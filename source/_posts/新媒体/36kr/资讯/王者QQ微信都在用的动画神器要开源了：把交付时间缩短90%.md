
---
title: '王者QQ微信都在用的动画神器要开源了：把交付时间缩短90%'
categories: 
 - 新媒体
 - 36kr
 - 资讯
headimg: 'https://img.36krcdn.com/20220106/v2_80a85df0bd9347d2a238fe83b12220c7_img_000'
author: 36kr
comments: false
date: Thu, 06 Jan 2022 06:31:13 GMT
thumbnail: 'https://img.36krcdn.com/20220106/v2_80a85df0bd9347d2a238fe83b12220c7_img_000'
---

<div>   
<p>给1分钟的王者“击杀”合集做一系列炫酷动画，并集成到客户端的一键战报生成功能中，需要多长时间？</p> 
<p>就像这样，带“开黑局”专属的转场动画，英雄昵称KDA一应俱全：</p> 
<p class="image-wrapper"><img data-img-size-val="480,213" src="https://img.36krcdn.com/20220106/v2_80a85df0bd9347d2a238fe83b12220c7_img_000" referrerpolicy="no-referrer"></p> 
<p>能在每段“高光”操作出现时，加上一段文字动效渲染气氛：</p> 
<p class="image-wrapper"><img data-img-size-val="480,211" src="https://img.36krcdn.com/20220106/v2_fb43590731da490ca12d60c7b0386ade_img_000" referrerpolicy="no-referrer"></p> 
<p>还可以在出现“三杀”等极限操作的时候，配合英雄来一把炸场效果：</p> 
<p class="image-wrapper"><img data-img-size-val="480,223" src="https://img.36krcdn.com/20220106/v2_c07f326accaa440d8934ce811059bc94_img_000" referrerpolicy="no-referrer"></p> 
<p>对于特效设计师和客户端的开发人员们而言，从设计完成到研发还原效果上线的时间原本应该在<strong>一周以上</strong>：</p> 
<p>毕竟设计师不光要在AE里搞定特效设计，还得跟研发人员反复确认代码的效果还原度。</p> 
<p>碰上特效太复杂、动画文件太大等情况，免不了又是一场办公室battle……</p> 
<p>这种掉头发伤感情的事，早已让程序员们坐不住了。</p> 
<p>这不，他们干脆搞出了一套自动化工具，用上它<strong>最快4小时</strong>就可以交付上线一个动画。</p> 
<p>而最近，这个由<a class="project-link" data-id="24961" data-name="腾讯" data-logo="https://img.36krcdn.com/20201201/v2_016524a9a477434cb3584e1558f3257a_img_000" data-refer-type="2" href="https://36kr.com/projectDetails/24961" target="_blank">腾讯</a>PCG发布器中台开发，名为<strong>PAG</strong>（Portable Animated Graphics）的工具传出“即将对外开源”的消息，更是直接在动画设计师和研发<a class="project-link" data-id="224096" data-name="圈子" data-logo="https://img.36krcdn.com/20210809/v2_43526951c0104829ab0a8e61c39a07af_img_000" data-refer-type="2" href="https://36kr.com/projectDetails/224096" target="_blank">圈子</a>里点燃了一把火。</p> 
<p>毕竟，官方邮箱里早已塞满来自外部的SDK申请和开源许愿贴。</p> 
<p class="image-wrapper"><img data-img-size-val="1080,1103" src="https://img.36krcdn.com/20220106/v2_ca7807c98ddb47dfb24190dec3cc5799_img_000" referrerpolicy="no-referrer"></p> 
<p>所以，PAG到底是怎么一回事，能让研发和设计师们如此<a class="project-link" data-id="52642" data-name="跃跃" data-logo="https://img.36krcdn.com/20210807/v2_48a15588eaa74e91a5f0e27765477dd0_img_000" data-refer-type="2" href="https://36kr.com/projectDetails/52642" target="_blank">跃跃</a>欲试？</p> 
<h2><strong>PAG是什么？</strong></h2> 
<p>简单来说，PAG是一套完整的动画工作流。</p> 
<p>在PAG出现之前，<strong>理想的</strong>移动端动画制作流程是这样的：</p> 
<p>设计师们先用AE（Adobe Effect）设计出一段动画效果，导出动画效果文件（gif或视频Demo）并交给研发；然后，研发们尝试用代码还原动画，渲染出我们在移动端看到的效果。</p> 
<p class="image-wrapper"><img data-img-size-val="1080,281" src="https://img.36krcdn.com/20220106/v2_0d00f03d84f642b9bb83e0bac3463538_img_000" referrerpolicy="no-referrer"></p> 
<p>但<strong>实际上</strong>，设计和研发的（一整周）工作流程是这样的：</p> 
<p class="image-wrapper"><img data-img-size-val="1080,697" src="https://img.36krcdn.com/20220106/v2_b28958f34be74a5a81ed8244bf0f920d_img_000" referrerpolicy="no-referrer"></p> 
<p>双方battle的问题包括且不限于：</p> 
<p><strong>从研发角度来看，并非设计给出的所有特效都能在手机上实现。</strong></p> 
<p>如果系统不支持特效实现方式，即使它非常酷炫狂拽，用户也无法体验。例如，某个交互特效在安卓和iOS上都无法实现，研发就可能把它打回给设计“重做”。</p> 
<p>除了无法实现的特效以外，难以实现的特效也在“重做”范围内。如果设计给出的特效不在库里、或是排期不允许，最后都得让设计重做。</p> 
<p>即使前两个需求都满足，研发还得考虑实现性能等问题，如果实现完发现对性能要求过高，也会被打回去“重头再来”。</p> 
<p><strong>从设计角度来看，并非研发给出的每个解决方案都可以接受。</strong></p> 
<p>如果一个精心设计的动画，被研发用另一种方式“拼凑”出来，导致效果看起来很“低级”，就脱离了设计的初衷。</p> 
<p>因此设计往往需要和研发反复battle协商，最终确定一个折中的方案，甚至在预览阶段，动画特效也不一定就能拍板，如果临时变更需求，研发就又得再来一遍……</p> 
<p><strong>这种情况下，PAG（Portable Animated Graphics）作为一套动画工作流“横空出世”。</strong></p> 
<p>它包含三部分：PAG导出插件（PAG Exporter）、桌面预览工具（PAGViewer）、渲染SDK，分别用来解决前面提到的三大研发问题。</p> 
<p class="image-wrapper"><img data-img-size-val="1080,327" src="https://img.36krcdn.com/20220106/v2_3f1f019b5ec54d60b1ab184f4f87aa90_img_000" referrerpolicy="no-referrer"></p> 
<h3><strong>PAG导出插件</strong></h3> 
<p>首先，设计师在AE中做出一段动画后，无需再导出成视频或gif这样的动画效果文件，而是能通过<strong>PAG导出插件</strong>，直接将AE动画编码导出成一份.pag格式的动画文件。</p> 
<p>这个插件，相当于从源头上解决了设计与研发之间<strong>“来回返工”</strong>的问题。当设计文件中出现系统不支持的AE矢量特性、或使用了特别影响性能的属性时，PAG导出插件就会给出<strong>修改提示</strong>，帮助设计师导出符合系统要求的动画文件。</p> 
<p>细节上也有一些好用的地方，例如一键设置就能导出BMP预合成、设置占位图填充模式等功能，进一步节省设计的时间；</p> 
<p class="image-wrapper"><img data-img-size-val="1080,1020" src="https://img.36krcdn.com/20220106/v2_e0c23b5fd4884825873e1806f310d764_img_000" referrerpolicy="no-referrer"></p> 
<p>由于导出的.pag文件采用二进制格式存储动画信息，不仅有效降低了文件大小，还能让设计师们往里面直接放各种素材资源（图片、音频等），交付时<strong>只用发送一个文件</strong>。</p> 
<p class="image-wrapper"><img data-img-size-val="1080,506" src="https://img.36krcdn.com/20220106/v2_23ece5f950784aa68fc367fadd8828e6_img_000" referrerpolicy="no-referrer"></p> 
<p class="img-desc">△文件格式长这样</p> 
<h3><strong>桌面预览工具PAGViewer</strong></h3> 
<p>然后，设计师在预览时，就能直接采用<strong>PAGViewer</strong>在PC端预览.pag动画文件的效果。这样设计师无需等待动画文件上线、就能一键预览移动端的动画效果。</p> 
<p>还可以直接在PAGViewer里面修改可编辑文本或占位图：</p> 
<p class="image-wrapper"><img data-img-size-val="640,715" src="https://img.36krcdn.com/20220106/v2_5ae4329e1e3549e2b220268f2856d8ea_img_000" referrerpolicy="no-referrer"></p> 
<p>除了修改可编辑文件和预览效果，PAGViewer还增加了性能展示面板，里面包含了pag动画的基本信息，如时长、帧率、尺寸、bmp预合成的数量、图层总数等。</p> 
<p>如下图所示，设计师直接就能通过面板，看到量化的性能指标，来定量评估.pag文件的性能，并进行针对性优化，避免上线前才发现“性能卡设计”等问题：</p> 
<p class="image-wrapper"><img data-img-size-val="1080,395" src="https://img.36krcdn.com/20220106/v2_3751201094554e0ba285797c44d1daf1_img_000" referrerpolicy="no-referrer"></p> 
<h3><strong>渲染SDK</strong></h3> 
<p>最后，开发只需要一次性的<strong>渲染SDK</strong>接入就能加载PAG文件，直接在Android、iOS、mac OS、windows、web、Linux等常用的平台端准确还原动画效果，无需进行额外开发。</p> 
<p>当然，由于pag文件的可编辑性，开发自己也能直接修改或替换文件中的文本和占位图，不用再在需求上麻烦设计。</p> 
<blockquote> 
 <p>一段动画特效可以被分成“动画效果+内容”两部分，“可编辑性”指的是替换“内容”部分。</p> 
</blockquote> 
<p>以“滚动的一串文本”动画效果为例，其中文本信息是内容，滚动就是动画效果。pag可以在保留预设动画的情况下，做到修改文本的内容，字体，字号，颜色等十几项属性。</p> 
<p>除了文本可以被修改替换，PAG还提供了占位图的替换能力，同样在保留预设动画的情况下，不仅可以替换照片，甚至可以直接把视频也放进占位图。</p> 
<p>这样一来，不仅避免了设计反复根据需求修改动画特效的痛苦，还能将动画特效运用于视频剪辑中。</p> 
<p>像我们在开头看到的王者特效，包括昵称和KDA其实都可以被一键替换，不需要再将对应的动效重新设计一遍。</p> 
<p class="image-wrapper"><img data-img-size-val="480,266" src="https://img.36krcdn.com/20220106/v2_5b65f4c00e4a40cbb551535a42363764_img_000" referrerpolicy="no-referrer"></p> 
<p class="img-desc">△这次是情侣组合（狗头）</p> 
<p><strong>总结一下，PAG最大的优势有以下几点：</strong></p> 
<p>输出动画文件极小，比同类型方案平均<strong>降低50%</strong></p> 
<p>支持<strong>所有AE效果</strong>导出，包括第三方AE特效插件</p> 
<p>运行时保留动画效果，<strong>实时编辑</strong>文本替换占位图</p> 
<p>提供从导出、预览、到性能优化的<strong>完善工具链</strong>支持</p> 
<p>SDK覆盖所有平台，包含<strong>Web以及服务端</strong>渲染能力</p> 
<p>解决的正是当前短视频特效设计师们最头疼的几大痛点。</p> 
<p>其实在PAG出现之前，业内已经有一些类似的设计插件，但或多或少存在一点问题。</p> 
<p>PAG究竟是怎么解决它们的？</p> 
<p>我们与PAG的研发团队、腾讯PCG发布器中台下编辑子工作组的负责人Dom取得了联系，了解了背后的实现原理。</p> 
<h2><strong>PAG背后的技术门道</strong></h2> 
<p>Dom表示，PAG早期最有挑战的地方，其实就在于“动画文件设计”和“全AE特性支持”这两部分。</p> 
<h3><strong>高效动画文件</strong></h3> 
<p>在输出文件格式方面，已有的JSON等格式存在两大问题：<strong>解码速度慢、压缩率低</strong>。</p> 
<p>为此，团队重新设计了一种名为.pag的文件格式，采用二进制数据结构来存储动画信息。</p> 
<p><strong>一方面</strong>，二进制数据结构不需要做字符串匹配、序列化等操作，解码速度会比JSON等格式的文件快上许多。<a class="project-link" data-id="1657012" data-name="测试数据" data-logo="https://img.36krcdn.com/20211217/v2_acad707f378546aca2eb6705f1a85244_img_000" data-refer-type="1" href="https://p.36kr.com/space/2710010340?mp=zzquote" target="_blank">测试数据</a>显示，在解码速度上，PAG格式的动画文件要比JSON文件<strong>快12倍</strong>。</p> 
<p><strong>另一方面</strong>，相比于JSON，二进制数据结构具有更高的压缩率。</p> 
<p>JSON文件导出的冗余信息较多，而二进制的数据结构则能跳过大量默认值存储，并使用动态比特位来紧凑存储。因此相同的动画内容，PAG文件比同类型方案压缩文件<strong>小50%左右</strong>。</p> 
<p>此外，采用二进制数据结构还有一个额外的好处，在导出动画文件时不用再搭配“图片包”（外挂图片），<strong>一个文件就能搞定</strong>，包括音频也能够内置。</p> 
<p class="image-wrapper"><img data-img-size-val="1080,359" src="https://img.36krcdn.com/20220106/v2_64994724c9024ed9b903290df3560164_img_000" referrerpolicy="no-referrer"></p> 
<h3><strong>全AE特性支持</strong></h3> 
<p>说完文件格式，再来看看PAG文件是如何做到支持所有AE效果的。</p> 
<p>这个特性使得PAG文件既能实时预览复杂特效，又能确保动画的可编辑性，但在之前，它们并不能同时被实现。</p> 
<p>这是因为传统的动画的导出模式有两种，即<strong>矢量导出</strong>和<strong>序列帧导出</strong>。</p> 
<p><strong>矢量导出</strong>的动画文件具有可编辑性，但缺点是一些复杂特效无法在移动端实时预览，因此无法做到全AE特性支持。</p> 
<p><strong>序列帧导</strong>出基于截图的原理解决了这个问题，也就是将复杂的视觉动效全部截成图片，再实现导出。但这就导致文件大小可能高达几十上百兆，对移动端而言“又大，又没法编辑”。</p> 
<p>为了让文件既可以编辑，又能保证精彩动态效果的实现，PAG的研发人员们想到了混合导出的方法。</p> 
<p>简单来说，就是给不需要可编辑性的图层打标记。这样在导出时，需要保留编辑性的图层就会以纯矢量形式被导出，而打了标记的图层，则以序列帧的方式导出。</p> 
<p class="image-wrapper"><img data-img-size-val="1080,347" src="https://img.36krcdn.com/20220106/v2_be9315c4f7a443efb979233c535ba919_img_000" referrerpolicy="no-referrer"></p> 
<p>值得一提的是，为了尽可能压缩导出文件的大小，PAG团队还自己设计了bmp预合成的格式，充分利用了视频的极限帧间压缩能力，并在此基础上扩展了对透明通道的支持。</p> 
<p>再加上渲染方面的优化，最终，相比于传统图片序列帧，视频序列帧格式的文件大小可以降低到原来的<strong>1.24%</strong>左右。</p> 
<p class="image-wrapper"><img data-img-size-val="1080,367" src="https://img.36krcdn.com/20220106/v2_ab427423cabf4f3caa95f121ea9c4e26_img_000" referrerpolicy="no-referrer"></p> 
<p>但从基础功能的实现，到如今成为一整套完整的工具流，PAG并非“一蹴而就”。</p> 
<p>与之相反，虽然SDK去年才开始对外开放，但早在2016年，PAG的第一行代码就已经写下。</p> 
<p>从最初的1.0版本迭代到如今的形态，PAG已经走过了4个版本。</p> 
<h2><strong>“被battle出来的产品”</strong></h2> 
<p>“从写下第1行代码，到第1次跑通，团队就用了<strong>6个月</strong>时间。”</p> 
<p>至于为何要选择坚持打磨这样一款工具产品，Dom提到了一个“回忆杀”的词语<strong>Flash</strong>：</p> 
<blockquote> 
 <p>在Flash时代，动效开发有一套非常完善的工作流：设计师把动画制作出来，导出一个SWF文件，开发人员无需手敲代码还原效果，直接导入就能使用。并且动效里面的细节是可以调整的。</p> 
 <p>但到了现在的H5、移动应用开发里，很少有工具能够完整还原这套完善的动画工作流。</p> 
</blockquote> 
<p>他希望PAG能在视频编辑这样一个场景里，把这套工作流带到移动端动画制作上，降低或者消除动画相关的研发成本。</p> 
<p>这个想法在市场上也很快有了案例验证——</p> 
<p>PAG项目开始的同一年，支持将矢量动画导出到各个平台的AE插件Lottie问世。这款插件的成功问世，证明了还原Flash这套设计到研发之间的流畅工作流“跑得通”。</p> 
<p>和PAG团队一样，Lottie背后的开发者同样有着深厚的Flash相关经验，只是Lottie主要面向UI动画设计，不太适用于短视频场景。</p> 
<p>为了能够满足短视频贴纸动画以及模板的开发需求，PAG团队选择了继续自研。</p> 
<p>6个月之后，<strong>PAG 1.0版本</strong>出炉。</p> 
<p>腾讯的设计师们试用后，PAG团队<a class="project-link" data-id="95377" data-name="得到" data-logo="https://img.36krcdn.com/20210807/v2_966db147ab4646ef82349f069ce61219_img_000" data-refer-type="2" href="https://36kr.com/projectDetails/95377" target="_blank">得到</a>的反馈是“存在不少问题”，核心概括起来就是：</p> 
<blockquote> 
 <p>1.0版本虽然支持了带动画的文本编辑，但仅覆盖了AE的纯矢量导出能力，很多复杂动画效果无法被完整还原。</p> 
</blockquote> 
<p>为此，PAG继续迭代出了<strong>2.0版本</strong>：通过混合导出实现AE全特性支持，同时解决了特效和可编辑性的问题。开发团队还在 2.0版本引入了占位图的能力，为照片模板和视频模板的生产带来了工业化量产的能力。</p> 
<p>到<strong>3.0版本</strong>时，PAG在编辑性上进一步探索突破，强化了图层级别的原子编辑组合能力，支持了从原子特效组件动态构建模板，很好地支撑了游戏战报和<strong>一键出片</strong>等动态模板的需求……</p> 
<p class="image-wrapper"><img data-img-size-val="640,535" src="https://img.36krcdn.com/20220106/v2_0ef475128c4d4fc3b6c7ca25bdedd483_img_000" referrerpolicy="no-referrer"></p> 
<p>这时候，PAG功能已经相对全面，腾讯内部设计师开始“口口相传”，将PAG主动推荐给外部的其他设计师使用，也因此反馈出了更多的需求。</p> 
<p>就在本月，PAG完成了4.0版本的开发，并传出开源信号。这个版本耗时近一年时间完成了渲染架构的重大升级，彻底脱离了<a class="project-link" data-id="3968996" data-name="谷歌" data-logo="https://img.36krcdn.com/20200916/v2_811751a081924fa9af8741ce120bd7bf_img_png" data-refer-type="2" href="https://36kr.com/projectDetails/3968996" target="_blank">谷歌</a>的Skia 2D绘图库，SDK包体也直接<strong>下降了60%</strong>。</p> 
<p>具体而言，PAG团队自研实现了一套轻量纯GPU绘图引擎，通过最大化利用平台端提供的所有能力，以500K左右的包体覆盖了Skia的绝大部分功能，并且在接口设计上充分暴露了针对现代GPU渲染的优化能力。因此，包体减小的同时，渲染性能的上限实际得到了进一步的提升。</p> 
<p>另外，PAG 4.0版本基于这个全新的2D绘图引擎，也将正式拓展对<strong>Web端</strong>的支持。</p> 
<p><a class="project-link" data-id="397416" data-name="量子位" data-logo="https://img.36krcdn.com/20210811/v2_1664f3547e9747f8b61dc0cac3fcd649_img_000" data-refer-type="2" href="https://36kr.com/projectDetails/397416" target="_blank">量子位</a>还获悉，<strong>目前PAG 4.0版本已经走完腾讯开源审核流程。</strong></p> 
<p>回过头看，PAG的不断进化，其实也得益于腾讯内部复杂的业务需求。开发团队与业务方的持续“battle”，使得这套动画工作流始终贴合着设计师、工程师们最真实的“痛点”。</p> 
<p>这或许也就是为什么，明明是一个腾讯内部工具，却在外部因使用者们的口口相传打出名气，被推动着走向开放、开源。</p> 
<p>说了这么多，是时候附上传送门了。</p> 
<p>如果你对PAG感兴趣，现在就可以去官网获取SDK。</p> 
<p>开源代码也正在路上，可以<a class="project-link" data-id="81906" data-name="一起" data-logo="https://img.36krcdn.com/20210709/v2_647b9860d6f7437caf1be2501d37698a_img_000" data-refer-type="1" href="https://www.36dianping.com/space/4772100123" target="_blank">一起</a>蹲一个~</p> 
<p>官网链接：https://pag.io/</p> 
<p class="editor-note">本文来自<a class="project-link" data-id="3968527" data-name="微信" data-logo="https://img.36krcdn.com/20200916/v2_811751a081924fa9af8741ce120bd7bf_img_png" data-refer-type="2" href="https://36kr.com/projectDetails/3968527" target="_blank">微信</a>公众号<a target="_blank" rel="noopener noreferrer" href="https://mp.weixin.qq.com/s/a8-yOp8h5LiFGKSdLE_toA">“量子位”（ID:QbitAI）</a>，作者：鱼羊 萧箫，36氪经授权发布。</p>  
</div>
            