
---
title: '7 行代码让B站崩溃 3 小时，竟因_一个诡计多端的 0_'
categories: 
 - 新媒体
 - IT 之家
 - 热榜
headimg: 'https://img.ithome.com/newsuploadfiles/2022/7/7484d1e0-91c6-4a55-a44f-fee7bcc43ce8.jpg'
author: IT 之家
comments: false
date: Sun, 24 Jul 2022 04:47:16 GMT
thumbnail: 'https://img.ithome.com/newsuploadfiles/2022/7/7484d1e0-91c6-4a55-a44f-fee7bcc43ce8.jpg'
---

<div>   
<div class="tougao-user">感谢IT之家网友 <a href="https://m.ithome.com/html/app/open.html?url=ithome%3A%2F%2Fuserpage%3Fid%3D1014261" rel="nofollow">Sancu</a> 的线索投递！</div>
            <p data-vmark="9bc6">一个小小字符“0”，竟引得B站全面崩溃。</p><p style="text-align: center;" data-vmark="5454"><img src="https://img.ithome.com/newsuploadfiles/2022/7/7484d1e0-91c6-4a55-a44f-fee7bcc43ce8.jpg" w="637" h="460" title="7 行代码让B站崩溃 3 小时，竟因“一个诡计多端的 0”" width="637" height="460" referrerpolicy="no-referrer"></p><p data-vmark="d79e">不知你是否还记得那一夜，B站<strong>“大楼停电”“服务器爆炸”“程序员删库跑路”</strong>的彻夜狂欢。（手动狗头）</p><p data-vmark="24e5">时隔一年，背后“真凶”现在终于被阿 B 披露出来 ——</p><p style="text-align: center;" data-vmark="a6ba"><img src="https://img.ithome.com/newsuploadfiles/2022/7/efd8f48f-069c-40cf-821f-a57f9fc11f4c.png" w="604" h="358" title="7 行代码让B站崩溃 3 小时，竟因“一个诡计多端的 0”" width="604" height="358" referrerpolicy="no-referrer"></p><p data-vmark="eacc">没想到吧，就是这么简单几行代码，直接干趴B站两三个小时，搞得B站程序员彻夜无眠头发狂掉。</p><p data-vmark="3682">你可能会问，这不就是个普普通通用来求最大公约数的函数吗，怎么就有如此大的威力？背后一桩桩一件件，归根结底其实就一句话：<strong>0，它真的不兴除啊</strong>。</p><p style="text-align: center;" data-vmark="377c"><img src="https://img.ithome.com/newsuploadfiles/2022/7/45378ec9-d6b5-4d9a-9984-dfb0bda383f2.png" w="500" h="366" title="7 行代码让B站崩溃 3 小时，竟因“一个诡计多端的 0”" width="500" height="366" referrerpolicy="no-referrer"></p><p data-vmark="0dde">具体详情，咱们还是一起来看看“事故报告”。</p><h2 data-vmark="66db">字符串“0”引发的“血案”</h2><p data-vmark="1adf">先来说道说道引发惨案的根本原因，<strong>也就是开头贴出的这个 gcd 函数</strong>。学过一点编程知识的小伙伴应该都知道，<strong>这是一种用辗转相除法来计算最大公约数的递归函数</strong>。</p><p data-vmark="375c">跟我们手算最大公约数的方法不同，这个算法是这样的：</p><p data-vmark="9fe6">举个简单的例子，a=24，b=18，求 a 和 b 的最大公约数；</p><p data-vmark="e9a4">a 除以 b，得到的余数是 6，那么就让 a=18，b=6，然后接着往下算；</p><p data-vmark="6d62">18 除以 6，这回余数是 0，那么 6 也就是 24 和 18 的最大公约数了。</p><p data-vmark="b81e">也就是说，a 和 b 反复相除取余数，直到 b=0，函数中：</p><pre class="brush:javascript;toolbar:false">if b==0 then return a end</pre><p data-vmark="340c">这个判断语句生效，结果就算出来了。基于这样的数学原理，我们再来看这段代码，似乎没什么问题：</p><p style="text-align: center;" data-vmark="9c84"><img src="https://img.ithome.com/newsuploadfiles/2022/7/129c83cc-580f-4b5b-8727-0f2571aa358b.png" w="604" h="358" title="7 行代码让B站崩溃 3 小时，竟因“一个诡计多端的 0”" width="604" height="358" referrerpolicy="no-referrer"></p><p data-vmark="b563">但如果输入的 b 是个字符串“0”呢？</p><p data-vmark="0553">B站的技术解析文章中提到，<strong>这段出事的代码是用 Lua 写的</strong>。Lua 具有这么几个特点：</p><ul class="ai-word-checked list-paddingleft-2"><li><p data-vmark="d91b">这是一种动态类型语言，常用习惯里变量不需要定义类型，直接给变量赋值就行。</p></li><li><p data-vmark="b228">Lua 在对一个数字字符串进行算术操作时，会尝试将这个数字字符串转成一个数字。</p></li><li><p data-vmark="4ada">在 Lua 语言中，数学运算 n%0 的结果是 nan (Not A Number)。</p></li></ul><p data-vmark="e2e7">我们来模拟一下这个过程：</p><p data-vmark="1e86">1、当 b 是一个字符串“0”时，由于这个 gcd 函数没有对其进行类型校验，因此在碰上判定语句时，“0”不等于 0，代码中“return _gcd (b, a% b)”触发，返回_gcd (“0”, nan)。</p><p data-vmark="8b0d">2、_gcd (“0”, nan) 再次被执行，于是返回值变成了_gcd (nan, nan)。</p><p data-vmark="bf0c">这下就完犊子了，判定语句中 b=0 的条件永远没法达到，于是，死循环出现了。也就是说，这个程序开始疯狂地原地转圈，并且<strong>为了一个永远得不到的结果，把 CPU 占了个 100%</strong>，别的用户请求自然就处理不了了。</p><p style="text-align: center;" data-vmark="e82d"><img src="https://img.ithome.com/newsuploadfiles/2022/7/4514b784-b33a-4304-9505-36e1d6722277.png" w="235" h="214" title="7 行代码让B站崩溃 3 小时，竟因“一个诡计多端的 0”" width="235" height="214" referrerpolicy="no-referrer"></p><p data-vmark="ff36">那么问题来了，这个“0”它到底是怎么进去的呢？</p><p data-vmark="4aa5">官方说法是：</p><blockquote><p data-vmark="4875">在某种发布模式中，应用的实例权重会短暂地调整为 0，此时注册中心返回给 SLB（负载均衡）的权重是字符串类型的“0”。此发布环境只有生产环境会用到，同时使用的频率极低，在 SLB 前期灰度过程中未触发此问题。</p><p data-vmark="ef1e">SLB 在 balance_by_lua 阶段，会将共享内存中保存的服务 IP、Port、Weight 作为参数传给 lua-resty-balancer 模块用于选择 upstream server，在节点 weight=“0”时，balancer 模块中的_gcd 函数收到的入参 b 可能为“0”。</p></blockquote><h2 data-vmark="214d">bug 是如何定位的</h2><p data-vmark="dcd3">以“事后诸葛亮”的视角来看，这个引发B站全面崩溃的根本原因多少有点让人直呼“就这”。但从当事程序员的视角来看，事情确实没有辣么简单。</p><p data-vmark="6434">当天晚上 22:52 分 —— 大部分程序员才刚下班或者还没下班的节骨眼（doge），<strong>B站运维收到服务不可用的报警</strong>，第一时间怀疑机房、网络、四层 LB、七层 SLB 等基础设施出现问题。</p><p data-vmark="8765">然后立马和相关技术人员拉了个紧急语音会议开始处理。5 分钟后，运维发现<strong>承载全部在线业务的主机房七层 SLB 的 CPU 占用率达到了 100%</strong>，无法处理用户请求，排除其他设施后，锁定故障为该层。</p><p data-vmark="34e7">（七层 SLB 是指基于 URL 等应用层信息的负载均衡。负载均衡通过算法把客户请求分配到服务器集群，从而减少服务器压力。）</p><p data-vmark="3bfd">万般紧急之时，小插曲还现了：远程在家的程序员没法进入内网，只好又去 call 了一遍内网负责人，走了个绿色通道才全部上线（因为其中一个域名是由故障的 SLB 代理的）。</p><p style="text-align: center;" data-vmark="4842"><img src="https://img.ithome.com/newsuploadfiles/2022/7/1d3b6d2f-599e-4f70-8fe0-c42d40174e5a.png" w="1080" h="498" title="7 行代码让B站崩溃 3 小时，竟因“一个诡计多端的 0”" width="1080" height="378" referrerpolicy="no-referrer"></p><p data-vmark="d685">此时已经过去了 25 分钟，抢修正式开始。</p><p data-vmark="a53b">首先，运维先热重启了一遍 SLB，未恢复；然后尝试拒绝用户流量冷重启 SLB，CPU 依然 100%，还是未恢复。</p><p data-vmark="530a">接着，运维发现多活机房 SLB 请求大量超时，但 CPU 未过载，正准备重启多活机房 SLB 时，内部群反应主站服务已恢复，视频播放、推荐、评论、动态等功能已基本正常。</p><p data-vmark="7863">此时是 23 点 23 分，距离事故发生 31 分钟。</p><p data-vmark="b6c2">值得一提的是，<strong>这些功能恢复其实是事发之时被网友们吐槽的“高可用容灾架构”发挥了作用</strong>。</p><p style="text-align: center;" data-vmark="f4cd"><img src="https://img.ithome.com/newsuploadfiles/2022/7/80b9bdc7-5fa5-408c-93d4-6e6b233da48a.png" w="1080" h="357" title="7 行代码让B站崩溃 3 小时，竟因“一个诡计多端的 0”" width="1080" height="271" referrerpolicy="no-referrer"></p><p data-vmark="8d2c">至于这道防线为啥一开始没发挥作用，里头可能还有你我一点锅。</p><p data-vmark="fce1">简单来说，就是大家伙点不开B站就开始疯狂刷新，CDN 流量回源重试 + 用户重试，<strong>直接让B站流量突增 4 倍以上</strong>，连接数突增 100 倍到千万级别，<strong>多活 SLB 就给整过载了</strong>。</p><p style="text-align: center;" data-vmark="1a46"><img src="https://img.ithome.com/newsuploadfiles/2022/7/e0b60175-91cb-4d5c-bd29-9c910b2a299a.png" w="600" h="601" title="7 行代码让B站崩溃 3 小时，竟因“一个诡计多端的 0”" width="600" height="601" referrerpolicy="no-referrer"></p><p data-vmark="e351">不过，并不是所有服务都搞了多活架构，至此事情并没完全解决。接下来的半个小时里，大家做了很多操作，回滚了最近两周左右上线的 Lua 代码，都没把剩余的服务恢复。</p><p data-vmark="cac6">时间来到了 12 点，没有办法了，“先不管 bug 是怎么出来的，把服务全恢复了再说”。简单 + 粗暴：<strong>运维直接耗时一小时重建了一组全新的 SLB 集群</strong>。</p><p data-vmark="7f1c">凌晨 1 点，新集群终于建好：一边，有人负责陆续将直播、电商、漫画、支付等核心业务流量切换到新集群，恢复全部服务（凌晨 1 点 50 分全部搞定，暂时结束了崩了逼近 3 个小时的事故）；</p><p data-vmark="037d">另一边，继续分析 bug 原因。在他们用分析工具跑出一份详细的火焰图数据后，那个搞事的“0”才终于露出了一点端倪：CPU 热点明显集中在一个对 lua-resty-balancer 模块的调用中。而该模块的_gcd 函数在某次执行后返回了一个预期外的值：NaN。</p><p data-vmark="618b">同时，他们也发现了触发诱因的条件：<strong>某个容器 IP 的 weight=0</strong>。他们怀疑是该函数触发了 jit 编译器的某个 bug，运行出错陷入死循环导致 SLB CPU 100%。于是就全局关闭了 jit 编译，暂时规避了风险。一切都解决完后，已经快 4 点，大家终于暂时睡了个好觉。</p><p data-vmark="dd66">第二天大家也没闲着，马不停蹄地在线下环境复现了 bug 后，发现并不是 jit 编译器的问题，而是<strong>服务的某种特殊发布模式会出现容器实例权重为 0 的情况</strong>，而这个 0 是个字符串形式。</p><p data-vmark="966b">正如前面所说，这个字符串“0”在动态语言 Lua 中的算术操作中，被转成了数字，走到了不该走的分支，造成了死循环，引发了 b 站此次前所未见的大崩溃事件。</p><h2 data-vmark="9868">递归的锅还是弱类型语言的锅？</h2><p data-vmark="de8f">不少网友都还对这次事故记忆犹新，有回想起自己就是以为手机不行换电脑也不行的，也有人还记得当时 5 分钟后此事就上了热搜。</p><p data-vmark="aa17">大家都很诧异，就这么一个简单的死循环就能造成如此大的网站崩服。不过，有人指出，死循环不罕见，<strong>罕见的是在 SLB 层、在分发过程出问题</strong>，它还不像在后台出问题很快能重启解决。</p><p style="text-align: center;" data-vmark="9a12"><img src="https://img.ithome.com/newsuploadfiles/2022/7/d7f818fd-4fe4-4a3a-8fc4-54abdeb348db.png" w="1080" h="273" title="7 行代码让B站崩溃 3 小时，竟因“一个诡计多端的 0”" width="1080" height="207" referrerpolicy="no-referrer"></p><p data-vmark="aef2">为了避免这种情况发生，有人认为要慎用递归，硬要用还是设置一个计数器，达到一个业务不太可能达到的值后直接 return 掉。</p><p data-vmark="2aae">还有人认为这不怪递归，主要还是弱类型语言的锅。以此还导致了“诡计多端的‘0’”这一打趣的说法。</p><p style="text-align: center;" data-vmark="7d50"><img src="https://img.ithome.com/newsuploadfiles/2022/7/df6e777c-d44d-4e7f-b739-2e9e3bdd0d82.png" w="1080" h="152" title="7 行代码让B站崩溃 3 小时，竟因“一个诡计多端的 0”" width="1080" height="115" referrerpolicy="no-referrer"></p><p data-vmark="15e2">另外，由于事故实在是耽误了太久、太多事儿，<strong>当时B站给所有用户补了一天大会员</strong>。</p><p data-vmark="ce21">有人就在此算了一笔账，称就是这 7 行代码，<strong>让 b 站老板一下亏了大约 1,5750,0000 元</strong>。（手动狗头）</p><p style="text-align: center;" data-vmark="2edf"><img src="https://img.ithome.com/newsuploadfiles/2022/7/316dd57d-dfcd-472e-aa00-549d5f7aa764.png" w="1080" h="185" title="7 行代码让B站崩溃 3 小时，竟因“一个诡计多端的 0”" width="1080" height="140" referrerpolicy="no-referrer"></p><p data-vmark="8a27">对于这个 bug，你有什么想吐槽的？</p><p data-vmark="ed28">参考链接：</p><p data-vmark="7e43">[1]《2021.07.13 我们是这样崩的》by 哔哩哔哩技术</p><p data-vmark="0d86"><span class="link-text-start-with-http">https://mp.weixin.qq.com/s/nGtC5lBX_Iaj57HIdXq3Qg</span></p>
          
</div>
            