
---
title: '腾讯老照片修复算法开源：细节到头发丝，3 种预训练模型可下载，曾登顶 GitHub 热榜第一'
categories: 
 - 新媒体
 - IT 之家
 - 热榜
headimg: 'https://img.ithome.com/newsuploadfiles/2022/3/74d09056-ddeb-42d5-ad51-10c2fb15d748.png'
author: IT 之家
comments: false
date: Sun, 13 Mar 2022 04:43:11 GMT
thumbnail: 'https://img.ithome.com/newsuploadfiles/2022/3/74d09056-ddeb-42d5-ad51-10c2fb15d748.png'
---

<div>   
<p data-vmark="510a">还记得这个能将老照片修复到纤毫毕现的 GFPGAN 吗？</p><p data-vmark="eaac" style="text-align: center;"><img src="https://img.ithome.com/newsuploadfiles/2022/3/74d09056-ddeb-42d5-ad51-10c2fb15d748.png" w="573" h="345" alt="能将老照片修复到纤毫毕现的 GFPGAN" title="腾讯老照片修复算法开源：细节到头发丝，3 种预训练模型可下载，曾登顶 GitHub 热榜第一" width="573" height="345" referrerpolicy="no-referrer"></p><p data-vmark="fa01">现在，它的代码正式开源了！官方已经在 GitHub 上传了 3 个预训练模型，3 个版本的效果区别如下：</p><p data-vmark="9818" style="text-align: center;"><img src="https://img.ithome.com/newsuploadfiles/2022/3/d76e4ab3-82f7-4b1c-8b7c-387c88910fe8.png" w="1080" h="464" alt="3 个预训练模型" title="腾讯老照片修复算法开源：细节到头发丝，3 种预训练模型可下载，曾登顶 GitHub 热榜第一" width="1080" height="352" referrerpolicy="no-referrer"></p><p data-vmark="685e">其中，V1.3 是最近更新的一版，修复效果更加自然。同时还能在低质量输入的情况下，输出高质量结果。自上线以来，<span class="accentTextColor">GFPGAN 已经在 GitHub 上揽星 1.7w+，还曾登顶过热榜第一</span>。</p><p data-vmark="f32c">更是在推特上引起过一波试玩热潮：</p><p data-vmark="ba5b" style="text-align: center;"><img src="https://img.ithome.com/newsuploadfiles/2022/3/08abde7c-1692-4f5e-8ab0-47116be2e7ee.png" w="1080" h="968" alt="在推特上引起过一波试玩热潮" title="腾讯老照片修复算法开源：细节到头发丝，3 种预训练模型可下载，曾登顶 GitHub 热榜第一" width="1080" height="735" referrerpolicy="no-referrer"></p><p data-vmark="3701"><span class="accentTextColor">这一项目由腾讯 PCG ARC 实验室提出</span>，其相关论文已被 CVPR2021 收录。</p><h2 data-vmark="ca7e">3 种预训练模型可挑选</h2><p data-vmark="bbd8">开源代码主要分为预训练和训练两个部分。预训练中以 GFPGAN 的 V1.3 版本为例，给出了预训练模型的下载地址：</p><pre>wget https://github.com/TencentARC/GFPGAN/releases/download/v1.3.0/GFPGANv1.3.pth -P Experiments/pretrained_models</pre><p data-vmark="eb34">然后，只需一行代码就能开始预训练模型推理了：</p><pre>python inference_gfpgan.py -i inputs/whole_imgs -o results -v 1.3 -s 2</pre><p data-vmark="fa60">具体介绍如下：</p><pre>Usage: python inference_gfpgan.py -i inputs/whole_imgs -o results -v 1.3 -s 2 [options]...

  -h                   show this help
  -i input             Input image or folder. Default: inputs/whole_imgs
  -o output            Output folder. Default: results
  -v version           GFPGAN model version. Option: 1 | 1.2 | 1.3. Default: 1.3
  -s upscale           The final upsampling scale of the image. Default: 2
  -bg_upsampler        background upsampler. Default: realesrgan
  -bg_tile             Tile size for background sampler, 0 for no tile during testing. Default: 400
  -suffix              Suffix of the restored faces
  -only_center_face    Only restore the center face
  -aligned             Input are aligned faces
  -ext                 Image extension. Options: auto | jpg | png, auto means using the same extension as inputs. Default: auto</pre><p data-vmark="4f90">在这里，官方还展示了 3 种预训练模型的区别在哪里。</p><p data-vmark="ab01" style="text-align: center;"><img src="https://img.ithome.com/newsuploadfiles/2022/3/b1cd9c93-8438-441a-b787-3cdea8325b7f.png" w="1080" h="333" alt="3 种预训练模型的区别" title="腾讯老照片修复算法开源：细节到头发丝，3 种预训练模型可下载，曾登顶 GitHub 热榜第一" width="1080" height="253" referrerpolicy="no-referrer"></p><p data-vmark="ce27">与初始版本相比，后两版在修复精度上有了明显提升。</p><p data-vmark="c2fb">V1.2 的锐化更明显，同时还带有一些美颜效果，所以在一些情况下会比较假面。</p><p data-vmark="6283">V1.3 明显解决了这一问题，使得输出更加自然，还能进行二次修复；不过弊端是人物面部特征有时会发生变化（比如下图中的安妮・海瑟薇示例）。</p><p data-vmark="362b" style="text-align: center;"><img src="https://img.ithome.com/newsuploadfiles/2022/3/fda3938c-1381-4241-ac83-222498a4bb96.png" w="1080" h="584" alt="不同版本的图像" title="腾讯老照片修复算法开源：细节到头发丝，3 种预训练模型可下载，曾登顶 GitHub 热榜第一" width="1080" height="443" referrerpolicy="no-referrer"></p><p data-vmark="3e87">总之，V1.3 并不完全优于 V1.2，大家可以按需选取合适的模型。</p><p data-vmark="a237">接下来到了训练部分。首先，数据集选用 FFHQ；然后，将下载好的预训练模型其他数据放在 experiments / pretrained_models 文件夹里。其他数据包括：预训练好的 StyleGAN2 模型，FFHQ 人脸对齐模型文件和 ArcFace 模型。</p><p data-vmark="674b">接下来，修改相对应的配置文件 options / train_gfpgan_v1.yml。在这里，也可以尝试不使用人脸对齐的简单版本 options / train_gfpgan_v1_simple.yml。</p><p data-vmark="cd72">最后，就可以开始训练了。</p><pre>python -m torch.distributed.launch —nproc_per_node=4 —master_port=22021 gfpgan/train.py -opt options/train_gfpgan_v1.yml —launcher pytorch</pre><p data-vmark="7605">此外，官方还有两则提醒。第一，输入更多高质量的人脸图像，可以提高修复的效果。第二，训练中可能需要进行一些图像预处理，比如美颜。如果你选择训练 V1.2 版本，官方还给出了微调指南：</p><blockquote><p data-vmark="4cc1">GFPGAN V1.2 采用了 clean 架构，更加方便部署；它是从一个双线性模型转换而来，因此需要对其原有模型微调，然后再进行转换。</p></blockquote><h2 data-vmark="3336">Demo 试玩</h2><p data-vmark="c438">除了开源代码，官方也早已开通了多个线上试玩通道。在这里，我们用 HuggingFace 来给大家展示具体效果。先来看看修复后的蒙娜丽莎女士，不仅面部的噪点都被去掉了，甚至连头发上的纱巾都清晰可见。</p><p data-vmark="bb2c" style="text-align: center;"><img src="https://img.ithome.com/newsuploadfiles/2022/3/493e5045-ca3a-447e-9aab-329bc7ce50b9.png" w="1074" h="430" alt="蒙娜丽莎" title="腾讯老照片修复算法开源：细节到头发丝，3 种预训练模型可下载，曾登顶 GitHub 热榜第一" width="1074" height="328" referrerpolicy="no-referrer"></p><p data-vmark="a46f">修复的爱因斯坦，笑起来时脸上的褶皱更加明显，头发丝、胡茬也都被还原了出来。</p><p data-vmark="1cdb" style="text-align: center;"><img src="https://img.ithome.com/newsuploadfiles/2022/3/3642fcaf-0d60-46b1-bbc0-f462ffda5213.png" w="1080" h="448" alt="爱因斯坦" title="腾讯老照片修复算法开源：细节到头发丝，3 种预训练模型可下载，曾登顶 GitHub 热榜第一" width="1080" height="340" referrerpolicy="no-referrer"></p><p data-vmark="be75">最后再来看看修复后的青年马化腾，这照片清晰地仿佛像昨天才拍出来一样。</p><p data-vmark="3e40" style="text-align: center;"><img src="https://img.ithome.com/newsuploadfiles/2022/3/8183c370-365c-4dfa-ad18-21b9bd46e56b.png" w="1056" h="426" alt="马化腾" title="腾讯老照片修复算法开源：细节到头发丝，3 种预训练模型可下载，曾登顶 GitHub 热榜第一" width="1056" height="331" referrerpolicy="no-referrer"></p><h2 data-vmark="cd47">盲脸修复 + 大量先验信息</h2><p data-vmark="7cb5">GFPGAN 能够快速、高清地修复各种人脸图像，<span class="accentTextColor">主要是应用了盲脸修复</span> （blind face restoration）。传统人脸修复方法主要针对同一场景下、特定退化的人脸图像修复。</p><p data-vmark="1154">比如此前一些人脸修复方法，会把 Obama 照片还原为白人面孔。这背后除了数据集存在偏差，还可能是算法没有为每张人脸特征性建模。</p><p data-vmark="4bfd" style="text-align: center;"><img src="https://img.ithome.com/newsuploadfiles/2022/3/4b4a5550-b213-4a4f-b49c-ee0076cdb283.png" w="1080" h="906" alt="Obama被还原为白人面孔" title="腾讯老照片修复算法开源：细节到头发丝，3 种预训练模型可下载，曾登顶 GitHub 热榜第一" width="1080" height="688" referrerpolicy="no-referrer"></p><p data-vmark="2995">盲脸修复就很好解决了这一弊端，它是指当点扩展函数未知或不确知的情况下，从低质的待修复人脸图像恢复出清晰、高质的目标人脸图像的过程。</p><p data-vmark="72b7">本质上是一种非匹配性的人脸修复方法。不过此前的一些盲脸修复方法在细节上表现不好，由此作者在 GFPGAN 中引入丰富的先验信息，从而来保证高质量的输出效果。</p><p data-vmark="339c" style="text-align: center;"><img src="https://img.ithome.com/newsuploadfiles/2022/3/22b00e24-186b-43a1-bd0e-d5eb2e1d7030.png" w="1080" h="433" alt="引入丰富的先验信息" title="腾讯老照片修复算法开源：细节到头发丝，3 种预训练模型可下载，曾登顶 GitHub 热榜第一" width="1080" height="329" referrerpolicy="no-referrer"></p><p data-vmark="2cb5">具体来看，在 GFP-GAN 的模型框架中，主要用到了一个退化清除模块和一个预训练的 GAN 作为先验。两个模块通过隐编码映射和多个信道分割空间特征变化层（CS-SFT）连接。训练过程中，首先要对低质量人脸进行降噪等粗处理，然后保留面部信息。</p><p data-vmark="2ef6">在保真度方面，研究人员引入了一个面部损失（ Facial Component Loss），判断哪些细节需要提升保留，然后再用识别保留损失（Identity Preserving Loss）进行修复。</p><h2 data-vmark="509b">团队介绍</h2><p data-vmark="c2ab">本文论文一作是 Xintao Wang，他是腾讯 ARC 实验室 (深圳应用研究中心) 的研究员。本科毕业于浙江大学，博士毕业于香港中文大学。其博士期间师从汤晓鸥教授和 Chen Change Loy 教授。研究方向为计算机视觉和深度学习，尤其关注图像、视频修复方面。</p><p data-vmark="18ab" style="text-align: center;"><img src="https://img.ithome.com/newsuploadfiles/2022/3/082dce7a-cf09-4565-a94e-2f5b710fdec8.png" w="601" h="601" alt="本文论文一作" title="腾讯老照片修复算法开源：细节到头发丝，3 种预训练模型可下载，曾登顶 GitHub 热榜第一" width="601" height="601" referrerpolicy="no-referrer"></p><p data-vmark="06d0">GitHub 地址：</p><p data-vmark="0b2a"><span class="link-text-start-with-http">https://github.com/TencentARC/GFPGAN</span></p><p data-vmark="98c5">论文地址：</p><p data-vmark="2a8e"><span class="link-text-start-with-http">https://arxiv.org/abs/2101.04061</span></p><p data-vmark="4ca3">试玩地址：</p><p data-vmark="322a"><span class="link-text-start-with-http">https://huggingface.co/spaces/akhaliq/GFPGAN</span></p>
          
</div>
            