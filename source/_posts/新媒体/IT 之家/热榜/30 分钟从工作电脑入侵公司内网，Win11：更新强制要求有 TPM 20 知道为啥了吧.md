
---
title: '30 分钟从工作电脑入侵公司内网，Win11：更新强制要求有 TPM 2.0 知道为啥了吧'
categories: 
 - 新媒体
 - IT 之家
 - 热榜
headimg: 'https://img.ithome.com/newsuploadfiles/2021/7/dc9bb355-c106-4c3d-b9b2-984f0d1f7728.png'
author: IT 之家
comments: false
date: Sat, 31 Jul 2021 06:24:34 GMT
thumbnail: 'https://img.ithome.com/newsuploadfiles/2021/7/dc9bb355-c106-4c3d-b9b2-984f0d1f7728.png'
---

<div>   
<p>工作电脑被偷的 30 分钟后，公司内网就进人了。</p><p>不仅拥有活动目录上的基本特权，还能在内部文件中来去自如！</p><p>可我那保护重重的 Windows 防火墙呢？</p><p>我那可以生成和存储各种密钥的 TPM 芯片呢？</p><p><img src="https://img.ithome.com/newsuploadfiles/2021/7/dc9bb355-c106-4c3d-b9b2-984f0d1f7728.png" w="1080" h="572" title="30 分钟从工作电脑入侵公司内网，Win11：更新强制要求有 TPM 2.0 知道为啥了吧" width="1080" height="434" referrerpolicy="no-referrer"></p><p>黑客到底是怎么越过这些阻碍的？</p><h2>绕过 TPM</h2><p>好，现在请出我们的受害者 ——</p><p>一台 <a class="s_tag" href="https://win10.ithome.com/" target="_blank">Windows 10</a> 系统的联想笔记本电脑。</p><p>使用的是微软的 BitLocker，通过微软的可信平台模块（TPM）加密。</p><p>这时，要提取驱动器解密密钥进而入侵内网，就需要从 TPM 入手：</p><p><img src="https://img.ithome.com/newsuploadfiles/2021/7/a5136686-b2cd-4069-881d-c8b68c08d869.png" w="667" h="437" title="30 分钟从工作电脑入侵公司内网，Win11：更新强制要求有 TPM 2.0 知道为啥了吧" width="667" height="437" referrerpolicy="no-referrer"></p><p>不过这是一种结构高度复杂，且含有许多篡改检测和保护的硬件。直接攻击可能会花费大量时间。</p><p>因此，我们可以关注一下 TPM 周围的依赖关系和内容。</p><p>比如…… 并没有使用 TPM 2.0 标准的加密通信特性的 BitLocker。</p><p>这意味着从 TPM 发出的数据都是以明文形式游走在 SPI 总线上的，包括 Windows 的解密密钥。</p><p>如果能抓住那个密钥，就能够解密驱动器，获得 VPN 客户端配置的访问权限，进而有访问内部网络的可能。</p><p>可现在问题又来了。</p><p>要抓取 SPI 总线上的数据，就要将引线或探针连接到 TPM 的引脚上。</p><p>而这个“引脚”只有 0.25 毫米宽，0.5 毫米间隔，还是一个平放在芯片面上，难以用物理方式连接的伪・引脚。</p><p>那有没有更大，更好连接的呢？</p><p>还真有：</p><p><img src="https://img.ithome.com/newsuploadfiles/2021/7/2345364b-7852-4998-a202-efb8a9404578.png" w="672" h="393" title="30 分钟从工作电脑入侵公司内网，Win11：更新强制要求有 TPM 2.0 知道为啥了吧" width="672" height="393" referrerpolicy="no-referrer"></p><p>这是与 TPM 共享一个 SPI 总线的 CMOS 芯片，它的引脚非常清晰分明。</p><p>好，Saleae 逻辑分析仪，连接！</p><p><img src="https://img.ithome.com/newsuploadfiles/2021/7/4a107d74-daf7-4275-8349-150b5a8f7b68.png" w="755" h="618" title="30 分钟从工作电脑入侵公司内网，Win11：更新强制要求有 TPM 2.0 知道为啥了吧" width="755" height="618" referrerpolicy="no-referrer"></p><h2>从预登陆功能的“后门”入侵</h2><p>现在，探测仪已经连接，开始启动电脑。</p><p>我们现在需要在数以百万计的 SPI 字节中，找到一个正在被发送的 BitLocker 解密密钥。</p><p>先用高级分析器（HLA）进行事务分析：</p><p><img src="https://img.ithome.com/newsuploadfiles/2021/7/ce83e8d5-fd67-4180-9ac2-a2d0124c1dbc.png" w="1080" h="374" title="30 分钟从工作电脑入侵公司内网，Win11：更新强制要求有 TPM 2.0 知道为啥了吧" width="1080" height="284" referrerpolicy="no-referrer"></p><p>经过几天的故障排除和比较之后，我们发现了 TPM 命令包的不同位掩码的组合，以及用于寻找密钥的不同正则表达式。</p><p>再用 bitlocker-spi-toolkit 解析这些请求，钥匙就拿到了！</p><p><img src="https://img.ithome.com/newsuploadfiles/2021/7/040512a8-eb8d-4a6b-a13a-8a0a12317dae.png" w="1080" h="508" title="30 分钟从工作电脑入侵公司内网，Win11：更新强制要求有 TPM 2.0 知道为啥了吧" width="1080" height="386" referrerpolicy="no-referrer"></p><p>接下来让我们用钥匙解密固盘（SSD），看看里面到底有什么。</p><p>拔出固态硬盘，安装在一个适配器上，然后插上：</p><p><img src="https://img.ithome.com/newsuploadfiles/2021/7/58f447d9-64cd-4b1d-b516-55b943280a7f.png" w="671" h="500" title="30 分钟从工作电脑入侵公司内网，Win11：更新强制要求有 TPM 2.0 知道为啥了吧" width="671" height="500" referrerpolicy="no-referrer"></p><p>在做了一个磁盘镜像之后，我们使用 Dislocker 工具集来解密驱动器：</p><p><img src="https://img.ithome.com/newsuploadfiles/2021/7/19779a2d-4115-4bdf-aafd-f2d1708b36cf.png" w="667" h="480" title="30 分钟从工作电脑入侵公司内网，Win11：更新强制要求有 TPM 2.0 知道为啥了吧" width="667" height="480" referrerpolicy="no-referrer"></p><p>现在就可以离线访问内容的明文了！</p><p>此外，我们还发现了正在使用的 VPN 客户端: Palo Alto 的全球保护（GP）。</p><p>GP 有一项预登陆（Pre-logon）功能，会对端点（而不是用户）进行身份验证，并允许域脚本或其他任务在端点启动后立即运行。</p><p>这样，我们就可以使用粘滞键后门（Sticky Keys Backdoor），在不需要任何凭证的的前提下访问 VPN。</p><p>有了后门访问之后，我们需要将解密后的 Windows 映像引导为虚拟机。</p><p>因此，先创建一个 VMDK，将解密 BitLocker 分区和加密映像的起始扇区映射到适当的 VM 分区：</p><p><img src="https://img.ithome.com/newsuploadfiles/2021/7/f41dc9f2-85f9-49c9-9065-0347d999385a.png" w="671" h="569" title="30 分钟从工作电脑入侵公司内网，Win11：更新强制要求有 TPM 2.0 知道为啥了吧" width="671" height="569" referrerpolicy="no-referrer"></p><p>再使用 VMDK 和粘滞键后门的 WIndows 镜像，创建并启动虚拟机，按下 WIndows + U：</p><p><img src="https://img.ithome.com/newsuploadfiles/2021/7/007d43fa-0532-4bd3-988a-b5f01c291e2b.png" w="1024" h="768" title="30 分钟从工作电脑入侵公司内网，Win11：更新强制要求有 TPM 2.0 知道为啥了吧" width="1024" height="615" referrerpolicy="no-referrer"></p><p>△全球保护状态：已连接</p><p>然后就可以在域中运行基本的 SMB 命令了。</p><p>比如查询如用户、组、系统等网域控制器的各种类型的领域信息。</p><p>或者列出并查看中小企业内部共享的文件内容：</p><p><img src="https://img.ithome.com/newsuploadfiles/2021/7/390d7388-1522-443d-a904-49ea2e941e7f.png" w="600" h="404" title="30 分钟从工作电脑入侵公司内网，Win11：更新强制要求有 TPM 2.0 知道为啥了吧" width="600" height="404" referrerpolicy="no-referrer"></p><p>还可以通过访问这个电脑帐户来发动内部攻击。</p><p>比如将一个文件写入内部文件服务器，并将其读回：</p><p><img src="https://img.ithome.com/newsuploadfiles/2021/7/e6ceb0f6-ace2-4fc7-ad69-b237b2e2cfb8.png" w="804" h="537" title="30 分钟从工作电脑入侵公司内网，Win11：更新强制要求有 TPM 2.0 知道为啥了吧" width="804" height="537" referrerpolicy="no-referrer"></p><p>至此，我们已经获得了内部网络的访问权限 ——</p><p>包括在活动目录上的基本特权，以及对内部文件共享的访问权限。</p><p>而以此开始做 LNK 攻击或 trojaned pdf 等入侵，最终致使数据泄露也就有了可能。</p><h2>Windows11 更新强制要求设备有 TPM2.0</h2><p>当然，上述的所有过程都不是真的黑客攻击。</p><p>而是美国的一家网络安全公司 Dolos Group 面对客户疑惑的回应：</p><blockquote><p>你能用偷来的笔记本干什么？能进入我们的内网吗？</p></blockquote><p><img src="https://img.ithome.com/newsuploadfiles/2021/7/b541894a-30bb-4c8d-bc8d-472d04621b09.png" w="1080" h="210" title="30 分钟从工作电脑入侵公司内网，Win11：更新强制要求有 TPM 2.0 知道为啥了吧" width="1080" height="159" referrerpolicy="no-referrer"></p><p>因此，Dolos Group 团队就展示了如何使用一台“被盗”的公司笔记本电脑，将几个漏洞链接在一起，最后进入公司内网。</p><p>而让人注意的是，Dolos Group 团队在入侵的最开始就提到：</p><blockquote><p>BitLocker 没有使用 TPM 2.0 标准的加密通信特性。</p></blockquote><p>这不禁让人想到了 Windows11 更新时强制要求设备有 TPM2.0 的措施：</p><p><img src="https://img.ithome.com/newsuploadfiles/2021/7/0436aaa0-1642-4740-9d5b-1a9c18f3a5e2.png" w="1080" h="419" title="30 分钟从工作电脑入侵公司内网，Win11：更新强制要求有 TPM 2.0 知道为啥了吧" width="1080" height="318" referrerpolicy="no-referrer"></p><p>所以，2.0 版本对比 1.X 标准都增加了哪些功能？</p><p>简单来说，<span class="accentTextColor">TPM 2.0 大幅增加了模块内置加密算法的种类和安全性。</span></p><p>因此兼容的软件和场景更多，生成的密码更长更难破解。</p><p>结合上文对适用了旧版本 TPM 的电脑的入侵，微软会将 TPM2.0 列入 <a class="s_tag" href="https://win11.ithome.com/" target="_blank">Windows 11</a> 的必须硬件配置列表中，似乎也就不难理解了。</p><p>不过，也有网友对此表示：</p><blockquote><p>为了避免这种问题，你应该有一个必要的外部密码来解锁硬盘，而非 TPM。</p></blockquote><p><img src="https://img.ithome.com/newsuploadfiles/2021/7/14e74fe8-0dec-44d0-99ed-a304c631d6f7.png" w="1080" h="121" title="30 分钟从工作电脑入侵公司内网，Win11：更新强制要求有 TPM 2.0 知道为啥了吧" width="1080" height="92" referrerpolicy="no-referrer"></p>
          
</div>
            