
---
title: '秒秒钟揪出张量形状错误，这个工具能防止 ML 模型训练白忙一场'
categories: 
 - 新媒体
 - IT 之家
 - 分类资讯
headimg: 'https://img.ithome.com/newsuploadfiles/2021/12/5fc7ad84-8bd5-4048-959b-32575f5c4f37.png'
author: IT 之家
comments: false
date: Mon, 27 Dec 2021 14:29:45 GMT
thumbnail: 'https://img.ithome.com/newsuploadfiles/2021/12/5fc7ad84-8bd5-4048-959b-32575f5c4f37.png'
---

<div>   
<p data-vmark="6b99">模型吭哧吭哧训练了半天，结果发现张量形状定义错了，这一定没少让你抓狂吧。那么针对这种情况，是否存在较好的解决方法呢？</p><p data-vmark="6067">这不最近，韩国首尔大学的研究者就开发出了一款“利器”—— PyTea。</p><p data-vmark="174e">据研究人员介绍，<span class="accentTextColor">它在训练模型前，能几秒内帮助你静态分析潜在的张量形状错误</span>。</p><p data-vmark="0318">那么 PyTea 是如何做到的，到底靠不靠谱，让我们一探究竟吧。</p><h2 data-vmark="4600">PyTea 的出场方式</h2><blockquote><p data-vmark="4f29">为什么张量形状错误这么重要？</p></blockquote><p data-vmark="0d23">神经网络涉及到一系列的矩阵计算，前面矩阵的列数必需匹配后面矩阵的行数，如果维度不匹配，那后面的运算就都无法运行了。</p><p data-vmark="c959"><img src="https://img.ithome.com/newsuploadfiles/2021/12/5fc7ad84-8bd5-4048-959b-32575f5c4f37.png" w="1072" h="436" alt="图片" title="秒秒钟揪出张量形状错误，这个工具能防止 ML 模型训练白忙一场" width="1072" height="334" referrerpolicy="no-referrer"></p><p data-vmark="b544">上图代码就是一个典型的张量形状错误，[B x 120] * [80 x 10] 无法进行矩阵运算。</p><p data-vmark="ea26"><img src="https://img.ithome.com/newsuploadfiles/2021/12/0b69378b-c481-49dd-aa99-56c0e822db3f.png" w="1080" h="375" alt="图片" title="秒秒钟揪出张量形状错误，这个工具能防止 ML 模型训练白忙一场" width="1080" height="285" referrerpolicy="no-referrer"></p><p data-vmark="2891">无论是 PyTorch，TensorFlow 还是 Keras 在进行神经网络的训练时，大多都遵循图上的流程。</p><p data-vmark="7336">首先定义一系列神经网络层（也就是矩阵），然后合成神经网络模块……</p><blockquote><p data-vmark="9cd2">那么为什么需要 PyTea 呢？</p></blockquote><p data-vmark="71c4">以往我们都是在模型读取大量数据，开始训练，代码运行到错误张量处，才可以发现张量形状定义错误。</p><p data-vmark="2525">由于模型可能十分复杂，训练数据非常庞大，所以发现错误的时间成本会很高，有时候代码放在后台训练，出了问题都不知道……</p><p data-vmark="e00c">PyTea 就可以有效帮我们避免这个问题，因为它能在运行模型代码之前，就帮我们分析出形状错误。</p><p data-vmark="891e"><img src="https://img.ithome.com/newsuploadfiles/2021/12/91caf1b2-b5d5-4270-8be7-665f7eb60858.png" w="1080" h="300" alt="图片" title="秒秒钟揪出张量形状错误，这个工具能防止 ML 模型训练白忙一场" width="1080" height="228" referrerpolicy="no-referrer"></p><p data-vmark="132c">网友们已经在热烈讨论了。</p><p data-vmark="cbc8">PyTea 是如何运作的，它能否有效地检查出错误呢？</p><p data-vmark="f865"><img src="https://img.ithome.com/newsuploadfiles/2021/12/a1a856eb-04c1-41ce-9413-014e1fb7e144.png" w="1080" h="254" alt="图片" title="秒秒钟揪出张量形状错误，这个工具能防止 ML 模型训练白忙一场" width="1080" height="193" referrerpolicy="no-referrer"></p><p data-vmark="110f">受各种约束条件的影响，代码可能的运行路径有很多，不同的数据会走向不同的路径。</p><p data-vmark="bf88">所以 PyTea 需要静态扫描所有可能的运行路径，跟踪张量变化，推断出每个张量形状精确而保守的范围。</p><p data-vmark="649b">上图就是 PyTea 的整体架构，一共分为翻译语言，收集约束条件，求解器判断和给出反馈四步。</p><p data-vmark="b65a"><img src="https://img.ithome.com/newsuploadfiles/2021/12/60ef8498-4c1e-4a53-b9ee-26b630e52480.png" w="570" h="538" alt="图片" title="秒秒钟揪出张量形状错误，这个工具能防止 ML 模型训练白忙一场" width="570" height="538" referrerpolicy="no-referrer"></p><p data-vmark="192d">首先 PyTea 将原始的 Python 代码翻译成一种内核语言。PyTea 内部表示法（PyTea IR）。</p><p data-vmark="7b37"><img src="https://img.ithome.com/newsuploadfiles/2021/12/f122a192-0b1f-442e-a278-9a509685a803.png" w="978" h="556" alt="图片" title="秒秒钟揪出张量形状错误，这个工具能防止 ML 模型训练白忙一场" width="978" height="466" referrerpolicy="no-referrer"></p><p data-vmark="6abf">接着 PyTea 追踪 PyTea IR 每个可能的执行路径，并收集有关张量形状的约束条件。</p><p data-vmark="5ba8">判断约束条件是否被满足，<span class="accentTextColor">分为线上分析和离线分析两步</span>：</p><ul class=" list-paddingleft-2"><li><p data-vmark="c945">线上分析 node.js（TypeScript / JavaScript）：查找张量形状数值上的不匹配和误用 API 函数的情况。如果 PyTea 发现问题，就会停止在当前位置，然后给用户报错。</p></li></ul><p data-vmark="c51c"><img src="https://img.ithome.com/newsuploadfiles/2021/12/9f0e41b1-0ccd-40e3-a788-f01931005b65.png" w="1080" h="544" alt="图片" title="秒秒钟揪出张量形状错误，这个工具能防止 ML 模型训练白忙一场" width="1080" height="413" referrerpolicy="no-referrer"></p><ul class="ai-word-checked list-paddingleft-2"><li><p data-vmark="30f4">离线分析 Z3 / Python：如果线上分析没有问题，PyTea 将收集到的约束条件传给 SMT（Satisfiability Modulo Theories）求解器 Z3，求解器负责查看每条路径的约束条件是否都能被满足，如果不能，返回给用户第一条出错路径的约束条件。</p></li></ul><p data-vmark="09e1"><img src="https://img.ithome.com/newsuploadfiles/2021/12/d132a004-afbd-41e0-9643-2b7ddb0e7479.png" w="1080" h="380" alt="图片" title="秒秒钟揪出张量形状错误，这个工具能防止 ML 模型训练白忙一场" width="1080" height="289" referrerpolicy="no-referrer"></p><p data-vmark="1469">如果求解器过久没有反应，PyTea 会返回不知道是否存在问题。</p><p data-vmark="4499">然而追踪所有可能的路径是指数级别的任务，对于复杂的神经网络来说，一定会发生路径爆炸这个问题。</p><p data-vmark="f088"><img src="https://img.ithome.com/newsuploadfiles/2021/12/06f2cbfa-faa4-43fb-b57d-7d60236150f3.png" w="560" h="502" alt="图片" title="秒秒钟揪出张量形状错误，这个工具能防止 ML 模型训练白忙一场" width="560" height="502" referrerpolicy="no-referrer"></p><p data-vmark="68c6">比如说在这个例子中，网络的最终结构是由 24 个相同模块块构成的（第 17 行），那么可能的路径就有 16M 之多。</p><blockquote><p data-vmark="c6cc">所以路径爆炸是一定要处理的，PyTea 是怎么做的？</p></blockquote><p data-vmark="4007">PyTea 选择保守的地对路径剪枝和超时判断来处理这种路径爆炸。</p><blockquote><p data-vmark="c255">什么样的路径可以被剪枝？</p></blockquote><p data-vmark="ff21">PyTea 给出的答案是，如果该前馈函数不改变全局值，并且它的输出值不受分支条件影响，对于每条路径都是相等的，我们就可以忽略许多完全一致的路径，来节约计算资源。</p><p data-vmark="894e">如果路径剪枝还是不行，那么就只能按超时处理了。</p><p data-vmark="7197">原理就介绍这么多了，感觉还是值得一试的，现在代码已经在 GitHub 上面开源了，快去看看吧！</p><h2 data-vmark="fc19">使用方法</h2><p data-vmark="688e">依赖库：</p><p data-vmark="9302"><img src="https://img.ithome.com/newsuploadfiles/2021/12/d5ce9831-d1cf-46cc-931d-d27a3b5b110d.png" w="670" h="156" alt="图片" title="秒秒钟揪出张量形状错误，这个工具能防止 ML 模型训练白忙一场" width="670" height="156" referrerpolicy="no-referrer"></p><p data-vmark="049c">安装方法：</p><p data-vmark="e8bb"><img src="https://img.ithome.com/newsuploadfiles/2021/12/00784b63-de68-4659-8999-a1d8d44f5ff5.png" w="1080" h="306" alt="图片" title="秒秒钟揪出张量形状错误，这个工具能防止 ML 模型训练白忙一场" width="1080" height="232" referrerpolicy="no-referrer"></p><p data-vmark="f2e4">运行命令：</p><p data-vmark="aa05"><img src="https://img.ithome.com/newsuploadfiles/2021/12/517c0d60-f949-4345-97bf-d23e202130e1.png" w="1080" h="206" alt="图片" title="秒秒钟揪出张量形状错误，这个工具能防止 ML 模型训练白忙一场" width="1080" height="156" referrerpolicy="no-referrer"></p><p data-vmark="bc7f"><strong>参考链接</strong>：</p><p data-vmark="7edd"><span class="no-auto-spacing">[1]<span class="link-text-start-with-http">https://github.com/ropas/pytea</span></span></p><p data-vmark="41d4"><span class="no-auto-spacing">[2]<span class="link-text-start-with-http">https://arxiv.org/abs/2112.09037</span></span></p>
          
</div>
            