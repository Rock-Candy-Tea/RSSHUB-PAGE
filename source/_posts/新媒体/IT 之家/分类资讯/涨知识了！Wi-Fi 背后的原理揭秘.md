
---
title: '涨知识了！Wi-Fi 背后的原理揭秘'
categories: 
 - 新媒体
 - IT 之家
 - 分类资讯
headimg: 'https://img.ithome.com/newsuploadfiles/2022/5/6317e84a-780d-4cb6-b6c7-5a9e73b11b78.png'
author: IT 之家
comments: false
date: Fri, 06 May 2022 12:27:17 GMT
thumbnail: 'https://img.ithome.com/newsuploadfiles/2022/5/6317e84a-780d-4cb6-b6c7-5a9e73b11b78.png'
---

<div>   
<p data-vmark="9cc0">Wi-Fi 和 4G / 5G 蜂窝网络，是我们上网时最常用的两种接入方式。</p><p data-vmark="1309">这两种接入方式，平时在上网时似乎没感觉到有什么区别。然而，它们却是完全不同的设计哲学。</p><p data-vmark="c3e1">蜂窝网络以基站为小区中心，基站承担了小区的中央控制、用户授权和调度。</p><p data-vmark="f63e">以 5G 为例，基站在每个帧中广播同步信号块 SSB。SSB 包含了小区的 PCI（物理小区标识）、基站的同步时间信息、空口信息、接入控制等参数。</p><p data-vmark="f214">手机在确认同步信号后，通过随机接入信道 PRACH，发送接入前导序列 Preamble，以此获取基站授权接入。不同的用户，采用不同的 ZC 正交序列来区分。</p><p data-vmark="d553">在接入后，无线信道分配好上下行时隙（这里特指 TDD 网络），基站和所有终端都在固定的时间内进行数据发送或接收。这种设计理念以基站作为小区中心，采用中心规划的设计哲学。</p><p data-vmark="6c81">而 Wi-Fi 网络则不同。</p><p data-vmark="cdae">Wi-Fi 在设计时，将 AP 接入点（这里 AP 的功能等同于 5G 中的基站）和用户终端放在同等的位置考虑。<span class="accentTextColor">基于 802.11 协议的 AP 和终端，采用了载波侦听多路访问 / 碰撞避免（CSMA / CA）的方式，来平等竞争占用无线信道。</span></p><p data-vmark="dee6">AP 和终端、终端与终端之间，在接入网络时先进行无线信道侦听。在确保信道没被占用的情况下，接入网络。设备之间并不分层级，而是采用自协调竞争接入的模式，访问网络。</p><p data-vmark="3d11">从某种意义上，Wi-Fi 网络是一种去中心化的设计哲学。</p><p data-vmark="b321">这两种设计哲学，各有千秋。</p><p data-vmark="61c5">蜂窝网络考虑的侧重点，是多设备接入时的容量和效率。而 Wi-Fi，由于其使用非授权频谱以及成本上考量，设计时更加侧重于抗干扰、低成本等特性。</p><p data-vmark="d082">两种方案都能让信道得到充分的利用。参考 Aruba Networks 发布的测试结果可以看出，LTE 和 Wi-Fi 6 在 MAC 层面的频谱使用效率非常接近，单流、256QAM 的情况下，都能到 5Mbps / Hz 以上的频谱使用效率。</p><p style="text-align: center;" data-vmark="10a6"><img src="https://img.ithome.com/newsuploadfiles/2022/5/6317e84a-780d-4cb6-b6c7-5a9e73b11b78.png" w="606" h="347" title="涨知识了！Wi-Fi 背后的原理揭秘" width="606" height="347" referrerpolicy="no-referrer"></p><p style="text-align: center;" data-vmark="cafb">图 1 LTE 与 Wi-Fi 在频谱使用效率上的对比</p><h3 data-vmark="8819">█ 接入过程与漫游</h3><p data-vmark="c0ce">那么，没有中心控制的 Wi-Fi，具体是怎么协作接入的呢？</p><p data-vmark="7cb1">首先第一步，是寻找 Wi-Fi 网络。</p><p data-vmark="4c71">由于 Wi-Fi 网络中 AP 没有广播功能，终端是不可能预先知道是否有可用的网络资源以及 AP 参数的。</p><p data-vmark="444d">这里，终端采用了一种主动探针的方式来进行请求。</p><p data-vmark="4579">终端会在 Wi-Fi 的第一个 20MHz 频道上，发送一系列探针序列，然后等待 AP 回应。</p><p data-vmark="cff6">如果 20ms 后 AP 没有回应的话，终端将切换到下一个 20MHz 频道，重复上述动作，直到收到 AP 的回应，确认 AP 的工作频段和接入参数才能接入网络。</p><p style="text-align: center;" data-vmark="f275"><img src="https://img.ithome.com/newsuploadfiles/2022/5/453dbe66-97b0-4c46-a8a6-69c361cdb7cd.png" w="936" h="427" title="涨知识了！Wi-Fi 背后的原理揭秘" width="936" height="374" referrerpolicy="no-referrer"></p><p style="text-align: center;" data-vmark="61ac">图 2 手机进行主动扫探针搜寻信道过程</p><p data-vmark="aea3">写到这里，你可能会想到，如果室内有多个 Wi-Fi AP，当用户在移动，终端从一个 AP 切换到另一个 AP 时，还要重复上述的 AP 搜寻过程吗？</p><p data-vmark="baf3">每个频道 20ms，搜索一圈信道下来，需要较长时间，连接岂不是会中断？那还怎么确保视频会议或者微信语音的通信质量呢？</p><p data-vmark="84ba">现在的办公室甚至现在很多家庭无线局域网，都会采用多 AP mesh 组网的方式，来提高网络覆盖性能。</p><p data-vmark="45d8">如果每次终端切换 AP 时，都重新做上述的主动探针搜寻信道过程，将是会非常低效的。好在 802.11 工作组考虑到了小区切换的问题，在 802.11k 中开发了“邻居报告”的协议。</p><p data-vmark="6b71">设备在接入 AP 后，该 AP 会将其附近 AP 的 BSSID 和频道信息发送给用户。这样一来，用户在需要切换到另一个 AP 时，就不用再扫描一遍频道了。</p><p data-vmark="8597">这样做的好处，一来是极大节省了切换时间，保证通信不出现中断。二来是给用户设备省电，设备不再需要发送一个个探针。第三，就是无线信道也得到了更加有效的利用，AP 不需要频繁占用无线信道来不断回应终端的请求。</p><p style="text-align: center;" data-vmark="678b"><img src="https://img.ithome.com/newsuploadfiles/2022/5/88f824a5-12b5-4ca8-8b26-a53ff4373880.jpg" w="550" h="402" title="涨知识了！Wi-Fi 背后的原理揭秘" width="550" height="402" referrerpolicy="no-referrer"></p><p style="text-align: center;" data-vmark="54c2">图 3 AP 通过 802.11k 协议回应终端设备其邻近 AP 的信息</p><h3 data-vmark="039b">█ 自我协调，信道竞争接入，避免冲突</h3><p data-vmark="10ba">接入网络后，AP 和终端们便开始竞争无线信道的使用。</p><p data-vmark="0f88">在 Wi-Fi 系统中，终端和 AP 的空口时间统一被分为空闲（Idle）和机会发送（TXOP）时段。没有数据时，设备属于空闲期，不会发送任何信息。</p><p data-vmark="61e0">当设备收到数据发送请求时，设备开始进入争夺无线信道的“仲裁”（Arbitration）过程。没有中央调度器，所有设备按照数据优先级采用“公平竞争”模式来赢得信道仲裁。赢得信道的设备，将会得到 6ms 的机会发送窗，然后进入下一个仲裁期。</p><p style="text-align: center;" data-vmark="fccc"><img src="https://img.ithome.com/newsuploadfiles/2022/5/ba907351-3c81-443c-8651-e12cb8464000.png" w="1080" h="177" title="涨知识了！Wi-Fi 背后的原理揭秘" width="1080" height="134" referrerpolicy="no-referrer"></p><p style="text-align: center;" data-vmark="f524">图 4 802.11 中的空口时间分配</p><p data-vmark="3c97">进入仲裁过程的 Wi-Fi 设备，首先开启信道侦听模式，RF 接收机对无线信道中的 802.11 信号进行监测（Signal Detection）。如果侦听到的信号强度低于其 SD 阈值（以下图思科的方案为例，阈值为-82dBm）时，设备判定目前信道没有其他 Wi-Fi 设备在使用。</p><p data-vmark="3ce9">由于 Wi-Fi 使用的频段属于免授权频段，需要与非 802.11 设备共享使用，比如蓝牙，遥控器，微波炉等等。那么，在判断信道占用情况时，不仅仅需要能对自身 802.11 协议的信号进行监测，还需要对不明通信协议的功率进行检测。</p><p data-vmark="27d8">这里就引出了第二个检测机制 —— 能量检测（Energy Detection）。</p><p data-vmark="3f9b">ED 的作用，是判断无线信道没有被其他非 Wi-Fi 设备占用，防止发送的有用 Wi-Fi 信号被淹没在噪声中，通常 ED 的门限比 SD 高 20dB。</p><p style="text-align: center;" data-vmark="f353"><img src="https://img.ithome.com/newsuploadfiles/2022/5/b7289cb7-6ab2-421f-b179-96d2d13b06d2.png" w="1043" h="537" title="涨知识了！Wi-Fi 背后的原理揭秘" width="1043" height="422" referrerpolicy="no-referrer"></p><p style="text-align: center;" data-vmark="28f1">图 5 思科无线设备的 SD，ED 设定</p><p data-vmark="a92e">细心的用户可能会发现，在网络环境不好的情况下，视频通话时经常有能听到声音但图像被卡住的现象。这其实是 Wi-Fi 的一种发送优化措施，用于保障最基本的服务。</p><p data-vmark="4fdc">Wi-Fi 将数据分为四种不同的优先级，从上到下分别为语音（VO），视频（VI），最大努力（BE）和背景（BK）。每一个级别，都会附上不同的 AIFS 值。AIFS 值越低，发送优先级越高。</p><p data-vmark="1989">在 AIFS 时间结束之后，设备便进入了竞争窗口（CW），设备开始侦听无线信道，同时开始倒计时准备发送。</p><p data-vmark="6ee1">当 CW 倒计时结束时，如果设备发现信道正在占用，设备便自动进入下一个仲裁期。如果设备发现信道处于空闲状态，便开始占用信道，发送数据。</p><p data-vmark="fce9">下图这个例子，在第一个仲裁期中，IPad 的 CW 时间最短，竞争信道成功，获得了发送权。在 IPad 数据发送后，一轮新的仲裁开始，手机在 CW 结束后，发现信道没有被占用，获得了发送权。最终，无线 AP 赢得了第三轮仲裁，获得发送权。</p><p style="text-align: center;" data-vmark="99b6"><img src="https://img.ithome.com/newsuploadfiles/2022/5/583c9fb3-e5f8-4f3e-927a-29a30a8a0a34.png" w="1080" h="461" title="涨知识了！Wi-Fi 背后的原理揭秘" width="1080" height="350" referrerpolicy="no-referrer"></p><p style="text-align: center;" data-vmark="0f78">图 6 多设备信道竞争过程</p><p data-vmark="1dd9">读到这里，你可能会发现，这个竞争过程在设备增多的情况下，效率会明显降低，每个设备的等待发送时间将会变长很多。</p><p data-vmark="4331">实际体验中，你可能也注意到了，在 Wi-Fi 设备多的公共环境，比如商场、学校中，经常需要等待很长时间，才能发送或接收数据。</p><p data-vmark="ef49">那么，很有可能是网络还没有升级到最新的 Wi-Fi 6。</p><p data-vmark="5164">Wi-Fi 6 可以说是 Wi-Fi 行业过去十多年中最大的一次革新。具体 Wi-Fi 6 是通过哪些新特性来解决多设备下网络阻塞的问题呢？我会在下一期的文章中给大家一一道来。</p>
          
</div>
            