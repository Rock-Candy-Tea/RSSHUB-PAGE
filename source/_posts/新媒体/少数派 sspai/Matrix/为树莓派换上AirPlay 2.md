
---
title: '为树莓派换上AirPlay 2'
categories: 
 - 新媒体
 - 少数派 sspai
 - Matrix
headimg: 'https://cdn.sspai.com/2022/07/18/fe598ebe8921f9c96302be0921711326.png?imageView2/2/w/1120/q/40/interlace/1/ignore-error/1'
author: 少数派 sspai
comments: false
date: Tue, 19 Jul 2022 09:44:50 GMT
thumbnail: 'https://cdn.sspai.com/2022/07/18/fe598ebe8921f9c96302be0921711326.png?imageView2/2/w/1120/q/40/interlace/1/ignore-error/1'
---

<div>   
<div class="articleWidth-content" data-v-557a067a><div class="update-wrap" data-v-557a067a></div><div class="content wangEditor-txt minHeight" data-v-557a067a><p>这两天在Reddit上看到一个关于「AirPlay 2 on Linux」的帖子，其中推荐了 <a href="https://github.com/mikebrady/shairport-sync" target="_blank">Shairport Sync </a>项目，于是我打算给家里在用的树莓派的AirPlay升级一下。大家有能力的可以直接去看<a href="https://github.com/mikebrady/shairport-sync/blob/development/AIRPLAY2.md" target="_blank">原文</a>，里面文档写的很详细。</p><h2>准备</h2><ul><li>一台Linux 或 FreeBSD的设备，其性能至少要大于等于树莓派 2</li><li>319 和 320端口没有被占用</li><li>一个音箱（最好是3.5mm接口）</li></ul><h2>开始安装</h2><p>首选建议大家先将系统更新到最新状态，可以大大减少许多莫名其妙的问题。</p><pre class="language-shell"><code>sudo apt-get update #检查更新
sudo apt-get upgrade #执行更新</code></pre><h3>关闭Wi-Fi节能管理</h3><p>如果你使用设备使用Wi-Fi连接的话，需要将节能管理关闭，可以避免安装后设备进入节能后搜索不到音箱。</p><pre class="language-shell"><code>iwconfig wlan0 power off</code></pre><h3>安装依赖</h3><p>以下是Shairport Sync需要依赖</p><pre class="language-shell"><code>apt install --no-install-recommends build-essential git xxd xmltoman \ 
autoconf automake libtool libpopt-dev libconfig-dev libasound2-dev \ 
avahi-daemon libavahi-client-dev libssl-dev libsoxr-dev libplist-dev \ 
libsodium-dev libavutil-dev libavcodec-dev libavformat-dev uuid-dev libgcrypt-dev</code></pre><h3><strong>nqptp</strong></h3><p><a href="https://github.com/mikebrady/nqptp" target="_blank">nqptp</a>是 <strong>Shairport Sync </strong>监控时间的重要依赖，需要手动编译安装。</p><pre class="language-shell"><code>git clone https://github.com/mikebrady/nqptp.git #下载项目
cd nqptp #进入项目目录
autoreconf -fi #编译
./configure --with-systemd-startup #配置
make #构建环境
make install #安装</code></pre><p>安装完毕后，需要启动<a href="https://github.com/mikebrady/nqptp" target="_blank">nqptp</a>：</p><pre class="language-shell"><code>systemctl enable nqptp #设置自动启动
systemctl start nqptp #启动nqptp</code></pre><h3><strong>sps-alsa-explore</strong></h3><p>一个可以帮助我们<strong>Shairport Sync</strong>的工具，可以很直观的列出当前的音频输出设备，需要手动编译安装。</p><pre class="language-shell"><code>git clone https://github.com/mikebrady/sps-alsa-explore.git #下载项目
cd sps-alsa-explore #进入项目目录
autoreconf -fi #编译
./configure #配置
make #构建环境</code></pre><p>将音箱连接到树莓派，然后在sps-alsa-explore目录下执行<code>./sps-alsa-explore</code>：</p><figure class="image ss-img-wrapper"><img src="https://cdn.sspai.com/2022/07/18/fe598ebe8921f9c96302be0921711326.png?imageView2/2/w/1120/q/40/interlace/1/ignore-error/1" data-original="https://cdn.sspai.com/2022/07/18/fe598ebe8921f9c96302be0921711326.png" referrerpolicy="no-referrer"></figure><p>记录下<code>Device Full Name:"hw:Headphones"</code>和<code>Possible mixers:"Headphone"</code> 在后续配置文件中使用。</p><h3>编译安装 <strong>Shairport Sync</strong></h3><pre class="language-shell"><code>git clone https://github.com/mikebrady/shairport-sync.git #下载项目
cd shairport-sync  #进入项目目录
git checkout development #切换到development分支
autoreconf -fi #编译
./configure --sysconfdir=/etc --with-alsa --with-soxr --with-avahi --with-ssl=openssl --with-systemd --with-airplay-2 #配置
make -j #构建环境
make install #安装</code></pre><h3>配置 <strong>Shairport Sync</strong></h3><p><strong>Shairport Sync</strong> 的配置文件路径在<code>/etc/shairport-sync.conf</code>，其中输出设备这里需要配置一下，熟悉vi/vim的朋友可以直接 <code>sudo vi /etc/shairport-sync.conf</code>配置一下，其中<code>output_device</code>和<code>mixer_control_name</code>都可以在前面<code>./sps-alsa-explore</code>的结果中找到。</p><pre class="language-shell"><code>alsa =
&#123;
  output_device = "hw:Headphones";
  mixer_control_name = "Headphone";
&#125;;</code></pre><p>配置文件中有大量注释说明，大家可以按需配置。</p><h3><strong>启动Shairport Sync</strong></h3><pre class="language-shell"><code>systemctl enable shairport-sync #设置自动启动
systemctl start shairport-sync #启动Shairport Sync</code></pre><h2>添加到HomeKit</h2><p>在添加配件时，点击「没有代码或无法扫描？」，家庭 app 就会发现 AirPlay 2 设备，点击即可加入。</p><figure class="image ss-img-wrapper"><img src="https://cdn.sspai.com/2022/07/18/3a69f79cc453fc8cf2e4c4197a1ba050.png?imageView2/2/w/1120/q/40/interlace/1/ignore-error/1" data-original="https://cdn.sspai.com/2022/07/18/3a69f79cc453fc8cf2e4c4197a1ba050.png" referrerpolicy="no-referrer"><figcaption>添加到HomeKit</figcaption></figure><h2>遇到的问题</h2><p>在「多房间音频系统」播放时存在延迟，我翻了下<strong>Shairport Sync</strong>的Issues发现并不是所有人都存在这个问题，通常HDMI连接的设备都会存在100毫秒左右的延迟。在文档的常见问题中给出的解决方法是手动设置一个延迟，在配置文件<code>/etc/shairport-sync.conf</code>中有一个<code>audio_backend_latency_offset_in_seconds</code>配置项单位为秒：</p><figure class="image ss-img-wrapper"><img src="https://cdn.sspai.com/2022/07/18/273f18149194aea32b48b3ff5bf665f2.png?imageView2/2/w/1120/q/40/interlace/1/ignore-error/1" data-original="https://cdn.sspai.com/2022/07/18/273f18149194aea32b48b3ff5bf665f2.png" referrerpolicy="no-referrer"><figcaption><code>audio_backend_latency_offset_in_seconds</code>配置</figcaption></figure><p>有其他问题的话可以先到文档中排查 <a href="https://github.com/mikebrady/shairport-sync/blob/master/TROUBLESHOOTING.md" target="_blank">「Troubleshooting」</a></p><h2 style="margin-left:0px;"><strong>使用感受</strong></h2><p>折腾完用了几天后感觉还算是可用状态，借此也让我体验到「多房间音频系统」的功能，但仅限于听歌或播客之类的音频，AirPlay的延迟一就是个头疼的问题，许多视频软件由于没有适配会出现音画不同步问题，就算适配AirPlay之后也会存在一个缓冲的延迟。但作为音频播放器在「多房间音频系统」时还是很方便的。</p><figure class="image ss-img-wrapper"><img src="https://cdn.sspai.com/2022/07/18/488cfb58e39e58e2f8f8378a1e430a04.PNG?imageView2/2/w/1120/q/40/interlace/1/ignore-error/1" data-original="https://cdn.sspai.com/2022/07/18/488cfb58e39e58e2f8f8378a1e430a04.PNG" referrerpolicy="no-referrer"><figcaption>多房间音频系统</figcaption></figure><p>当然对于不喜欢折腾的人，<a href="https://support.apple.com/kb/sp651?locale=zh_CN" target="_blank">Airport Express 2 (A1392)</a> 也许是更好的选择，简单配置就可以让音箱支持AirPlay2，咸鱼价格在150～200。</p><figure class="image ss-img-wrapper"><img src="https://cdn.sspai.com/2022/07/18/9547f829006c8793642d6c27bb0da958.jpeg?imageView2/2/w/1120/q/40/interlace/1/ignore-error/1" data-original="https://cdn.sspai.com/2022/07/18/9547f829006c8793642d6c27bb0da958.jpeg" referrerpolicy="no-referrer"><figcaption><a href="https://support.apple.com/kb/sp651?locale=zh_CN" target="_blank">Airport Express 2 (A1392)</a></figcaption></figure><p> </p><h2 style="margin-left:0px;"><strong>参考资料</strong></h2><ul><li><a href="https://github.com/mikebrady/shairport-sync" target="_blank">「Shairport-Sync 」</a></li><li><a href="https://support.apple.com/kb/sp651?locale=zh_CN" target="_blank">「AirPort Express 802.11n (第2代) 」</a></li></ul></div><div class="update-details-wrap" data-v-557a067a></div><!----></div><div style="border:1px solid transparent;" data-v-557a067a></div><div class="article-side sideTop" style="display:none;left:0;" data-v-7be936cf data-v-557a067a><div class="download-guide-container" data-v-14f9065e data-v-7be936cf><div class="btn-wrapper" data-v-14f9065e><!----><button class="btn btn-view" data-v-14f9065e><i class="iconfont iconfont-phone" data-v-14f9065e></i></button></div><a href="https://sspai.com/s/JYjP" target="_blank" data-v-14f9065e><!----></a></div><div class="item-wrapper" data-v-7be936cf><button class="btn btn-charge" data-v-7be936cf><i class="iconfont" data-v-7be936cf></i></button><span class="count" data-v-7be936cf>2</span></div><div class="item-wrapper" data-v-7be936cf><button class="btn-mini btn-comment" data-v-7be936cf><i class="iconfont iconfont-comment" data-v-7be936cf></i></button><span class="count" data-v-7be936cf>4</span></div><div class="item-wrapper" data-v-7be936cf><span data-v-7be936cf><div role="tooltip" id="el-popover-2901" aria-hidden="true" class="el-popover el-popper popper-share right ss-popper-dark-border" style="width:undefinedpx;display:none;"><!----><div class="article-side-share-btn"><a href="https://service.weibo.com/share/share.php?url=null?ref=weibo&title=%E3%80%90%E4%B8%BA%E6%A0%91%E8%8E%93%E6%B4%BE%E6%8D%A2%E4%B8%8AAirPlay%202%E3%80%91%E8%BF%99%E4%B8%A4%E5%A4%A9%E5%9C%A8Reddit%E4%B8%8A%E7%9C%8B%E5%88%B0%E4%B8%80%E4%B8%AA%E5%85%B3%E4%BA%8E%E3%80%8CAirPlay2onLinux%E3%80%8D%E7%9A%84%E5%B8%96%E5%AD%90%EF%BC%8C%E5%85%B6%E4%B8%AD%E6%8E%A8%E8%8D%90%E4%BA%86ShairportSync%E9%A1%B9%E7%9B%AE%EF%BC%8C%E4%BA%8E%E6%98%AF%E6%88%91%E6%89%93%E7%AE%97%E7%BB%99%E5%AE%B6%E9%87%8C%E5%9C%A8%E7%94%A8%E7%9A%84%EF%BC%88%E6%9D%A5%E8%87%AA%20%40%E5%B0%91%E6%95%B0%E6%B4%BEsspai%EF%BC%89%E5%85%A8%E6%96%87%EF%BC%9A&pic=https%3A%2F%2Fcdn.sspai.com%2F2022%2F07%2F18%2F5887846d47ad1ef15e487c855ddb9208.png%3FimageMogr2%2Fauto-orient%2Fquality%2F95%2Fthumbnail%2F!1420x708r%2Fgravity%2FCenter%2Fcrop%2F1420x708%2Finterlace%2F1&appkey=3196502474#" target="_blank"><i class="iconfont iconfont-weibo-simple right-16"></i></a><span><div role="tooltip" id="el-popover-8177" aria-hidden="true" class="el-popover el-popper" style="width:undefinedpx;display:none;"><!----><div style="text-align:center;"><div id="qr-code"></div><small class="qr-small">扫码分享</small></div></div><span class="el-popover__reference-wrapper"><i class="iconfont iconfont-wechat-simple right-16"></i></span></span><a href="https://twitter.com/share?text=%E3%80%90%E4%B8%BA%E6%A0%91%E8%8E%93%E6%B4%BE%E6%8D%A2%E4%B8%8AAirPlay%202%E3%80%91%E8%BF%99%E4%B8%A4%E5%A4%A9%E5%9C%A8Reddit%E4%B8%8A%E7%9C%8B%E5%88%B0%E4%B8%80%E4%B8%AA%E5%85%B3%E4%BA%8E%E3%80%8CAirPlay2onLinux%E3%80%8D%E7%9A%84%E5%B8%96%E5%AD%90%EF%BC%8C%E5%85%B6%E4%B8%AD%E6%8E%A8%E8%8D%90%E4%BA%86ShairportSync%E9%A1%B9%E7%9B%AE%EF%BC%8C%E4%BA%8E%E6%98%AF%E6%88%91%E6%89%93%E7%AE%97%E7%BB%99%E5%AE%B6%E9%87%8C%E5%9C%A8%E7%94%A8%E7%9A%84%EF%BC%88%E6%9D%A5%E8%87%AA%20%40%E5%B0%91%E6%95%B0%E6%B4%BEsspai%EF%BC%89%E5%85%A8%E6%96%87%EF%BC%9A&url=null" target="_blank" class="twitter"><i class="iconfont iconfont-twitter-simple right-16"></i></a></div></div><span class="el-popover__reference-wrapper"><button class="btn-mini btn-share" data-v-7be936cf><i class="iconfont iconfont-share" data-v-7be936cf></i></button></span></span></div><div class="item-wrapper" data-v-7be936cf><button class="btn-mini btn-collect" data-v-7be936cf><i class="iconfont iconfont-collect" data-v-7be936cf></i></button></div><!----></div><!---->  
</div>
            