
---
title: '利用树莓派打造时间机器'
categories: 
 - 新媒体
 - 少数派 sspai
 - Matrix
headimg: 'https://cdn.sspai.com/2021/10/11/ea9a22d1af77ce7b744bbdc35a4ea1ff.jpg?imageView2/2/w/1120/q/40/interlace/1/ignore-error/1'
author: 少数派 sspai
comments: false
date: Wed, 13 Oct 2021 06:08:50 GMT
thumbnail: 'https://cdn.sspai.com/2021/10/11/ea9a22d1af77ce7b744bbdc35a4ea1ff.jpg?imageView2/2/w/1120/q/40/interlace/1/ignore-error/1'
---

<div>   
<div class="articleWidth-content" data-v-6a669db8><div class="content wangEditor-txt minHeight" data-v-6a669db8><h3 style="margin-left:0px;"><strong>Matrix 首页推荐</strong></h3><p style="margin-left:0px;"><a href="https://sspai.com/matrix">Matrix</a> 是少数派的写作社区，我们主张分享真实的产品体验，有实用价值的经验与思考。我们会不定期挑选 Matrix 最优质的文章，展示来自用户的最真实的体验和观点。</p><p style="margin-left:0px;">文章代表作者个人观点，少数派仅对标题和排版略作修改。</p><hr><p style="margin-left:0px;">家里有个 Raspberry Pi 4B 只装了 HomeBridge 来接入家电感觉有点浪费，加上前一段时间折腾体验 <a href="https://www.apple.com.cn/macos/monterey-preview/">macOS Monterey 预览版</a> 用到了 Time Machine 作备份时想到要是可以像 iCloud 云备份一样可以无感自动备份就好了，所以就有了这篇文章。</p><p style="margin-left:0px;">得益于 ARM 芯片的低功耗加持目前我的树莓派跑了 Docker 版本的 <a href="https://homebridge.io/" target="_blank">HomeBridge</a> 和 <a href="https://github.com/fatedier/frp" target="_blank">frp</a>以及几个定时脚本加上担任无线时间机器，目前这些任务负载并不大，树莓派的性能也足够覆盖多数使用场景。顺便一提关于树莓派温度，由于我个人倾向于减少噪音所以没有选择风扇而是选择了被动散热方案，使用一段时间观察日常温度在 50℃ 左右，参考之前用的是树莓派官方的塑料外壳日常温度在 60℃ 左右。</p><h2 style="margin-left:0px;">准备阶段</h2><p>其实早在几年前就用 Raspberry Pi 3B+ 折腾过无线 Time Machine<strong>，</strong>但是无奈 USB 2.0 接口一个全量备份需要几天，还远达不到可用。Raspberry Pi 4B 的千兆 LAN 口以及 USB 接口的升级使得理论速度可以达到千兆带宽的家庭局域网水平，用来做无线备份也算可以一试了。</p><p style="margin-left:0px;">需要设备材料：</p><ul><li>Raspberry Pi 4B 搭载 Raspberry Pi OS（其他 OS 的也可以）</li><li>TF 卡（做系统盘）</li><li>千兆路由器</li><li>CAT6 网线</li><li>一个硬盘搭配硬盘盒/移动硬盘（线材也要选择 <a href="https://zh.wikipedia.org/wiki/USB_3.0" target="_blank">USB 3.1 Gen 1</a> 带宽为 5 Gbit/s 版本）</li></ul><h3 style="margin-left:0px;">硬盘格式化分区</h3><p style="margin-left:0px;">如果熟悉挂载硬盘的操作可以直接跳过这部分，直接看<strong>配置 Time Machine</strong>。</p><p style="margin-left:0px;">首先插上硬盘通过 <code>sudo fdisk -l</code> 查看以下硬盘状态：</p><figure class="image ss-img-wrapper"><img src="https://cdn.sspai.com/2021/10/11/ea9a22d1af77ce7b744bbdc35a4ea1ff.jpg?imageView2/2/w/1120/q/40/interlace/1/ignore-error/1" data-original="https://cdn.sspai.com/2021/10/11/ea9a22d1af77ce7b744bbdc35a4ea1ff.jpg" referrerpolicy="no-referrer"><figcaption><code>sudo fdisk -l</code></figcaption></figure><p style="margin-left:0px;">可以看出这里的是 NTFS 格式的硬盘，我这里要根据 <code>/dev/sdb</code> 把硬盘格式化为 ext4 格式：<code>sudo mkfs.ext4 /dev/sdb</code></p><h3 style="margin-left:0px;">手动挂载硬盘</h3><p style="margin-left:0px;">格式化完成后，重新通过<code>sudo fdisk -l</code>查看以下硬盘状态，此时我们可以把硬盘挂载到指定目录下： <code>sudo mount Device名称 自定义的指定目录</code> </p><p style="margin-left:0px;">举例： <code>sudo mount /dev/sdb /media/pi/backup</code> </p><p style="margin-left:0px;">记得先创建一下 storage 文件夹<code>sudo mkdir /media/pi/backup</code> 再次查看硬盘状态<code>df -h</code>，此时<code>/dev/sdb</code>已经挂载上去了。</p><figure class="image ss-img-wrapper"><img src="https://cdn.sspai.com/2021/10/11/d27f66df36426808ee44c32d2dab9518.jpg?imageView2/2/w/1120/q/40/interlace/1/ignore-error/1" data-original="https://cdn.sspai.com/2021/10/11/d27f66df36426808ee44c32d2dab9518.jpg" referrerpolicy="no-referrer"><figcaption><code>df -h</code></figcaption></figure><p style="margin-left:0px;">以上就是手动挂载的方式，但是迫于断电重启的问题，每次挂载有点麻烦，所以设置启动时自动挂载硬盘是个不错的办法。</p><h3 style="margin-left:0px;">自动挂载硬盘</h3><p style="margin-left:0px;">在系统开机时会主动读取<code>/etc/fstab</code>这个文件中的内容，根据文件里面的配置挂载磁盘。 所以我们只需在<code>/etc/fstab</code>加入我们硬盘信息即可。首先编辑文件：<code>sudo vi /etc/fstab</code> </p><p style="margin-left:0px;">在<code>/etc/fstab</code>中加入 <code><strong>UUID 指定目录 硬盘文件系统格式 defaults,nofail 0 0</strong></code></p><p>其中 nofail 的作用为当挂载硬盘失败时不会影响系统的启动，当你不知道硬盘文件系统格式时，可以通过<code>sudo blkid</code>查看硬盘的 UUID 和 TYPE。</p><figure class="image ss-img-wrapper"><img src="https://cdn.sspai.com/2021/10/11/e87a9b866c0664f194e7a7a82d920dd0.jpg?imageView2/2/w/1120/q/40/interlace/1/ignore-error/1" data-original="https://cdn.sspai.com/2021/10/11/e87a9b866c0664f194e7a7a82d920dd0.jpg" referrerpolicy="no-referrer"><figcaption>sudo blkid</figcaption></figure><p>举例：<code> UUID="3f63fe7c-1173-4423-ad02-6bf92e15c2b7" /media/pi/backup ext4 defaults,nofail 0 0</code></p><h2 style="margin-left:0px;">配置 Time Machine</h2><h3 style="margin-left:0px;">配置用户</h3><p style="margin-left:0px;">首先新增 linux 的系统用户（这里用 timemachine 举例）：</p><p style="margin-left:0px;"><code>sudo adduser timemachine</code></p><p style="margin-left:0px;">将前面挂载磁盘权限修改为timemachine用户：</p><p style="margin-left:0px;"><code>sudo chown -R timemachine: /media/pi/backup</code></p><h3 style="margin-left:0px;">安装 SMB</h3><p style="margin-left:0px;">首先更新一下软件：</p><p style="margin-left:0px;"><code>sudo apt-get update && sudo apt-get upgrade</code></p><p style="margin-left:0px;">安装 <a href="https://zh.wikipedia.org/wiki/Samba" target="_blank">Samba</a>：</p><p style="margin-left:0px;"><code>sudo apt-get install samba</code></p><h3 style="margin-left:0px;">配置 SMB</h3><p style="margin-left:0px;">添加 smmba 用户并设置密码：</p><p style="margin-left:0px;"><code>sudo smbpasswd -a timemachine</code></p><p style="margin-left:0px;">编辑 <a href="https://zh.wikipedia.org/wiki/Samba" target="_blank">Samba</a> 的配置文件：</p><p style="margin-left:0px;"><code>sudo vi /etc/samba/smb.conf</code></p><p style="margin-left:0px;">在<code><strong>/etc/samba/smb.conf</strong></code>文件的全局配置段应增加如下设置以禁用 SMB1 协议和支持 macOS 系统的拓展属性：</p><pre class="language-shell"><code>[global]
#Apple extensions ("AAPL") run under SMB2/3 protocol, make that the minimum (probably shouldn't be running SMB1 anyway...) 
    min protocol = SMB2
    #支持macOS系统的拓展属性
    ea support = yes</code></pre><p> </p><p style="margin-left:0px;">其次，作为备份的共享文件夹设置应设置支持 Time Machine，<code><strong>/etc/samba/smb.conf</strong></code>文件追加以下配置：</p><pre class="language-shell"><code>[TimeMachine]
    comment = TimeMachine Backup
    # 填入硬盘挂载路径
    path = /media/pi/backup
    browseable = yes
    public = no
    writable = yes
    create mask = 0700
    # 用户名按需修改为前面创建的
    valid users = timemachine
    # 加载模块以支持AAPL拓展，注意顺序很重要！
    vfs objects = catia fruit streams_xattr
    # 支持AAPL
    fruit:aapl = yes
    # 存储macOS的元数据
    fruit:metadata = stream
    # 设置服务器在finder中的图标
    fruit:model = MacSamba
    # 设置支持Time Machine
    fruit:time machine = yes
    # 文件清理相关配置
    fruit:posix_rename = yes
    fruit:veto_appledouble = no
    fruit:wipe_intentionally_left_blank_rfork = yes
    fruit:delete_empty_adfiles = yes</code></pre><p>配置好后重启 samba 服务让设置生效：</p><p><code>sudo systemctl restart smbd</code></p><h3 style="margin-left:0px;">配置广播服务</h3><p style="margin-left:0px;">Raspberry Pi OS 默认安装和启用了 Avahi 服务，Avahi 服务会自动提供服务广播。因 Time Machine<strong> </strong>只能选择系统自动发现的硬盘，所以树莓派需要广播让 macOS 发现支持 Time Machine<strong> </strong>的备份硬盘存在。如果你的系统未安装 Avahi，使用该命令可安装：</p><p style="margin-left:0px;"><code>sudo apt install avahi </code></p><p style="margin-left:0px;">启动并且设置 Avahi 服务自动启动：</p><p style="margin-left:0px;"><code>sudo systemctl enable avahi-daemon && sudo systemctl start avahi-daemon</code></p><p>接下来配置 Time Machine。打开系统设置，找到 Time Machine(时光机器)，解锁后点击「选择磁盘」，如果配置无误且在同一个局域网的话，会看到共享的 <code>TimeMachine</code><strong> </strong>硬盘：</p><figure class="image ss-img-wrapper"><img src="https://cdn.sspai.com/2021/10/11/11f1c831acf66e540b98dba74f67546f.png?imageView2/2/w/1120/q/40/interlace/1/ignore-error/1" data-original="https://cdn.sspai.com/2021/10/11/11f1c831acf66e540b98dba74f67546f.png" referrerpolicy="no-referrer"></figure><h2 style="margin-left:0px;"><strong>macOS端设置</strong></h2><p style="margin-left:0px;">打开系统设置选择时间机器，然后选择磁盘就会发现刚创建好的，然后输入前面设置的用户名 <code>timemachine</code> 以及对应的密码然后连接即可。</p><p style="margin-left:0px;"> </p><figure class="ss-imgRows" figcaption="时间机器"><img src="https://cdn.sspai.com/2021/10/11/8da2903e0754087f294b465765590e56.png?imageView2/2/w/1120/q/40/interlace/1/ignore-error/1" alt data-original="https://cdn.sspai.com/2021/10/11/8da2903e0754087f294b465765590e56.png" referrerpolicy="no-referrer"><img src="https://cdn.sspai.com/2021/10/11/b82a2f69f6ba004d2009356ea3eff305.png?imageView2/2/w/1120/q/40/interlace/1/ignore-error/1" alt data-original="https://cdn.sspai.com/2021/10/11/b82a2f69f6ba004d2009356ea3eff305.png" referrerpolicy="no-referrer"></figure><h2>使用感受</h2><p>首次 330G 的全量备份大概花了 10 个小时，抛开第一次全量备份外每天的增量备份在 10G 左右备份时间也都在半小时内，所以不会占用太长时间。实际使用了一周的后，最便捷的就是只要连上家中 Wi-Fi 就会开始备份，同时也不用担心备份一半就要出门会导致备份损坏的情况。对我个人习惯来说下班回家之后会把电脑外接显示器使用，此时就会开始备份。相比于硬盘备份实在方便很多，通常来说很难做到坚持每天回家接上硬盘点击备份，这个更像一个部署在局域网的 iCloud 云备份。当然这个也和每个人的使用习惯相关，假如你下班回家之后连电脑都懒得从包里拿出的话，那么定期备份一次才是更加适合你的选择。</p><p>Time Machine<strong> </strong>备份策略在你硬盘足够大的情况下是可以追溯 24 小时的每小时备份，即使没有连接到 Time Machine<strong> </strong>也会在本地磁盘<sup class="ss-footnote" href title="在本地硬盘空间充足的情况下，Time Machine 会每小时保存一份本地快照，保存24小时，本地快照只保存最近有变动的文件。当本地硬盘的存储空间少于20%的时候，Time Machine 会自动删除旧的快照。当本地硬盘的存储空间少于 10% 或者少于 5G 时，Time Machine 只会保留一个本地快照。" footnote-id="1">1</sup>中存储快照。这种机制下可以很方便追溯 24 小时内的版本，对于误删或者误操作覆盖等情况都可以快速找回。</p><h2 style="margin-left:0px;"><strong>参考资料</strong></h2><ul><li><a href="https://wiki.samba.org/index.php/Configure_Samba_to_Work_Better_with_Mac_OS_X" target="_blank">Configure Samba to Work Better with Mac OS X</a></li><li><a href="https://support.apple.com/zh-cn/guide/mac-help/mh15139/11.0/mac/11.0" target="_blank">在 Mac 上可以与时间机器配合使用的磁盘类型</a></li><li><a href="https://zh.wikipedia.org/wiki/%E6%A0%91%E8%8E%93%E6%B4%BE" target="_blank">树莓派 维基百科</a></li></ul></div><!----></div><div style="border:1px solid transparent;" data-v-6a669db8></div><div class="article-side sideTop" style="display:none;left:0;" data-v-7be936cf data-v-6a669db8><div class="download-guide-container" data-v-14f9065e data-v-7be936cf><div class="btn-wrapper" data-v-14f9065e><!----><button class="btn btn-view" data-v-14f9065e><i class="iconfont iconfont-phone" data-v-14f9065e></i></button></div><a href="https://sspai.com/s/JYjP" target="_blank" data-v-14f9065e><!----></a></div><div class="item-wrapper" data-v-7be936cf><button class="btn btn-charge" data-v-7be936cf><i class="iconfont" data-v-7be936cf></i></button><span class="count" data-v-7be936cf>18</span></div><div class="item-wrapper" data-v-7be936cf><button class="btn-mini btn-comment" data-v-7be936cf><i class="iconfont iconfont-comment" data-v-7be936cf></i></button><span class="count" data-v-7be936cf>14</span></div><div class="item-wrapper" data-v-7be936cf><span data-v-7be936cf><div role="tooltip" id="el-popover-7560" aria-hidden="true" class="el-popover el-popper popper-share right ss-popper-dark-border" style="width:undefinedpx;display:none;"><!----><div class="article-side-share-btn"><a href="https://service.weibo.com/share/share.php?url=null?ref=weibo&title=%E3%80%90%0A%E5%88%A9%E7%94%A8%E6%A0%91%E8%8E%93%E6%B4%BE%E6%89%93%E9%80%A0%E6%97%B6%E9%97%B4%E6%9C%BA%E5%99%A8%E3%80%91%E5%AE%B6%E9%87%8C%E6%9C%89%E4%B8%AARaspberryPi4B%E5%8F%AA%E8%A3%85%E4%BA%86HomeBridge%E6%9D%A5%E6%8E%A5%E5%85%A5%E5%AE%B6%E7%94%B5%E6%84%9F%E8%A7%89%E6%9C%89%E7%82%B9%E6%B5%AA%E8%B4%B9%EF%BC%8C%E5%8A%A0%E4%B8%8A%E5%89%8D%E4%B8%80%E6%AE%B5%E6%97%B6%E9%97%B4%E6%8A%98%E8%85%BE%E4%BD%93%E9%AA%8CmacOSMonterey%E9%A2%84%E8%A7%88%E7%89%88%E7%94%A8%EF%BC%88%E6%9D%A5%E8%87%AA%20%40%E5%B0%91%E6%95%B0%E6%B4%BEsspai%EF%BC%89%E5%85%A8%E6%96%87%EF%BC%9A&pic=https%3A%2F%2Fcdn.sspai.com%2F2021%2F10%2F17%2F2f8fe4d8231836d3c782bdaeafd83779.png%3FimageMogr2%2Fauto-orient%2Fquality%2F95%2Fthumbnail%2F!1420x708r%2Fgravity%2FCenter%2Fcrop%2F1420x708%2Finterlace%2F1&appkey=3196502474#" target="_blank"><i class="iconfont iconfont-weibo-simple right-16"></i></a><span><div role="tooltip" id="el-popover-3024" aria-hidden="true" class="el-popover el-popper" style="width:undefinedpx;display:none;"><!----><div style="text-align:center;"><div id="qr-code"></div><small class="qr-small">扫码分享</small></div></div><span class="el-popover__reference-wrapper"><i class="iconfont iconfont-wechat-simple right-16"></i></span></span><a href="https://twitter.com/share?text=%E3%80%90%0A%E5%88%A9%E7%94%A8%E6%A0%91%E8%8E%93%E6%B4%BE%E6%89%93%E9%80%A0%E6%97%B6%E9%97%B4%E6%9C%BA%E5%99%A8%E3%80%91%E5%AE%B6%E9%87%8C%E6%9C%89%E4%B8%AARaspberryPi4B%E5%8F%AA%E8%A3%85%E4%BA%86HomeBridge%E6%9D%A5%E6%8E%A5%E5%85%A5%E5%AE%B6%E7%94%B5%E6%84%9F%E8%A7%89%E6%9C%89%E7%82%B9%E6%B5%AA%E8%B4%B9%EF%BC%8C%E5%8A%A0%E4%B8%8A%E5%89%8D%E4%B8%80%E6%AE%B5%E6%97%B6%E9%97%B4%E6%8A%98%E8%85%BE%E4%BD%93%E9%AA%8CmacOSMonterey%E9%A2%84%E8%A7%88%E7%89%88%E7%94%A8%EF%BC%88%E6%9D%A5%E8%87%AA%20%40%E5%B0%91%E6%95%B0%E6%B4%BEsspai%EF%BC%89%E5%85%A8%E6%96%87%EF%BC%9A&url=null" target="_blank" class="twitter"><i class="iconfont iconfont-twitter-simple right-16"></i></a></div></div><span class="el-popover__reference-wrapper"><button class="btn-mini btn-share" data-v-7be936cf><i class="iconfont iconfont-share" data-v-7be936cf></i></button></span></span></div><div class="item-wrapper" data-v-7be936cf><button class="btn-mini btn-collect" data-v-7be936cf><i class="iconfont iconfont-collect" data-v-7be936cf></i></button></div><!----></div><!---->  
</div>
            