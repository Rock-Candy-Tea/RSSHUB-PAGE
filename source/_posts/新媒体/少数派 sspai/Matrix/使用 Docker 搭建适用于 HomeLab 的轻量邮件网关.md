
---
title: '使用 Docker 搭建适用于 HomeLab 的轻量邮件网关'
categories: 
 - 新媒体
 - 少数派 sspai
 - Matrix
headimg: 'https://cdn.sspai.com/2022/03/16/article/f2921f44ad4faae09f2eab14b2c2ef61?imageView2/2/w/1120/q/40/interlace/1/ignore-error/1'
author: 少数派 sspai
comments: false
date: Wed, 16 Mar 2022 06:48:09 GMT
thumbnail: 'https://cdn.sspai.com/2022/03/16/article/f2921f44ad4faae09f2eab14b2c2ef61?imageView2/2/w/1120/q/40/interlace/1/ignore-error/1'
---

<div>   
<div class="articleWidth-content" data-v-0b37afcb><div class="update-wrap" data-v-0b37afcb></div><div class="content wangEditor-txt minHeight" data-v-0b37afcb><p>本篇文章将介绍如何使用 Docker 快速搭建一个适用于 HomeLab 和开发阶段使用的邮件网关，用来快速聚合各种软件的通知消息。当然，你也可以用它来快速验证各种软件中的邮件配置是否正确。</p><p>如果你熟悉 Docker 的话，大概十分钟，你将会拥有一套完全属于自己的邮件通知聚合服务，而这个服务，只需要 20MB 左右的内存消耗，非常轻量。</p><h2>写在前面</h2><p>最近在整理家里的部署的软件和服务，这些服务多数都拥有“邮件通知”的能力，并会在必要的时候，使用“发送邮件”的方式通知用户一些必要的信息，比如：任务执行完毕、敏感操作、根据计划任务跑完的数据统计摘要等。</p><p>以往部署这些软件的时候，在邮件通知功能配置上，我们的选择无非是三种：注册一个真实的邮箱，使用我们自己已经在用的邮箱账号，关闭邮件通知功能。</p><p><strong>当软件比较少的时候，不论选择哪种方案，都是可以的，因为我们的一次性操作和维护成本都比较低</strong>。</p><p>但当我们部署了越来越多的软件和服务之后，关闭邮件通知属于“鸵鸟行为”，是不推荐的；在不能100%确定软件可靠性的前提下，所有软件共享一个邮箱账号，显然是不安全的；<strong>最可靠的方案，便是为为每一个软件配置不同的邮箱账号</strong>。</p><p>而如果为每一个软件都配置独立的邮箱账号，维护邮箱账号的时间成本，将会变得不可忽视，因为你永远不知道什么时候、哪一个邮箱账号会有问题，以及在什么时候你会漏掉重要的应用消息。</p><p>所以，我开始寻找一个适用于个人或者小团队的、私有化部署的邮件网关方案，降低账号的维护成本和经济成本，以及尽可能减少不必要的公网数据交换。</p><h2>软件选型</h2><p>为了解决上面的问题，一般可以选择两类软件方案：邮局类软件、邮件测试网关。</p><p>我们先来聊聊邮局类应用。</p><h3>邮局类软件应用</h3><p>邮局类软件，顾名思义，和我们日常使用的 GMail、Outlook、QQ 邮箱、163 邮箱等等。在 GitHub 上，我们也可以找到不少优秀的邮局软件应用，比如下面这些：</p><ul><li>（11.4k Stars）<a href="https://github.com/postalserver/postal">https://github.com/postalserver/postal</a></li><li>（10.9k Stars）<a href="https://github.com/mail-in-a-box/mailinabox">https://github.com/mail-in-a-box/mailinabox</a><ul><li>可以比较简单的和 NextCloud Mail 一起使用（625 Stars）<a href="https://github.com/nextcloud/mail">https://github.com/nextcloud/mail</a></li></ul></li><li>（8.7k Stars） <a href="https://github.com/docker-mailserver/docker-mailserver">https://github.com/docker-mailserver/docker-mailserver</a></li><li>（4.9k Stars）<a href="https://github.com/mailcow/mailcow-dockerized">https://github.com/mailcow/mailcow-dockerized</a></li><li>（3.5k Stars）<a href="https://github.com/Mailu/Mailu">https://github.com/Mailu/Mailu</a></li><li>（2.1k Stars）<a href="https://github.com/modoboa/modoboa">https://github.com/modoboa/modoboa</a></li></ul><p>上面的开源方案都可以作为我们日常使用的云服务、知名邮件厂商的替代方案使用。</p><p>但是通常情况下，这类软件会包含非常多的组件和能力，比如：Web 界面、多账户支持、多种邮局聚合、各种邮件协议支持、邮件推送、垃圾邮件审查、邮件防火墙、各种复杂的邮件相关的 DNS 支持等等。</p><p>随着软件功能的丰富完善，软件运行过程中的资源消耗和使用中的功能复杂度自然也就上去了，加上这几个头部的项目，技术选型多是 Ruby、Python，资源使用自然更是“雪上加霜”。</p><p>考虑到我不需要多用户支持，并且我希望我的应用始终是<strong>轻量可靠的</strong>。所以，我将目光转向了：测试网关类应用。</p><h3>邮件测试网关类应用</h3><p>坦白说，能够符合我前文中提到的大部分需求，并具备比较低的资源占用的项目并不多。如果再限制能够快速进行功能验证（跑起来看效果）的项目，那就更屈指可数啦：</p><ul><li>（5.6k Stars）<a href="https://github.com/sj26/mailcatcher">https://github.com/sj26/mailcatcher</a></li><li>（3.2k Stars）<a href="https://github.com/maildev/maildev">https://github.com/maildev/maildev</a></li></ul><p>在简单使用之后，我选择了以第二个项目，将它作为代码基进行二次开发。毕竟基于在以往项目中的经验，相比较 Ruby 的性能和效率，我对 Node 更有信心。</p><p>如果你等不及验证效果，可以跳过下面的小节，直接阅读文章的 “使用 Docker 进行快速体验”部分。</p><h2>基于 MailDev 进行二次开发</h2><p>从项目当前出现的问题和社区里的反馈里，我们可以看到几个比较明显的问题：</p><ol><li>软件文档和官方镜像似乎“对不上号”，一些代码中的依赖配置项也是有问题的，会导致软件无法正常使用。 <a href="https://github.com/maildev/maildev/pull/376">issue #376</a>、<a href="https://github.com/maildev/maildev/issues">issue list</a></li><li>作者官宣弃坑，后来者做了 fork 版本，但仅仅是解决了一些基础问题。<a href="https://github.com/maildev/maildev/issues/335">issue #335</a></li><li>软件依赖和运行时都过于陈旧，依赖的 lib 的版本缺乏有效管理，NPM 子依赖中不少依赖都已经被废弃或者存在安全隐患。</li><li>使用更可靠的 Markdown 和 HTML 互相转化方案，对内容进行安全的标签过滤。</li></ol><p>所以，我花了一些时间，针对原来的代码做了一些调整：</p><ul><li>升级了 Node Runtime 到 v16 TLS。</li><li>将各种基础依赖升级到可靠版本，解决各种安全问题。</li><li>重新构建可用的 Docker 容器版本。</li></ul><figure class="image ss-img-wrapper"><img src="https://cdn.sspai.com/2022/03/16/article/f2921f44ad4faae09f2eab14b2c2ef61?imageView2/2/w/1120/q/40/interlace/1/ignore-error/1" alt="针对 MailDev 进行细节调整" data-original="https://cdn.sspai.com/2022/03/16/article/f2921f44ad4faae09f2eab14b2c2ef61" referrerpolicy="no-referrer"><figcaption>针对 MailDev 进行细节调整</figcaption></figure><p>如果你好奇到底改了哪些内容的话，可以看这里的提交记录：<a href="https://github.com/maildev/maildev/compare/master...soulteary:master">https://github.com/maildev/maildev/compare/master...soulteary:master</a></p><p>接下来，我们来看看如何通过容器快速使用这个“邮件工具”吧。</p><h2>使用 Docker 快速体验邮件网关</h2><p>如果我们想启动一个“邮件网关”，可以直接使用“一句话”的容器命令来解决战斗：</p><pre class="language-shell"><code>docker run -p 1080:1080 -p 1025:1025 soulteary/maildev</code></pre><p>当命令执行完毕，我们将能够看到类似下面的日志输出：</p><pre class="language-shell"><code>MailDev using directory /tmp/maildev-1
MailDev webapp running at http://0.0.0.0:1080
MailDev SMTP Server running at 0.0.0.0:1025</code></pre><p>接着在浏览器中打开 <code>http://0.0.0.0:1080</code>，就能看到下图一样的收件箱界面了。</p><figure class="image ss-img-wrapper"><img src="https://cdn.sspai.com/2022/03/16/article/fe9f354ae369007c7e7083cad70c1a51?imageView2/2/w/1120/q/40/interlace/1/ignore-error/1" alt="MailDev 的欢迎界面" data-original="https://cdn.sspai.com/2022/03/16/article/fe9f354ae369007c7e7083cad70c1a51" referrerpolicy="no-referrer"><figcaption>MailDev 的欢迎界面</figcaption></figure><p>如果我们需要测试邮件聚合功能是否能够正常工作，<strong>只需要使用邮件客户端、配置任意用户名和密码</strong>，向 <code>0.0.0.0:1025</code> 端口发送邮件，就能够看到效果啦。</p><p>还记得上文中需要配置不同账号的问题吗？是不是很轻松的就解决啦？甚至你还可以配置邮件转发真实邮箱、限制只接收某些账号的邮件消息。</p><h3>使用 Node.js 快速验证服务功能</h3><p>相比较使用客户端，我更喜欢使用代码来做快速验证。</p><p>这里为了方便描述，我使用 Node.js 写了一个非常简单的发信脚本：</p><pre class="language-javascript"><code>'use strict'

const nodemailer = require('nodemailer')

async function main () &#123;
  const &#123; user, pass &#125; = await nodemailer.createTestAccount()
  let transporter = nodemailer.createTransport(&#123;
    host: '0.0.0.0',
    port: 1025,
    auth: &#123; type: 'login', user, pass &#125;
  &#125;)

  // send mail with defined transport object
  let info = await transporter.sendMail(&#123;
    from: '\'Fred Foo 👻\' <foo@example.com>', // sender address
    to: 'bar@example.com, baz@example.com', // list of receivers
    subject: 'Hello ✔', // Subject line
    text: 'Hello world?', // plain text body
    html: '<b>Hello world?</b>' // html body
  &#125;)

  console.log('Message sent: %s', info.messageId)
  // Message sent: <b658f8ca-6296-ccf4-8306-87d57a0b4321@example.com>

  // Preview only available when sending through an Ethereal account
  console.log('Preview URL: %s', nodemailer.getTestMessageUrl(info))
  // Preview URL: https://ethereal.email/message/WaQKMgKddxQDoou...
&#125;

main().catch(console.error)</code></pre><p>将上面的代码保存为 <code>example-sendmail.js</code>，接着执行 <code>node example-sendmail.js</code>，顺利的话，我们将看到类似下面的日志输出：</p><pre class="language-shell"><code>Message sent: <c9867b60-8c5d-df8d-2476-39f5dd77f856@example.com>
Preview URL: false `</code></pre><p>接着，在浏览器中打开 <code>http://0.0.0.0:1080</code>，我们将看到 MailDev 的界面中多了一份意料之中的“邮件”，邮件正文正是我们上面写代码中的内容。</p><figure class="image ss-img-wrapper"><img src="https://cdn.sspai.com/2022/03/16/article/2855210e2d52237e714b98134586ab2b?imageView2/2/w/1120/q/40/interlace/1/ignore-error/1" alt="收到来信的 MailDev" data-original="https://cdn.sspai.com/2022/03/16/article/2855210e2d52237e714b98134586ab2b" referrerpolicy="no-referrer"><figcaption>收到来信的 MailDev</figcaption></figure><p>在不进行额外的代码调整之前，我们多重复几次上面的发信操作，就可以模拟出日常学习和工作中各种应用的邮件通知发送场景。</p><p>此时，MailDev 的列表中就会实时展示新到的“邮件”了。</p><figure class="image ss-img-wrapper"><img src="https://cdn.sspai.com/2022/03/16/article/7edc131a61d63f1a203fc703ac8df103?imageView2/2/w/1120/q/40/interlace/1/ignore-error/1" alt="MailDev 的邮件列表" data-original="https://cdn.sspai.com/2022/03/16/article/7edc131a61d63f1a203fc703ac8df103" referrerpolicy="no-referrer"><figcaption>MailDev 的邮件列表</figcaption></figure><h3>使用 Docker-Compose 启动服务</h3><p>为了方便我的老读者们，让大家能够一起偷懒，按照惯例，我提供一个简单的容器编排配置文件：</p><pre class="language-shell"><code>version: '3'

services:

  maildev:
    image: soulteary/maildev
    restart: always
    environment:
      - TZ=Asia/Shanghai
      - MAILDEV_WEB_PORT=1080
      - MAILDEV_SMTP_PORT=1025
    ports:
      - "1080:1080"
      - "1025:1025"</code></pre><p>将上面的内容保存为 <code>docker-compose.yml</code>，接着使用 <code>docker-compose up -d</code> 启动应用，和上文提到的一样，我们就能够在浏览器中访问 <code>http://localhost:1080</code> 来浏览和管理“邮件内容”，并通过 <code>1025</code> 端口来进行邮件汇聚操作啦。</p><h2>最后</h2><p>和之前提到过的其他的项目一样，接下来我将持续改进这个项目。短时间内，我希望它能够更好的支持 WebHook、并和一些消息推送软件进行打通，更好的支持我的 HomeLab 场景。</p><p>如果你对这个项目感兴趣、又比较“心急”的话，可以访问项目源代码：<a href="https://github.com/soulteary/maildev">https://github.com/soulteary/maildev</a> 进行 DIY。当然，也欢迎你在项目 issue 中留下你对这个项目的建议和想法。</p><p>--EOF</p><p> </p><hr><p>本文使用「署名 4.0 国际 (CC BY 4.0)」许可协议，欢迎转载、或重新修改使用，但需要注明来源。 <a href="https://creativecommons.org/licenses/by/4.0/deed.zh">署名 4.0 国际 (CC BY 4.0)</a></p><p>本文作者: 苏洋</p><p>创建时间: 2022年03月15日<br>统计字数: 5362字<br>阅读时间: 11分钟阅读<br>本文链接: https://soulteary.com/2022/03/15/build-a-lightweight-mail-gateway-for-homelab-using-docker.html</p></div><div class="update-details-wrap" data-v-0b37afcb></div><!----></div><div style="border:1px solid transparent;" data-v-0b37afcb></div><div class="article-side sideTop" style="display:none;left:0;" data-v-7be936cf data-v-0b37afcb><div class="download-guide-container" data-v-14f9065e data-v-7be936cf><div class="btn-wrapper" data-v-14f9065e><!----><button class="btn btn-view" data-v-14f9065e><i class="iconfont iconfont-phone" data-v-14f9065e></i></button></div><a href="https://sspai.com/s/JYjP" target="_blank" data-v-14f9065e><!----></a></div><div class="item-wrapper" data-v-7be936cf><button class="btn btn-charge" data-v-7be936cf><i class="iconfont" data-v-7be936cf></i></button><span class="count" data-v-7be936cf>9</span></div><div class="item-wrapper" data-v-7be936cf><button class="btn-mini btn-comment" data-v-7be936cf><i class="iconfont iconfont-comment" data-v-7be936cf></i></button><span class="count" data-v-7be936cf>0</span></div><div class="item-wrapper" data-v-7be936cf><span data-v-7be936cf><div role="tooltip" id="el-popover-1587" aria-hidden="true" class="el-popover el-popper popper-share right ss-popper-dark-border" style="width:undefinedpx;display:none;"><!----><div class="article-side-share-btn"><a href="https://service.weibo.com/share/share.php?url=null?ref=weibo&title=%E3%80%90%E4%BD%BF%E7%94%A8%20Docker%20%E6%90%AD%E5%BB%BA%E9%80%82%E7%94%A8%E4%BA%8E%20HomeLab%20%E7%9A%84%E8%BD%BB%E9%87%8F%E9%82%AE%E4%BB%B6%E7%BD%91%E5%85%B3%E3%80%91%E6%9C%AC%E7%AF%87%E6%96%87%E7%AB%A0%E5%B0%86%E4%BB%8B%E7%BB%8D%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8Docker%E5%BF%AB%E9%80%9F%E6%90%AD%E5%BB%BA%E4%B8%80%E4%B8%AA%E9%80%82%E7%94%A8%E4%BA%8EHomeLab%E5%92%8C%E5%BC%80%E5%8F%91%E9%98%B6%E6%AE%B5%E4%BD%BF%E7%94%A8%E7%9A%84%E9%82%AE%E4%BB%B6%E7%BD%91%E5%85%B3%EF%BC%8C%E7%94%A8%E6%9D%A5%E5%BF%AB%E9%80%9F%E8%81%9A%E5%90%88%E5%90%84%E7%A7%8D%E8%BD%AF%E4%BB%B6%E7%9A%84%E9%80%9A%E7%9F%A5%E6%B6%88%E6%81%AF%E3%80%82%E5%BD%93%E7%84%B6%EF%BC%8C%E4%BD%A0%E4%B9%9F%E5%8F%AF%E4%BB%A5%E7%94%A8%EF%BC%88%E6%9D%A5%E8%87%AA%20%40%E5%B0%91%E6%95%B0%E6%B4%BEsspai%EF%BC%89%E5%85%A8%E6%96%87%EF%BC%9A&pic=https%3A%2F%2Fcdn.sspai.com%2F2022%2F03%2F16%2F00905affbce6b6756ab6f6f36c2c6800.jpeg%3FimageMogr2%2Fauto-orient%2Fquality%2F95%2Fthumbnail%2F!1420x708r%2Fgravity%2FCenter%2Fcrop%2F1420x708%2Finterlace%2F1&appkey=3196502474#" target="_blank"><i class="iconfont iconfont-weibo-simple right-16"></i></a><span><div role="tooltip" id="el-popover-8347" aria-hidden="true" class="el-popover el-popper" style="width:undefinedpx;display:none;"><!----><div style="text-align:center;"><div id="qr-code"></div><small class="qr-small">扫码分享</small></div></div><span class="el-popover__reference-wrapper"><i class="iconfont iconfont-wechat-simple right-16"></i></span></span><a href="https://twitter.com/share?text=%E3%80%90%E4%BD%BF%E7%94%A8%20Docker%20%E6%90%AD%E5%BB%BA%E9%80%82%E7%94%A8%E4%BA%8E%20HomeLab%20%E7%9A%84%E8%BD%BB%E9%87%8F%E9%82%AE%E4%BB%B6%E7%BD%91%E5%85%B3%E3%80%91%E6%9C%AC%E7%AF%87%E6%96%87%E7%AB%A0%E5%B0%86%E4%BB%8B%E7%BB%8D%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8Docker%E5%BF%AB%E9%80%9F%E6%90%AD%E5%BB%BA%E4%B8%80%E4%B8%AA%E9%80%82%E7%94%A8%E4%BA%8EHomeLab%E5%92%8C%E5%BC%80%E5%8F%91%E9%98%B6%E6%AE%B5%E4%BD%BF%E7%94%A8%E7%9A%84%E9%82%AE%E4%BB%B6%E7%BD%91%E5%85%B3%EF%BC%8C%E7%94%A8%E6%9D%A5%E5%BF%AB%E9%80%9F%E8%81%9A%E5%90%88%E5%90%84%E7%A7%8D%E8%BD%AF%E4%BB%B6%E7%9A%84%E9%80%9A%E7%9F%A5%E6%B6%88%E6%81%AF%E3%80%82%E5%BD%93%E7%84%B6%EF%BC%8C%E4%BD%A0%E4%B9%9F%E5%8F%AF%E4%BB%A5%E7%94%A8%EF%BC%88%E6%9D%A5%E8%87%AA%20%40%E5%B0%91%E6%95%B0%E6%B4%BEsspai%EF%BC%89%E5%85%A8%E6%96%87%EF%BC%9A&url=null" target="_blank" class="twitter"><i class="iconfont iconfont-twitter-simple right-16"></i></a></div></div><span class="el-popover__reference-wrapper"><button class="btn-mini btn-share" data-v-7be936cf><i class="iconfont iconfont-share" data-v-7be936cf></i></button></span></span></div><div class="item-wrapper" data-v-7be936cf><button class="btn-mini btn-collect" data-v-7be936cf><i class="iconfont iconfont-collect" data-v-7be936cf></i></button></div><!----></div><!---->  
</div>
            