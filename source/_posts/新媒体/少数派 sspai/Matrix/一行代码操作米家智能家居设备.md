
---
title: '一行代码操作米家智能家居设备'
categories: 
 - 新媒体
 - 少数派 sspai
 - Matrix
headimg: 'https://cdn.sspai.com/2021/08/16/97a6e26e0e148f15cbdc96346be175e1.png?imageView2/2/w/1120/q/40/interlace/1/ignore-error/1'
author: 少数派 sspai
comments: false
date: Sun, 22 Aug 2021 09:05:29 GMT
thumbnail: 'https://cdn.sspai.com/2021/08/16/97a6e26e0e148f15cbdc96346be175e1.png?imageView2/2/w/1120/q/40/interlace/1/ignore-error/1'
---

<div>   
<div class="articleWidth-content" data-v-6a669db8><div class="content wangEditor-txt minHeight" data-v-6a669db8><blockquote><p>以更加简约自由的方式操作米家智能家居设备</p></blockquote><p>由于居住地变化，一直吃灰的米家智能插座终于有了用武之地，一开始买的时候就希望可以摆脱米家App，用其它更加开放的方法进行操控「开源与闭源相结合」；然而受环境和认知水平限制，一直不能如愿，直至去年方才有机会将米家设备玩起来，整套方案如下：</p><figure class="image ss-img-wrapper"><img src="https://cdn.sspai.com/2021/08/16/97a6e26e0e148f15cbdc96346be175e1.png?imageView2/2/w/1120/q/40/interlace/1/ignore-error/1" data-original="https://cdn.sspai.com/2021/08/16/97a6e26e0e148f15cbdc96346be175e1.png" referrerpolicy="no-referrer"></figure><p>HomeBridge 虽然也能满足需求，但手头的设备并不多，简单场景下反而有些大材小用了</p><p>根据网上公开的资料，米家智能家居设备使用 miIO协议 进行通信，本想看是不是可以自己实现一个miIO协议处理器，但网上已经有针对miIO协议的实现了，使用近一年，非常稳定。</p><p><a href="https://python-miio.readthedocs.io/en/latest/#" target="_blank">python-miio</a> 虽是一个miIO网络库，但还附带提供了基于命令行的调试工具 <strong>miiocli</strong>，方便其它开发人员调试miIO设备，使用门槛几乎没有，仅需一行代码即可控制米家智能插座。</p><h2>搭建</h2><p>基于Raspberry Pi 2「Raspbian 10 buster」</p><h3>安装python-miio库</h3><p><code>sudo pip3 install python-miio</code></p><p>如果没有pip3工具请先安装python-pip3</p><p><code>sudo apt-get install python-pip3</code></p><p>等进度条走完，即可使用miiocli命令行工具，项目官网列出了目前所能<a href="https://python-miio.readthedocs.io/en/latest/#supported-devices" target="_blank">支持的硬件设备</a>，以米家居多，基本上能接入WiFi的设备都能用。</p><pre class="language-null"><code>pi@RAS:~ $ miiocli --help
Usage: miiocli [OPTIONS] COMMAND [ARGS]...

Options:
  -d, --debug
  -o, --output [default|json|json_pretty]
  --version                       Show the version and exit.
  --help                          Show this message and exit.

Commands:
  airconditionermiot
  airconditioningcompanion
  airconditioningcompanionmcn02
  airconditioningcompanionv3
  airdehumidifier
  airfresh
  airfresht2017
  airfreshva4
......</code></pre><p>命令本身非常简单，以接下来要用的 智能插座 为例：</p><pre class="language-null"><code>pi@RAS:~ $ miiocli plug
Usage: miiocli plug [OPTIONS] COMMAND [ARGS]...

Options:
  --ip TEXT     [required]
  --token TEXT  [required]
  --help        Show this message and exit.</code></pre><p>需要提供设备 IP 和 Token 两个参数</p><h3>获取设备Token</h3><p>Token 在智能家居设备初始化时自动生成，字串长度32，大致有两种方式可以获取：</p><h4>miIO Discovery</h4><p>通过主动发送<strong>特定信号</strong>进行探测，最方便，前提是你的智能家居设备 固件版本 足够早「2015年 固件版本1.2.4_16」；因此设计存在安全风险，升级后的固件已不支持，但值得一试</p><ul><li><a href="https://github.com/id872/airpurifier2" target="_blank">一行代码</a>「手动去掉空格」</li></ul><pre class="language-null"><code>pi@RAS:~ $ echo -ne '\x21\x31\x00\x20\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff' | nc -u 10.0.0.3 54321 | od -An -j 16 -t x1
48 9e bc 3f e5 62 d4 e5 9f fa b6 56 72 46 87 79</code></pre><ul><li><a href="https://paper.seebug.org/616/">借助 python-miio 解码</a>「此处稍作改动」</li></ul><pre class="language-null"><code>#-*-coding:utf8-*-

import codecs
import socket
from miio.protocol import Message

helobytes=bytes.fromhex('21310020ffffffffffffffffffffffffffffffffffffffffffffffffffffffff')
s=socket.socket(socket.AF_INET,socket.SOCK_DGRAM)
s.sendto(helobytes,('10.0.0.3',54321))#插座ip，端口54321
data,addr=s.recvfrom(1024)
m=Message.parse(data)
tok=codecs.encode(m.checksum,'hex')
print(tok)</code></pre><h4>miio2.db「通用」</h4><ol><li><a href="https://sspai.com/post/63117" target="_blank">一日一技｜只要一台电脑，轻松获取米家设备 token</a>，提取App中存储Token的文件，并解密</li><li><a href="https://python-miio.readthedocs.io/en/latest/discovery.html" target="_blank">Device Discovery - python-miio</a>，同方法二，但该库提供了一系列命令行工具方便提取Token值</li></ol><h4>获取设备 IP</h4><figure class="image ss-img-wrapper"><img src="https://cdn.sspai.com/2021/08/17/97937f5f051b2aac6f5df175c9fb5f37.png?imageView2/2/w/1120/q/40/interlace/1/ignore-error/1" data-original="https://cdn.sspai.com/2021/08/17/97937f5f051b2aac6f5df175c9fb5f37.png" referrerpolicy="no-referrer"><figcaption>打开米家App</figcaption></figure><figure class="image ss-img-wrapper"><img src="https://cdn.sspai.com/2021/08/17/b8fa43f5a7f3bd6d3e762497fef03f6b.png?imageView2/2/w/1120/q/40/interlace/1/ignore-error/1" data-original="https://cdn.sspai.com/2021/08/17/b8fa43f5a7f3bd6d3e762497fef03f6b.png" referrerpolicy="no-referrer"><figcaption>更多设置 -> 网络信息</figcaption></figure><figure class="image ss-img-wrapper"><img src="https://cdn.sspai.com/2021/08/17/e0d31ccaa198268509ef67af8e895b96.png?imageView2/2/w/1120/q/40/interlace/1/ignore-error/1" data-original="https://cdn.sspai.com/2021/08/17/e0d31ccaa198268509ef67af8e895b96.png" referrerpolicy="no-referrer"><figcaption>Get ✓</figcaption></figure><p>同时，使能路由器中的「地址保留」功能，确保 智能设备 每次都能分配到<strong>相同的</strong>内网IP地址，避免因地址变化导致服务不可用。</p><h2>调试</h2><p>因miIO协议需要，请确保 <strong>树莓派 </strong>和 <strong>智能家居设备 </strong>处在同一局域网下</p><p>以手头的<strong>米家智能插座WiFi版</strong>为例</p><ul><li>类型：plug / chuangmiplug</li><li>IP地址：10.0.0.3</li><li>Token：489ebc3fe562d4e59ffab65672468779</li></ul><p>根据<code>miio plug --help</code>的提示信息，plug类型设备支持下列操作：</p><pre class="language-null"><code>Commands:
  info          Get miIO protocol information from the device.
  off           Power off.
  on            Power on.
  raw_command   Send a raw command to the device.
  set_wifi_led  Set the wifi led on/off.
  status        Retrieve properties.
  usb_off       Power off.
  usb_on        Power on.</code></pre><h3>检查设备状态</h3><p><code>miiocli plug --ip 10.0.0.3 --token 489ebe3fe567d4e59ffab61672468779 status</code></p><pre class="language-null"><code>Power: False
USB Power: None
Temperature: 48 °C
Load power: None
WiFi LED: None</code></pre><p>返回设备情况，说明参数正确且设备连接正常</p><h3>开启 / 关闭 插座供电</h3><p><code>miiocli plug --ip 10.0.0.3 --token 489ebe3fe567d4e59ffab61672468779 on</code></p><pre class="language-null"><code>Powering on
['ok']</code></pre><p><code>miiocli plug --ip 10.0.0.3 --token 489ebe3fe567d4e59ffab61672468779 off</code></p><pre class="language-null"><code>Powering off
['ok']</code></pre><p>观察设备情况，确认是否正确执行了对应的上下电操作</p><h2>看看效果</h2><p>经评论区网友提醒，iOS捷径 支持通过SSH发送指令；虽然HTTP接口通用性强，但实现起来仍然有一定的门槛，所以就先不折腾了。</p><p>SSH环境下使用绝对路径避免找不到程序等有可能妨碍执行的问题 <code>which miiocli</code></p><p><code>/usr/local/bin/miiocli plug --ip <IP> --token <TOKEN> ACTION</code></p><iframe class="ss-videoIframe" src="//player.bilibili.com/player.html?bvid=BV1YM4y1V7CD"> </iframe><h2>后记</h2><p>本方法着重于简单地对智能家居设备进行控制，未考虑以图形化方式展示设备的当前状态</p><p>如果你也只是需要控制少量米家设备，没有复杂的交互场景，手头又有一点闲置的计算资源「树莓派等运行 Linux发行版 的设备」，希望以更加自由、简单的方式操作你的设备，那就不妨试试吧~</p><h2>参考材料</h2><ul><li><a href="https://github.com/OpenMiHome/mihome-binary-protocol">Xiaomi's MiHome Binary protocol</a></li><li><a href="https://python-miio.readthedocs.io/en/latest/index.html">Getting Started python-miio</a></li><li><a href="https://www.vanwerkhoven.org/blog/2021/cloudless-xiaomi-smart-plug/">Cloudless Xiaomi Smart Plug</a></li></ul><p> </p></div><!----></div><div style="border:1px solid transparent;" data-v-6a669db8></div><div class="article-side sideTop" style="display:none;left:0;" data-v-7be936cf data-v-6a669db8><div class="download-guide-container" data-v-14f9065e data-v-7be936cf><div class="btn-wrapper" data-v-14f9065e><!----><button class="btn btn-view" data-v-14f9065e><i class="iconfont iconfont-phone" data-v-14f9065e></i></button></div><a href="https://sspai.com/s/JYjP" target="_blank" data-v-14f9065e><!----></a></div><div class="item-wrapper" data-v-7be936cf><button class="btn btn-charge" data-v-7be936cf><i class="iconfont" data-v-7be936cf></i></button><span class="count" data-v-7be936cf>8</span></div><div class="item-wrapper" data-v-7be936cf><button class="btn-mini btn-comment" data-v-7be936cf><i class="iconfont iconfont-comment" data-v-7be936cf></i></button><span class="count" data-v-7be936cf>1</span></div><div class="item-wrapper" data-v-7be936cf><span data-v-7be936cf><div role="tooltip" id="el-popover-3481" aria-hidden="true" class="el-popover el-popper popper-share right ss-popper-dark-border" style="width:undefinedpx;display:none;"><!----><div class="article-side-share-btn"><a href="https://service.weibo.com/share/share.php?url=null?ref=weibo&title=%E3%80%90%E4%B8%80%E8%A1%8C%E4%BB%A3%E7%A0%81%E6%93%8D%E4%BD%9C%E7%B1%B3%E5%AE%B6%E6%99%BA%E8%83%BD%E5%AE%B6%E5%B1%85%E8%AE%BE%E5%A4%87%E3%80%91%E4%BB%A5%E6%9B%B4%E5%8A%A0%E7%AE%80%E7%BA%A6%E8%87%AA%E7%94%B1%E7%9A%84%E6%96%B9%E5%BC%8F%E6%93%8D%E4%BD%9C%E7%B1%B3%E5%AE%B6%E6%99%BA%E8%83%BD%E5%AE%B6%E5%B1%85%E8%AE%BE%E5%A4%87%E7%94%B1%E4%BA%8E%E5%B1%85%E4%BD%8F%E5%9C%B0%E5%8F%98%E5%8C%96%EF%BC%8C%E4%B8%80%E7%9B%B4%E5%90%83%E7%81%B0%E7%9A%84%E7%B1%B3%E5%AE%B6%E6%99%BA%E8%83%BD%E6%8F%92%E5%BA%A7%E7%BB%88%E4%BA%8E%E6%9C%89%E4%BA%86%E7%94%A8%E6%AD%A6%E4%B9%8B%E5%9C%B0%EF%BC%8C%E4%B8%80%E5%BC%80%E5%A7%8B%E4%B9%B0%E7%9A%84%E6%97%B6%E5%80%99%E5%B0%B1%E5%B8%8C%E6%9C%9B%E5%8F%AF%E4%BB%A5%E6%91%86%E8%84%B1%E7%B1%B3%E5%AE%B6App%EF%BC%8C%E7%94%A8%E5%85%B6%EF%BC%88%E6%9D%A5%E8%87%AA%20%40%E5%B0%91%E6%95%B0%E6%B4%BEsspai%EF%BC%89%E5%85%A8%E6%96%87%EF%BC%9A&pic=https%3A%2F%2Fcdn.sspai.com%2F2021%2F08%2F24%2F73e25bfec886f8efb4e2d6f8187fa781.png%3FimageMogr2%2Fauto-orient%2Fquality%2F95%2Fthumbnail%2F!1420x708r%2Fgravity%2FCenter%2Fcrop%2F1420x708%2Finterlace%2F1&appkey=3196502474#" target="_blank"><i class="iconfont iconfont-weibo-simple right-16"></i></a><span><div role="tooltip" id="el-popover-4776" aria-hidden="true" class="el-popover el-popper" style="width:undefinedpx;display:none;"><!----><div style="text-align:center;"><div id="qr-code"></div><small class="qr-small">扫码分享</small></div></div><span class="el-popover__reference-wrapper"><i class="iconfont iconfont-wechat-simple right-16"></i></span></span><a href="https://twitter.com/share?text=%E3%80%90%E4%B8%80%E8%A1%8C%E4%BB%A3%E7%A0%81%E6%93%8D%E4%BD%9C%E7%B1%B3%E5%AE%B6%E6%99%BA%E8%83%BD%E5%AE%B6%E5%B1%85%E8%AE%BE%E5%A4%87%E3%80%91%E4%BB%A5%E6%9B%B4%E5%8A%A0%E7%AE%80%E7%BA%A6%E8%87%AA%E7%94%B1%E7%9A%84%E6%96%B9%E5%BC%8F%E6%93%8D%E4%BD%9C%E7%B1%B3%E5%AE%B6%E6%99%BA%E8%83%BD%E5%AE%B6%E5%B1%85%E8%AE%BE%E5%A4%87%E7%94%B1%E4%BA%8E%E5%B1%85%E4%BD%8F%E5%9C%B0%E5%8F%98%E5%8C%96%EF%BC%8C%E4%B8%80%E7%9B%B4%E5%90%83%E7%81%B0%E7%9A%84%E7%B1%B3%E5%AE%B6%E6%99%BA%E8%83%BD%E6%8F%92%E5%BA%A7%E7%BB%88%E4%BA%8E%E6%9C%89%E4%BA%86%E7%94%A8%E6%AD%A6%E4%B9%8B%E5%9C%B0%EF%BC%8C%E4%B8%80%E5%BC%80%E5%A7%8B%E4%B9%B0%E7%9A%84%E6%97%B6%E5%80%99%E5%B0%B1%E5%B8%8C%E6%9C%9B%E5%8F%AF%E4%BB%A5%E6%91%86%E8%84%B1%E7%B1%B3%E5%AE%B6App%EF%BC%8C%E7%94%A8%E5%85%B6%EF%BC%88%E6%9D%A5%E8%87%AA%20%40%E5%B0%91%E6%95%B0%E6%B4%BEsspai%EF%BC%89%E5%85%A8%E6%96%87%EF%BC%9A&url=null" target="_blank" class="twitter"><i class="iconfont iconfont-twitter-simple right-16"></i></a></div></div><span class="el-popover__reference-wrapper"><button class="btn-mini btn-share" data-v-7be936cf><i class="iconfont iconfont-share" data-v-7be936cf></i></button></span></span></div><div class="item-wrapper" data-v-7be936cf><button class="btn-mini btn-collect" data-v-7be936cf><i class="iconfont iconfont-collect" data-v-7be936cf></i></button></div><!----></div><!---->  
</div>
            