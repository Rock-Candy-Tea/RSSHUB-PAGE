
---
title: 'Windows 本地自动化工具，任务计划程序应用举例'
categories: 
 - 新媒体
 - 少数派 sspai
 - Matrix
headimg: 'https://cdn.sspai.com/2021/04/17/article/f01a1648123132dc2cfcf376c79e98e3?imageView2/2/w/1120/q/40/interlace/1/ignore-error/1'
author: 少数派 sspai
comments: false
date: Sat, 17 Apr 2021 07:12:13 GMT
thumbnail: 'https://cdn.sspai.com/2021/04/17/article/f01a1648123132dc2cfcf376c79e98e3?imageView2/2/w/1120/q/40/interlace/1/ignore-error/1'
---

<div>   
<div class="articleWidth-content" data-v-e1f0100a><div class="content wangEditor-txt minHeight" data-v-e1f0100a><p>正如快捷指令，Tasker 之于手机端，Windows 上的任务计划程序也能够让不同软件协同工作，方便地完成各种具有固定流程的任务。本文将用三个简单例子阐释如何使用任务计划程序创建在固定时间运行的任务、周期循环的任务以及随事件触发的任务。任务计划程序本身并非实现自动化任务唯一要点，在脚本中使用合适的命令行工具有时候更加重要，因此，文中的每一节内容将包括脚本编写和任务计划程序配置两个方面。</p><p>想要任务计划程序正确工作须确保 Task Scheduler 服务的启动类型为「自动」。示例脚本运行环境为 Windows 10 和 PowerShell 7.1，不保证适用于低版本的 Windows。</p><h2>一、定时任务：Windows 深色/浅色模式切换</h2><p>强光下将系统和程序切换为浅色模式让显示更清晰，暗光下将系统和程序切换成深色减少对眼睛的刺激。实现以上效果的思路是在一天早晨和晚上的固定时间执行一系列固定任务。<a href="https://sspai.com/post/57593">两种方法，让 Windows 10 也能自动切换深/浅色主题</a> 一文虽然已经给出方法但并不完美。</p><p>切换系统和程序的深/浅模式需要完成三个步骤：切换系统显示模式，更换壁纸，切换不跟随系统样式的应用程序的显示模式。</p><p>切换系统显示模式可以用命令行修改注册表。位于<code>HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Themes\Personalize</code>  的 AppsUseLightTheme 以及 SystemUsesLightTheme 的值为 0 时是深色模式，为 1 时为浅色模式。</p><p>更改 Windows 壁纸则有打包好的 <a href="https://github.com/sindresorhus/wallpaper-cli">Wallpaper-CLI</a> 程序，安装 Node.js 后输入<code>npm install --global wallpaper-cli</code>安装此应用。之后，使用 <code>wallpaper [imagepath]</code>就能更换壁纸。</p><figure class="image ss-img-wrapper image_resized" style="width:740px;"><img src="https://cdn.sspai.com/2021/04/17/article/f01a1648123132dc2cfcf376c79e98e3?imageView2/2/w/1120/q/40/interlace/1/ignore-error/1" data-original="https://cdn.sspai.com/2021/04/17/article/f01a1648123132dc2cfcf376c79e98e3" referrerpolicy="no-referrer"></figure><p>像 Windows Terminal、Rime 这类应用程序的配色由自己独立的配置文件控制，我们需要找到并修改它们的配置文件。以 Rime 输入法为例，修改 weasel.custom.yaml 文件的<code>style/color_scheme</code>值，并重新部署即可切换皮肤。我们既可以使用<code>-replace</code><sup class="ss-footnote" href title="注意，PowerShell 5 在读写文件时可能会有编码错误。建议使用 PowerShell 7" footnote-id="1">1</sup>的方式，也可以准备两份配置文件用<code>Copy-Item</code>覆盖掉原文件。</p><p>综上所述，创建名为 Toggle-Night.ps1 的文件以切换深色模式，写入如下命令：</p><pre class="language-shell"><code>reg.exe add HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Themes\Personalize /v AppsUseLightTheme /t REG_DWORD /d 0 /f
reg.exe add HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Themes\Personalize /v SystemUsesLightTheme /t REG_DWORD /d 0 /f

wallpaper "D:\blank.jpg" ## 更换壁纸为 black.jpg

## 下面是 Rime 输入法的修改
(Get-Content "C:\...\Rime\weasel.custom.yaml") -replace("ink", "dark_temple") | Out-File "C:\...Rime\weasel.custom.yaml" ## 修改主题皮肤为 dark_temple
cd "C:\...\Rime\weasel-0.14.3\";./WeaselDeployer.exe /deploy ## 重新部署</code></pre><p>脚本编写完成后，进入任务计划程序，创建名为「深色模式」的任务，浅色模式同理：</p><ul><li>新建触发器。选择「按预定计划」，在开始一栏中写入我们希望系统切换为深色模式的时间。勾选「每天」，设置每隔「1」天发生一次，注意<strong>不要</strong>勾选「重复任务间隔」。</li><li>新建操作。选择「启动程序」，在「程序和脚本」栏中写入「pwsh.exe」，「添加参数」中写入「-nop -w hidden -file "D:\...\Toggle-Night.ps1"」。<code>-w hidden</code>会让脚本执行时终端只闪烁出现一次立刻消失。如果使用默认的 PowerShell 5 的话，需将「pwsh.exe」改为「powershell.exe」。</li><li><strong>不要</strong>勾选「条件」栏中的「只有计算机使用交流电源时才启动此任务」。在「设置」栏中，勾选「允许按需运行任务」和「如果过了计划时间，立即启动任务」。这样错过设定的时间时任务也会运行。</li></ul><figure class="image ss-img-wrapper image_resized" style="width:854px;"><img src="https://cdn.sspai.com/2021/04/17/article/adfcc3e5a9270d62008f7ec9e473d9bd?imageView2/2/w/1120/q/40/interlace/1/ignore-error/1" alt="效果" data-original="https://cdn.sspai.com/2021/04/17/article/adfcc3e5a9270d62008f7ec9e473d9bd" referrerpolicy="no-referrer"></figure><p>我们可以考虑将一些需要定时运行的任务都写入 Toggle-Night.ps1 中，不必为他们单独创建任务。例如我就将 Rime 输入法的词库同步、Chocolatey 升级添加进了脚本。</p><h2>二、周期任务：备份频繁变动的文件</h2><p>Word 等现代编辑器有每隔一定时间备份正在编辑的文件的功能，我们希望能够使用脚本实现类似的效果，备份诸如游戏本地存档、笔记等频繁变动的文件，方便回溯历史。不同于间隔时间很长的定时任务，这类脚本重复的间隔需要是几小时乃至几分钟。</p><p>比如，D 盘有一个 Obsidian 的笔记库 Note 文件夹，需要每 1 小时为它创建一次备份。文件夹中是数百个 KB 大小的 Markdown 文件，通过复制 <code>Copy-Item</code> 到其他文件夹的方式备份会产生大量小文件，不方便管理。因此，我们考虑使用 <a href="https://www.7-zip.org/">7zip</a> 的命令行工具<code>7z</code>。使用<code>7z</code>将所有文件以压缩包的形式备份到 OneDrive 内，并排除 .obsidian 等基本不变的文件夹，其命令为<code>7z a "$env:OneDrive/Data/Note/Obsidian.zip" "D:/Note/*" -xr!'.obsidian'</code>。</p><p>当然，我们不能让备份文件一直这样累加上去，需要配以清理命令——当备份文件到达一定数目时，删除最老的备份。最终的脚本 Backup-Note.ps1 如下：</p><pre class="language-shell"><code>## 以时间戳的方式命名备份的压缩包
$date = Get-Date -Format 'yyyy-MM-dd-HH'
7z a "$env:OneDrive/Data/Note/Obsidian-$date.zip" "D:/Note/*" -xr!'.obsidian'
## 当备份文件超过 5 个时，删除最老的备份
$Number = [System.IO.Directory]::GetFiles("$env:OneDrive\Data\Note").Count
if ($Number -ge 5)&#123;
 cd $env:OneDrive\Data\Note
 Get-Childitem | Sort-Object -Property LastWriteTime -Top 1 | Remove-Item ##注意，Powershell 5 不支持 -top 属性
&#125;</code></pre><p>然而不同于第一节中的定时任务，如果还使用<code>pwsh.exe -w hidden</code>的方式来隐藏终端的话，我们将会每 1 小时看到终端闪烁一下，体验可想可知。为了彻底隐藏脚本执行时的终端窗口，一个思路是使用 JS 脚本来执行 PowerShell 脚本 —— 创建文件 Backup-Note.js，写入</p><pre class="language-javascript"><code>var wshShell = new ActiveXObject("WScript.Shell");
wshShell.Run('pwsh.exe -nop -File "D:/.../Backup-Note.ps1"', 0, false);</code></pre><p>双击该 JS 脚本绑定 wscript 的打开方式，可以看到执行时不会有任何窗口。</p><p>接下来在任务计划程序中创建名为「备份 Note」的任务：</p><ul><li>新建触发器，选择「按预定计划」，将开始栏的数值调整为过去的任意时间，并勾选「重复任务间隔」，数值设置为「1 小时」，持续时间为「无限期」；</li><li>新建操作，选择「启动程序」，在程序和脚本栏中写入 Backup-Note.js 的路径；</li><li>其他设置参考第一节。</li></ul><figure class="image ss-img-wrapper image_resized" style="width:854px;"><img src="https://cdn.sspai.com/2021/04/17/article/0f951fdff0063ed17001fbbe92f076d4?imageView2/2/w/1120/q/40/interlace/1/ignore-error/1" data-original="https://cdn.sspai.com/2021/04/17/article/0f951fdff0063ed17001fbbe92f076d4" referrerpolicy="no-referrer"></figure><h2>三、事件任务：网络状态更改时，启/停应用</h2><p>任务计划程序提供了诸如「登录时」、「空闲状态」等常见的事件，可以用于配置开机自启软件等任务，这些任务配置起来相对简单。下面展示复杂一点的，需要配合 Windows 事件日志设置的任务 —— 网络状态更改时，启动/停止某程序。</p><p>诸如公司代理等软件，只有在连接网络时运行才有意义。在 PowerShell 中启/停应用比较简单，<code>Start-Process</code>和<code>Stop-Process</code>就能做到。比较麻烦的是找出网络状态更改时的事件日志。</p><p>通过搜索打开 Windows 事件查看器，定位到应用程序和服务日志 - Microsoft - Windows - NetworkProfile - Operational，窗口右侧会显示出所有已经记录的日志。为了准确地找到网络状态更改时产生的日志，首先选择「清除日志」，然后手动断开网络再连接，这时候刷新事件查看器，会多出几行网络日志。</p><figure class="image ss-img-wrapper image_resized" style="width:740px;"><img src="https://cdn.sspai.com/2021/04/17/article/ca2e1468ff9ba5f3618c0f025893b876?imageView2/2/w/1120/q/40/interlace/1/ignore-error/1" data-original="https://cdn.sspai.com/2021/04/17/article/ca2e1468ff9ba5f3618c0f025893b876" referrerpolicy="no-referrer"></figure><p>查看这些多出来的日志，可以发现连接网络时会产生一个 ID 为 10000 的日志，断开网络时会生成 ID 为 10001 的日志。</p><p>创建名为「启动代理软件」的任务，「停止软件」任务的配置同理：</p><ul><li>新建触发器，选择「发生事件时」，在下拉菜单中找到 Microsoft-Windows-NetworkProfile/Operational，选择源为 NetworkProfile，填写事件 ID 为上面我们记录的 10000；</li></ul><figure class="image ss-img-wrapper image_resized" style="width:740px;"><img src="https://cdn.sspai.com/2021/04/17/article/07a192f86a53eb699b93fdf537d17047?imageView2/2/w/1120/q/40/interlace/1/ignore-error/1" data-original="https://cdn.sspai.com/2021/04/17/article/07a192f86a53eb699b93fdf537d17047" referrerpolicy="no-referrer"></figure><ul><li>新建操作，选择启动程序，填入代理软件的路径；</li><li>在设置栏中，勾选「如果任务失败，按以下频率重新启动」。<strong>不要</strong>勾选「如果任务运行时间超过……」一项，因为在这个任务中，只要网络是连接状态，程序会一直保持「正在运行」状态。其他设置随意。</li></ul><h2>四、尾巴</h2><p>笔者通过以上三个简单例子，展示了不同的触发式任务在任务计划程序中的配置方式，同时穿插讲述了隐藏脚本运行时的终端窗口的两种思路以及查找固定事件日志的方法。但自动化程序能做的远远不只于此。</p><p>读者可以根据自己的想象力和需求配置出更棒的自动化任务。</p><p>题图：Photo by <a href="https://unsplash.com/@stadsa?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText">Tadas Sar</a> on <a href="https://unsplash.com/s/photos/microsoft?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText">Unsplash</a> </p></div><!----></div><div style="border:1px solid transparent;" data-v-e1f0100a></div><div class="article-side sideTop" style="display:none;left:0;" data-v-7be936cf data-v-e1f0100a><div class="download-guide-container" data-v-14f9065e data-v-7be936cf><div class="btn-wrapper" data-v-14f9065e><!----><button class="btn btn-view" data-v-14f9065e><i class="iconfont iconfont-phone" data-v-14f9065e></i></button></div><a href="https://sspai.com/s/JYjP" target="_blank" data-v-14f9065e><!----></a></div><div class="item-wrapper" data-v-7be936cf><button class="btn btn-charge" data-v-7be936cf><i class="iconfont" data-v-7be936cf></i></button><span class="count" data-v-7be936cf>9</span></div><div class="item-wrapper" data-v-7be936cf><button class="btn-mini btn-comment" data-v-7be936cf><i class="iconfont iconfont-comment" data-v-7be936cf></i></button><span class="count" data-v-7be936cf>2</span></div><div class="item-wrapper" data-v-7be936cf><span data-v-7be936cf><div role="tooltip" id="el-popover-5070" aria-hidden="true" class="el-popover el-popper popper-share right ss-popper-dark-border" style="width:undefinedpx;display:none;"><!----><div class="article-side-share-btn"><a href="https://service.weibo.com/share/share.php?url=null?ref=weibo&title=%E3%80%90Windows%20%E6%9C%AC%E5%9C%B0%E8%87%AA%E5%8A%A8%E5%8C%96%E5%B7%A5%E5%85%B7%EF%BC%8C%E4%BB%BB%E5%8A%A1%E8%AE%A1%E5%88%92%E7%A8%8B%E5%BA%8F%E5%BA%94%E7%94%A8%E4%B8%BE%E4%BE%8B%E3%80%91%E6%AD%A3%E5%A6%82%E5%BF%AB%E6%8D%B7%E6%8C%87%E4%BB%A4%EF%BC%8CTasker%E4%B9%8B%E4%BA%8E%E6%89%8B%E6%9C%BA%E7%AB%AF%EF%BC%8CWindows%E4%B8%8A%E7%9A%84%E4%BB%BB%E5%8A%A1%E8%AE%A1%E5%88%92%E7%A8%8B%E5%BA%8F%E4%B9%9F%E8%83%BD%E5%A4%9F%E8%AE%A9%E4%B8%8D%E5%90%8C%E8%BD%AF%E4%BB%B6%E5%8D%8F%E5%90%8C%E5%B7%A5%E4%BD%9C%EF%BC%8C%E6%96%B9%E4%BE%BF%E5%9C%B0%E5%AE%8C%E6%88%90%E5%90%84%E7%A7%8D%E5%85%B7%E6%9C%89%E5%9B%BA%E5%AE%9A%E6%B5%81%E7%A8%8B%E7%9A%84%E4%BB%BB%E5%8A%A1%EF%BC%8C%E4%BD%86%E8%BF%99%E6%96%B9%E9%9D%A2%E7%9A%84%E8%B5%84%EF%BC%88%E6%9D%A5%E8%87%AA%20%40%E5%B0%91%E6%95%B0%E6%B4%BEsspai%EF%BC%89%E5%85%A8%E6%96%87%EF%BC%9A&pic=https%3A%2F%2Fcdn.sspai.com%2F2021%2F04%2F21%2Fafb175b50f95937dde5b0d2250a7302e.jpg%3FimageMogr2%2Fauto-orient%2Fquality%2F95%2Fthumbnail%2F!1420x708r%2Fgravity%2FCenter%2Fcrop%2F1420x708%2Finterlace%2F1&appkey=3196502474#" target="_blank"><i class="icon icon-article_weibo right-16"></i></a><span><div role="tooltip" id="el-popover-8507" aria-hidden="true" class="el-popover el-popper" style="width:undefinedpx;display:none;"><!----><div style="text-align:center;"><div id="qr-code"></div><small class="qr-small">扫码分享</small></div></div><i class="icon icon-article_weixin right-16"></i></span><a href="https://twitter.com/share?text=%E3%80%90Windows%20%E6%9C%AC%E5%9C%B0%E8%87%AA%E5%8A%A8%E5%8C%96%E5%B7%A5%E5%85%B7%EF%BC%8C%E4%BB%BB%E5%8A%A1%E8%AE%A1%E5%88%92%E7%A8%8B%E5%BA%8F%E5%BA%94%E7%94%A8%E4%B8%BE%E4%BE%8B%E3%80%91%E6%AD%A3%E5%A6%82%E5%BF%AB%E6%8D%B7%E6%8C%87%E4%BB%A4%EF%BC%8CTasker%E4%B9%8B%E4%BA%8E%E6%89%8B%E6%9C%BA%E7%AB%AF%EF%BC%8CWindows%E4%B8%8A%E7%9A%84%E4%BB%BB%E5%8A%A1%E8%AE%A1%E5%88%92%E7%A8%8B%E5%BA%8F%E4%B9%9F%E8%83%BD%E5%A4%9F%E8%AE%A9%E4%B8%8D%E5%90%8C%E8%BD%AF%E4%BB%B6%E5%8D%8F%E5%90%8C%E5%B7%A5%E4%BD%9C%EF%BC%8C%E6%96%B9%E4%BE%BF%E5%9C%B0%E5%AE%8C%E6%88%90%E5%90%84%E7%A7%8D%E5%85%B7%E6%9C%89%E5%9B%BA%E5%AE%9A%E6%B5%81%E7%A8%8B%E7%9A%84%E4%BB%BB%E5%8A%A1%EF%BC%8C%E4%BD%86%E8%BF%99%E6%96%B9%E9%9D%A2%E7%9A%84%E8%B5%84%EF%BC%88%E6%9D%A5%E8%87%AA%20%40%E5%B0%91%E6%95%B0%E6%B4%BEsspai%EF%BC%89%E5%85%A8%E6%96%87%EF%BC%9A&url=null" target="_blank" class="twitter"><i class="icon icon-article_twitter right-16"></i></a></div></div><button class="btn-mini btn-share" data-v-7be936cf><i class="iconfont iconfont-share" data-v-7be936cf></i></button></span></div><div class="item-wrapper" data-v-7be936cf><button class="btn-mini btn-collect" data-v-7be936cf><i class="iconfont iconfont-collect" data-v-7be936cf></i></button></div><!----></div><!---->  
</div>
            