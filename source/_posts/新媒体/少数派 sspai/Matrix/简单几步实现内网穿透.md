
---
title: '简单几步实现内网穿透'
categories: 
 - 新媒体
 - 少数派 sspai
 - Matrix
headimg: 'https://cdn.sspai.com/2022/05/17/db42d70e69013af8c4944a5fc1225e3b.png?imageView2/2/w/1120/q/40/interlace/1/ignore-error/1'
author: 少数派 sspai
comments: false
date: Tue, 17 May 2022 15:41:29 GMT
thumbnail: 'https://cdn.sspai.com/2022/05/17/db42d70e69013af8c4944a5fc1225e3b.png?imageView2/2/w/1120/q/40/interlace/1/ignore-error/1'
---

<div>   
<div class="articleWidth-content" data-v-6dd0eb6a><div class="update-wrap" data-v-6dd0eb6a></div><div class="content wangEditor-txt minHeight" data-v-6dd0eb6a><h3>场景</h3><p>为了避免阐述过多理论，我们直接从需求场景入手，来了解一下为什么需要内网穿透？</p><blockquote><p>小明是少数派的一位咕咕作者，在家里电脑稿某文稿了一半，到公司后打算摸鱼继续稿，怎么办呢（此处假定他没有使用任何云同步软件，也不会使用git，就算会用他也忘了提交）？</p><p>此时，小明想通过ssh等远程访问设备文件的方式来下载家里那半稿子，但他的家庭网络是没有分配公网IP的，无法通过互联网直连。内网穿透就这样派上用场了。</p></blockquote><p>所以通俗地讲，内网穿透就是要将流量从公网穿透到内网，让内网设备也能通过公网访问，帮助小明在公司访问家里电脑的文件。</p><h3>设施</h3><p>内网穿透的核心思想就是“映射”和“转发”，把内网设备的端口映射到公网设备的端口上，来进行流量转发。</p><figure class="image ss-img-wrapper"><img src="https://cdn.sspai.com/2022/05/17/db42d70e69013af8c4944a5fc1225e3b.png?imageView2/2/w/1120/q/40/interlace/1/ignore-error/1" data-original="https://cdn.sspai.com/2022/05/17/db42d70e69013af8c4944a5fc1225e3b.png" referrerpolicy="no-referrer"></figure><p>简单地画一下示意图如上，基础设施由两个核心设备组成：</p><p>服务端：拥有公网IP的设备一台，即上图“公网服务器”，开放2个端口7000和6000，用于公网通信。</p><p>客户端：要访问的内网设备一台，即上图"内网家用电脑"，开放实际应用服务所需的端口（比如ssh服务，默认22端口），并将配置的公网映射端口6000告知服务端。所以服务端开放的那个端口6000实际上是客户端告诉它的。</p><p><i>（以上端口除22以外均为自定义端口，无特殊含义。）</i></p><p>基础设施搭建好以后，小明在公司通过ssh远程访问自家电脑的命令便如下：</p><pre class="language-shell"><code># 假定服务器公网IP是119.23.141.248，内网家用电脑用户名是test
ssh -oPort=6000 test@119.23.141.248</code></pre><p>这就是我们想达到内网穿透的预期效果——表面上看，家庭内网的电脑就像拥有了公网IP一样暴露在互联网中。</p><h3>实现</h3><p>要实现这种基础的内网穿透，一般是以一台带公网IP的服务器作为中转（暂不讨论点对点的）。开源世界中已经有很多较为成熟的工具，接下来就直接以<a href="https://github.com/fatedier/frp">frp</a>为例，简单几步部署就可以搞定啦！</p><h4>安装</h4><p>先在官方发布仓库下载对应包，几种常用架构：</p><ul><li>比如服务端一般是Linux（Intel 64位CPU）：<a href="https://github.com/fatedier/frp/releases/download/v0.42.0/frp_0.42.0_linux_amd64.tar.gz">frp_0.42.0_linux_amd64.tar.gz</a></li><li>客户端一般是Windows（Intel 64位CPU）：<a href="https://github.com/fatedier/frp/releases/download/v0.42.0/frp_0.42.0_windows_amd64.zip">frp_0.42.0_windows_amd64.zip</a></li><li>或macOS（Intel芯片）：<a href="https://github.com/fatedier/frp/releases/download/v0.42.0/frp_0.42.0_darwin_amd64.tar.gz">frp_0.42.0_darwin_amd64.tar.gz</a>；M1芯片：<a href="https://github.com/fatedier/frp/releases/download/v0.42.0/frp_0.42.0_darwin_arm64.tar.gz">frp_0.42.0_darwin_arm64.tar.gz</a></li></ul><p>如果GitHub访问困难，可以从我的网盘下载：<a href="https://pan.baidu.com/s/1BUb9pDITZLPHATGYaYVefw?pwd=c655">frp-v0.4.2</a></p><p><strong>解压</strong>后会发现里面既有<code>frps</code>也有<code>frpc</code>（Windows版本的可执行程序是exe），前者表示Server（服务端），后者表示Client（客户端），对应同名配置文件<code>frps.ini</code>和<code>frpc.ini</code>，对于某一端只会用到其中一套程序。</p><h4>配置</h4><p>这里参考<a href="https://gofrp.org/docs/examples/ssh/">官方文档</a>介绍两种比较实用的配置，ssh服务和文件访问服务。</p><p><strong>一、通过 SSH 访问内网机器</strong></p><p>解压对应架构的包到服务端，并修改frps.ini文件，设置端口7000，当然你可以自定义为任意端口，只要不和系统上已有端口冲突即可：</p><pre class="language-shell"><code>[common]
bind_port = 7000</code></pre><p>启动服务端frp（-c参数表示config）：</p><pre class="language-shell"><code>./frps -c ./frps.ini</code></pre><p>同理，解压包到客户端，并修改frpc.ini文件，在common标签下填入公网服务器的IP和端口（对应服务端设置的端口）。然后设置好ssh服务的远程端口6000即可（local_ip和port一般不用改）。</p><pre class="language-shell"><code>[common]
server_addr = x.x.x.x
server_port = 7000

[ssh]
type = tcp
local_ip = 127.0.0.1
local_port = 22
remote_port = 6000</code></pre><p>启动客户端frp：</p><pre class="language-shell"><code>./frpc -c ./frpc.ini</code></pre><p>不出意外的话，客户端的终端会提示你登录服务端成功。</p><p>然后在任意一个设备上即可通过公网访问内网设备（即客户端frp所在的那台）：</p><pre class="language-shell"><code>ssh -oPort=6000 你的系统登录用户名@x.x.x.x</code></pre><p><strong>二、对外提供简单的文件访问服务</strong></p><p>如果我们想通过浏览器直接访问内网设备上的文件，就这样配置客户端（此处以Windows为例），不用改服务端：</p><pre class="language-shell"><code>[common]
server_addr = x.x.x.x
server_port = 7000

[ssh]
type = tcp
local_ip = 127.0.0.1
local_port = 22
remote_port = 6000

[c_static_file]
type = tcp
remote_port = 6001
plugin = static_file
plugin_local_path = C:
plugin_strip_prefix = driver_c
plugin_http_user = 自定义名称，这个和系统登录的用户名不是一个东西，随便写就行
plugin_http_passwd = 自定义密码

[d_static_file]
type = tcp
remote_port = 6002
plugin = static_file
plugin_local_path = D:
plugin_strip_prefix = driver_d
plugin_http_user = 自定义名称，同上
plugin_http_passwd = 自定义密码</code></pre><p>我们在上文已配置好ssh的基础上，追加两个文件访问配置c_static_file和d_static_file，这两个标签名字也是自定义的；static_file是文件访问服务的客户端插件名称，这个是固定的；<code>plugin_local_path = C:</code>表示可访问整个C盘，对应下面的是D盘；driver_c和driver_d这两个前缀也是自定义的，便于等会儿在浏览器访问。</p><p>修改配置文件后，重新启动客户端frp：</p><pre class="language-shell"><code>frpc.exe -c frpc.ini</code></pre><p>启动成功后，就可以在浏览器直接访问啦：<strong>http://x.x.x.x:6001/driver_c/</strong>，访问的时候提示你输入用户名和密码就是上面配置的plugin_http_user和passwd。</p><p><i>（不容易注意到的小坑：地址末尾的斜杠/必须填，否则访问不了）</i></p><h3>末了</h3><p>在测试的时候，我的公网服务器是在腾讯云上，默认有防火墙规则，所以要记得在后台配置放开相应的端口访问（比如上述的7000和6000）。另外，文中有个小彩蛋，不知道有没有人发现哈哈！</p></div><div class="update-details-wrap" data-v-6dd0eb6a></div><!----></div><div style="border:1px solid transparent;" data-v-6dd0eb6a></div><div class="article-side sideTop" style="display:none;left:0;" data-v-7be936cf data-v-6dd0eb6a><div class="download-guide-container" data-v-14f9065e data-v-7be936cf><div class="btn-wrapper" data-v-14f9065e><!----><button class="btn btn-view" data-v-14f9065e><i class="iconfont iconfont-phone" data-v-14f9065e></i></button></div><a href="https://sspai.com/s/JYjP" target="_blank" data-v-14f9065e><!----></a></div><div class="item-wrapper" data-v-7be936cf><button class="btn btn-charge" data-v-7be936cf><i class="iconfont" data-v-7be936cf></i></button><span class="count" data-v-7be936cf>7</span></div><div class="item-wrapper" data-v-7be936cf><button class="btn-mini btn-comment" data-v-7be936cf><i class="iconfont iconfont-comment" data-v-7be936cf></i></button><span class="count" data-v-7be936cf>3</span></div><div class="item-wrapper" data-v-7be936cf><span data-v-7be936cf><div role="tooltip" id="el-popover-4090" aria-hidden="true" class="el-popover el-popper popper-share right ss-popper-dark-border" style="width:undefinedpx;display:none;"><!----><div class="article-side-share-btn"><a href="https://service.weibo.com/share/share.php?url=null?ref=weibo&title=%E3%80%90%E7%AE%80%E5%8D%95%E5%87%A0%E6%AD%A5%E5%AE%9E%E7%8E%B0%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F%E3%80%91%E5%9C%BA%E6%99%AF%E4%B8%BA%E4%BA%86%E9%81%BF%E5%85%8D%E9%98%90%E8%BF%B0%E8%BF%87%E5%A4%9A%E7%90%86%E8%AE%BA%EF%BC%8C%E6%88%91%E4%BB%AC%E7%9B%B4%E6%8E%A5%E4%BB%8E%E9%9C%80%E6%B1%82%E5%9C%BA%E6%99%AF%E5%85%A5%E6%89%8B%EF%BC%8C%E6%9D%A5%E4%BA%86%E8%A7%A3%E4%B8%80%E4%B8%8B%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F%EF%BC%9F%E5%B0%8F%E6%98%8E%E6%98%AF%E5%B0%91%E6%95%B0%E6%B4%BE%E7%9A%84%E4%B8%80%E4%BD%8D%E5%92%95%E5%92%95%E4%BD%9C%E8%80%85%EF%BC%8C%E5%9C%A8%E5%AE%B6%E9%87%8C%E7%94%B5%E8%84%91%E7%A8%BF%E6%9F%90%E6%96%87%E7%A8%BF%E4%BA%86%E4%B8%80%E5%8D%8A%EF%BC%8C%E5%88%B0%E5%85%AC%E5%8F%B8%EF%BC%88%E6%9D%A5%E8%87%AA%20%40%E5%B0%91%E6%95%B0%E6%B4%BEsspai%EF%BC%89%E5%85%A8%E6%96%87%EF%BC%9A&pic=https%3A%2F%2Fcdn.sspai.com%2F2022%2F05%2F17%2Ff0d27f409f59e76ca7fc7e3e6a68f656.png%3FimageMogr2%2Fauto-orient%2Fquality%2F95%2Fthumbnail%2F!1420x708r%2Fgravity%2FCenter%2Fcrop%2F1420x708%2Finterlace%2F1&appkey=3196502474#" target="_blank"><i class="iconfont iconfont-weibo-simple right-16"></i></a><span><div role="tooltip" id="el-popover-8583" aria-hidden="true" class="el-popover el-popper" style="width:undefinedpx;display:none;"><!----><div style="text-align:center;"><div id="qr-code"></div><small class="qr-small">扫码分享</small></div></div><span class="el-popover__reference-wrapper"><i class="iconfont iconfont-wechat-simple right-16"></i></span></span><a href="https://twitter.com/share?text=%E3%80%90%E7%AE%80%E5%8D%95%E5%87%A0%E6%AD%A5%E5%AE%9E%E7%8E%B0%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F%E3%80%91%E5%9C%BA%E6%99%AF%E4%B8%BA%E4%BA%86%E9%81%BF%E5%85%8D%E9%98%90%E8%BF%B0%E8%BF%87%E5%A4%9A%E7%90%86%E8%AE%BA%EF%BC%8C%E6%88%91%E4%BB%AC%E7%9B%B4%E6%8E%A5%E4%BB%8E%E9%9C%80%E6%B1%82%E5%9C%BA%E6%99%AF%E5%85%A5%E6%89%8B%EF%BC%8C%E6%9D%A5%E4%BA%86%E8%A7%A3%E4%B8%80%E4%B8%8B%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F%EF%BC%9F%E5%B0%8F%E6%98%8E%E6%98%AF%E5%B0%91%E6%95%B0%E6%B4%BE%E7%9A%84%E4%B8%80%E4%BD%8D%E5%92%95%E5%92%95%E4%BD%9C%E8%80%85%EF%BC%8C%E5%9C%A8%E5%AE%B6%E9%87%8C%E7%94%B5%E8%84%91%E7%A8%BF%E6%9F%90%E6%96%87%E7%A8%BF%E4%BA%86%E4%B8%80%E5%8D%8A%EF%BC%8C%E5%88%B0%E5%85%AC%E5%8F%B8%EF%BC%88%E6%9D%A5%E8%87%AA%20%40%E5%B0%91%E6%95%B0%E6%B4%BEsspai%EF%BC%89%E5%85%A8%E6%96%87%EF%BC%9A&url=null" target="_blank" class="twitter"><i class="iconfont iconfont-twitter-simple right-16"></i></a></div></div><span class="el-popover__reference-wrapper"><button class="btn-mini btn-share" data-v-7be936cf><i class="iconfont iconfont-share" data-v-7be936cf></i></button></span></span></div><div class="item-wrapper" data-v-7be936cf><button class="btn-mini btn-collect" data-v-7be936cf><i class="iconfont iconfont-collect" data-v-7be936cf></i></button></div><!----></div><!---->  
</div>
            