
---
title: '【标签画像系列】标签加工与落库'
categories: 
 - 新媒体
 - 人人都是产品经理
 - 最新文章
headimg: 'https://cors.zfour.workers.dev/?http://image.woshipm.com/wp-files/2022/05/fbHsZakg47hx8UlNr8Gw.jpg'
author: 人人都是产品经理
comments: false
date: Thu, 26 May 2022 00:00:00 GMT
thumbnail: 'https://cors.zfour.workers.dev/?http://image.woshipm.com/wp-files/2022/05/fbHsZakg47hx8UlNr8Gw.jpg'
---

<div>   
<blockquote><p>编辑导语：标签加工与落库是标签体系完成后重要的步骤，本篇文章作者分享了标签加工与落库过程中需要关注的注意点，讲述了不同标签的加工内容以及标签的更新与落库等内容，一起来学习一下吧，希望对你有帮助。</p></blockquote>
<p><img data-action="zoom" class="size-full wp-image-5457509 aligncenter" src="https://cors.zfour.workers.dev/?http://image.woshipm.com/wp-files/2022/05/fbHsZakg47hx8UlNr8Gw.jpg" alt width="900" height="420" referrerpolicy="no-referrer"></p>
<p>在标签生命周期流程中，标签体系设计完成后，便进入标签加工与上线运行阶段，一般来说数据开发团队会主导此过程，但我们需要关心以下几个问题：</p>
<ul>
<li>标签如何快速创建和实现标签逻辑的在线化管理；</li>
<li>业务人员怎么参与到标签建设流程中；</li>
<li>百级别的标签如何落表。</li>
</ul>
<h2 id="toc-1">一、加工方式：传统 VS 在线</h2>
<p>当企业无标签系统时，一般由数据开发在离线数仓中完成标签加工和运行，运营或市场同学需要某个标签需要通过产品经理向数据开发提需求，这个过程存在很多问题：</p>
<ul>
<li>标签资产不可见：标签是存在于表里的字段，业务人员不清楚现在有多少标签；标签的加工逻辑与业务逻辑是否一致只能查看SQL代码；新上线的标签只有部分人知道，标签价值散发慢等。</li>
<li>标签资产不可管：加工好的标签，有多少在真正被使用，有多少没人用，完全黑盒，不用的标签每天继续运行浪费计算与存储资源。</li>
<li>标签加工效率低：当业务人员需要某个简单标签时，也需要提交需求给数据开发，加工到上线基本需要2-3天流程。</li>
</ul>
<p>基于以上这些问题，<b>标签在线化创建与管理显得尤为重要</b>，在线化主要包含以下内容：</p>
<ul>
<li>标签在线化加工；</li>
<li>标签在线化管理；</li>
<li>标签在线化更新。</li>
</ul>
<p>其让标签加工过程、有哪些标签变得透明，业务人员也可以参与进标签建设的流程中。</p>
<h2 id="toc-2">二、各类型标签加工</h2>
<p>标签类型的区分在此处便不再赘述了。在袋鼠云智能标签产品中，我们按照标签加工逻辑，将标签分为下文类型，各类型标签的加工层次如下图：</p>
<p><img data-action="zoom" class="origin_image zh-lightbox-thumb lazy aligncenter" src="https://cors.zfour.workers.dev/?http://image.woshipm.com/wp-files/2022/05/hV0PE5A8SrPQ6URsykaJ.jpg" width="772" height="371" referrerpolicy="no-referrer"></p>
<p>接下来，我们看下具体各类型标签的加工吧。</p>
<h3>1. 原子标签</h3>
<p>该类标签由数据开发在数仓加工中完成，一般基于数仓DWD、DWS层的明细表与汇总表加工而来，处理逻辑较为复杂，同时维表中的一些字段也可以作为原子标签。这类标签一般包含哪些内容呢？</p>
<p><strong>比如建立用户的标签体系，会包含：</strong></p>
<p>用户维表中的用户基础属性：性别、年龄、置业、会员等级、手机号、身份证号等信息，一般用户系统会有该类信息。</p>
<p><strong>基于交易表加工的交易指标：</strong>最近30天购买次数、最近30天交易金额、最近7天购买次数、最近7天交易金额。这部分标签也建议放在数仓中实现，有以下几点原因。</p>
<ol>
<li>因为其本身也是一个指标，除后续作为标签进行画像分析外，也常用于在数据门户、BI报表中分析，可作为对外服务的指标放在ADS层中，并且市场上也会有专门指标管理的产品，来实现该指标的加工。</li>
<li>这类标签若属于同一个统计维度（如都计算最近7天），数据开发可以在一个SQL片段中计算多个标签，节约计算成本。</li>
<li>若业务人员直接基于DWS层的轻度汇总表（每天汇总的交易次数、交易金额）、或DWD层的明细表（每条交易记录一行数据）来加工最近30天购买次数这个标签，需要针对对应的字段进行求和，稍微涉及到一点SQL理解，有一点难度。</li>
</ol>
<p>故该类使用场景多、对于业务人员有计算难度，可在数仓中合并加工降低成本的标签，可在数仓中作为原子标签加工。</p>
<p>基于行为表加工的行为指标：可经过数仓加工成如下表格式，加工行为类的标签，便于后续业务人员去衍生。</p>
<p><img data-action="zoom" class="origin_image zh-lightbox-thumb lazy aligncenter" src="https://cors.zfour.workers.dev/?http://image.woshipm.com/wp-files/2022/05/dYLnNUNijoYb9R5xYERh.jpg" width="753" height="188" referrerpolicy="no-referrer"></p>
<p>原子标签在数仓加工好后，可导入到标签系统中，进行在线化管理。</p>
<h3>2. 规则标签</h3>
<p>该类标签配置可由数据开发或数据分析师来完成，可基于单张表或关联表中的字段进行在线化加工，可设置统计周期、数据过滤条件，其内置常用的聚合函数（求和、均值、计数、去重技术、最大值、最小值等）、操作符（大于、小于、区间、有值、无值、包含等），通过规则化的在线配置完成标签加工。配置界面如以下：<br>
<img data-action="zoom" class="origin_image zh-lightbox-thumb lazy aligncenter" src="https://cors.zfour.workers.dev/?http://image.woshipm.com/wp-files/2022/05/g3u3waat4jCxK5gO4qMG.jpg" width="771" height="781" referrerpolicy="no-referrer"></p>
<p>根据上面的描述，该类标签可以将指标的类型的标签在数仓或指标平台加工好，导入至标签平台作为原子标签，再基于这些原子标签取操作符更好。但在实际场景中，基于不同考虑，有的客户也会在标签平台直接加工此类型标签，如以下场景：</p>
<ol>
<li>数仓无对应的基础标签，但业务人员很着急需要该标签某标签，走正常的排期、数仓加工、测试，上线到使用基本2天以上了，基于这种情况可以通过该类标签在标签系统直接配置，5分钟即可配置、更新完成，业务人员便可以使用了；</li>
<li>客户方想把标签的加工逻辑在线化呈现、方便查找与追溯，通过可视化的方式在线配置。</li>
</ol>
<h3>3. SQL标签</h3>
<p>SQL标签主要数据开发、数据分析师使用，主要解决通过规则标签无法表达的逻辑，如用到排序函数、字符转化函数、子查询等内容。可以通过标准SQL语法灵活完成标签加工。</p>
<p><img data-action="zoom" class="origin_image zh-lightbox-thumb lazy aligncenter" src="https://cors.zfour.workers.dev/?http://image.woshipm.com/wp-files/2022/05/chRdJwiLVGRFYUo2G2uC.jpg" width="772" height="425" referrerpolicy="no-referrer"></p>
<h3>4. 模型标签</h3>
<p>模型标签可由业务人员创建。系统集成常见的用户分层RFM模型，用户营销AIPL模型、用户生命周期模型，用户输入对应的指标值区间，便可定义对应的标签值。</p>
<p>以RFM模型举例，基于该模型生成“客户价值”标签。可基于最近一次购买时间、最近一年消费金额、最近一年消费频率等几个原子标签，进行不同区间的取值，给用户打上“重要价值客户”、“重要发展客户”、“重要发展客户”、“重要挽留客户”等。</p>
<h3>5. 组合标签</h3>
<p>模型标签可由业务人员创建。基于已生成的原子、规则、SQL、模型标签等，进行规则衍生，生成组合标签。如组合标签“高收入低购买”用户，可通过“收入水平”衍生标签，与“最近3年消费金额区间”衍生标签组合加工，如下图：</p>
<p><img data-action="zoom" class="origin_image zh-lightbox-thumb lazy aligncenter" src="https://cors.zfour.workers.dev/?http://image.woshipm.com/wp-files/2022/05/HZdqLRaoZcOJ5ZGJJylF.jpg" width="777" height="424" referrerpolicy="no-referrer"></p>
<h3>6. 自定义标签</h3>
<p>自定义标签可由业务人员创建。手动为某些用户打上标签，该类标签手动导入，常见场景如下：</p>
<ul>
<li>客服人员和用户ID为1001的用户沟通后，给该用户打上”性格：温和、有耐心”标签。</li>
<li>如监管机构提供的一些信贷黑名单用户，该类标签可直接导入进标签系统，为用户打上新的标签。</li>
</ul>
<h3>7. 算法标签</h3>
<p>算法标签由算法开发同学创建，该类标签可在算法平台完成，将算好的结果存储至Hive表中，标签系统可获取算法标签的元数据，拿到算法标签的中文名、英文名，注册至标签系统中，在标签系统中完成算法标签的标签信息查看、标签查询等。</p>
<p>如利用机器学习模型加工预测类的算法标签，如根据用户的特征，预测哪些用户是否即将流失，流失的概率等，从而在用户流失之前做一些措施来挽留。</p>
<h3>8. 实时标签</h3>
<p>实时标签由数据开发同学创建，该类标签可在流计算平台完成，实时行为数据打入到kafka中，用FlinkSQL消费，再输出到Kafka、或数据表中，下游直接订阅或查询。</p>
<h2 id="toc-3">三、标签更新与落库</h2>
<p>标签配置完成后，便需要进行标签更新与落库，即将标签打到对象（如用户）的身上，这样业务同学就可以根据标签圈选目标群组啦。在此处我们需要说明以下几个问题：</p>
<h3>1. 技术选型</h3>
<p>首先说明一下标签加工的技术选型，在袋鼠云智能标签产品中我们用的 Trino（Presto）高性能分析引擎读写 Hive 表的方式，标签表存储在Hive中。主要有以下几点原因：</p>
<ul>
<li>随着国家对数字化转型的支持，从金融、政府到小企业都在建设数仓，进行数字化应用，在这个过程中，大多采用的是分布式的Hadoop系统作为计算存储引擎（不论是开源Hadoop，还是发行版的CDH、TDH、FusionInsight等），Hive表便是最常用的存储形式。标签是基于数仓模型搭建出来的，与数仓用同一种存储可以节省存储资源以及不用两种存储之间进行数据交换。</li>
<li>而用Trino（Presto）的原因是其首先是一个分析型引擎，读写速度均可；其次是其SQL语法完备、函数丰富、灵活，可以处理绝大多是业务场景的需求；并且支持跨库同时读取，如Trino可以同时取Hive与MySQL的数据进行数据处理。</li>
</ul>
<p>但没有一种完美的技术选型，只能贴合企业自己的业务，选取最合适的技术。在这里我们就不分析各种标签的技术选型了。</p>
<h3>2. 落表方式</h3>
<p>上面我们介绍了有各种类型的标签，标签如何落表呢，大家看下面这个图：</p>
<p><img data-action="zoom" class="origin_image zh-lightbox-thumb lazy aligncenter" src="https://cors.zfour.workers.dev/?http://image.woshipm.com/wp-files/2022/05/Vsy9bJvogTIeL2KQAPwi.jpg" width="770" height="295" referrerpolicy="no-referrer"></p>
<p>在业务场景中，存在有的标签需要每天更新，如最近30天消费金额区间。而有的标签周更新、月更新即可，更新频率不高，如活动类型偏好。</p>
<p>这样，便需要支持每个标签有不同的更新频率，但hive2.x版本不支持单列更新，为了解决该问题，我们将每个标签先在临时表存一下（就包含2列，1列用户ID，1列标签）该临时表即建即用即删，每个标签只有一个临时表（非分区表），每个标签占用的占用不大，又能解决标签更新周期不一致的问题。</p>
<p>但如果后续的标签圈群、群组画像分析，我们基于这些单独表的去做联合查询，那效率会很低。</p>
<p>因为每个用营销活动，我们需要5个标签圈选出来一批人群，并查询出这群人的性别、年龄、月消费、会员等级、是否活跃用户等信息，加起来用到了10个标签左右，会涉及到10个表的join操作，客户集群资源不丰裕的情况，查询速度慢。</p>
<p>所有我们便将多个临时表通过聚合任务，将所有的临时表join到一张标签大宽表中，进行固化，这张表是一个分区表，可以每天存储一份全量用户标签信息，当然可以自行设置该表的更新周期与保存多少个分区。</p>
<p>这样，业务人员进行圈群和分析就可以一张表查询数据，查询效率大大提升。通过标签跑批时间的消耗换取业务的查询速度。</p>
<p>但会遇到有些企业标签数量在500-1000个之间，用户量在千万、亿级别，这样的话，用一张表去存所有的标签会遇到标签大宽表跑批时间过长或跑不出来的情况，所以便需要分表，可以根据标签数量分表。</p>
<p>综上，以上加工存储方式，有缺点的地方便是大宽表加工时，需要join多个临时表，消耗内存，跑批时间长。</p>
<p>为解决该问题，袋鼠云智能标签产品在引入数据湖Iceberg进行标签表的存储，其可以实现单列更新，每个标签可以单独更新，这样，便不需要那些临时表了，解决加工效率的问题。</p>
<p>该篇讲了标签的加工与落库，欢迎大家留言讨论，也可以分享下自己见到一些好的标签加工方式，我们共同进步。</p>
<p>对了，业务人员怎么参与到标签建设流程中，该问题在【标签画像系列】标签画像建设方法论中有介绍过，可以去那里查看。</p>
<p> </p>
<p>本文由 @木研 原创发布于人人都是产品经理，未经许可，禁止转载。</p>
<p>题图来自 Unsplash，基于 CC0 协议。</p>
<div class="support-author"><div class="support-title">给作者打赏，鼓励TA抓紧创作！</div><button class="button--pay" data-post-id="5456420" data-author="1027126" data-avatar="http://image.woshipm.com/wp-files/2022/05/fS0QU5IWVxcyvzdZwz5d.jpeg"><svg width="13" height="16" class="svgIcon--use" viewBox="0 0 13 16"><path d="M9.113,4.571 C9.951,3.771 10.895,2.742 10.685,2.057 C10.475,1.485 10.056,0.799 9.427,0.571 C8.903,0.342 8.379,0.456 7.750,0.799 C7.540,0.342 7.016,0.114 6.596,-0.001 C5.863,-0.001 5.234,0.228 4.814,0.914 C4.080,0.571 3.451,0.685 2.927,1.028 C2.613,1.256 2.298,1.713 2.298,2.628 C2.298,3.542 3.137,4.228 3.766,4.685 C2.508,5.599 -0.218,7.885 -0.008,12.228 C-0.218,15.656 2.613,15.999 2.613,15.999 L10.371,15.999 C11.314,15.885 12.991,14.971 12.991,12.571 L12.991,12.228 C13.201,7.771 10.371,5.371 9.113,4.571 L9.113,4.571 ZM8.932,11.835 L6.940,11.835 L6.940,13.207 C6.940,13.435 6.731,13.549 6.521,13.549 C6.311,13.549 6.102,13.435 6.102,13.207 L6.102,11.835 L4.110,11.835 C3.900,11.835 3.795,11.606 3.795,11.378 C3.795,11.149 3.900,10.921 4.110,10.921 L6.102,10.921 L6.102,10.121 L4.949,10.121 C4.739,10.121 4.634,9.892 4.634,9.664 C4.634,9.435 4.739,9.206 4.949,9.206 L5.892,9.206 L4.739,7.950 C4.634,7.835 4.739,7.606 4.949,7.492 C5.158,7.378 5.368,7.264 5.473,7.378 L6.521,8.635 L7.674,7.264 C7.779,7.149 7.989,7.264 8.198,7.378 C8.408,7.492 8.408,7.721 8.408,7.835 L7.150,9.321 L8.094,9.321 C8.303,9.321 8.408,9.549 8.408,9.778 C8.408,10.007 8.303,10.235 8.094,10.235 L6.940,10.235 L6.940,11.035 L8.932,11.035 C9.142,11.035 9.247,11.264 9.247,11.493 C9.247,11.606 9.037,11.835 8.932,11.835 L8.932,11.835 Z"/></svg>
赞赏</button></div>                      
</div>
            