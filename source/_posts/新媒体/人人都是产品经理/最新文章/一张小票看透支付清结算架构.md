
---
title: '一张小票看透支付清结算架构'
categories: 
 - 新媒体
 - 人人都是产品经理
 - 最新文章
headimg: 'https://cors.zfour.workers.dev/?http://image.woshipm.com/wp-files/2021/05/AnxepRL88ZrX3vJ69Q6A.jpg'
author: 人人都是产品经理
comments: false
date: Mon, 17 May 2021 00:00:00 GMT
thumbnail: 'https://cors.zfour.workers.dev/?http://image.woshipm.com/wp-files/2021/05/AnxepRL88ZrX3vJ69Q6A.jpg'
---

<div>   
<blockquote><p>编辑导语：支付清结算系统在现实生活中十分常见，并在多个场景中被应用。本篇文章里，作者结合生活中的现象对支付清结算系统的整体架构进行了梳理，抽象出“311架构模型”。假如你想系统地了解支付清结算系统的话，不妨一起看一下吧。</p></blockquote>
<p><img data-action="zoom" class="size-full wp-image-4572854 aligncenter" src="https://cors.zfour.workers.dev/?http://image.woshipm.com/wp-files/2021/05/AnxepRL88ZrX3vJ69Q6A.jpg" alt width="900" height="420" referrerpolicy="no-referrer"></p>
<p>支付清结算相关的系统写了很多了，单模块介绍的也不少；虽然有几个架构性质的文章，但是有不少朋友反馈说无法串起来；今天我们就从一次美团外卖的小票来看，将支付清结算串起来会是什么体验！准备好了么，抓好扶手，走起！</p>
<h2 id="toc-1">一、一张小票</h2>
<p>我们看下面外卖盒上的小票，牛肉拌饭1份一共39元，餐盒费1元，没有配送费，合计40元，优惠了19元，实付21，实收17元。</p>
<p>我们再看美团订单的信息，烤肉饭1分39元，打包费1元，配送费原价7元现价2元，美团会员15元；美团红包减7元，满减优惠14元；总优惠26元，合计36元。</p>
<p><img data-action="zoom" class="rich_pages aligncenter" title="一张小票看透支付清结算架构" src="https://cors.zfour.workers.dev/?http://image.woshipm.com/wp-files/2021/05/3XpVixlhVLRzh6lC2Hyo.png" alt="一张小票看透支付清结算架构" width="507" height="260" referrerpolicy="no-referrer"></p>
<p>我们发现商家的小票和美团的订单信息之间有不少的差异，特别是优惠的明细展示以及优惠总额和应付总额之间存在差异；下面我们就来顺藤摸瓜，分析背后的玄机。</p>
<p><img data-action="zoom" class="rich_pages aligncenter" title="一张小票看透支付清结算架构" src="https://cors.zfour.workers.dev/?http://image.woshipm.com/wp-files/2021/05/NkPJwkpdHa2dNlohzRtq.png" alt="一张小票看透支付清结算架构" referrerpolicy="no-referrer"></p>
<p>我们先认清一个关系，订外卖的陈老师跟商家没有直接的关系，美团跟商家直接是结算关系，也就是美团帮助商家代收餐费，并进行结算；简而言之就是陈老师付给美团综合的外卖钱，美团抽一部分然后给商家结算餐费。</p>
<p>我们先粗略的假想一下，这个过程是怎么完成的。</p>
<ol>
<li>我们先到美团平台选择喜欢的“商品”；</li>
<li>然后“下单”并生成交易“账单”；</li>
<li>选择支付方式进行“支付”；</li>
<li>支付成功后美团要履行承诺把餐送到“履约”；</li>
<li>完成以后美团就开始进行各方利益的“清分”计算了；</li>
<li>算清楚应给给各方多少钱时并计入账簿“记账”；</li>
<li>然后就是进行“结算”。</li>
</ol>
<p><img data-action="zoom" class="rich_pages aligncenter" title="一张小票看透支付清结算架构" src="https://cors.zfour.workers.dev/?http://image.woshipm.com/wp-files/2021/05/9Q6vwOrKXvmhZkdyPEay.png" alt="一张小票看透支付清结算架构" width="783" height="69" referrerpolicy="no-referrer"></p>
<p>按照这个思路，我们来看，上面的小票在每个环节都是怎么处理的呢？</p>
<h2 id="toc-2">二、商品</h2>
<p>商品广泛用于电商系，在O2O领域我们可能叫“服务”多一点，这里其实站在吃货的角度来看，订外卖，买了一份商品也没什么问题。商品模型这里我们不过多介绍，简而言之就是下面这样一个高度抽象的结构：</p>
<p><img data-action="zoom" class="rich_pages aligncenter" title="一张小票看透支付清结算架构" src="https://cors.zfour.workers.dev/?http://image.woshipm.com/wp-files/2021/05/Yd16YW8xC9SrQto0Vcql.png" alt="一张小票看透支付清结算架构" width="563" height="200" referrerpolicy="no-referrer"></p>
<p>那么这一单外卖的商品有哪些呢，有4个（这里我们将配送服务看做商品）：</p>
<p><img data-action="zoom" class="rich_pages aligncenter" title="一张小票看透支付清结算架构" src="https://cors.zfour.workers.dev/?http://image.woshipm.com/wp-files/2021/05/4QH9k2NAvpabPv0XT3cX.png" alt="一张小票看透支付清结算架构" width="395" height="213" referrerpolicy="no-referrer"></p>
<p>这里我们要说一下美团会员，这是美团推出的一个会员服务，相当于花钱买了多张优惠券，所以购买美团会员获得优惠券也是一次交易。而且本交易要先与外卖单，因为外卖单的支付用到了这批券，交易层处理很有意思，大家可以思考一下。</p>
<p><img data-action="zoom" class="rich_pages aligncenter" title="一张小票看透支付清结算架构" src="https://cors.zfour.workers.dev/?http://image.woshipm.com/wp-files/2021/05/Q2YXqUinEXXsgne18hid.png" alt="一张小票看透支付清结算架构" width="389" height="158" referrerpolicy="no-referrer"></p>
<h2 id="toc-3">三、订单</h2>
<p>选购好了商品，那么就需要下单了，这时候订单会去营销系统获取可以使用的活动优惠或者卡券，本小票我们可以看出来，有这些优惠我们可以使用：</p>
<p><img data-action="zoom" class="rich_pages aligncenter" title="一张小票看透支付清结算架构" src="https://cors.zfour.workers.dev/?http://image.woshipm.com/wp-files/2021/05/NUzlX5sgufMY3J7H6cZX.png" alt="一张小票看透支付清结算架构" width="300" height="245" referrerpolicy="no-referrer"></p>
<p>因为目前我们还不清楚美团和商家之间的清结算协议，所以暂且认为所有优惠由美团提供给用户，后续美团再基于协议跟商家之间做优惠的分摊，这部分不是本文的重点，大家可以私下思考交流。</p>
<p>这样我们就得到了订单信息了：</p>
<p><img data-action="zoom" class="rich_pages aligncenter" title="一张小票看透支付清结算架构" src="https://cors.zfour.workers.dev/?http://image.woshipm.com/wp-files/2021/05/8IryVt91zxRiwwjx4oEa.png" alt="一张小票看透支付清结算架构" width="355" height="308" referrerpolicy="no-referrer"></p>
<p>其实我们发现，其中的美团红包是基于15元购买了优惠券以后才能使用的优惠，相当于这一单，你要先买会员获得优惠券，然后在本单同时使用优惠券进行优惠。</p>
<p>虽然是同一个订单，但我们可以想象出来，在交易处理层，至少需要做2次处理，一个是对美团会员的处理，另一个是对本单整单的优惠处理。所以订单需要拆成2个子单，一个是外卖单，一个是美团会员单。</p>
<p><img data-action="zoom" class="rich_pages aligncenter" title="一张小票看透支付清结算架构" src="https://cors.zfour.workers.dev/?http://image.woshipm.com/wp-files/2021/05/hzdKTpyjK43YIpjb1RKO.png" alt="一张小票看透支付清结算架构" width="420" height="144" referrerpolicy="no-referrer"></p>
<p>我们看到商家的小票，商品总价是40，总优惠是19；跟订单11101之间的7元差额是什么呢，其实就是配送费。那么将配送费抛出后跟商家小票一致，我们可以推断出商家承担了5元的配送优惠成本，加上满减优惠14，商家总优惠成本是19。</p>
<p>但最后我们发现商家实收17元，那么这4元是什么呢？其实我们有2个推断，一是美团抽佣4元，另一个可能是商家承担美团红包7元优惠中的4元；如果是取中间可能的话那么实际可能是：</p>
<ul>
<li>4元=x+y；</li>
<li>x=美团抽佣；x属于[0-4]元；</li>
<li>y=分摊美团红包优惠；y属于[0-4]元。</li>
</ul>
<h2 id="toc-4">四、交易</h2>
<p>完成了订单以后就需要创建支付账单了，基于以上分析交易处理是非常复杂的，因为要先处理美团会员的购买，然后处理外卖订单。</p>
<p><img data-action="zoom" class="rich_pages aligncenter" title="一张小票看透支付清结算架构" src="https://cors.zfour.workers.dev/?http://image.woshipm.com/wp-files/2021/05/FFdvmbXLtuYnWPKjdsk0.png" alt="一张小票看透支付清结算架构" width="443" height="212" referrerpolicy="no-referrer"></p>
<p>这里因为有2个子单，所以我们生成2个交易账单，但是在支付的时候我们进行合并支付。</p>
<p><img data-action="zoom" class="rich_pages aligncenter" title="一张小票看透支付清结算架构" src="https://cors.zfour.workers.dev/?http://image.woshipm.com/wp-files/2021/05/S1yagKBBE4v87QaSzcfq.png" alt="一张小票看透支付清结算架构" width="433" height="173" referrerpolicy="no-referrer"></p>
<p>基于账单生成支付请求。</p>
<p><img data-action="zoom" class="rich_pages aligncenter" title="一张小票看透支付清结算架构" src="https://cors.zfour.workers.dev/?http://image.woshipm.com/wp-files/2021/05/SQ4LifWRmrgsobqKaHGN.png" alt="一张小票看透支付清结算架构" width="417" height="277" referrerpolicy="no-referrer"></p>
<h2 id="toc-5">五、支付</h2>
<p>账单生成以后，我们进行支付处理。微信支付请求支付系统，优惠类支付我们等待微信支付成功以后请求营销系统，完成优惠券的核销，这样我们就完成了账单的支付了。这时候账单变为已支付，订单支付状态变为已支付，订单状态变为待配送。</p>
<p><img data-action="zoom" class="rich_pages aligncenter" title="一张小票看透支付清结算架构" src="https://cors.zfour.workers.dev/?http://image.woshipm.com/wp-files/2021/05/r1W02xUH6irROcumDcM5.png" alt="一张小票看透支付清结算架构" width="412" height="192" referrerpolicy="no-referrer"></p>
<h2 id="toc-6">六、履约</h2>
<p>订单变为待配送时，会生成服务订单，也就是配送订单，由骑手小王01抢单了。</p>
<p><img data-action="zoom" class="rich_pages aligncenter" title="一张小票看透支付清结算架构" src="https://cors.zfour.workers.dev/?http://image.woshipm.com/wp-files/2021/05/gGJ71zEoJTMU3czrvaCn.png" alt="一张小票看透支付清结算架构" width="460" height="77" referrerpolicy="no-referrer"></p>
<p>然后的过程大家都熟悉，取了餐、送餐、确认已送达、服务单完成，将订单推送至清算中心进行清分计算。</p>
<h2 id="toc-7">七、清算</h2>
<p>清算系统接收到的清算订单信息包含，订单信息、账单信息、支付信息、履约信息。</p>
<p><img data-action="zoom" class="rich_pages aligncenter" title="一张小票看透支付清结算架构" src="https://cors.zfour.workers.dev/?http://image.woshipm.com/wp-files/2021/05/mY9by2NrCpcAUs9pnmFW.png" alt="一张小票看透支付清结算架构" width="433" height="375" referrerpolicy="no-referrer"></p>
<p><img data-action="zoom" class="rich_pages aligncenter" title="一张小票看透支付清结算架构" src="https://cors.zfour.workers.dev/?http://image.woshipm.com/wp-files/2021/05/sTkzZoG7R3UxBQxeqmlD.png" alt="一张小票看透支付清结算架构" width="435" height="289" referrerpolicy="no-referrer"></p>
<p><img data-action="zoom" class="rich_pages aligncenter" title="一张小票看透支付清结算架构" src="https://cors.zfour.workers.dev/?http://image.woshipm.com/wp-files/2021/05/Gc9MoamRIpncakNfNhrH.png" alt="一张小票看透支付清结算架构" width="433" height="202" referrerpolicy="no-referrer"></p>
<p><img data-action="zoom" class="rich_pages aligncenter" title="一张小票看透支付清结算架构" src="https://cors.zfour.workers.dev/?http://image.woshipm.com/wp-files/2021/05/iH3QbVmwZQKLD2Hppl2g.png" alt="一张小票看透支付清结算架构" width="436" height="73" referrerpolicy="no-referrer"></p>
<p>在清分计费环节有几个关键的模块，我们可以设定为一下模型：</p>
<p><img data-action="zoom" class="rich_pages aligncenter" title="一张小票看透支付清结算架构" src="https://cors.zfour.workers.dev/?http://image.woshipm.com/wp-files/2021/05/g90pkWfTfBgWudolf5EH.png" alt="一张小票看透支付清结算架构" width="433" height="307" referrerpolicy="no-referrer"></p>
<p>计费模型就是，基于订单业务我们就知道应该计算出什么样的费用出来，比如本单其实有2个业务，一个是外卖业务，一个是美团会员业务。</p>
<p>我们假设有计费模型是这样的，美团外卖业务需要计算商家应结算金额、抽佣金额、优惠分摊金额；美团会员计费模型需要计算出美团会员费给平台业务的分成，那么简单起见我们的模型如下：</p>
<p><img data-action="zoom" class="rich_pages aligncenter" title="一张小票看透支付清结算架构" src="https://cors.zfour.workers.dev/?http://image.woshipm.com/wp-files/2021/05/XTn4tJhxrBLT0JDMwooS.png" alt="一张小票看透支付清结算架构" width="430" height="159" referrerpolicy="no-referrer"></p>
<p>我们再基于业务类型，去查找计费规则。什么是计费规则呢？就是计费参数、计费基数、计费模式、计费规则；我们设定规则如下：</p>
<p><img data-action="zoom" class="rich_pages aligncenter" title="一张小票看透支付清结算架构" src="https://cors.zfour.workers.dev/?http://image.woshipm.com/wp-files/2021/05/sm1HlQqpVm0Os8kPtj9F.png" alt="一张小票看透支付清结算架构" width="466" height="126" referrerpolicy="no-referrer"></p>
<p>那么计费规则，我们可以计算出以下清分结果：</p>
<p><img data-action="zoom" class="rich_pages aligncenter" title="一张小票看透支付清结算架构" src="https://cors.zfour.workers.dev/?http://image.woshipm.com/wp-files/2021/05/UTlMq6N4NguNMk6VD1OE.png" alt="一张小票看透支付清结算架构" width="465" height="125" referrerpolicy="no-referrer"></p>
<p>所以我们得到以下清分结果：</p>
<p><img data-action="zoom" class="rich_pages aligncenter" title="一张小票看透支付清结算架构" src="https://cors.zfour.workers.dev/?http://image.woshipm.com/wp-files/2021/05/iEQ9p4WCdwDY64pFUYbo.png" alt="一张小票看透支付清结算架构" width="465" height="190" referrerpolicy="no-referrer"></p>
<p>剩下的就是优惠成本的分摊了。</p>
<p><img data-action="zoom" class="rich_pages aligncenter" title="一张小票看透支付清结算架构" src="https://cors.zfour.workers.dev/?http://image.woshipm.com/wp-files/2021/05/mcI36EPMNK9GPNaIxX6P.png" alt="一张小票看透支付清结算架构" width="464" height="130" referrerpolicy="no-referrer"></p>
<h2 id="toc-8">八、账务</h2>
<p>完成清分计费以后就需要请求账务系统完成记账了，为了简单我们只对商家的结算和骑手的结算进行记账；这时先生成账务记录：</p>
<p><img data-action="zoom" class="rich_pages aligncenter" title="一张小票看透支付清结算架构" src="https://cors.zfour.workers.dev/?http://image.woshipm.com/wp-files/2021/05/ehznsH99HVYglFgJVQjQ.png" alt="一张小票看透支付清结算架构" width="466" height="101" referrerpolicy="no-referrer"></p>
<p>账务流水去操作账户更新余额，这部分内容大家可以看《<a href="http://www.woshipm.com/pd/4420513.html">账户系统设计从入门到精通</a>》。</p>
<p><img data-action="zoom" class="rich_pages aligncenter" title="一张小票看透支付清结算架构" src="https://cors.zfour.workers.dev/?http://image.woshipm.com/wp-files/2021/05/wEPS4bjgygeZ3SLYBG1m.png" alt="一张小票看透支付清结算架构" width="463" height="101" referrerpolicy="no-referrer"></p>
<p>入账成功后账户余额变为：</p>
<p><img data-action="zoom" class="rich_pages aligncenter" title="一张小票看透支付清结算架构" src="https://cors.zfour.workers.dev/?http://image.woshipm.com/wp-files/2021/05/tmgxf4h6DFTV52hWqWyg.png" alt="一张小票看透支付清结算架构" width="467" height="98" referrerpolicy="no-referrer"></p>
<h2 id="toc-9">九、结算</h2>
<p>商家和骑手都可以在钱包里看到账户里入账了，然后可以对余额发起提现；生成提现订单，请求打款中心完成出款，这个我们就不详细介绍了。</p>
<h2 id="toc-10">十、这里涉及到的各个系统</h2>
<p>这里面涉及到了11个系统，我们之前都有文章详细介绍过：</p>
<p>《<a href="http://www.woshipm.com/pd/4422465.html">详解 | 支付收银台前端设计</a>》、《<a href="http://www.woshipm.com/pd/4422921.html">详解：支付路由设计</a>》、《<a href="http://www.woshipm.com/pd/4435342.html">聊聊支付通道那些事儿——介绍和接入</a>》、《订单系统设计解析》、《<a href="http://www.woshipm.com/pd/4438208.html">详解 | 关于交易的核心设计指南</a>》、《<a href="http://www.woshipm.com/pd/4420513.html">账户系统设计从入门到精通</a>》、《<a href="http://www.woshipm.com/pd/4391371.html">详解 | 结算系统设计</a>》、《<a href="http://www.woshipm.com/pd/4427117.html">对账系统从入门到精通</a>》。</p>
<h2 id="toc-11">十一、综合架构</h2>
<p>从上面的案例，并结合之前的一些文章，我们抽象出一个清结算的通用架构，我们称之为“311架构模型”，即分3层、11个系统，所以叫311架构模型。大家记住这个架构，基本可以解决绝大部分平台的订单支付交易清结算业务模型。</p>
<p><img data-action="zoom" class="rich_pages aligncenter" title="一张小票看透支付清结算架构" src="https://cors.zfour.workers.dev/?http://image.woshipm.com/wp-files/2021/05/F7oJyWTNIzFs1hJdC7sa.png" alt="一张小票看透支付清结算架构" width="569" height="266" referrerpolicy="no-referrer"></p>
<h2 id="toc-12">十二、思考题</h2>
<p>这张打车小票，司机手机的结算信息与用户订单的结算信息，你能想象出来系统层的实现方式以及业务流转么？用户、滴滴、司机三者之间的清结算结果是怎么样的呢？滴滴这一单是挣钱了还是赔钱了呢？</p>
<p><img data-action="zoom" class="rich_pages aligncenter" title="一张小票看透支付清结算架构" src="https://cors.zfour.workers.dev/?http://image.woshipm.com/wp-files/2021/05/GcneiXXG2Yh9QjM10WaH.png" alt="一张小票看透支付清结算架构" width="486" height="359" referrerpolicy="no-referrer"></p>
<p>声明：以上内容均为案例讲解设定、推测，并非美团真实系统设计，请悉知。</p>
<h3>#专栏作家#</h3>
<p>陈天宇宙，微信公众号：陈晓光，人人都是产品经理专栏作家。10年产品设计经验，曾任职于某头部金融，某头部支付机构，云对账创始人获千万融资。</p>
<p>本文原创发布于人人都是产品经理。未经许可，禁止转载</p>
<p>题图来自Unsplash，基于CC0协议</p>
<div class="support-author"><div class="support-title">给作者打赏，鼓励TA抓紧创作！</div><button class="button--pay" data-post-id="4563219" data-author="94217" data-avatar="http://image.woshipm.com/wp-files/2021/02/a84xkWDMu44P1PnVp06z.jpeg"><svg width="13" height="16" class="svgIcon--use" viewBox="0 0 13 16"><path d="M9.113,4.571 C9.951,3.771 10.895,2.742 10.685,2.057 C10.475,1.485 10.056,0.799 9.427,0.571 C8.903,0.342 8.379,0.456 7.750,0.799 C7.540,0.342 7.016,0.114 6.596,-0.001 C5.863,-0.001 5.234,0.228 4.814,0.914 C4.080,0.571 3.451,0.685 2.927,1.028 C2.613,1.256 2.298,1.713 2.298,2.628 C2.298,3.542 3.137,4.228 3.766,4.685 C2.508,5.599 -0.218,7.885 -0.008,12.228 C-0.218,15.656 2.613,15.999 2.613,15.999 L10.371,15.999 C11.314,15.885 12.991,14.971 12.991,12.571 L12.991,12.228 C13.201,7.771 10.371,5.371 9.113,4.571 L9.113,4.571 ZM8.932,11.835 L6.940,11.835 L6.940,13.207 C6.940,13.435 6.731,13.549 6.521,13.549 C6.311,13.549 6.102,13.435 6.102,13.207 L6.102,11.835 L4.110,11.835 C3.900,11.835 3.795,11.606 3.795,11.378 C3.795,11.149 3.900,10.921 4.110,10.921 L6.102,10.921 L6.102,10.121 L4.949,10.121 C4.739,10.121 4.634,9.892 4.634,9.664 C4.634,9.435 4.739,9.206 4.949,9.206 L5.892,9.206 L4.739,7.950 C4.634,7.835 4.739,7.606 4.949,7.492 C5.158,7.378 5.368,7.264 5.473,7.378 L6.521,8.635 L7.674,7.264 C7.779,7.149 7.989,7.264 8.198,7.378 C8.408,7.492 8.408,7.721 8.408,7.835 L7.150,9.321 L8.094,9.321 C8.303,9.321 8.408,9.549 8.408,9.778 C8.408,10.007 8.303,10.235 8.094,10.235 L6.940,10.235 L6.940,11.035 L8.932,11.035 C9.142,11.035 9.247,11.264 9.247,11.493 C9.247,11.606 9.037,11.835 8.932,11.835 L8.932,11.835 Z"/></svg>
赞赏</button></div>                      
</div>
            