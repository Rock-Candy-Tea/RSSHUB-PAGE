
---
title: 'B站自曝去年服务器大崩溃原因，就因为这？'
categories: 
 - 新媒体
 - ZAKER
 - channel
headimg: 'https://cors.zfour.workers.dev/?http://zkres1.myzaker.com/202207/62d6d8f0b15ec07ae9611ea0_1024.jpg'
author: ZAKER
comments: false
date: Tue, 19 Jul 2022 08:47:30 GMT
thumbnail: 'https://cors.zfour.workers.dev/?http://zkres1.myzaker.com/202207/62d6d8f0b15ec07ae9611ea0_1024.jpg'
---

<div>   
<p>不知道差友们还记不记得，去年的 7 月 13 日，B 站发生了一件大事。</p><p>它毫无征兆的崩了。。。（ 如果忘了的小伙伴，可以看 这篇文章 ）</p><p></p><div class="img_box" id="id_imagebox_0" onclick><div class="content_img_div perview_img_div"><img class="lazy opacity_0 " id="img_0" data-original="http://zkres1.myzaker.com/202207/62d6d8f0b15ec07ae9611ea0_1024.jpg" data-height="477" data-width="548" src="https://cors.zfour.workers.dev/?http://zkres1.myzaker.com/202207/62d6d8f0b15ec07ae9611ea0_1024.jpg" referrerpolicy="no-referrer"></div></div>至于为啥崩了，当时大家谁也心里没个底。<p></p><p>不过吹起水来可是一套一套的，什么停电啊，起火啊，程序员 rm -rf /* 跑路啊。。。</p><p>说的是个天马行空。</p><p></p><div class="img_box" id="id_imagebox_1" onclick><div class="content_img_div perview_img_div"><img class="lazy opacity_0 " id="img_1" data-original="http://zkres1.myzaker.com/202207/62d6d8f0b15ec07ae9611ea2_1024.jpg" data-height="630" data-width="1080" src="https://cors.zfour.workers.dev/?http://zkres1.myzaker.com/202207/62d6d8f0b15ec07ae9611ea2_1024.jpg" referrerpolicy="no-referrer"></div></div>后来呢，随着 B 站在凌晨两点一顿修仙，把服务器问题给慢慢解决，这件事情也算是告一段落了。<p></p><p></p><div class="img_box" id="id_imagebox_2" onclick><div class="content_img_div perview_img_div"><img class="lazy opacity_0 " id="img_2" data-original="http://zkres2.myzaker.com/202207/62d6d8f0b15ec07ae9611ea3_1024.jpg" data-height="165" data-width="824" src="https://cors.zfour.workers.dev/?http://zkres2.myzaker.com/202207/62d6d8f0b15ec07ae9611ea3_1024.jpg" referrerpolicy="no-referrer"></div></div>本以为这次 B 站崩了会和微博上无数崩了的网站一样，成为我们冲浪生活中的一个笑谈，仅留下一个大会员给我们 " 缅怀 "。<p></p><p></p><div class="img_box" id="id_imagebox_3" onclick><div class="content_img_div perview_img_div"><img class="lazy opacity_0 " id="img_3" data-original="http://zkres2.myzaker.com/202207/62d6d8f0b15ec07ae9611ea4_1024.jpg" data-height="389" data-width="671" src="https://cors.zfour.workers.dev/?http://zkres2.myzaker.com/202207/62d6d8f0b15ec07ae9611ea4_1024.jpg" referrerpolicy="no-referrer"></div></div>没想到在今年的 7 月 13 日，B 站特意发了一篇文章，刨开心窝子来给我们讲了一讲，那个晚上，到底发生了什么。<p></p><p></p><div class="img_box" id="id_imagebox_4" onclick><div class="content_img_div perview_img_div"><img class="lazy opacity_0 " id="img_4" data-original="http://zkres1.myzaker.com/202207/62d6d8f0b15ec07ae9611ea5_1024.jpg" data-height="199" data-width="486" src="https://cors.zfour.workers.dev/?http://zkres1.myzaker.com/202207/62d6d8f0b15ec07ae9611ea5_1024.jpg" referrerpolicy="no-referrer"></div></div>咱也看了一下这篇文章，好家伙，让整个 B 站崩溃的原因，<strong>竟然只是一行代码没写好？？？</strong><p></p><p>借着这篇文章，世超准备带大家从 <strong>B 站的角度</strong>来回顾一下这件事情。</p><p>放心，不会有生涩难懂的名词，不会有犀利糊涂的黑话，保证小白也能看明白。</p><p><b><strong> </strong><strong> 案情回溯</strong><strong>： </strong></b></p><p>意外，发生在 2021 年 7 月 13 日的 22 时 52 分。</p><p>负责搞定站点<strong>可靠性的工程师</strong><strong>（</strong><strong>SRE</strong><strong>）</strong>和 B 站的客服都收到了大量网站打不开的报警。</p><p></p><div class="img_box" id="id_imagebox_5" onclick><div class="content_img_div perview_img_div"><img class="lazy opacity_0 " id="img_5" data-original="http://zkres2.myzaker.com/202207/62d6d8f0b15ec07ae9611ea6_1024.jpg" data-height="266" data-width="462" src="https://cors.zfour.workers.dev/?http://zkres2.myzaker.com/202207/62d6d8f0b15ec07ae9611ea6_1024.jpg" referrerpolicy="no-referrer"></div></div>而负责处理这些事故的同事已经下班了，当即准备在家里通过 VPN 来登录公司内网处理这些问题。<p></p><p><strong>结果发现</strong><strong>VPN</strong><strong> 也崩了。。。压根进不去系统。</strong></p><p>最后，还是在公司的整了个 " 绿色通道 " 才成功进去。</p><p><strong>你说这绿色通道不会是向日葵吧（一种远程桌面软件） </strong>▼</p><p></p><div class="img_box" id="id_imagebox_6" onclick><div class="content_img_div perview_img_div"><img class="lazy opacity_0 " id="img_6" data-original="http://zkres1.myzaker.com/202207/62d6d8f0b15ec07ae9611ea8_1024.jpg" data-height="475" data-width="464" src="https://cors.zfour.workers.dev/?http://zkres1.myzaker.com/202207/62d6d8f0b15ec07ae9611ea8_1024.jpg" referrerpolicy="no-referrer"></div></div>而在绿色通道成功打通，负责各种业务的团队就位之后，B 站也开始对问题进行分析定位。<p></p><p>出问题的模块也很明显，在线业务主机房的 7 层 SLB<strong>（</strong><strong>负载均衡</strong><strong>服务器，用来处理多用户，多业务的情况）</strong>的 CPU 跑满了 100%。</p><p><strong>简单来说，就是 CPU 被不知道哪里来的刺客给占用光了算力，没法处理业务了。</strong></p><p><strong>系统未响应 .exe ▼</strong></p><p></p><div class="img_box" id="id_imagebox_7" onclick><div class="content_img_div perview_img_div"><img class="lazy opacity_0 " id="img_7" data-original="http://zkres2.myzaker.com/202207/62d6d8f0b15ec07ae9611ea9_1024.jpg" data-height="802" data-width="881" src="https://cors.zfour.workers.dev/?http://zkres2.myzaker.com/202207/62d6d8f0b15ec07ae9611ea9_1024.jpg" referrerpolicy="no-referrer"></div></div>B 站最开始的尝试方法呢，和咱们平时手机电脑卡机后做的操作一样。<p></p><p><strong>重启就完事了，要相信重启能解决 90% 的问题！</strong></p><p></p><div class="img_box" id="id_imagebox_8" onclick><div class="content_img_div perview_img_div"><img class="lazy opacity_0 " id="img_8" data-original="http://zkres1.myzaker.com/202207/62d6d8f0b15ec07ae9611eaa_1024.jpg" data-height="116" data-width="472" src="https://cors.zfour.workers.dev/?http://zkres1.myzaker.com/202207/62d6d8f0b15ec07ae9611eaa_1024.jpg" referrerpolicy="no-referrer"></div></div>但很可惜，B 站这次是那个 10.5%。<p></p><p>说业务恢复了嘛，也没有，主机房重启后还是出现了 CPU 跑满 100% 的问题。</p><p>不过别的机房好起来了，虽然会卡，<strong>但是没出现 CPU 跑满的问题。</strong></p><p></p><div class="img_box" id="id_imagebox_9" onclick><div class="content_img_div perview_img_div"><img class="lazy opacity_0 " id="img_9" data-original="http://zkres2.myzaker.com/202207/62d6d8f0b15ec07ae9611eab_1024.jpg" data-height="332" data-width="459" src="https://cors.zfour.workers.dev/?http://zkres2.myzaker.com/202207/62d6d8f0b15ec07ae9611eab_1024.jpg" referrerpolicy="no-referrer"></div></div>有一部分做了多活的业务（多站点同时提供服务）开始慢慢恢复。<p></p><p>所以。。。重启不能完全解决问题，但是这个问题<strong>既然过去没出现过</strong>。</p><p><strong>那会不会是新加入的代码问题呢？</strong></p><p>随着时间在一分一秒的过去，借助分析工具的帮助，问题被定位到了最近新上线的 Lua ( 一种编程语言，类似 Python，Java 这些 ) 函数上。</p><p>随后，B 站开始进行了一波波紧张的回滚操作。</p><p></p><div class="img_box" id="id_imagebox_10" onclick><div class="content_img_div perview_img_div"><img class="lazy opacity_0 " id="img_10" data-original="http://zkres1.myzaker.com/202207/62d6d8f0b15ec07ae9611eac_1024.jpg" data-height="393" data-width="465" src="https://cors.zfour.workers.dev/?http://zkres1.myzaker.com/202207/62d6d8f0b15ec07ae9611eac_1024.jpg" referrerpolicy="no-referrer"></div></div>这一通工作弄下来，<strong>虽然好像找到几个疑似出问题的部位</strong>，但服务器还是该挂挂，距离 " 康复 " 还有那么一些距离。<p></p><p><strong>没办法，总得让业务先跑起来吧。</strong></p><p>于是团队开始兵分两路。</p><p>一队继续坚持排查问题，寻找原因，另一队则是开始重建一个新的 SLB 服务。</p><p>在紧张刺激的一小时后，新的 SLB 配置成功，原本导向主站的流量也慢慢的开始迁移过去。</p><p></p><div class="img_box" id="id_imagebox_11" onclick><div class="content_img_div perview_img_div"><img class="lazy opacity_0 " id="img_11" data-original="http://zkres1.myzaker.com/202207/62d6d8f0b15ec07ae9611ead_1024.jpg" data-height="415" data-width="459" src="https://cors.zfour.workers.dev/?http://zkres1.myzaker.com/202207/62d6d8f0b15ec07ae9611ead_1024.jpg" referrerpolicy="no-referrer"></div></div>好在这次行了。<p></p><p>凌晨两点，在崩溃了三小时之后，B 站的业务总算得到了恢复。</p><p><b></b></p><p><b></b></p><p><b><strong> </strong><strong> 罪魁祸首</strong><strong>： </strong></b></p><p>上面这些，就是那个晚上 B 站发生的故事，虽然解决了表面问题，让业务恢复了。</p><p><strong>可是最根本的原因是啥呢？</strong></p><p>如果不找到根因，那迟早会二度暴雷。</p><p>负责排查问题的同学也没让人失望，在时间压力大大放缓之后，<strong>找出了真相。</strong></p><p>没有外星人，没有起火，没有断电，和网友们想象的大相径庭。</p><p><strong>B 站这次崩的根因，仅仅是因为一个求最大公约数的函数没写好。。。</strong></p><p></p><div class="img_box" id="id_imagebox_12" onclick><div class="content_img_div perview_img_div"><img class="lazy opacity_0 " id="img_12" data-original="http://zkres1.myzaker.com/202207/62d6d8f0b15ec07ae9611eae_1024.jpg" data-height="298" data-width="438" src="https://cors.zfour.workers.dev/?http://zkres1.myzaker.com/202207/62d6d8f0b15ec07ae9611eae_1024.jpg" referrerpolicy="no-referrer"></div></div>咱先盘一下这个 " 万恶之源 " 哈。<p></p><p><strong>这是一个典型的 " 自己调用自己 " 的递归函数。</strong></p><p>a b 两数字辗转求余，直到<strong> b 等于 0</strong> 的时候函数终止。</p><p><strong>不然这个函数就会自己调用自己，重新再跑一遍。</strong></p><p>看上去好像是一点点问题都没有，既明确了递归的终止条件（b = 0），也没有太多复杂的逻辑处理。</p><p><strong>但是既然事情能发展到这地步。。。那就说明是出大问题了。</strong></p><p>对编程有些了解的差友可能发现了不对：</p><p>你传进去的 0，是个什么 0？</p><p>没错，在编程语言里，<strong>数字 0 和字符串 ‘ 0 ’ 并不算是一个东西。</strong></p><p>为了防止呆呆的计算机语言把事情给搞混，像 C 语言，Java 这些静态语言都会要求我们在创建新变量的时候<strong>声明这个变量的类型。</strong></p><p>搞清楚它到底是整数，还是小数，或者是一个字符。</p><p><strong>然而 Lua 是个非常智慧的语言，它没有这个要求。</strong></p><p>麻烦的脏活累活让它自动来做就好了，Lua 会根据<strong>程序的需求自动分配变量类型。</strong></p><p><strong></strong></p><p>C 语言示例：</p><p># 定义一个整型数据 a，为它赋值 1</p><p># 定义一个字符串数据 b，为它赋值‘ 1 ’</p><p>int a = 0;</p><p>char a = '0';</p><p>Lua 示例：</p><p>-- 定义 a 为数字 0，b 为字符串‘ 0 ’</p><p>a = 0</p><p>b = '0'</p><p>所以，我们给参数 b 传进去的数值，是<strong>数字 0 </strong>呢，还是<strong>字符 ‘ 0 ’ </strong>？</p><p>一旦前面数据验证没把好关，在执行某个功能的时候，把<strong>字符 ‘ 0 ’ </strong>给传到了这个函数里。</p><p>地雷就被引爆了。</p><p><strong>字符串 <strong>‘</strong> 0 <strong>’</strong> 不会等于数字 0，函数的终止条件判断不通过。</strong></p><p>所以程序进入递归模式，再次调用自己。</p><p>在后续进行求余预算的时候，Lua 的 " 智慧 " 又突然起到了作用。</p><p>Lua 一拍脑袋，咋会有人把字符 ‘ 0 ’ 拿来做计算啊，肯定是想把这个参数当数字用。</p><p></p><div class="img_box" id="id_imagebox_13" onclick><div class="content_img_div perview_img_div"><img class="lazy opacity_0 " id="img_13" data-original="http://zkres1.myzaker.com/202207/62d6d8f1b15ec07ae9611eb1_1024.jpg" data-height="766" data-width="600" src="https://cors.zfour.workers.dev/?http://zkres1.myzaker.com/202207/62d6d8f1b15ec07ae9611eb1_1024.jpg" referrerpolicy="no-referrer"></div></div>于是发生了强制类型转换。<p></p><p>所以咱们小学数学都会学到的。。。 <strong>把 0 当除数的事情就发生了。</strong></p><p>这要是古老的大哥 C 语言来干这活，可能直接就给一个 Floating point exception 报错了。</p><p>但是 Lua 不一样，作为一个新时代的 " 智慧 " 的语言，它会优雅的返回一个 nan （Not A Numbewr）。</p><p><strong>程序，继续运行。</strong></p><p>更要命的是，nan 也不会等于 0。。。<strong>程序的终止条件无法实现。</strong></p><p>这样跑几个循环之后，原本用来计算 a 和 b 的最大公约数的函数 _gcd ( a,b ) 就变成了一个停不下来的函数 _gcd ( nan,nan ) 。</p><p><strong>在停不下来的路上根本停不下来，直接把 CPU 资源给吃满了。</strong></p><p></p><div class="img_box" id="id_imagebox_14" onclick><div class="content_img_div perview_img_div"><img class="lazy opacity_0 " id="img_14" data-original="http://zkres2.myzaker.com/202207/62d6d8f1b15ec07ae9611eb3_1024.jpg" data-height="330" data-width="674" src="https://cors.zfour.workers.dev/?http://zkres2.myzaker.com/202207/62d6d8f1b15ec07ae9611eb3_1024.jpg" referrerpolicy="no-referrer"></div></div>太聪明也不是一件好事啊。。。<p></p><p>就这样<strong>，被占满的 CPU 一口气把别的业务也带崩了</strong>。</p><p>还得前面提到的在家的 B 站程序员没法在家通过 VPN 来抢救网络么？</p><p>没错，他们登录内网的时候，其中有部分服务也需要通过内网来处理。。。</p><p></p><div class="img_box" id="id_imagebox_15" onclick><div class="content_img_div perview_img_div"><img class="lazy opacity_0 " id="img_15" data-original="http://zkres1.myzaker.com/202207/62d6d8f1b15ec07ae9611eb4_1024.jpg" data-height="310" data-width="472" src="https://cors.zfour.workers.dev/?http://zkres1.myzaker.com/202207/62d6d8f1b15ec07ae9611eb4_1024.jpg" referrerpolicy="no-referrer"></div></div>属于是把钥匙断锁眼里，也是崩的理所当然了。<p></p><p><b><strong> </strong><strong> 崩完之后</strong><strong>： </strong></b></p><p>最后，如果差友们对相关技术细节更感兴趣的话，世超建议你看看 B 站发布的这篇 2021.07.13 我们是这样崩的</p><p>除了对事故的起承转合，还对未来技术的更进与反思都做了更加专业，全面的总结。</p><p>讲道理，这样的机会其实挺难得的。</p><p>每年崩了的应用何其多，<strong>但是愿意发出来给同行学习，给普罗大众看个乐子的寥寥无几。</strong></p><p><strong></strong></p><p><strong>向上滑动 ▼</strong></p><p></p><div class="img_box" id="id_imagebox_16" onclick><div class="content_img_div perview_img_div"><img class="lazy opacity_0 " id="img_16" data-original="http://zkres2.myzaker.com/202207/62d6d8f1b15ec07ae9611eb5_1024.jpg" data-height="6483" data-width="1080" src="https://cors.zfour.workers.dev/?http://zkres2.myzaker.com/202207/62d6d8f1b15ec07ae9611eb5_1024.jpg" referrerpolicy="no-referrer"></div></div>B 站这次愿意分享，直面自己的 " 伤疤 " 。<p></p><p>也让我们看到了互联网运维上最真实的一面。</p><p><strong>这些经验，可不会写在任何教科书上。</strong></p><p>哦对，这篇文章发出来的晚上，B 站其实又偷偷小崩了一次。。。</p><p></p><div class="img_box" id="id_imagebox_17" onclick><div class="content_img_div perview_img_div"><img class="lazy opacity_0 " id="img_17" data-original="http://zkres2.myzaker.com/202207/62d6d8f1b15ec07ae9611eb6_1024.jpg" data-height="253" data-width="635" src="https://cors.zfour.workers.dev/?http://zkres2.myzaker.com/202207/62d6d8f1b15ec07ae9611eb6_1024.jpg" referrerpolicy="no-referrer"></div></div>不知道是不是团队好好总结了去年经验的缘故。<p></p><p>这回还没等大部分人反应过来。。。B 站已经把问题给解决了。</p><div id="recommend_bottom"></div><div id="article_bottom"></div>  
</div>
            