
---
title: '聚合支付的路由系统设计'
categories: 
 - 新媒体
 - PMCAFF
 - 今日推荐 / 精选
headimg: 'https://cors.zfour.workers.dev/?http://img.pmcaff.com/9d2e8e59289603c3bb5954e542451077-picture'
author: PMCAFF
comments: false
date: Fri, 07 Jan 2022 23:34:29 GMT
thumbnail: 'https://cors.zfour.workers.dev/?http://img.pmcaff.com/9d2e8e59289603c3bb5954e542451077-picture'
---

<div>   
<div><style>
#articleCont &#123;
  font-size: 16px;
  line-height: 1.6;
  color: #333;
  word-wrap: break-word;
&#125;
#articleCont :first-child &#123;
  margin-top: 0 !important;
&#125;
#articleCont h1,
#articleCont h2,
#articleCont h3,
#articleCont h4,
#articleCont h5,
#articleCont h6 &#123;
  margin: 40px 0 20px;
&#125;
#articleCont h1 &#123;
  font-size: 24px;
&#125;
#articleCont h2 &#123;
  font-size: 22px;
&#125;
#articleCont h3 &#123;
  font-size: 20px;
&#125;
#articleCont h4 &#123;
  font-size: 18px;
&#125;
#articleCont h5 &#123;
  font-size: 16px;
&#125;
#articleCont i &#123;
  font-style: italic;
&#125;
#articleCont p,
#articleCont div &#123;
  word-wrap: break-word;
  margin: 14px 0;
  text-align: justify;
&#125;
#articleCont blockquote &#123;
  border-left: 6px solid #ddd;
  padding: 5px 0 5px 10px;
&#125;
#articleCont blockquote p:last-child &#123;
  margin-bottom: 0;
&#125;
#articleCont .simditor-body blockquote :last-child &#123;
  margin-bottom: 0;
&#125;
#articleCont a &#123;
  color: #82b64a;
&#125;
#articleCont a:visited &#123;
  color: #82b64a;
&#125;
#articleCont a:hover &#123;
  color: #74a342;
&#125;
#articleCont img &#123;
  max-width: 100%;
  height: auto;
&#125;
#articleCont hr &#123;
  margin: 19px 0;
  border: none;
  border-top: solid 1px #ddd;
&#125;
#articleCont ol &#123;
  list-style-type: decimal;
&#125;
#articleCont ol li &#123;
  list-style-type: decimal;
&#125;
#articleCont ul &#123;
  list-style-type: disc;
  padding-left: 40px;
&#125;
#articleCont ul li &#123;
  list-style-type: disc;
&#125;
#articleCont table &#123;
  width: 100%;
  font-size: 12px;
  border-collapse: collapse;
  line-height: 1.7;
&#125;
#articleCont table thead &#123;
  background: #f9f9f9;
&#125;
#articleCont table th,
#articleCont table td &#123;
  border: solid 1px #ccc;
  text-align: left;
  vertical-align: top;
  padding: 2px 4px;
  height: 30px;
  min-width: 40px;
  box-sizing: border-box;
&#125;
#articleCont pre &#123;
  white-space: pre-wrap;
&#125;
</style><p>支付路由是金融交易中尤为重要的一个环节，已经被应用在充值、消费、提现、转账、代扣、代收、代付等交易场景中。</p><p>但是随着金融业务的不断激增，为了更好地提升用户支付体验，提高支付服务质量，并降低平台运营成本，金融企业往往会对接多个支付渠道。</p><p>能否快速选择合适的支付渠道，是金融企业最为关心的问题。</p><p>金融业务系统一般会聚合多家支付渠道，可以充分利用渠道资源提升综合服务能力，主要表现为：</p><ul><li>一方面是在支付机构侧尽可能的减少通道费用；</li><li>另一方面是在商业银行侧尽可能的获得营销费用。</li></ul><p>在钱包、收银台、充值、转账、提现、缴费、代扣等业务场景中，支付渠道提供了签约、认证、支付、撤销、退款、对账等支付功能，通过聚合支付把支付渠道的快捷支付、网银支付、虚拟支付、账户支付等支付方式进行封装，所有业务模系统的交易都通过支付路由调用，从而形成聚合支付业务架构。</p><p><img src="https://cors.zfour.workers.dev/?http://img.pmcaff.com/9d2e8e59289603c3bb5954e542451077-picture" alt="聚合支付路由系统设计" width="737" height="354" coffee-w="831px" coffee-h="399px" coffee-format="png" referrerpolicy="no-referrer"></p><h2>一、支付路由引导</h2><p>为了满足金融业务的发展需求，企业往往会对接多个支付渠道，利用支付渠道资源来达到通道最优、渠道最稳定、费用最少的目的。</p><p>用户在交易平台在进行聚合支付时，会通过收银台展示不同支付渠道的支付方式。</p><p>我们可以基于渠道稳定性、通达服务费、到账时效性、支付成功率等因素，控制支付方式的展示或优先级排序、记录最近一次支付方式，并通过营销活动引导路由。</p><p>比如在钱包充值过程中，通过聚合支付调起收银台时，会基于用户提交的充值金额、支付方式，银行卡号、手机号、商户信息等支付请求，在收银台展示微信、支付宝、云闪付、银行代扣等支付方式，用户选择支付方式并提交支付后，会调用支付系统发起支付指令，然后根据定价策略、判断引擎路由支付渠道，以便节省通道费用。</p><h2>二、支付路由规则</h2><p>支付路由作为支付系统的核心功能模块，重点是如何根据路由规则设计支付路由。</p><p>支付路由是根据用户侧、商户侧、渠道侧的各种综合因素考虑的，以便为用户提供最合适的支付渠道。</p><h3>1. 用户侧</h3><p>交易金额（单笔、阶梯价）、交易时间（工作日、自然日）、交易类型（开户、充值、转账、提现、代扣）、支付方式（微信支付、支付宝支付、云闪付支付、银行代扣）、支持交易银行、卡类型（借记卡、贷记卡、存折）等。</p><h3>2. 商户侧</h3><p>商户所属行业、商户所属城市（业务开办地区）、账户类型（个人、对公）、支持结算银行、到账实效性（D0、T+1）、结算手续费、开户成功率、交易掉单率、累计交易总额、单笔交易金额等。</p><h3>3. 渠道侧</h3><p>渠道QOS、渠道费率（单笔、阶梯价）、渠道限额（单笔、单日）、渠道类型（移动支付、在线支付、B2B支付、免密支付）、资金头寸、渠道信息、到账时效、营销费用（达标条件、优惠费率、补贴金额、活动时间）等。</p><p>比如根据支付渠道的交易限额、卡类型、到账时效性等路由规则，量化为路由调价并进行权重评分判断，根据路由评分进行支付渠道的动态优先级，然后从中筛选出有且只有一条最优支付渠道。</p><p><img src="https://cors.zfour.workers.dev/?http://img.pmcaff.com/de51a943ced8e7bee82e98049b78b14e-picture" alt="聚合支付路由系统设计" width="735" height="440" coffee-w="794px" coffee-h="475px" coffee-format="png" referrerpolicy="no-referrer"></p><h2>三、支付路由引擎</h2><p>基于路由规则构建路由引擎，路由引擎主要包括：路由规则表、路由规则集、路由规则树。</p><p>一般采用判断引擎的方式，以支持对路由规则的灵活调整。</p><h3>1. 路由规则表</h3><p>路由规则表以表格形式将路由规则抽象化，通过描述充值金额、到账时效性、银行卡类型等变量作为判断引擎的条件，然后根据用户提交的支付信息去匹配规则表的一个或多个路由规则，以便快速做出决策。</p><p><img src="https://cors.zfour.workers.dev/?http://img.pmcaff.com/dbfc4f1bce53b52317a494716153c346-picture" alt width="733" height="297" coffee-w="1054px" coffee-h="427px" coffee-format="png" referrerpolicy="no-referrer"></p><h3>2. 路由规则集</h3><p>路由规则集是支付路由中使用频率最高的一种判断引擎的实现方式。</p><p>利用判断引擎的规则设计器将交易限额、导致时效性和银行卡类型等路由规则最大限度的可视化。</p><p>在路由规则集中当条件满足时会自动执行路由动作，并给用户推荐路由渠道。</p><p><img src="https://cors.zfour.workers.dev/?http://img.pmcaff.com/9f66a775eb53a44613facadca039abe0-picture" alt="聚合支付路由系统设计" width="736" height="432" coffee-w="830px" coffee-h="487px" coffee-format="png" referrerpolicy="no-referrer"></p><h3>3. 路由规则树</h3><p>路由决策树是判断引擎中提供的另外一种构建路由规则的方式，把路由规则定义用到的所有条件节点都以树的形式表现出来。路由规则树对于充值金额的判断逻辑很简单，只筛选目前可用的支付渠道即可。</p><p><img src="https://cors.zfour.workers.dev/?http://img.pmcaff.com/7340b9eee654102b175177a1d1946241-picture" alt="聚合支付路由系统设计" width="735" height="536" coffee-w="831px" coffee-h="606px" coffee-format="png" referrerpolicy="no-referrer"></p><h2>四、支付路由渠道</h2><p>对接多个支付产品并给用户推荐最优的支付渠道，对平台而言是在确保系统稳定的前提下降低通道费用，对用户而言是在确保支付体验的前提下减少通道选择。</p><p>因此，系统稳定好、通道费用低、支付体验好是支付路由选择支付通道的最关键因素。</p><p>以华创微课的银行路由为例，当前聚合了中国银行、交通银行、农业银行等支付渠道，根据模式分类、黑名单过滤、白名单过滤、路由模板（主要包括渠道QOS、渠道限额、渠道费率、到账实效性、营销费用、开户成功率、交易掉单率等）来确定银行路由的路由状态、路由比例、优先级排序。</p><p><img src="https://cors.zfour.workers.dev/?http://img.pmcaff.com/4939ff1b9aaba9d27babd64b007428d9-picture" alt="聚合支付路由系统设计" width="734" height="264" coffee-w="831px" coffee-h="299px" coffee-format="png" referrerpolicy="no-referrer"></p><p>通过银行路由配置中国银行A、交通银行B、农业银行C的路由比例分别为30%：60%：10%，假设A通过渠道路由并完成充值的用户数为200人，B通过渠道路由并完成充值的用户数为250人，C通过渠道路由并完成充值的用户数为50人。若业务系统再来一批（单个或若干）充值新用户，将会优先分配给哪个银行渠道？</p><ul><li>渠道A的当前负荷为：30÷(30+60+10) – 200÷(200+250+50) = 0.3-0.4 = -0.1 繁忙状态</li><li>渠道B的当前负荷为：60÷(30+60+10) – 250÷(200+250+50) = 0.6-0.5 = 0.1 空闲</li><li>渠道C的当前负荷为：10÷(30+60+10) – 50÷(200+250+50) = 0.1-0.1 = 0 正常</li></ul><p>由于路由比例（权重）是计算某一个支付时刻的繁忙状态，且与支付渠道的处理效率有关，以此类推，将会分配给渠道B交通银行。</p><p>在进行华创微课钱包充值过程中，用户选择充值面额、充值方式，并提交订单支付完成充值。其实在收银台选择充值方式的环节，支付系统会根据路由规则调整银行渠道的排序，并给用户默认选择一个最优的银行渠道：交通银行，以此来保证支付成功率，同时降低通道费用。</p><p><img src="https://cors.zfour.workers.dev/?http://img.pmcaff.com/0a2d085f283eec20939f37649511f70f-picture" alt="聚合支付路由系统设计" width="737" height="437" coffee-w="830px" coffee-h="492px" coffee-format="png" referrerpolicy="no-referrer"></p><p>用户提交充值订单支付后，就需要支付系统执行银行代扣。银行代扣主要包括：银行直连、三方渠道、网银通道、银联渠道等支付渠道。</p><p>为了提高充值成功率，降低通道费用，一般会选择银行直连的方式进行代扣。</p><p><img src="https://cors.zfour.workers.dev/?http://img.pmcaff.com/5808ef844ccb52322567ebc5528be111-picture" alt="聚合支付路由系统设计" width="736" height="266" coffee-w="830px" coffee-h="300px" coffee-format="png" referrerpolicy="no-referrer"></p><h2>五、支付路由熔断</h2><p>当支付系统中的某些服务发生故障，或支付渠道中的某条网关紧急关闭的时候，会导致支付通道无法继续提供支付服务，甚至导致整个支付系统崩溃，所以我们要合理利用路由熔断机制降低系统风险并防止服务宕机。</p><p>比如互联网黑客通过机器人伪造虚拟手机号段进行大批量的开户注册，当手机号段命中支付风控规则的熔断条件触发时，就会触发支付系统的自动熔断，采取暂停交易措施，自动熔断命中手机号段黑名单的所有流量。</p><p>此外，因监管政策调整、金融业务受限、支付系统维护等因素，导致支付渠道关闭的时候，可以自由轮询并平稳切换到另外一个支付渠道。</p><p>以银行路由熔断为例，我们将渠道QOS、渠道费率、渠道限额、营销费用、交易掉单率、开户成功率、数据错误率、到账时效性等路由规则作为判断引擎，在状态轮询过程中，发现银行渠道的交易掉单率较高、数据错误率较大触碰路由熔断机制，业务系统就会自动开启、暂停或关闭当前银行渠道，并切换到另外一个银行渠道。</p><p><img src="https://cors.zfour.workers.dev/?http://img.pmcaff.com/70d7711e9906471fbf0a600b6c444402-picture" alt="聚合支付路由系统设计" width="734" height="327" coffee-w="801px" coffee-h="357px" coffee-format="png" referrerpolicy="no-referrer"></p><p>在聚合支付中设置路由熔断机制，可以解决支付网关路由异常的问题，增强路由系统的容错率，并自由切换支付渠道。</p><p>综上所述，路由熔断的根本目的是在支付渠道出问题的时候，用户还是可以正常使用签约、认证、支付、撤销、退款、对账、代扣等支付功能，并保证线上支付体验的一致性。</p><p><br></p><blockquote><p>游善朱哥：《产品闭环：重新定义产品经理》作者，读者送江湖口号：做产品，找朱哥！更多内容请关注公众号：朱哥聊产品</p></blockquote></div>
  
</div>
            