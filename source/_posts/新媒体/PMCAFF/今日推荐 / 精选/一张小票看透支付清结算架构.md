
---
title: '一张小票看透支付清结算架构'
categories: 
 - 新媒体
 - PMCAFF
 - 今日推荐 / 精选
headimg: 'https://cors.zfour.workers.dev/?http://img.pmcaff.com/a3e9d0e7804fdf646cc599dc10fae25f-picture'
author: PMCAFF
comments: false
date: Sat, 15 May 2021 16:10:20 GMT
thumbnail: 'https://cors.zfour.workers.dev/?http://img.pmcaff.com/a3e9d0e7804fdf646cc599dc10fae25f-picture'
---

<div>   
<pre><style>
#articleCont &#123;
  font-size: 16px;
  line-height: 1.6;
  color: #333;
  word-wrap: break-word;
&#125;
#articleCont :first-child &#123;
  margin-top: 0 !important;
&#125;
#articleCont h1,
#articleCont h2,
#articleCont h3,
#articleCont h4,
#articleCont h5,
#articleCont h6 &#123;
  margin: 40px 0 20px;
&#125;
#articleCont h1 &#123;
  font-size: 24px;
&#125;
#articleCont h2 &#123;
  font-size: 22px;
&#125;
#articleCont h3 &#123;
  font-size: 20px;
&#125;
#articleCont h4 &#123;
  font-size: 18px;
&#125;
#articleCont h5 &#123;
  font-size: 16px;
&#125;
#articleCont i &#123;
  font-style: italic;
&#125;
#articleCont p,
#articleCont div &#123;
  word-wrap: break-word;
  margin: 14px 0;
  text-align: justify;
&#125;
#articleCont blockquote &#123;
  border-left: 6px solid #ddd;
  padding: 5px 0 5px 10px;
&#125;
#articleCont blockquote p:last-child &#123;
  margin-bottom: 0;
&#125;
#articleCont .simditor-body blockquote :last-child &#123;
  margin-bottom: 0;
&#125;
#articleCont a &#123;
  color: #82b64a;
&#125;
#articleCont a:visited &#123;
  color: #82b64a;
&#125;
#articleCont a:hover &#123;
  color: #74a342;
&#125;
#articleCont img &#123;
  max-width: 100%;
  height: auto;
&#125;
#articleCont hr &#123;
  margin: 19px 0;
  border: none;
  border-top: solid 1px #ddd;
&#125;
#articleCont ol &#123;
  list-style-type: decimal;
&#125;
#articleCont ol li &#123;
  list-style-type: decimal;
&#125;
#articleCont ul &#123;
  list-style-type: disc;
  padding-left: 40px;
&#125;
#articleCont ul li &#123;
  list-style-type: disc;
&#125;
#articleCont table &#123;
  width: 100%;
  font-size: 12px;
  border-collapse: collapse;
  line-height: 1.7;
&#125;
#articleCont table thead &#123;
  background: #f9f9f9;
&#125;
#articleCont table th,
#articleCont table td &#123;
  border: solid 1px #ccc;
  text-align: left;
  vertical-align: top;
  padding: 2px 4px;
  height: 30px;
  min-width: 40px;
  box-sizing: border-box;
&#125;
#articleCont pre &#123;
  white-space: pre-wrap;
&#125;
</style><p style="text-align:justify;"><span style="color:rgb(136,136,136);">支付清结算相关的系统写了很多了，单模块介绍的也不少；虽然有几个架构性质的文章，但是有不少朋友反馈说无法串起来；今天我们就从一次美团外卖的小票来看，将支付清结算串起来会是什么体验!准备好了么，抓好扶手，走起！</span></p><h1><strong>1.一张小票</strong><br></h1><p>我们看下面外卖盒上的小票，牛肉拌饭1份一共39元，餐盒费1元，没有配送费，合计40元，优惠了19元，实付21，实收17元<br></p><p>我们再看美团订单的信息，烤肉饭1分39元，打包费1元，配送费原价7元现价2元，美团会员15元；美团红包减7元，满减优惠14元；总优惠26元，合计36元</p><p style="text-align:center;"><img src="https://cors.zfour.workers.dev/?http://img.pmcaff.com/a3e9d0e7804fdf646cc599dc10fae25f-picture" alt="图片" coffee-w="897px" coffee-h="460px" coffee-format="png" referrerpolicy="no-referrer"></p><p>我们发现商家的小票和美团的订单信息之间有不少的差异，特别是优惠的明细展示以及优惠总额和应付总额之间存在差异；下面我们就来顺藤摸瓜，分析背后的玄机</p><p style="text-align:center;"><img src="https://cors.zfour.workers.dev/?http://img.pmcaff.com/c74e5e1b048ae34d3a6325eb7b2a5fa1-picture" alt="图片" coffee-w="531px" coffee-h="97px" coffee-format="png" referrerpolicy="no-referrer"></p><p>我们先认清一个关系，订外卖的陈老师跟商家没有直接的关系，美团跟商家直接是结算关系，也就是美团帮助商家代收餐费，并进行结算；简而言之就是陈老师付给美团综合的外卖钱，美团抽一部分然后给商家结算餐费<br></p><p>我们先粗略的假想一下，这个过程是怎么完成的</p><p>我们先到美团平台选择喜欢的“商品”</p><p>然后“下单”并生成交易“账单”</p><p>选择支付方式进行“支付”</p><p>支付成功后美团要履行承诺把餐送到“履约”</p><p>完成以后美团就开始进行各方利益的“清分”计算了</p><p>算清楚应给给各方多少钱时并计入账簿“记账”</p><p>然后就是进行“结算”</p><p style="text-align:center;"><img src="https://cors.zfour.workers.dev/?http://img.pmcaff.com/74dad4103ff3fad7f48d18ef90f67796-picture" alt="图片" coffee-w="1032px" coffee-h="91px" coffee-format="png" referrerpolicy="no-referrer"></p><p style="text-align:justify;">按照这个思路，我们来看，上面的小票在每个环节都是怎么处理的呢</p><h1><strong>2.商品</strong><br></h1><p style="text-align:justify;">商品广泛用于电商系，在o2o领域我们可能叫“服务”多一点，这里其实站在吃货的角度来看，订外卖，买了一份商品也没什么问题；商品模型这里我们不过多介绍，简而言之就是下面这样一个高度抽象的结构<br></p><p style="text-align:center;"><img src="https://cors.zfour.workers.dev/?http://img.pmcaff.com/a0d64a0b7e979ad005c79c3ae7b7033c-picture" alt="图片" coffee-w="616px" coffee-h="219px" coffee-format="png" referrerpolicy="no-referrer"></p><p style="text-align:justify;">那么这一单外卖的商品有哪些呢，有4个（这里我们将配送服务看做商品）</p><p style="text-align:center;"><img src="https://cors.zfour.workers.dev/?http://img.pmcaff.com/02e1890b0e3ca85abaa1b2cb9f18dfc9-picture" alt="图片" coffee-w="440px" coffee-h="237px" coffee-format="png" referrerpolicy="no-referrer"></p><p style="text-align:justify;">这里我们要说一下美团会员，这是美团推出的一个会员服务，相当于花钱买了多张优惠券，所以购买美团会员获得优惠券也是一次交易，而且本交易要先与外卖单，因为外卖单的支付用到了这批券，交易层处理很有意思，大家可以思考一下<br></p><p style="text-align:center;"><img src="https://cors.zfour.workers.dev/?http://img.pmcaff.com/aa6aed9edcc03e8bd4b63873e7ae7dab-picture" alt="图片" coffee-w="866px" coffee-h="352px" coffee-format="png" referrerpolicy="no-referrer"></p><h1><strong>3.订单</strong></h1><p style="text-align:justify;">选购好了商品，那么就需要下单了，这时候订单会去营销系统获取可以使用的活动优惠或者卡券，本小票我们可以看出来，有这些优惠我们可以使用<br></p><p style="text-align:center;"><img src="https://cors.zfour.workers.dev/?http://img.pmcaff.com/dd2045bdb66b290b8ac324e72d2fb995-picture" alt="图片" coffee-w="255px" coffee-h="208px" coffee-format="png" referrerpolicy="no-referrer"></p><p style="text-align:justify;">因为目前我们还不清楚美团和商家之间的清结算协议，所以暂且认为所有优惠由美团提供给用户，后续美团再基于协议跟商家之间做优惠的分摊，这部分不是本文的重点，大家可以私下思考交流<br></p><p style="text-align:justify;">这样我们就得到了订单信息了<br></p><p style="text-align:center;"><img src="https://cors.zfour.workers.dev/?http://img.pmcaff.com/7268f0b722c83da8a244a9040b88bc49-picture" alt="图片" coffee-w="585px" coffee-h="507px" coffee-format="png" referrerpolicy="no-referrer"></p><p style="text-align:justify;">其实我们发现，其中的美团红包是基于15元购买了优惠券以后才能使用的优惠，相当于这一单，你要先买会员获得优惠券，然后在本单同时使用优惠券进行优惠，虽然是同一个订单，但我们可以想象出来，在交易处理层，至少需要做2次处理，一个是对美团会员的处理，另一个是对本单整单的优惠处理；所以订单需要拆成2个子单，一个是外卖单，一个是美团会员单<br></p><p style="text-align:center;"><img src="https://cors.zfour.workers.dev/?http://img.pmcaff.com/88136417b094cf0bb3c1bb5570656ecb-picture" alt="图片" coffee-w="581px" coffee-h="199px" coffee-format="png" referrerpolicy="no-referrer"></p><p>我们看到商家的小票，商品总价是40，总优惠是19；跟订单11101之间的7元差额是什么呢，其实就是配送费，那么将配送费抛出后跟商家小票一致，我们可以推断出商家承担了5元的配送优惠成本，加上满减优惠14，商家总优惠成本是19；</p><p>但最后我们发现商家实收17元，那么这4元是什么呢？其实我们有2个推断，一是美团抽佣4元，另一个可能是商家承担美团红包7元优惠中的4元；如果是取中间可能的话那么实际可能是</p><p>4元=x+y</p><p>x=美团抽佣；x属于[0-4]元</p><p>y=分摊美团红包优惠；y属于[0-4]元<br></p><h1><strong>4.交易</strong></h1><p style="text-align:justify;">完成了订单以后就需要创建支付账单了，基于以上分析交易处理是非常复杂的，因为要先处理美团会员的购买，然后处理外卖订单，</p><p style="text-align:center;"><img src="https://cors.zfour.workers.dev/?http://img.pmcaff.com/d989d78706d8e14020842c09c64bee09-picture" alt="图片" coffee-w="745px" coffee-h="357px" coffee-format="png" referrerpolicy="no-referrer"></p><p style="text-align:justify;">这里因为有2个子单，所以我们生成2个交易账单，但是在支付的时候我们进行合并支付<br></p><p style="text-align:center;"><img src="https://cors.zfour.workers.dev/?http://img.pmcaff.com/7d14564e201a07b50ec0e7b3000ced72-picture" alt="图片" coffee-w="441px" coffee-h="176px" coffee-format="png" referrerpolicy="no-referrer"></p><p>基于账单生成支付请求<br></p><p style="text-align:center;"><img src="https://cors.zfour.workers.dev/?http://img.pmcaff.com/6c5ba66f038b19090dd0c537d538919a-picture" alt="图片" coffee-w="477px" coffee-h="317px" coffee-format="png" referrerpolicy="no-referrer"></p><h1><strong>5.支付</strong></h1><p style="text-align:justify;">账单生成以后，我们进行支付处理，微信支付请求支付系统，优惠类支付我们等待微信支付成功以后请求营销系统，完成优惠券的核销，这样我们就完成了账单的支付了，这时候账单变为已支付，订单支付状态变为已支付，订单状态变为待配送</p><p style="text-align:center;"><img src="https://cors.zfour.workers.dev/?http://img.pmcaff.com/219d94e15adadab9edbdcc8e21824af1-picture" alt="图片" coffee-w="515px" coffee-h="240px" coffee-format="png" referrerpolicy="no-referrer"></p><h1><strong>6.履约</strong></h1><p style="text-align:justify;">订单变为待配送时，会生成服务订单，也就是配送订单，由骑手小王01抢单了</p><p style="text-align:center;"><img src="https://cors.zfour.workers.dev/?http://img.pmcaff.com/1490180e647fcb3899218873f5012ef9-picture" alt="图片" coffee-w="520px" coffee-h="87px" coffee-format="png" referrerpolicy="no-referrer"></p><p style="text-align:justify;">然后的过程大家都熟悉，取了餐，送餐，确认已送达，服务单完成，将订单推送至清算中心进行清分计算</p><h1><strong>7.清算</strong></h1><p style="text-align:justify;">清算系统接收到的清算订单信息包含，订单信息，账单信息，支付信息，履约信息<br></p><p style="text-align:justify;"><img src="https://cors.zfour.workers.dev/?http://img.pmcaff.com/7268f0b722c83da8a244a9040b88bc49-picture" alt="图片" coffee-w="585px" coffee-h="507px" coffee-format="png" referrerpolicy="no-referrer"></p><p style="text-align:justify;"><img src="https://cors.zfour.workers.dev/?http://img.pmcaff.com/6c5ba66f038b19090dd0c537d538919a-picture" alt="图片" coffee-w="477px" coffee-h="317px" coffee-format="png" referrerpolicy="no-referrer"></p><p style="text-align:justify;"><img src="https://cors.zfour.workers.dev/?http://img.pmcaff.com/219d94e15adadab9edbdcc8e21824af1-picture" alt="图片" coffee-w="515px" coffee-h="240px" coffee-format="png" referrerpolicy="no-referrer"></p><p style="text-align:justify;"><img src="https://cors.zfour.workers.dev/?http://img.pmcaff.com/1490180e647fcb3899218873f5012ef9-picture" alt="图片" coffee-w="520px" coffee-h="87px" coffee-format="png" referrerpolicy="no-referrer"></p><p style="text-align:justify;">在清分计费环节有几个关键的模块，我们可以设定为一下模型<br></p><p style="text-align:center;"><img src="https://cors.zfour.workers.dev/?http://img.pmcaff.com/fba8b7728a30ebf8d993a350498e26d6-picture" alt="图片" coffee-w="360px" coffee-h="255px" coffee-format="png" referrerpolicy="no-referrer"></p><p style="text-align:justify;">计费模型就是基于订单业务我们就知道应该计算出什么样的费用出来，比如本单其实有2个业务，一个是外卖业务，一个是美团会员业务<br></p><p style="text-align:justify;">我们假设有计费模型是这样的，美团外卖业务需要计算商家应结算金额，抽佣金额，优惠分摊金额；美团会员计费模型需要计算出美团会员费给平台业务的分成，那么简单起见我们的模型如下</p><p style="text-align:center;"><img src="https://cors.zfour.workers.dev/?http://img.pmcaff.com/34d53519251f0581a47cf89490ac9c5c-picture" alt="图片" coffee-w="322px" coffee-h="119px" coffee-format="png" referrerpolicy="no-referrer"></p><p style="text-align:justify;">我们再基于业务类型，去查找计费规则，什么是计费规则呢，就是计费参数，计费基数，计费模式，计费规则；我们设定规则如下<br></p><p style="text-align:center;"><img src="https://cors.zfour.workers.dev/?http://img.pmcaff.com/4b2d61e68811edabc1fef54bdb356375-picture" alt="图片" coffee-w="617px" coffee-h="167px" coffee-format="png" referrerpolicy="no-referrer"></p><p style="text-align:justify;">那么计费规则，我们可以计算出以下清分结果</p><p style="text-align:center;"><img src="https://cors.zfour.workers.dev/?http://img.pmcaff.com/fcc27d15fe6dea764e32ca387ee35e9d-picture" alt="图片" coffee-w="618px" coffee-h="166px" coffee-format="png" referrerpolicy="no-referrer"></p><p style="text-align:justify;">所以我们得到以下清分结果</p><p style="text-align:center;"><img src="https://cors.zfour.workers.dev/?http://img.pmcaff.com/d485ecf2fe19a952a843c5c3eaeaa5cb-picture" alt="图片" coffee-w="587px" coffee-h="240px" coffee-format="png" referrerpolicy="no-referrer"></p><p style="text-align:justify;">剩下的就是优惠成本的分摊了</p><p style="text-align:center;"><img src="https://cors.zfour.workers.dev/?http://img.pmcaff.com/d3e94461fad73d0de37456ba1c685ee3-picture" alt="图片" coffee-w="585px" coffee-h="164px" coffee-format="png" referrerpolicy="no-referrer"></p><h1><strong>8.账务</strong></h1><p style="text-align:justify;">完成清分计费以后就需要请求账务系统完成记账了，为了简单我们只对商家的结算和骑手的结算进行记账；这时先生成账务记录</p><p style="text-align:center;"><img src="https://cors.zfour.workers.dev/?http://img.pmcaff.com/dc84f35bdc0fb49d9c07e41d1002a6c3-picture" alt="图片" coffee-w="591px" coffee-h="128px" coffee-format="png" referrerpolicy="no-referrer"></p><p>账务流水去操作账户更新余额，这部分内容大家可以看<a target="_blank" href="https://coffee.pmcaff.com/article/2791259841902720/pmcaff?utm_source=forum&newwindow=1" rel="noreferrer noopener">账户系统设计从入门到精通</a><br></p><p style="text-align:center;"><img src="https://cors.zfour.workers.dev/?http://img.pmcaff.com/c04c4a28646db441095c0e11f43f0be6-picture?imageView2/0/format/jpg" alt="图片" coffee-w="587px" coffee-h="128px" coffee-format="webp" referrerpolicy="no-referrer"></p><p style="text-align:justify;">入账成功后账户余额变为</p><p style="text-align:center;"><img src="https://cors.zfour.workers.dev/?http://img.pmcaff.com/3f248b4d0228a511e943d7fb0d5d8be0-picture" alt="图片" coffee-w="586px" coffee-h="123px" coffee-format="png" referrerpolicy="no-referrer"></p><h1><strong>9.结算</strong><br></h1><p>商家和骑手都可以在钱包里看到账户里入账了，然后可以对余额发起提现；生成提现订单，请求打款中心完成出款，这个我们就不详细介绍了</p><h1><strong>10.相关系统</strong><br></h1><p>这里面涉及到了11个系统，我们之前都有文章详细介绍过，大家可以看一下<br></p><p><a target="_blank" href="https://coffee.pmcaff.com/article/2723475494532224/pmcaff?utm_source=forum&newwindow=1" rel="noreferrer noopener">收银台设计方法论</a><br></p><p><a target="_blank" href="https://coffee.pmcaff.com/article/2728167917066368/pmcaff?utm_source=forum&newwindow=1" rel="noreferrer noopener">支付路由设计详解-我见过的最美算法</a><br></p><p><a target="_blank" href="https://coffee.pmcaff.com/article/2759807261843584/pmcaff?utm_source=forum&newwindow=1" rel="noreferrer noopener">支付通道介绍和接入</a><br></p><p><a target="_blank" href="https://coffee.pmcaff.com/article/2739547270772864/pmcaff?utm_source=forum&newwindow=1" rel="noreferrer noopener">订单系统设计解析</a><br></p><p><a target="_blank" href="https://coffee.pmcaff.com/article/2766804032244864/pmcaff?utm_source=forum&newwindow=1" rel="noreferrer noopener">详解|交易核心设计指南</a></p><p><a target="_blank" href="https://coffee.pmcaff.com/article/2791259841902720/pmcaff?utm_source=forum&newwindow=1" rel="noreferrer noopener">账户系统设计从入门到精通</a><br></p><p><a target="_blank" href="https://coffee.pmcaff.com/article/2758829765053568/pmcaff?utm_source=forum&newwindow=1" rel="noreferrer noopener">详解 | 结算系统设计</a><br></p><p><a target="_blank" href="https://coffee.pmcaff.com/article/2797895682348160/pmcaff?utm_source=forum&newwindow=1" rel="noreferrer noopener">对账系统从入门到精通</a></p><h1><strong>11.综合架构</strong></h1><p>从上面的案例，并结合之前的一些文章，我们抽象出一个清结算的通用架构，我们称之为“311架构模型”，即分3层，11个系统；所以叫311架构模型；大家记住这个架构，基本可以解决绝大部分平台的订单支付交易清结算业务模型<br></p><p style="text-align:center;"><img src="https://cors.zfour.workers.dev/?http://img.pmcaff.com/c92440140d457750ce5e424905e413ad-picture" alt="图片" coffee-w="1080px" coffee-h="506px" coffee-format="png" referrerpolicy="no-referrer"></p><p style="text-align:justify;"><span style="color:rgb(255,0,0);">思考题：这张打车小票，司机手机的结算信息与用户订单的结算信息；你能想象出来系统层的实现方式以及业务流转么？用户，滴滴，司机三者之间的清结算结果是怎么样的呢，滴滴这一单是挣钱了还是赔钱了呢？欢迎微信群或者星球内打卡交流。</span></p><p style="text-align:center;"><img src="https://cors.zfour.workers.dev/?http://img.pmcaff.com/1acec6082973a380fc24556e21ed7188-picture" alt="图片" coffee-w="889px" coffee-h="656px" coffee-format="png" referrerpolicy="no-referrer"></p><p><span style="color:rgb(255,0,0);">声明：以上内容均为案例讲解设定，推测，并非美团真实系统设计，请悉知</span></p><p style="text-align:center;"><span style="color:rgb(136,136,136);">·················微信公众号：陈天宇宙·················</span></p><p><span style="color:rgb(136,136,136);">10年产品设计经验，4年社交，2年电商，5年支付；曾任职于某头部金融，某头部支付机构；云对账创始人获千万融资；PMCAFF专栏作者；把所见·所闻·所想·所做，在夜深人静处沉淀成文字留给这个世界！</span></p></pre>
  
</div>
            