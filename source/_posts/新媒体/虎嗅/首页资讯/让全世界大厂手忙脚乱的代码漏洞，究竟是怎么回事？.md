
---
title: '让全世界大厂手忙脚乱的代码漏洞，究竟是怎么回事？'
categories: 
 - 新媒体
 - 虎嗅
 - 首页资讯
headimg: 'https://img.huxiucdn.com/article/content/202112/16/073803078274.jpg?imageView2/2/w/1000/format/jpg/interlace/1/q/85'
author: 虎嗅
comments: false
date: Thu, 16 Dec 2021 01:41:00 GMT
thumbnail: 'https://img.huxiucdn.com/article/content/202112/16/073803078274.jpg?imageView2/2/w/1000/format/jpg/interlace/1/q/85'
---

<div>   
<p><span class="text-remarks" label="备注">本文来自微信公众号：</span><a href="https://mp.weixin.qq.com/s/1RIQBqbYK_hX0NwfnpVyoA" target="_blank" rel="nofollow" style="text-decoration: none;"><span class="text-remarks">差评（ID：chaping321）</span></a><span class="text-remarks">，作者：世超，编辑：小鑫鑫、结界，原文标题：《让全世界大厂都手忙脚乱的代码漏洞，是怎么一步步成为噩梦的？》，头图来自：视觉中国</span></p><p>最近几天，世超在各家互联网大厂的程序员朋友们，都快被一个叫 Log4Shell 的史诗级漏洞给折磨疯了！<br></p><p>这个漏洞源于一个叫 Log4J2 <span class="text-remarks" label="备注">（ Log For Java 2 ）</span>的 Java 开源日志框架，它在用 Java 敲代码的码农群体里可以说是无人不知，无人不晓。</p><p class="img-center-box"><img class="lazyImg" _src="https://img.huxiucdn.com/article/content/202112/16/073803078274.jpg?imageView2/2/w/1000/format/jpg/interlace/1/q/85" data-w="512" data-h="271" src="https://img.huxiucdn.com/article/content/202112/16/073803078274.jpg?imageView2/2/w/1000/format/jpg/interlace/1/q/85" referrerpolicy="no-referrer"></p><p>它就好像早年间打《 魔兽世界 》一定要装的大脚插件一样，属于真正意义上的 “ 咖啡伴侣 ” ，很少有 Java 程序不用这个组件。</p><p class="img-center-box"><img class="lazyImg" _src="https://img.huxiucdn.com/article/content/202112/16/073804195002.png?imageView2/2/w/1000/format/png/interlace/1/q/85" data-w="500" data-h="500" src="https://img.huxiucdn.com/article/content/202112/16/073804195002.png?imageView2/2/w/1000/format/png/interlace/1/q/85" referrerpolicy="no-referrer"></p><p>就是这么一个要命的底层日志框架，被发现透了一个洞……</p><p>最先发现漏洞的，是阿里云安全团队中，一位叫 Chen Zhaojun 的大佬。</p><p>据他的说法，这个漏洞很早就被国外的安全代码扫描平台扫出来了，圈内的程序员大佬们也都在等待官方的修复，没有声张。</p><p class="img-center-box"><img class="lazyImg" _src="https://img.huxiucdn.com/article/content/202112/16/073806907273.jpg?imageView2/2/w/1000/format/jpg/interlace/1/q/85" data-w="1000" data-h="563" src="https://img.huxiucdn.com/article/content/202112/16/073806907273.jpg?imageView2/2/w/1000/format/jpg/interlace/1/q/85" referrerpolicy="no-referrer"></p><p label="图片备注" class="text-img-note"> “ 上百万刀的安全架构，在 Log4J2 漏洞面前一文不值……”</p><p>很快啊，包括了阿里、腾讯、百度、网易、新浪等一众国内的互联网大厂纷纷中枪，都被圈在了受影响的范围之内。</p><p class="img-center-box"><img class="lazyImg" _src="https://img.huxiucdn.com/article/content/202112/16/073808617034.jpg?imageView2/2/w/1000/format/jpg/interlace/1/q/85" data-w="750" data-h="660" src="https://img.huxiucdn.com/article/content/202112/16/073808617034.jpg?imageView2/2/w/1000/format/jpg/interlace/1/q/85" referrerpolicy="no-referrer"></p><p label="图片备注" class="text-img-note">有博主还收到了腾讯云发来的防护短信。 </p><p>不仅仅是大厂的服务系统，耳机、电脑、车机等硬件系统等也无一幸免……</p><p class="img-center-box"><img class="lazyImg" _src="https://img.huxiucdn.com/article/content/202112/16/073809789627.png?imageView2/2/w/1000/format/png/interlace/1/q/85" data-w="783" data-h="392" src="https://img.huxiucdn.com/article/content/202112/16/073809789627.png?imageView2/2/w/1000/format/png/interlace/1/q/85" referrerpolicy="no-referrer"></p><p>不夸张地说，这个漏洞要是不及时修补，下场就是被如饥似渴的黑客们捅烂，进一步威胁网络安全。</p><p>他们会有效利用“零日漏洞”<span class="text-remarks" label="备注">（ 指的是发现后立即被恶意利用的安全漏洞 ）</span>发动零时差攻击，抢在安全补丁出来之前，对服务器造成杀伤。</p><p class="img-center-box"><img class="lazyImg" _src="https://img.huxiucdn.com/article/content/202112/16/073810913397.jpg?imageView2/2/w/1000/format/jpg/interlace/1/q/85" data-w="1000" data-h="867" src="https://img.huxiucdn.com/article/content/202112/16/073810913397.jpg?imageView2/2/w/1000/format/jpg/interlace/1/q/85" referrerpolicy="no-referrer"></p><p>就连我们日常使用的手机、电脑软件<span class="text-remarks" label="备注">（ 大部分都是拿 Java 写的 ）</span>，也都将暴露在黑客的的攻击范围内，想捅哪里捅哪里，把你的电脑挟持过来挖矿也不是没可能。</p><p>就和打游戏偷家似的， so easy ……</p><p>说回这次的漏洞，<strong>最可怕的地方在于实现起来没什么门槛，只要用一串简单的字符，就能轻易攻破服务器，并在上面运行各种代码</strong>。</p><p>这别说是窃取个人信息了，黑客想要远程挟持、瘫痪企业级的服务器，那也是毫无阻碍。</p><p>那黑客到底是怎么样利用漏洞，用几串字符就轻松攻破服务器的呢？<br></p><p class="img-center-box"><img class="lazyImg" _src="https://img.huxiucdn.com/article/content/202112/16/073814420448.png?imageView2/2/w/1000/format/png/interlace/1/q/85" data-w="459" data-h="464" src="https://img.huxiucdn.com/article/content/202112/16/073814420448.png?imageView2/2/w/1000/format/png/interlace/1/q/85" referrerpolicy="no-referrer"></p><p>要整明白这个问题，我们得先搞清楚啥是日志。</p><p>众所周知啊，程序员在敲完一段代码之后，肯定不可能马上拿来用，而要通过反复的测试来验证代码的可行性。</p><p class="img-center-box"><img class="lazyImg" _src="https://img.huxiucdn.com/article/content/202112/16/073815151578.jpg?imageView2/2/w/1000/format/jpg/interlace/1/q/85" data-w="1000" data-h="563" src="https://img.huxiucdn.com/article/content/202112/16/073815151578.jpg?imageView2/2/w/1000/format/jpg/interlace/1/q/85" referrerpolicy="no-referrer"></p><p>但代码本身在跑的时候，处于一个黑箱状态，如果放任它瞎跑的话，跑到一半卡住，根本不知道是错在哪一步上。</p><p>这就好像是做数学题时候如果没草稿纸，在心里算总是没个底。</p><p>这时候，日志的作用就体现出来了，它就好像是一大张草稿纸，能在上面做任何你自己看的懂得步骤和标记，方便随时随地验算。</p><p>本质上日志是程序员们经常使用的一个工具，它把代码在测试过程中的每一步都给记录下来，跑完再回头 Debug 的时候，就很有针对性，效率也高。</p><p class="img-center-box"><img class="lazyImg" _src="https://img.huxiucdn.com/article/content/202112/16/073816643683.png?imageView2/2/w/1000/format/png/interlace/1/q/85" data-w="551" data-h="236" src="https://img.huxiucdn.com/article/content/202112/16/073816643683.png?imageView2/2/w/1000/format/png/interlace/1/q/85" referrerpolicy="no-referrer"></p><p><strong>而 Log4J2 ，就是这么一个开源的日志框架</strong>，它里面整合了不少在修改代码时会用到的常用功能，比如日志管理、输出变量等实用功能。</p><p class="img-center-box"><img class="lazyImg" _src="https://img.huxiucdn.com/article/content/202112/16/073817394519.png?imageView2/2/w/1000/format/png/interlace/1/q/85" data-w="1000" data-h="593" src="https://img.huxiucdn.com/article/content/202112/16/073817394519.png?imageView2/2/w/1000/format/png/interlace/1/q/85" referrerpolicy="no-referrer"></p><p>这次的高危漏洞就是源于 Log4J2 中一个叫 Lookups 的功能。</p><p>从字面上理解，<strong>这个功能就是一个用来搜索内容的接口</strong>，想要搜些啥，那就要靠代码去实现了。</p><p class="img-center-box"><img class="lazyImg" _src="https://img.huxiucdn.com/article/content/202112/16/073819721586.png?imageView2/2/w/1000/format/png/interlace/1/q/85" data-w="1000" data-h="486" src="https://img.huxiucdn.com/article/content/202112/16/073819721586.png?imageView2/2/w/1000/format/png/interlace/1/q/85" referrerpolicy="no-referrer"></p><p>Log4J2 也在 Lookups 的功能下，提供了不少实现的途径，问题就出在这个叫 JNDI 的途径上。</p><p class="img-center-box"><img class="lazyImg" _src="https://img.huxiucdn.com/article/content/202112/16/073820637242.png?imageView2/2/w/1000/format/png/interlace/1/q/85" data-w="504" data-h="665" src="https://img.huxiucdn.com/article/content/202112/16/073820637242.png?imageView2/2/w/1000/format/png/interlace/1/q/85" referrerpolicy="no-referrer"></p><p>JNDI 被 Java 允许通过远程连接的方式来加载文件，这个远程地址可以是开发者自己的服务器，也可以是外界的服务器。</p><p class="img-center-box"><img class="lazyImg" _src="https://img.huxiucdn.com/article/content/202112/16/073822916228.png?imageView2/2/w/1000/format/png/interlace/1/q/85" data-w="1000" data-h="562" src="https://img.huxiucdn.com/article/content/202112/16/073822916228.png?imageView2/2/w/1000/format/png/interlace/1/q/85" referrerpolicy="no-referrer"></p><p><strong>坏就坏在这个远程下载上了……</strong></p><p>黑客只要通过 JNDI 的方法连接上自己的恶意服务器，就可以堂而皇之从这个接口进来，继而攻破整栋固若金汤的大厦。</p><p class="img-center-box"><img class="lazyImg" _src="https://img.huxiucdn.com/article/content/202112/16/073824851119.jpg?imageView2/2/w/1000/format/jpg/interlace/1/q/85" data-w="1000" data-h="676" src="https://img.huxiucdn.com/article/content/202112/16/073824851119.jpg?imageView2/2/w/1000/format/jpg/interlace/1/q/85" referrerpolicy="no-referrer"></p><p>这里世超用尽可能简单的说法解释了一下这个漏洞，如果差友们对具体的实现方式有兴趣，可以看下知乎上轩辕之风大佬写的<a href="https://zhuanlan.zhihu.com/p/444103520" target="_blank" rel="nofollow" textvalue="这篇文章">这篇文章</a>，介绍得很详尽了。</p><p>那么问题来了，为什么这个漏洞在被发现之后过了这么久，才被重视起来？</p><p>外行看热闹，内行看门道，有些事儿还真得问问业内人士。<br></p><p>于是世超咨询了国内知名的白帽网站——火线安全平台的小火子同学，聊了一通之后，大致了解了专业人士对这件事儿的看法。</p><p><strong>实际上 Log4J2 漏洞产生的原因，是部分程序员想要开发者保留在 Lookups 中 JNDI 的实现方式的旧功能而引起的。</strong></p><p>根据 Log4J2 的维护者 Volkan Yazıcı 的说法，<strong>他们早就想把这个有风险的功能给去了，但为了保证向后的兼容性，照顾到想要用这个功能的程序员，所以还是保留了下来</strong>。</p><p class="img-center-box"><img class="lazyImg" _src="https://img.huxiucdn.com/article/content/202112/16/073826535400.png?imageView2/2/w/1000/format/png/interlace/1/q/85" data-w="742" data-h="655" src="https://img.huxiucdn.com/article/content/202112/16/073826535400.png?imageView2/2/w/1000/format/png/interlace/1/q/85" referrerpolicy="no-referrer"></p><p>好嘛，小洞不补、大洞吃苦，这个高危漏洞被发现之后， Log4J2 实际的管理机构 Apache 软件基金会并没能引起足够的重视，披露漏洞的流程也没有按流程来走。</p><p class="img-center-box"><img class="lazyImg" _src="https://img.huxiucdn.com/article/content/202112/16/073829717965.png?imageView2/2/w/1000/format/png/interlace/1/q/85" data-w="1000" data-h="625" src="https://img.huxiucdn.com/article/content/202112/16/073829717965.png?imageView2/2/w/1000/format/png/interlace/1/q/85" referrerpolicy="no-referrer"></p><p>他们直接把问题往开源平台 Github 的 issue 里一贴，期待能有好心人给出解决问题的方案。</p><p>但这是个开放平台啊，有程序员同样也有黑客……</p><p>这波操作等于告诉了全世界的黑客：“咱这软件有高危漏洞哈，欢迎来捅！” </p><p class="img-center-box"><img class="lazyImg" _src="https://img.huxiucdn.com/article/content/202112/16/073830254748.png?imageView2/2/w/1000/format/png/interlace/1/q/85" data-w="1000" data-h="777" src="https://img.huxiucdn.com/article/content/202112/16/073830254748.png?imageView2/2/w/1000/format/png/interlace/1/q/85" referrerpolicy="no-referrer"></p><p>甚至在漏洞全面爆发之前，就已经有白客们在 issue 中公开讨论过具体的修复细节。</p><p class="img-center-box"><img class="lazyImg" _src="https://img.huxiucdn.com/article/content/202112/16/073832469425.png?imageView2/2/w/1000/format/png/interlace/1/q/85" data-w="1000" data-h="644" src="https://img.huxiucdn.com/article/content/202112/16/073832469425.png?imageView2/2/w/1000/format/png/interlace/1/q/85" referrerpolicy="no-referrer"></p><p><strong>可惜的是，等到所有用到使用 Log4J2 的业务系统反应过来有这个漏洞，已经过去了很长一段时间了。</strong></p><p>因为使用 Log4J2 组件的软件实在太多，所以互联网公司的安全部门要一个个软件做修复和升级，这里头的工作量也可想而知。</p><p>目前最快的临时处理方案，是在 Log4J2 做一个触发式的拦截程序，类似于给系统先打上疫苗，把与漏洞相关内容，提前进行阻拦，和防火墙的原理差不多。</p><p>话说回来，世超觉得引发这次漏洞问题的锅，也不应该全由 Log4J2 的维护者来背。</p><p>说出来你可能不信，<strong>像 Log4J2 这么大一个开源项目，实际只靠几个程序员在业余事件来管理和维护，他们本身也是用爱发电，没有任何报酬的</strong>。</p><p class="img-center-box"><img class="lazyImg" _src="https://img.huxiucdn.com/article/content/202112/16/073833314063.jpg?imageView2/2/w/1000/format/jpg/interlace/1/q/85" data-w="600" data-h="762" src="https://img.huxiucdn.com/article/content/202112/16/073833314063.jpg?imageView2/2/w/1000/format/jpg/interlace/1/q/85" referrerpolicy="no-referrer"></p><p label="图片备注" class="text-img-note">来自 Volkan Yazıcı 推特下网友们的评论</p><p>与之相反的是，包括像苹果、谷歌、亚马逊、特斯拉在内的这些大公司，都一定程度上在开心地“白嫖”Log4J2 ，毕竟开源嘛，能省一点人力维护就省一点，反正总会有人维护的……<br></p><p>对于大厂开发者来说，这个来自十几年前仅有数人在维护的工具，只要能够完成产品，那凑合用就凑合用了，绝不重复造轮子。</p><p>并且争取在出现问题之前，成功跳槽……</p><p>可想而知，人人对于这类程序安全漏洞始终都是“碰到了才明白出了问题”，谁知道整个行业都翻了车。</p><p class="img-center-box"><img class="lazyImg" _src="https://img.huxiucdn.com/article/content/202112/16/073834195342.jpg?imageView2/2/w/1000/format/jpg/interlace/1/q/85" data-w="610" data-h="404" src="https://img.huxiucdn.com/article/content/202112/16/073834195342.jpg?imageView2/2/w/1000/format/jpg/interlace/1/q/85" referrerpolicy="no-referrer"></p><p>尽管事儿已经是告一段落了，但这样大型的漏洞翻车事件，并不是第一次，也不会是最后一次发生，此类的“黑天鹅事件”，往往是不可预估且偶发性的。</p><p>而这一场场在网络世界中燃起的大火，唯有依靠程序员们的挑灯夜战，才得以熄灭。<br></p><p><span class="text-remarks" label="备注">特别鸣谢：火线安全</span></p><p><span class="text-remarks" label="备注">图片、资料来源：</span></p><p><span class="text-remarks" label="备注">微博：@程序员的那些事</span></p><p><span class="text-remarks" label="备注">微博：@Flanker_017</span></p><p><span class="text-remarks" label="备注">微博：@主动干饭猫</span></p><p><span class="text-remarks" label="备注">知乎：核弹级漏洞！我把log4j扒给你看！</span></p><p><span class="text-remarks" label="备注">新智元：中国程序员抢先预警「史诗」级漏洞，席卷苹果特斯拉</span></p><p><span class="text-remarks" label="备注">开源中国：Log4j 维护者：为向后兼容没移除导致漏洞的旧功能</span></p><p><span class="text-remarks" label="备注">Twitter：@yazicivo</span></p><p><span class="text-remarks" label="备注">Mitigating the log4j Vulnerability (CVE-2021-44228) with NGINX</span><br></p><p><span class="text-remarks" label="备注">本文来自微信公众号：</span><a href="https://mp.weixin.qq.com/s/1RIQBqbYK_hX0NwfnpVyoA" target="_blank" rel="nofollow" style="text-decoration: none;"><span class="text-remarks">差评（ID：chaping321）</span></a><span class="text-remarks">，作者：世超</span></p>  
</div>
            