
---
title: '1 月 4 日早上有网友反映「西安一码通」再次崩溃，真实情况如何？这可能给疫情防控带来哪些影响？'
categories: 
 - 社交媒体
 - 知乎
 - 知乎热榜
headimg: 'https://pic1.zhimg.com/v2-f4eda075167d48ff18d187b8810f6bfe_1440w.jpg'
author: 知乎
comments: false
date: Tue, 04 Jan 2022 03:34:08 GMT
thumbnail: 'https://pic1.zhimg.com/v2-f4eda075167d48ff18d187b8810f6bfe_1440w.jpg'
---

<div>   
纯洁的微笑的回答<br><br><p data-pid="-Fzk3aES">推荐阅读：<i><b><a href="http://link.zhihu.com/?target=https%3A//mp.weixin.qq.com/s%3F__biz%3DMzg5ODcwNDUwOQ%3D%3D%26mid%3D2247485667%26idx%3D1%26sn%3D8015e7d7e861106b19a9cdaba219995c%26scene%3D21%23wechat_redirect" class=" wrap external" target="_blank" rel="nofollow noreferrer">《西安健康一码通崩了！程序员抢修竟然被……》</a></b></i></p><p><br></p><p data-pid="7clzOhOy">1    <b>又崩了</b></p><p><br></p><p data-pid="0n95wS7e">12月20号，算得上西安崩溃的一天。</p><p data-pid="uuFcOBgz"><b>那么今天1月4号，就是上西安市民的又又一次崩溃。</b></p><p data-pid="JPkNUvXg">在中央的领导下，西安正在打攻坚战的时候，西安一码通又又一次崩溃了。。。</p><p><br></p><figure data-size="normal"><img src="https://pic1.zhimg.com/v2-f4eda075167d48ff18d187b8810f6bfe_1440w.jpg" data-caption data-size="normal" data-rawwidth="1080" data-rawheight="2204" data-default-watermark-src="https://pic2.zhimg.com/v2-d49845ecc8da7d7cb48b51821fff2bad_720w.jpg" class="origin_image zh-lightbox-thumb" data-original="https://pic1.zhimg.com/v2-f4eda075167d48ff18d187b8810f6bfe_r.jpg" referrerpolicy="no-referrer"></figure><p><br></p><figure data-size="normal"><img src="https://pic4.zhimg.com/v2-b6e914a525b4c0074e3424176aed3d33_1440w.jpg" data-caption data-size="normal" data-rawwidth="1080" data-rawheight="2204" data-default-watermark-src="https://pic1.zhimg.com/v2-4a744dab9be9d60877a7af193dea1294_720w.jpg" class="origin_image zh-lightbox-thumb" data-original="https://pic4.zhimg.com/v2-b6e914a525b4c0074e3424176aed3d33_r.jpg" referrerpolicy="no-referrer"></figure><p><br></p><p data-pid="6YNi162y"><b>第一次出现问题，修复了整整一天，那么这次呢？同样的问题过去了十几天仍然再次出现了！！！</b><br></p><p data-pid="prMJdEEw">今天小区8点，西安市通知开始又一轮全市核酸检测，于是各个小区开始让大家排队做核酸。</p><p data-pid="tfKJ6avA">结果很多小区都没开始做的时候，大家突然发现一码通打不开了，大家可要知道西安市现在的温度是1度，大家排队在外面的感受。<br></p><p data-pid="G3-rWj9O">刚开始还让等待，结果等了30分钟之后，发现仍然没有一点恢复的迹象，于是通知大家回家等待。<br></p><p data-pid="0sZyeQqK"><b>西安现在防疫压力有多大，我这里不需要再复述了，严重程度仅次于当年的武汉。</b></p><p data-pid="dclDguyZ">最讽刺的是，大家都还在排队的过程中，收到了市里面发过来的短信，而一码通仍然处于崩溃中。</p><figure data-size="normal"><img src="https://pic4.zhimg.com/v2-a89c562458f0bb7ebe04ae37bdd80c84_1440w.jpg" data-caption data-size="normal" data-rawwidth="1080" data-rawheight="701" data-default-watermark-src="https://pic4.zhimg.com/v2-25a5827254e479a28c92e32e1a5e0249_720w.jpg" class="origin_image zh-lightbox-thumb" data-original="https://pic4.zhimg.com/v2-a89c562458f0bb7ebe04ae37bdd80c84_r.jpg" referrerpolicy="no-referrer"></figure><p><br></p><p><br></p><p data-pid="W75K08DK"><b>关键是这个问题有那么难吗？</b><br></p><p data-pid="-xxYNNf2">关键时刻、关系到国计民生的事情，如果负责的技术团队解决不了，能不能请求一下 BAT 的专家过来帮忙支援。</p><p data-pid="P-BA11Fc">到现在这个程度，已经不是钱的问题了，严重影响整个西安防控的进展了。</p><p data-pid="TXkVnKcz">吐槽归吐槽，估计一码通的程序员，现在压力巨大，希望他们可以沉下心来尽快将问题解决吧。</p><p data-pid="tKeZUUFN">这个级别的问题和干活的程序员关系不大，<b>主要的责任人都在负责的相关领导身上。</b></p><p data-pid="GpahsJPD">希望相关领导负起责任来，将类似的问题一次性解决好，西安真的以及经不起再次再次的折腾了。。。</p><p><br></p><p data-pid="rPfAiL-B"><b>下面这篇文章是我在20号，崩溃的时候写的</b>，只能从局外人给出一些浅薄的见解。</p><p><br></p><p data-pid="WU5Q6s6c">2  <b>产品分析</b></p><p><br></p><p data-pid="deoF-c35">西安一码通其它业务我们暂且不分析，那并不是重点，并且当天也没有完全崩溃，崩溃的仅有扫码功能。</p><p data-pid="9-n-Kuh8">其实这是一个非常典型的大量查询、少数更新的业务，闭着眼睛分析一下，可以说， 90% 以上的流量都是查询。<br></p><p data-pid="Z_PHoC1p">我们先来看看第一版的产品形态，扫码之后展示个人部分姓名和身份证信息，同时下面展示绿、黄、红码。<br></p><p><br></p><figure data-size="normal"><img src="https://pic1.zhimg.com/v2-b89603129c191ea92e3a9144b1d30ebc_720w.jpg" data-caption data-size="normal" data-rawwidth="413" data-rawheight="731" data-default-watermark-src="https://pic3.zhimg.com/v2-f4050158138dd5ac9546198f1edf8d63_720w.jpg" class="content_image" referrerpolicy="no-referrer"></figure><p><br></p><p data-pid="OysLze_t">这是西安一码通最开始的样子，业务流程仅仅只需要一个请求，甚至一个查询的 SQL 就可以搞定。</p><p data-pid="Pgs0kAKG">到了后来，这个界面做了2次比较大的改版。</p><p data-pid="N6J3Dey5">第一次改版新增了疫苗接种信息，加了一个边框；第二次改版新增了核酸检测信息，在最下方展示核酸检测时间、结果。</p><figure data-size="normal"><img src="https://pic4.zhimg.com/v2-bb5a2ee70d3991502249659a9e4f2d36_1440w.jpg" data-caption data-size="normal" data-rawwidth="1080" data-rawheight="809" data-default-watermark-src="https://pic1.zhimg.com/v2-6ac83014a049723707121abe86f44a38_720w.jpg" class="origin_image zh-lightbox-thumb" data-original="https://pic4.zhimg.com/v2-bb5a2ee70d3991502249659a9e4f2d36_r.jpg" referrerpolicy="no-referrer"></figure><p data-pid="gP_TulQW">整个页面增加了2个查询业务，如果系统背后使用的是关系数据库，可能会多增加至少2个查询SQL。<br></p><p data-pid="gqeZwmfb">基本上就是这样的一个需求，据统计西安有1300万人口，按照最大10%的市民同时扫码（我怀疑不会有这么多），也就是百万的并发量。<br></p><p data-pid="tm-Kq_rJ">这样一个并发量的业务，在互联网公司很常见，甚至比这个复杂的场景也多了去了。<br></p><p data-pid="S4aXkMNj">那怎么就崩了呢？<br></p><p><br></p><p data-pid="GIxBHY-_">3  <b>技术分析</b></p><p><br></p><p data-pid="dFPMf-Yz">在当天晚上的官方回复中，我们看到有这样一句话：</p><blockquote data-pid="34bw4pKi">12月20日早7:40分左右，西安“一码通”用户访问量激增，每秒访问量达到以往峰值的10倍以上，造成网络拥塞，致使包括“一码通”在内的部分应用系统无法正常使用。“<br><br>一码通”后台监控第一时间报警，各24小时驻场通信、网络、政务云、安全和运维团队立即开展排查，平台应用系统和数据库运行正常，判断问题出现在网络接口侧。<br><br></blockquote><p data-pid="-WHeqinv">根据上面的信息，数据库和平台系统都正常，是网络出现了问题。<br></p><p data-pid="BukdvYRJ">我之前在文章<b><i><a href="http://link.zhihu.com/?target=http%3A//mp.weixin.qq.com/s%3F__biz%3DMzI4NDY5Mjc1Mg%3D%3D%26mid%3D2247483915%26idx%3D1%26sn%3D0f03cad9366456ab147ace69c86cfc5d%26chksm%3Debf6da74dc815362070aa44ffd510f4b4d94f40725f00e80393a81153071129e46c4cbf8cf72%26scene%3D21%23wechat_redirect" class=" wrap external" target="_blank" rel="nofollow noreferrer">《一次dns缓存引发的惨案》</a></i></b>画过一张访问示意图，用这个图来和大家分析一下，网络出现问题的情况。</p><p><br></p><figure data-size="normal"><img src="https://pic4.zhimg.com/v2-c2d23631a15efa03b581de15d00bb523_1440w.jpg" data-caption data-size="normal" data-rawwidth="900" data-rawheight="755" data-default-watermark-src="https://pic1.zhimg.com/v2-19684608323a5ee19d0f69a350e37d1a_720w.jpg" class="origin_image zh-lightbox-thumb" data-original="https://pic4.zhimg.com/v2-c2d23631a15efa03b581de15d00bb523_r.jpg" referrerpolicy="no-referrer"></figure><p><br></p><p data-pid="b7LGW3ig">一般用户的请求，会先从域名开始，经过DNS服务器解析后拿到外网IP地址，经过外网IP访问防火墙和负载之后打到服务器，最后服务器响应后将结果返回到浏览器。</p><p data-pid="1sTUN_vX">如果真的是网络出现问题，一般最常见的问题就是 DNS 解析错误，或者外网的宽带被打满了。</p><p data-pid="tzp6ftXo">DNS解析错误一定不是本次的问题，不然可能不只是这一个功能出错了；外网的宽带被打满，直接增加带宽就行，不至于一天都没搞定。<br></p><p data-pid="ctiWQQiQ">如果真的是网络侧出现问题，一般也不需要改动业务，但实际上系统恢复的时候，大家都发现界面回到文章开头提到了第一个版本了。</p><p><br></p><figure data-size="normal"><img src="https://pic2.zhimg.com/v2-b89603129c191ea92e3a9144b1d30ebc_720w.jpg" data-caption data-size="normal" data-rawwidth="413" data-rawheight="731" data-default-watermark-src="https://pic3.zhimg.com/v2-f4050158138dd5ac9546198f1edf8d63_720w.jpg" class="content_image" referrerpolicy="no-referrer"></figure><p><br></p><p data-pid="cCUG31g2"><b>也就是说系统“回滚”了。</b><br></p><p data-pid="AHyH3xlO">界面少了接种信息和核酸检测信息的内容，并且在一码通的首页位置，新增加了一个核酸查询的页面。</p><p><br></p><figure data-size="normal"><img src="https://pic2.zhimg.com/v2-06bba78a7feeb39740de20334291eb0c_1440w.jpg" data-caption data-size="normal" data-rawwidth="1080" data-rawheight="1079" data-default-watermark-src="https://pic3.zhimg.com/v2-cf8ee7d7b1f874858b2b00a96f1a9dd1_720w.jpg" class="origin_image zh-lightbox-thumb" data-original="https://pic2.zhimg.com/v2-06bba78a7feeb39740de20334291eb0c_r.jpg" referrerpolicy="no-referrer"></figure><p><br></p><p data-pid="vUcnyEfV">所以，仅仅是网络接口侧出现问题吗？我这里有一点点的疑问。<br></p><p><br></p><p><br></p><p data-pid="YgHu3-zo">4  <b>个人分析</b></p><p><br></p><p data-pid="xu3JMb4l">根据我以往的经验，这是一个很典型的系统过载现象，也就是说短期内请求量超过服务器响应。</p><p data-pid="Nk_8vPiT">说人话就是，外部请求量超过了系统的最大处理能力。<br></p><p data-pid="0z_uZf3O">当然了，系统最大处理能力和系统架构息息相关，同样的服务器不同的架构，系统负载量差异极大。</p><p data-pid="0Vipd36Q">应对这样的问题，解决起来无非有两个方案，一个是<b>限流</b>，另外一个就是<b>扩容</b>了。<br></p><p data-pid="CRmHkiod">限流就是把用户挡在外面，先处理能处理的请求；扩容就是加服务器、增加数据库承载能力。<br></p><p data-pid="MudXSLQI">上面提到官方让大家没事别刷一码通，也算是人工限流的一种方式；不过在技术体系上基本上不会这样做。</p><p data-pid="4tMfbIE7">技术上的限流方案有很多，但最简单的就是前面挂一个 Nginx 配置一下就能用；复杂一点就是接入层自己写算法。<br></p><p data-pid="nHWFPrkO">当然了限流不能真正的解决问题，只是负责把一部分请求挡在外面；真正解决问题还是需要扩容，满足所有用户。</p><p data-pid="79KXk5BT">但实际上，根据解决问题的处理和产品回滚的情况来看，一码通并没有第一时间做扩容，而是选择了回滚。</p><p data-pid="lgmcU0cx">这说明，在系统架构设计上，没有充分考虑扩容的情况，所以并不能支持第一时间选择这个方案。</p><p><br></p><p><br></p><p data-pid="5KtxTvXG">5  <b>理想的方案？</b></p><p><br></p><p data-pid="aBlYO4mW">上面说那么多也仅仅是个人推测，实际上可能他们会面临更多现实问题，比如工期紧张、老板控制预算等等...</p><p data-pid="3sbbL2JV">话说回来，如果你是负责一码通公司的架构师，你会怎么设计整个技术方案呢？欢迎大家留言，这里说说我的想法。</p><p data-pid="cQrI-FjE">第一步，读写分离、缓存。</p><p data-pid="b5dMCq1G">至少把系统分为2大块，满足日常使用的读业务单独抽取出来，用于承接外部的最大流量。<br></p><p data-pid="iTr60U8W">单独抽出一个子系统负责业务的更新，比如接种信息的更新、核酸信息的变化、或者根据业务定时变更码的颜色。</p><p data-pid="dlBhJIr9">同时针对用户大量的单查询，上缓存系统，优先读取缓存系统的信息，防止压垮后面的数据库。<br></p><p data-pid="eOVxxajJ">第二步，分库分表、服务拆分。<br></p><p data-pid="p-0sTmED">其实用户和用户之间的单个查询是没有关系的，完全可以根据用户的属性做分库分表。<br></p><p data-pid="IGKddav1">比如就用用户ID取模分64个表，甚至可以分成64个子系统来查询，在接口最前端将流量分发掉，减轻单个表或者服务压力。</p><p data-pid="5nYw4aLY">上面分析没有及时扩容，可能就是没有做服务拆分，如果都是单个的业务子服务的话，遇到过载的问题很容易做扩容。<br></p><p data-pid="DBt_EM1t">当然，如果条件合适的话，上微服务架构就更好了，有一套解决方案来处理类似的问题。<br></p><p data-pid="wGd-dpBX">第三步，大数据系统、容灾。<br></p><p data-pid="WyXmjjYO">如果在一个页面中展示很多信息，还有一个技术方案，就是通过异步的数据清洗，整合到 nosql 的一张大表中。</p><p data-pid="sd5URxx8">用户扫描查询等相关业务，直接走 nosql 数据库即可。</p><p data-pid="-gjIAvRl">这样处理的好处是，哪怕更新业务完全挂了，也不会影响用户扫码查询，因为两套系统、数据库都是完全分开的。<br></p><p data-pid="5k1kOTZ4">使用异地双机房等形式部署服务，同时做好整体的容灾、备灾方案，避免出现极端情况，比如机房光缆挖断等。<br></p><p data-pid="aOL8Oh7Z">还有很多细节上的优化，这里就不一一说明了，这里也只是我的一些想法，欢迎大家留言补充。</p><p><br></p><p data-pid="Kd5zvV3E">6  <b>最后</b></p><p><br></p><p data-pid="qbnYyPWv">不管怎么分析，这肯定是人祸而不是天灾。</p><p data-pid="IT82f3tX">系统在没有经过严格测试之下，就直接投入到生产，在强度稍微大一点的环境中就崩溃了。</p><p data-pid="CpQGxpGY">比西安大的城市很多，比西安现在疫情还要严重的情况，其它城市也遇到过，怎么没有出现类似的问题？</p><p data-pid="nGn3HrBU">西安做为一个科技大城，出现这样的问题真的不应该，特别是我看了这个小程序背后使用的域名地址之后。<br></p><p><br></p><figure data-size="normal"><img src="https://pic1.zhimg.com/v2-5b5e532b31c34409c62b813e55832a98_1440w.jpg" data-caption data-size="normal" data-rawwidth="1080" data-rawheight="1600" data-default-watermark-src="https://pic4.zhimg.com/v2-002c2667856844247e9ea1d3c06376af_720w.jpg" class="origin_image zh-lightbox-thumb" data-original="https://pic1.zhimg.com/v2-5b5e532b31c34409c62b813e55832a98_r.jpg" referrerpolicy="no-referrer"></figure><p><br></p><p data-pid="PrcR95bE">有一种无力吐槽的感觉，虽然说这和程序使用没有关系，但是从细节真的可以看出一个技术团队的实力。</p><p data-pid="pA92ZnAD">希望这次能够吸取教训，避免再次出现类似的问题！<br></p><p data-pid="nY-g7ETO"><b>最后，这里再给大家推荐一个程序员学习网站，可以说涉及到程序员的方方面面的资源都有，使用了的朋友都说，只恨没有早点发现这个网站：</b></p><p><br></p><a href="http://link.zhihu.com/?target=https%3A//cxy521.com/" data-draft-node="block" data-draft-type="link-card" data-image="https://pic4.zhimg.com/v2-6a2e6aba669fb3aabce71c2d80f9847c_bh.jpg" data-image-width="400" data-image-height="120" class=" wrap external" target="_blank" rel="nofollow noreferrer">程序员导航-CXY521​cxy521.com/​cxy521.com/</a><p><br></p><p data-pid="fGG5V96N"><a href="https://www.zhihu.com/people/c472bd14369be7a8841b8ab5762ce22e" class="internal">@纯洁的微笑</a></p><p data-pid="SPsHKFMv">也可以关注我的知乎，一个有故事的程序员，如果对你有用，来个赞吧！</p>  
</div>
            