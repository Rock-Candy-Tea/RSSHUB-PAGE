
---
title: '12 月 20 日西安一码通崩溃，西安建议市民非必要不展码、亮码，一码通故障的影响有多大？'
categories: 
 - 社交媒体
 - 知乎
 - 知乎热榜
headimg: 'https://pic4.zhimg.com/v2-685acfe7e0f4c2f23952216792e15551_1440w.jpg'
author: 知乎
comments: false
date: Tue, 21 Dec 2021 04:36:56 GMT
thumbnail: 'https://pic4.zhimg.com/v2-685acfe7e0f4c2f23952216792e15551_1440w.jpg'
---

<div>   
夕立改二的回答<br><br><p data-pid="v1CMVehQ">首先崩溃的原因大概率是并发过高了。</p><h2>我来猜一下为什么，以及怎么修的</h2><p data-pid="v51xuTTw">以前，打开西安一码通健康码后，底下会有最近一次的核酸结果：</p><figure data-size="normal"><img src="https://pic4.zhimg.com/v2-685acfe7e0f4c2f23952216792e15551_1440w.jpg" data-rawwidth="640" data-rawheight="1430" data-size="normal" data-default-watermark-src="https://pic2.zhimg.com/v2-85ecab290e633e09298161fba99a2631_720w.jpg" class="origin_image zh-lightbox-thumb" data-original="https://pic4.zhimg.com/v2-685acfe7e0f4c2f23952216792e15551_r.jpg" referrerpolicy="no-referrer"><figcaption>旧版西安健康码（图源网络，侵删）</figcaption></figure><p data-pid="_u7BOa29">点开下方核酸结果，可以看到最近7天内的所有核酸结果：</p><figure data-size="normal"><img src="https://pic2.zhimg.com/v2-c5884491ad7cca60150b769be79aa6bd_720w.jpg" data-rawwidth="219" data-rawheight="438" data-size="normal" data-default-watermark-src="https://pic1.zhimg.com/v2-c9c75c747693614d812f4a1b5d1d31c9_720w.jpg" class="content_image" referrerpolicy="no-referrer"><figcaption>旧版核酸结果查询（图源网络，侵删）</figcaption></figure><p data-pid="A5CN25w5">然而，在20号瘫痪一天之后，新版一码通变成了这样：</p><figure data-size="normal"><img src="https://pic2.zhimg.com/v2-b2d5d1c6d54f7ed807bb5bebd583623e_1440w.jpg" data-rawwidth="1439" data-rawheight="2782" data-size="normal" data-default-watermark-src="https://pic3.zhimg.com/v2-95dc0785ad5a13c1e29d07992081c4e3_720w.jpg" class="origin_image zh-lightbox-thumb" data-original="https://pic2.zhimg.com/v2-b2d5d1c6d54f7ed807bb5bebd583623e_r.jpg" referrerpolicy="no-referrer"><figcaption>新版西安健康码</figcaption></figure><p data-pid="fhRujzUm">可以注意到，<b>最近一次核酸结果不再显示</b>，<b>疫苗接种结果不再显示</b>。</p><p data-pid="AU68b5bo">核酸查询入口挪到了一码通主界面：</p><figure data-size="normal"><img src="https://pic4.zhimg.com/v2-0b1e1539570e69a452dde71763c1dc88_1440w.jpg" data-rawwidth="1440" data-rawheight="2896" data-size="normal" data-default-watermark-src="https://pic3.zhimg.com/v2-df86e5ea968b971adc407228bcf885cd_720w.jpg" class="origin_image zh-lightbox-thumb" data-original="https://pic4.zhimg.com/v2-0b1e1539570e69a452dde71763c1dc88_r.jpg" referrerpolicy="no-referrer"><figcaption>新版核酸查询入口</figcaption></figure><p data-pid="perC-KMi">新版核酸查询结果：</p><figure data-size="normal"><img src="https://pic4.zhimg.com/v2-809810926b4bbbabe1c46fd23e432436_1440w.jpg" data-rawwidth="1439" data-rawheight="2196" data-size="normal" data-qrcode-action="none" data-default-watermark-src="https://pic4.zhimg.com/v2-949e28e8eefa302c691de18493d79980_720w.jpg" class="origin_image zh-lightbox-thumb" data-original="https://pic4.zhimg.com/v2-809810926b4bbbabe1c46fd23e432436_r.jpg" referrerpolicy="no-referrer"><figcaption>新版核酸查询结果</figcaption></figure><p data-pid="bA4bgwGg">可以看到，<b>只显示最近一天的结果了，并且手动查询其他日期也不再显示</b>。</p><p data-pid="tbibDj0l">也就是说，事关千万人出行和安全的基础软件设施，在经历一天的紧急维修后，并没有选择扩容。政府应该是不缺钱的，那么就是无法短时间内扩容，也就是这个软件架构设计就有问题，根本支撑不住这么高的并发。</p><p data-pid="Jw2x6WsH">那么他们选择了什么呢？尽量避免核酸查询。也就是说瓶颈应该是出在核酸查询接口的并发能力上。现在，亮码不再显示核酸（也不显示疫苗），手动查询只显示最新一条记录。</p><p data-pid="gL7uR5oH">如果原来亮一次码需要：</p><p data-pid="iQshCqZF">查询最新核酸1次，查询疫苗接种1次。</p><p data-pid="SfUo3soh">那么现在亮一次码则省掉了以上两次查询。</p><p data-pid="gEi94B0x">这应该会避免掉很多不必要的流量，比如公交、地铁。</p><p data-pid="TLrus58S">如果原来查一次核酸需要以下任意一种：</p><ol><li data-pid="JB45iA-i">查询7天内核酸1次（用数据库自带日期计算函数）。</li><li data-pid="Un_CLUX-">查询从当天往前推每天的核酸7次。</li><li data-pid="1lmW9Qky">不停查询最新n次核酸，n累加1，直到最后一条记录日期与当天做差大于7。</li></ol><p data-pid="BASJdqDx">（这三种写法是依愚蠢程度上升的。）</p><p data-pid="qFvUZYed">那么现在查一次核酸则固定变成了1次查询（order by date desc limit 1）。</p><p data-pid="nMx4KSU9">确实相比以性能有提升。</p><p data-pid="5J0nE-PP">综上，结合微博上看到的各单位要求出示48h核酸阴性报告才能上班，昨天是周一第一天执行该政策，<b>我认为，是过高的核酸查询并发把整个健康码系统给拖崩溃了</b>。</p><p data-pid="5GjLhLL6"><b>解决方案就是：</b></p><p data-pid="vqU3fSxH"><b>1. 在健康码界面砍掉核酸查询，让公交地铁等扫码但不看核酸的场景不再查询核酸。</b></p><p data-pid="Nm9Euj87"><b>2. 在核酸查询界面砍掉过往核酸查询，只留一条最新记录。</b></p><p data-pid="PWcPDr6Y"><b>我想这是扩不了容的情况下能做的一切了。</b></p><p data-pid="V0kQPvzh"><b>但我还是想不通为什么这两步做了一整天。</b></p><h2><b>那么问题来了，为什么扩不了容？</b></h2><p data-pid="dBC_Gsaf">如真如网上所说，系统由电信、东软和美林数据共同支持，假设美林甩锅合理成立（微博有自称美林员工说美林只提供数据支持，不负责运营），那我猜东软是主力。</p><p data-pid="HyoExuwC">不管是电信还是东软，都不是第一天入行了。这又不是互联网创业不知第二天死活先上线再说，一开始做系统的时候，就应该知道面向的是全西安人民，真的一点扩容的后路都没有留？缓存、拆表、集群……有那么多方法，开发的时候多耗不了多少精力。如今这个堪称搞笑的补救措施——你以为抗压能力强了？其实是砍了很多功能哒！——贻笑大方了属于是。</p>  
</div>
            