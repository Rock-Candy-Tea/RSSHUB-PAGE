
---
title: 'Rust 发布 1.56.0 版本，支持闭包非联接捕获'
categories: 
 - 编程
 - 开源中国
 - 资讯
headimg: 'https://picsum.photos/400/300?random=4345'
author: 开源中国
comments: false
date: Fri, 22 Oct 2021 18:19:00 GMT
thumbnail: 'https://picsum.photos/400/300?random=4345'
---

<div>   
<div class="content">
                                                                    
                                                        <p><span style="color:#333333"> Rust 1.56.0 版本已正式发布，此版本支持闭包对标识符的</span><span style="color:#2e3033">非联接</span><span style="color:#333333">捕获，并对 </span><code><strong>pattern</strong></code>做了大量优化。</p> 
<p><span style="color:#333333">且如果你此前已通过 rustup 安装了以前的 Rust 版本，运行以下命令即可升级至最新版本：</span></p> 
<p><span style="color:#000000"><code>＄ rustup update stable                                                                                  </code></span></p> 
<h2 style="margin-left:0px"><strong>1.56.0 版本主要更新内容：</strong></h2> 
<ul> 
 <li><span style="color:#2e3033">非联接捕获：闭包现在捕获单个命名字段，不会总是捕获整个标识符。（如：</span><code>|| a.x + 1</code>现在只捕获<code>a.x</code>而不是<code>a</code>）</li> 
 <li>数组 <code>IntoIterator</code>：<code>array.into_iter()</code> 现在按值，而不是按引用来迭代项目</li> 
 <li><span style="color:#000000">patterns 的 </span><span style="color:#301900"><code>$_:pat</code></span><span style="color:#000000"> 标识符在 </span><code>macro_rules</code> 宏里可以匹配 <code>|</code>  （<a href="https://www.oschina.net/news/146638/rust-1-53-0-released">1.53 引入的 <code>|</code> 扩展</a> ），<span style="color:#301900">用 <code>$_:pat_param </code> 代替之前的 <code>$_:pat </code>，</span><code>$_:pat_param</code> 不匹配 <code>|</code>  ，但是可以在所有版本中使用。</li> 
 <li><span style="color:#2e3033">默认用第二版 Cargo 。</span></li> 
 <li>Prelude 库新增 ：<code>TryInto</code><span style="color:#000000"> 、 </span><code>TryFrom</code><span style="color:#000000"> 、 </span><code>FromIterator</code> 默认可用。</li> 
 <li>Panic 宏只接受格式化字符串，比如 <code>println!()</code></li> 
 <li><code>ident#</code> 、<code>ident"..."</code> 和 <code>ident'...'</code> 变成保留语法。</li> 
 <li><code>bare_trait_objects</code> 和 <code>ellipsis_inclusive_range_patterns</code> 从警告变成报错。</li> 
</ul> 
<h2>闭包的非联接捕获</h2> 
<p><span style="color:#000000">新的不相交捕获功能可以简化编写闭包的过程，看个例子：</span></p> 
<pre><code class="language-rust"><span>// 2015 或 2018 版代码</span>
<span>let</span> a = SomeStruct::new();

<span>// </span><span>从结构体的一个字段中移出</span></code><code class="language-rust"><span>drop</span>(a.x);

<span>// 还是使用结构体的另一个字段</span>
<span>println!</span>(<span>"&#123;&#125;"</span>, a.y);

<span>// 错误:在2021版之前，会试图捕获所有' a '</span>
<span>let</span> c = || <span>println!</span>(<span>"&#123;&#125;"</span>, a.y);
c();
</code></pre> 
<p>2021版本之前，你要在形成闭包之前手动提取相关的标识符，比如 <code>let y = &a.y;</code><span style="color:#000000"> ，从 Rust 2021 开始，闭包将自动捕获它们使用的字段，因此上面的示例可以正常编译。</span></p> 
<h2><strong>Cargo </strong><code><strong>rust-version</strong></code></h2> 
<p><code>Cargo.toml</code><span style="color:#000000">  现在 支持 </span><code>[package]</code><span style="color:#000000"> </span><code><u>rust-version</u></code><span style="color:#000000"> 字段来指定 crate 支持的最低 Rust 版本，如果不满足，Cargo 将退出并显示早期错误。这不会影响依赖解析器，旨在解决兼容性的问题，避免编译的时候出现模糊不清的报错。</span></p> 
<h2><strong>新绑定 </strong><code><strong>binding @ pattern</strong></code></h2> 
<p>Rust pattern 匹配可以用绑定值的单个标识符来编写，然后 <code>@</code> 一个结构更精细的 pattern ，但现在还不允许进行额外的绑定。</p> 
<pre><code class="language-rust"><span><span>struct</span> <span>Matrix</span></span> &#123;
    data: <span>Vec</span><<span>f64</span>>,
    row_len: <span>usize</span>,
&#125;
<span>// 在此之前，我们需要单独的语句来绑定</span>
<span>let</span> matrix = get_matrix();
<span>let</span> row_len = matrix.row_len;
<span>// 或者使用一个破坏性的 pattern :</span>
<span>let</span> Matrix &#123; row_len, .. &#125; = matrix;
<span>// Rust 1.56 现在可以同时绑定两个</span>
<span>let</span> matrix @ Matrix &#123; row_len, .. &#125; = get_matrix();
</code></pre> 
<p><span style="color:#2e3033">这个功能在 Rust 1.0 之前是可以用的，不过当时因为不完善而被删除了。随着版本的稳定，现在又可以使用了。</span></p> 
<h2><span style="color:#2e3033"><strong>稳定的 API</strong></span></h2> 
<p><span style="color:#000000">以下方法和特征已稳定：</span></p> 
<ul> 
 <li><code><u>std::os::unix::fs::chroot</u></code></li> 
 <li><code><u>UnsafeCell::raw_get</u></code></li> 
 <li><code><u>BufWriter::into_parts</u></code></li> 
 <li><code><u>core::panic::&#123;UnwindSafe, RefUnwindSafe, AssertUnwindSafe&#125;</u></code> (以前只在 <code>std</code> 里支持)</li> 
 <li><code><u>Vec::shrink_to</u></code></li> 
 <li><code><u>String::shrink_to</u></code></li> 
 <li><code><u>OsString::shrink_to</u></code></li> 
 <li><code><u>PathBuf::shrink_to</u></code></li> 
 <li><code><u>BinaryHeap::shrink_to</u></code></li> 
 <li><code><u>VecDeque::shrink_to</u></code></li> 
 <li><code><u>HashMap::shrink_to</u></code></li> 
 <li><code><u>HashSet::shrink_to</u></code></li> 
</ul> 
<p>下面这些之前稳定的函数现在属于 <code>const</code>.</p> 
<ul> 
 <li><code><u>std::mem::transmute</u></code></li> 
 <li><code><u>[T]::first</u></code></li> 
 <li><code><u>[T]::split_first</u></code></li> 
 <li><code><u>[T]::last</u></code></li> 
 <li><code><u>[T]::split_last</u></code></li> 
</ul> 
<h2><strong>其他变化</strong></h2> 
<p>Rust 1.56.0 版本中还有一些其他修改，详情请查看 <a href="https://www.oschina.net/action/GoToLink?url=https%3A%2F%2Fgithub.com%2Frust-lang%2Frust%2Fblob%2Fmaster%2FRELEASES.md%23version-1560-2021-10-21" target="_blank">Rust</a>、 <a href="https://www.oschina.net/action/GoToLink?url=https%3A%2F%2Fgithub.com%2Frust-lang%2Fcargo%2Fblob%2Fmaster%2FCHANGELOG.md%23cargo-156-2021-10-21" target="_blank">Cargo</a> 和 <a href="https://www.oschina.net/action/GoToLink?url=https%3A%2F%2Fgithub.com%2Frust-lang%2Frust-clippy%2Fblob%2Fmaster%2FCHANGELOG.md%23rust-156" target="_blank">Clippy</a>  。</p>
                                        </div>
                                      
</div>
            