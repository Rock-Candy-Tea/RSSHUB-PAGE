
---
title: '木兰语言 0.0.17.2 实现简易网页浏览器，又一次碰到语法歧义'
categories: 
 - 编程
 - 开源中国
 - 资讯
headimg: 'https://picsum.photos/400/300?random=4112'
author: 开源中国
comments: false
date: Mon, 03 May 2021 09:15:00 GMT
thumbnail: 'https://picsum.photos/400/300?random=4112'
---

<div>   
<div class="content">
                                                                                            <div> 
 <div> 
  <p>上周试用木兰语言加 QtWebkit 实现简易网页浏览器（<a href="https://www.oschina.net/action/GoToLink?url=https%3A%2F%2Flink.zhihu.com%2F%3Ftarget%3Dhttps%253A%2F%2Fgitee.com%2Fzhishi%2Fsimple-browser" target="_blank">已开源在 Gitee</a> ，81 行代码）时，发现需要复现带参数的 super：</p> 
  <div> 
   <pre><code class="language-python3">super(演示, self).__init__()</code></pre> 
  </div> 
  <p>实现过程中，又一次遇到了这个头疼的报错：</p> 
  <div> 
   <pre><code class="language-text">ParserGeneratorWarning: 1 shift/reduce conflict </code></pre> 
  </div> 
  <p>去年碰到过几次，都是通过照着逆向工程设置词的优先级来规避，没有深究调试方法，这次决定下点功夫搞清楚缘由。</p> 
  <p>rply 的调试信息有限，貌似 <a href="https://www.oschina.net/action/GoToLink?url=https%3A%2F%2Flink.zhihu.com%2F%3Ftarget%3Dhttps%253A%2F%2Fgithub.com%2Falex%2Frply%2Fissues%2F28" target="_blank">七年前就是如此</a>，包括 shift/reduce 在内的所有信息都极简，项目现在似乎也没有什么改进的迹象。由于它是参考 ply 重写的，于是查看了 <a href="https://www.oschina.net/action/GoToLink?url=https%3A%2F%2Flink.zhihu.com%2F%3Ftarget%3Dhttps%253A%2F%2Fply.readthedocs.io%2Fen%2Flatest%2Fply.html%2523dealing-with-ambiguous-grammars" target="_blank">ply 对歧义语法的调试信息示例</a>。纠结了一下是把木兰用 ply 重写还是修改 rply 来获得类似调试信息，决定走后者。</p> 
  <p>这里记一下：任何框架或工具，包括编程语言，可调试性——即告知用户“哪儿出错了？”——对于可用性非常非常重要。任何的反馈信息，包括警告、报错，都应以用户可理解、问题可定位、提供解决方案为首要目标。</p> 
  <p>首先，分别创建了 <a href="https://www.oschina.net/action/GoToLink?url=https%3A%2F%2Flink.zhihu.com%2F%3Ftarget%3Dhttps%253A%2F%2Fgitee.com%2FProgram-in-Chinese%2Fstudy%2Fblob%2Fmaster%2F%2525E6%25259C%2525A8%2525E5%252585%2525B0%2Fply%2F%2525E6%2525AD%2525A7%2525E4%2525B9%252589.py" target="_blank">ply</a> 和 <a href="https://www.oschina.net/action/GoToLink?url=https%3A%2F%2Flink.zhihu.com%2F%3Ftarget%3Dhttps%253A%2F%2Fgitee.com%2FProgram-in-Chinese%2Fstudy%2Fblob%2Fmaster%2F%2525E6%25259C%2525A8%2525E5%252585%2525B0%2Frply%2F%2525E5%252585%2525A5%2525E9%252597%2525A8%2F%2525E8%2525AF%2525AD%2525E6%2525B3%252595%2525E5%252588%252586%2525E6%25259E%252590%2F%2525E6%2525AD%2525A7%2525E4%2525B9%252589.py" target="_blank">rply</a> 的最简歧义演示。语法如下（ply 不支持在语法定义中使用中文标识符，下面是 rply 的表示）：</p> 
  <div> 
   <pre><code class="language-bnf">表达式 : 数
表达式 : 表达式 减 表达式 </code></pre> 
  </div> 
  <p>测试表达式为 <code>2 - 3 - 4</code>。在没有优先级设置时，会报警：<code>1 shift/reduce conflict</code> 而且输出：3</p> 
  <p>在 ply 的 parser.out 文件中，可以看到进一步细节：</p> 
  <div> 
   <pre><code class="language-text">state 4

    (1) expression -> expression MINUS expression .
    (1) expression -> expression . MINUS expression

  ! shift/reduce conflict for MINUS resolved as shift
    $end            reduce using rule 1 (expression -> expression MINUS expression .)
    MINUS           shift and go to state 3

  ! MINUS           [ reduce using rule 1 (expression -> expression MINUS expression .) ] </code></pre> 
  </div> 
  <p>根据 <a href="https://www.oschina.net/action/GoToLink?url=https%3A%2F%2Flink.zhihu.com%2F%3Ftarget%3Dhttps%253A%2F%2Fply.readthedocs.io%2Fen%2Flatest%2Fply.html%2523the-parser-out-file" target="_blank">ply 官方文档</a>，可以估摸出是第二个减号有歧义，可以先将 2-3 化简为“expression”，也可以将减号接在 3 后面，作为 <code>expression . MINUS expression</code> 的一部分。在有此类歧义时，默认 shift 而不化简。因此，待 3-4 都解析完后化为 expression，求值为 -1，再将 2-(-1) 化简求值为 3。</p> 
  <p>这里注意到，这个报警信息与具体的测试表达式无关。在语法分析器生成时，会根据语法定义生成所有可能的语法要素序列，在此基础上发现所有歧义。另一方面也好奇，是否能够进一步生成能够复现歧义的表达式用例，这样应该可以更方便开发者调试吧。</p> 
  <p>接下来，就是在 rply 源码内加入调试信息输出（<a href="https://www.oschina.net/action/GoToLink?url=https%3A%2F%2Flink.zhihu.com%2F%3Ftarget%3Dhttps%253A%2F%2Fgithub.com%2Fnobodxbodon%2Frply%2Ftree%2F%2525E8%2525B0%252583%2525E8%2525AF%252595" target="_blank">开源在此</a>）。可以看到下面的 5 个序列：</p> 
  <div> 
   <pre><code class="language-text">0[LRItem(S' -> . 表达式), LRItem(表达式 -> . 数), LRItem(表达式 -> . 表达式 减 表达式)]
1[LRItem(表达式 -> 数 .)]
2[LRItem(S' -> 表达式 .), LRItem(表达式 -> 表达式 . 减 表达式)]
3[LRItem(表达式 -> 表达式 减 . 表达式), LRItem(表达式 -> . 数), LRItem(表达式 -> . 表达式 减 表达式)]
4[LRItem(表达式 -> 表达式 减 表达式 .), LRItem(表达式 -> 表达式 . 减 表达式)] </code></pre> 
  </div> 
  <p>以及歧义相关的序列和词：4 》》 '减'，即：<code>4[LRItem(表达式 -> 表达式 减 表达式 .), LRItem(表达式 -> 表达式 . 减 表达式)]</code> 中的减号，句点含义与 ply 中相同，这样包含的信息已接近了 ply 的。</p> 
  <p>回头看 super 语法，整理后的输出如下：</p> 
  <div> 
   <pre><code class="language-text">词'('有歧义，默认进行 shift2
歧义序列：
        超类: super .
        超类: super . 实参部分
        实参部分: . ( )
        实参部分: . ( 各实参 ) </code></pre> 
  </div> 
  <p>仍然看不大清，简化了 <code>实参部分</code> 语法后，仍然有歧义：</p> 
  <div> 
   <pre><code class="language-text">词'('有歧义，默认进行 shift2
歧义序列：
        超类: super .
        超类: super . 实参部分
        实参部分: . ( ) </code></pre> 
  </div> 
  <p>继续简化：</p> 
  <div> 
   <pre><code class="language-text">词'('有歧义，默认进行 shift2
歧义序列：
        超类: super .
        超类: super . ( ) </code></pre> 
  </div> 
  <p>到这里看出，其实很简单，没有优先级设置时，<code>super()</code> 有两种解析方式：</p> 
  <table> 
   <tbody> 
    <tr> 
     <th>步骤</th> 
     <th>符号栈</th> 
     <th>词输入</th> 
     <th>行为</th> 
    </tr> 
    <tr> 
     <td>1</td> 
     <td> </td> 
     <td>super ( )</td> 
     <td>移入 super</td> 
    </tr> 
    <tr> 
     <td>2</td> 
     <td>super</td> 
     <td>( )</td> 
     <td> <p>歧义：<br> 1）根据 超类: super，可以直接消减（reduce）为 超类</p> <p>2） 根据 超类: super ( )，可以移入 (</p> </td> 
    </tr> 
   </tbody> 
  </table> 
  <p>问题确定之后，就是如何确定优先级高低，待继续研究。</p> 
 </div> 
</div>
                                        </div>
                                      
</div>
            