
---
title: '.NET 7 已发布第三个预览版'
categories: 
 - 编程
 - 开源中国
 - 资讯
headimg: 'https://oscimg.oschina.net/oscnet/up-8b440d3ce608cc276cb8989bbe4a349de31.png'
author: 开源中国
comments: false
date: Fri, 15 Apr 2022 07:43:00 GMT
thumbnail: 'https://oscimg.oschina.net/oscnet/up-8b440d3ce608cc276cb8989bbe4a349de31.png'
---

<div>   
<div class="content">
                                                                                            <p>.NET 7 Preview 3 <a href="https://www.oschina.net/action/GoToLink?url=https%3A%2F%2Fgithub.com%2Fdotnet%2Fcore%2Fblob%2Fmain%2Frelease-notes%2F7.0%2Fpreview%2F7.0.0-preview.3.md" target="_blank">已发布</a>， .NET 7 的第三个预览版包括对可观察性、启动时间、代码生成、GC 区域、Native AOT 编译等方面的增强。</p> 
<h2>Native AOT 编译</h2> 
<p>Native AOT 的主要优势在于启动时间、内存使用、访问受限平台（不允许 JIT）以及磁盘空间更小。Preview 3 版本对 Native AOT 性能进行了优化更新，以下是最新的 Native AOT 性能（与现有的 AOT 编译 “ReadyToRun” 对比）：</p> 
<p><img height="266" src="https://oscimg.oschina.net/oscnet/up-8b440d3ce608cc276cb8989bbe4a349de31.png" width="500" referrerpolicy="no-referrer"></p> 
<p>接下来的几个 .NET 版本将<strong>持续改进 </strong>Native AOT 兼容性，且将在 dotnet SDK 中添加一流的支持（<span style="background-color:#ffffff; color:#333333">Crossgen 应用程序</span>），以支持使用 Native AOT 发布项目。</p> 
<h3><span><span><span><span><span><span style="color:#333333"><span><span><span><span><span><span><span><span><span><span style="background-color:#ffffff"><span><span><span>可观察性</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></h3> 
<p style="text-align:left"><span><span><span><span><span style="color:#333333"><span><span><span><span><span><span><span><span><span><span><span><span style="background-color:#ffffff"><span><span><span>.NET 7 继续发展对云原生 OpenTelemetry 规范的支持。预览版 3 添加了对规范更新的支持 （<a href="https://www.oschina.net/action/GoToLink?url=https%3A%2F%2Fgithub.com%2Fopen-telemetry%2Fopentelemetry-specification%2Fpull%2F988" target="_blank">#988</a> 和 <a href="https://www.oschina.net/action/GoToLink?url=https%3A%2F%2Fgithub.com%2Fopen-telemetry%2Fopentelemetry-dotnet%2Fissues%2F1708" target="_blank">#1708</a>），使得跟踪状态对于采样器可变。</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></p> 
<ul> 
 <li><a href="https://www.oschina.net/action/GoToLink?url=https%3A%2F%2Fgithub.com%2Fdotnet%2Fruntime%2Fpull%2F65530" target="_blank">允许跟踪采样器修改活动跟踪状态</a></li> 
</ul> 
<pre><span><span><span><span><span style="color:#212529"><span style="background-color:#f0f0f0 !important"><span><span><span><span><span><span><span><span><code class="language-C#"> <span><span style="color:#008800"><span><span style="color:#008800">// ActivityListener Sampling callback</span></span></span></span><span><span style="color:#000000"><span><span style="color:#000000"> listener</span></span></span></span><span><span style="color:#000000"><span><span style="color:#000000">.</span></span></span></span><span><span style="color:#660066"><span><span style="color:#660066">Sample</span></span></span></span> <span><span style="color:#000000"><span><span style="color:#000000">=</span></span></span></span> <span><span style="color:#000000"><span><span style="color:#000000">(</span></span></span></span><span><span style="color:#1e1eff"><span><span style="color:#1e1eff">ref</span></span></span></span> <span><span style="color:#660066"><span><span style="color:#660066">ActivityCreationOptions</span></span></span></span><span><span style="color:#000000"><span><span style="color:#000000"><</span></span></span></span><span><span style="color:#660066"><span><span style="color:#660066">ActivityContext</span></span></span></span><span><span style="color:#000000"><span><span style="color:#000000">></span></span></span></span><span><span style="color:#000000"><span><span style="color:#000000"> activityOptions</span></span></span></span><span><span style="color:#000000"><span><span style="color:#000000">)</span></span></span></span> <span><span style="color:#000000"><span><span style="color:#000000">=></span></span></span></span> <span><span style="color:#000000"><span><span style="color:#000000">&#123;</span></span></span></span><span><span style="color:#000000"><span><span style="color:#000000"> activityOptions </span></span></span></span><span><span style="color:#000000"><span><span style="color:#000000">=</span></span></span></span><span><span style="color:#000000"><span><span style="color:#000000"> activityOptions </span></span></span></span><span><span style="color:#1e1eff"><span><span style="color:#1e1eff">with</span></span></span></span> <span><span style="color:#000000"><span><span style="color:#000000">&#123;</span></span></span></span> <span><span style="color:#660066"><span><span style="color:#660066">TraceState</span></span></span></span> <span><span style="color:#000000"><span><span style="color:#000000">=</span></span></span></span> <span><span style="color:#980606"><span><span style="color:#980606">"rojo=00f067aa0ba902b7"</span></span></span></span> <span><span style="color:#000000"><span><span style="color:#000000">&#125;;</span></span></span></span> <span><span style="color:#1e1eff"><span><span style="color:#1e1eff">return</span></span></span></span> <span><span style="color:#660066"><span><span style="color:#660066">ActivitySamplingResult</span></span></span></span><span><span style="color:#000000"><span><span style="color:#000000">.</span></span></span></span><span><span style="color:#660066"><span><span style="color:#660066">AllDataAndRecorded</span></span></span></span><span><span style="color:#000000"><span><span style="color:#000000">;</span></span></span></span> <span><span style="color:#000000"><span><span style="color:#000000">&#125;;</span></span></span></span></code></span></span></span></span></span></span></span></span></span></span></span></span></span></span></pre> 
<h3><span><span><span><span><span><span style="color:#333333"><span><span><span><span><span><span><span><span><span><span style="background-color:#ffffff"><span><span><span>改进启动时间</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></h3> 
<p style="text-align:left"><span><span><span><span><span style="color:#333333"><span><span><span><span><span><span><span><span><span><span><span><span style="background-color:#ffffff"><span><span><span>性能仍然是 .NET 7 的主要关注点<a href="https://www.oschina.net/action/GoToLink?url=https%3A%2F%2Fgithub.com%2Fdotnet%2Fruntime%2Fpull%2F65738" target="_blank">。dotnet/runtime#65738 PR</a> </span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span><span style="color:#333333"><span><span><span><span><span><span><span><span><span><span style="background-color:#ffffff"><span><span><span>，</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span style="color:#333333"><span><span><span><span><span><span><span><span><span><span><span><span style="background-color:#ffffff"><span><span><span>重新实现了预代码和调用计数存根（使用分层编译帮助程序存根），可显著减少运行时中创建后再修改的可执行代码数量。</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></p> 
<p style="text-align:left"><span><span><span><span><span style="color:#333333"><span><span><span><span><span><span><span><span><span><span><span><span style="background-color:#ffffff"><span><span><span>启用该 Write-Xor-Execute 新功能可缩短 10-15% 启动时间。即使没有启用 Write-Xor-Execute，此更改也带来了一些微基准测试和一些 ASPNet 基准测试的稳态性能提高（高达 8%）。</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></p> 
<h3><span><span><span><span><span><span style="color:#333333"><span><span><span><span><span><span><span><span><span><span style="background-color:#ffffff"><span><span><span>循环优化</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></h3> 
<ul> 
 <li><a href="https://www.oschina.net/action/GoToLink?url=https%3A%2F%2Fgithub.com%2Fdotnet%2Fruntime%2Fpull%2F66257" target="_blank">循环克隆</a> 功能将 System.Collections.Tests.Perf_BitArray.BitArrayLeftShift(Size: 512) 的单次调用持续时间提高了 21%：</li> 
</ul> 
<p><img alt height="230" src="https://oscimg.oschina.net/oscnet/up-3b0bbe64a412cc0e20b51d1d4791dea7bbe.png" width="700" referrerpolicy="no-referrer"></p> 
<h3><span><span><span><span><span><span style="color:#333333"><span><span><span><span><span><span><span><span><span><span style="background-color:#ffffff"><span><span><span>默认启用 GC 区域</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></h3> 
<p style="text-align:left"><span><span><span><span><span style="color:#333333"><span><span><span><span><span><span><span><span><span><span><span><span style="background-color:#ffffff"><span><span><span>在 Preview 3 中，除了 MacOS 和 NativeAOT 之外的所有平台都默认启用 </span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span><span><span><span style="color:#24292f"><span><span><span><span><span><span><span><span><span><span><span style="background-color:#ffffff"><span><span><span><span>GC 区域</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span style="color:#333333"><span><span><span><span><span><span><span><span><span><span><span><span style="background-color:#ffffff"><span><span><span>功能，该功能有助于提升高吞吐量应用程序的内存利用率。</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></p> 
<p style="text-align:left"><span><span><span><span><span style="color:#333333"><span><span><span><span><span><span><span><span><span><span><span><span style="background-color:#ffffff"><span><span><span>有关 GC 区域功能的详细信息可在该 <a href="https://www.oschina.net/action/GoToLink?url=https%3A%2F%2Fgithub.com%2Fdotnet%2Fruntime%2Fissues%2F43844" target="_blank">Issue 中查看</a>。</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></p> 
<h2><span><span><span><span><span style="color:#333333"><span><span><span><span><span><span><span><span><span><span><span><span style="background-color:#ffffff"><span><span><span>代码生成</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></h2> 
<p style="text-align:left"><span style="background-color:#ffffff; color:#333333">该版本对代码生成和 JIT 编译进行了多项优化和错误修复，比如</span></p> 
<ul> 
 <li><a href="https://www.oschina.net/action/GoToLink?url=https%3A%2F%2Fgithub.com%2Fdotnet%2Fruntime%2Fpull%2F66282" target="_blank">为 ARM32 启用快速尾调用优化</a></li> 
 <li><a href="https://www.oschina.net/action/GoToLink?url=https%3A%2F%2Fgithub.com%2Fdotnet%2Fruntime%2Fpull%2F62818" target="_blank">将“X & 1 == 1”优化为“X & 1” (#61412)</a></li> 
 <li><a href="https://www.oschina.net/action/GoToLink?url=https%3A%2F%2Fgithub.com%2Fdotnet%2Fruntime%2Fpull%2F65257" target="_blank">ZeroObj 断言</a></li> 
 <li><a href="https://www.oschina.net/action/GoToLink?url=https%3A%2F%2Fgithub.com%2Fdotnet%2Fruntime%2Fpull%2F65302" target="_blank">去重 HWI 代码生成代码</a></li> 
 <li><a href="https://www.oschina.net/action/GoToLink?url=https%3A%2F%2Fgithub.com%2Fdotnet%2Fruntime%2Fpull%2F65387" target="_blank">在 x86 上对 8/12 字节结构参数使用 push</a> </li> 
</ul> 
<p>...</p> 
<p style="text-align:left"> </p> 
<p style="text-align:left">更多内容可在<a href="https://www.oschina.net/action/GoToLink?url=https%3A%2F%2Fdevblogs.microsoft.com%2Fdotnet%2Fannouncing-dotnet-7-preview-3%2F" target="_blank">官方博客</a>中查看。</p>
                                        </div>
                                      
</div>
            