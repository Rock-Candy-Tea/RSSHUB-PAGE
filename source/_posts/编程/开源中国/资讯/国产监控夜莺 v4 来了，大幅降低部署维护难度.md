
---
title: '国产监控夜莺 v4 来了，大幅降低部署维护难度'
categories: 
 - 编程
 - 开源中国
 - 资讯
headimg: 'https://static.oschina.net/uploads/space/2021/0416/154849_I6RU_4252687.png'
author: 开源中国
comments: false
date: Fri, 16 Apr 2021 15:28:00 GMT
thumbnail: 'https://static.oschina.net/uploads/space/2021/0416/154849_I6RU_4252687.png'
---

<div>   
<div class="content">
                                                                                            <p>​大家好，经过2个月的开发，夜莺v4来了，欢迎大家试用。本文为大家介绍一下开发v4的背景、最新模块组成、升级建议，同时演示一下单机快速部署的方式。如果朋友是第一次尝试夜莺，可以按照后面讲解的部署方式来搞，5分钟搞定。</p> 
<p><span style="color:#ff4c41"><strong>演进背景</strong></span></p> 
<p>v3版本融入了很多运维平台的功能，组件变多，部署麻烦，不同的组件相互之间有调用关系，在做分布式部署的时候需要了解整体架构才能正确修改配置文件，对用户提出了较高的要求。很多issue和群里的讨论，都反映出了这个复杂性问题。</p> 
<p>我们希望降低这个复杂度，所以，把众多服务端模块做了合并。这样原来组件之间的调用都变成了进程内部的方法调用，可靠性性能都会提升。</p> 
<p><span style="color:#ff4c41"><strong>新的架构</strong></span></p> 
<p>模块合并之后，把时序存储抽离，总共只剩3个组件：server、prober、agentd。</p> 
<p>服务端就是部署server模块，如果要集群部署，就搞2个机器，每个机器分别部署server模块即可。每个server会使用本机的redis，所以，有几个server就部署几个redis，redis只需监听在127.0.0.1，供本机的server使用即可。</p> 
<p>prober是个中心式探针，比如贵司有2个网络区域，每个网络区域可以部署一个prober，用此prober采集监控本区域的数据库中间件。如果担心prober挂掉，每个区域可以部署多个prober做高可用。不同网络区域的prober，有个配置要注意，即：report.region字段，比如有bj和gz两个网络区域，每个网络区域分别部署了2台prober，bj的2台prober，report.region要设置为bj，gz的2台prober，report.region要设置为gz。最后，在server.yml里修改monapi.region字段，配上bj和gz。</p> 
<p>如果网络是可以互联互通的，那就简单了，prober和server混部即可，都放到中心。</p> 
<p>agentd是部署到所有目标机器的，采集目标机器的性能指标，在目标机器执行插件之类的，v4版本的agentd与server之间通信只走了server的rpc端口，所以相比v3，开通网络acl要变简单了。</p> 
<p><span style="color:#ff4c41"><strong>升级建议</strong></span></p> 
<p>如果v2、v3已经玩得很溜了，并且满足贵司的需求，就不建议升级了。当然，如果新版本有些功能特别想要，那就只能升级了。</p> 
<p>如果时序库是使用的tsdb+index这个方案，tsdb进程不用动，可以复用v3的，但是index需要升级。tsdb+index这俩模块的代码抽取到了github.com/n9e/n9e-tsdb中了，编译方法和二进制最新地址都可以在这个repo的README中找到。</p> 
<p>server.yml默认使用m3作为存储后端，所以，如果使用tsdb+index的方案，需要修改server.yml，把DataSource改成使用tsdb。</p> 
<p>不过我个人建议大家尝试一下m3db，容灾、扩容都做的很方便。</p> 
<p><span style="color:#ff4c41"><strong>快速部署</strong></span></p> 
<p>这里我带着大家部署一个单机版本的夜莺v4，请大家提前准备好mysql、redis、nginx，单机部署，直接yum安装即可，非常简便。<span style="color:#ff4c41">请找一台干净的机器测试！</span></p> 
<p>1、下载二进制</p> 
<pre><code>mkdir -p /home/n9e</code><code>cd /home/n9e</code><code>wget http://116.85.64.82/n9e-4.0.0.tar.gz</code><code>tar zxvf n9e.tar.gz</code></pre> 
<p>2、初始化数据库，这里假设使用 root 账号，密码为 1234，如果不是这个账号密码，需要修改 /home/n9e/etc/mysql.yml</p> 
<pre><code>cd /home/n9e/sql</code><code>mysql -uroot -p1234 < n9e_ams.sql</code><code>mysql -uroot -p1234 < n9e_hbs.sql</code><code>mysql -uroot -p1234 < n9e_job.sql</code><code>mysql -uroot -p1234 < n9e_mon.sql</code><code>mysql -uroot -p1234 < n9e_rdb.sql</code></pre> 
<p>3、redis请不要配置密码， 如果redis设置了密码，需要修改/home/n9e/etc/server.yml，把密码改对</p> 
<p>4、下载前端静态资源文件，放到/home/n9e下，请不要随意更换目录结构，否则还要自行修改nginx.conf，徒增烦恼</p> 
<pre><code>cd /home/n9e</code><code>wget http://116.85.64.82/pub-3.5.2.tar.gz</code><code>tar zxvf pub.tar.gz</code></pre> 
<p>5、覆盖nginx.conf。如果静态资源文件不是放到/home/n9e下的，就要先修改nginx.conf了</p> 
<pre><code>cp etc/nginx.conf /etc/nginx/nginx.conf</code><code>systemctl restart nginx</code></pre> 
<p>6、时序数据存储部署，这里选择使用单机版本的m3db</p> 
<pre><code>mkdir -p /home/m3db</code><code>cd /home/m3db</code><code>wget https://s3-gz01.didistatic.com/n9e-pub/tarball/m3dbnode-single-v0.0.1.tar.gz</code><code>​</code><code>tar zxvf m3dbnode-single-v0.0.1.tar.gz</code><code>cd m3dbnode-single</code><code>./scripts/install.sh</code><code>​</code><code># retentionTime 表示历史监控数据存储时长，使用m3一般建议最长不要超过3个月</code><code>curl -X POST http://localhost:7201/api/v1/database/create -d '&#123;</code><code>  "type": "local",</code><code>  "namespaceName": "default",</code><code>  "retentionTime": "48h"</code><code>&#125;'</code></pre> 
<p>7、最后一步，启动相关进程。即可访问nginx看效果了</p> 
<pre><code>cd /home/n9e</code><code>./control start server</code><code>./control start prober</code><code>./control start agentd</code></pre> 
<p>效果图如下：</p> 
<p><img height="352" src="https://static.oschina.net/uploads/space/2021/0416/154849_I6RU_4252687.png" width="700" referrerpolicy="no-referrer"></p>
                                        </div>
                                      
</div>
            