
---
title: 'Rust 1.59.0 稳定版发布，正式支持内联汇编'
categories: 
 - 编程
 - 开源中国
 - 资讯
headimg: 'https://picsum.photos/400/300?random=8516'
author: 开源中国
comments: false
date: Sat, 26 Feb 2022 07:19:00 GMT
thumbnail: 'https://picsum.photos/400/300?random=8516'
---

<div>   
<div class="content">
                                                                                            <p>Rust 1.59.0 稳定版<a href="https://www.oschina.net/action/GoToLink?url=https%3A%2F%2Fblog.rust-lang.org%2F2022%2F02%2F24%2FRust-1.59.0.html" target="_blank">已正式发布</a>，新版本最值得关注的特性是支持在代码中内联汇编 (Inline assembly)，其他变化包括：引入解构式赋值、默认关闭增量编译，以及 Const 泛型参数支持设置默认值等。</p> 
<h3 style="text-align:start">内联汇编 (Inline assembly)</h3> 
<p>此项特性的使用场景主要是<strong>控制底层执行</strong>，或者<strong>访问特定的机器指令</strong>。</p> 
<p>例如面向 x86-64 目标平台进行编译时，可以用以下的方式编写代码：</p> 
<pre><code>use std::arch::asm;

// Multiply x by 6 using shifts and adds
let mut x: u64 = 4;
unsafe &#123;
    asm!(
        "mov &#123;tmp&#125;, &#123;x&#125;",
        "shl &#123;tmp&#125;, 1",
        "shl &#123;x&#125;, 2",
        "add &#123;x&#125;, &#123;tmp&#125;",
        x = inout(reg) x,
        tmp = out(reg) _,
    );
&#125;
assert_eq!(x, 4 * 6);</code></pre> 
<p>可以看到，此处格式化字符串的语法与 Rust 格式化字符串中使用的相同，除了<code>asm!</code>，<code>global_asm!</code><span style="background-color:#ffffff; color:#000000">宏也支持这种用法。</span></p> 
<p>内联汇编中使用的汇编语言和指令取决于目标架构。目前 Rust 编译器支持以下架构的内联汇编：</p> 
<ul> 
 <li>x86 & x86-64</li> 
 <li>ARM</li> 
 <li>AArch64</li> 
 <li>RISC-V</li> 
</ul> 
<p>点此查看 <a href="https://www.oschina.net/action/GoToLink?url=https%3A%2F%2Fdoc.rust-lang.org%2Fnightly%2Frust-by-example%2Funsafe%2Fasm.html" target="_blank">更多示例</a> 和 <span style="color:#000000"><a href="https://www.oschina.net/action/GoToLink?url=https%3A%2F%2Fdoc.rust-lang.org%2Fnightly%2Freference%2Finline-assembly.html" target="_blank">文档</a>。</span></p> 
<h3>解构式赋值 (Destructuring assignments)</h3> 
<p><span style="background-color:#ffffff; color:#000000">通过此项特性，</span><span style="background-color:#ffffff; color:#121212">支持在赋值语句的左侧等式使用元组、切片和结构体模式 (</span>struct patterns<span style="background-color:#ffffff; color:#121212">)。</span></p> 
<pre><code>let (a, b, c, d, e);

(a, b) = (1, 2);
[c, .., d, _] = [1, 2, 3, 4, 5];
Struct &#123; e, .. &#125; = Struct &#123; e: 5, f: 3 &#125;;

assert_eq!([1, 2, 1, 4, 5], [a, b, c, d, e]);</code></pre> 
<p>不过要注意使用<span> </span><code>+=</code>运算符的赋值语句尚未支持解构式赋值。</p> 
<h3 style="text-align:start">Const 泛型参数支持设置默认值</h3> 
<p style="color:#000000; text-align:start">支持为 Const 泛型参数设置默认值，如下：</p> 
<pre><code>struct ArrayStorage<T, const N: usize = 2> &#123;
    arr: [T; N],
&#125;

impl<T> ArrayStorage<T> &#123;
    fn new(a: T, b: T) -> ArrayStorage<T> &#123;
        ArrayStorage &#123;
            arr: [a, b],
        &#125;
    &#125;
&#125;</code></pre> 
<p>在此前的版本中，类型参数必须要放在所有 const 参数之前，目前此限制已放宽，支持将它们交替排列使用。</p> 
<pre><code>fn cartesian_product<
    T, const N: usize,
    U, const M: usize,
    V, F
>(a: [T; N], b: [U; M], f: F) -> [[V; N]; M]
where
    F: FnMut(&T, &U) -> V
&#123;
    // ...
&#125;</code></pre> 
<h3 style="text-align:start">默认关闭增量编译</h3> 
<p style="color:#121212; margin-left:0; margin-right:0; text-align:start">Rust 1.59.0 版本已默认禁用增量编译功能（可通过环境变量显式地启用：<code>RUSTC_FORCE_INCREMENTAL=1</code><span> </span>)，此项变更降低了已知 bug<span> </span><a href="https://www.oschina.net/action/GoToLink?url=https%3A%2F%2Flink.zhihu.com%2F%3Ftarget%3Dhttps%253A%2F%2Fgithub.com%2Frust-lang%2Frust%2Fissues%2F94124" target="_blank">#94124</a><span> </span>的影响，该 bug 会导致在增量编译过程中引发反序列化错误和 panic。</p> 
<p style="color:#121212; margin-left:0; margin-right:0; text-align:start">开发团队表示，他们会在 1.60.0 版本修复这个 bug（六周内），届时如果没有出现意外问题，增量编译会重新设置为默认启用。</p> 
<h3 style="margin-left:0px; margin-right:0px; text-align:start">稳定的 API 列表</h3> 
<p style="color:#121212; margin-left:0; margin-right:0; text-align:start">部分方法和 <span style="background-color:#ffffff; color:#000000">trait<span> 实现已稳定化，<a href="https://www.oschina.net/action/GoToLink?url=https%3A%2F%2Fblog.rust-lang.org%2F2022%2F02%2F24%2FRust-1.59.0.html%23stabilized-apis" target="_blank">点此查看详情</a>。</span></span></p> 
<p>下载地址：<a href="https://www.oschina.net/action/GoToLink?url=https%3A%2F%2Fgithub.com%2Frust-lang%2Frust%2Freleases%2Ftag%2F1.59.0" target="_blank">https://github.com/rust-lang/rust/releases/tag/1.59.0</a></p>
                                        </div>
                                      
</div>
            