
---
title: '木兰语言 0.0.17.1：源码生成支持更多函数、类相关语法'
categories: 
 - 编程
 - 开源中国
 - 资讯
headimg: 'https://picsum.photos/400/300?random=4165'
author: 开源中国
comments: false
date: Wed, 21 Apr 2021 08:34:00 GMT
thumbnail: 'https://picsum.photos/400/300?random=4165'
---

<div>   
<div class="content">
                                                                    
                                                        <p>这几个星期继续重现由 Python 语法树生成木兰源码的功能（0.0.17.1 已发布在 PyPI，可通过 pip install ulang 安装）：</p> 
<ul> 
 <li>单参数、多参数、带默认值参数函数定义</li> 
 <li>类、类方法、构造方法、嵌套类、扩展类</li> 
 <li>引用属性、类方法</li> 
</ul> 
<p>如下 Python 代码：</p> 
<div> 
 <pre><code class="language-python3">class C1:
    class C2:
        def __init__(self):
            print(2)

    def __init__(self):
        print(1)
C1()
C1.C2()</code></pre> 
</div> 
<p>可生成木兰源码：</p> 
<div> 
 <pre><code class="language-js">type C1 &#123;


  type C2 &#123;

    func $C2() &#123;
      println(2)
    &#125;
  &#125;

  func __init__(self) &#123;
    println(1)
  &#125;
&#125;
C1()
C1.C2()
</code></pre> 
</div> 
<p>期间发现了一些费解之处。比如上面的第二个 <code>__init__</code>，为何不转换为 <code>$C1</code> 呢？</p> 
<p>还有更明显的问题，比如对变长指名参数：</p> 
<div> 
 <pre><code class="language-python3">def a(**kwargs):
    print(kwargs)

a(k1="v1", k2="v2")</code></pre> 
</div> 
<p><a href="https://www.oschina.net/action/GoToLink?url=https%3A%2F%2Flink.zhihu.com%2F%3Ftarget%3Dhttps%253A%2F%2Fgithub.com%2FMulanRevive%2Fbounty%2Ftree%2Fmaster%2F%2525E5%25258E%25259F%2525E5%2525A7%25258B%2525E8%2525B5%252584%2525E6%252596%252599%2F%2525E5%25258F%2525AF%2525E6%252589%2525A7%2525E8%2525A1%25258C%2525E6%252596%252587%2525E4%2525BB%2525B6" target="_blank">原始木兰可执行文件</a> 转换时就会报错：</p> 
<div> 
 <pre><code class="language-text">TypeError: can only concatenate str (not "arg") to str </code></pre> 
</div> 
<p>又如属性方法：</p> 
<div> 
 <pre><code class="language-python3">class C:
    @property
    def m(self):
        print(0)

    @m.setter
    def m(self, value):
        print(1)</code></pre> 
</div> 
<p>转换时也会报错：</p> 
<div> 
 <pre><code class="language-text">NameError: name 'decorator_list' is not defined </code></pre> 
</div> 
<p>这些问题都已在重现项目中原样复现，原因写在源码注释中。</p> 
<p>综上，至此个人感觉此部分由 Python 生成木兰源码的功能的打磨程度不及语法解析部分。也许是因为此功能当时尚未在学校教学中大规模应用。</p> 
<p>另外，为调试方便，添加了新命令行选项“--语法树”，用于显示源码的对应语法树。</p> 
<hr> 
<h3><em><strong>附：代码量统计</strong></em></h3> 
<p>主要部分的代码行数统计，格式为：上次->现在。</p> 
<ul> 
 <li>木兰代码量，提取儿歌部分代码到 <a href="https://www.oschina.net/action/GoToLink?url=https%3A%2F%2Flink.zhihu.com%2F%3Ftarget%3Dhttps%253A%2F%2Fgitee.com%2Fzhishi%2Fsongs-for-kids" target="_blank">此单独项目</a> 3324 -> 3050 
  <ul> 
   <li>运行环境，实现与测试大部为木兰代码：582</li> 
   <li>木兰测试用例，包括部分实用小程序（如井字棋）：2742 -> 2468 (报错信息测试用例替代了源码中的注释)</li> 
  </ul> </li> 
</ul> 
<p> </p> 
<ul> 
 <li>Python 代码量（木兰实现与测试框架）：2934 -> 3381 
  <ul> 
   <li><code>生成/木兰.py</code>：206</li> 
   <li><code>功用/反馈信息.py</code>：81 -> 175</li> 
   <li><code>环境.py</code>，定义全局方法： 174 -> 175</li> 
   <li><code>中.py</code>，主程序：74 -> 95</li> 
   <li><code>分析器/错误.py</code>：26 -> 28</li> 
   <li>未变 
    <ul> 
     <li><code>分析器/语法分析器.py</code>：1049</li> 
     <li><code>分析器/语法树.py</code>：225</li> 
     <li><code>分析器/词法分析器.py</code>：216</li> 
     <li><code>交互.py</code>，交互环境（REPL）：148</li> 
     <li><code>测试/期望值表.py</code>：144</li> 
     <li><code>测试/unittest/报错.py</code>：124</li> 
     <li><code>分析器/语法树处理.py</code>：91</li> 
     <li><code>分析器/语法成分.py</code>，从语法分析器中提取出来的枚举常量：85</li> 
     <li><code>测试/运行所有.py</code>，检验所有木兰测试代码片段：71</li> 
     <li><code>测试/unittest/生成.py</code>，语法树生成木兰源码相关测试：60</li> 
     <li><code>测试/unittest/语法树.py</code>，确保生成的语法树与原始版本一致，拆分报错部分：58</li> 
     <li><code>功用/调试辅助.py</code>，：57</li> 
     <li><code>setup.py</code>, 34</li> 
     <li><code>测试/unittest/交互.py</code>，交互环境相关测试：28</li> 
     <li><code>测试/unittest/所有用例.py</code>：24</li> 
    </ul> </li> 
  </ul> </li> 
</ul>
                                        </div>
                                      
</div>
            