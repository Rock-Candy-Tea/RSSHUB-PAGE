
---
title: 'GitHub Action + ACK：云原生 DevOps 落地利器'
categories: 
    - 编程
    - segmentfault
    - 用户

author: segmentfault
comments: false
date: 2021-03-22 18:34:00
thumbnail: 'https://segmentfault.com/img/remote/1460000039418977'
---

<div>   
<p><strong>简介：</strong> 据信通院《中国 DevOps 现状调查报告（2020年）》显示，63% 的企业已经实践落地 DevOps，采用持续交付流水线打通开发、测试、部署和运维多个环节。但是依然有 20% 的企业反馈实践 DevOps 复杂，自建 Jenkins 需要自部署及插件运维，而 SaaS 化 CI/CD 工具又配置繁琐，希望有更轻量便捷的工具加速其转型落地。</p><p><span class="img-wrap"><img class="lazy" src="https://segmentfault.com/img/remote/1460000039418977" alt="头图.png" title="头图.png" referrerpolicy="no-referrer"></span></p><p>作者 | 瑶靖<br>来源 | <a href="https://mp.weixin.qq.com/s/dcz724OxHDhsqufJ3s92-A" rel="nofollow">阿里巴巴云原生公众号</a></p><p>据信通院<a href="https://max.book118.com/html/2020/0827/7055160101002163.shtm" rel="nofollow">《中国 DevOps 现状调查报告（2020年）》</a>显示，63% 的企业已经实践落地 DevOps，采用持续交付流水线打通开发、测试、部署和运维多个环节。但是依然有 20% 的企业反馈实践 DevOps 复杂，自建 Jenkins 需要自部署及插件运维，而 SaaS 化 CI/CD 工具又配置繁琐，希望有更轻量便捷的工具加速其转型落地。</p><p>目前，阿里云与 GitHub 联合发布了快速部署至阿里云 ACK 的 GitHub Action Workflow。无需再自建部署维护 CI/CD 工具，基于开箱即用的 GitHub Action 及阿里云部署模板，即可实现 GitHub 代码变更后，自动应用打包构建上传阿里云容器镜像服务 ACR、快速部署至阿里云容器服务 ACK 的流程。本文将从 GitHub Action、阿里云容器服务及实践 Demo 来为您详细介绍。</p><p><span class="img-wrap"><img class="lazy" src="https://segmentfault.com/img/remote/1460000039418980" alt="1.jpg" title="1.jpg" referrerpolicy="no-referrer"></span></p><p>图 1 - GitHub Action 支持阿里云部署模板</p><h1>GitHub 与阿里云联合发布 GitHub Action Workflow</h1><ol><li>关于 GitHub Acticon</li></ol><hr><p><span class="img-wrap"><img class="lazy" src="https://segmentfault.com/img/remote/1460000039418976" alt="2.jpg" title="2.jpg" referrerpolicy="no-referrer"></span><br>图 2 - GitHub Action 首页</p><p><a href="https://github.com/features/actions" rel="nofollow">GitHub Action</a> 是 GitHub 2018 年 10 月推出的内置持续集成工具，简化自动化构建、测试、部署的流程。GitHub Action 通过将持续集成的原子操作封装成 Actions，再基于 Workflow 流程定义，将多个 Action 组装成可复用的模板，实现 GitHub 事件更新后自动触发执行 Action 流程。</p><p>GitHub Action 有以下特点：</p><ul><li><strong>开箱即用</strong>：GitHub Action 是 SaaS 化托管服务，可通过申明指定在 GitHub VM 或者容器内部执行任务，保障业务高峰时期的弹性扩容。同时，也支持添加您自主托管在云上或者 IDC 的机器来执行任务，定制任务执行的环境。</li><li><strong>灵活便捷</strong>：支持 Linux、macOS、Windows 多平台，虚拟机及容器运行环境。支持 Node.js、Python、Java、Ruby、PHP、Go、Rust、.NET 等多语言和框架。支持矩阵构建，实现多平台多环境并行兼容测试，提高软件测试集成效率。</li><li><strong>限额免费</strong>：GitHub Action 针对公开仓库及自主托管的 runner 是免费的，针对其他 GitHub 规格有免费的存储及任务运行时长，超额后按量收费，具体收费信息参考：<a href="https://docs.github.com/en/github/setting-up-and-managing-billing-and-payments-on-github/about-billing-for-github-actions" rel="nofollow">http://t.tb.cn/69r7pJmDOlTsLN724CgrlO</a>。</li><li><strong>开放生态</strong>：GitHub Action 使用 YAML 脚本编写，它们可以像代码片段一样被编辑和复用。<a href="https://github.com/marketplace?type=actions" rel="nofollow">GitHub Action Marketplace</a> 也提供了云厂商认证及三方提供的 GitHub Action 模板，您可直接使用或二次定制。</li></ul><p>GitHub Action 的核心概念分为以下四个部分：<br> </p><ul><li><strong>Workflow</strong>：基于代码仓库的一次持续集成运行过程，可以设置定时或者由 GitHub 事件触发。Workflow 文件采用 YAML 格式定义，存放在代码仓库的 .github/workflows 目录下。一个代码仓库可以有多个 Workflow 文件，GitHub 识别到目录下的 .yaml 文件，就会并行执行这些 Workflow。</li><li><strong>Job</strong>：一个 Workflow 由多个 Job 构成。默认 Job 会并发执行，也可以设置 Job 顺序执行，实现有前后逻辑依赖的 Workflow。</li><li><strong>Step</strong>：一个Job 由多个 Step 构成。同一个 Job 下的 Step 会在一个 Runner 上执行，保证环境及数据的共享。</li><li><strong>Action</strong>：一个 Step 由多个 Action 构成。Action 是独立的命令集，也基于 YAML 代码定义的，开发者可以像代码一样编辑、重用以及共享。</li></ul><p>以下是一个简单的 GitHub Action Workflow 示例，定义了由两个 Step 组成的 Job。其中，第一个 Step 复用了社区的 actions/checkout@v2 模板，执行当前代码库的检出，第二个 Step 则直接执行了 Bash 命令。</p><pre><code>name: Greeting
on: push

jobs:
  my-job:
    name: My Job
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v2
      
    - name: Greeting
      run: |
        echo 'Welcome to Alibaba Cloud!'</code></pre><p>GitHub 与阿里云联合发布的 GitHub Action Worflow，定义了多个 Step，支持快速构建及部署至阿里云容器服务 ACK。具体 Workflow 的定义，可参考链接：<a href="https://github.com/actions/starter-workflows/blob/main/ci/alibabacloud.yml" rel="nofollow">http://t.tb.cn/60eKsjLUTOKijV4NjGizeq</a>。</p><ol><li>关于阿里云容器服务</li></ol><hr><p>如果说 GitHub Action 是实践 DevOps 的瑞士军刀，那么阿里云容器服务就是落地云原生 DevOps 的最佳界面，功能丰富又便捷易用。阿里云容器服务 ACK（Alibaba Cloud Container Service for Kubernetes）是全球首批通过 Kubernetes 一致性认证的服务平台，提供高性能的容器应用管理服务，支持企业级 Kubernetes 容器化应用的生命周期管理。ACK 在阿里集团内作为核心的容器化基础设施，有丰富的应用场景和经验积累，包括电商、实时音视频、数据库、消息中间件、人工智能等场景，支撑广泛的内外部客户的 双11 活动。同时，容器服务将阿里内部各种大规模场景的经验和能力融入产品，向公有云客户开放，提升了更加丰富的功能和更加突出的稳定性，容器服务连续多年保持国内容器市场份额第一。 </p><p><span class="img-wrap"><img class="lazy" src="https://segmentfault.com/img/remote/1460000039418978" alt="3.jpg" title="3.jpg" referrerpolicy="no-referrer"></span></p><p>图 3 - 阿里云容器服务产品家族</p><p><strong>在应用管理领域</strong>，针对阿里的大规模实践和企业的丰富生产实践，阿里云进一步增强了可靠性、安全性，并且提供可赔付的 SLA 的 Kubernetes 集群 - ACK Pro 版。ACK Pro 版集群是在原 ACK 托管版集群的基础上发展而来的集群类型，继承了原托管版集群的所有优势，例如 Master 节点托管、Master 节点高可用等。同时，相比原托管版进一步提升了集群的可靠性、安全性和调度性能，并且支持赔付标准的 SLA，适合生产环境下有着大规模业务，对稳定性和安全性有高要求的企业客户。</p><p><strong>在应用制品管理领域</strong>，面向安全及性能需求高的企业客户，阿里云推出容器镜像服务企业版 ACR EE，提供公共云首个独享实例的企业级服务。ACR EE 除了支持多架构容器镜像，还支持多版本 Helm Chart、Operator 等符合 OCI 规范制品的托管。在安全治理部分，ACR EE 提供了网络访问控制、安全扫描、镜像加签、安全审计等多维度安全保障，助力企业从 DevOps 到 DevSecOps 的升级。在全球分发加速场景，ACR EE 优化了网络链路及调度策略，保障稳定的跨海同步成功率。在大镜像规模化分发场景，ACR EE 支持按需加载，实现镜像数据免全量下载和在线解压，平均容器启动时间降低 60%。目前已有众多企业生产环境模使用 ACR EE，保障企业客户云原生应用制品的安全托管及多场景高效分发。</p><p><strong>如果你在容器镜像的使用方面有什么问题，欢迎</strong><a href="https://survey.aliyun.com/apps/zhiliao/S0DUp0Tj9" rel="nofollow"><strong>点击填写调查问卷</strong></a><strong>，我们将随机挑选 10 位参与者，赠送阿里云容器镜像服务（企业版）ACR EE 优惠券</strong>。</p><h1>基于 GitHub Action + ACK 构建云原生 DevOps 实践</h1><p>下面将基于 GitHub Action 演示，如何将一个简单 Nginx 应用打包成容器镜像，托管至阿里云容器镜像服务 ACR，再自动化部署至阿里云容器服务 ACK，快速便捷地实现 CI/CD 流程。GitHub Action Demo 地址参考：<a href="https://github.com/ljinging/action-demo" rel="nofollow">http://yli16.cn/LAZxC</a>，您可以更新对应 Yaml 文件，实现自定义业务场景。</p><p><span class="img-wrap"><img class="lazy" src="https://segmentfault.com/img/remote/1460000039418973" alt="4.jpg" title="4.jpg" referrerpolicy="no-referrer"></span></p><p>图 4 - 基于 GitHub Action 的 DevOps 流程</p><ol><li>前期准备</li></ol><hr><ul><li>开通阿里云容器镜像服务 ACR，创建命名空间及镜像仓库，<a href="https://help.aliyun.com/document_detail/198212.html" rel="nofollow">参考文档</a>。如果您有强安全及高性能分发需求，建议使用 ACR EE 企业版实例，<a href="https://help.aliyun.com/document_detail/198690.html" rel="nofollow">参考文档</a>。</li><li>开通阿里云容器服务 ACK，在 ACK 上创建一个集群，<a href="https://help.aliyun.com/document_detail/85903.html" rel="nofollow">参考文档</a>。如果您有强安全及高性能需求，建议使用 ACK PRO，<a href="https://help.aliyun.com/document_detail/176833.html" rel="nofollow">参考文档</a>。</li><li>开通 GitHub 并创建仓库，代码仓库中有业务代码也包含应用部署的模板 Yaml，可参考<a href="https://github.com/ljinging/action-demo" rel="nofollow">代码示例</a>。</li></ul><ol><li>实践过程</li></ol><hr><h3>1）创建 Workflow</h3><p>在 GitHub 代码仓库中，点击 Actions 的 Tab 页面，会有基于当前 GitHub 项目内容推荐的 Workflow，选择部署至阿里云 ACK 的 Workflow 模板。</p><p><span class="img-wrap"><img class="lazy" src="https://segmentfault.com/img/remote/1460000039418974" alt="5.jpg" title="5.jpg" referrerpolicy="no-referrer"></span></p><p>图 5 - GitHub 仓库内置 Actions</p><p><span class="img-wrap"><img class="lazy" src="https://segmentfault.com/img/remote/1460000039418975" alt="6.jpg" title="6.jpg" referrerpolicy="no-referrer"></span></p><p>图 6 - 选择部署至阿里云 ACK 的 Workflow </p><p>GitHub Action 默认会在代码仓库 .github/workflows目录下创建 alibabacloud.yml 文件。在 YAML 文件中定义监听代码发布 Release 事件，一旦事件发生就会自动触发后续集成部署的流程。您也可以搜索右侧市场中相关的 Action，自定义 Job 中的 Action 步骤。</p><h3>2）更新 Workflow 中变量信息</h3><p>在 Workflow 中定义了 env 环境变量，需要按照实际情况更新对应的地域、容器镜像服务、容器服务集群等信息。ACCESS_KEY_ID 和 ACCESS_KEY_SECRET 定义了阿里云账号 AK 信息，需要以密文形式设置在仓库对应的 Secrets 中。</p><p><span class="img-wrap"><img class="lazy" src="https://segmentfault.com/img/remote/1460000039418982" alt="7.jpg" title="7.jpg" referrerpolicy="no-referrer"></span></p><p>图 7 - 更新 Worflow 中对应的环境变量</p><p><span class="img-wrap"><img class="lazy" src="https://segmentfault.com/img/remote/1460000039418979" alt="8.jpg" title="8.jpg" referrerpolicy="no-referrer"></span></p><p>图 8 - 更新 Secrets 信息</p><h3>3）自动部署</h3><p>配置完成后，默认当有一个 Release 发布后，会自动触发 GitHub Action 执行任务。点击 Actions 按钮，可以看到对应的任务执行历史和详情。整个工作流是顺序执行的，一旦其中某个任务执行失败后，整个工作流都将终止执行。可实现容器镜像推送至 ACR 后，发现有高危安全漏洞，立即取消后续容器部署至 ACK 流程。当构建、安全扫描及部署流程顺利完成，则在 ACK 上会基于新的容器镜像生成一个 nginx 服务。将安全风险识别及决策内置全链路中，实践安全高效的 DevSecOps 流程。</p><p><span class="img-wrap"><img class="lazy" src="https://segmentfault.com/img/remote/1460000039418981" alt="9.jpg" title="9.jpg" referrerpolicy="no-referrer"></span></p><p>图 9 - Workflow 执行历史</p><h3>4）扩展</h3><p>您可以在 GitHub Action Marketplace 上寻找需要的 Action 任务模板，来实现自定义的 Workflow 流程。目前，GitHub Action 上已经有丰富的 Action 模板，覆盖了多种语言的代码依赖、代码集成、代码质量等多种场景。可以基于模板快速构建出一个支持多操作系统及多语言框架下的 Workflow 矩阵，并行测试项目的多个版本。</p><p><span class="img-wrap"><img class="lazy" src="https://segmentfault.com/img/remote/1460000039418983" alt="10.jpg" title="10.jpg" referrerpolicy="no-referrer"></span></p><p>图 10 - GitHub Action Marketplace</p><h1>指引云原生时代落地 DevOps 的新路径</h1><p>相较于传统的 Jenkins 工具，GitHub Action 是 SaaS 化托管服务，无需部署及插件运维。只需简单定义或复用官方 Workflow，即可实现便捷的 CI/CD 场景。相较于 Travis CI /Circle CI，GitHub Action 是 GitHub 推出的原生工具，集成体验及灵活性更佳，并且有更丰富的 Action Marketplace 生态支持，让用户可以更便捷复用及自定义 Workflow。</p><p>如今 GitHub Action 也内置支持了自动构建推送阿里云容器镜像服务 ACR，自动部署阿里云容器服务 ACK 的 Workflow，指引云原生时代落地 DevOps 的新路径。希望可以帮助更多企业在享受云原生技术红利同时，加速完成企业级的数字化转型和架构升级。<br><a href="https://developer.aliyun.com/article/782743?utm_content=g_1000254374" rel="nofollow">原文链接</a><br>本文伟阿里云原创内容，未经允许不得转载。</p>  
</div>
            