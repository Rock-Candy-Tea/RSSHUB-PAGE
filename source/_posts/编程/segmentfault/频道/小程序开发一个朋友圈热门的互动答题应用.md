
---
title: '小程序开发一个朋友圈热门的互动答题应用'
categories: 
 - 编程
 - segmentfault
 - 频道
headimg: 'https://segmentfault.com/img/remote/1460000039706683'
author: segmentfault
comments: false
date: 2021-03-25 04:15:51
thumbnail: 'https://segmentfault.com/img/remote/1460000039706683'
---

<div>   
<p>这是之前受到朋友圈的一些 <strong>亲密度测试</strong> 的启发，开发的一个互动答题应用。</p><h3>功能</h3><ol><li>创建自定义题目，设置正确选项</li><li>生成分享图邀请好友来答题</li><li>好友得到成绩单，并可以生成图片分享</li><li>通知中心可以查看好友答题记录</li></ol><h3>技术栈</h3><ul><li>前端：<strong>小程序</strong></li><li>后端：<strong>云开发</strong></li><li>框架：<strong>mpx</strong></li></ul><h2>展示</h2><blockquote>小程序搜索：小题卡。由于使用免费到云套餐，接口有访问次数限制</blockquote><h3>预览地址</h3><p><span class="img-wrap"><img class="lazy" src="https://segmentfault.com/img/remote/1460000039706683" alt="小题卡.jpg" title="小题卡.jpg" referrerpolicy="no-referrer"></span></p><h3>截图</h3><p><span class="img-wrap"><img class="lazy" src="https://segmentfault.com/img/remote/1460000039706682" alt="应用截图.jpg" title="应用截图.jpg" referrerpolicy="no-referrer"></span></p><h2>代码</h2><p>git仓库：<a href="https://github.com/luosijie/mini-questions" rel="nofollow">https://github.com/luosijie/m...</a></p><h4>代码结构</h4><p><span class="img-wrap"><img class="lazy" src="https://segmentfault.com/img/remote/1460000039706684" alt="代码结构.jpg" title="代码结构.jpg" referrerpolicy="no-referrer"></span></p><h3>示例</h3><blockquote>由于完整项目涉及简单交互较多，下面展示一些主要功能代码</blockquote><h4>新建题目</h4><blockquote>核心要点：用 <strong>swipe组件</strong> 实现题目到卡片式切换</blockquote><pre><code class="js"><template>
  <view>
    <swiper class="cards" bindchange="swiperChange" current="&#123;&#123; current &#125;&#125;">
      <!-- 全局配置 -->
      <swiper-item>
        <view class="card config">
          <textarea type="text" maxlength="12" auto-height="true" wx:model="&#123;&#123; formData.title &#125;&#125;"  placeholder="请输入题卡名称"/>
        </view>
      </swiper-item>
      <swiper-item wx:for="&#123;&#123; formData.cards &#125;&#125;" wx:key="id" wx:for-item="card">
        <view class="card">
          <!-- 标题 -->
          <input type="text" maxlength="12" class="title" value="&#123;&#123; card.title &#125;&#125;" placeholder="请输入标题" bindblur="titleChange"/>
          <!-- 选项 -->
          <view
            class="option"
            wx:for="&#123;&#123; card.options &#125;&#125;"
            wx:key="id"
            wx:for-item="option"
            wx:for-index="optionIndex"
          >
            <!-- 移除选项 -->
            <i class="remove iconfont icon-remove" bindtap="removeOption(optionIndex)"></i>
            <!-- 选项标题 -->
            <input type="text" maxlength="12" value="&#123;&#123; option.value &#125;&#125;" placeholder="请输入选项标题" bindblur="optionTitleChange(optionIndex, $event)"/>
            <!-- 正确选项 -->
            <view class="correct" bindtap="setCorrect(index, optionIndex)">
              <i class="check iconfont icon-check" wx:if="&#123;&#123; card.correct === optionIndex &#125;&#125;"></i>
            </view>
          </view>
          <!-- 新增 -->
          <view class="add-option" wx:if="&#123;&#123; card.options.length < 4 &#125;&#125;" bindtap="addOption">新增选项</view>
        </view>
      </swiper-item>
      <swiper-item>
        <view class="card" bindtap="addCard">
          <view class="new-card">
            <i class="iconfont icon-new-card"></i>
          </view>
        </view>
      </swiper-item>
    </swiper>
    <view class="controls">
      <view class="ps">
        <block wx:if="&#123;&#123; current < formData.cards.length + 1 && current > 0 &#125;&#125;">
          <view class="tip">
            点击选项右边标记正确答案
          </view>
          <i class="delete-card iconfont icon-clear" bindtap="deleteCard" wx:if="&#123;&#123; current > 1 &#125;&#125;"></i>
        </block>
      </view>
      <view class="swip">
        <view class="pre iconfont icon-pre" bindtap="pre"></view>
        <view class="current">
          <block wx:if="&#123;&#123; current === 0 &#125;&#125;">
            题卡配置
          </block>
          <block wx:elif="&#123;&#123; current < formData.cards.length + 1 &#125;&#125;">
            第&#123;&#123; current &#125;&#125;/&#123;&#123; formData.cards.length &#125;&#125;题
          </block>
          <block wx:else>
            新增题目
          </block>
        </view>
        <view class="next iconfont icon-next" bindtap="next"></view>
      </view>
      <view class="generate" bindtap="generate">生成</view>
    </view>
  </view>
</template>

<script>
  import &#123; createPage &#125; from '@mpxjs/core'
  createPage(&#123;
    data: &#123;
      current: 0,
      formData: &#123;
        title: '',
        cards: []
      &#125;
    &#125;,
    onLoad () &#123;
      this.formData.cards = []
      const card = this.generateCard()
      this.formData.cards.push(card)
    &#125;,
    methods: &#123;
      // 生成选项
      generateOption (id) &#123;
        return &#123;
          id,
          value: ''
        &#125;
      &#125;,
      // 生成一个起始题目
      generateCard () &#123;
        const id = new Date().getTime()
        const card = &#123;
          id,
          title: '',
          options: [
            this.generateOption(id + 1),
            this.generateOption(id + 2),
            this.generateOption(id + 3),
            this.generateOption(id + 4)
          ],
          correct: 0
        &#125;
        return card
      &#125;,
      addCard () &#123;
        const card = this.generateCard()
        this.formData.cards.push(card)
      &#125;,
      swiperChange (e) &#123;
        this.current = e.detail.current
      &#125;,
      // 切换上一题
      pre () &#123;
        if (this.current > 0) &#123;
          this.current--
        &#125;
      &#125;,
      // 切换下一题目
      next () &#123;
        if (this.current < this.formData.cards.length + 1) &#123;
          this.current++
          console.log('cards:', this.formData)
        &#125;
      &#125;,
      // 移除选项
      removeOption (index) &#123;
        const options = this.formData.cards[this.current - 1].options
        if (options.length < 3) &#123;
          wx.showToast(&#123;
            title: '至少保留2个选项',
            icon: 'none'
          &#125;)
          return
        &#125;
        options.splice(index, 1)
      &#125;,
      // 新增选项
      addOption () &#123;
        const options = this.formData.cards[this.current - 1].options
        const option = this.generateOption(new Date().getTime())
        options.push(option)
      &#125;,
      // 删除卡片
      deleteCard () &#123;
        console.log('delete')
        if (this.formData.cards.length < 2) &#123;
          wx.showToast(&#123;
            title: '不能再删了',
            icon: 'none'
          &#125;)
          return
        &#125;
        wx.showModal(&#123;
          title: '提示',
          content: '确定删除该题目吗',
          confirmColor: '#40A9FF',
          success: () => &#123;
            this.formData.cards.splice(this.current - 1, 1)
            console.log('删除卡片', this.formData.cards)
          &#125;
        &#125;)
      &#125;,
      titleChange (e) &#123;
        this.formData.cards[this.current - 1].title = e.detail.value
        console.log('e', this.formData.cards)
      &#125;,
      optionTitleChange (index, e) &#123;
        const options = this.formData.cards[this.current - 1].options
        options[index].value = e.detail.value
      &#125;,
      // 校验题卡表单
      validateForm () &#123;
        if (!this.formData.title) &#123;
          wx.showToast(&#123;
            title: '题卡名称未填写',
            icon: 'none'
          &#125;)
          return false
        &#125;
        for (let i = 0; i < this.formData.cards.length; i++) &#123;
          const card = this.formData.cards[i]
          if (!card.title) &#123;
            wx.showToast(&#123;
              title: `第$&#123;i + 1&#125;道题 标题未填写`,
              icon: 'none'
            &#125;)
            return false
          &#125;
          // 校验选项标题填写情况
          for (let j = 0; j < card.options.length; j++) &#123;
            const option = card.options[j]
            if (!option.value) &#123;
              wx.showToast(&#123;
                title: `第$&#123;i + 1&#125;道题 选项未完善`,
                icon: 'none'
              &#125;)
              return false
            &#125;
          &#125;
        &#125;
        return true
      &#125;,
      // 设置正确选项
      setCorrect (index, optionIndex) &#123;
        const card = this.formData.cards[index]
        card.correct = optionIndex
        this.$set(this.formData.cards, index, card)
      &#125;,
      async generate () &#123;
        const valid = this.validateForm()
        if (!valid) return
        wx.showLoading(&#123;
          title: '处理中...',
          mask: true
        &#125;)
        const res = await wx.cloud.callFunction(&#123;
          name: 'questionAdd',
          data: this.formData
        &#125;)
        if (res.result.success) &#123;
          wx.showToast(&#123;
            title: '创建成功',
            icon: 'success'
          &#125;)
          // 跳转到投票详情页
          setTimeout(() => &#123;
            wx.redirectTo(&#123;
              url: `detail-entry?_id=$&#123;res.result._id&#125;`
            &#125;)
          &#125;, 1500)
        &#125;
      &#125;
    &#125;
  &#125;)
</script>


// 省略样式
</code></pre><h4>成绩单</h4><blockquote>核心要点：小程序canvas制作页面分享图</blockquote><pre><code class="js"><template>
  <view class="main" wx:if="&#123;&#123; detail &#125;&#125;">
    <view class="card">
      <view class="title">“ &#123;&#123; detail.question.title &#125;&#125; ”</view>
      <view class="zql">正确率</view>
      <view class="score">&#123;&#123; detail.score &#125;&#125;</view>
      <view class="from">
        <image src="&#123;&#123; detail.creator.avatarUrl &#125;&#125;"></image> &#123;&#123; detail.creator.nickName &#125;&#125; 的成绩单
      </view>
      <view class="result" wx:if="&#123;&#123; showResult &#125;&#125;">
        <view
          class="item"
          wx:for="&#123;&#123; detail.result &#125;&#125;"
          wx:key="index"
          wx:style="&#123;&#123; &#123; background: item.right ? '#4faf70' : '#d94948' &#125; &#125;&#125;"
        >
          &#123;&#123; item.letter &#125;&#125;
        </view>
      </view>
      <view class="me-too" wx:else bindtap="toCreate">
        我也来出一题
      </view>
      <view class="info">
        <view class="date">
          &#123;&#123; detail.createTime &#125;&#125;
        </view>
        <view class="date">
          出题人: &#123;&#123; detail.questionCreator.nickName &#125;&#125;
        </view>
        <view class="num" wx:if="&#123;&#123; detail.question.answers &#125;&#125;">
          &#123;&#123; detail.question.answers.length &#125;&#125;次参与
        </view>
      </view>
    </view>
    <view class="action">
      <view class="share" bindtap="generateShareImage">生成分享图</view>
      <view class="detail" bindtap="toCards" wx:if="&#123;&#123; user.OPENID === detail.creator.OPENID &#125;&#125;">再试一次</view>
      <view class="detail" bindtap="toDetail" wx:else>我试一下</view>
    </view>
    <!-- 用来生成分享图 -->
    <canvas
      type="2d"
      id="canvas_share"
      class="canvas-share"
      style="width: &#123;&#123;canvasShare.width&#125;&#125;px; height: &#123;&#123;canvasShare.height&#125;&#125;px"
    />
    <pop visible="&#123;&#123; imageShare.visible &#125;&#125;" bindclose="closeImageShare">
      <image src="&#123;&#123; imageShare.image &#125;&#125;" mode="aspectFit" class="image-share"></image>
    </pop>
  </view>
</template>

<script>
  import &#123; createPage &#125; from '@mpxjs/core'
  import no2letter from '../utils/no2letter'
  import loadImage from '../utils/loadImage'
  createPage(&#123;
    data: &#123;
      user: null,
      detail: null,
      canvasShare: &#123;
        width: 0,
        height: 0
      &#125;,
      imageShare: &#123;
        visible: false,
        image: ''
      &#125;,
      showResult: false
    &#125;,
    onLoad (params) &#123;
      const id = params._id || params.scene
      this.user = wx.getStorageSync('user')
      this.getDetail(id)
    &#125;,
    onShareAppMessage () &#123;
      const title = `我在$&#123;this.detail.questionCreator.nickName&#125;的题目中得分$&#123;this.detail.score&#125;,你也来试试？`
      return &#123;
        title
      &#125;
    &#125;,
    methods: &#123;
      closeImageShare () &#123;
        this.imageShare.visible = false
      &#125;,
      // 生成分享图
      async generateShareImage () &#123;
        if (this.imageShare.image) &#123;
          this.imageShare.visible = true
          wx.saveImageToPhotosAlbum(&#123;
            filePath: this.imageShare.image,
            success () &#123;
              wx.showToast(&#123;
                title: '图片已经保存到相册',
                icon: 'none'
              &#125;)
            &#125;,
            fail () &#123;
              wx.showToast(&#123;
                title: '请先在设置里打开相册权限',
                icon: 'none'
              &#125;)
            &#125;
          &#125;)
          return
        &#125;
        wx.showLoading(&#123;
          title: '处理中...'
        &#125;)
        const res = await wx.cloud.callFunction(&#123;
          name: 'wxacode',
          data: &#123;
            page: 'pages/result',
            scene: this.detail._id
          &#125;
        &#125;)
        let pageCode
        if (res.result.errCode === 0) &#123;
          pageCode = `data:image/png;base64,$&#123;wx.arrayBufferToBase64(res.result.buffer)&#125;`
        &#125; else &#123;
          return
        &#125;
        const query = this.createSelectorQuery()
        query
          .select('#canvas_share')
          .fields(&#123; node: true, size: true &#125;)
          .exec(async res => &#123;
            console.log('ressss', res)
            // 获取 canvas 实例
            const canvas = res[0].node
            // 获取 canvas 绘图上下文
            const ctx = canvas.getContext('2d')
            const width = 700
            const height = 900
            this.canvasShare.width = 700
            this.canvasShare.height = 900
            canvas.width = width
            canvas.height = height
            // 绘制背景
            ctx.fillStyle = 'white'
            ctx.fillRect(0, 0, width, height)
            // 绘制head区域
            ctx.textBaseline = 'top'
            ctx.font = '32px sans-serif'
            ctx.fillStyle = '#000000'
            ctx.fillText('小题卡', 20, 20)
            ctx.fillStyle = '#999999'
            ctx.fillText('成绩单', 585, 20)
            // 绘制title
            const title = `“$&#123;this.detail.question.title&#125;”`
            ctx.font = 'normal bold 50px sans-serif'
            ctx.fillStyle = '#000000'
            ctx.fillText(title, (width - title.length * 50) / 2 + 25, 150)
            // 绘制sub-title
            const subtitle = '我在      的题目中正确率为'
            ctx.font = '24px sans-serif'
            ctx.fillStyle = '#999'
            ctx.fillText(subtitle, (width - subtitle.length * 24) / 2 + 48, 250)
            // 绘制出题者头像
            const photoCreator = await loadImage.call(this, this.detail.questionCreator.avatarUrl, 'canvas_share')
            ctx.drawImage(photoCreator, 263, 250, 24, 24)
            // 绘制score
            ctx.font = 'normal bold 200px sans-serif'
            ctx.fillStyle = '#70B7FC'
            ctx.fillText(this.detail.score, (width - this.detail.score.length * 100) / 2 - 80, 350)
            // 绘制welcome
            const welcome = '你也来试试吧'
            ctx.font = '24px sans-serif'
            ctx.fillStyle = '#999'
            ctx.fillText(welcome, (width - welcome.length * 24) / 2, 620)
            // 绘制创建人头像
            const photoAnswer = await loadImage.call(this, this.detail.creator.avatarUrl, 'canvas_share')
            ctx.drawImage(photoAnswer, 40, 780, 24, 24)
            // 绘制foot-title
            const footTitle = '邀请你一起来答题'
            ctx.font = '24px sans-serif'
            ctx.fillStyle = '#999'
            ctx.fillText(footTitle, 70, 780)
            // 绘制foot-title
            const footSubTitle = '长按图片识别进入小程序'
            ctx.font = '24px sans-serif'
            ctx.fillStyle = '#999'
            ctx.fillText(footSubTitle, 40, 820)
            // 绘制小程序码
            const photoPage = await loadImage.call(this, pageCode, 'canvas_share')
            ctx.drawImage(photoPage, 510, 730, 150, 150)
            // 绘制边框和分割线
            ctx.strokeStyle = '#eee'
            ctx.lineWidth = 8
            ctx.strokeRect(0, 0, width, height)
            ctx.lineWidth = 3
            ctx.beginPath()
            ctx.moveTo(0, 700)
            ctx.lineTo(700, 700)
            ctx.stroke()
            ctx.save()
            wx.hideLoading()
            // 生成图片预览
            wx.canvasToTempFilePath(&#123;
              x: 0,
              y: 0,
              width,
              height,
              canvas,
              complete: resTemp => &#123;
                console.log('resTemp', canvas, resTemp)
                if (resTemp.errMsg === 'canvasToTempFilePath:ok') &#123;
                  this.imageShare.image = resTemp.tempFilePath
                  this.imageShare.visible = true
                  wx.saveImageToPhotosAlbum(&#123;
                    filePath: resTemp.tempFilePath,
                    success () &#123;
                      wx.showToast(&#123;
                        title: '图片已经保存到相册',
                        icon: 'none'
                      &#125;)
                    &#125;,
                    fail () &#123;
                      wx.showToast(&#123;
                        title: '请先在设置里打开相册权限',
                        icon: 'none'
                      &#125;)
                    &#125;
                  &#125;)
                &#125;
              &#125;
            &#125;)
          &#125;)
      &#125;,
      async getDetail (_id) &#123;
        wx.showLoading(&#123;
          title: '加载中...'
        &#125;)
        const res = await wx.cloud.callFunction(&#123;
          name: 'answerDetail',
          data: &#123;
            _id
          &#125;
        &#125;)
        this.detail = res.result.data
        this.detail.result = this.detail.result.map((e, index) => &#123;
          return &#123;
            letter: no2letter(this.detail.answer[index]),
            right: e
          &#125;
        &#125;)
        const OPENID = this.user.OPENID
        this.showResult = OPENID === this.detail.creator.OPENID || OPENID === this.detail.questionCreator.OPENID
        wx.hideLoading()
      &#125;,
      toCards () &#123;
        wx.navigateTo(&#123;
          url: `detail-cards?_id=$&#123;this.detail.question._id&#125;`
        &#125;)
      &#125;,
      toCreate () &#123;
        wx.navigateTo(&#123;
          url: 'new'
        &#125;)
      &#125;,
      toDetail () &#123;
        wx.navigateTo(&#123;
          url: `detail-entry?_id=$&#123;this.detail.question._id&#125;`
        &#125;)
      &#125;
    &#125;
  &#125;)
</script>

// 样式省略</code></pre><h2>谢谢阅读</h2><blockquote>喜欢我的项目，欢迎star支持一下</blockquote>  
</div>
            