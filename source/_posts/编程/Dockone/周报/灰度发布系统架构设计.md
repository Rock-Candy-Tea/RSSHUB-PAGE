
---
title: '灰度发布系统架构设计'
categories: 
 - 编程
 - Dockone
 - 周报
headimg: 'https://cors.zfour.workers.dev/?http://dockone.io/uploads/article/20210609/7e7e0254e60ce7bb730e3380315b307f.jpg'
author: Dockone
comments: false
date: 2021-06-14 04:08:24
thumbnail: 'https://cors.zfour.workers.dev/?http://dockone.io/uploads/article/20210609/7e7e0254e60ce7bb730e3380315b307f.jpg'
---

<div>   
<br><h3>灰度发布的定义</h3>互联网产品需要快速迭代开发上线，又要保证质量，保证刚上线的系统，一旦出现问题可以很快控制影响面，就需要设计一套灰度发布系统。<br>
<br>灰度发布系统的作用，可以根据配置，将用户的流量导到新上线的系统上，来快速验证新的功能，而一旦出现问题，也可以马上的修复，简单的说，就是一套A/B Test系统。<br>
<br>灰度发布允许带着bug上线，只要bug不是致命的，当然这个bug是不知道的情况下，如果知道就要很快的改掉。<br>
<h3>简单灰度发布系统的设计</h3><div class="aw-upload-img-list active">
<a href="http://dockone.io/uploads/article/20210609/7e7e0254e60ce7bb730e3380315b307f.jpg" target="_blank" data-fancybox-group="thumb" rel="lightbox"><img src="https://cors.zfour.workers.dev/?http://dockone.io/uploads/article/20210609/7e7e0254e60ce7bb730e3380315b307f.jpg" class="img-polaroid" title="1.jpg" alt="1.jpg" referrerpolicy="no-referrer"></a>
</div>
<br>
灰度简单架构如上图所示，其中的必要组件如下：<br>
<ul><li>策略的配置平台，存放灰度的策略</li><li>灰度功能的执行程序</li><li>注册中心，注册的服务携带ip/Port/name/version</li></ul><br>
<br>有了上面三个组件，才算一个完整的灰度平台<br>
<h3>灰度的策略</h3>灰度必须要有灰度策略，灰度策略常见的方式有以下几种：<br>
<ul><li>基于Request Header进行流量切分</li><li>基于Cookie进行流量切分</li><li>基于请求参数进行流量切分</li></ul><br>
<br>举例：根据请求中携带的用户uid进行取模，灰度的范围是百分之一，那么uid取模的范围就是100，模是0访问新版服务，模是1~99的访问老版服务。<br>
<br>灰度发布策略分为两类，单策略和组合策略：<br>
<ul><li>单策略：比如按照用户的uid、token、ip进行取模</li><li>组合策略：多个服务同时灰度，比如我有A/B/C三个服务，需要同时对A和C进行灰度，但是B不需要灰度，这个时候就需要一个tag字段，具体实现在下文详述。</li></ul><br>
<br><h3>灰度发布具体的执行控制</h3>在上面的简单灰度发布系统架构中我们了解到，灰度发布服务分为上游和下游服务，上游服务是具体的执行灰度策略的程序，这个服务可以是Nginx，也可以是微服务架构中的网关层/业务逻辑层，下面我们就来分析一下不同的上游服务，如何落地。<br>
<h3>Nginx</h3>如果上游服务是Nginx，那么就需要Nginx通过Lua扩展Nginx实现灰度策略的配置和转发，因为Nginx本身并不具备灰度策略的执行。<br>
<br>通过Lua扩展实现了灰度策略的执行，但是问题又来了，Nginx本身并不具备接收配置管理平台的灰度策略，这个时候应该怎么办呢？<br>
<br>解决方案：本地部署Agent（需要自己开发），接收服务配置管理平台下发的灰度策略，更新Nginx配置，优雅重启Nginx服务。<br>
<h3>网关层/业务逻辑层/数据访问层</h3>只需要集成配置管理平台客户端SDK，接收服务配置管理平台下发的灰度策略，在通过集成的SDK进行灰度策略的执行即可。<br>
<h3>灰度发布复杂场景</h3>下面举例两个稍微复杂的灰度发布场景，灰度策略假设都按照uid取模灰度百分之一的用户，看一下如何实现。<br>
<h3>场景1：调用链上同时灰度多个服务</h3>功能升级涉及到多个服务变动，网关层和数据访问层灰度，业务逻辑层不变，这个时候应该如何进行灰度？<br>
<br>解决方案：<br>
<br>经过新版本网关层的请求，全部打上tag T，在业务逻辑层根据tag T进行转发， 标记Tag T的请求全部转发到新版数据访问层服务上，没有tag T的请求全部转发到老版数据访问层上。<br>
<div class="aw-upload-img-list active">
<a href="http://dockone.io/uploads/article/20210609/27e4898fe03e0ef4677cccfc225d1626.jpg" target="_blank" data-fancybox-group="thumb" rel="lightbox"><img src="https://cors.zfour.workers.dev/?http://dockone.io/uploads/article/20210609/27e4898fe03e0ef4677cccfc225d1626.jpg" class="img-polaroid" title="2.jpg" alt="2.jpg" referrerpolicy="no-referrer"></a>
</div>
<br>
<h3>场景2：涉及数据的灰度服务</h3>涉及到数据的灰度服务，一定会使用到数据库，使用到数据库就会涉及到你使用数据库前后的表字段不一致，我老版本是A/B/C三个字段，新版本是A/B/C/D四个字段。这时新版的灰度，就不能往老版的数据库进行修改了，这个时候就需要把数据copy一份出来做这个事情了<br>
<br>数据库其实并没有灰度的概念，这个时候我们只能把数据重新拷贝一份出来进行读和写，因为这时你的写必须是全量的（双写），不能说90%的数据写入到老版本，10%的数据写入到新版本，因为这个时候你会发现两个数据库的数据都不是全量的。<br>
<br>离线全量复制数据的过程中一定会有数据丢失，这个时候就需要业务逻辑层写一份数据到MQ中，等数据同步完成之后，新版的数据访问层再将MQ的数据写入到新版本的DB中，实现数据的一致性，这个也是引入MQ的主要目的。<br>
<div class="aw-upload-img-list active">
<a href="http://dockone.io/uploads/article/20210609/24c0dcc4ed7acc8245b107e75a562bdc.jpg" target="_blank" data-fancybox-group="thumb" rel="lightbox"><img src="https://cors.zfour.workers.dev/?http://dockone.io/uploads/article/20210609/24c0dcc4ed7acc8245b107e75a562bdc.jpg" class="img-polaroid" title="3.jpg" alt="3.jpg" referrerpolicy="no-referrer"></a>
</div>
<br>
灰度过程中需要对两个数据库的数据进行对比，观察数据是否一致。这样不管是灰度失败，放弃新版DB，还是灰度成功切换到新版DB，数据都不会产生丢失。<br>
<br>原文链接：<a href="https://www.toutiao.com/i6910008843955192323" rel="nofollow" target="_blank">https://www.toutiao.com/i6910008843955192323</a>，作者：小杨互联网 
                                                                <div class="aw-upload-img-list">
                                                                                                                                                                                                                                                                </div>
                                
                                                                <ul class="aw-upload-file-list">
                                                                                                                                                                                                                                                                                            </ul>
                                                              
</div>
            