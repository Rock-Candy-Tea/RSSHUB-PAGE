
---
title: '微服务设计原则'
categories: 
 - 编程
 - Dockone
 - 周报
headimg: 'https://cors.zfour.workers.dev/?http://dockone.io/uploads/article/20210511/2402d917e9d3c822e2bfba2a1ca7c3bd.jpeg'
author: Dockone
comments: false
date: 2021-05-13 04:12:01
thumbnail: 'https://cors.zfour.workers.dev/?http://dockone.io/uploads/article/20210511/2402d917e9d3c822e2bfba2a1ca7c3bd.jpeg'
---

<div>   
<br>良好的微服务设计可以使后期的升级维护更加轻松，否则将会令人非常头疼。<br>
<br>下面几个设计原则强烈建议采用：<br>
<ul><li>单一职责</li><li>高内聚</li><li><br>低耦合<br>
<ul><li>隐藏内部实现</li><li>避免代码库共享</li><li>避免数据过度暴露</li><li>避免数据库共享</li><li>最小化同步调用</li><li>最小化硬件共享</li><li>避免使用平台独特性技术</li></ul></li></ul><br>
<br>这三大原则是面向对象设计中的核心，同样适用于微服务设计。<br>
<h3>单一职责</h3>每个微服务只应担负一个职责。<br>
<div class="aw-upload-img-list active">
<a href="http://dockone.io/uploads/article/20210511/2402d917e9d3c822e2bfba2a1ca7c3bd.jpeg" target="_blank" data-fancybox-group="thumb" rel="lightbox"><img src="https://cors.zfour.workers.dev/?http://dockone.io/uploads/article/20210511/2402d917e9d3c822e2bfba2a1ca7c3bd.jpeg" class="img-polaroid" title="1.jpeg" alt="1.jpeg" referrerpolicy="no-referrer"></a>
</div>
<br>
比如一个微服务中有两大功能：<br>
<ul><li>商品分类管理</li><li>购物车</li></ul><br>
<br>把它们放在一起看起来问题不大，因为使用的技术相同、功能和数据上会有比较紧密的联系，在组织结构上，通常是由同一个开发小组负责。<br>
<br>但是，这会造成两个功能有大量的代码耦合。<br>
<br>时间长了之后，会带来和单体架构一样的问题，维护难、测试难、部署难……<br>
<div class="aw-upload-img-list active">
<a href="http://dockone.io/uploads/article/20210511/4ccd8d86c629b3b7b3275610251635b1.jpeg" target="_blank" data-fancybox-group="thumb" rel="lightbox"><img src="https://cors.zfour.workers.dev/?http://dockone.io/uploads/article/20210511/4ccd8d86c629b3b7b3275610251635b1.jpeg" class="img-polaroid" title="2.jpeg" alt="2.jpeg" referrerpolicy="no-referrer"></a>
</div>
<br>
所以，按照“单一职责”原则，应该分为两个微服务。<br>
<h3>高内聚</h3>关系紧密的行为应放在一起。<br>
<div class="aw-upload-img-list active">
<a href="http://dockone.io/uploads/article/20210511/419d0d2b203bb22562d167f94dc330f0.jpeg" target="_blank" data-fancybox-group="thumb" rel="lightbox"><img src="https://cors.zfour.workers.dev/?http://dockone.io/uploads/article/20210511/419d0d2b203bb22562d167f94dc330f0.jpeg" class="img-polaroid" title="3.jpeg" alt="3.jpeg" referrerpolicy="no-referrer"></a>
</div>
<br>
比如有2个微服务：<br>
<ul><li>订单管理</li><li>订单金额统计</li></ul><br>
<br>“订单金额统计”服务需要请求“订单管理”服务，以获取所需数据。<br>
<br>例如价格、税、服务费……<br>
<br>刚开始一切安好，但突然某一天上头增加税种了，需要更改新的计算规则。<br>
<br>那么，订单服务就要提供新的数据，金额统计服务也需要更改计算方式。<br>
<br>也就是说，每次变更基本都需要两个服务一起改，是紧耦合的。<br>
<div class="aw-upload-img-list active">
<a href="http://dockone.io/uploads/article/20210511/3209db6f95abae9457364a5be3de9c1a.jpeg" target="_blank" data-fancybox-group="thumb" rel="lightbox"><img src="https://cors.zfour.workers.dev/?http://dockone.io/uploads/article/20210511/3209db6f95abae9457364a5be3de9c1a.jpeg" class="img-polaroid" title="4.jpeg" alt="4.jpeg" referrerpolicy="no-referrer"></a>
</div>
<br>
因为订单金额统计服务的逻辑只与订单相关，所以应该并入订单服务。<br>
<br>把紧密相关的行为放在一起，实现高内聚。<br>
<h3>低耦合</h3>一个服务的变更不要影响其他服务。<br>
<br>此原则涉及到多个方面。<br>
<h4>隐藏内部实现</h4>比如上一节“高内聚”中，把金额统计服务并入了订单管理服务，那么，之前金额统计服务中的 “统计接口” 还需要对外暴露吗？<br>
<br>现在已经是订单服务的内部功能了，统计结果可以作为订单对象中的数据，所以无需对外暴露，防止误操作和造成不必要的耦合关系。<br>
<h4>避免共享代码库</h4><div class="aw-upload-img-list active">
<a href="http://dockone.io/uploads/article/20210511/580918ca906aa78b91cff09f7aada067.jpeg" target="_blank" data-fancybox-group="thumb" rel="lightbox"><img src="https://cors.zfour.workers.dev/?http://dockone.io/uploads/article/20210511/580918ca906aa78b91cff09f7aada067.jpeg" class="img-polaroid" title="5.jpeg" alt="5.jpeg" referrerpolicy="no-referrer"></a>
</div>
<br>
共享代码的确非常方便，但是会造成底层代码关联度太强。<br>
<br>对于以后的升级非常不便，例如某个服务想把语言版本升级，但共享库使用的是低版本，其中某些用法在高版本中是过期的，这就很尴尬了。<br>
<br>想要完美的避免也是不现实的，只能尽量规避。<br>
<br>例如<strong>不共享</strong>，各服务重新造轮子，这样服务之间就有边界了。<br>
<br>但这个方式只适用于需要共享的库是非常稳定的，不怎么需要改了，否则的话相关服务都需要改。<br>
<br>再比如把共享库的<strong>粒度缩小</strong>，避免形成功能特别全的大库。<br>
<br>大库必然导致被引用的范围非常广，影响面大。<br>
<br>如果粒度很小的话，涉及的服务也就少。<br>
<h4>避免数据过度暴露</h4>例如用户服务有一个获取用户详情的接口，返回用户所有信息。<br>
<br>购物车服务获取用户信息时，就会拿到很全的数据，例如包括支付信息。<br>
<br>这是没必要的，只需要返回用户的基本属性即可。<br>
<br>特殊的属性应通过另外的接口提供。<br>
<br>过度暴露会增加服务间的耦合度。<br>
<h4>避免数据库共享</h4><div class="aw-upload-img-list active">
<a href="http://dockone.io/uploads/article/20210511/de8298b2ae34340715c777ac8c191113.jpeg" target="_blank" data-fancybox-group="thumb" rel="lightbox"><img src="https://cors.zfour.workers.dev/?http://dockone.io/uploads/article/20210511/de8298b2ae34340715c777ac8c191113.jpeg" class="img-polaroid" title="6.jpeg" alt="6.jpeg" referrerpolicy="no-referrer"></a>
</div>
<br>
一个服务想获取另一个服务的数据时，只应该通过接口，而不是直接从对方的数据库中拿。<br>
<br>否则，这种数据层面的耦合会带来噩梦。<br>
<h4>最小化同步调用</h4><div class="aw-upload-img-list active">
<a href="http://dockone.io/uploads/article/20210511/2534d2349f1a71dd75b37bf4996ac6f6.jpeg" target="_blank" data-fancybox-group="thumb" rel="lightbox"><img src="https://cors.zfour.workers.dev/?http://dockone.io/uploads/article/20210511/2534d2349f1a71dd75b37bf4996ac6f6.jpeg" class="img-polaroid" title="7.jpeg" alt="7.jpeg" referrerpolicy="no-referrer"></a>
</div>
<br>
比如订单服务创建订单的时候需要调用很多其他服务，例如用户、商品、支付、库存、物流。<br>
<br>直接同步调用各个服务的接口吗？<br>
<br>不现实，如果其中有一个服务接口调用失败，那么创建订单就失败了。<br>
<br>最好使用事件驱动的异步调用。<br>
<br>同步调用会产生网络的阻塞，对被调用服务的可用性要求极高，所以要慎重使用。<br>
<h4>避免硬件基础设施的共享</h4><div class="aw-upload-img-list active">
<a href="http://dockone.io/uploads/article/20210511/87bd3cfa7b749b880abed7006b132539.jpeg" target="_blank" data-fancybox-group="thumb" rel="lightbox"><img src="https://cors.zfour.workers.dev/?http://dockone.io/uploads/article/20210511/87bd3cfa7b749b880abed7006b132539.jpeg" class="img-polaroid" title="8.jpeg" alt="8.jpeg" referrerpolicy="no-referrer"></a>
</div>
<br>
服务设计得很好，但如果硬件部署没有规划好，一样非常痛苦。<br>
<br>例如两个服务部署在一台服务器上，服务B非常消耗资源，那么服务A可能就没法用了。<br>
<br>所以，不能忽略硬件这个关键点，要根据各个服务的特点做好均衡部署。<br>
<h4>避免使用平台特性技术</h4>例如Java RMI做远程调用不错，但它是平台特性，要求服务双方都用一套技术，这种高耦合就不如平台独立的REST更自由了。<br>
<br>原文链接：<a href="https://segmentfault.com/a/1190000039963016" rel="nofollow" target="_blank">https://segmentfault.com/a/1190000039963016</a>
                                                                <div class="aw-upload-img-list">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </div>
                                
                                                                <ul class="aw-upload-file-list">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </ul>
                                                              
</div>
            