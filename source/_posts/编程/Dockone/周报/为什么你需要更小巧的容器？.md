
---
title: '为什么你需要更小巧的容器？'
categories: 
 - 编程
 - Dockone
 - 周报
headimg: 'https://cors.zfour.workers.dev/?http://dockone.io/uploads/article/20211211/0442e528485f7b2900a2df23ebedcf2e.png'
author: Dockone
comments: false
date: 2021-12-12 11:07:17
thumbnail: 'https://cors.zfour.workers.dev/?http://dockone.io/uploads/article/20211211/0442e528485f7b2900a2df23ebedcf2e.png'
---

<div>   
<br>【编者的话】为你的容器瘦身吧！更小的容器不仅仅意味着更快的构建和更小的磁盘和网络利用率，它们还意味着更安全。<br>
<br>这篇文章出人意料地登上了黑客新闻的头版，并在那里引发了一场富有成效的讨论。我将试着总结一下主要的要点：<br>
<ul><li><br>漏洞扫描器往往有很多误报<br>
<ul><li>一些报告的发现已经可以在上游和后端修复</li><li>有些可能完全不相关，因为它们特定于某些深奥的架构</li></ul></li><li><br>在镜像仓库（例如Docker Hub）中，官方基础镜像从不（或很少）更新。</li><li>随着容器使用的增加，为操作系统打补丁的负担实际上从管理员和操作人员转移到了开发人员身上</li><li><br>但并不是每个开发者都意识到这一点<br>
<ul><li>有些人建议在每个Dockerfile的开头添加<code class="prettyprint">RUN apt-get update &amp;&amp; apt-get -y upgrade</code>，我尝试了一下，在完全成熟的Debian 10发行版中，它提供了非常小的效果</li><li>但其他人反驳说，这会导致不可复制的构建，以及由于反向端口改变依赖的默认行为而导致的潜在风险</li><li>这导致了一个公平的控制源存储库的建议</li><li>当然，这会让事情变得更复杂</li><li>这就是为什么最典型的解决方案似乎是简单地，忽略了这个问题</li></ul></li><li><br>尽管扫描结果很好，但Alpine镜像并不总是很好<br>
<ul><li>因为据报道<code class="prettyprint">musl libc</code>比<code class="prettyprint">glibc</code>慢，并不是每个依赖库都为这个平台提供构建</li></ul></li></ul><br>
<br>以下是原文。<br>
<br>我最近在破解容器时注意到，Docker开始在构建输出中突出Docker扫描命令。我已经忽略它的存在有一段时间了，所以是时候尝试一下了。<br>
<h3>扫描官方Python镜像</h3>Docker扫描命令使用一个第三方工具，称为Snyk Container。显然，这是某种漏洞扫描器。所以，我决定，主要是为了好玩，扫描我的一个镜像。这是一件非常基本的事情：<br>
<pre class="prettyprint"># latest stable at the time<br>
FROM python:3.9<br>
<br>
RUN pip install Flask<br>
<br>
COPY server.py server.py<br>
<br>
ENV FLASK_APP=server.py<br>
ENV FLASK_RUN_PORT=5000<br>
ENV FLASK_RUN_HOST=0.0.0.0<br>
<br>
EXPOSE 5000<br>
<br>
CMD ["flask", "run"]<br>
</pre><br>
我运行<code class="prettyprint">docker build -t python-flask</code>，然后容器扫描python-flask。令我非常惊讶的是，产生大量的输出！下面是一段摘录：<br>
<pre class="prettyprint">Testing python-flask...<br>
<br>
✗ Low severity vulnerability found in unbound/libunbound8<br>
Description: Improper Input Validation<br>
Info: https://snyk.io/vuln/SNYK-DEBIAN10-UNBOUND-534899<br>
Introduced through: mysql-defaults/default-libmysqlclient-dev@1.0.5<br>
From: mysql-defaults/default-libmysqlclient-dev@1.0.5 > mariadb-10.3/libmariadb-dev-compat@1:10.3.27-0+deb10u1 > mariadb-10.3/libmariadb-dev@1:10.3.27-0+deb10u1 > gnutls28/libgnutls28-dev@3.6.7-4+deb10u6 > gnutls28/libgnutls-dane0@3.6.7-4+deb10u6 > unbound/libunbound8@1.9.0-2+deb10u2<br>
<br>
✗ Low severity vulnerability found in tiff/libtiff5<br>
Description: Out-of-Bounds<br>
Info: https://snyk.io/vuln/SNYK-DEBIAN10-TIFF-1079067<br>
Introduced through: imagemagick@8:6.9.10.23+dfsg-2.1+deb10u1, imagemagick/libmagickcore-dev@8:6.9.10.23+dfsg-2.1+deb10u1<br>
From: imagemagick@8:6.9.10.23+dfsg-2.1+deb10u1 > imagemagick/imagemagick-6.q16@8:6.9.10.23+dfsg-2.1+deb10u1 > imagemagick/libmagickcore-6.q16-6@8:6.9.10.23+dfsg-2.1+deb10u1 > tiff/libtiff5@4.1.0+git191117-2~deb10u2<br>
From: imagemagick/libmagickcore-dev@8:6.9.10.23+dfsg-2.1+deb10u1 > imagemagick/libmagickcore-6.q16-dev@8:6.9.10.23+dfsg-2.1+deb10u1 > tiff/libtiff-dev@4.1.0+git191117-2~deb10u2 > tiff/libtiff5@4.1.0+git191117-2~deb10u2<br>
From: imagemagick/libmagickcore-dev@8:6.9.10.23+dfsg-2.1+deb10u1 > imagemagick/libmagickcore-6.q16-dev@8:6.9.10.23+dfsg-2.1+deb10u1 > tiff/libtiff-dev@4.1.0+git191117-2~deb10u2 > tiff/libtiffxx5@4.1.0+git191117-2~deb10u2 > tiff/libtiff5@4.1.0+git191117-2~deb10u2<br>
and 3 more...<br>
<br>
...<br>
<br>
✗ High severity vulnerability found in gcc-8<br>
Description: Insufficient Entropy<br>
Info: https://snyk.io/vuln/SNYK-DEBIAN10-GCC8-469413<br>
Introduced through: gcc-defaults/g++@4:8.3.0-1, libtool@2.4.6-9, imagemagick@8:6.9.10.23+dfsg-2.1+deb10u1, meta-common-packages@meta<br>
From: gcc-defaults/g++@4:8.3.0-1 > gcc-8@8.3.0-6<br>
From: libtool@2.4.6-9 > gcc-8@8.3.0-6<br>
From: gcc-defaults/g++@4:8.3.0-1 > gcc-8/g++-8@8.3.0-6 > gcc-8@8.3.0-6<br>
and 23 more...<br>
<br>
✗ High severity vulnerability found in djvulibre/libdjvulibre21<br>
Description: NULL Pointer Dereference<br>
Info: https://snyk.io/vuln/SNYK-DEBIAN10-DJVULIBRE-481572<br>
Introduced through: imagemagick/libmagickcore-dev@8:6.9.10.23+dfsg-2.1+deb10u1<br>
From: imagemagick/libmagickcore-dev@8:6.9.10.23+dfsg-2.1+deb10u1 > imagemagick/libmagickcore-6.q16-dev@8:6.9.10.23+dfsg-2.1+deb10u1 > djvulibre/libdjvulibre-dev@3.5.27.1-10 > djvulibre/libdjvulibre21@3.5.27.1-10<br>
From: imagemagick/libmagickcore-dev@8:6.9.10.23+dfsg-2.1+deb10u1 > imagemagick/libmagickcore-6.q16-dev@8:6.9.10.23+dfsg-2.1+deb10u1 > imagemagick/libmagickcore-6.q16-6-extra@8:6.9.10.23+dfsg-2.1+deb10u1 > djvulibre/libdjvulibre21@3.5.27.1-10<br>
From: imagemagick/libmagickcore-dev@8:6.9.10.23+dfsg-2.1+deb10u1 > imagemagick/libmagickcore-6.q16-dev@8:6.9.10.23+dfsg-2.1+deb10u1 > djvulibre/libdjvulibre-dev@3.5.27.1-10<br>
and 1 more...<br>
<br>
✗ High severity vulnerability found in bluez/libbluetooth3<br>
Description: Double Free<br>
Info: https://snyk.io/vuln/SNYK-DEBIAN10-BLUEZ-1018718<br>
Introduced through: bluez/libbluetooth-dev@5.50-1.2~deb10u1<br>
From: bluez/libbluetooth-dev@5.50-1.2~deb10u1 > bluez/libbluetooth3@5.50-1.2~deb10u1<br>
From: bluez/libbluetooth-dev@5.50-1.2~deb10u1<br>
<br>
<br>
<br>
Package manager:   deb<br>
Project name:      docker-image|python-flask<br>
Docker image:      python-flask<br>
Platform:          linux/amd64<br>
<br>
Tested 431 dependencies for known vulnerabilities, found 358 vulnerabilities.<br>
<br>
For more free scans that keep your images secure, sign up to Snyk at https://dockr.ly/3ePqVcp<br>
</pre><br>
共发现漏洞358个，其中高级别54个，中级别48个。<br>
<br>仔细查看扫描报告后，我发现的大部分漏洞可能与Debian有关（参见信息：<a href="https://snyk.io/vuln/SNYK-" rel="nofollow" target="_blank">https://snyk.io/vuln/SNYK-DEBIAN10-</a>…稍高一点，报告中很多项目都有）。<br>
<br>显然，python:3.9镜像是基于成熟的Debian 10发行版。<br>
<div class="aw-upload-img-list active">
<a href="http://dockone.io/uploads/article/20211211/0442e528485f7b2900a2df23ebedcf2e.png" target="_blank" data-fancybox-group="thumb" rel="lightbox"><img src="https://cors.zfour.workers.dev/?http://dockone.io/uploads/article/20211211/0442e528485f7b2900a2df23ebedcf2e.png" class="img-polaroid" title="1.png" alt="1.png" referrerpolicy="no-referrer"></a>
</div>
<br>
<em>114MB的潜在安全漏洞</em><br>
<br>老实说，这是令人兴奋的！我知道容器越厚，潜在的攻击面就越高。但无论如何，我没想到会有这么大的规模。<br>
<br>好的，让我们试着把镜像瘦身……<br>
<pre class="prettyprint">FROM python:3.9-slim<br>
<br>
RUN pip install Flask<br>
<br>
COPY server.py server.py<br>
<br>
ENV FLASK_APP=server.py<br>
ENV FLASK_RUN_PORT=5000<br>
ENV FLASK_RUN_HOST=0.0.0.0<br>
<br>
EXPOSE 5000<br>
<br>
CMD ["flask", "run"]<br>
</pre><br>
扫描python:3.9-slim的镜像给了我更好的结果：<br>
<pre class="prettyprint">Package manager:   deb<br>
Project name:      docker-image|python-flask-slim<br>
Docker image:      python-flask-slim<br>
Platform:          linux/amd64<br>
<br>
Tested 94 dependencies for known vulnerabilities, found 69 vulnerabilities.<br>
</pre><br>
共发现69个漏洞，其中高级别14个，中级别8个。<br>
<div class="aw-upload-img-list active">
<a href="http://dockone.io/uploads/article/20211211/5d3e1a8039445108b42cb359959dcd3d.png" target="_blank" data-fancybox-group="thumb" rel="lightbox"><img src="https://cors.zfour.workers.dev/?http://dockone.io/uploads/article/20211211/5d3e1a8039445108b42cb359959dcd3d.png" class="img-polaroid" title="2.png" alt="2.png" referrerpolicy="no-referrer"></a>
</div>
<br>
<em>基础镜像每兆字节有一个漏洞……</em><br>
<br>我们能做得更好吗？让我们尝试python: 3.9-alpine：<br>
<pre class="prettyprint">FROM python:3.9-alpine<br>
<br>
RUN pip install Flask<br>
<br>
COPY server.py server.py<br>
<br>
ENV FLASK_APP=server.py<br>
ENV FLASK_RUN_PORT=5000<br>
ENV FLASK_RUN_HOST=0.0.0.0<br>
<br>
EXPOSE 5000<br>
<br>
CMD ["flask", "run"]<br>
</pre><br>
终于，0已知的漏洞！<br>
<pre class="prettyprint">Package manager:   apk<br>
Project name:      docker-image|python-flask-alpine<br>
Docker image:      python-flask-alpine<br>
Platform:          linux/amd64<br>
<br>
✓ Tested 37 dependencies for known issues, no vulnerable paths found.<br>
</pre><br>
<div class="aw-upload-img-list active">
<a href="http://dockone.io/uploads/article/20211211/7fa9dfb4d4a7aa3f1b43d01891267b48.png" target="_blank" data-fancybox-group="thumb" rel="lightbox"><img src="https://cors.zfour.workers.dev/?http://dockone.io/uploads/article/20211211/7fa9dfb4d4a7aa3f1b43d01891267b48.png" class="img-polaroid" title="3.png" alt="3.png" referrerpolicy="no-referrer"></a>
</div>
<br>
<em>5.6 MB Alpine！</em><br>
<h3>扫描无发布的Python镜像</h3>另一个可能解决膨胀容器问题的方案是谷歌所谓的“非发行版”Docker镜像。项目描述说它是“语言聚焦Docker镜像，减去操作系统”。尽管这在Python的情况下很难实现，因为它的标准库依赖于一些高级操作系统功能。<br>
<br>我花了一段时间才想出一个可以工作的非发行版Python镜像。大多数示例都展示了如何使用一些简单的脚本。然而，安装Flask（或任何其他依赖项）比我预期的要困难得多。由于gcr，Python的无发行版容器需要多阶段的构建过程。<code class="prettyprint">gcr.io/distroless/python3</code>镜像既没有PIP，也没有easy_install。首先，我试图利用构建镜像中的虚拟环境，然后将其复制到运行时镜像中，并修改PATH变量。但它并没有很好地工作，因为基本的非发行版镜像在文件系统布局上做了一些自以为是的布局：<br>
<div class="aw-upload-img-list active">
<a href="http://dockone.io/uploads/article/20211211/d0b00605962bc03f43cab1b3ac7a1d5b.png" target="_blank" data-fancybox-group="thumb" rel="lightbox"><img src="https://cors.zfour.workers.dev/?http://dockone.io/uploads/article/20211211/d0b00605962bc03f43cab1b3ac7a1d5b.png" class="img-polaroid" title="4.png" alt="4.png" referrerpolicy="no-referrer"></a>
</div>
<br>
<em>预料之中的是，Linux distr仍然存在，但是它比debian还要薄</em><br>
<br>所以，我最终得到了以下Dockerfile，允许我在非发行版的Python镜像中安装Flask：<br>
<pre class="prettyprint"># Build image<br>
FROM python:3.7-slim AS build-env<br>
<br>
RUN python -m pip install Flask<br>
<br>
# Runtime image<br>
FROM gcr.io/distroless/python3<br>
<br>
COPY --from=build-env /usr/local/bin/flask /usr/local/bin/flask<br>
COPY --from=build-env /usr/local/lib/python3.7/site-packages /usr/local/lib/python3.7/site-packages<br>
<br>
WORKDIR /app<br>
<br>
COPY server.py server.py<br>
<br>
# Important line!<br>
ENV PYTHONPATH=/usr/local/lib/python3.7/site-packages<br>
<br>
ENV FLASK_APP=server.py<br>
ENV FLASK_RUN_PORT=5000<br>
ENV FLASK_RUN_HOST=0.0.0.0<br>
<br>
EXPOSE 5000<br>
<br>
CMD ["/usr/local/bin/flask", "run"]<br>
</pre><br>
扫描它与Docker扫描输出以下结果：<br>
<pre class="prettyprint">Package manager:   deb<br>
Project name:      docker-image|python-flask-distroless<br>
Docker image:      python-flask-distroless<br>
Platform:          linux/amd64<br>
<br>
Tested 25 dependencies for known vulnerabilities, found 37 vulnerabilities.<br>
</pre><br>
所以，只有37个漏洞：6个严重程度高，8个中等。听起来好像比原始的python:3.9镜像减少了90%！它甚至比python:3.9-slim中的漏洞更少。<br>
<br>因此，我们的基于Alpine的Python镜像是一个赢家！<br>
<h3>扫描Go镜像</h3>我喜欢完全从零开始构建容器镜像的想法，避免将任何distr内容放入其中。但为此，你需要一种对静态构建有深刻支持的语言，例如Go：<br>
<pre class="prettyprint">FROM scratch<br>
<br>
COPY hello /<br>
CMD ["/hello"]<br>
</pre><br>
得出以下结果……没错，这就是它！<br>
<pre class="prettyprint">Testing go-scratch...<br>
<br>
Package manager:   linux<br>
Project name:      docker-image|go-scratch<br>
Docker image:      go-scratch<br>
Platform:          linux/amd64<br>
<br>
✓ Tested go-scratch for known vulnerabilities, no vulnerable paths found.<br>
</pre><br>
没有distr并不意味着没有漏洞。但它确实降低了攻击的可能性。<br>
<div class="aw-upload-img-list active">
<a href="http://dockone.io/uploads/article/20211211/f00f675c152c6980a231e0de945a21d6.png" target="_blank" data-fancybox-group="thumb" rel="lightbox"><img src="https://cors.zfour.workers.dev/?http://dockone.io/uploads/article/20211211/f00f675c152c6980a231e0de945a21d6.png" class="img-polaroid" title="5.png" alt="5.png" referrerpolicy="no-referrer"></a>
</div>
<br>
<h3>相反的结论</h3>根据我的经验，膨胀的镜像通常是使用默认的From bloated_base，或者因为人们为了将来的调试/故障排除故意将额外的工具放入镜像的结果。<br>
<br>第一种可能是Docker过去大规模营销活动的结果。为了普及容器，你需要给人们一些看起来很酷和方便的东西。而且能够在一秒钟内从你的开发机器上启动一个成熟的Linux distr（某种程度上），即使在今天看起来也很酷。一些本地的修补和/或实验从<code class="prettyprint">docker run -it ubuntu</code>中获益良多。然而，我希望它从来没有被用于生产。但是从一个成熟的Debian，CentOS，或者Ubuntu开始，Dockerfile的例子实在是太多了，至少要避免将其中一些渗透到我们的生产环境中。<br>
<br>第二个原因看起来更合理。但我有一种感觉，这只是第一眼看到的感觉。理想情况下，应该有另一种方法来调试你的容器化服务。这种方法不需要将所有潜在需要的工具打包到一个容器中。最近添加的kubectl调试功能很好地证明了这一假设。它允许将临时容器注入运行中的Pod中，这样的容器可以拥有调试所需的所有东西。<br>
<br>更小的容器不仅仅意味着更快的构建和更小的磁盘和网络利用率，它们还意味着更安全。<br>
<br><strong>原文链接：<a href="https://iximiuz.com/en/posts/thick-container-vulnerabilities/">The Need For Slimmer Containers</a></strong><br>
<br><strong>译者</strong>：Mr.lzc，软件工程师、DevOpsDays、HDZ深圳核心组织者，目前供职于华为，从事云计算工作，专注于K8s、微服务领域。
                                                                <div class="aw-upload-img-list">
                                                                                                                                                                                                                                                                                                                                                                                                </div>
                                
                                                                <ul class="aw-upload-file-list">
                                                                                                                                                                                                                                                                                                                                                                                                                                            </ul>
                                                              
</div>
            