
---
title: '微服务下的网关如何选择'
categories: 
 - 编程
 - Dockone
 - 周报
headimg: 'https://cors.zfour.workers.dev/?http://dockone.io/uploads/article/20210812/c548f5ccff29a20e00c72085709ec0b6.png'
author: Dockone
comments: false
date: 2021-08-13 05:06:48
thumbnail: 'https://cors.zfour.workers.dev/?http://dockone.io/uploads/article/20210812/c548f5ccff29a20e00c72085709ec0b6.png'
---

<div>   
<br><h3>为什么出现网关</h3>微服务的架构体系中，可以简单的看做是一个大应用拆分为多个小应用，小应用可以自成体系，可以拥有自己的数据库、框架甚至于语言等等，各个小应用一般通过Rest接口的形式被第三方、H5或者APP去调用。这个时候必然会存在一种情况，某些页面需要多个服务组合才能得到用户需要的信息。举个栗子：<br>
<br>在电商系统中，查看商品详情页，这个商品详情页包含商品的详情，价格，库存，评论等，这些数据对于后端来说位于不同的微服务系统之中，后台的系统是这样来拆分服务的：<br>
<ul><li>商品服务：负责提供商品的标题，描述，规格等。  </li><li>营销服务：负责对产品进行定价，价格策略计算，促销价等。  </li><li>库存服务：负责产品库存。  </li><li>评价服务：负责用户对商品的评论，回复等。</li></ul><br>
<br>我们不做任何处理的时候，调用的时候是这样：<br>
<div class="aw-upload-img-list active">
<a href="http://dockone.io/uploads/article/20210812/c548f5ccff29a20e00c72085709ec0b6.png" target="_blank" data-fancybox-group="thumb" rel="lightbox"><img src="https://cors.zfour.workers.dev/?http://dockone.io/uploads/article/20210812/c548f5ccff29a20e00c72085709ec0b6.png" class="img-polaroid" title="1.png" alt="1.png" referrerpolicy="no-referrer"></a>
</div>
<br>
该处的缺点就是前端需要调用多次服务才能拿到我们想要的数据，为了解决这个问题我们可以做一层中间的聚合层，聚合层也就是我们通常所说的BFF（Back-end for Front-end），BFF可以认为是一种适配服务，将后端的微服务进行适配（主要包括聚合裁剪和格式适配等逻辑），实现上没太大限制，能做请求转发和数据转化即可，升级以后框架是这样的，之前我们系统处于这个阶段：<br>
<div class="aw-upload-img-list active">
<a href="http://dockone.io/uploads/article/20210812/fca1754d0e68dd397a0da8ec79e6188a.png" target="_blank" data-fancybox-group="thumb" rel="lightbox"><img src="https://cors.zfour.workers.dev/?http://dockone.io/uploads/article/20210812/fca1754d0e68dd397a0da8ec79e6188a.png" class="img-polaroid" title="2.png" alt="2.png" referrerpolicy="no-referrer"></a>
</div>
<br>
<ol><li>多个聚合层有很多跨横切面的代码是重复的，比如安全认证，日志监控，限流熔断等，随着时间的发展代码变得不可维护；  </li><li>随着访问量、业务的增加，两个BFF层也满足不了我们的业务，需要抽象更多的BFF和采用集群部署的方式。</li></ol><br>
<br>接下来我们再次升级我们架构，如下图：<br>
<div class="aw-upload-img-list active">
<a href="http://dockone.io/uploads/article/20210812/23a037c9c7e3a7b9168aa8ae21e0443f.png" target="_blank" data-fancybox-group="thumb" rel="lightbox"><img src="https://cors.zfour.workers.dev/?http://dockone.io/uploads/article/20210812/23a037c9c7e3a7b9168aa8ae21e0443f.png" class="img-polaroid" title="3.png" alt="3.png" referrerpolicy="no-referrer"></a>
</div>
<br>
这里我们引入的我们本章的主角网关，由于网关的加入我们可以将所有的跨横切面的代码通通抽象到网关层，这样我们BFF层只需要关注服务适配的逻辑，另外也解决掉了之前业务单点、多节点的等问题，这个时候你可能又想，网关的部署也是单点了，这个时候你可以考虑在网关前挂一层NG或者F5，如果随着业务发展网关管理的服务越来越多，也可以将网关按照业务域进行整体的拆分。  <br>
<br>到这里你一定了解到了为什么需要网关，写到这里我突然想到某个伟人说的一句话，没有什么是加一个中间层解决不了的，如果有，就加两个……，BFF也好、网关也好都是我们的中间层。<br><br>
<h3>网关选型</h3>目前市面上根据技术栈实现的不同大概有如下一些网关：<br>
<div class="aw-upload-img-list active">
<a href="http://dockone.io/uploads/article/20210812/5dbbfe47e7704b90ce6691a527b9c641.png" target="_blank" data-fancybox-group="thumb" rel="lightbox"><img src="https://cors.zfour.workers.dev/?http://dockone.io/uploads/article/20210812/5dbbfe47e7704b90ce6691a527b9c641.png" class="img-polaroid" title="4.png" alt="4.png" referrerpolicy="no-referrer"></a>
</div>
<br>
接下来我们就简单了解下以上5个网关：<br>
<br><strong>Nginx</strong>：Nginx由内核和模块组成，内核的设计非常微小和简洁，完成的工作也非常简单，仅仅通过查找配置文件与客户端请求进行URL匹配，用于启动不同的模块去完成相应的工作。<br>
<div class="aw-upload-img-list active">
<a href="http://dockone.io/uploads/article/20210812/73cd9b0d8e624780260101fa60a5915e.png" target="_blank" data-fancybox-group="thumb" rel="lightbox"><img src="https://cors.zfour.workers.dev/?http://dockone.io/uploads/article/20210812/73cd9b0d8e624780260101fa60a5915e.png" class="img-polaroid" title="5.png" alt="5.png" referrerpolicy="no-referrer"></a>
</div>
<br>
Nginx在启动后，会有一个Master进程和多个Worker进程，Master进程和Worker进程之间是通过进程间通信进行交互的，如图所示。Worker工作进程的阻塞点是在像select()、epoll_wait()等这样的I/O多路复用函数调用处，以等待发生数据可读/写事件。Nginx采用了异步非阻塞的方式来处理请求，也就是说，Nginx是可以同时处理成千上万个请求的。<br>
<br>还可以将Lua嵌入到Nginx中，从而可以使用Lua来编写脚本，这样就可以使用Lua编写应用脚本，部署到Nginx中运行，即Nginx变成了一个Web容器；这样开发人员就可以使用Lua语言开发高性能Web应用了。在开发的时候使用OpenResty来搭建开发环境，OpenResty将Nginx核心、LuaJIT、许多有用的Lua库和Nginx第三方模块打包在一起；这样只需要安装OpenResty，不需要了解Nginx核心和写复杂的C/C++模块就可以，只需要使用Lua语言进行Web应用开发了。<br>
<br><strong>Kong</strong>：Kong是一款基于OpenResty（Nginx + Lua模块）编写的高可用、易扩展的，由Mashape公司开源的API Gateway项目。Kong是基于NGINX和Apache Cassandra或PostgreSQL构建的，能提供易于使用的RESTful API来操作和配置API管理系统，所以它可以水平扩展多个Kong服务器，通过前置的负载均衡配置把请求均匀地分发到各个Server，来应对大批量的网络请求。<br>
<div class="aw-upload-img-list active">
<a href="http://dockone.io/uploads/article/20210812/7bedc84d10963ca7adf38de176673de4.png" target="_blank" data-fancybox-group="thumb" rel="lightbox"><img src="https://cors.zfour.workers.dev/?http://dockone.io/uploads/article/20210812/7bedc84d10963ca7adf38de176673de4.png" class="img-polaroid" title="6.png" alt="6.png" referrerpolicy="no-referrer"></a>
</div>
<br>
Kong主要有三个组件：<br>
<ol><li>Kong Server：基于Nginx的服务器，用来接收API请求。</li><li>Apache Cassandra/PostgreSQL：用来存储操作数据。</li><li>Kong dashboard：官方推荐UI管理工具，当然，也可以使用RESTful方式管理admin api。</li></ol><br>
<br>Kong采用插件机制进行功能定制，插件集（可以是0或N个）在API请求响应循环的生命周期中被执行。插件使用Lua编写，目前已有几个基础功能：HTTP基本认证、密钥认证、CORS（Cross-Origin Resource Sharing，跨域资源共享）、TCP、UDP、文件日志、API请求限流、请求转发以及Nginx监控。<br>
<div class="aw-upload-img-list active">
<a href="http://dockone.io/uploads/article/20210812/5484685e393748253c732d0929afc669.png" target="_blank" data-fancybox-group="thumb" rel="lightbox"><img src="https://cors.zfour.workers.dev/?http://dockone.io/uploads/article/20210812/5484685e393748253c732d0929afc669.png" class="img-polaroid" title="7.png" alt="7.png" referrerpolicy="no-referrer"></a>
</div>
<br>
Kong网关具有以下的特性：<br>
<ol><li>可扩展性：通过简单地添加更多的服务器，可以轻松地进行横向扩展，这意味着您的平台可以在一个较低负载的情况下处理任何请求；</li><li>模块化：可以通过添加新的插件进行扩展，这些插件可以通过RESTful Admin API轻松配置；</li><li>在任何基础架构上运行：Kong网关可以在任何地方都能运行。您可以在云或内部网络环境中部署Kong，包括单个或多个数据中心设置，以及public，private 或invite-only APIs。</li></ol><br>
<br><strong>Netfilx Zuul</strong>：Zuul是Netflix开源的微服务网关组件，它可以和Eureka、Ribbon、Hystrix等组件配合使用。社区活跃，融合于Spring Cloud完整生态，是构建微服务体系前置网关服务的最佳选型。<br>
<div class="aw-upload-img-list active">
<a href="http://dockone.io/uploads/article/20210812/ad9d4628a220441188cbf618a5029935.jpeg" target="_blank" data-fancybox-group="thumb" rel="lightbox"><img src="https://cors.zfour.workers.dev/?http://dockone.io/uploads/article/20210812/ad9d4628a220441188cbf618a5029935.jpeg" class="img-polaroid" title="8.jpeg" alt="8.jpeg" referrerpolicy="no-referrer"></a>
</div>
<br>
Zuul的核心是一系列的filters，Zuul的核心是一系列的过滤器，这些过滤器可以完成以下功能：<br>
<ol><li>身份认证与安全：识别每个资源的验证要求，并拒绝那些与要求不符的请求。</li><li>审查与监控：与边缘位置追踪有意义的数据和统计结果，从而带来精确的生产视图。</li><li>动态路由：动态地将请求路由到不同的后端集群。</li><li>压力测试：逐渐增加指向集群的流量，以了解性能。</li><li>负载分配：为每一种负载类型分配对应容量，并弃用超出限定值的请求。</li><li>静态响应处理：在边缘位置直接建立部分响应，从而避免其转发到内部集群。</li><li>多区域弹性：跨越AWS Region进行请求路由，旨在实现ELB（Elastic Load Balancing，弹性负载均衡）使用的多样化，以及让系统的边缘更贴近系统的使用者。</li></ol><br>
<br>Zuul目前有两个大的版本：Zuul1和Zuul2。<br>
<br>Zuul1是基于Servlet框架构建，如图所示，采用的是阻塞和多线程方式，即一个线程处理一次连接请求，这种方式在内部延迟严重、设备故障较多情况下会引起存活的连接增多和线程增加的情况发生。<br>
<div class="aw-upload-img-list active">
<a href="http://dockone.io/uploads/article/20210812/b112fbf91a2e4092ecf0955d118622ec.png" target="_blank" data-fancybox-group="thumb" rel="lightbox"><img src="https://cors.zfour.workers.dev/?http://dockone.io/uploads/article/20210812/b112fbf91a2e4092ecf0955d118622ec.png" class="img-polaroid" title="9.png" alt="9.png" referrerpolicy="no-referrer"></a>
</div>
<br>
Netflix发布的Zuul2有重大的更新，它运行在异步和无阻塞框架上，每个CPU核一个线程，处理所有的请求和响应，请求和响应的生命周期是通过事件和回调来处理的，这种方式减少了线程数量，因此开销较小。<br><br>
<div class="aw-upload-img-list active">
<a href="http://dockone.io/uploads/article/20210812/f56b3dd15ac65ed70eaf8ff1498ee87c.png" target="_blank" data-fancybox-group="thumb" rel="lightbox"><img src="https://cors.zfour.workers.dev/?http://dockone.io/uploads/article/20210812/f56b3dd15ac65ed70eaf8ff1498ee87c.png" class="img-polaroid" title="10.png" alt="10.png" referrerpolicy="no-referrer"></a>
</div>
<br>
<strong>Spring Cloud GetWay</strong>：Spring Cloud Gateway是Spring Cloud的一个全新的API网关项目，目的是为了替换掉Zuul1。Gateway可以与Spring Cloud Discovery Client（如Eureka）、Ribbon、Hystrix等组件配合使用，实现路由转发、负载均衡、熔断等功能，并且Gateway还内置了限流过滤器，实现了限流的功能。<br>
<div class="aw-upload-img-list active">
<a href="http://dockone.io/uploads/article/20210812/14e4a7167e93b17c2b0c09c0736736b4.png" target="_blank" data-fancybox-group="thumb" rel="lightbox"><img src="https://cors.zfour.workers.dev/?http://dockone.io/uploads/article/20210812/14e4a7167e93b17c2b0c09c0736736b4.png" class="img-polaroid" title="11.png" alt="11.png" referrerpolicy="no-referrer"></a>
</div>
<br>
Gateway基于Spring 5、Spring Boot 2和Reactor构建，使用Netty作为运行时环境，比较完美的支持异步非阻塞编程。Netty使用非阻塞的IO，线程处理模型建立在主从Reactors多线程模型上。其中Boss Group轮询到新连接后与Client建立连接，生成NioSocketChannel，将channel绑定到Worker；Worker Group轮询并处理Read、Write事件。<br>
<br><strong>Soul</strong>：Soul是一个异步的，高性能的，跨语言的，响应式的API网关。参考了Kong，Spring-Cloud-Gateway等优秀的网关后，站在巨人的肩膀上，Soul由此诞生！<br>
<div class="aw-upload-img-list active">
<a href="http://dockone.io/uploads/article/20210812/763593c86d4a798d3c9c883c94291456.png" target="_blank" data-fancybox-group="thumb" rel="lightbox"><img src="https://cors.zfour.workers.dev/?http://dockone.io/uploads/article/20210812/763593c86d4a798d3c9c883c94291456.png" class="img-polaroid" title="12.png" alt="12.png" referrerpolicy="no-referrer"></a>
</div>
<br>
Soul特征：<br>
<ol><li>支持各种语言，无缝集成Dubbo，Spring Cloud。</li><li>丰富的插件支持，鉴权，限流，熔断，防火墙等等。</li><li>网关多种规则动态配置，支持各种策略配置。</li><li>插件热插拔，易扩展</li><li>支持集群部署，支持A/B Test</li></ol><br>
<br>总结一下：<br>
<ul><li>性能，Nginx+Lua形式必然是高于Java语言实现的网关的，Java技术栈里面Zuul1.0是基于Servlet实现的，剩下都是基于WebFlux实现，性能是高于基于Servlet实现的。在性能方面我觉得选择网关可能不算那么重要，多加几台机器就可以搞定。</li><li>可维护性和扩展性，Nginx+Lua这个组合掌握的人不算多，如果团队有大神，大佬们就随意了，当没看到这段话，对于一般团队来说的话，选择自己团队擅长的语言更重要，所以我选择了Java技术栈下的网关。Java技术栈下的3种网关，对于Zuul和Spring Cloud Getway需要或多或少要搞一些集成和配置页面来维护，但是对于Soul我就无脑看看文章，需要哪个搬哪个好了，尤其是可以无脑对接Dubbo美滋滋，此外Soul2.0以后版本可以摆脱ZK，在我心里再无诟病，我就喜欢无脑操作。</li><li>高可用，对于网关高可用基本都是统一的策略都是采用多机器部署的方式，前面挂一个负载，对于而外需要用的一些组件大家注意一下。</li></ul><br>
<br>原文链接：<a href="https://www.cnblogs.com/wtzbk/p/14009219.html" rel="nofollow" target="_blank">https://www.cnblogs.com/wtzbk/p/14009219.html</a>
                                                                <div class="aw-upload-img-list">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </div>
                                
                                                                <ul class="aw-upload-file-list">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </ul>
                                                              
</div>
            