
---
title: '仅需添加1个参数，即可飞速拉取Rancher镜像！'
categories: 
 - 编程
 - Dockone
 - 周报
headimg: 'https://img-blog.csdnimg.cn/20210511233044971.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L1JhbmNoZXJMYWJz,size_16,color_FFFFFF,t_70'
author: Dockone
comments: false
date: 2021-05-13 04:12:01
thumbnail: 'https://img-blog.csdnimg.cn/20210511233044971.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L1JhbmNoZXJMYWJz,size_16,color_FFFFFF,t_70'
---

<div>   
<br><blockquote><br>作者简介<br>
  <br>
  <br>王海龙，SUSE/Rancher中国社区技术经理，负责Rancher中国技术社区的维护和运营。拥有7年的云计算领域经验，经历了OpenStack到Kubernetes的技术变革，无论底层操作系统Linux，还是虚拟化KVM或是Docker容器技术都有丰富的运维和实践经验。</blockquote><h2>前  言</h2>离线安装部署可以让企业在内网环境顺利运行Rancher，但是在国内网络环境中进行Rancher离线安装时，由于镜像本身较大以及网络的影响下载所需的镜像耗时较长。<br>
<br>Rancher 提供的 <strong>rancher-images.txt</strong> 有 100+个镜像，压缩后的大小也将近 8G。从 Rancher release（<strong><a href="https://github.com/rancher/rancher/releases" rel="nofollow" target="_blank">https://github.com/rancher/rancher/releases</a></strong>） 下载的 <strong>rancher-save-images.sh</strong> 默认从 dockerhub 拉取镜像。如果所有镜像都从 dockerhub 下载，那将是一个非常艰巨的任务。<br>
<br>为了进一步提升国内用户体验，Rancher 针对国内环境做了一些优化， 在 <strong>rancher-save-images.sh</strong> 中增加了 <strong>--from-aliyun true</strong> 参数, 来支持从国内的阿里云镜像仓库去拉取 <strong>rancher-images.txt</strong> 的镜像。<br>
<br><strong>注意：</strong><br>
<ol><li>从 Rancher v2.4.15 和 v2.5.8 开始支持<strong>--from-aliyun true</strong> 参数。</li><li>从 Rancher release 中下载的 <strong>rancher-save-images.sh</strong> 暂不支持 <strong>--from-aliyun<br>
true</strong> 参数。</li><li>支持 <strong>--from-aliyun true</strong> 参数的 <strong>rancher-save-images.sh</strong> 可以从<a href="http://mirror.rancher.cn/" rel="nofollow" target="_blank">http://mirror.rancher.cn</a> --> <strong>rancher</strong> 获得。</li></ol><br>
<br><h2>操作步骤</h2>1、获取支持 <strong>--from-aliyun true</strong> 参数的 <strong>rancher-save-images.sh</strong><br>
<br>浏览器访问 <a href="http://mirror.rancher.cn/" rel="nofollow" target="_blank">http://mirror.rancher.cn</a>，然后导航到 rancher 目录下，选择对应的 rancher 版本，下载 <strong>rancher-save-images.sh。rancher-images.txt</strong> 和 <strong>rancher-load-images.sh</strong> 从 <a href="http://mirror.rancher.cn/" rel="nofollow" target="_blank">http://mirror.rancher.cn</a> 或 Rancher release 下载均可，无差别。<br>
<br><img src="https://img-blog.csdnimg.cn/20210511233044971.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L1JhbmNoZXJMYWJz,size_16,color_FFFFFF,t_70" alt="图片" referrerpolicy="no-referrer"><br>
<br>2、从阿里云镜像仓库拉取镜像并打包<br>
<br><code class="prettyprint">root@ip-172-31-21-94:~/image# ./rancher-save-images.sh -h<br>
USAGE: ./rancher-save-images.sh [--image-list rancher-images.txt] [--images rancher-images.tar.gz] [--from-aliyun true]<br>
  [-l|--image-list path] text file with list of images; one image per line.<br>
  [-i|--images path] tar.gz generated by docker save.<br>
  [--from-aliyun true|false] get an image from aliyun<br>
  [-h|--help] Usage message<br>
root@ip-172-31-21-94:~/image#<br>
root@ip-172-31-21-94:~/image# ./rancher-save-images.sh --from-aliyun true<br>
Image pull success: registry.cn-hangzhou.aliyuncs.com/rancher/busybox<br>
Image pull success: registry.cn-hangzhou.aliyuncs.com/rancher/backup-restore-operator:v1.0.4-rc4<br>
Image pull success: registry.cn-hangzhou.aliyuncs.com/rancher/cis-operator:v1.0.4<br>
Image pull success: registry.cn-hangzhou.aliyuncs.com/rancher/configmap-reload:v0.3.0-rancher4<br>
Image pull success: registry.cn-hangzhou.aliyuncs.com/rancher/coredns-coredns:1.6.2<br>
...</code><br>
<br>从以上日志中可以看出使用 <strong>--from-aliyun true</strong> 指定了从阿里云镜像仓库拉取镜像，速度比从 dockerhub 拉镜像快了 N 倍。<br>
<br>脚本执行成功后会在当前目录生成 <strong>rancher-images.tar.gz</strong> 的镜像压缩包。<br>
<br>3、推送镜像到私有镜像库<br>
<br>这一步，你将使用脚本将文件 <strong>rancher-images.tar.gz</strong> 中的镜像上传到您自己的私有镜像库。<br>
<br>文件 rancher-images.txt 、 rancher-images.tar.gz 应该和 <strong>rancher-load-images.sh</strong> 脚本在同一目录下。<br>
<br>登录私有镜像库<br>
<br><code class="prettyprint">docker login harbor.kingsd.top</code><br>
<br>推送镜像<br>
<br><code class="prettyprint">./rancher-load-images.sh --registry harbor.kingsd.top</code><br>
<br>等待执行成功后，就可以在私有镜像仓库中看到所有 Rancher 需要的镜像已经上传完毕。<br>
<br><h2>后  记</h2>本文的操作步骤和Rancher官方文档的离线安装基本相同，只不过在本文中 rancher-save-images.sh 从 <a href="http://mirror.rancher.cn/" rel="nofollow" target="_blank">http://mirror.rancher.cn</a> 下载，并且在执行 rancher-save-images.sh 时增加了 --from-aliyun true 参数来指定从阿里云镜像仓库下载。<br>
<br>希望通过这篇文章可以大大提升Rancher国内用户的离线安装体验，如果有任何Rancher相关的经验分享或是使用疑问欢迎扫描文末二维码加入技术交流群，和各位Rancher用户一起交流。<br>
<img src="https://img-blog.csdnimg.cn/20210512082439692.jpg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L1JhbmNoZXJMYWJz,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述" referrerpolicy="no-referrer">
                                
                                                              
</div>
            