
---
title: '边开飞机边换引擎？我们造了个新功能保障业务流量无损迁移'
categories: 
 - 编程
 - Dockone
 - 周报
headimg: 'https://ucc.alicdn.com/pic/developer-ecology/af5212262d00485ca839da20698a9f06.png'
author: Dockone
comments: false
date: 2021-04-28 12:10:54
thumbnail: 'https://ucc.alicdn.com/pic/developer-ecology/af5212262d00485ca839da20698a9f06.png'
---

<div>   
<br><img src="https://ucc.alicdn.com/pic/developer-ecology/af5212262d00485ca839da20698a9f06.png" alt="头图.png" referrerpolicy="no-referrer"><br>
<br>作者 | 顾静（子白）<br>
来源 | <a href="https://mp.weixin.qq.com/s/skKMvRo75gD9suCCgV2KZQ">阿里巴巴云原生公众号</a><br>
<br>容器化部署应用可以降低企业成本，提升研发效率，解放运维人员。据 Gartner 预计，到 2022 年，将有 75％ 的企业将在生产中运行容器化应用程序。Kubernetes 是企业部署容器化应用的首选框架。由于 Kubernetes 部署及运维的复杂性，越来越多的客户选择将业务从 ECS 或者自建的 Kubernetes 迁移到阿里云托管版 Kubernetes —— ACK 中。但是，如何保证业务流量的平滑迁移成为一大挑战。<br>
<br>Cloud Controller Manager（CCM）是 ACK 的一个系统核心组件，负责对接 Kubernetes 与云上基础产品如 CLB、VPC、DNS 等。当 Service 的类型设置为 Type=LoadBalancer 时，CCM 会为该 Service 创建或配置阿里云负载均衡 CLB。当 Service 对应的后端 Endpoint 或者集群节点发生变化时，CCM 会自动更新 CLB 的后端虚拟服务器组。此外，CCM 还提供了许多阿里云注解，支持丰富的负载均衡能力。<br>
<br>近期 CCM 发布了一个新特性——<strong>支持在同一个 CLB 后端挂载集群内节点和集群外 ECS，借助这一特性可以解决业务容器化过程中流量平滑迁移的难题</strong>。<br>
<br><h1>场景一：应用容器化改造（流量平滑迁移）</h1><h2>对于一个 CLB，支持将流量转发至集群内及集群外节点</h2><div class="aw-upload-img-list active">
<a href="http://dockone.io/uploads/article/20210428/18260fd38ab82b57b7f6b11a93bce3f0.png" target="_blank" data-fancybox-group="thumb" rel="lightbox"><img src="http://dockone.io/uploads/article/20210428/18260fd38ab82b57b7f6b11a93bce3f0.png" class="img-polaroid" title="1.png" alt="1.png" referrerpolicy="no-referrer"></a>
</div>
<br>
<br><h3><strong>1）操作步骤</strong></h3><ul><li>登录 CLB 控制台创建 CLB，记录 CLB ID ("lb-xxxxx")</li><li>创建 Service</li></ul><br>
<br>设置 service.beta.kubernetes.io/alicloud-loadbalancer-force-override-listeners 为 false，不管理监听信息。<br>
<br>CCM 会自动创建对应的虚拟服务器组。<br>
<br><code class="prettyprint">cat &lt;&lt;EOF |kubectl apply -f -<br>
apiVersion: v1<br>
kind: Service<br>
metadata:<br>
  annotations:<br>
    service.beta.kubernetes.io/alibaba-cloud-loadbalancer-id: &quot;lb-xxxx&quot;<br>
    service.beta.kubernetes.io/alicloud-loadbalancer-force-override-listeners: &quot;false&quot;<br>
  labels:<br>
    app: nignx<br>
  name: my-nginx-svc<br>
  namespace: default<br>
spec:<br>
  ports:<br>
  - port: 80<br>
    protocol: TCP<br>
    targetPort: 80<br>
  selector:<br>
    app: nginx<br>
  type: LoadBalancer<br>
EOF</code><br>
<ul><li>登录 CLB 控制台，创建监听并关联虚拟服务器组</li><li>登录 CLB 控制台，手动在虚拟服务器组中添加集群外 ECS 并设置权重</li></ul><br>
<br><h3><strong>2）预期结果</strong></h3>配置完成后，在 CLB 的虚拟服务组里既可以看到集群内的节点，也可以看到集群外的 ECS。集群内应用进行扩缩容时，集群外的 ECS 节点不受影响。<br>
<br><div class="aw-upload-img-list active">
<a href="http://dockone.io/uploads/article/20210428/e23e8444ab60370bf0994c49083573be.png" target="_blank" data-fancybox-group="thumb" rel="lightbox"><img src="http://dockone.io/uploads/article/20210428/e23e8444ab60370bf0994c49083573be.png" class="img-polaroid" title="2.png" alt="2.png" referrerpolicy="no-referrer"></a>
</div>
<br>
<br><h1>场景二：金丝雀发布</h1><h2>支持金丝雀发布，将流量按比例转发至集群内及集群外节点</h2>迁移过程中，往往需要逐步将流量从存量 ECS 迁往 Kubernetes 集群中。CCM 支持通过 annotationservice.beta.kubernetes.io/alicloud-loadbalancer-weight为 Kubernetes 集群配置权重，从而实现流量的逐步迁移。<br>
<br><div class="aw-upload-img-list active">
<a href="http://dockone.io/uploads/article/20210428/75f29459c61353b44f388e25753307d8.png" target="_blank" data-fancybox-group="thumb" rel="lightbox"><img src="http://dockone.io/uploads/article/20210428/75f29459c61353b44f388e25753307d8.png" class="img-polaroid" title="3.png" alt="3.png" referrerpolicy="no-referrer"></a>
</div>
<br>
<br><h3><strong>1）注意事项</strong></h3><ul><li>不能跨 CLB 复用虚拟服务器组</li><li>一个虚拟服务器组只能与一个端口关联</li><li>集群内节点权重由 CCM 组件设置，集群外 ECS 权重需要用户手动设置</li></ul><br>
<br><h3><strong>2）操作步骤</strong></h3><ul><li>登录 CLB 控制台创建 CLB、监听及虚拟服务器组，记录 CLB ID ("lb-xxxx") 及虚拟服务器组 Id ("rsp-xxx")</li><li>手动在虚拟服务器组中添加集群外 ECS 并设置权重</li><li>创建 Service</li></ul><br>
<br><code class="prettyprint">apiVersion: v1<br>
kind: Service<br>
metadata:<br>
  annotations:<br>
    service.beta.kubernetes.io/alicloud-loadbalancer-id: &quot;lb-xxxxx&quot;<br>
    service.beta.kubernetes.io/alicloud-loadbalancer-vgroup-ids: &quot;80:rsp-xxx&quot;<br>
    # 集群内部权重为20%<br>
    service.beta.kubernetes.io/alicloud-loadbalancer-weight: &quot;20&quot;<br>
  name: nginx-svc<br>
  namespace: default<br>
spec:<br>
  ports:<br>
  - name: http<br>
    port: 80<br>
    protocol: TCP<br>
    targetPort: 80<br>
  selector:<br>
    app: nginx<br>
  sessionAffinity: None<br>
  type: LoadBalancer</code><br>
<br><h3><strong>3）预期结果</strong></h3>配置完成后，在 CLB 的虚拟服务组里既可以看到集群内的节点，也可以看到集群外的 ECS，集群节点的权重按照 annotation 配置。集群内应用进行扩缩容时，集群外的 ECS 节点不受影响。<br>
<br><h1>场景三：多集群业务流量多活与灾备</h1><h2>对于一个 CLB，支持将流量转发至多个 Kubernetes 集群内</h2>企业用户会采取多种措施以保障应用的高可用性，如创建多个集群进行备份、容灾等。这要求业务流量可以通过一个 CLB 接入多个 Kubernetes 集群中，并且支持为 Kubernetes 集群设置不同的权重，如下图所示。<br>
<br><div class="aw-upload-img-list active">
<a href="http://dockone.io/uploads/article/20210428/59f79b9480034185dc8cf94c11aeb84e.png" target="_blank" data-fancybox-group="thumb" rel="lightbox"><img src="http://dockone.io/uploads/article/20210428/59f79b9480034185dc8cf94c11aeb84e.png" class="img-polaroid" title="4.png" alt="4.png" referrerpolicy="no-referrer"></a>
</div>
<br>
<br><h3><strong>1）注意事项</strong></h3><ul><li>不能跨 CLB 复用虚拟服务器组</li><li>一个虚拟服务器组只能与一个端口关联</li><li>两个集群均已配置 Cluster Id，否则两个集群中的 service 需要不同名称</li></ul><br>
<br><h3><strong>2）操作步骤</strong></h3><ul><li>登录 CLB 控制台创建 CLB、监听及虚拟服务器组，记录 CLB ID ("lb-xxxx")  及虚拟服务器组 Id ("rsp-xxx")</li><li>集群 A 中创建 Serivce-A，权重设置为 20%</li></ul><br>
<br><code class="prettyprint">apiVersion: v1<br>
kind: Service<br>
metadata:<br>
  annotations:<br>
    service.beta.kubernetes.io/alicloud-loadbalancer-id: &quot;lb-xxxxx&quot;<br>
    service.beta.kubernetes.io/alicloud-loadbalancer-vgroup-ids: &quot;80:rsp-xxx&quot;<br>
    service.beta.kubernetes.io/alicloud-loadbalancer-weight: &quot;20&quot;<br>
  name: service-A<br>
  namespace: default<br>
spec:<br>
  ports:<br>
  - name: http<br>
    port: 80<br>
    protocol: TCP<br>
    targetPort: 80<br>
  selector:<br>
    app: nginx<br>
  sessionAffinity: None<br>
  type: LoadBalancer</code><br>
<br><h3><strong>3）预期结果</strong></h3>配置完成后，在 clb 的虚拟服务组里既可以看到集群 A 内的节点，也可以看到集群 B 的节点。集群节点的权重按照 annotation 自动设置。集群内应用进行扩缩容时，CLB 后端虚拟服务器组会自动更新。<br>
<br><h1>总结</h1>出于降本增效的考虑，越来越多的企业采用容器化方式部署应用。在业务迁移过程中，如何保障业务流量不受损成为一大难题。对于电商类应用而言，业务流量下跌往往会导致交易量下跌，造成重大损失。游戏类应用对业务流量也十分敏感，短暂的流量中断都会明显地影响游戏用户体验；交通类应用的流量下跌会影响交通流量管制、交通故障排险效率。保障业务流量不受损是保障用户业务正常运转的底线。<br>
<br>CCM 发布的支持在同一个 CLB 后端挂载集群内节点和集群外 ECS 的功能，可以一举解决迁移过程中流量中断的难题。同时，还支持将业务流量转发至多个 Kubernetes 集群内，支撑备份、容灾等需求，保障业务高可用。
                                                                <div class="aw-upload-img-list">
                                                                                                                                                                                                                                                                                                                                </div>
                                
                                                                <ul class="aw-upload-file-list">
                                                                                                                                                                                                                                                                                                                                                                    </ul>
                                                              
</div>
            