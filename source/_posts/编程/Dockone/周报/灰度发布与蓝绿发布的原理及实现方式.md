
---
title: '灰度发布与蓝绿发布的原理及实现方式'
categories: 
 - 编程
 - Dockone
 - 周报
headimg: 'https://cors.zfour.workers.dev/?http://dockone.io/uploads/article/20211228/6ea993ea0ba02e4984d79ce2237d7d3f.gif'
author: Dockone
comments: false
date: 2022-01-03 08:10:19
thumbnail: 'https://cors.zfour.workers.dev/?http://dockone.io/uploads/article/20211228/6ea993ea0ba02e4984d79ce2237d7d3f.gif'
---

<div>   
<br>通常产品优化迭代，直接将某版本上线发布给全部用户，若遇到线上事故（或BUG），解决周期较长，则不得不回滚到前一版本，会严重影响用户体验。使用灰度发布或蓝绿发布，能够有效避免因发布导致的流量丢失或服务不可用问题。究竟什么是灰度发布和蓝绿发布，怎么实现，让我们一探究竟。<br>
<h4>应用现状</h4>应用程序升级面临最大挑战是新旧业务切换，将软件从测试的最后阶段带到生产环境，同时要保证系统不间断提供服务。如果直接将某版本上线发布给全部用户，一旦遇到线上事故（或BUG），对用户的影响极大，解决问题周期较长，甚至有时不得不回滚到前一版本，严重影响了用户体验。<br><br>
<h4>解决方案</h4>长期以来，业务升级逐渐形成了几个发布策略：灰度发布、蓝绿发布、A/B测试、滚动升级以及分批暂停发布，尽可能避免因发布导致的流量丢失或服务不可用问题。本文着重介绍灰度发布和蓝绿发布的原理及实践。<br>
<br>灰度发布，又称金丝雀发布，是版本升级平滑过渡的一种方式，当版本升级时，使部分用户使用新版本，其他用户继续使用老版本，待新版本稳定后，逐步扩大范围把所有用户流量都迁移到新版本上面来。<br>
<br>这样可以最大限度地控制新版本发布带来的业务风险，降低故障带来的影响面，同时支持快速回滚。<br>
<br>以下示意图可描述灰度发布的大致流程：先切分20%的流量到新版本，若表现正常，逐步增加流量占比，继续测试新版本表现。若新版本一直很稳定，那么将所有流量都切分到新版本，并下线老版本。<br>
<div class="aw-upload-img-list active">
<a href="http://dockone.io/uploads/article/20211228/6ea993ea0ba02e4984d79ce2237d7d3f.gif" target="_blank" data-fancybox-group="thumb" rel="lightbox"><img src="https://cors.zfour.workers.dev/?http://dockone.io/uploads/article/20211228/6ea993ea0ba02e4984d79ce2237d7d3f.gif" class="img-polaroid" title="1.gif" alt="1.gif" referrerpolicy="no-referrer"></a>
</div>
<br>
切分20%的流量到新版本后，新版本出现异常，则快速将流量切回老版本。<br>
<div class="aw-upload-img-list active">
<a href="http://dockone.io/uploads/article/20211228/8e245d19d2244cb23f0e7093310f5f0a.gif" target="_blank" data-fancybox-group="thumb" rel="lightbox"><img src="https://cors.zfour.workers.dev/?http://dockone.io/uploads/article/20211228/8e245d19d2244cb23f0e7093310f5f0a.gif" class="img-polaroid" title="2.gif" alt="2.gif" referrerpolicy="no-referrer"></a>
</div>
<br>
蓝绿发布提供了一种零宕机的部署方式，是一种以可预测的方式发布应用的技术，目的是减少发布过程中服务停止的时间。<br>
<br>在保留老版本的同时部署新版本，将两个版本同时在线，新版本和老版本相互热备，通过切换路由权重的方式（非0即100）实现应用的不同版本上线或者下线，如果有问题可以快速地回滚到老版本。<br>
<div class="aw-upload-img-list active">
<a href="http://dockone.io/uploads/article/20211228/f1820819b191aff898071ca6cbf73854.gif" target="_blank" data-fancybox-group="thumb" rel="lightbox"><img src="https://cors.zfour.workers.dev/?http://dockone.io/uploads/article/20211228/f1820819b191aff898071ca6cbf73854.gif" class="img-polaroid" title="3.gif" alt="3.gif" referrerpolicy="no-referrer"></a>
</div>
<br>
<h4>灰度发布或蓝绿发布实现方式</h4>利用Kubernetes原生的特性可以实现简单的灰度发布或蓝绿发布，比如：通过修改Service的selector中决定服务版本的label的值来改变Service后端对应的Pod，实现让服务从一个版本直接切换到另一个版本，从而实现蓝绿发布。<br>
<br>如果您的灰度或蓝绿发布需求较复杂，可以向集群额外部署其他开源工具，例如Nginx Ingress、Traefik，或将业务部署至应用服务网格（Application Service Mesh，简称ASM），利用开源工具和服务网格的能力实现。  <br>
<br>三种实现方式对比：<br>
<div class="aw-upload-img-list active">
<a href="http://dockone.io/uploads/article/20211228/ee6448048df0d5a438491159ddbc64bc.png" target="_blank" data-fancybox-group="thumb" rel="lightbox"><img src="https://cors.zfour.workers.dev/?http://dockone.io/uploads/article/20211228/ee6448048df0d5a438491159ddbc64bc.png" class="img-polaroid" title="4.png" alt="4.png" referrerpolicy="no-referrer"></a>
</div>
<br>
这三种方式是如何实现灰度发布和蓝绿发布的，我们将在后续文章解答，敬请期待！<br>
<br>原文链接：<a href="https://mp.weixin.qq.com/s/V8Y8fHBOUgLtPb0YPuaqXg" rel="nofollow" target="_blank">https://mp.weixin.qq.com/s/V8Y8fHBOUgLtPb0YPuaqXg</a>
                                                                <div class="aw-upload-img-list">
                                                                                                                                                                                                                                                                                                                                </div>
                                
                                                                <ul class="aw-upload-file-list">
                                                                                                                                                                                                                                                                                                                                                                    </ul>
                                                              
</div>
            