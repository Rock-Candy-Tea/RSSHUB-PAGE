
---
title: '如何优雅的在业务中使用设计模式'
categories: 
 - 编程
 - Dockone
 - 周报
headimg: 'https://cors.zfour.workers.dev/?http://dockone.io/uploads/article/20210829/51314757b8a39781e1f374fe666605ee.png'
author: Dockone
comments: false
date: 2021-08-30 05:07:35
thumbnail: 'https://cors.zfour.workers.dev/?http://dockone.io/uploads/article/20210829/51314757b8a39781e1f374fe666605ee.png'
---

<div>   
<br><h3>前言</h3>有段时间没写文章了，最近沉迷Rust，无法自拔，锈儿有毒；这真是门非常有趣的语言，很多地方的设计，真的是满足了我所有的向往。<br>
<br>当然，这也不是一门简单的语言，提出所有权的概念，引入了极多符号：mut、&mut、ref mut、&、*、as_mut、as_ref……让人头秃……<br>
<br>之前看到过一句话，觉得很不错：<strong>学习Rust并不会给你带来智商上的优越感，但或许会让你重新爱上编程</strong>。<br>
<br>大家如果阅读过一些开源框架的源码，可能会发现其中数不尽的抽象类，设计模式拈手而来，在功能框架中，可以使用设计模式随心所欲的解耦；在实际的复杂业务中，当然也可以应用合适的设计模式。<br>
<br>这篇文章，我会结合较为常见的实际业务场景，探讨如何使用合适的设计模式将业务解耦：<br>
<ul><li>此处的应用绝不是生搬硬套，是我经过深思熟虑，并将较为复杂的业务进行全面重构后，得出的一套行之有效的思路历程</li><li>任何一个设计模式都是一个伟大的经验及其思想总结，千人千面，如果对文章中内容，有不同的意见，希望你能在评论中提出，我们共同探讨，共同进步</li></ul><br>
<br><em>本文章是一篇弱代码类型文章，我会画大量的图片向大家展示，引用设计模式后，会对原有的业务流程，产生什么样的影响。</em><br>
<h3>前置知识</h3>这里，需要了解下基础知识，什么是责任链模式和策略模式。<br>
<br>责任链模式，在很多开源框架中都是有所应用，你如果听到啥啥拦截器，基本就是责任链模式，责任链模式的思想很简单，但是有很多种实现方式：<br>
<ul><li>最简单的链表实现就和OkHttp的拦截器实现大相径庭</li><li>OkHttp的拦截器实现和Dio拦截器实现结构相同，但遍历方式不一样</li><li>很多骚操作：我喜欢OkHttp的实现方式，喜欢dio的Api设计，结尾会给出一个结合这俩者思想的通用拦截器</li></ul><br>
<br>策略模式，或是天生适合业务，同一模块不同类型业务，如果行为相同，或许就可以考虑使用策略模式去解耦了<br>
<h4>责任链模式</h4>这边用Dart写一个简单的拦截器，Dart和Java非常像：<br>
<ul><li>为了减少语言差异，我就不使用箭头语法了</li><li>下划线表示私有</li></ul><br>
<br><strong>用啥语言不重要，这边只是用代码简单演示下思想</strong>。<br>
<br>此处实现就用链表了；如果，使用数组的形式，需要多写很多逻辑，数组的优化写法在结尾给出，此处暂且不表。<br>
<br><strong>结构</strong><br>
<br>责任链的结构，通常有两种结构：<br>
<ul><li>链表结构：链表构建责任链，十分便捷的就能和下一节点建立联系</li><li>数组结构：数组，用通用的List即可，方便增删，不固定长度（别费劲的用固定长度Array了，例如：int[]、String[]）</li></ul><br>
<br><div class="aw-upload-img-list active">
<a href="http://dockone.io/uploads/article/20210829/51314757b8a39781e1f374fe666605ee.png" target="_blank" data-fancybox-group="thumb" rel="lightbox"><img src="https://cors.zfour.workers.dev/?http://dockone.io/uploads/article/20210829/51314757b8a39781e1f374fe666605ee.png" class="img-polaroid" title="1.png" alt="1.png" referrerpolicy="no-referrer"></a>
</div>
<br>
<em>责任链结构</em><br>
<br>实现一个链表实体很简单：<br>
<pre class="prettyprint">abstract class InterceptChain<T> &#123;<br>
InterceptChain? next;<br>
<br>
void intercept(T data) &#123;<br>
next?.intercept(data);<br>
&#125;<br>
&#125; <br>
</pre><br>
<strong>实现</strong><br>
<br>拦截器实现：<br>
<pre class="prettyprint">/// 该拦截器以最简单的链表实现<br>
abstract class InterceptChain<T> &#123;<br>
InterceptChain? next;<br>
<br>
void intercept(T data) &#123;<br>
next?.intercept(data);<br>
&#125;<br>
&#125;<br>
<br>
class InterceptChainHandler<T> &#123;<br>
InterceptChain? _interceptFirst;<br>
<br>
void add(InterceptChain interceptChain) &#123;<br>
if (_interceptFirst == null) &#123;<br>
  _interceptFirst = interceptChain;<br>
  return;<br>
&#125;<br>
<br>
var node = _interceptFirst!;<br>
while (true) &#123;<br>
  if (node.next == null) &#123;<br>
    node.next = interceptChain;<br>
    break;<br>
  &#125;<br>
  node = node.next!;<br>
&#125;<br>
&#125;<br>
<br>
void intercept(T data) &#123;<br>
_interceptFirst?.intercept(data);<br>
&#125;<br>
&#125; <br>
</pre><br>
使用：<br>
<ul><li>调整add顺序，就调整了对应逻辑的节点，在整个责任链中的顺序</li><li>去掉intercept重写方法中的super.intercept(data)，就能实现拦截后续节点逻辑</li></ul><br>
<br><pre class="prettyprint">void main() &#123;<br>
var intercepts = InterceptChainHandler<String>();<br>
intercepts.add(OneIntercept());<br>
intercepts.add(TwoIntercept());<br>
intercepts.intercept("测试拦截器");<br>
&#125;<br>
<br>
class OneIntercept extends InterceptChain<String> &#123;<br>
@override<br>
void intercept(String data) &#123;<br>
data = "$data：OneIntercept";<br>
print(data);<br>
super.intercept(data);<br>
&#125;<br>
&#125;<br>
<br>
class TwoIntercept extends InterceptChain<String> &#123;<br>
@override<br>
void intercept(String data) &#123;<br>
data = "$data：TwoIntercept";<br>
print(data);<br>
super.intercept(data);<br>
&#125;<br>
&#125; <br>
</pre><br>
打印结果：<br>
<pre class="prettyprint">测试拦截器：OneIntercept<br>
测试拦截器：OneIntercept：TwoIntercept<br>
</pre><br>
<h4>策略模式</h4><strong>结构</strong><br>
<br>策略模式最重要的：应该就是对抽象类的设计，对行为的抽象。<br>
<div class="aw-upload-img-list active">
<a href="http://dockone.io/uploads/article/20210829/870facb99167a19c489df701021e7514.png" target="_blank" data-fancybox-group="thumb" rel="lightbox"><img src="https://cors.zfour.workers.dev/?http://dockone.io/uploads/article/20210829/870facb99167a19c489df701021e7514.png" class="img-polaroid" title="2.png" alt="2.png" referrerpolicy="no-referrer"></a>
</div>
<br>
<em>策略模式应用</em><br>
<br><strong>实现</strong><br>
<br>定义抽象类，抽象行为：<br>
<pre class="prettyprint">/// 结合适配器模式的接口适配：抽象必须实现行为，和可选实现行为<br>
abstract class BusinessAction &#123;<br>
///创建相应资源：该行为必须实现<br>
void create();<br>
<br>
///可选实现<br>
void dealIO() &#123;&#125;<br>
<br>
///可选实现<br>
void dealNet() &#123;&#125;<br>
<br>
///可选实现<br>
void dealSystem() &#123;&#125;<br>
<br>
///释放资源：该行为必须实现<br>
void dispose();<br>
&#125; <br>
</pre><br>
实现策略类：<br>
<pre class="prettyprint">//Net策略<br>
class NetStrategy extends BusinessAction &#123;<br>
@override<br>
void create() &#123;<br>
print("创建Net资源");<br>
&#125;<br>
<br>
@override<br>
void dealNet() &#123;<br>
print("处理Net逻辑");<br>
&#125;<br>
<br>
@override<br>
void dispose() &#123;<br>
print("释放Net资源");<br>
&#125;<br>
&#125;<br>
<br>
///IO策略<br>
class IOStrategy extends BusinessAction &#123;<br>
@override<br>
void create() &#123;<br>
print("创建IO资源");<br>
&#125;<br>
<br>
@override<br>
void dealIO() &#123;<br>
print("处理IO逻辑");<br>
&#125;<br>
<br>
@override<br>
void dispose() &#123;<br>
print("释放IO资源");<br>
&#125;<br>
&#125; <br>
</pre><br>
使用：<br>
<pre class="prettyprint">void main() &#123;<br>
var type = 1;<br>
BusinessAction strategy;<br>
<br>
//不同业务使用不同策略<br>
if (type == 0) &#123;<br>
strategy = NetStrategy();<br>
&#125; else &#123;<br>
strategy = IOStrategy();<br>
&#125;<br>
<br>
//开始创建资源<br>
strategy.create();<br>
//......... 省略N多逻辑（其中某些场景，会有用到Net业务，和上面type是关联的）<br>
//IO业务：开始处理业务<br>
strategy.dealIO();<br>
//......... 省略N多逻辑<br>
//释放资源<br>
strategy.dispose();<br>
&#125; <br>
</pre><br>
结果：<br>
<pre class="prettyprint">创建IO资源<br>
处理IO逻辑<br>
释放IO资源<br>
</pre><br>
<h3>适合的业务场景</h3>这边举一些适合上述设计模式的业务场景，这些场景是真实存在的！<br>
<br>这些真实的业务，使用设计模式解耦和纯靠if else怼，完全是俩种体验！<br>
<br><strong>代码如诗，这并不是一句玩笑话。</strong><br>
<h4>连环弹窗业务</h4><strong>业务描述</strong><br>
<br>连环弹窗夺命call来袭……<br>
<ul><li><br>A弹窗弹出：有确定和取消按钮<br>
<ul><li><br>确定按钮：B弹窗弹出（有查看详情和取消按钮）<br>
<ul><li><br>查看详情按钮：C弹窗弹出（有同意和拒绝按钮）<br>
<ul><li><br>同意按钮：D弹窗弹出（有查看和下一步按钮）<br>
<ul><li><br>查看按钮：E弹窗弹出（只有下一步按钮）<br>
<ul><li>下一步按钮：F弹窗弹出（结束）</li></ul></li><li><br>下一步按钮：F弹窗弹出（结束）</li></ul></li><li><br>拒绝按钮：流程结束</li></ul></li><li><br>取消按钮：流程结束</li></ul></li><li><br>取消按钮：流程结束</li></ul></li></ul><br>
<br>好家伙，套娃真是无所不在，真不是我们代码套娃，实在是业务套娃，手动滑稽.png<br>
<div class="aw-upload-img-list active">
<a href="http://dockone.io/uploads/article/20210829/30adf277327927eef1e911af84135ebf.jpeg" target="_blank" data-fancybox-group="thumb" rel="lightbox"><img src="https://cors.zfour.workers.dev/?http://dockone.io/uploads/article/20210829/30adf277327927eef1e911af84135ebf.jpeg" class="img-polaroid" title="3.jpeg" alt="3.jpeg" referrerpolicy="no-referrer"></a>
</div>
<br>
图示弹窗业务：<br>
<div class="aw-upload-img-list active">
<a href="http://dockone.io/uploads/article/20210829/41eb6696fd92506bef7bddfb4b6ac58b.png" target="_blank" data-fancybox-group="thumb" rel="lightbox"><img src="https://cors.zfour.workers.dev/?http://dockone.io/uploads/article/20210829/41eb6696fd92506bef7bddfb4b6ac58b.png" class="img-polaroid" title="4.png" alt="4.png" referrerpolicy="no-referrer"></a>
</div>
<br>
<em>连环弹窗业务1</em><br>
<br><strong>直接开搞</strong><br>
<br>看到这个业务，大家会去怎么做呢？<br>
<ul><li><br>有人可能会想，这么简单的业务还需要想吗？直接写啊！<br>
<ul><li>A：在确定回调里面，跳转B弹窗</li><li>B：查看详情按钮跳转C弹窗</li><li>……</li></ul></li><li><br>好一通套后，终于写完了</li></ul><br>
<br><blockquote><br>产品来了，加需求！<br>
  B和C弹窗之间要加个预览G弹窗，点击B的查看详情按钮，跳转预览G弹窗；预览G弹窗只有一个确定按钮，点击后跳转C弹窗。</blockquote><div class="aw-upload-img-list active">
<a href="http://dockone.io/uploads/article/20210829/38ee5379c5c780c8ecf5c6ea7ca7f24c.jpg" target="_blank" data-fancybox-group="thumb" rel="lightbox"><img src="https://cors.zfour.workers.dev/?http://dockone.io/uploads/article/20210829/38ee5379c5c780c8ecf5c6ea7ca7f24c.jpg" class="img-polaroid" title="5.jpg" alt="5.jpg" referrerpolicy="no-referrer"></a>
</div>
<br>
<ul><li><br>你心里可能要想了，这特么不是坑爹？<br>
<ul><li>业务本来就超吉尔套，我B弹窗里面写的跳转代码要改，传参要改，而且还要加弹窗！</li></ul></li><li><br>先要去找产品撕比，撕完后：<br>
<ul><li>然后继续在屎山上，小心翼翼的再拉了坨shit</li><li>这座克苏鲁山初成规模</li></ul></li></ul><br>
<br><div class="aw-upload-img-list active">
<a href="http://dockone.io/uploads/article/20210829/35d4a895be96a4e8c1406370ae090672.png" target="_blank" data-fancybox-group="thumb" rel="lightbox"><img src="https://cors.zfour.workers.dev/?http://dockone.io/uploads/article/20210829/35d4a895be96a4e8c1406370ae090672.png" class="img-polaroid" title="6.png" alt="6.png" referrerpolicy="no-referrer"></a>
</div>
<br>
<em>连环弹窗业务2</em><br>
<br><blockquote><br>产品又来了，第一稿需求不合理，需要调整需求！<br>
  交换C和D弹窗位置，逻辑调整：D弹窗点击下一步的时候，需要加一个校验请求，通过后跳转到C弹窗，点击查看按钮跳转弹窗F。</blockquote><div class="aw-upload-img-list active">
<a href="http://dockone.io/uploads/article/20210829/413706cfc44e259b5871d8fbf8c29a7b.jpg" target="_blank" data-fancybox-group="thumb" rel="lightbox"><img src="https://cors.zfour.workers.dev/?http://dockone.io/uploads/article/20210829/413706cfc44e259b5871d8fbf8c29a7b.jpg" class="img-polaroid" title="7.jpg" alt="7.jpg" referrerpolicy="no-referrer"></a>
</div>
<br>
<ul><li><br>你眉头一皱，发现事情没有表面这么简单<br>
<ul><li>由于初期图简单，几乎都写在一个文件里，眼花缭乱弹窗回调太多，而且弹窗样式也不一样</li><li>现在改整个流程，导致你整个人脑子嗡嗡响</li></ul></li><li><br>心中怒气翻涌，找到产品说：<br>
<div class="aw-upload-img-list active">
<a href="http://dockone.io/uploads/article/20210829/a8db8d35379b20e8bd7597368465ac0c.jpg" target="_blank" data-fancybox-group="thumb" rel="lightbox"><img src="https://cors.zfour.workers.dev/?http://dockone.io/uploads/article/20210829/a8db8d35379b20e8bd7597368465ac0c.jpg" class="img-polaroid" title="8.jpg" alt="8.jpg" referrerpolicy="no-referrer"></a>
</div>
</li><li><br>回来，坐在椅子上，心里想：<br>
<ul><li>老夫写的代码天衣无缝，这什么几把需求</li><li>可恶，这次测试，起码要给我多提十几个BUG<br>
<div class="aw-upload-img-list active">
<a href="http://dockone.io/uploads/article/20210829/542021a2ee4f5deece8f554a2511d5cc.png" target="_blank" data-fancybox-group="thumb" rel="lightbox"><img src="https://cors.zfour.workers.dev/?http://dockone.io/uploads/article/20210829/542021a2ee4f5deece8f554a2511d5cc.png" class="img-polaroid" title="9.png" alt="9.png" referrerpolicy="no-referrer"></a>
</div>
</li></ul></li><li>克苏鲁山开始狰狞</li></ul><br>
<br><div class="aw-upload-img-list active">
<a href="http://dockone.io/uploads/article/20210829/7616d7f88456b50fda5f8edd60d6d6d5.png" target="_blank" data-fancybox-group="thumb" rel="lightbox"><img src="https://cors.zfour.workers.dev/?http://dockone.io/uploads/article/20210829/7616d7f88456b50fda5f8edd60d6d6d5.png" class="img-polaroid" title="10.png" alt="10.png" referrerpolicy="no-referrer"></a>
</div>
<br>
<em>连环弹窗业务3</em><br>
<br><blockquote><br>产品飘来，加改需求：如此，如此……这般，这般……<br>
  <ul><li>你....<br>
  <div class="aw-upload-img-list active">
<a href="http://dockone.io/uploads/article/20210829/33e3685641b66894d03167cb55948ad7.jpg" target="_blank" data-fancybox-group="thumb" rel="lightbox"><img src="https://cors.zfour.workers.dev/?http://dockone.io/uploads/article/20210829/33e3685641b66894d03167cb55948ad7.jpg" class="img-polaroid" title="11.jpg" alt="11.jpg" referrerpolicy="no-referrer"></a>
</div>
</li></ul><br>
  <br>
  <br>产品：改下……然后，扔给你几十页的PRD</blockquote>你看了看这改了几十版的克苏鲁山，这几十个弹窗逻辑居然都写在一个文件里，快一万行的代码……<br>
<ul><li><br>心里不禁想：<br>
<ul><li>本帅比写的代码果然牛批，或许这就是艺术！艺术总是曲高和寡，难被人理解！而我的代码更牛批，连我自己都看不懂了！</li><li>这代码行数！这代码结构！不得拍个照留念下，传给以后的孩子当传家宝供着！</li></ul></li><li><br>心里不禁嘚瑟：<br>
<ul><li>这块业务，除了我，还有谁敢动，成为头儿的心腹，指日可待！<br>
<div class="aw-upload-img-list active">
<a href="http://dockone.io/uploads/article/20210829/c467c1a6d8327171c50192b4add3884c.jpg" target="_blank" data-fancybox-group="thumb" rel="lightbox"><img src="https://cors.zfour.workers.dev/?http://dockone.io/uploads/article/20210829/c467c1a6d8327171c50192b4add3884c.jpg" class="img-polaroid" title="12.jpg" alt="12.jpg" referrerpolicy="no-referrer"></a>
</div>
</li></ul></li><li><br>但，转念深思后：事了拂衣去，深藏功与名<br>
<div class="aw-upload-img-list active">
<a href="http://dockone.io/uploads/article/20210829/3b2c3021de642a97104d2f9a9d6baf7c.jpg" target="_blank" data-fancybox-group="thumb" rel="lightbox"><img src="https://cors.zfour.workers.dev/?http://dockone.io/uploads/article/20210829/3b2c3021de642a97104d2f9a9d6baf7c.jpg" class="img-polaroid" title="13.jpg" alt="13.jpg" referrerpolicy="no-referrer"></a>
</div>
</li></ul><br>
<br><strong>重构</strong><br>
<br><blockquote><br>随着业务的逐渐复杂，最初的设计缺点会逐渐暴露；重构有缺陷的代码流程，变得势在必行，这会极大的降低维护成本。</blockquote>如果心中对责任链模式有一些概念的话，会发现上面的业务，极其适合责任链模式！<br>
<br>对上面的业务进行分析，可以明确一些事：<br>
<ul><li>这个业务是一个链式的，有着明确的方向性：单向，从头到尾指向</li><li>业务拆分开，可以将一个弹窗作为单颗粒度，一个弹窗作为节点</li><li>上级的业务节点可以对下级节点拦截（点击取消，拒绝按钮，不再进行后续业务）</li></ul><br>
<br>重构上面的代码，只要明确思想和流程就行了。<br>
<br>第一稿业务：<br>
<ul><li><br>业务流程<br>
<div class="aw-upload-img-list active">
<a href="http://dockone.io/uploads/article/20210829/4e8bbe2d00b984912c384637a9b00935.png" target="_blank" data-fancybox-group="thumb" rel="lightbox"><img src="https://cors.zfour.workers.dev/?http://dockone.io/uploads/article/20210829/4e8bbe2d00b984912c384637a9b00935.png" class="img-polaroid" title="14.png" alt="14.png" referrerpolicy="no-referrer"></a>
</div>
<br>
<em>连环弹窗业务1</em></li><li><br>责任链<br>
<div class="aw-upload-img-list active">
<a href="http://dockone.io/uploads/article/20210829/e9f55641c1eaa138bfd2c0048de409bc.png" target="_blank" data-fancybox-group="thumb" rel="lightbox"><img src="https://cors.zfour.workers.dev/?http://dockone.io/uploads/article/20210829/e9f55641c1eaa138bfd2c0048de409bc.png" class="img-polaroid" title="15.png" alt="15.png" referrerpolicy="no-referrer"></a>
</div>
<br>
<em>责任链业务1</em></li></ul><br>
<br>代码：简写<br>
<pre class="prettyprint">void main() &#123;<br>
var intercepts = InterceptChainHandler<String>();<br>
intercepts.add(AIntercept());<br>
intercepts.add(BIntercept());<br>
intercepts.add(CIntercept());<br>
intercepts.add(DIntercept());<br>
intercepts.add(EIntercept());<br>
intercepts.add(FIntercept());<br>
intercepts.intercept("测试拦截器");<br>
&#125; <br>
</pre><br>
第二稿业务：<br>
<ul><li><br>业务流程<br>
<div class="aw-upload-img-list active">
<a href="http://dockone.io/uploads/article/20210829/d3191812caf660ff16b5f2d968b51be9.png" target="_blank" data-fancybox-group="thumb" rel="lightbox"><img src="https://cors.zfour.workers.dev/?http://dockone.io/uploads/article/20210829/d3191812caf660ff16b5f2d968b51be9.png" class="img-polaroid" title="16.png" alt="16.png" referrerpolicy="no-referrer"></a>
</div>
<br>
<em>连环弹窗业务2</em></li><li><br>责任链<br>
<div class="aw-upload-img-list active">
<a href="http://dockone.io/uploads/article/20210829/3acb1b59a6509b966c3b4cff4bb478a6.png" target="_blank" data-fancybox-group="thumb" rel="lightbox"><img src="https://cors.zfour.workers.dev/?http://dockone.io/uploads/article/20210829/3acb1b59a6509b966c3b4cff4bb478a6.png" class="img-polaroid" title="17.png" alt="17.png" referrerpolicy="no-referrer"></a>
</div>
<br>
<em>责任链业务2</em></li></ul><br>
<br>代码：简写<br>
<pre class="prettyprint">void main() &#123;<br>
var intercepts = InterceptChainHandler<String>();<br>
intercepts.add(AIntercept());<br>
intercepts.add(BIntercept());<br>
intercepts.add(GIntercept());<br>
intercepts.add(CIntercept());<br>
intercepts.add(DIntercept());<br>
intercepts.add(EIntercept());<br>
intercepts.add(FIntercept());<br>
intercepts.intercept("测试拦截器");<br>
&#125; <br>
</pre><br>
第三稿业务：<br>
<ul><li><br>业务流程<br>
<div class="aw-upload-img-list active">
<a href="http://dockone.io/uploads/article/20210829/20e26cf5259da2d57448134e82d2cb40.png" target="_blank" data-fancybox-group="thumb" rel="lightbox"><img src="https://cors.zfour.workers.dev/?http://dockone.io/uploads/article/20210829/20e26cf5259da2d57448134e82d2cb40.png" class="img-polaroid" title="18.png" alt="18.png" referrerpolicy="no-referrer"></a>
</div>
<br>
<em>连环弹窗业务3</em></li><li><br>责任链<br>
<div class="aw-upload-img-list active">
<a href="http://dockone.io/uploads/article/20210829/3ed7efef86a82aaa5efce6ae4c5181b9.png" target="_blank" data-fancybox-group="thumb" rel="lightbox"><img src="https://cors.zfour.workers.dev/?http://dockone.io/uploads/article/20210829/3ed7efef86a82aaa5efce6ae4c5181b9.png" class="img-polaroid" title="19.png" alt="19.png" referrerpolicy="no-referrer"></a>
</div>
<br>
<em>责任链业务3</em></li></ul><br>
<br>代码：简写<br>
<pre class="prettyprint">void main() &#123;<br>
var intercepts = InterceptChainHandler<String>();<br>
intercepts.add(AIntercept());<br>
intercepts.add(BIntercept());<br>
intercepts.add(GIntercept());<br>
intercepts.add(DIntercept());<br>
intercepts.add(CIntercept());<br>
intercepts.add(EIntercept());<br>
intercepts.add(FIntercept());<br>
intercepts.intercept("测试拦截器");<br>
&#125; <br>
</pre><br>
总结：经过责任链模式重构后，业务节点被明确的区分开，整个流程从代码上看，都相当的清楚，维护将变的异常轻松；或许，此时能感受到一些，编程的乐趣了。<br>
<div class="aw-upload-img-list active">
<a href="http://dockone.io/uploads/article/20210829/f560af73f3547ad80aed36d8408c63c8.jpg" target="_blank" data-fancybox-group="thumb" rel="lightbox"><img src="https://cors.zfour.workers.dev/?http://dockone.io/uploads/article/20210829/f560af73f3547ad80aed36d8408c63c8.jpg" class="img-polaroid" title="20.jpg" alt="20.jpg" referrerpolicy="no-referrer"></a>
</div>
<br>
<h4>花样弹窗业务</h4><strong>业务描述</strong><br>
<br>来描述一个新的业务：这个业务场景真实存在某办公软件<br>
<ul><li>进入APP首页后，和后台建立一个长连接</li><li>后台某些工单处理后，会通知APP处理，此时APP会弹出处理工单的弹窗（APP顶部）</li><li>弹窗类型很多：工单处理弹窗，流程审批弹窗，邀请类型弹窗，查看工单详情弹窗，提交信息弹窗……</li><li>弹窗弹出类型，是根据后台给的Type进行判断：从而弹出不同类型弹窗、点击其按钮，跳转不同业务，传递不同参数。</li></ul><br>
<br><div class="aw-upload-img-list active">
<a href="http://dockone.io/uploads/article/20210829/525ff5db97476cb70da29ca4e23c4cf7.png" target="_blank" data-fancybox-group="thumb" rel="lightbox"><img src="https://cors.zfour.workers.dev/?http://dockone.io/uploads/article/20210829/525ff5db97476cb70da29ca4e23c4cf7.png" class="img-polaroid" title="21.png" alt="21.png" referrerpolicy="no-referrer"></a>
</div>
<br>
<strong>分析</strong><br>
<br><blockquote><br>确定设计</blockquote>这个业务，是一种渐变性的引导你搭建克苏鲁代码山。<br>
<ul><li>在前期开发的时候，一般只有俩三种类型弹窗，前期十分好做；根本不用考虑如何设计，抬手一行代码，反手一行代码，就能搞定</li><li>但是后来整个业务会渐渐的鬼畜，不同类型会慢慢加到几十种之多！</li></ul><br>
<br>首先这个业务，使用责任链模式，肯定是不合适的，因为弹窗之间的耦合性很低，并没有什么明确的上下游关系。<br>
<br>但是，这个业务使用策略模式非常的合适！<br>
<ul><li>type明确：不同类型弹出不同弹窗，按钮执行不同逻辑</li><li>抽象行为明确：一个按钮就是一种行为，不同行为的实现逻辑大相径庭</li></ul><br>
<br><blockquote><br>抽象行为</blockquote>多样弹窗的行为抽象，对应其按钮就行了：确定、取消、同意、拒绝、查看详情、我知道了、提交。<br>
<br>直接画图来表示吧：<br>
<div class="aw-upload-img-list active">
<a href="http://dockone.io/uploads/article/20210829/734057b5aeeacbcf5f34a4d01b807ec0.png" target="_blank" data-fancybox-group="thumb" rel="lightbox"><img src="https://cors.zfour.workers.dev/?http://dockone.io/uploads/article/20210829/734057b5aeeacbcf5f34a4d01b807ec0.png" class="img-polaroid" title="22.png" alt="22.png" referrerpolicy="no-referrer"></a>
</div>
<br>
<em>花样弹窗业务-抽象行为</em><br>
<br><strong>实现</strong><br>
<br>来看下简要的代码实现，代码不重要，重要的是思想，这边简要的看下代码实现流程。<br>
<br>抽象基类：<br>
<pre class="prettyprint">/// 默认实现抛异常,可提醒未实现方法被误用<br>
abstract class DialogAction &#123;<br>
///确定<br>
void onConfirm() &#123;<br>
throw 'DialogAction：not implement onConfirm()';<br>
&#125;<br>
<br>
///取消<br>
void onCancel() &#123;<br>
throw 'DialogAction：not implement onCancel()';<br>
&#125;<br>
<br>
///同意<br>
void onAgree() &#123;<br>
throw 'DialogAction：not implement onAgree()';<br>
&#125;<br>
<br>
///拒绝<br>
void onRefuse() &#123;<br>
throw 'DialogAction：not implement onRefuse()';<br>
&#125;<br>
<br>
///查看详情<br>
void onDetail() &#123;<br>
throw 'DialogAction：not implement onDetail()';<br>
&#125;<br>
<br>
///我知道了<br>
void onKnow() &#123;<br>
throw 'DialogAction：not implement onKnow()';<br>
&#125;<br>
<br>
///提交<br>
void onSubmit() &#123;<br>
throw 'DialogAction：not implement onSubmit()';<br>
&#125;<br>
&#125; <br>
</pre><br>
实现逻辑类：<br>
<pre class="prettyprint">class OneStrategy extends DialogAction &#123;<br>
@override<br>
void onConfirm() &#123;<br>
print("确定");<br>
&#125;<br>
<br>
@override<br>
void onCancel() &#123;<br>
print("取消");<br>
&#125;<br>
&#125;<br>
<br>
class TwoStrategy extends DialogAction&#123;<br>
@override<br>
void onAgree() &#123;<br>
print("同意");<br>
&#125;<br>
<br>
@override<br>
void onRefuse() &#123;<br>
print("拒绝");<br>
&#125;<br>
&#125;<br>
<br>
//........省略其他实现<br>
</pre><br>
使用：<br>
<pre class="prettyprint">void main() &#123;<br>
//根据接口获取<br>
var type = 1;<br>
DialogAction strategy;<br>
switch (type) &#123;<br>
case 0:<br>
  strategy = DefaultStrategy();<br>
  break;<br>
case 1:<br>
  strategy = OneStrategy();<br>
  break;<br>
case 2:<br>
  strategy = TwoStrategy();<br>
  break;<br>
case 3:<br>
  strategy = ThreeStrategy();<br>
  break;<br>
case 4:<br>
  strategy = FourStrategy();<br>
  break;<br>
case 5:<br>
  strategy = FiveStrategy();<br>
  break;<br>
default:<br>
  strategy = DefaultStrategy();<br>
  break;<br>
&#125;<br>
<br>
//聚合弹窗按钮触发事件（不同弹窗的确定按钮，皆可聚合为一个onConfirm事件，其它同理）<br>
BusinessDialog(<br>
//通过传入的type，显示对应类型的弹窗<br>
type: type,<br>
//确定按钮<br>
onConfirm: () &#123;<br>
  strategy.onConfirm();<br>
&#125;,<br>
//取消按钮<br>
onCancel: () &#123;<br>
  strategy.onCancel();<br>
&#125;,<br>
//同意按钮<br>
onAgree: () &#123;<br>
  strategy.onAgree();<br>
&#125;,<br>
//拒绝按钮<br>
onRefuse: () &#123;<br>
  strategy.onRefuse();<br>
&#125;,<br>
//查看详情按钮<br>
onDetail: () &#123;<br>
  strategy.onDetail();<br>
&#125;,<br>
//我知道了按钮<br>
onKnow: () &#123;<br>
  strategy.onKnow();<br>
&#125;,<br>
//提交按钮<br>
onSubmit: () &#123;<br>
  strategy.onSubmit();<br>
&#125;,<br>
);<br>
&#125; <br>
</pre><br>
图示：<br>
<div class="aw-upload-img-list active">
<a href="http://dockone.io/uploads/article/20210829/c55f23956542c49def3e21df6a34e97d.png" target="_blank" data-fancybox-group="thumb" rel="lightbox"><img src="https://cors.zfour.workers.dev/?http://dockone.io/uploads/article/20210829/c55f23956542c49def3e21df6a34e97d.png" class="img-polaroid" title="23.png" alt="23.png" referrerpolicy="no-referrer"></a>
</div>
<br>
<em>花样弹窗业务-业务流程</em><br>
<h3>一个复杂业务场景的演变</h3>我们看下，一个简单的提交业务流，怎么逐渐变的狰狞。<br>
<br>我会逐渐给出一个合适的解决方案，如果大家有更好的想法，务必在评论区告诉鄙人。<br>
<br>业务描述：我们的车子因不可抗原因坏了，要去维修厂修车，工作人员开始登记这个损坏车辆。<br>
<h4>业务的演变</h4><strong>第一稿：初始业务</strong><br>
<br>登记一个维修车辆的流程，实际上还是满麻烦的。<br>
<ul><li>登记一个新车，需要将车辆详细信息登记清楚：车牌、车架、车型号、车辆类型、进出场时间、油量、里程</li><li>还需要登记一下用户信息：姓名、手机号、是否隶属公司</li><li>登记车损程度：车顶、车底、方向盘、玻璃、离合器、刹车</li><li>车内物品：车座皮套、工具</li><li>以及其他我没想到的</li><li>最后：提交所有登记好的信息</li></ul><br>
<br>第一稿，业务流程十分清晰，细节复杂，但是做起来不难。<br>
<div class="aw-upload-img-list active">
<a href="http://dockone.io/uploads/article/20210829/1c7e5e88a26f8f46175ca599052ca45f.png" target="_blank" data-fancybox-group="thumb" rel="lightbox"><img src="https://cors.zfour.workers.dev/?http://dockone.io/uploads/article/20210829/1c7e5e88a26f8f46175ca599052ca45f.png" class="img-polaroid" title="24.png" alt="24.png" referrerpolicy="no-referrer"></a>
</div>
<br>
<em>车辆登记第一稿</em><br>
<br><strong>第二稿（实际是多稿聚合）</strong><br>
<br>增加下述几个流程：<br>
<ul><li>外部登记：外部登记了一个维修车辆部分信息（后台，微信小程序，H5等等），需要在APP上完善信息，提交接口不同（必带车牌号）</li><li>快捷洗车：洗车业务极其常见，快捷生成对应信息，提交接口不同</li><li>预约订单登记：预约好了车辆一部分一些信息，可快捷登记，提交接口不同（必带车牌号）</li></ul><br>
<br>因为登记维修车辆流程，登记车辆信息流程极其细致繁琐，我们决定复用登记新车模块：<br>
<ul><li>因为此处逻辑大多涉及开头和结尾，中间登记车辆信息操作几乎未改动，复用想法是可行的</li><li>如果增加车辆登记项，新的三个流程也必须提交这些信息；所以，复用势在必行</li></ul><br>
<br>因为这一稿需求，业务也变得愈加复杂。<br>
<div class="aw-upload-img-list active">
<a href="http://dockone.io/uploads/article/20210829/8b0752894bcaee0c22e166b17219d5e3.jpg" target="_blank" data-fancybox-group="thumb" rel="lightbox"><img src="https://cors.zfour.workers.dev/?http://dockone.io/uploads/article/20210829/8b0752894bcaee0c22e166b17219d5e3.jpg" class="img-polaroid" title="25.jpg" alt="25.jpg" referrerpolicy="no-referrer"></a>
</div>
<br>
<em>车辆登记第二稿</em><br>
<br><strong>第三稿</strong><br>
<br>现在要针对不同的车辆类型，做不同的处理；车类型分：个人车，集团车。<br>
<br>不同类型的登记，在提交的时候，需要校验不同的信息；校验不通过，需要提示用户，并且不能进行提交流程。<br>
<br>提交后，需要处理下通用业务，然后跳转到某个页面。<br>
<br>第三稿的描述不多，但是，大大的增加了复杂度：<br>
<ul><li>尤其是不同类型校验过程还不同，还能中断后续提交流程</li><li>提交流程后，还需要跳转通用页面</li></ul><br>
<br><div class="aw-upload-img-list active">
<a href="http://dockone.io/uploads/article/20210829/39b3e60eff537242c61e9614fa7012eb.png" target="_blank" data-fancybox-group="thumb" rel="lightbox"><img src="https://cors.zfour.workers.dev/?http://dockone.io/uploads/article/20210829/39b3e60eff537242c61e9614fa7012eb.png" class="img-polaroid" title="26.png" alt="26.png" referrerpolicy="no-referrer"></a>
</div>
<br>
<em>车辆登记第三稿</em><br>
<h4>开发探讨</h4><strong>第一稿</strong><br>
<br>业务流程：<br>
<div class="aw-upload-img-list active">
<a href="http://dockone.io/uploads/article/20210829/20a32decbab91394e78f796d01b6d8d6.png" target="_blank" data-fancybox-group="thumb" rel="lightbox"><img src="https://cors.zfour.workers.dev/?http://dockone.io/uploads/article/20210829/20a32decbab91394e78f796d01b6d8d6.png" class="img-polaroid" title="27.png" alt="27.png" referrerpolicy="no-referrer"></a>
</div>
<br>
<em>车辆登记第一稿</em><br>
<br>开发：正常流程开发<br>
<br><strong>第二稿</strong><br>
<br>业务流程：<br>
<div class="aw-upload-img-list active">
<a href="http://dockone.io/uploads/article/20210829/6591d594ab429f76c3f2429caaef2adb.jpg" target="_blank" data-fancybox-group="thumb" rel="lightbox"><img src="https://cors.zfour.workers.dev/?http://dockone.io/uploads/article/20210829/6591d594ab429f76c3f2429caaef2adb.jpg" class="img-polaroid" title="28.jpg" alt="28.jpg" referrerpolicy="no-referrer"></a>
</div>
<br>
<em>车辆登记第二稿</em><br>
<br>思考：<br>
<br>对于第二稿业务，可以好好考虑下，怎么去设计？<br>
<br>开头和结尾需要单独写判断，去处理不同流程的业务，这至少要写俩个大的判断模块，接受数据的入口模块可能还要写判断，这样就非常适合策略模式去做了。开头根据执行的流程，选择相应的策略对象，后续将逻辑块替换抽象的策略方法就OK了，大致流程如下：<br>
<div class="aw-upload-img-list active">
<a href="http://dockone.io/uploads/article/20210829/f2ee8bbb3a72123e5fa3cf0c1e7a220d.png" target="_blank" data-fancybox-group="thumb" rel="lightbox"><img src="https://cors.zfour.workers.dev/?http://dockone.io/uploads/article/20210829/f2ee8bbb3a72123e5fa3cf0c1e7a220d.png" class="img-polaroid" title="29.png" alt="29.png" referrerpolicy="no-referrer"></a>
</div>
<br>
<em>车辆登记第二稿（策略模式）</em><br>
<br><strong>第三稿</strong><br>
<br>业务流程：<br>
<div class="aw-upload-img-list active">
<a href="http://dockone.io/uploads/article/20210829/3557320a6a5b4b6a7912536f5288bf12.png" target="_blank" data-fancybox-group="thumb" rel="lightbox"><img src="https://cors.zfour.workers.dev/?http://dockone.io/uploads/article/20210829/3557320a6a5b4b6a7912536f5288bf12.png" class="img-polaroid" title="30.png" alt="30.png" referrerpolicy="no-referrer"></a>
</div>
<br>
<em>车辆登记第三稿</em><br>
<br> 探讨：<br>
<ul><li><br>第三稿的需求，实际上，已经比较复杂了<br>
<ul><li>整个流程中掺杂着不同业务流程处理，不同流程逻辑又拥有阻断下游机制（绿色模块）</li><li>下游逻辑又会合流（结尾）的多种变换</li></ul></li><li><br>在这一稿的需求<br>
<ul><li>使用策略模式肯定是可以的</li><li>阻断那块（绿色模块）需要单独处理下：<code class="prettyprint">抽象方法应该拥有返回值，外层根据返回值，判断是否进行后续流程</code></li><li>但！这！也太不优雅了！</li></ul></li><li><br>思考上面业务一些特性<br>
<ul><li>拦截下游机制</li><li>上游到下游、方向明确</li><li>随时可能插入新的业务流程</li></ul></li></ul><br>
<br>可以用责任链模式！但，需要做一些小改动！这地方，我们可以将频繁变动的模块用责任链模式全都隔离出来。<br>
<br>看下，使用责任链模式改造后流程图：<br>
<div class="aw-upload-img-list active">
<a href="http://dockone.io/uploads/article/20210829/7ad09112238b17b2dd2ca1088586b560.png" target="_blank" data-fancybox-group="thumb" rel="lightbox"><img src="https://cors.zfour.workers.dev/?http://dockone.io/uploads/article/20210829/7ad09112238b17b2dd2ca1088586b560.png" class="img-polaroid" title="31.png" alt="31.png" referrerpolicy="no-referrer"></a>
</div>
<br>
<em>车辆登记第三稿（责任链模式）</em><br>
<br>浏览上述流程图可发现，本来是极度杂乱糅合的业务，可以被设计相对更加平行的结构。<br>
<ul><li><br>对于上述流程，可以进一步分析，并进一步简化：对整体业务分析，我们需要去关注其变或不变的部分<br>
<ul><li>不变：整体业务变动很小的是，登记信息流程（主体逻辑这块），此处的相关变动是很小的，对所有流程也是共用的部分</li><li>变：可以发现，开头和结尾是变动更加频繁的部分，我们可以对此处逻辑进行整体的抽象</li></ul></li><li>抽象多变的开头和结尾</li></ul><br>
<br><div class="aw-upload-img-list active">
<a href="http://dockone.io/uploads/article/20210829/0bd7920fc61edfcc6b3a91fe93f122dc.png" target="_blank" data-fancybox-group="thumb" rel="lightbox"><img src="https://cors.zfour.workers.dev/?http://dockone.io/uploads/article/20210829/0bd7920fc61edfcc6b3a91fe93f122dc.png" class="img-polaroid" title="32.png" alt="32.png" referrerpolicy="no-referrer"></a>
</div>
<br>
<em>车辆登记第三稿（责任链模式——简化）</em><br>
<br>所以我们抽象拦截类，可以做一些调整。<br>
<pre class="prettyprint">abstract class InterceptChainTwice<T> &#123;<br>
InterceptChainTwice? next;<br>
<br>
void onInit(T data) &#123;<br>
next?.onInit(data);<br>
&#125;<br>
<br>
void onSubmit(T data) &#123;<br>
next?.onSubmit(data);<br>
&#125;<br>
&#125; <br>
</pre><br>
<br><blockquote><br>来看下简要的代码实现，代码不重要，主要看看实现流程和思想。</blockquote>抽象拦截器：<br>
<pre class="prettyprint">abstract class InterceptChainTwice<T> &#123;<br>
InterceptChainTwice? next;<br>
<br>
void onInit(T data) &#123;<br>
next?.onInit(data);<br>
&#125;<br>
<br>
void onSubmit(T data) &#123;<br>
next?.onSubmit(data);<br>
&#125;<br>
&#125;<br>
<br>
class InterceptChainTwiceHandler<T> &#123;<br>
InterceptChainTwice? _interceptFirst;<br>
<br>
void add(InterceptChainTwice interceptChain) &#123;<br>
if (_interceptFirst == null) &#123;<br>
  _interceptFirst = interceptChain;<br>
  return;<br>
&#125;<br>
<br>
var node = _interceptFirst!;<br>
while (true) &#123;<br>
  if (node.next == null) &#123;<br>
    node.next = interceptChain;<br>
    break;<br>
  &#125;<br>
  node = node.next!;<br>
&#125;<br>
&#125;<br>
<br>
void onInit(T data) &#123;<br>
_interceptFirst?.onInit(data);<br>
&#125;<br>
<br>
void onSubmit(T data) &#123;<br>
_interceptFirst?.onSubmit(data);<br>
&#125;<br>
&#125; <br>
</pre><br>
实现拦截器：<br>
<pre class="prettyprint">/// 开头通用拦截器<br>
class CommonIntercept extends InterceptChainTwice<String> &#123;<br>
@override<br>
void onInit(String data) &#123;<br>
//如果有车牌，请求接口，获取数据<br>
//.................<br>
//填充页面<br>
super.onInit(data);<br>
&#125;<br>
&#125;<br>
<br>
/// 登记新车拦截器<br>
class RegisterNewIntercept extends InterceptChainTwice<String> &#123;<br>
@override<br>
void onInit(String data) &#123;<br>
//处理开头针对登记新车的单独逻辑<br>
super.onInit(data);<br>
&#125;<br>
<br>
@override<br>
void onSubmit(String data) &#123;<br>
var isPass = false;<br>
//如果校验不过，拦截下游逻辑<br>
if (!isPass) &#123;<br>
  return;<br>
&#125;<br>
// ......<br>
super.onSubmit(data);<br>
&#125;<br>
&#125;<br>
<br>
/// 省略其他实现<br>
</pre><br>
使用：<br>
<pre class="prettyprint">void main() &#123;<br>
var type = 0;<br>
var intercepts = InterceptChainTwiceHandler();<br>
<br>
intercepts.add(CommonIntercept());<br>
intercepts.add(CarTypeDealIntercept());<br>
if (type == 0) &#123;<br>
//登记新车<br>
intercepts.add(RegisterNewCarIntercept());<br>
&#125; else if (type == 1) &#123;<br>
//外部登记<br>
intercepts.add(OutRegisterIntercept());<br>
&#125; else if (type == 2) &#123;<br>
//快捷洗车<br>
intercepts.add(FastWashIntercept());<br>
&#125; else &#123;<br>
//预约订单登记<br>
intercepts.add(OrderRegisterIntercept());<br>
&#125;<br>
intercepts.add(TailIntercept());<br>
<br>
//业务开始<br>
intercepts.onInit("传入数据源");<br>
<br>
//开始处理N多逻辑<br>
//............................................................<br>
//经历了N多逻辑<br>
<br>
//提交按钮触发事件<br>
SubmitBtn(<br>
//提交按钮<br>
onSubmit: () &#123;<br>
  intercepts.onSubmit("传入提交数据");<br>
&#125;,<br>
);<br>
&#125; <br>
</pre><br>
<h4>总结</h4>关于代码部分，关键的代码，我都写出来，用心看看，肯定能明白我写的意思。<br>
<br>也不用找我要完整代码了，这些业务demo代码写完后，就删了。<br>
<br>本栏目这个业务，实际上是非常常见的的一个业务，一个提交流程与很多其它的流程耦合，整个业务就会慢慢的变的鬼畜，充满各种判断，很容易让人陷入泥泞，或许，此时可以对已有业务进行思考，如何进行合理的优化。<br>
<br>该业务的演变历程，和开发改造是本人的一次思路历程，如大家有更好的思路，还请不吝赐教。<br>
<h3>通用拦截器</h3>我结合OkHttp的思想和Dio的API，封装了俩个通用拦截器，这边贴下代码，如果哪里有什么不足，请及时告知本人。<br>
<br>说明下：这是Dart版本的。<br>
<h4>抽象单方法</h4><pre class="prettyprint">///一层通用拦截器，T的类型必须一致<br>
abstract class InterceptSingle<T> &#123;<br>
void intercept(T data, SingleHandler handler) => handler.next(data);<br>
&#125;<br>
<br>
///添加拦截器，触发拦截器方法入口<br>
class InterceptSingleHandler<T> &#123;<br>
_InterceptSingleHandler _handler = _InterceptSingleHandler(<br>
index: 0,<br>
intercepts: [],<br>
);<br>
<br>
void add(InterceptSingle intercept) &#123;<br>
//一种类型的拦截器只能添加一次<br>
for (var item in _handler.intercepts) &#123;<br>
  if (item.runtimeType == intercept.runtimeType) &#123;<br>
    return;<br>
  &#125;<br>
&#125;<br>
<br>
_handler.intercepts.add(intercept);<br>
&#125;<br>
<br>
void delete(InterceptSingle intercept) &#123;<br>
_handler.intercepts.remove(intercept);<br>
&#125;<br>
<br>
void intercept(T data) &#123;<br>
_handler.next(data);<br>
&#125;<br>
&#125;<br>
<br>
///------------实现不同处理器，参照dio api设计和OkHttp实现思想---------------<br>
abstract class SingleHandler &#123;<br>
next(dynamic data);<br>
&#125;<br>
<br>
///实现init处理器<br>
class _InterceptSingleHandler extends SingleHandler &#123;<br>
List<InterceptSingle> intercepts;<br>
<br>
int index;<br>
<br>
_InterceptSingleHandler(&#123;<br>
required this.index,<br>
required this.intercepts,<br>
&#125;);<br>
<br>
@override<br>
next(dynamic data) &#123;<br>
if (index >= intercepts.length) &#123;<br>
  return;<br>
&#125;<br>
<br>
var intercept = intercepts[index];<br>
var handler =<br>
    _InterceptSingleHandler(index: index + 1, intercepts: intercepts);<br>
<br>
intercept.intercept(data, handler);<br>
&#125;<br>
&#125; <br>
</pre><br>
<h4>抽象双方法</h4><pre class="prettyprint">///俩层通用拦截器，T的类型必须一致<br>
abstract class InterceptTwice<T> &#123;<br>
void onInit(T data, TwiceHandler handler) => handler.next(data);<br>
<br>
void onSubmit(T data, TwiceHandler handler) => handler.next(data);<br>
&#125;<br>
<br>
///添加拦截器，触发拦截器方法入口<br>
class InterceptTwiceHandler<T> &#123;<br>
_TwiceInitHandler _init = _TwiceInitHandler(index: 0, intercepts: []);<br>
_TwiceSubmitHandler _submit = _TwiceSubmitHandler(index: 0, intercepts: []);<br>
<br>
void add(InterceptTwice intercept) &#123;<br>
//一种类型的拦截器只能添加一次<br>
for (var item in _init.intercepts) &#123;<br>
  if (item.runtimeType == intercept.runtimeType) &#123;<br>
    return;<br>
  &#125;<br>
&#125;<br>
<br>
_init.intercepts.add(intercept);<br>
_submit.intercepts.add(intercept);<br>
&#125;<br>
<br>
void delete(InterceptTwice intercept) &#123;<br>
_init.intercepts.remove(intercept);<br>
_submit.intercepts.remove(intercept);<br>
&#125;<br>
<br>
void onInit(T data) &#123;<br>
_init.next(data);<br>
&#125;<br>
<br>
void onSubmit(T data) &#123;<br>
_submit.next(data);<br>
&#125;<br>
&#125;<br>
<br>
///------------实现不同处理器，参照dio api设计和OkHttp实现思想---------------<br>
abstract class TwiceHandler &#123;<br>
next(dynamic data);<br>
&#125;<br>
<br>
///实现init处理器<br>
class _TwiceInitHandler extends TwiceHandler &#123;<br>
List<InterceptTwice> intercepts;<br>
<br>
int index;<br>
<br>
_TwiceInitHandler(&#123;<br>
required this.index,<br>
required this.intercepts,<br>
&#125;);<br>
<br>
@override<br>
next(dynamic data) &#123;<br>
if (index >= intercepts.length) &#123;<br>
  return;<br>
&#125;<br>
<br>
var intercept = intercepts[index];<br>
var handler = _TwiceInitHandler(index: index + 1, intercepts: intercepts);<br>
<br>
intercept.onInit(data, handler);<br>
&#125;<br>
&#125;<br>
<br>
///实现submit处理器<br>
class _TwiceSubmitHandler extends TwiceHandler &#123;<br>
List<InterceptTwice> intercepts;<br>
<br>
int index;<br>
<br>
_TwiceSubmitHandler(&#123;<br>
required this.index,<br>
required this.intercepts,<br>
&#125;);<br>
<br>
@override<br>
next(dynamic data) &#123;<br>
if (index >= intercepts.length) &#123;<br>
  return;<br>
&#125;<br>
<br>
var intercept = intercepts[index];<br>
var handler = _TwiceSubmitHandler(index: index + 1, intercepts: intercepts);<br>
<br>
intercept.onSubmit(data, handler);<br>
&#125;<br>
&#125; <br>
</pre><br>
<h3>最后</h3>第一次，写这种结合业务的文章，如有收获，还请点个赞。<br>
<br>原文链接：<a href="https://juejin.cn/post/6999875193082478600" rel="nofollow" target="_blank">https://juejin.cn/post/6999875193082478600</a>，作者：小呆呆666
                                                                <div class="aw-upload-img-list">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </div>
                                
                                                                <ul class="aw-upload-file-list">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </ul>
                                                              
</div>
            