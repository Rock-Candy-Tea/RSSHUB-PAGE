
---
title: '什么是Runtime_平时项目有用到过吗_'
categories: 
 - 编程
 - 掘金
 - 热门
headimg: 'https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/fbe8ddd8810548059c84b17973ff24d3~tplv-k3u1fbpfcp-zoom-1.image'
author: 掘金
comments: false
date: Tue, 06 Apr 2021 18:23:26 GMT
thumbnail: 'https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/fbe8ddd8810548059c84b17973ff24d3~tplv-k3u1fbpfcp-zoom-1.image'
---

<div>   
<div class="markdown-body"><style>.markdown-body&#123;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333&#125;.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6&#123;line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px&#125;.markdown-body h1&#123;font-size:30px;margin-bottom:5px&#125;.markdown-body h2&#123;padding-bottom:12px;font-size:24px;border-bottom:1px solid #ececec&#125;.markdown-body h3&#123;font-size:18px;padding-bottom:0&#125;.markdown-body h4&#123;font-size:16px&#125;.markdown-body h5&#123;font-size:15px&#125;.markdown-body h6&#123;margin-top:5px&#125;.markdown-body p&#123;line-height:inherit;margin-top:22px;margin-bottom:22px&#125;.markdown-body img&#123;max-width:100%&#125;.markdown-body hr&#123;border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px&#125;.markdown-body code&#123;word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em&#125;.markdown-body code,.markdown-body pre&#123;font-family:Menlo,Monaco,Consolas,Courier New,monospace&#125;.markdown-body pre&#123;overflow:auto;position:relative;line-height:1.75&#125;.markdown-body pre>code&#123;font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8&#125;.markdown-body a&#123;text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff&#125;.markdown-body a:active,.markdown-body a:hover&#123;color:#275b8c&#125;.markdown-body table&#123;display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6&#125;.markdown-body thead&#123;background:#f6f6f6;color:#000;text-align:left&#125;.markdown-body tr:nth-child(2n)&#123;background-color:#fcfcfc&#125;.markdown-body td,.markdown-body th&#123;padding:12px 7px;line-height:24px&#125;.markdown-body td&#123;min-width:120px&#125;.markdown-body blockquote&#123;color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8&#125;.markdown-body blockquote:after&#123;display:block;content:""&#125;.markdown-body blockquote>p&#123;margin:10px 0&#125;.markdown-body ol,.markdown-body ul&#123;padding-left:28px&#125;.markdown-body ol li,.markdown-body ul li&#123;margin-bottom:0;list-style:inherit&#125;.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item&#123;list-style:none&#125;.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul&#123;margin-top:0&#125;.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul&#123;margin-top:3px&#125;.markdown-body ol li&#123;padding-left:6px&#125;.markdown-body .contains-task-list&#123;padding-left:0&#125;.markdown-body .task-list-item&#123;list-style:none&#125;@media (max-width:720px)&#123;.markdown-body h1&#123;font-size:24px&#125;.markdown-body h2&#123;font-size:20px&#125;.markdown-body h3&#123;font-size:18px&#125;&#125;</style><p>我们在面试中经常会被问到这些问题,到底怎么回答比较合适?</p>
<p>这样我们先去看一下我们平时项目中用到的Runtime,等下我们再来概括上面的问题的答案.我们肯定是用Runtime提供的API去做一些事情.</p>
<p>我们肯定是多多少少有接触Runtime,如果面试官问你,你肯定回答用过,不然说明你对Runtime一点都不了解.这样对你的印象就大打折扣了.</p>
<p>现在我就列一些我们可能用到的API(<strong>注意只是部分,不是所有</strong>).</p>
<h2 data-id="heading-0">Runtime类相关的API</h2>
<p><img alt class="lazyload" src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/fbe8ddd8810548059c84b17973ff24d3~tplv-k3u1fbpfcp-zoom-1.image" data-width="800" data-height="600" referrerpolicy="no-referrer"><img alt title="点击并拖拽以移动" src="https://juejin.cn/post/undefined" referrerpolicy="no-referrer">​</p>
<h2 data-id="heading-1">Runtime成员变量相关的API</h2>
<p><img alt class="lazyload" src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b6b48bb171cd40a99161dd92fbb56ab4~tplv-k3u1fbpfcp-zoom-1.image" data-width="800" data-height="600" referrerpolicy="no-referrer"><img alt title="点击并拖拽以移动" src="https://juejin.cn/post/undefined" referrerpolicy="no-referrer">​</p>
<h2 data-id="heading-2">Runtime属性相关的API</h2>
<p><img alt class="lazyload" src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/40b093f48f324755ae959be2be05e649~tplv-k3u1fbpfcp-zoom-1.image" data-width="800" data-height="600" referrerpolicy="no-referrer"><img alt title="点击并拖拽以移动" src="https://juejin.cn/post/undefined" referrerpolicy="no-referrer">​</p>
<h2 data-id="heading-3">Runtime方法相关的API</h2>
<p><img alt class="lazyload" src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b578528ac14b4abbb6d5525445dae60f~tplv-k3u1fbpfcp-zoom-1.image" data-width="800" data-height="600" referrerpolicy="no-referrer"><img alt title="点击并拖拽以移动" src="https://juejin.cn/post/undefined" referrerpolicy="no-referrer">​</p>
<p><img alt class="lazyload" src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/dd55648e7d9a43e0b52c462035d7d529~tplv-k3u1fbpfcp-zoom-1.image" data-width="800" data-height="600" referrerpolicy="no-referrer"><img alt title="点击并拖拽以移动" src="https://juejin.cn/post/undefined" referrerpolicy="no-referrer">​</p>
<p>上面就是我们可能会遇到的一些的API,而且有些我们是用过的,比如获取对象的内存大小、替换方法、关联对象、添加方法等等.接下来我们就去看部分案例用法:(只列举部分用法,因为比较多)其他要用的时候,我们可以自己查阅.</p>
<p>先看相关的应用:</p>
<p>1.object_getClass:获取isa指向的class对象</p>
<p><img alt class="lazyload" src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0f5a676f512a4611903bf2bddfaaeca8~tplv-k3u1fbpfcp-zoom-1.image" data-width="800" data-height="600" referrerpolicy="no-referrer"><img alt title="点击并拖拽以移动" src="https://juejin.cn/post/undefined" referrerpolicy="no-referrer">​</p>
<p>2.object_setClass:设置isa指向的class</p>
<p><img alt class="lazyload" src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/02111d77ac7c46719f26e9c436a9c52f~tplv-k3u1fbpfcp-zoom-1.image" data-width="800" data-height="600" referrerpolicy="no-referrer"><img alt title="点击并拖拽以移动" src="https://juejin.cn/post/undefined" referrerpolicy="no-referrer">​</p>
<p>3.object_isClass:判断一个OC对象是否为Class</p>
<p><img alt class="lazyload" src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/449b9f41d73f47638d485ebddb5c6169~tplv-k3u1fbpfcp-zoom-1.image" data-width="800" data-height="600" referrerpolicy="no-referrer"><img alt title="点击并拖拽以移动" src="https://juejin.cn/post/undefined" referrerpolicy="no-referrer">​</p>
<p>4.objc_allocateClassPair:动态创建一个类(参数:父类,类名,额外的内存空间)</p>
<p><img alt class="lazyload" src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/af9c9ee0917849eeabb1a4f9c1b2c273~tplv-k3u1fbpfcp-zoom-1.image" data-width="800" data-height="600" referrerpolicy="no-referrer"><img alt title="点击并拖拽以移动" src="https://juejin.cn/post/undefined" referrerpolicy="no-referrer">​</p>
<p>在不用这个类的时候释放它: objc_disposeClassPair(NewClass).</p>
<p><img alt class="lazyload" src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9f83a986f14144a6b04fc856b2be9437~tplv-k3u1fbpfcp-zoom-1.image" data-width="800" data-height="600" referrerpolicy="no-referrer"><img alt title="点击并拖拽以移动" src="https://juejin.cn/post/undefined" referrerpolicy="no-referrer">​</p>
<p>当然这个也可以给现有的类增加属性.大家可以自己尝试</p>
<p>5.class_copyIvarList:获取类的属性,这个在开发中遇到的较多,很多框架的数据解析等等都是用了这个,(注意:runtime中copy或者create等创建出来的都需要free).</p>
<p><img alt class="lazyload" src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4b4764ebbb414921aa897a816511f88f~tplv-k3u1fbpfcp-zoom-1.image" data-width="800" data-height="600" referrerpolicy="no-referrer"><img alt title="点击并拖拽以移动" src="https://juejin.cn/post/undefined" referrerpolicy="no-referrer">​</p>
<h2 data-id="heading-4">项目实战应用实例</h2>
<p>1.修改UITextField提示的颜色</p>
<p>首先我们看下我们用自带的是如何实现的</p>
<p><img alt class="lazyload" src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/976335f064d949f581b2834b00e1e450~tplv-k3u1fbpfcp-zoom-1.image" data-width="800" data-height="600" referrerpolicy="no-referrer"><img alt title="点击并拖拽以移动" src="https://juejin.cn/post/undefined" referrerpolicy="no-referrer">​</p>
<p>我们可以用NSMutableAttributedString去修改UITextField的提示颜色.,因为要写的代码比较多,如果我们不用这个,那我们可以考虑用runtime去实现?首先我们想红色的内容极有可能是UILabel,我们就窥探UITextField里面有哪些属性,请看下图:</p>
<p><img alt class="lazyload" src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/fcbfe252a9e647eba449a1aa6d0212c2~tplv-k3u1fbpfcp-zoom-1.image" data-width="800" data-height="600" referrerpolicy="no-referrer"><img alt title="点击并拖拽以移动" src="https://juejin.cn/post/undefined" referrerpolicy="no-referrer">​</p>
<p>然后用kvc去赋值就行了,这样就很简单了(注意赋值之前要先设置一个placehold,因为这个label是懒加载创建的).通过这种思路我们就可以去遍历系统的某些成员变量了,可以做更多便捷的事.</p>
<p>2.说一下开发中的字典转模型的应用</p>
<p>传统的我就不演示了,直接演示runtime的操作,我们NSObject创建一个分类,这样模型都能直接调用,请看下图代码:先看下结果,这样的话,有n多个要解析,都是可以做到(注意我这边只是写了一点点代码,具体用还有很多注意事项,这里只是一个思路).</p>
<p><img alt class="lazyload" src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/769c47edb8e44dfdb2c81682fbac73f8~tplv-k3u1fbpfcp-zoom-1.image" data-width="800" data-height="600" referrerpolicy="no-referrer"><img alt title="点击并拖拽以移动" src="https://juejin.cn/post/undefined" referrerpolicy="no-referrer">​</p>
<p><img alt class="lazyload" src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f695587056cd42fe8475c50ed889ed63~tplv-k3u1fbpfcp-zoom-1.image" data-width="800" data-height="600" referrerpolicy="no-referrer"><img alt title="点击并拖拽以移动" src="https://juejin.cn/post/undefined" referrerpolicy="no-referrer">​</p>
<p>就这样简短的代码就能解决问题,再来一个类照样可以调用这样的方法.有些字典转模型的框架就是里面用了这些操作,当然成熟的框架肯定考虑了很多情况,比如出现继承,出现nil等等的处理,我们只是写了一个简短的代码演示.</p>
<p>最后再介绍一下方法相关的.</p>
<p>1.class_replaceMethod:方法替换</p>
<p><img alt class="lazyload" src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3bd1cded09834a068a04c293c59d9251~tplv-k3u1fbpfcp-zoom-1.image" data-width="800" data-height="600" referrerpolicy="no-referrer"><img alt title="点击并拖拽以移动" src="https://juejin.cn/post/undefined" referrerpolicy="no-referrer">​</p>
<p>2.imp_implementationWithBlock:也可用block作为方法实现</p>
<p><img alt class="lazyload" src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/174e25fe38394edfa962ee945d054624~tplv-k3u1fbpfcp-zoom-1.image" data-width="800" data-height="600" referrerpolicy="no-referrer"><img alt title="点击并拖拽以移动" src="https://juejin.cn/post/undefined" referrerpolicy="no-referrer">​</p>
<p>3.重点:方法交换</p>
<p>其实方法交换的用处非常大,比如我看到一些视频公开课,说什么,永久解决数组越界的问题!这里面也是用到runtime的方法交互,再比如我想统计所有按钮的点击次数,如果不用runtime去实现,就比较麻烦,而用runtime就非常的简单,最多的用处我们还是去替换系统的方法!</p>
<p>下面就举一个拦截所有按钮点击事件的例子</p>
<p>我们知道UIButton是继承UIControl,所以我们创建一个分类.</p>
<p><img alt class="lazyload" src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/fb1da070a1e946dba73d86f964bc959c~tplv-k3u1fbpfcp-zoom-1.image" data-width="800" data-height="600" referrerpolicy="no-referrer"><img alt title="点击并拖拽以移动" src="https://juejin.cn/post/undefined" referrerpolicy="no-referrer">​</p>
<p>首先创建一个UIControl的分类,置换代码如下:</p>
<p><img alt class="lazyload" src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e4d719fe7e4c42469a10368c0b5f48f7~tplv-k3u1fbpfcp-zoom-1.image" data-width="800" data-height="600" referrerpolicy="no-referrer"><img alt title="点击并拖拽以移动" src="https://juejin.cn/post/undefined" referrerpolicy="no-referrer">​</p>
<p>从上面的代码我们可以看出我们确实是做到了这个需求,但是你发现没,以前的方法就没有执行了,点击事情的结果是没有了,所以我们肯定不想破坏之前的系统的结构,所以我们要调用一下系统的,注意这时候方法已经置换,如果调用请注意.</p>
<p>请看下面的代码:</p>
<p><img alt class="lazyload" src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e94f140d90ce43588f32e98581ec0db8~tplv-k3u1fbpfcp-zoom-1.image" data-width="800" data-height="600" referrerpolicy="no-referrer"><img alt title="点击并拖拽以移动" src="https://juejin.cn/post/undefined" referrerpolicy="no-referrer">​</p>
<p>这就在不破坏系统的结构下,达到了我们想要的完美效果.它实际上是交换IMP的地址值.这里load我们可以里面加一个GCD函数的dispatch_once函数,因为我们不能保证load函数只执行一次,我们只需要置换一次,再置换就换回来了,用dispatch_once保证只执行一次.</p>
<p>我们看一下源码(源码地址之前的博客都有提到,现在我用的是818版本)</p>
<p><img alt class="lazyload" src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/315f3de85c414cb4a5e1b27b48f1ad55~tplv-k3u1fbpfcp-zoom-1.image" data-width="800" data-height="600" referrerpolicy="no-referrer"><img alt title="点击并拖拽以移动" src="https://juejin.cn/post/undefined" referrerpolicy="no-referrer">​</p>
<p>源码查看</p>
<p>我们从源码也能看出来,是直接交换imp地址.是rw_t里面的method集合里面的方法的imp直接置换的.flushCaches是清除缓存,可以点进去看具体实现.这个把系统的方法替换掉,也就是我们常说的hook,钩子函数!</p>
<p>基本要说的就这么多,还有很多其他的用法,我们可以自己尝试.</p>
<h1 data-id="heading-5">总结</h1>
<h2 data-id="heading-6">1.什么是Runtime?</h2>
<p>OC是一门动态性比较强的编程语言,允许很多操作推迟到程序运行时再进行,</p>
<p>OC的动态性就是由Runtime来支撑和实现的,Runtime是一套C语言的API,封装了很多动态性相关的函数</p>
<p>平时编写的OC代码,底层都是转换了Runtime API进行调用</p>
<h2 data-id="heading-7">2平时项目有用到过吗?</h2>
<p>利用关联对象(AssociatedObject)给分类添加属性;</p>
<p>遍历类的所有成员变量(修改textfield的占位文字颜色、字典转模型、自动归档解档);</p>
<p>交换方法实现(交互系统的方法);</p>
<p>利用消息转发机制解决方法找不到的异常的问题;</p>
<p>等等等,所有一切你用到的都可以写上去.</p>
<p>...</p>
<h2 data-id="heading-8">接下来我会继续介绍Runloop.</h2>
<h1 data-id="heading-9">如果觉得我写得对您有所帮助，请关注我，我会持续更新😄</h1></div> <div class="image-viewer-box" data-v-78c9b824><!----></div>  
</div>
            