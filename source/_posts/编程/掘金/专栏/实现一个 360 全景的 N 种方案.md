
---
title: '实现一个 360 全景的 N 种方案'
categories: 
 - 编程
 - 掘金
 - 专栏
headimg: 'https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/91454c1c84fe4feeaba1fc185a9476f5~tplv-k3u1fbpfcp-zoom-1.image'
author: 掘金
comments: false
date: Thu, 01 Apr 2021 22:48:19 GMT
thumbnail: 'https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/91454c1c84fe4feeaba1fc185a9476f5~tplv-k3u1fbpfcp-zoom-1.image'
---

<div>   
<div class="markdown-body"><style>.markdown-body&#123;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333&#125;.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6&#123;line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px&#125;.markdown-body h1&#123;font-size:30px;margin-bottom:5px&#125;.markdown-body h2&#123;padding-bottom:12px;font-size:24px;border-bottom:1px solid #ececec&#125;.markdown-body h3&#123;font-size:18px;padding-bottom:0&#125;.markdown-body h4&#123;font-size:16px&#125;.markdown-body h5&#123;font-size:15px&#125;.markdown-body h6&#123;margin-top:5px&#125;.markdown-body p&#123;line-height:inherit;margin-top:22px;margin-bottom:22px&#125;.markdown-body img&#123;max-width:100%&#125;.markdown-body hr&#123;border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px&#125;.markdown-body code&#123;word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em&#125;.markdown-body code,.markdown-body pre&#123;font-family:Menlo,Monaco,Consolas,Courier New,monospace&#125;.markdown-body pre&#123;overflow:auto;position:relative;line-height:1.75&#125;.markdown-body pre>code&#123;font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8&#125;.markdown-body a&#123;text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff&#125;.markdown-body a:active,.markdown-body a:hover&#123;color:#275b8c&#125;.markdown-body table&#123;display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6&#125;.markdown-body thead&#123;background:#f6f6f6;color:#000;text-align:left&#125;.markdown-body tr:nth-child(2n)&#123;background-color:#fcfcfc&#125;.markdown-body td,.markdown-body th&#123;padding:12px 7px;line-height:24px&#125;.markdown-body td&#123;min-width:120px&#125;.markdown-body blockquote&#123;color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8&#125;.markdown-body blockquote:after&#123;display:block;content:""&#125;.markdown-body blockquote>p&#123;margin:10px 0&#125;.markdown-body ol,.markdown-body ul&#123;padding-left:28px&#125;.markdown-body ol li,.markdown-body ul li&#123;margin-bottom:0;list-style:inherit&#125;.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item&#123;list-style:none&#125;.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul&#123;margin-top:0&#125;.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul&#123;margin-top:3px&#125;.markdown-body ol li&#123;padding-left:6px&#125;.markdown-body .contains-task-list&#123;padding-left:0&#125;.markdown-body .task-list-item&#123;list-style:none&#125;@media (max-width:720px)&#123;.markdown-body h1&#123;font-size:24px&#125;.markdown-body h2&#123;font-size:20px&#125;.markdown-body h3&#123;font-size:18px&#125;&#125;</style><blockquote>
<p>本文来自飞猪前端同学@甜虾，教你用 N 种方式用 JS 实现一个 360 全景效果。</p>
</blockquote>
<h2 data-id="heading-0">概述</h2>
<p>360 全景浏览是一种性价比很高的虚拟现实解决方案，给人一种全新的浏览体验，让你足不出户就能身临其境地感受到现场的环境。该技术被广泛地应用在房产、酒店、家居等领域。在互联网订房已经普及的时代，在网站上用全景展示酒店宾馆的各种餐饮和住宿设施，是吸引顾客的好办法。利用网络，远程虚拟浏览宾馆的外型、大厅、客房、会议厅等各项服务场所，展现宾馆舒适的环境，给客户以实在感受，促进客户预定客房。在酒店大堂提供客房的全景展示，再也不用麻烦客户在各个房间会场穿梭，就能观看各房间的真实场景，更方便客户确认和挑选客房，进而提高效率，用户体验更胜一筹。</p>
<p>下面我们使用三种方法讨论一个 360 全景的实现。</p>
<h2 data-id="heading-1">一、CSS3</h2>
<p>利用 CSS 中的变换、旋转等属性就可以实现一个 360 全景。实现的基本思路如下：</p>
<ul>
<li>利用 CSS3 做出一个 3D 立方体。</li>
<li>在立方体的 6 个面设置目标图片（利用全景工具导出的图片，一共有 6 张）。</li>
<li>使用 perspective、translateZ、transform-style: preserve-3d 等属性改变视图的大小。</li>
<li>添加触摸事件改变 translateX、translateY 的角度数即可实现一个基本的全景图效果。</li>
</ul>
<p>下面我们尝试使用 div 做出一个 3D 立方体：</p>
<ol>
<li>
<p>写出 6 个面：</p>
<pre><code class="hljs language-html copyable" lang="html"><span class="hljs-tag"><<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"scene"</span>></span>
  <span class="hljs-tag"><<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"cube"</span>></span>
    <span class="hljs-tag"><<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"cube__face cube__face--front"</span>></span>front<span class="hljs-tag"></<span class="hljs-name">div</span>></span>
    <span class="hljs-tag"><<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"cube__face cube__face--back"</span>></span>back<span class="hljs-tag"></<span class="hljs-name">div</span>></span>
    <span class="hljs-tag"><<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"cube__face cube__face--right"</span>></span>right<span class="hljs-tag"></<span class="hljs-name">div</span>></span>
    <span class="hljs-tag"><<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"cube__face cube__face--left"</span>></span>left<span class="hljs-tag"></<span class="hljs-name">div</span>></span>
    <span class="hljs-tag"><<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"cube__face cube__face--top"</span>></span>top<span class="hljs-tag"></<span class="hljs-name">div</span>></span>
    <span class="hljs-tag"><<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"cube__face cube__face--bottom"</span>></span>bottom<span class="hljs-tag"></<span class="hljs-name">div</span>></span>
  <span class="hljs-tag"></<span class="hljs-name">div</span>></span>
<span class="hljs-tag"></<span class="hljs-name">div</span>></span>
<span class="copy-code-btn">复制代码</span></code></pre>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/91454c1c84fe4feeaba1fc185a9476f5~tplv-k3u1fbpfcp-zoom-1.image" alt="image.png" loading="lazy" referrerpolicy="no-referrer"></p>
<p>perspective 指定观察者与 z=0 平面的距离，使具有三维位置变换的元素产生透视效果（近大远小原理）。transform-style 指定其为子元素提供 2D 还是 3D 的场景。
如下图，高度为 600px 的元素，距离 z=0 的屏幕 300px，视角与屏幕距离 1000px，根据相似三角形的原理，可以计算出该元素在屏幕上的投影高度为 857px，即实际我们看到的元素高度。</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a013f30cc1fd456498dd0d0d41e2a8d4~tplv-k3u1fbpfcp-zoom-1.image" alt="image.png" loading="lazy" referrerpolicy="no-referrer"></p>
<p>关于这个属性的详细讲解可查看<a href="https://www.cnblogs.com/yanggeng/p/11285856.html" target="_blank" rel="nofollow noopener noreferrer">css3 系列之详解 perspective</a>。</p>
</li>
<li>
<p>写出基本定位</p>
<pre><code class="hljs language-css copyable" lang="css"><span class="hljs-selector-class">.scene</span> &#123;
  <span class="hljs-attribute">width</span>: <span class="hljs-number">200px</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">200px</span>;
  <span class="hljs-attribute">perspective</span>: <span class="hljs-number">600px</span>;
&#125;

<span class="hljs-selector-class">.cube</span> &#123;
  <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">100%</span>;
  <span class="hljs-attribute">position</span>: relative;
  <span class="hljs-attribute">transform-style</span>: preserve-<span class="hljs-number">3</span>d;
&#125;

<span class="hljs-selector-class">.cube__face</span> &#123;
  <span class="hljs-attribute">position</span>: absolute;
  <span class="hljs-attribute">width</span>: <span class="hljs-number">200px</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">200px</span>;
&#125;
<span class="copy-code-btn">复制代码</span></code></pre>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1912dd89a8ed459fa7049d867b0d5976~tplv-k3u1fbpfcp-zoom-1.image" alt="image.png" loading="lazy" referrerpolicy="no-referrer"></p>
</li>
<li>
<p>旋转各面，使“三对”面互相垂直，达到如下效果</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b624060a4a744efea03ef03cc51356ed~tplv-k3u1fbpfcp-zoom-1.image" alt="image.png" loading="lazy" referrerpolicy="no-referrer"></p>
<pre><code class="hljs language-css copyable" lang="css"><span class="hljs-selector-class">.cube__face--front</span> &#123;
  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">rotateY</span>(<span class="hljs-number">0deg</span>);
&#125;
<span class="hljs-selector-class">.cube__face--right</span> &#123;
  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">rotateY</span>(<span class="hljs-number">90deg</span>);
&#125;
<span class="hljs-selector-class">.cube__face--back</span> &#123;
  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">rotateY</span>(<span class="hljs-number">180deg</span>);
&#125;
<span class="hljs-selector-class">.cube__face--left</span> &#123;
  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">rotateY</span>(-<span class="hljs-number">90deg</span>);
&#125;
<span class="hljs-selector-class">.cube__face--top</span> &#123;
  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">rotateX</span>(<span class="hljs-number">90deg</span>);
&#125;
<span class="hljs-selector-class">.cube__face--bottom</span> &#123;
  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">rotateX</span>(-<span class="hljs-number">90deg</span>);
&#125;
<span class="copy-code-btn">复制代码</span></code></pre>
<p>结果如下图</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5184abd27ac34d80b6b48e5f549b688f~tplv-k3u1fbpfcp-zoom-1.image" alt="image.png" loading="lazy" referrerpolicy="no-referrer"></p>
</li>
<li>
<p>貌似看不出怎么变换的？我们将以上重合的两个面的旋转角度稍微调整下，就可以更直观地看出效果：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/64a9bb571b6f40078c46b9cab6cc0236~tplv-k3u1fbpfcp-zoom-1.image" alt="image.png" loading="lazy" referrerpolicy="no-referrer"></p>
</li>
<li>
<p>各面继续向两侧位移</p>
<pre><code class="hljs language-css copyable" lang="css"><span class="hljs-selector-class">.cube__face--front</span> &#123;
  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">rotateY</span>(<span class="hljs-number">0deg</span>) <span class="hljs-built_in">translateZ</span>(<span class="hljs-number">100px</span>);
&#125;
<span class="hljs-selector-class">.cube__face--right</span> &#123;
  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">rotateY</span>(<span class="hljs-number">90deg</span>) <span class="hljs-built_in">translateZ</span>(<span class="hljs-number">100px</span>);
&#125;
<span class="hljs-selector-class">.cube__face--back</span> &#123;
  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">rotateY</span>(<span class="hljs-number">180deg</span>) <span class="hljs-built_in">translateZ</span>(<span class="hljs-number">100px</span>);
&#125;
<span class="hljs-selector-class">.cube__face--left</span> &#123;
  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">rotateY</span>(-<span class="hljs-number">90deg</span>) <span class="hljs-built_in">translateZ</span>(<span class="hljs-number">100px</span>);
&#125;
<span class="hljs-selector-class">.cube__face--top</span> &#123;
  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">rotateX</span>(<span class="hljs-number">90deg</span>) <span class="hljs-built_in">translateZ</span>(<span class="hljs-number">100px</span>);
&#125;
<span class="hljs-selector-class">.cube__face--bottom</span> &#123;
  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">rotateX</span>(-<span class="hljs-number">90deg</span>) <span class="hljs-built_in">translateZ</span>(<span class="hljs-number">100px</span>);
&#125;
<span class="copy-code-btn">复制代码</span></code></pre>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/92bb7c0946d046a39fc8bf3a22fedd69~tplv-k3u1fbpfcp-zoom-1.image" alt="image.png" loading="lazy" referrerpolicy="no-referrer"></p>
<p>整个过程可用下图表示：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6f38794287b249af96e8ee99f5dd9a33~tplv-k3u1fbpfcp-zoom-1.image" alt="1.gif" loading="lazy" referrerpolicy="no-referrer"></p>
<p>最终效果：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/404b79d0218c4144bf17375cff666cfe~tplv-k3u1fbpfcp-zoom-1.image" alt="3.gif" loading="lazy" referrerpolicy="no-referrer"></p>
</li>
<li>
<p>通过调整容器样式的 perspective 属性值，将视角放置在立方体中。将每个面的尺寸放大，添加上全景图切出的 6 面图，添加上鼠标事件，便可实现 360 全景效果。</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6485c0ac311b4b1cb7c6c9148d0c40ee~tplv-k3u1fbpfcp-zoom-1.image" alt="4.gif" loading="lazy" referrerpolicy="no-referrer"></p>
<p>扫码看效果：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/92c2b9eee5e64666bedbb18ea4ab62f3~tplv-k3u1fbpfcp-zoom-1.image" alt="image.png" loading="lazy" referrerpolicy="no-referrer"></p>
</li>
</ol>
<h2 data-id="heading-2">二、Three.js</h2>
<p>Three.js 是一款运行在浏览器中的 webGL 引擎，我们可以用它创建各种三维场景，包括了摄影机、光影、材质等各种对象，利用 Three.js 我们可以轻松地实现各种想要的几何体。
上面的方案中，我们用 CSS3 “拼”出了一个立方体，而 webGL 中立方体等各种几何体是最常见的。我们可以利用 Threejs 中的立方体实现全景图功能，把立方体当成天空盒子，将无缝衔接的图片贴上，看起来就像在一个场景中，相机一般放置在中央，只要离边缘足够远就看不出是立方体，但如果超出边界就能看到他们。
下面是简单的实现过程：</p>
<ol>
<li>
<p>初始化一个立方体几何，给材料上色，便得到了一个立方体：</p>
<pre><code class="hljs language-javascript copyable" lang="javascript"><span class="hljs-keyword">const</span> geometry = <span class="hljs-keyword">new</span> THREE.BoxBufferGeometry(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>);
<span class="hljs-keyword">const</span> material = <span class="hljs-keyword">new</span> THREE.MeshBasicMaterial(&#123; <span class="hljs-attr">color</span>: <span class="hljs-number">0x156289</span> &#125;);
<span class="hljs-keyword">const</span> skyBox = <span class="hljs-keyword">new</span> THREE.Mesh(geometry, material);
<span class="copy-code-btn">复制代码</span></code></pre>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/18999202550a4f0c94825eb4f559e041~tplv-k3u1fbpfcp-zoom-1.image" alt="444.gif" loading="lazy" referrerpolicy="no-referrer"></p>
</li>
<li>
<p>将立方体的纹理颜色换成图片纹理：</p>
<pre><code class="hljs language-javascript copyable" lang="javascript"><span class="hljs-keyword">const</span> texture = <span class="hljs-keyword">new</span> THREE.TextureLoader().load(<span class="hljs-string">'textures/crate.gif'</span>);
<span class="hljs-keyword">const</span> geometry = <span class="hljs-keyword">new</span> THREE.BoxBufferGeometry(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>);
<span class="hljs-keyword">const</span> material = <span class="hljs-keyword">new</span> THREE.MeshBasicMaterial(&#123; <span class="hljs-attr">map</span>: texture &#125;);
<span class="hljs-keyword">const</span> skyBox = <span class="hljs-keyword">new</span> THREE.Mesh(geometry, material);
<span class="copy-code-btn">复制代码</span></code></pre>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/bc68a0a20dac49579c4260a9eae53edf~tplv-k3u1fbpfcp-zoom-1.image" alt="555.gif" loading="lazy" referrerpolicy="no-referrer"></p>
</li>
<li>
<p>将 6 张全景图片替换掉上面相同的纹理：</p>
<p>图片加载的顺序是正 X(px.jpg)，负 X(nx.jpg)，正 Y(py.jpg)，负 Y(ny.jpg)，正 Z(pz.jpg)和负 Z(nz.jpg)，将他们分别赋给 6 个材质的贴图，作为立方体 skyBox 的材质。</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/bf55b26cf8834fc98da100f3b4a02e02~tplv-k3u1fbpfcp-zoom-1.image" alt="image.png" loading="lazy" referrerpolicy="no-referrer"></p>
<pre><code class="hljs language-javascript copyable" lang="javascript"><span class="hljs-keyword">const</span> geometry = <span class="hljs-keyword">new</span> THREE.BoxBufferGeometry(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>);
<span class="hljs-keyword">const</span> textures = [
  <span class="hljs-string">'https://img.alicdn.com/imgextra/i3/O1CN01LsO1Bk20QbKpFTUQr_!!6000000006844-0-tps-1500-1500.jpg'</span>,
  <span class="hljs-string">'https://img.alicdn.com/imgextra/i3/O1CN01uTWCLc1XOCOuA92H0_!!6000000002913-0-tps-1500-1500.jpg'</span>,
  <span class="hljs-string">'https://img.alicdn.com/imgextra/i4/O1CN016lU3YJ1JdrJuFTcWt_!!6000000001052-0-tps-1500-1500.jpg'</span>,
  <span class="hljs-string">'https://img.alicdn.com/imgextra/i2/O1CN01nYe2Mn1ohkmBVyKpp_!!6000000005257-0-tps-1500-1500.jpg'</span>,
  <span class="hljs-string">'https://img.alicdn.com/imgextra/i4/O1CN014TNffn1nlaTfA98Fg_!!6000000005130-0-tps-1500-1500.jpg'</span>,
  <span class="hljs-string">'https://img.alicdn.com/imgextra/i1/O1CN01sS5m781ya6JgLSaVk_!!6000000006594-0-tps-1500-1500.jpg'</span>,
];
<span class="hljs-keyword">const</span> materials = [];
<span class="hljs-keyword">const</span> textureLoader = <span class="hljs-keyword">new</span> THREE.TextureLoader();

<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i < <span class="hljs-number">6</span>; i++) &#123;
  materials.push(
    <span class="hljs-keyword">new</span> THREE.MeshBasicMaterial(&#123; <span class="hljs-attr">map</span>: textureLoader.load(textures[i]) &#125;)
  );
&#125;
<span class="hljs-keyword">const</span> skyBox = <span class="hljs-keyword">new</span> THREE.Mesh(geometry, materials);
<span class="copy-code-btn">复制代码</span></code></pre>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/86fd9f55e720481bb46d61bb16ba6ff1~tplv-k3u1fbpfcp-zoom-1.image" alt="666.gif" loading="lazy" referrerpolicy="no-referrer"></p>
</li>
<li>
<p>因为相机在 skyBox 的内部，而内部的面不会显示，所以要将 X 轴或者 Z 轴的放大倍数变为负数，这样才能看到内部，scale.z=-1 时相当于将 Z 轴正向的面移到 Z 轴负方向上。</p>
<pre><code class="hljs language-javascript copyable" lang="javascript">skyBox.geometry.scale(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>);
<span class="copy-code-btn">复制代码</span></code></pre>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9ac2621386b249a99ef6a8b8c549fb2a~tplv-k3u1fbpfcp-zoom-1.image" alt="3333.gif" loading="lazy" referrerpolicy="no-referrer"></p>
</li>
<li>
<p>进一步优化体验：</p>
<pre><code class="hljs language-javascript copyable" lang="javascript">camera.position.z = <span class="hljs-number">0.01</span>; <span class="hljs-comment">// 将相机放在里面</span>
<span class="hljs-keyword">const</span> controls = <span class="hljs-keyword">new</span> OrbitControls(camera, renderer.domElement);
controls.enableZoom = <span class="hljs-literal">false</span>; <span class="hljs-comment">// 禁用放大</span>
controls.enablePan = <span class="hljs-literal">false</span>; <span class="hljs-comment">// 禁用双指缩放</span>
controls.enableDamping = <span class="hljs-literal">true</span>; <span class="hljs-comment">// 开启阻尼效果</span>
controls.rotateSpeed = -<span class="hljs-number">0.25</span>; <span class="hljs-comment">// 旋转方向取反，使内部拖拽旋转方向一致</span>
<span class="copy-code-btn">复制代码</span></code></pre>
<p>扫码看效果：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2e6052b1b1b84ea6a3812e06fb3c666a~tplv-k3u1fbpfcp-zoom-1.image" alt="image.png" loading="lazy" referrerpolicy="no-referrer"></p>
</li>
</ol>
<h2 data-id="heading-3">三、pannellum</h2>
<p><a href="https://pannellum.org/" target="_blank" rel="nofollow noopener noreferrer">pannellum</a> 是一个轻量级、免费、开源的基于 webGL 的全景播放器。支持多种投影方式、支持热点、支持漫游、视频等，且文档清晰明了、简单易用、API 比较丰富，易于功能扩展。
使用：</p>
<pre><code class="hljs language-javascript copyable" lang="javascript">pannellum.viewer(<span class="hljs-string">'container'</span>, &#123;
  <span class="hljs-attr">type</span>: <span class="hljs-string">'cubemap'</span>,
  <span class="hljs-attr">cubeMap</span>: [
    <span class="hljs-string">'https://img.alicdn.com/imgextra/i4/O1CN014TNffn1nlaTfA98Fg_!!6000000005130-0-tps-1500-1500.jpg'</span>,
    <span class="hljs-string">'https://img.alicdn.com/imgextra/i3/O1CN01LsO1Bk20QbKpFTUQr_!!6000000006844-0-tps-1500-1500.jpg'</span>,
    <span class="hljs-string">'https://img.alicdn.com/imgextra/i1/O1CN01sS5m781ya6JgLSaVk_!!6000000006594-0-tps-1500-1500.jpg'</span>,
    <span class="hljs-string">'https://img.alicdn.com/imgextra/i3/O1CN01uTWCLc1XOCOuA92H0_!!6000000002913-0-tps-1500-1500.jpg'</span>,
    <span class="hljs-string">'https://img.alicdn.com/imgextra/i4/O1CN016lU3YJ1JdrJuFTcWt_!!6000000001052-0-tps-1500-1500.jpg'</span>,
    <span class="hljs-string">'https://img.alicdn.com/imgextra/i2/O1CN01nYe2Mn1ohkmBVyKpp_!!6000000005257-0-tps-1500-1500.jpg'</span>,
  ],
&#125;);
<span class="copy-code-btn">复制代码</span></code></pre>
<p>扫码看效果：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ac98fb129eec46c9962e11cb12c1b092~tplv-k3u1fbpfcp-zoom-1.image" alt="image.png" loading="lazy" referrerpolicy="no-referrer"></p>
<p>基于 pannellum 我们封装了一个 360 全景容器组件 cube，支持了 pannellum 的所有配置，支持了立方体投影和球型投影两种方式、场景切换、陀螺仪效果等。目前该组件已应用在飞猪酒店详情中。
使用：</p>
<pre><code class="hljs language-javascript copyable" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">CubeDemo</span>(<span class="hljs-params"></span>) </span>&#123;
  <span class="hljs-keyword">const</span> [scenes, setScenes] = useState([]);

  useEffect(<span class="hljs-function">() =></span> &#123;
    <span class="hljs-comment">// 模拟异步请求</span>
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =></span> &#123;
      setScenes(
        [
          &#123;
            <span class="hljs-attr">preview</span>: <span class="hljs-string">'https://img.alicdn.com/imgextra/i1/O1CN01dVOIEe1IhEcaIPw2z_!!6000000000924-0-tps-100-100.jpg'</span>,
            <span class="hljs-attr">title</span>: <span class="hljs-string">'客厅'</span>,
            <span class="hljs-comment">// 或 panorama: 'https://img.alicdn.com/imgextra/i4/6000000007276/O1CN01Hp5gIf23cSOvzzA9k_!!6000000007276-0-hotel.jpg', //type: 'equirectangular' 时需要</span>
            <span class="hljs-attr">cubeMap</span>: [
              <span class="hljs-comment">// 顺序是：前、右、后、左、上、下</span>
              <span class="hljs-string">'https://gw.alicdn.com/imgextra/i3/O1CN01550SRA1JcwWgs0sIj_!!6000000001050-0-tps-1500-1500.jpg'</span>,
              <span class="hljs-string">'https://img.alicdn.com/imgextra/i4/O1CN01e796bV1P2CRfCQkrA_!!6000000001782-0-tps-1500-1500.jpg'</span>,
              <span class="hljs-string">'https://img.alicdn.com/imgextra/i4/O1CN01GcW84X29SHK4oJlWc_!!6000000008066-0-tps-1500-1500.jpg'</span>,
              <span class="hljs-string">'https://img.alicdn.com/imgextra/i2/O1CN01ZHLck11GX2ZgBHA4o_!!6000000000631-0-tps-1500-1500.jpg'</span>,
              <span class="hljs-string">'https://img.alicdn.com/imgextra/i2/O1CN019c9xKu1ig1aC7pWPk_!!6000000004441-0-tps-1500-1500.jpg'</span>,
              <span class="hljs-string">'https://img.alicdn.com/imgextra/i4/O1CN01XfaKOu1kzNYODz7HD_!!6000000004754-0-tps-1500-1500.jpg'</span>
            ]
          &#125;,
          &#123;
            <span class="hljs-attr">preview</span>: <span class="hljs-string">'https://img.alicdn.com/imgextra/i1/O1CN01KU3hrj1uJNO2OdyaC_!!6000000006016-0-tps-100-100.jpg'</span>,
            <span class="hljs-comment">// 或 panorama: 'https://img.alicdn.com/imgextra/i4/6000000004110/O1CN01lKLSsP1gEQSNAMIsJ_!!6000000004110-0-hotel.jpg',</span>
            <span class="hljs-attr">title</span>: <span class="hljs-string">'书房'</span>,
            <span class="hljs-attr">cubeMap</span>: [
              <span class="hljs-string">'https://img.alicdn.com/imgextra/i1/O1CN01fWDIfB1bWgC3NnVVa_!!6000000003473-0-tps-1500-1500.jpg'</span>,
              <span class="hljs-string">'https://img.alicdn.com/imgextra/i2/O1CN01xt97cb1YMeg4BOCbI_!!6000000003045-0-tps-1500-1500.jpg'</span>,
              <span class="hljs-string">'https://img.alicdn.com/imgextra/i1/O1CN01xKTq1u1DR8cdeMeYt_!!6000000000212-0-tps-1500-1500.jpg'</span>,
              <span class="hljs-string">'https://img.alicdn.com/imgextra/i3/O1CN01Zko8Qy1p1uCLUYBji_!!6000000005301-0-tps-1500-1500.jpg'</span>,
              <span class="hljs-string">'https://img.alicdn.com/imgextra/i3/O1CN01k3AVvK28W71UNWXW7_!!6000000007939-0-tps-1500-1500.jpg'</span>,
              <span class="hljs-string">'https://img.alicdn.com/imgextra/i1/O1CN015MBT6P1N8x3J83Fqo_!!6000000001526-0-tps-1500-1500.jpg'</span>
            ]
          &#125;
       ......
        ]
      );
    &#125;, <span class="hljs-number">1000</span>);
  &#125;, []);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag"><<span class="hljs-name">Cube</span>
      <span class="hljs-attr">container</span>=<span class="hljs-string">"viwer"</span>
      <span class="hljs-attr">config</span>=<span class="hljs-string">&#123;&#123;</span>
        <span class="hljs-attr">type:</span> '<span class="hljs-attr">cubemap</span>', // <span class="hljs-attr">or</span> '<span class="hljs-attr">equirectangular</span>'
        <span class="hljs-attr">scenes</span>,
      &#125;&#125; /></span></span>
  );
&#125;
<span class="copy-code-btn">复制代码</span></code></pre>
<p>扫码看效果：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f1565f2b708645ab9564d946464835ca~tplv-k3u1fbpfcp-zoom-1.image" alt="image.png" loading="lazy" referrerpolicy="no-referrer"></p>
<h3 data-id="heading-4">球型投影</h3>
<p>以上的实现全部是利用立方体实现的，除此之外，我们还可以使用圆柱体投影的方式，three.js 和 pannellum 都支持这种方式。
<img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a3269ed76f084abebf4c634d1d6b5db6~tplv-k3u1fbpfcp-zoom-1.image" alt="O1CN01djW9bE1h1QprTMP5d_!!6000000004217-0-hotel.jpeg" loading="lazy" referrerpolicy="no-referrer">
three.js 中：</p>
<pre><code class="hljs language-javascript copyable" lang="javascript"><span class="hljs-keyword">const</span> geometry = <span class="hljs-keyword">new</span> THREE.SphereBufferGeometry(<span class="hljs-number">300</span>, <span class="hljs-number">60</span>, <span class="hljs-number">40</span>); <span class="hljs-comment">// 初始化一个球体</span>
geometry.scale(-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>); <span class="hljs-comment">// 翻转x轴，将所有面朝向里</span>
<span class="hljs-keyword">const</span> texture = <span class="hljs-keyword">new</span> THREE.TextureLoader().load(
  <span class="hljs-string">'https://img.alicdn.com/imgextra/i2/6000000004217/O1CN01djW9bE1h1QprTMP5d_!!6000000004217-0-hotel.jpg'</span>
); <span class="hljs-comment">// 加载全景纹理</span>
<span class="hljs-keyword">const</span> material = <span class="hljs-keyword">new</span> THREE.MeshBasicMaterial(&#123; <span class="hljs-attr">map</span>: texture &#125;);
mesh = <span class="hljs-keyword">new</span> THREE.Mesh(geometry, material);
<span class="copy-code-btn">复制代码</span></code></pre>
<p>pannellum 中：</p>
<pre><code class="hljs language-javascript copyable" lang="javascript">pannellum.viewer(<span class="hljs-string">'panorama'</span>, &#123;
  <span class="hljs-attr">type</span>: <span class="hljs-string">'equirectangular'</span>,
  <span class="hljs-attr">panorama</span>:
    <span class="hljs-string">'https://img.alicdn.com/imgextra/i2/6000000004217/O1CN01djW9bE1h1QprTMP5d_!!6000000004217-0-hotel.jpg'</span>,
&#125;);
<span class="copy-code-btn">复制代码</span></code></pre>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/59493fc617bd4e358cd077f8d7e1c95b~tplv-k3u1fbpfcp-zoom-1.image" alt="5.gif" loading="lazy" referrerpolicy="no-referrer"></p>
<p>页面和代码可参考 <a href="https://threejs.org/examples/#webgl_panorama_equirectangular" target="_blank" rel="nofollow noopener noreferrer">webgl_panorama_equirectangular</a>
球型全景和立方体全景两种方式比较起来各有自己的特点，比如：</p>
<ul>
<li>球型全景图更贴近人眼的构建模式，只用一张图，但图片的尺寸可能会很大</li>
<li>球型全景图，从赤道到两极，横向拉伸不断加剧，导致南北极存在扭曲的情况</li>
<li>立方体兼容性更好，还可以用 css3 实现</li>
<li>从模型上来说,球型是由非常多的三角面拼接出来的，比立方体更复杂，所以立方体有更高的性能</li>
</ul>
<p>飞猪酒店详情中，服务端对这两种方式都提供了图片资源，但在使用球型全景的方式时少数酒店上传的图片过大，导致部分手机上组件加载资源出错，所以最终决定采用立方体的方式（）。</p>
<h2 data-id="heading-5">四、krpano</h2>
<p>krpano 是一款较专业的全景引擎平台。目前市场中较大的全景平台大部分都用了 krpano 。但由于它用法较复杂，有一定的学习成本，需要掌握其使用的 XML 的各种配置、功能较多较重且是收费的，对于酒店详情的简单的业务场景来说有点重了，所以权衡之后没有选择它，而是选择了相对轻量的 pannellum。
使用：</p>
<pre><code class="hljs language-javascript copyable" lang="javascript"><div id=<span class="hljs-string">'container'</span>></div>
<span class="copy-code-btn">复制代码</span></code></pre>
<pre><code class="hljs language-javascript copyable" lang="javascript">embedpano(&#123;
  <span class="hljs-attr">xml</span>:
    <span class="hljs-string">'https://raw.githubusercontent.com/xiaotianxia/three.js-learning/gh-pages/examples/config.xml'</span>,
  <span class="hljs-attr">target</span>: <span class="hljs-string">'container'</span>,
  <span class="hljs-attr">html5</span>: <span class="hljs-string">'auto'</span>,
  <span class="hljs-attr">mobilescale</span>: <span class="hljs-number">1.0</span>,
&#125;);
<span class="copy-code-btn">复制代码</span></code></pre>
<p>扫码看效果：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/52406890e2ec4a938d8c0cca37324093~tplv-k3u1fbpfcp-zoom-1.image" alt="image.png" loading="lazy" referrerpolicy="no-referrer"></p>
<h2 data-id="heading-6">总结</h2>
<p>本文叙述了实现 360 全景功能 4 种不同的方案，包括：CSS3、Three.js、pannellum 和 krpano，在基于 webGL 的方案中，介绍了两种主要的投影方式：立方体投影和球型投影，并给出了 demo 代码和页面，推荐了基于 pannellum 开发的 360 全景容器组件，
如有错误，欢迎指正。</p>
<h2 data-id="heading-7">参考</h2>
<ol>
<li><a href="https://www.smashingmagazine.com/2016/07/front-end-challenge-accepted-css-3d-cube/" target="_blank" rel="nofollow noopener noreferrer">Front-End Challenge Accepted: CSS 3D Cube</a></li>
<li><a href="https://3dtransforms.desandro.com/" target="_blank" rel="nofollow noopener noreferrer">Intro to CSS 3D transforms</a></li>
<li><a href="https://www.cnblogs.com/yanggeng/p/11285856.html" target="_blank" rel="nofollow noopener noreferrer">css3 系列之详解 perspective</a></li>
<li><a href="https://threejs.org/" target="_blank" rel="nofollow noopener noreferrer">threejs</a></li>
<li><a href="https://pannellum.org/" target="_blank" rel="nofollow noopener noreferrer">pannellum</a></li>
</ol></div>  
</div>
            