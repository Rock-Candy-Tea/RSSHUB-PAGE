
---
title: '老弟做了个网盘，炸了！'
categories: 
 - 编程
 - 掘金
 - 标签
headimg: 'https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/33ecfd83b7be437d995aed6e1ee8b73c~tplv-k3u1fbpfcp-watermark.image'
author: 掘金
comments: false
date: Thu, 12 Aug 2021 21:46:16 GMT
thumbnail: 'https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/33ecfd83b7be437d995aed6e1ee8b73c~tplv-k3u1fbpfcp-watermark.image'
---

<div>   
<div class="markdown-body"><style>.markdown-body&#123;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333&#125;.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6&#123;line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px&#125;.markdown-body h1&#123;font-size:30px;margin-bottom:5px&#125;.markdown-body h2&#123;padding-bottom:12px;font-size:24px;border-bottom:1px solid #ececec&#125;.markdown-body h3&#123;font-size:18px;padding-bottom:0&#125;.markdown-body h4&#123;font-size:16px&#125;.markdown-body h5&#123;font-size:15px&#125;.markdown-body h6&#123;margin-top:5px&#125;.markdown-body p&#123;line-height:inherit;margin-top:22px;margin-bottom:22px&#125;.markdown-body img&#123;max-width:100%&#125;.markdown-body hr&#123;border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px&#125;.markdown-body code&#123;word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em&#125;.markdown-body code,.markdown-body pre&#123;font-family:Menlo,Monaco,Consolas,Courier New,monospace&#125;.markdown-body pre&#123;overflow:auto;position:relative;line-height:1.75&#125;.markdown-body pre>code&#123;font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8&#125;.markdown-body a&#123;text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff&#125;.markdown-body a:active,.markdown-body a:hover&#123;color:#275b8c&#125;.markdown-body table&#123;display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6&#125;.markdown-body thead&#123;background:#f6f6f6;color:#000;text-align:left&#125;.markdown-body tr:nth-child(2n)&#123;background-color:#fcfcfc&#125;.markdown-body td,.markdown-body th&#123;padding:12px 7px;line-height:24px&#125;.markdown-body td&#123;min-width:120px&#125;.markdown-body blockquote&#123;color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8&#125;.markdown-body blockquote:after&#123;display:block;content:""&#125;.markdown-body blockquote>p&#123;margin:10px 0&#125;.markdown-body ol,.markdown-body ul&#123;padding-left:28px&#125;.markdown-body ol li,.markdown-body ul li&#123;margin-bottom:0;list-style:inherit&#125;.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item&#123;list-style:none&#125;.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul&#123;margin-top:0&#125;.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul&#123;margin-top:3px&#125;.markdown-body ol li&#123;padding-left:6px&#125;.markdown-body .contains-task-list&#123;padding-left:0&#125;.markdown-body .task-list-item&#123;list-style:none&#125;@media (max-width:720px)&#123;.markdown-body h1&#123;font-size:24px&#125;.markdown-body h2&#123;font-size:20px&#125;.markdown-body h3&#123;font-size:18px&#125;&#125;</style><blockquote>
<p>趣讲文件上传功能的巧妙设计</p>
</blockquote>
<p>大家好，我是鱼皮。</p>
<p>不知道大家有没有想过制作一款自己的网盘呢？这不，我学编程的老弟小阿巴做了一个，非常激动地找我来体验。</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/33ecfd83b7be437d995aed6e1ee8b73c~tplv-k3u1fbpfcp-watermark.image" alt loading="lazy" referrerpolicy="no-referrer"></p>
<p>打开网盘，界面仿的还不错，我简单试了下文件的上传和下载，没有什么问题。</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c4c0302885e04a00bccdea9d1b835c53~tplv-k3u1fbpfcp-watermark.image" alt="阿巴网盘" loading="lazy" referrerpolicy="no-referrer"></p>
<p>正当小阿巴洋洋得意时，我试着上传一个 1 GB 大小的文件。结果文件上传到 99% 时，网络一抖，文件上传失败，竟然还要从 0 开始重新上传？！</p>
<p>小阿巴无奈地挠挠头：网络不好，怪我咯？</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ebcc402cc7b742259e7d9b8dd43fc068~tplv-k3u1fbpfcp-watermark.image" alt loading="lazy" referrerpolicy="no-referrer"></p>
<p>我直接一巴掌甩过去，要知道，制作网盘可不是一件容易的事！</p>
<p>先从最基础的功能来说，要实现文件的上传、存储、下载、文件和目录管理。如果要真正上线、开放给其他人使用，还要考虑到权限管理、接口访问、CDN 加速，无论哪点自己来做都是很麻烦的。</p>
<p>所以除了学习之外，如果想要搭建自己的私人网盘，建议直接选择一些开源的，比如主流的 Seafile、Nextcloud、Cloudreve、OwnCloud 都可以。</p>
<p>当然，公用网盘最要命的还是带宽、存储等资源的费用，所以为了节约成本、支持更多用户访问，很多网盘都采取了限速、限制容量策略。</p>
<p>小阿巴：做了网盘这么麻烦啊，我放弃我放弃。。。</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ab0438bbb0b649b0b5ec8d0e85cbe735~tplv-k3u1fbpfcp-watermark.image" alt loading="lazy" referrerpolicy="no-referrer"></p>
<p>我笑到：虽然想做好网盘很难，但我们可以一步步来，学习每个功能中的优秀设计，相信最后也能做出一款不错的网盘。今天就先从 <strong>文件上传</strong> 讲起吧，解决下刚刚上传失败必须从 0 重新上传的问题等。</p>
<h3 data-id="heading-0">文件上传设计</h3>
<p>文件上传顾名思义就是把文件从本地电脑发送到存储文件的远程服务器上，小文件的上传倒没有什么好说的，主要考虑的是大文件上传怎么 <strong>更快、更稳定、更灵活、更快响应</strong> 等等，以提高用户的体验。</p>
<p>这里分享几个经典的大文件上传设计，包括文件分块、并发上传、断点续传、秒传、异步上传。</p>
<h4 data-id="heading-1">文件分块</h4>
<p>既然小文件的处理相对容易，那不妨在发送前，把大文件分割为多个连续的小文件，一块一块地发送。</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/26b7a287de12487ab8997773c02ed3f8~tplv-k3u1fbpfcp-watermark.image" alt="文件分块" loading="lazy" referrerpolicy="no-referrer"></p>
<p>此外，需要在发送每一个文件块时，额外传输一些信息，比如当前块数、文件总块数、文件大小、所属原文件标识（MD5）等：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3c8eafa7583c430eaf44c3a953fc0258~tplv-k3u1fbpfcp-watermark.image" alt loading="lazy" referrerpolicy="no-referrer"></p>
<p>这样，服务器就能一块一块地接收，把这些文件块保存到临时目录中。当接收到最后一块时，把之前的所有文件块再拼接到一起，就能组成完成的原文件啦。</p>
<h4 data-id="heading-2">并发上传</h4>
<p>将大文件分块后，就可以通过多线程并发上传，同时传输多个块：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/84170dd9cec6463c81a3bb44910db577~tplv-k3u1fbpfcp-watermark.image" alt="串行上传和并发上传" loading="lazy" referrerpolicy="no-referrer"></p>
<p>要根据网络情况决定是否并发上传、同时并发上传多少个块，不是并发数越多越好。网络好的话，并发数量调大一些，能够大大提高文件整体上传效率；相反，盲目调整并发数，上传可能会更慢。</p>
<h4 data-id="heading-3">断点续传</h4>
<p>对于大文件来说，上传中断后如果要从 0 开始重传，就太让人崩溃了！</p>
<p>推荐使用断点续传技术，原理很简单，在文件分块的基础上，服务器记录一下原文件对应的上传进度，每接收到一个块，就更新一下进度。这样，即使网络故障导致上传失败，也能从上传进度中知道哪些文件块已上传、接下来需要从哪一块重新开始了，而不用从第 1 块开始重新传输。</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b063c85a01a54e4092608c0f5a2fd433~tplv-k3u1fbpfcp-watermark.image" alt="断点续传" loading="lazy" referrerpolicy="no-referrer"></p>
<blockquote>
<p>该原理同样适用于文件下载。</p>
</blockquote>
<p>断点续传有很多种实现方式，自主实现、HTTP 协议 1.1 等，感兴趣的同学可以了解下。</p>
<h4 data-id="heading-4">秒传</h4>
<p>不知道大家有没有发现，有时，我们上传一个几 GB 的超大文件竟然可以在 1 秒内完成！</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b89fc22a979444efaa9968efa7989183~tplv-k3u1fbpfcp-watermark.image" alt loading="lazy" referrerpolicy="no-referrer"></p>
<p>这是咋实现的呢？真相只有一个，该文件肯定之前已经被上传过了！</p>
<p>这就是经典的秒传技术。</p>
<p>上传文件前，先在客户端（比如浏览器）根据文件内容计算出文件的 MD5 值，相同内容的文件 MD5 值必然相同。然后在服务器已上传文件数据库中查找该 MD5 对应的文件是否已存在。如果不存在，上传文件并在上传成功后将该文件信息插入数据库，过程如下：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7ca8a2208e374f9bab43cfa4e4f6eefa~tplv-k3u1fbpfcp-watermark.image" alt="文件秒传 - 文件不存在" loading="lazy" referrerpolicy="no-referrer"></p>
<p>若文件已存在，直接新建一个对该文件的引用就行了，不必重复上传，过程如下：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2ca3e3ece0154b739926b835ae2de1c3~tplv-k3u1fbpfcp-watermark.image" alt="文件秒传 - 文件已存在" loading="lazy" referrerpolicy="no-referrer"></p>
<p>不过要注意，不同内容文件的 MD5 值也可能会相同（碰撞），导致用户下载到不是自己上传的文件，所以检验重复时，还可以补充一些校验，比如针对文件前几位再生成一个 MD5、用其他 Hash 算法再生成一个校验值等。</p>
<h4 data-id="heading-5">异步上传</h4>
<p>除了同步上传外，当我们要上传的文件不在本地而是已经存在对应 url 时，也可以采用 <strong>全异步上传</strong> 的方式，将文件上传变成一个 <strong>任务</strong> 。</p>
<p>用户输入要上传的文件 url，点击上传后，不需要一直在文件上传页面等着，而是只需要告诉后台 “我要执行文件上传”，并向后台新建一个文件上传任务，就可以快速响应用户了，比如 “文件上传中，请留意通知”。等后台取出并真正完成文件上传的任务后，给用户发送通知就可以了。</p>
<p>整体步骤如下：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6580530afa1d48feb9992c447587666b~tplv-k3u1fbpfcp-watermark.image" alt="异步上传" loading="lazy" referrerpolicy="no-referrer"></p>
<hr>
<p>最后，如果只是需要在开发中用到文件上传，大可不必自己实现上述功能，用个现成的对象存储服务就好了。比如七牛云，分块上传什么的都给我们做好了，也可以参考七牛云 SDK 文档（<a href="https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Fqiniu%25EF%25BC%2589%25E6%259D%25A5%25E4%25BA%2586%25E8%25A7%25A3%25E5%25AE%2583%25E4%25BB%25AC%25E7%259A%2584%25E5%25AE%259E%25E7%258E%25B0%25E6%2596%25B9%25E5%25BC%258F%25E3%2580%2582" target="_blank" rel="nofollow noopener noreferrer" title="https://github.com/qiniu%EF%BC%89%E6%9D%A5%E4%BA%86%E8%A7%A3%E5%AE%83%E4%BB%AC%E7%9A%84%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F%E3%80%82" ref="nofollow noopener noreferrer">github.com/qiniu）来了解它们…</a></p>
<p>我是鱼皮，最后再送大家一些 <strong>帮助我拿到大厂 offer 的学习资料</strong>：</p>
<p><a href="https://link.juejin.cn/?target=https%3A%2F%2Ft.1yb.co%2FqOJG" target="_blank" rel="nofollow noopener noreferrer" title="https://t.1yb.co/qOJG" ref="nofollow noopener noreferrer">跑了，留下 6T 的资源！</a></p>
<p>欢迎阅读 <strong>我从 0 自学进入腾讯的编程学习、实习、求职、考证、写书经历，不再迷茫！</strong></p>
<p><a href="https://link.juejin.cn/?target=https%3A%2F%2Ft.1yb.co%2Fw66s" target="_blank" rel="nofollow noopener noreferrer" title="https://t.1yb.co/w66s" ref="nofollow noopener noreferrer">我学计算机的四年，共勉！</a></p>
<p>以上就是本期分享，有帮助的话点个赞吧 ❤️</p></div>  
</div>
            