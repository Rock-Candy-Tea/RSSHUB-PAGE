
---
title: '插件版网络请求设计使用技巧'
categories: 
 - 编程
 - 掘金
 - 标签
headimg: 'https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9d3a068b704f41b4b29e04a6d5855f50~tplv-k3u1fbpfcp-zoom-1.image'
author: 掘金
comments: false
date: Tue, 27 Jul 2021 07:56:40 GMT
thumbnail: 'https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9d3a068b704f41b4b29e04a6d5855f50~tplv-k3u1fbpfcp-zoom-1.image'
---

<div>   
<div class="markdown-body"><style>.markdown-body&#123;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333&#125;.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6&#123;line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px&#125;.markdown-body h1&#123;font-size:30px;margin-bottom:5px&#125;.markdown-body h2&#123;padding-bottom:12px;font-size:24px;border-bottom:1px solid #ececec&#125;.markdown-body h3&#123;font-size:18px;padding-bottom:0&#125;.markdown-body h4&#123;font-size:16px&#125;.markdown-body h5&#123;font-size:15px&#125;.markdown-body h6&#123;margin-top:5px&#125;.markdown-body p&#123;line-height:inherit;margin-top:22px;margin-bottom:22px&#125;.markdown-body img&#123;max-width:100%&#125;.markdown-body hr&#123;border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px&#125;.markdown-body code&#123;word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em&#125;.markdown-body code,.markdown-body pre&#123;font-family:Menlo,Monaco,Consolas,Courier New,monospace&#125;.markdown-body pre&#123;overflow:auto;position:relative;line-height:1.75&#125;.markdown-body pre>code&#123;font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8&#125;.markdown-body a&#123;text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff&#125;.markdown-body a:active,.markdown-body a:hover&#123;color:#275b8c&#125;.markdown-body table&#123;display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6&#125;.markdown-body thead&#123;background:#f6f6f6;color:#000;text-align:left&#125;.markdown-body tr:nth-child(2n)&#123;background-color:#fcfcfc&#125;.markdown-body td,.markdown-body th&#123;padding:12px 7px;line-height:24px&#125;.markdown-body td&#123;min-width:120px&#125;.markdown-body blockquote&#123;color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8&#125;.markdown-body blockquote:after&#123;display:block;content:""&#125;.markdown-body blockquote>p&#123;margin:10px 0&#125;.markdown-body ol,.markdown-body ul&#123;padding-left:28px&#125;.markdown-body ol li,.markdown-body ul li&#123;margin-bottom:0;list-style:inherit&#125;.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item&#123;list-style:none&#125;.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul&#123;margin-top:0&#125;.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul&#123;margin-top:3px&#125;.markdown-body ol li&#123;padding-left:6px&#125;.markdown-body .contains-task-list&#123;padding-left:0&#125;.markdown-body .task-list-item&#123;list-style:none&#125;@media (max-width:720px)&#123;.markdown-body h1&#123;font-size:24px&#125;.markdown-body h2&#123;font-size:20px&#125;.markdown-body h3&#123;font-size:18px&#125;&#125;</style><h1 data-id="heading-0">KJNetworkPluginManager</h1>
<ul>
<li>熟悉swift的朋友应该都知道一款优秀的三方库<a href="https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2FMoya%2FMoya" target="_blank" rel="nofollow noopener noreferrer" title="https://github.com/Moya/Moya" ref="nofollow noopener noreferrer">Moya</a>，插件版网络请求是真香，于是乎借鉴思路制作一款纯oc版本的插件网络请求库</li>
<li>熟悉oc的朋友又应该都知道一款优秀的三方库<a href="https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Fyuantiku%2FYTKNetwork" target="_blank" rel="nofollow noopener noreferrer" title="https://github.com/yuantiku/YTKNetwork" ref="nofollow noopener noreferrer">YTKNetwork</a>，基于对象的协议版网络请求，然后他的批量网络请求和链式网络请求也超级香</li>
<li>结合一下两者优点，制作一款 <code>批量</code> 和 <code>链式</code> 插件版网络请求库</li>
</ul>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9d3a068b704f41b4b29e04a6d5855f50~tplv-k3u1fbpfcp-zoom-1.image" alt="image" loading="lazy" referrerpolicy="no-referrer"></p>
<h2 data-id="heading-1">KJNetworkPlugin模块组成</h2>
<p><strong>KJNetworkPlugin</strong>是一款基于面向协议的网络抽象层的插件版网络请求库，基于<a href="https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2FAFNetworking%2FAFNetworking" target="_blank" rel="nofollow noopener noreferrer" title="https://github.com/AFNetworking/AFNetworking" ref="nofollow noopener noreferrer">AFNetworking</a>的基础上再次封装使用。简单讲应该分为这么几大板块：</p>
<ul>
<li><strong>Chain</strong>：链式插件版网络请求</li>
<li><strong>Batch</strong>：批量插件版网络请求</li>
<li><strong>Network</strong>：插件管理器和网络请求基类</li>
<li><strong>Plugins</strong>：插件集合，目前已有5款插件供使用
<ul>
<li>Loading：加载错误提示插件</li>
<li>Anslysis：数据解析插件</li>
<li>Cache：缓存插件</li>
<li>Certificate：自建证书插件</li>
<li>Thief：修改器插件</li>
</ul>
</li>
</ul>
<blockquote>
<p><strong>其实还有上传日志插件和加密解密插件等等，由于和项目耦合度比较高，暂时不考虑分享，后面我会提供思路，大家可以根据思路去封装属于自己的专属插件</strong></p>
</blockquote>
<h3 data-id="heading-2">Network版块</h3>
<ul>
<li><strong>KJBaseNetworking</strong>：网络请求基类，基于 AFNetworking 封装使用</li>
</ul>
<p>这里也提供两个入口，设置通用的根路径和通用参数，类似：userID，token等</p>
<pre><code class="copyable">/// 根路径地址
@property (nonatomic, strong, class) NSString *baseURL;
/// 基本参数，类似：userID，token等
@property (nonatomic, strong, class) NSDictionary *baseParameters;
<span class="copy-code-btn">复制代码</span></code></pre>
<p>封装的有基本的网络请求，上传下载文件等方法</p>
<ul>
<li><strong>KJNetworkingRequest</strong>：请求体，设置网络请求相关参数，其中包含参数，请求方式，插件等等</li>
</ul>
<pre><code class="copyable">/// 设置请求数据格式，默认 KJSerializerHTTP
@property (nonatomic, assign) KJSerializer requestSerializer;
/// 设置响应数据格式，默认 KJSerializerHTTP
@property (nonatomic, assign) KJSerializer responseSerializer;
/// 设置超时时间，默认30秒
@property (nonatomic, assign) NSTimeInterval timeoutInterval;
/// 默认请求头
@property (nonatomic, strong) NSDictionary *header;
/// 插件数组
@property (nonatomic, strong) NSArray<id<KJNetworkDelegate>>*plugins;
/// 请求类型，默认 KJNetworkRequestMethodPOST
@property (nonatomic, assign) KJNetworkRequestMethod method;
/// 根路径地址，默认 [KJBaseNetworking baseURL] 设置的根路径地址
@property (nonatomic, strong, nullable) NSString *ip;
/// 网络请求路径
@property (nonatomic, strong) NSString *path;
/// 请求参数
@property (nonatomic, strong, nullable) id params;
/// 加密参数，不涉及加密时刻该数据与上面一致
@property (nonatomic, strong, readonly) id secretParams;
/// 网址请求地址
@property (nonatomic, strong, readonly) NSString *URLString;

/// 网络请求插件时机，配合 `KJNetworkThiefPlugin` 插件使用效果极佳
@property (nonatomic, assign, readonly) KJRequestOpportunity opportunity;

/// 请求体标识符号，唯一标识
@property (nonatomic, strong, readonly) NSString *requestIdentifier;

/// 上传资源文件，需要使用时刻需要实例化该对象
@property (nonatomic, strong, nullable) KJConstructingBody *constructingBody;

/// 下载文件，需要使用时刻需要实例化该对象
@property (nonatomic, strong, nullable) KJDownloadBody *downloadBody;

<span class="copy-code-btn">复制代码</span></code></pre>
<blockquote>
<p><strong>后面的批量和链式网络请求，也需要继承该基类然后设计点高级用法，后面有空我再慢慢写文章分享，期待您的关注</strong></p>
</blockquote>
<ul>
<li>
<p><strong>KJNetworkingResponse</strong>：响应请求结果，这个类应该基本都是插件库内部使用或者<code>KJNetworkThiefPlugin</code>插件用到，获取插件之间产生的数据等等</p>
</li>
<li>
<p><strong>KJNetworkingType</strong>：汇总所有枚举和回调声明</p>
</li>
<li>
<p><strong>KJNetworkingDelegate</strong>：插件协议，目前抽离出以下5条协议方法，其中大致分为开始时刻、网络请求时刻、网络成功、网络失败、最终返回</p>
</li>
</ul>
<pre><code class="copyable">/// 开始准备网络请求
/// @param request 请求相关数据
/// @param endRequest 是否结束下面的网络请求
/// @return 返回准备插件处理后的数据
- (KJNetworkingResponse *)prepareWithRequest:(KJNetworkingRequest *)request endRequest:(BOOL *)endRequest;

/// 网络请求开始时刻请求
/// @param request 请求相关数据
/// @param stopRequest 是否停止网络请求
/// @return 返回网络请求开始时刻插件处理后的数据
- (KJNetworkingResponse *)willSendWithRequest:(KJNetworkingRequest *)request stopRequest:(BOOL *)stopRequest;

/// 成功接收数据
/// @param request  接收成功数据
/// @param againRequest 是否需要再次请求该网络
/// @return 返回成功插件处理后的数据
- (KJNetworkingResponse *)succeedWithRequest:(KJNetworkingRequest *)request againRequest:(BOOL *)againRequest;

/// 失败处理
/// @param request  失败的网络活动
/// @param againRequest 是否需要再次请求该网络
/// @return 返回失败插件处理后的数据
- (KJNetworkingResponse *)failureWithRequest:(KJNetworkingRequest *)request againRequest:(BOOL *)againRequest;

/// 准备返回给业务逻辑时刻调用
/// @param request 请求相关数据
/// @param error 错误信息
/// @return 返回最终加工之后的数据
- (KJNetworkingResponse *)processSuccessResponseWithRequest:(KJNetworkingRequest *)request error:(NSError **)error;
<span class="copy-code-btn">复制代码</span></code></pre>
<ul>
<li>
<p><strong>KJNetworkBasePlugin</strong>：插件基类，插件父类</p>
</li>
<li>
<p><strong>KJNetworkPluginManager</strong>：插件管理器，中枢神经，其实也就这么一个方法供外界调用</p>
</li>
</ul>
<pre><code class="copyable">/// 插件版网络请求
/// @param request 请求体
/// @param success 成功回调
/// @param failure 失败回调
+ (void)HTTPPluginRequest:(KJNetworkingRequest *)request success:(KJNetworkPluginSuccess)success failure:(KJNetworkPluginFailure)failure;
<span class="copy-code-btn">复制代码</span></code></pre>
<h3 data-id="heading-3">Plugins插件集合</h3>
<p>目前已有5款插件供使用：</p>
<ul>
<li>
<p><strong>KJNetworkLoadingPlugin</strong>：基于MBProgressHUD封装的加载框和错误提示框插件</p>
</li>
<li>
<p><strong>KJNetworkAnslysisPlugin</strong>：基于MJExtension封装的解析数据插件</p>
</li>
<li>
<p><strong>KJNetworkCachePlugin</strong>：基于YYCache封装的网络缓存插件</p>
</li>
<li>
<p><strong>KJNetworkCertificatePlugin</strong>：配置自建证书插件</p>
</li>
<li>
<p><strong>KJNetworkThiefPlugin</strong>：修改<code>KJNetworkingRequest</code>和获取 <code>KJNetworkingResponse</code>插件</p>
<ul>
<li>关于修改器插件使用介绍：<strong><a href="https://juejin.cn/post/6988730050820456455" target="_blank" title="https://juejin.cn/post/6988730050820456455">KJNetworkThiefPlugin</a></strong></li>
</ul>
</li>
</ul>
<blockquote>
<p><strong>后面有空我再来一一介绍每种插件设计思路和使用方式</strong></p>
</blockquote>
<h3 data-id="heading-4">Chain链式插件网络</h3>
<p>链式网络请求，关于如何使用后面再写文章，期待您的持续关注</p>
<p>这边目前封装两套使用链式插件方案，</p>
<ul>
<li>方案1：采用自定义参数方式处理</li>
</ul>
<pre><code class="copyable">/// 链式网络请求
/// @param request 请求体系
/// @param success 全部成功回调，存放请求所有结果数据
/// @param failure 失败回调，只要一个失败就会响应
/// @param chain 链式回调，返回下个网络请求体，为空时即可结束后续请求，responseObject上个网络请求响应数据
+ (void)HTTPChainRequest:(__kindof KJNetworkingRequest *)request
                 success:(KJNetworkChainSuccess)success
                 failure:(KJNetworkChainFailure)failure
                   chain:(KJNetworkNextChainRequest)chain,...;
<span class="copy-code-btn">复制代码</span></code></pre>
<ul>
<li>方案2：采用链式闭包方式处理</li>
</ul>
<pre><code class="copyable">/// 链式网络请求，需 `chain` 和 `lastchain` 配合使用
/// @param request 请求体系
/// @param failure 失败回调，只要一个失败就会响应
/// @return 返回自身对象
+ (instancetype)HTTPChainRequest:(__kindof KJNetworkingRequest *)request failure:(KJNetworkChainFailure)failure;
/// 请求体传递载体，回调返回上一个网络请求结果
@property (nonatomic, copy, readonly) KJNetworkChainManager * (^chain)(KJNetworkNextChainRequest);
/// 最后链数据回调，回调最后一个网络请求结果
@property (nonatomic, copy, readonly) void(^lastChain)(void(^)(id responseObject));
<span class="copy-code-btn">复制代码</span></code></pre>
<h3 data-id="heading-5">Batch批量插件网络</h3>
<p>批量插件网络请求，这里提供设置最大并发数量，失败调用次数，错误重连时机等配置信息</p>
<pre><code class="copyable">/// 批量网络请求
/// @param configuration 批量请求配置信息
/// @param reconnect 网络请求失败时候回调，返回YES再次继续批量处理
/// @param complete 最终结果回调，返回成功和失败数据数组
+ (void)HTTPBatchRequestConfiguration:(KJBatchConfiguration *)configuration
                            reconnect:(KJNetworkBatchReconnect)reconnect
                             complete:(KJNetworkBatchComplete)complete;
<span class="copy-code-btn">复制代码</span></code></pre>
<h2 data-id="heading-6">结尾介绍</h2>
<h3 data-id="heading-7">pod 安装使用</h3>
<pre><code class="copyable">pod 'KJNetworkPlugin' # 插件版网络
pod 'KJNetworkPlugin/Batch' # 批量插件网络请求
pod 'KJNetworkPlugin/Chain' # 链式插件网络请求
pod 'KJNetworkPlugin/Loading'
pod 'KJNetworkPlugin/Cache'
pod 'KJNetworkPlugin/Thief'
pod 'KJNetworkPlugin/Anslysis'
pod 'KJNetworkPlugin/Certificate'
<span class="copy-code-btn">复制代码</span></code></pre>
<p>写东西着实累，老铁们觉得有用还望点个星支持一下，传送门<a href="https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2FyangKJ%2FKJNetworkPlugin" target="_blank" rel="nofollow noopener noreferrer" title="https://github.com/yangKJ/KJNetworkPlugin" ref="nofollow noopener noreferrer">KJNetworkPlugin</a></p>
<p>后面有相关插件我也会慢慢补充...</p></div>  
</div>
            