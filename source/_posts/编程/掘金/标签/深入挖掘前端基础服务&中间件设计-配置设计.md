
---
title: '深入挖掘前端基础服务&中间件设计-配置设计'
categories: 
 - 编程
 - 掘金
 - 标签
headimg: 'https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1f06e156c59a40cc9ccfc4d90d25b5fa~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp?'
author: 掘金
comments: false
date: Wed, 07 Sep 2022 00:50:22 GMT
thumbnail: 'https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1f06e156c59a40cc9ccfc4d90d25b5fa~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp?'
---

<div>   
<div class="markdown-body cache"><style>.markdown-body&#123;word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#333&#125;.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6&#123;line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px&#125;.markdown-body h1&#123;font-size:24px;margin-bottom:5px&#125;.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6&#123;font-size:20px&#125;.markdown-body h2&#123;padding-bottom:12px;border-bottom:1px solid #ececec&#125;.markdown-body h3&#123;font-size:18px;padding-bottom:0&#125;.markdown-body h6&#123;margin-top:5px&#125;.markdown-body p&#123;line-height:inherit;margin-top:22px;margin-bottom:22px&#125;.markdown-body img&#123;max-width:100%&#125;.markdown-body hr&#123;border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px&#125;.markdown-body code&#123;word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em&#125;.markdown-body code,.markdown-body pre&#123;font-family:Menlo,Monaco,Consolas,Courier New,monospace&#125;.markdown-body pre&#123;overflow:auto;position:relative;line-height:1.75&#125;.markdown-body pre>code&#123;font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8&#125;.markdown-body a&#123;text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff&#125;.markdown-body a:active,.markdown-body a:hover&#123;color:#275b8c&#125;.markdown-body table&#123;display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6&#125;.markdown-body thead&#123;background:#f6f6f6;color:#000;text-align:left&#125;.markdown-body tr:nth-child(2n)&#123;background-color:#fcfcfc&#125;.markdown-body td,.markdown-body th&#123;padding:12px 7px;line-height:24px&#125;.markdown-body td&#123;min-width:120px&#125;.markdown-body blockquote&#123;color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8&#125;.markdown-body blockquote:after&#123;display:block;content:""&#125;.markdown-body blockquote>p&#123;margin:10px 0&#125;.markdown-body ol,.markdown-body ul&#123;padding-left:28px&#125;.markdown-body ol li,.markdown-body ul li&#123;margin-bottom:0;list-style:inherit&#125;.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item&#123;list-style:none&#125;.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul&#123;margin-top:0&#125;.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul&#123;margin-top:3px&#125;.markdown-body ol li&#123;padding-left:6px&#125;.markdown-body .contains-task-list&#123;padding-left:0&#125;.markdown-body .task-list-item&#123;list-style:none&#125;@media (max-width:720px)&#123;.markdown-body h1&#123;font-size:24px&#125;.markdown-body h2&#123;font-size:20px&#125;.markdown-body h3&#123;font-size:18px&#125;&#125;</style><h1 data-id="heading-0">前言</h1>
<p>这一集非常简单，思路简单，代码也少。模块配置设计这个词多少有点太专业，我们来具体阐述下，这个配置相关的设计的来源和目的</p>
<p><strong>大家在日常开发中，肯定遇到过这种场景：</strong></p>
<blockquote>
<p>功能开发中，某个功能场景需要用到配置信息，要判断业务场景的走向，一般的做法</p>
<p>1、进行<strong>前端独立配置</strong>，也就是放到某个文件中，代码编译打包后，携带到源代码中，线上环境需要，直接进文件目录进行更新---看着没毛病，但是业务耦合性较强</p>
<p>2、服务端<strong>开个接口</strong>，搞个配置表，在不同的业务情况下，业务模块调用这个接口，取到数据，在做逻辑判断走向。---看着也没毛病，但是业务耦合性较强</p>
</blockquote>
<p>上面是针对业务场景，但是实际中，大部分遇到的</p>
<ul>
<li>系统名称</li>
<li>系统Logo</li>
<li>登录背景图</li>
<li>ICP配置</li>
<li>业务类配置</li>
</ul>
<p>上述场景中，一般平躺的思维，就是模块种直接引用，可以快速达到目的。</p>
<p>但对于这种在业务代码直接硬编码从本地存储里面获取，当然也有可能被直接篡改数据的可能，问题还是比较多的。</p>
<blockquote>
<p>如果那一天，领导说，我们要把这些零散的配置提到公共层面进行统一管理，这个时候，你会怎么办？</p>
</blockquote>
<p><strong>思路上大同小异，上面的解决方案，规整下即可</strong></p>
<p>1、提取配置，放到一个文件中，统一使用接口请求方式，可以方便后期切换到服务接口进行管理维护
2、对数据进行存储，使用方式统一起来，简单</p>
<h1 data-id="heading-1">设计思路</h1>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1f06e156c59a40cc9ccfc4d90d25b5fa~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp?" alt="image.png" loading="lazy" referrerpolicy="no-referrer"></p>
<h2 data-id="heading-2">配置数据-systemConfig.json</h2>
<pre><code class="hljs language-js copyable" lang="js">&#123;
  <span class="hljs-string">"systemName"</span>: <span class="hljs-string">"系统名称"</span>,
  <span class="hljs-string">"systemLogo"</span>: <span class="hljs-string">"resource/image/home/Logo2.png"</span>,
  <span class="hljs-string">"loginBackground"</span>: <span class="hljs-string">"resource/image/login/login4.png"</span>,
  <span class="hljs-string">"userDocPath"</span>: <span class="hljs-string">"resource/notice/用户使用手册.pdf"</span>,
  <span class="hljs-string">"userDocName"</span>: <span class="hljs-string">"用户使用手册.pdf"</span>,
  <span class="hljs-string">"HeartTime"</span>:<span class="hljs-number">30000</span>,
  <span class="hljs-string">"FOOTER_ICP"</span>:<span class="hljs-string">"京ICP备xxxx"</span>,
  <span class="hljs-string">"IS_AUTH_INTERFACE"</span>: <span class="hljs-literal">false</span>,
  <span class="hljs-string">"MQTT_USER_CONFIG"</span>:&#123;
    <span class="hljs-string">"openIM"</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-string">"protocol"</span>:<span class="hljs-string">"ws"</span>,
    <span class="hljs-string">"hostname"</span>: <span class="hljs-string">""</span>,
    <span class="hljs-string">"port"</span>:<span class="hljs-string">""</span>,
    <span class="hljs-string">"proxy"</span>: <span class="hljs-string">""</span>,
    <span class="hljs-string">"path"</span>:<span class="hljs-string">"/ws"</span>,
    <span class="hljs-string">"options"</span>:&#123;
      <span class="hljs-string">"username"</span>: <span class="hljs-string">"guest"</span>,
      <span class="hljs-string">"password"</span>: <span class="hljs-string">"guest"</span>
    &#125;
  &#125;
&#125;
<span class="copy-code-btn">复制代码</span></code></pre>
<h2 data-id="heading-3">业务应用：</h2>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">Config</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">'@basic-library'</span>
<span class="hljs-keyword">const</span> &#123;systemName&#125; =  <span class="hljs-title class_">Config</span>.<span class="hljs-property">BSConfig</span> 
<span class="copy-code-btn">复制代码</span></code></pre>
<h1 data-id="heading-4">实践代码：</h1>
<h2 data-id="heading-5">应用实践</h2>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// 配置初始化加载</span>
    <span class="hljs-keyword">await</span> <span class="hljs-title class_">InitialConfig</span>(&#123; <span class="hljs-attr">mode</span>: <span class="hljs-string">'local'</span> &#125;)
<span class="copy-code-btn">复制代码</span></code></pre>
<p><strong>InitialConfig</strong></p>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">Config</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">'@basic-library'</span>
<span class="hljs-keyword">import</span> &#123; querySystemConfig &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">'./utils'</span>

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">InitialConfig</span>(<span class="hljs-params">&#123; mode = <span class="hljs-string">'server'</span> &#125;</span>) &#123;
  <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>([
    <span class="hljs-title function_">querySystemConfig</span>(mode),
  ]).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">res</span>) =></span> &#123;
    <span class="hljs-keyword">const</span> [<span class="hljs-title class_">BSConfig</span>] = res
    <span class="hljs-title class_">BSConfig</span>.<span class="hljs-property">data</span> && <span class="hljs-title class_">Config</span>.<span class="hljs-title function_">registerBSConfig</span>(<span class="hljs-title class_">BSConfig</span>.<span class="hljs-property">data</span>);
  &#125;);
&#125;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">InitialConfig</span>
<span class="copy-code-btn">复制代码</span></code></pre>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">/*
 * @Description: 系统配置-工具--请求
 * @Author: ffzheng
 */</span>
<span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">Request</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">'@basic-library'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">querySystemConfig</span>(<span class="hljs-params">mode</span>) &#123;
  <span class="hljs-keyword">const</span> <span class="hljs-title class_">BaseUrl</span> = process.<span class="hljs-property">env</span>.<span class="hljs-property">BASE_URL</span>
  <span class="hljs-keyword">if</span> (mode === <span class="hljs-string">'local'</span>) &#123;
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Request</span>.$http(&#123; <span class="hljs-attr">url</span>: <span class="hljs-string">`<span class="hljs-subst">$&#123;BaseUrl&#125;</span>config/systemConfig.json?<span class="hljs-subst">$&#123;<span class="hljs-built_in">Date</span>.now()&#125;</span>`</span>, <span class="hljs-attr">requestId</span>: <span class="hljs-string">'systemConfig'</span> &#125;);
  &#125;
  <span class="hljs-keyword">return</span> <span class="hljs-title class_">Request</span>.$http(&#123; <span class="hljs-attr">url</span>: <span class="hljs-string">`<span class="hljs-subst">$&#123;BaseUrl&#125;</span>Api/systemConfig?<span class="hljs-subst">$&#123;<span class="hljs-built_in">Date</span>.now()&#125;</span>`</span>, <span class="hljs-attr">requestId</span>: <span class="hljs-string">'systemConfig'</span> &#125;);
&#125;
<span class="copy-code-btn">复制代码</span></code></pre>
<p>请求和逻辑进行了隔离，使用到了<code>Promise.all</code>，方便后期进行扩展</p>
<h2 data-id="heading-6">配置管理器</h2>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-keyword">import</span> produce <span class="hljs-keyword">from</span> <span class="hljs-string">'immer'</span>;

<span class="hljs-keyword">const</span> config = &#123;
  <span class="hljs-comment">//模块配置</span>
  <span class="hljs-title class_">AppConfig</span>: <span class="hljs-title function_">produce</span>(&#123;&#125;, <span class="hljs-function">() =></span> &#123;&#125;),
  <span class="hljs-title function_">registerAppConfig</span>(<span class="hljs-params">options</span>) &#123;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">AppConfig</span> = <span class="hljs-title function_">produce</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">AppConfig</span>, <span class="hljs-function">(<span class="hljs-params">draft</span>) =></span> &#123;
      <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(options).<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">key</span>) =></span> &#123;
        draft[key] = options[key];
      &#125;);
    &#125;);
  &#125;,
  <span class="hljs-comment">//应用配置</span>
  <span class="hljs-title class_">BSConfig</span>: <span class="hljs-title function_">produce</span>(&#123;&#125;, <span class="hljs-function">() =></span> &#123;&#125;),
  <span class="hljs-title function_">registerBSConfig</span>(<span class="hljs-params">options</span>) &#123;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">BSConfig</span> = <span class="hljs-title function_">produce</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">BSConfig</span>, <span class="hljs-function">(<span class="hljs-params">draft</span>) =></span> &#123;
      <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(options).<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">key</span>) =></span> &#123;
        draft[key] = options[key];
      &#125;);
    &#125;);
  &#125;,
&#125;;

<span class="hljs-keyword">const</span> <span class="hljs-title class_">EDUConfig</span> = (<span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;
  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">window</span>.<span class="hljs-property">_EDU_CONFIG_</span>) &#123;
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">window</span>.<span class="hljs-property">_EDU_CONFIG_</span>;
  &#125; <span class="hljs-keyword">else</span> &#123;
    <span class="hljs-variable language_">window</span>.<span class="hljs-property">_EDU_CONFIG_</span> = config;
    <span class="hljs-keyword">return</span> config;
  &#125;
&#125;)();

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">EDUConfig</span>;

<span class="copy-code-btn">复制代码</span></code></pre>
<h2 data-id="heading-7">核心源码解读：</h2>
<p>这个还是一个理念，使用registerBSConfig注册后，对传入的数据options，赋值给BSConfig，其中用到了<code>immer.js </code>库的<code>produce</code></p>
<h3 data-id="heading-8">immer produce原理解析</h3>
<p>produce函数的逻辑很简单，不考虑柯里化可以看作三个步骤：生成draft对象，对draft对象进行修改操作，生成新的结果。</p>
<pre><code class="hljs language-scss copyable" lang="scss">function <span class="hljs-built_in">produce</span>(baseState, recipe) &#123; 
    const draft = <span class="hljs-built_in">createProxy</span>(baseState); 
    <span class="hljs-built_in">recipe</span>(draft); 
    const result = <span class="hljs-built_in">finalize</span>(draft); 
&#125; 
 
<span class="copy-code-btn">复制代码</span></code></pre>
<p>其中关键在于生成的draft对象，draft通过拦截取值操作和赋值操作将变化前后状态都记录下来。</p>
<p><br>
<strong>在这个函数内部对原来的数据进行任何操作，都不会对原对象产生任何影响。</strong></p>
<p>完毕~~~</p>
<p><strong>老铁们，我们一起关注系列设计：</strong></p>
<p><a href="https://juejin.cn/post/7139528848835608584" target="_blank" title="https://juejin.cn/post/7139528848835608584">深入挖掘前端基础服务&中间件设计-basic-library</a><br>
<a href="https://juejin.cn/post/7139912261312708644" target="_blank" title="https://juejin.cn/post/7139912261312708644">深入挖掘前端基础服务&中间件设计-字典设计</a></p></div>  
</div>
            