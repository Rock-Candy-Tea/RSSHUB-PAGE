
---
title: '移动应用遗留系统重构（15）- 数据库重构示例篇'
categories: 
 - 编程
 - 掘金
 - 标签
headimg: 'https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5e7a759b472546d59f1a88572560f4db~tplv-k3u1fbpfcp-zoom-1.image'
author: 掘金
comments: false
date: Tue, 29 Jun 2021 04:56:06 GMT
thumbnail: 'https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5e7a759b472546d59f1a88572560f4db~tplv-k3u1fbpfcp-zoom-1.image'
---

<div>   
<div class="markdown-body"><style>.markdown-body&#123;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333&#125;.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6&#123;line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px&#125;.markdown-body h1&#123;font-size:30px;margin-bottom:5px&#125;.markdown-body h2&#123;padding-bottom:12px;font-size:24px;border-bottom:1px solid #ececec&#125;.markdown-body h3&#123;font-size:18px;padding-bottom:0&#125;.markdown-body h4&#123;font-size:16px&#125;.markdown-body h5&#123;font-size:15px&#125;.markdown-body h6&#123;margin-top:5px&#125;.markdown-body p&#123;line-height:inherit;margin-top:22px;margin-bottom:22px&#125;.markdown-body img&#123;max-width:100%&#125;.markdown-body hr&#123;border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px&#125;.markdown-body code&#123;word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em&#125;.markdown-body code,.markdown-body pre&#123;font-family:Menlo,Monaco,Consolas,Courier New,monospace&#125;.markdown-body pre&#123;overflow:auto;position:relative;line-height:1.75&#125;.markdown-body pre>code&#123;font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8&#125;.markdown-body a&#123;text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff&#125;.markdown-body a:active,.markdown-body a:hover&#123;color:#275b8c&#125;.markdown-body table&#123;display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6&#125;.markdown-body thead&#123;background:#f6f6f6;color:#000;text-align:left&#125;.markdown-body tr:nth-child(2n)&#123;background-color:#fcfcfc&#125;.markdown-body td,.markdown-body th&#123;padding:12px 7px;line-height:24px&#125;.markdown-body td&#123;min-width:120px&#125;.markdown-body blockquote&#123;color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8&#125;.markdown-body blockquote:after&#123;display:block;content:""&#125;.markdown-body blockquote>p&#123;margin:10px 0&#125;.markdown-body ol,.markdown-body ul&#123;padding-left:28px&#125;.markdown-body ol li,.markdown-body ul li&#123;margin-bottom:0;list-style:inherit&#125;.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item&#123;list-style:none&#125;.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul&#123;margin-top:0&#125;.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul&#123;margin-top:3px&#125;.markdown-body ol li&#123;padding-left:6px&#125;.markdown-body .contains-task-list&#123;padding-left:0&#125;.markdown-body .task-list-item&#123;list-style:none&#125;@media (max-width:720px)&#123;.markdown-body h1&#123;font-size:24px&#125;.markdown-body h2&#123;font-size:20px&#125;.markdown-body h3&#123;font-size:18px&#125;&#125;</style><h1 data-id="heading-0">前言</h1>
<p>上一篇<a href="https://juejin.cn/post/6977702335879315493" target="_blank">移动应用遗留系统重构（14）- Kotlin+MVVM重构示例篇</a>我们介绍了动态模块团队将动态件主页切换至Kotlin代码、重构为MVVM架构，并且补充了自动化测试。经过重构后，团队的开发效率和版本质量有了明显的提升。但本地数据库的管理依旧还是大量的sql 语句拼写，非常不利于扩展及维护，编写自动化测试也非常麻烦。</p>
<p>Google官方的建议是<a href="https://developer.android.com/training/data-storage/room#db-migration-testing" target="_blank" rel="nofollow noopener noreferrer">我们强烈建议您使用 Room而不是 SQLite</a>。框架带来的好处是节省编写大量的模版代码，易于维护，同时面向接口，便于扩展。关于性能方面，有的同学可能认为，使用原生的SQL语句可以将性能优化到极致，但往往忽略了维护大量的SQL拼写语句也带来了非常大的成本，况且框架也支持自定义SQL语句。</p>
<p>接下来给大家分享，动态模块的本地缓存如何从Sqlite安全、渐进式重构至Room。</p>
<h1 data-id="heading-1">重构</h1>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
A(1.梳理业务逻辑)-->B(2.分析原有的代码设计)
B-->C(3.补充守护测试)
C-->D(4.简单设计)
D-->E(5.小步安全重构)
E-->F(6.集成验收测试)
</code></pre>
<h2 data-id="heading-2">1.梳理业务逻辑</h2>
<p>原有的缓存逻辑比较简单，主要提供2个功能。</p>
<ul>
<li>查询缓存的动态数据</li>
<li>保存缓存的动态数据（保存上一次加载的所有数据）</li>
</ul>
<h2 data-id="heading-3">2.分析原有的代码设计</h2>
<pre><code class="hljs language-java copyable" lang="java"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LocalDataSource</span> @<span class="hljs-title">Inject</span> <span class="hljs-title">constructor</span>(
        @<span class="hljs-title">ApplicationContext</span> <span class="hljs-title">private</span> <span class="hljs-title">var</span> <span class="hljs-title">mContext</span>: <span class="hljs-title">Context</span>) : <span class="hljs-title">DataSource</span> </span>&#123;

    <span class="hljs-comment">//判断游标是否为空</span>
    <span class="hljs-function">override fun <span class="hljs-title">getDynamicListFromCache</span><span class="hljs-params">()</span>: List<Dynamic> </span>&#123;
        val dynamicList: MutableList<Dynamic> = ArrayList()
        val dataBaseHelper = DataBaseHelper(mContext)
        val c = dataBaseHelper.writableDatabase.query(DataBaseHelper.dynamic_info, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>)
        <span class="hljs-keyword">if</span> (c.moveToFirst()) &#123; <span class="hljs-comment">//判断游标是否为空</span>
            <span class="hljs-keyword">for</span> (i in <span class="hljs-number">0</span> until c.count) &#123;
                c.move(i) <span class="hljs-comment">//移动到指定记录</span>
                val id = c.getInt(c.getColumnIndex(DataBaseHelper.id))
                val content = c.getString(c.getColumnIndex(DataBaseHelper.content))
                val date = c.getLong(c.getColumnIndex(DataBaseHelper.date))
                dynamicList.add(Dynamic(id, content, date))
            &#125;
        &#125;
        <span class="hljs-keyword">return</span> dynamicList
    &#125;

    <span class="hljs-function">override fun <span class="hljs-title">saveDynamicToCache</span><span class="hljs-params">(dynamicList: List<Dynamic>?)</span> </span>&#123;
        val dataBaseHelper = DataBaseHelper(mContext)
        dynamicList?.let &#123;
            dataBaseHelper.writableDatabase.delete(DataBaseHelper.dynamic_info, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>)
            <span class="hljs-keyword">for</span> ((id, content, date) in dynamicList) &#123;
                val cv = ContentValues()
                cv.put(DataBaseHelper.id, id)
                cv.put(DataBaseHelper.content, content)
                cv.put(DataBaseHelper.date, date)
                dataBaseHelper.writableDatabase.insert(DataBaseHelper.dynamic_info, <span class="hljs-keyword">null</span>, cv)
            &#125;
        &#125;
    &#125;
&#125;
<span class="copy-code-btn">复制代码</span></code></pre>
<p>主要存在问题：</p>
<ul>
<li>较多模版代码，不利于维护扩展</li>
<li>没有采用事务管理，极端大数据情况下，可能有异常</li>
<li>没有任何的守护测试</li>
</ul>
<h2 data-id="heading-4">3.补充守护测试</h2>
<pre><code class="hljs language-java copyable" lang="java"><span class="hljs-meta">@RunWith(AndroidJUnit4::class)</span>
<span class="hljs-meta">@MediumTest</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LocalDataSourceTest</span> </span>&#123;

    <span class="hljs-meta">@Test</span>
    fun `should get dynamic is empty when database has not data`() &#123;
        <span class="hljs-comment">//given</span>
        val localDataSource = LocalDataSource(ApplicationProvider.getApplicationContext())
        <span class="hljs-comment">//when</span>
        val dynamicListFromCache = localDataSource.getDynamicListFromCache()
        <span class="hljs-comment">//then</span>
        assertThat(dynamicListFromCache).isEmpty()
    &#125;

    <span class="hljs-meta">@Test</span>
    fun `should get dynamic success when database has data`() &#123;
        <span class="hljs-comment">//given</span>
        val localDataSource = LocalDataSource(ApplicationProvider.getApplicationContext())
        localDataSource.saveDynamicToCache(getMockData())
        <span class="hljs-comment">//when</span>
        val dynamicListFromCache = localDataSource.getDynamicListFromCache()
        <span class="hljs-comment">//then</span>
        val dynamicOne = dynamicListFromCache[<span class="hljs-number">0</span>]
        assertThat(dynamicOne.id).isEqualTo(<span class="hljs-number">1</span>)
        assertThat(dynamicOne.content).isEqualTo(<span class="hljs-string">"今天天气真不错！"</span>)
        assertThat(dynamicOne.date).isEqualTo(<span class="hljs-number">1615963675000L</span>)
        val dynamicTwo = dynamicListFromCache[<span class="hljs-number">1</span>]
        assertThat(dynamicTwo.id).isEqualTo(<span class="hljs-number">2</span>)
        assertThat(dynamicTwo.content).isEqualTo(<span class="hljs-string">"这个连续剧值得追！"</span>)
        assertThat(dynamicTwo.date).isEqualTo(<span class="hljs-number">1615963688000L</span>)
    &#125;


    <span class="hljs-function"><span class="hljs-keyword">private</span> fun <span class="hljs-title">getMockData</span><span class="hljs-params">()</span>: ArrayList<Dynamic> </span>&#123;
        val dynamicList = ArrayList<Dynamic>()
        dynamicList.add(Dynamic(<span class="hljs-number">1</span>, <span class="hljs-string">"今天天气真不错！"</span>, <span class="hljs-number">1615963675000L</span>))
        dynamicList.add(Dynamic(<span class="hljs-number">2</span>, <span class="hljs-string">"这个连续剧值得追！"</span>, <span class="hljs-number">1615963688000L</span>))
        <span class="hljs-keyword">return</span> dynamicList
    &#125;
&#125;
<span class="copy-code-btn">复制代码</span></code></pre>
<h2 data-id="heading-5">4.简单设计</h2>
<p>分步进行重构，小步验证。</p>
<ol>
<li>将SQLiteOpenHelper管理数据库替换成Room的管理，但还是维持原有的SQL操作方式</li>
<li>将原有的SQL操作方式调整为ROOM的Dao形式</li>
<li>使用Coroutine管理数据库的异步操作</li>
<li>调整已有的测试用例</li>
</ol>
<h2 data-id="heading-6">5.小步安全重构</h2>
<h3 data-id="heading-7">将SQLiteOpenHelper管理数据库替换成Room的管理，但还是维持原有的SQL操作方式</h3>
<ol>
<li>bean改造，注意字段与表名需要与原来一致</li>
</ol>
<pre><code class="hljs language-java copyable" lang="java"><span class="hljs-meta">@Entity(tableName="dynamic_info")</span>
<span class="hljs-function">data class <span class="hljs-title">Dynamic</span><span class="hljs-params">(<span class="hljs-meta">@PrimaryKey</span> <span class="hljs-meta">@ColumnInfo(name = "id")</span> val id: Int,
                   <span class="hljs-meta">@ColumnInfo(name = "content")</span> val content: String,
                   <span class="hljs-meta">@ColumnInfo(name = "date")</span> val date: Long)</span> </span>&#123;
    <span class="hljs-meta">@Ignore</span>
    val formatDate = DateUtil.getDateToString(date)
&#125;
<span class="copy-code-btn">复制代码</span></code></pre>
<ol start="2">
<li>使用SupportSQLiteOpenHelper进行管理，继续以writableDatabase进行管理</li>
</ol>
<pre><code class="hljs language-java copyable" lang="java"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LocalDataSource</span> @<span class="hljs-title">Inject</span> <span class="hljs-title">constructor</span>(
        @<span class="hljs-title">ApplicationContext</span> <span class="hljs-title">private</span> <span class="hljs-title">var</span> <span class="hljs-title">mContext</span>: <span class="hljs-title">Context</span>) : <span class="hljs-title">DataSource</span> </span>&#123;

    val db = Room.databaseBuilder(
            mContext,
            AppDatabase::class.java, <span class="hljs-string">"dynamic.db"</span>
    ).build()


    <span class="hljs-comment">//判断游标是否为空</span>
    <span class="hljs-function">override fun <span class="hljs-title">getDynamicListFromCache</span><span class="hljs-params">()</span>: List<Dynamic> </span>&#123;
        val dynamicList: MutableList<Dynamic> = ArrayList()
        val dataBaseHelper = db.openHelper
        val c = dataBaseHelper.writableDatabase.query(<span class="hljs-string">""</span>)
        <span class="hljs-keyword">if</span> (c.moveToFirst()) &#123; <span class="hljs-comment">//判断游标是否为空</span>
            <span class="hljs-keyword">for</span> (i in <span class="hljs-number">0</span> until c.count) &#123;
                c.move(i) <span class="hljs-comment">//移动到指定记录</span>
                val id = c.getInt(c.getColumnIndex(DataBaseHelper.id))
                val content = c.getString(c.getColumnIndex(DataBaseHelper.content))
                val date = c.getLong(c.getColumnIndex(DataBaseHelper.date))
                dynamicList.add(Dynamic(id, content, date))
            &#125;
        &#125;
        <span class="hljs-keyword">return</span> dynamicList
    &#125;

    <span class="hljs-function">override fun <span class="hljs-title">saveDynamicToCache</span><span class="hljs-params">(dynamicList: List<Dynamic>?)</span> </span>&#123;
        val dataBaseHelper = db.openHelper
        dynamicList?.let &#123;
            dataBaseHelper.writableDatabase.delete(DataBaseHelper.dynamic_info, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>)
            <span class="hljs-keyword">for</span> ((id, content, date) in dynamicList) &#123;
                val cv = ContentValues()
                cv.put(DataBaseHelper.id, id)
                cv.put(DataBaseHelper.content, content)
                cv.put(DataBaseHelper.date, date)
                dataBaseHelper.writableDatabase.insert(DataBaseHelper.dynamic_info, SQLiteDatabase.CONFLICT_REPLACE, cv)
            &#125;
        &#125;
    &#125;
&#125;
<span class="copy-code-btn">复制代码</span></code></pre>
<h3 data-id="heading-8">将原有的SQL操作方式调整为ROOM的Dao形式</h3>
<pre><code class="hljs language-java copyable" lang="java"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LocalDataSource</span> @<span class="hljs-title">Inject</span> <span class="hljs-title">constructor</span>(
        @<span class="hljs-title">ApplicationContext</span> <span class="hljs-title">private</span> <span class="hljs-title">var</span> <span class="hljs-title">mContext</span>: <span class="hljs-title">Context</span>) : <span class="hljs-title">DataSource</span> </span>&#123;

    <span class="hljs-keyword">private</span> val db = Room.databaseBuilder(
            mContext,
            AppDatabase::class.java, <span class="hljs-string">"dynamic.db"</span>
    ).build()


    <span class="hljs-comment">//判断游标是否为空</span>
    <span class="hljs-function">override  fun <span class="hljs-title">getDynamicListFromCache</span><span class="hljs-params">()</span>: List<Dynamic> </span>&#123;
        <span class="hljs-keyword">return</span> db.dynamicDao().getAll()
    &#125;

    <span class="hljs-function">override  fun <span class="hljs-title">saveDynamicToCache</span><span class="hljs-params">(dynamicList: List<Dynamic>?)</span> </span>&#123;

        dynamicList?.let &#123;
            db.dynamicDao().deleteAll()
            db.dynamicDao().insertAll(*it.toTypedArray())
        &#125;
    &#125;
<span class="copy-code-btn">复制代码</span></code></pre>
<h3 data-id="heading-9">使用Coroutine管理数据库的异步操作</h3>
<pre><code class="hljs language-java copyable" lang="java"><span class="hljs-meta">@Dao</span>
<span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">DynamicDao</span> </span>&#123;
    <span class="hljs-meta">@Query("SELECT * FROM dynamic_info")</span>
    <span class="hljs-function">suspend fun <span class="hljs-title">getAll</span><span class="hljs-params">()</span>: List<Dynamic>

    @Insert
    suspend fun <span class="hljs-title">insertAll</span><span class="hljs-params">(vararg dynamic: Dynamic)</span>


    @<span class="hljs-title">Query</span><span class="hljs-params">(<span class="hljs-string">"DELETE FROM dynamic_info"</span>)</span>
    suspend fun <span class="hljs-title">deleteAll</span><span class="hljs-params">()</span>
&#125;
</span><span class="copy-code-btn">复制代码</span></code></pre>
<h3 data-id="heading-10">调整已有的测试用例</h3>
<pre><code class="hljs language-java copyable" lang="java"><span class="hljs-meta">@ExperimentalCoroutinesApi</span>
<span class="hljs-meta">@RunWith(AndroidJUnit4::class)</span>
<span class="hljs-meta">@MediumTest</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LocalDataSourceTest</span> </span>&#123;
    <span class="hljs-keyword">private</span> val testDispatcher = TestCoroutineDispatcher()

    <span class="hljs-meta">@Before</span>
    <span class="hljs-function">fun <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>&#123;
        Dispatchers.setMain(testDispatcher)
    &#125;

    <span class="hljs-meta">@After</span>
    <span class="hljs-function">fun <span class="hljs-title">tearDown</span><span class="hljs-params">()</span> </span>&#123;
        Dispatchers.resetMain()
        testDispatcher.cleanupTestCoroutines()
    &#125;

    <span class="hljs-meta">@Test</span>
    fun `should get dynamic is empty when database has not data`() = runBlocking &#123;
        <span class="hljs-comment">//given</span>
        val localDataSource = LocalDataSource(ApplicationProvider.getApplicationContext())
        <span class="hljs-comment">//when</span>
        val dynamicListFromCache = localDataSource.getDynamicListFromCache()
        <span class="hljs-comment">//then</span>
        assertThat(dynamicListFromCache).isEmpty()
    &#125;

    <span class="hljs-meta">@Test</span>
    fun `should get dynamic success when database has data`() = runBlocking &#123;
        <span class="hljs-comment">//given</span>
        val localDataSource = LocalDataSource(ApplicationProvider.getApplicationContext())
        localDataSource.saveDynamicToCache(getMockData())
        <span class="hljs-comment">//when</span>
        val dynamicListFromCache = localDataSource.getDynamicListFromCache()
        <span class="hljs-comment">//then</span>
        val dynamicOne = dynamicListFromCache[<span class="hljs-number">0</span>]
        assertThat(dynamicOne.id).isEqualTo(<span class="hljs-number">1</span>)
        assertThat(dynamicOne.content).isEqualTo(<span class="hljs-string">"今天天气真不错！"</span>)
        assertThat(dynamicOne.date).isEqualTo(<span class="hljs-number">1615963675000L</span>)
        val dynamicTwo = dynamicListFromCache[<span class="hljs-number">1</span>]
        assertThat(dynamicTwo.id).isEqualTo(<span class="hljs-number">2</span>)
        assertThat(dynamicTwo.content).isEqualTo(<span class="hljs-string">"这个连续剧值得追！"</span>)
        assertThat(dynamicTwo.date).isEqualTo(<span class="hljs-number">1615963688000L</span>)
    &#125;


    <span class="hljs-function"><span class="hljs-keyword">private</span> fun <span class="hljs-title">getMockData</span><span class="hljs-params">()</span>: ArrayList<Dynamic> </span>&#123;
        val dynamicList = ArrayList<Dynamic>()
        dynamicList.add(Dynamic(<span class="hljs-number">1</span>, <span class="hljs-string">"今天天气真不错！"</span>, <span class="hljs-number">1615963675000L</span>))
        dynamicList.add(Dynamic(<span class="hljs-number">2</span>, <span class="hljs-string">"这个连续剧值得追！"</span>, <span class="hljs-number">1615963688000L</span>))
        <span class="hljs-keyword">return</span> dynamicList
    &#125;
&#125;
<span class="copy-code-btn">复制代码</span></code></pre>
<h2 data-id="heading-11">6.集成验收测试</h2>
<ol>
<li>允行Dynamic模块所有守护测试，成功</li>
</ol>
<pre><code class="copyable"> ./gradlew dynamicBundle:testDUT
 ./gradlew dynamicDebug:testDUT 
<span class="copy-code-btn">复制代码</span></code></pre>
<ol start="2">
<li>编译运行DynamicDebug出现异常如下：</li>
</ol>
<pre><code class="copyable"> java.lang.IllegalStateException: Pre-packaged database has an invalid schema: dynamic_info(com.cloud.disk.bundle.dynamic.Dynamic).
     Expected:
    TableInfo&#123;name='dynamic_info', columns=&#123;date=Column&#123;name='date', type='INTEGER', affinity='3', notNull=true, primaryKeyPosition=0, defaultValue='null'&#125;, content=Column&#123;name='content', type='TEXT', affinity='2', notNull=true, primaryKeyPosition=0, defaultValue='null'&#125;, id=Column&#123;name='id', type='INTEGER', affinity='3', notNull=true, primaryKeyPosition=1, defaultValue='null'&#125;&#125;, foreignKeys=[], indices=[]&#125;
     Found:
    TableInfo&#123;name='dynamic_info', columns=&#123;date=Column&#123;name='date', type='LONG', affinity='1', notNull=false, primaryKeyPosition=0, defaultValue='null'&#125;, id=Column&#123;name='id', type='INTEGER', affinity='3', notNull=false, primaryKeyPosition=1, defaultValue='null'&#125;, content=Column&#123;name='content', type='VARCHAR(1024)', affinity='2', notNull=false, primaryKeyPosition=0, defaultValue='null'&#125;&#125;, foreignKeys=[], indices=[]&#125;
        at androidx.room.RoomOpenHelper.checkIdentity(RoomOpenHelper.java:163)
       
<span class="copy-code-btn">复制代码</span></code></pre>
<p>这是因为我们在测试阶段运行在JVM的环境上，没有提前发现数据迁移的问题。这里我们需要使用ROOM的Migration机制进行数据备份迁移。</p>
<pre><code class="hljs language-java copyable" lang="java">  <span class="hljs-keyword">private</span> val MIGRATION_1_2 = object : Migration(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>) &#123;
        <span class="hljs-function">override fun <span class="hljs-title">migrate</span><span class="hljs-params">(database: SupportSQLiteDatabase)</span> </span>&#123;
            database.execSQL(<span class="hljs-string">"ALTER TABLE dynamic_info RENAME TO dynamic_info_back_up"</span>)
            database.execSQL(<span class="hljs-string">"CREATE TABLE dynamic_info ( id  INTEGER PRIMARY KEY NOT NULL, content TEXT NOT NULL,date INTEGER NOT NULL)"</span>)
            database.execSQL(<span class="hljs-string">"INSERT INTO dynamic_info (id, content,date) SELECT id, content,date FROM dynamic_info_back_up"</span>)
        &#125;
    &#125;

    <span class="hljs-keyword">private</span> val db = Room.databaseBuilder(
            mContext,
            AppDatabase::class.java, <span class="hljs-string">"dynamic.db"</span>
    ).addMigrations(MIGRATION_1_2).build()

<span class="copy-code-btn">复制代码</span></code></pre>
<p>更多迁移及测试见<a href="https://developer.android.google.cn/training/data-storage/room/migrating-db-versions" target="_blank" rel="nofollow noopener noreferrer">迁移 Room 数据库</a>、<a href="https://developer.android.google.cn/training/data-storage/room/sqlite-room-migration" target="_blank" rel="nofollow noopener noreferrer">从SQlite迁移到Room</a></p>
<h1 data-id="heading-12">总结</h1>
<p>本篇我们分享了动态模块数据库从Sqlite迁移至Room的过程，使用框架节省编写大量的模版代码，易于维护及扩展。</p>
<p>前面CloudDisk团队已经拆分成了多仓库开发，但各个模块各自维护了第三方库。除了版本不统一、也导致打包构建时会带入多个版本的三方库。</p>
<p>下一篇，移动应用遗留系统重构（16）- Gradle依赖管理篇。我们将继续对CloudDisk的Gradle版本进行统一管理演示。</p>
<h1 data-id="heading-13">CloudDisk示例代码</h1>
<p><a href="https://github.com/junbin1011/CloudDisk" target="_blank" rel="nofollow noopener noreferrer">CloudDisk</a></p>
<h1 data-id="heading-14">系列链接</h1>
<p><a href="https://juejin.cn/post/6943470229905211422" target="_blank">移动应用遗留系统重构（1）- 开篇</a></p>
<p><a href="https://juejin.cn/post/6945313969556946980" target="_blank">移动应用遗留系统重构（2）-架构篇</a></p>
<p><a href="https://juejin.cn/post/6947855094272491556" target="_blank">移动应用遗留系统重构（3）-示例篇</a></p>
<p><a href="https://juejin.cn/post/6950077521790500894" target="_blank">移动应用遗留系统重构（4）-分析篇</a></p>
<p><a href="https://juejin.cn/post/6952298178095874055" target="_blank">移动应用遗留系统重构（5）- 重构方法篇</a></p>
<p><a href="https://juejin.cn/post/6954635678982340622" target="_blank">移动应用遗留系统重构（6）- 测试篇</a></p>
<p><a href="https://juejin.cn/post/6959504791642832909" target="_blank">移动应用遗留系统重构（7）- 解耦重构演示篇(一)+视频演示</a></p>
<p><a href="https://juejin.cn/post/6963214120178941983" target="_blank">移动应用遗留系统重构（8）- 依赖注入篇</a></p>
<p><a href="https://juejin.cn/post/6966166367821103117" target="_blank">移动应用遗留系统重构（9）- 路由篇</a></p>
<p><a href="https://juejin.cn/post/6970870458660945934" target="_blank">移动应用遗留系统重构（10）- 解耦重构演示篇（二）</a></p>
<p><a href="https://juejin.cn/post/6973836199655899149" target="_blank">移动应用遗留系统重构（11）- 制品管理篇</a></p>
<p><a href="https://juejin.cn/post/6974634615537401886" target="_blank">移动应用遗留系统重构（12）- 编译调试篇</a></p>
<p><a href="https://juejin.cn/post/6975877150314332168" target="_blank">移动应用遗留系统重构（13）- 编译调试篇</a></p>
<p><a href="https://juejin.cn/post/6975877150314332168" target="_blank">移动应用遗留系统重构（13）- 编译调试篇</a></p>
<p><a href="https://juejin.cn/post/6977702335879315493" target="_blank">移动应用遗留系统重构（14）- Kotlin+MVVM重构示例篇</a></p>
<h1 data-id="heading-15">大纲</h1>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5e7a759b472546d59f1a88572560f4db~tplv-k3u1fbpfcp-zoom-1.image" alt loading="lazy" referrerpolicy="no-referrer"></p>
<h1 data-id="heading-16">关于</h1>
<ul>
<li>作者：黄俊彬</li>
<li><a href="https://junbin.tech/" target="_blank" rel="nofollow noopener noreferrer">博客：junbin.tech</a></li>
<li><a href="https://github.com/junbin1011" target="_blank" rel="nofollow noopener noreferrer">GitHub: junbin1011 </a></li>
<li><a href="https://www.zhihu.com/people/junbin-9-77" target="_blank" rel="nofollow noopener noreferrer">知乎: @JunBin</a></li>
</ul></div>  
</div>
            