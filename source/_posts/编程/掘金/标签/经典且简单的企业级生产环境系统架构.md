
---
title: '经典且简单的企业级生产环境系统架构'
categories: 
 - 编程
 - 掘金
 - 标签
headimg: 'https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/fbcb0cde2f8244dc9b8a1cfa03abfe07~tplv-k3u1fbpfcp-watermark.image'
author: 掘金
comments: false
date: Fri, 30 Jul 2021 22:54:21 GMT
thumbnail: 'https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/fbcb0cde2f8244dc9b8a1cfa03abfe07~tplv-k3u1fbpfcp-watermark.image'
---

<div>   
<div class="markdown-body"><style>.markdown-body&#123;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333&#125;.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6&#123;line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px&#125;.markdown-body h1&#123;font-size:30px;margin-bottom:5px&#125;.markdown-body h2&#123;padding-bottom:12px;font-size:24px;border-bottom:1px solid #ececec&#125;.markdown-body h3&#123;font-size:18px;padding-bottom:0&#125;.markdown-body h4&#123;font-size:16px&#125;.markdown-body h5&#123;font-size:15px&#125;.markdown-body h6&#123;margin-top:5px&#125;.markdown-body p&#123;line-height:inherit;margin-top:22px;margin-bottom:22px&#125;.markdown-body img&#123;max-width:100%&#125;.markdown-body hr&#123;border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px&#125;.markdown-body code&#123;word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em&#125;.markdown-body code,.markdown-body pre&#123;font-family:Menlo,Monaco,Consolas,Courier New,monospace&#125;.markdown-body pre&#123;overflow:auto;position:relative;line-height:1.75&#125;.markdown-body pre>code&#123;font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8&#125;.markdown-body a&#123;text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff&#125;.markdown-body a:active,.markdown-body a:hover&#123;color:#275b8c&#125;.markdown-body table&#123;display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6&#125;.markdown-body thead&#123;background:#f6f6f6;color:#000;text-align:left&#125;.markdown-body tr:nth-child(2n)&#123;background-color:#fcfcfc&#125;.markdown-body td,.markdown-body th&#123;padding:12px 7px;line-height:24px&#125;.markdown-body td&#123;min-width:120px&#125;.markdown-body blockquote&#123;color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8&#125;.markdown-body blockquote:after&#123;display:block;content:""&#125;.markdown-body blockquote>p&#123;margin:10px 0&#125;.markdown-body ol,.markdown-body ul&#123;padding-left:28px&#125;.markdown-body ol li,.markdown-body ul li&#123;margin-bottom:0;list-style:inherit&#125;.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item&#123;list-style:none&#125;.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul&#123;margin-top:0&#125;.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul&#123;margin-top:3px&#125;.markdown-body ol li&#123;padding-left:6px&#125;.markdown-body .contains-task-list&#123;padding-left:0&#125;.markdown-body .task-list-item&#123;list-style:none&#125;@media (max-width:720px)&#123;.markdown-body h1&#123;font-size:24px&#125;.markdown-body h2&#123;font-size:20px&#125;.markdown-body h3&#123;font-size:18px&#125;&#125;</style><blockquote>
<p>各位读者好久不见，很长一段时间的周末都在忙着在为新工作做准备，所以没把时间用在写文章上。今天本也有安排， 可还是想抽点时间出来写一篇文章，对这一项目的技术栈做总结。</p>
</blockquote>
<p>文章正式开始之前还是想简单说一句我找工作的想法。受到开源社区以及一些Youtube程序员UP主的影响，对于下一份工作，它应该是一份我自己喜欢而且有英语工作环境的工作。快乐的coding才能做出一个真正受欢迎的程序吧 :-D 而且自己也不会感觉到很疲惫。期待有一天我也能拥有一个像Redis那样受欢迎的开源项目。</p>
<p>以下的内容是真实企业生产环境的项目搭建与配置，由于项目面向的人群比较特殊，因此系统的使用量不高，并发量也不大，所以没有采用比较复杂的设计。默认的配置也达到了压测的要求，所以没有对配置做过多的优化。</p>
<h2 data-id="heading-0">系统架构图</h2>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/fbcb0cde2f8244dc9b8a1cfa03abfe07~tplv-k3u1fbpfcp-watermark.image" alt="系統架構.png" loading="lazy" referrerpolicy="no-referrer">
上图是系统架构图，是互联网公司里最常见的系统架构。这类系统往往处理并发量不高，而且业务也不复杂，所以做集群（包括应用系统集群，Redis集群，MySQL主从）的作用仅是保障它的高可用。系统里面有使用到消息队列，但要求不高，我们就直接用了Redis里的list结构来实现。简单的事情用简单的方式处理即可，对于简单的要求就没必要使用专业的MQ（RocketMQ, RabbitMQ），要不然反而增加系统的复杂性。</p>
<h2 data-id="heading-1">总体请求流向图</h2>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1a77e8f24dcf47c1bf490ef5334aa620~tplv-k3u1fbpfcp-watermark.image" alt="请求流向图.png" loading="lazy" referrerpolicy="no-referrer">
因为阿里云跟客户有合作协议，所以服务器资源都是来自于阿里云。通过上面的请求流向图，读者们也可以大致了解整个系统的网络架构。</p>
<h2 data-id="heading-2">详细请求流向图</h2>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a4004ced04a9420198dc180ba1c2a4ad~tplv-k3u1fbpfcp-watermark.image" alt="详细请求流向图.png" loading="lazy" referrerpolicy="no-referrer">
上图中的大矩形框表示一台服务器，其中有若干矩形框代表同一台服务器里装了若干组件。所有的请求都是经由Nginx发出，包括用户浏览HTML/图片/其他静态资源，JS请求服务端，所以上图的Nginx有三个出度。这里使用Redis哨兵模式而没有使用集群模式，主要是考虑到本系统对Redis的使用仅是作为Session共享和消息队列（消息的数量比较少），总体的数据量非常少，就使用简单一些的哨兵模式。而没有考虑使用Redis Cluster模式，将数据分散到不同服务器上（通过slot）。Redis Cluster模式的其他资料读者可自行查询其他资料。</p>
<p>读者通过上面的3张图对系统框架有了大概的了解后，下面附上所有组件的搭建步骤，项目名为iurc。</p>
<h2 data-id="heading-3">组件部署搭建步骤与配置</h2>
<h3 data-id="heading-4">1. 服务器基础环境搭建</h3>
<h4 data-id="heading-5">1.1 所有服务器创建robin用户</h4>
<p>一共有9台服务器，假设IP为<code>10.210.111.12</code>-<code>10.210.111.20</code>。真实环境需要通过堡垒机登入，这里假设能直接登录服务器。</p>
<p>首先以root用户通过SSH工具登入服务器<code>10.210.111.12</code>，使用命令行创建<code>init_server.sh</code>脚本</p>
<pre><code class="hljs language-shell copyable" lang="shell">vim init_server.sh
<span class="hljs-meta">
#</span><span class="bash"> 创建robin用户</span>
adduser -m robin
<span class="hljs-meta">#</span><span class="bash"> 修改用户密码</span>
passwd robin
<span class="hljs-meta">#</span><span class="bash"> 安装telent</span>
yum -y install telnet
<span class="copy-code-btn">复制代码</span></code></pre>
<p>创建<code>send_all_servers.sh</code>脚本将<code>init_server.sh</code>脚本分发给所有服务器</p>
<pre><code class="hljs language-shell copyable" lang="shell">vim send_all_servers.sh
<span class="hljs-meta">
#</span><span class="bash"> 脚本中写入分发命令（此步骤的目的是节省创建用户的时间，但仍须登入每一台服务器执行该脚本）</span>
scp $1 root@10.210.111.13:/root/
scp $1 root@10.210.111.14:/root/
scp $1 root@10.210.111.15:/root/
scp $1 root@10.210.111.16:/root/
scp $1 root@10.210.111.17:/root/
scp $1 root@10.210.111.18:/root/
scp $1 root@10.210.111.19:/root/
scp $1 root@10.210.111.20:/root/
<span class="copy-code-btn">复制代码</span></code></pre>
<p>执行<code>send_all_servers.sh</code>脚本（暂未做免密登录，执行脚本后需要输入目标服务器密码）</p>
<pre><code class="hljs language-shell copyable" lang="shell">chmod +x ./send_all_servers.sh
bash ./send_all_servers.sh ./init_server.sh
<span class="copy-code-btn">复制代码</span></code></pre>
<p>在所有服务器执行<code>init_server.sh</code>脚本</p>
<pre><code class="hljs language-shell copyable" lang="shell">chmod +x ./init_server.sh
bash ./init_server.sh
<span class="copy-code-btn">复制代码</span></code></pre>
<h4 data-id="heading-6">1.2 所有服务器授权robin用户</h4>
<p>添加<code>sudoers</code>文件可寫權限</p>
<pre><code class="hljs language-shell copyable" lang="shell">chmod u+w /etc/sudoers
<span class="copy-code-btn">复制代码</span></code></pre>
<p>修改<code>sudoers</code>文件</p>
<pre><code class="hljs language-shell copyable" lang="shell">vim /etc/sudoers
<span class="copy-code-btn">复制代码</span></code></pre>
<p>在sudoers文件中找到如下图</p>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/913e4118b58342079cad8aeed3e66bac~tplv-k3u1fbpfcp-watermark.image" alt="image.png" loading="lazy" referrerpolicy="no-referrer"></p>
<p>在root行下方添加如下內容</p>
<pre><code class="hljs language-shell copyable" lang="shell">robin ALL=(ALL) ALL
<span class="copy-code-btn">复制代码</span></code></pre>
<p>收回<code>sudoers</code>文件可写权限</p>
<pre><code class="hljs language-shell copyable" lang="shell">chmod u-w /etc/sudoers
<span class="copy-code-btn">复制代码</span></code></pre>
<p>⚠️ 所有ECS都需要登入执行授权操作</p>
<h4 data-id="heading-7">1.3 修复服务器主机名</h4>
<p>修改<code>10.210.111.12</code>服务器主机名</p>
<pre><code class="hljs language-shell copyable" lang="shell">hostnamectl set-hostname nginx_01
reboot
<span class="copy-code-btn">复制代码</span></code></pre>
<p>建议以此修改方式，将所有主机名改为此服务器主要提供的服务，在后续方便运维。我设置的主机名如下：</p>























































<table><thead><tr><th>IP地址</th><th>系統</th><th>主机名</th></tr></thead><tbody><tr><td>10.210.111.12</td><td>CentOS7.x</td><td>nginx_01</td></tr><tr><td>10.210.111.13</td><td>CentOS7.x</td><td>nginx_02</td></tr><tr><td>10.210.111.14</td><td>CentOS7.x</td><td>redis_01</td></tr><tr><td>10.210.111.15</td><td>CentOS7.x</td><td>redis_02</td></tr><tr><td>10.210.111.16</td><td>CentOS7.x</td><td>redis_03</td></tr><tr><td>10.210.111.17</td><td>CentOS7.x</td><td>db_01</td></tr><tr><td>10.210.111.18</td><td>CentOS7.x</td><td>db_02</td></tr><tr><td>10.210.111.19</td><td>CentOS7.x</td><td>app_02</td></tr><tr><td>10.210.111.20</td><td>CentOS7.x</td><td>app_02</td></tr></tbody></table>
<h3 data-id="heading-8">2. Nginx安装及配置</h3>
<p>服务器配置</p>




















<table><thead><tr><th>IP地址</th><th>系统</th><th>功能</th></tr></thead><tbody><tr><td>10.210.111.12</td><td>CentOS7.x</td><td>Nginx</td></tr><tr><td>10.210.111.13</td><td>CentOS7.x</td><td>Nginx</td></tr></tbody></table>
<h4 data-id="heading-9">2.1 安装Nginx</h4>
<p>使用<strong>SSH工具</strong>以robin用戶登入服務器<strong>nginx_01</strong><code>10.210.111.12</code>，下載Nginx並解壓。</p>
<pre><code class="hljs language-shell copyable" lang="shell">cd /home/robin
wget http://nginx.org/download/nginx-1.20.1.tar.gz
tar -zxvf nginx-1.20.1.tar.gz && cd nginx-1.20.1
<span class="copy-code-btn">复制代码</span></code></pre>
<p>安装预编译环境</p>
<pre><code class="hljs language-shell copyable" lang="shell">sudo yum update
sudo yum -y install gcc pcre pcre-devel zlib zlib-devel openssl openssl-devel
<span class="copy-code-btn">复制代码</span></code></pre>
<p>编译安装用以下配置替換<code>/usr/local/nginx/conf/nginx.conf</code>裡的內容</p>
<pre><code class="hljs language-shell copyable" lang="shell">cd /home/robin/nginx-1.20.1
./configure --prefix=/usr/local/nginx
make
sudo make install
<span class="copy-code-btn">复制代码</span></code></pre>
<h4 data-id="heading-10">2.2 配置Nginx</h4>
<p>用以下配置替换<code>/usr/local/nginx/conf/nginx.conf</code>里的内容</p>
<pre><code class="hljs language-shell copyable" lang="shell">worker_processes  2;

events &#123;
    worker_connections  1024;
&#125;


http &#123;
    include       mime.types;
    default_type  application/octet-stream;

    sendfile        on;
    keepalive_timeout  65;

    server &#123;
        listen       80;
        server_name  localhost;
        
location @router&#123;
            rewrite ^.*$ /iurc/index.html break;
        &#125;

        location ^~/iurc &#123;
            root   /usr/local/nginx/html;
            try_files $uri $uri/ @router;
        &#125;

location ^~/iurc/api &#123;
            proxy_pass http://iurcProxy/iurc/api/channel/http.do;
            proxy_send_timeout 1800;
            proxy_read_timeout 1800;
            proxy_connect_timeout 1800;
            client_max_body_size 2048m;
            proxy_set_header  Host              $http_host;
            proxy_set_header  X-Real-IP   $remote_addr;
            proxy_set_header  X-Real-Port       $remote_port;
            proxy_set_header  X-Forwarded-For   $proxy_add_x_forwarded_for;
        &#125;

location @router_admin&#123;
            rewrite ^.*$ /iurc-admin/index.html break;
        &#125;

        location ^~/iurc-admin &#123;
            allow 192.168.10.0/24;
            allow 192.168.12.0/24;
            allow 192.168.30.0/24;
            allow 192.168.160.0/24;
            deny all;
            root   /usr/local/nginx/html;
            try_files $uri $uri/ @router_admin;
        &#125;

        location ^~/iurc-admin/api &#123;
            allow 192.168.10.0/24;
            allow 192.168.12.0/24;
            allow 192.168.30.0/24;
            allow 192.168.160.0/24;
            deny all;
            proxy_pass http://iurcAdminProxy/iurc/admin/api/channel/http.do;
            proxy_send_timeout 1800;
            proxy_read_timeout 1800;
            proxy_connect_timeout 1800;
            client_max_body_size 2048m;
            proxy_set_header  Host              $http_host;
            proxy_set_header  X-Real-IP   $remote_addr;
            proxy_set_header  X-Real-Port       $remote_port;
            proxy_set_header  X-Forwarded-For   $proxy_add_x_forwarded_for;
        &#125;

        location = /50x.html &#123;
            root   html;
        &#125;

    &#125;

    upstream iurcProxy &#123;
        server 10.210.111.19:30068;
        server 10.210.111.20:30068;
    &#125;
    
    upstream iurcAdminProxy &#123;
        server 10.210.111.19:30070;
        server 10.210.111.20:30070;
    &#125;
&#125;
<span class="copy-code-btn">复制代码</span></code></pre>
<h4 data-id="heading-11">2.3 启动Nginx</h4>
<pre><code class="hljs language-shell copyable" lang="shell">sudo /usr/local/nginx/sbin/nginx
<span class="copy-code-btn">复制代码</span></code></pre>
<p>⚠️ 在<strong>nginx_02</strong><code>10.210.111.13</code>服务器上按照步骤2.1 - 2.3安装配置Nginx</p>
<h4 data-id="heading-12">2.4 创建HTML存放目录</h4>
<pre><code class="hljs language-shell copyable" lang="shell">sudo mkdir /usr/local/nginx/html/iurc
sudo mkdir /usr/local/nginx/html/iurc-admin
<span class="copy-code-btn">复制代码</span></code></pre>
<p>若修改了<code>/usr/local/nginx/conf/nginx.conf</code>里的内容，可用如下命令重新启动Nginx，使新配置生效。</p>
<pre><code class="hljs language-shell copyable" lang="shell">sudo /usr/local/nginx/sbin/nginx -s reload
<span class="copy-code-btn">复制代码</span></code></pre>
<h3 data-id="heading-13">3. Redis集群安装及配置（哨兵模式）</h3>
<p>服务器配置</p>

























<table><thead><tr><th>IP地址</th><th>系统</th><th>功能</th></tr></thead><tbody><tr><td>10.210.111.14</td><td>CentOS7.x</td><td>Redis, 哨兵</td></tr><tr><td>10.210.111.15</td><td>CentOS7.x</td><td>Redis, 哨兵</td></tr><tr><td>10.210.111.16</td><td>CentOS7.x</td><td>Redis, 哨兵</td></tr></tbody></table>
<h4 data-id="heading-14">3.1 安装Redis</h4>
<p>以robin用户登入服务器<strong>redis_01</strong><code>10.210.111.14</code>，下载Redis并解压。</p>
<pre><code class="hljs language-shell copyable" lang="shell">cd /home/robin
wget https://download.redis.io/releases/redis-5.0.9.tar.gz
tar -zxvf redis-5.0.9.tar.gz && cd redis-5.0.9
<span class="copy-code-btn">复制代码</span></code></pre>
<p>安装预编译环境及安装</p>
<pre><code class="hljs language-shell copyable" lang="shell">sudo yum update
sudo yum -y install gcc
make
sudo make install PREFIX=/usr/local/redis
<span class="copy-code-btn">复制代码</span></code></pre>
<p>⚠️ 在<strong>redis_02</strong><code>10.210.111.15</code>服务器上按照步骤3.1安装配置Redis</p>
<p>⚠️ 在<strong>redis_03</strong><code>10.210.111.16</code>服务器上按照步骤3.1安装配置Redis</p>
<h4 data-id="heading-15">3.2 配置Redis</h4>
<p>在<code>10.210.111.14</code>中，从redis源码目录中复制redis.conf至redis的安装目录</p>
<pre><code class="copyable">sudo cp /home/robin/redis-5.0.9/redis.conf /usr/local/redis/bin/ && cd /usr/local/redis/bin/
<span class="copy-code-btn">复制代码</span></code></pre>
<p>在<code>10.210.111.14</code>中，修改redis.conf文件：</p>
<pre><code class="copyable">sudo vim redis.conf
<span class="copy-code-btn">复制代码</span></code></pre>
<p>将<code>daemonize no</code>改为<code>daemonize yes</code></p>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/448b5af582314f7c85a03853f7a8dfb8~tplv-k3u1fbpfcp-watermark.image" alt="image.png" loading="lazy" referrerpolicy="no-referrer"></p>
<p>把默认的回环地址注释掉，默认不能被其他机器访问</p>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/79354b7c261b44d289622afa382710a6~tplv-k3u1fbpfcp-watermark.image" alt="image.png" loading="lazy" referrerpolicy="no-referrer"></p>
<p>关闭保护模式，由<code>yes</code>改为<code>no</code></p>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ccd1537f9af7417082cf888466414e2e~tplv-k3u1fbpfcp-watermark.image" alt="image.png" loading="lazy" referrerpolicy="no-referrer"></p>
<p>将在<code>10.210.111.14</code>中修改完成的redis.conf文件分发到<code>10.210.111.15</code>及<code>10.210.111.16</code>中</p>
<pre><code class="hljs language-shell copyable" lang="shell">scp /usr/local/redis/bin/redis.conf root@10.210.111.15:/usr/local/redis/bin/
<span class="hljs-meta">#</span><span class="bash"> 此处会要求输入10.210.111.15的root密码</span>

scp /usr/local/redis/bin/redis.conf root@10.210.111.16:/usr/local/redis/bin/
<span class="hljs-meta">#</span><span class="bash"> 此处会要求输入10.210.111.16的root密码</span>
<span class="copy-code-btn">复制代码</span></code></pre>
<p>在<code>10.210.111.15</code>中，编辑redis.conf</p>
<pre><code class="hljs language-shell copyable" lang="shell">sudo vim /usr/local/redis/bin/redis.conf
<span class="hljs-meta">#</span><span class="bash">在最后一行加入如下内容</span>
replicaof 10.210.111.14 6379
<span class="copy-code-btn">复制代码</span></code></pre>
<p>在<code>10.210.111.16</code>中，编辑redis.conf</p>
<pre><code class="hljs language-shell copyable" lang="shell">sudo vim /usr/local/redis/bin/redis.conf
<span class="hljs-meta">#</span><span class="bash">在最后一行加入如下内容</span>
replicaof 10.210.111.14 6379
<span class="copy-code-btn">复制代码</span></code></pre>
<h4 data-id="heading-16">3.3 配置Redis Sentinel</h4>
<p>在<code>10.210.111.14</code>中，安装redis-sentinel</p>
<pre><code class="hljs language-shell copyable" lang="shell">sudo mkdir -p /usr/local/redis-sentinel
sudo cp -r /usr/local/redis/* /usr/local/redis-sentinel
<span class="copy-code-btn">复制代码</span></code></pre>
<p>在<code>10.210.111.14</code>中，复制sentinel.conf</p>
<pre><code class="hljs language-shell copyable" lang="shell">sudo cp /home/robin/redis-5.0.9/sentinel.conf /usr/local/redis-sentinel/bin
<span class="copy-code-btn">复制代码</span></code></pre>
<p>在<code>10.210.111.14</code>中，修改sentinel.conf</p>
<pre><code class="hljs language-shell copyable" lang="shell">sudo vim /usr/local/redis-sentinel/sentinel.conf
<span class="hljs-meta">
#</span><span class="bash">将daemonize由no改为yes</span>
daemonize yes
<span class="hljs-meta">#</span><span class="bash">指定多少毫秒后，主节点没有应答sentinel。此时，sentinel主观上认为主节点下线，默认30000毫秒，改为3000毫秒</span>
sentinel down-after-milliseconds mymaster 3000
<span class="copy-code-btn">复制代码</span></code></pre>
<p>将<code>10.210.111.14</code>的sentinel复制到<code>10.210.111.15</code>和<code>10.210.111.16</code>中</p>
<pre><code class="copyable">scp -r /usr/local/redis-sentinel/ root@10.210.111.15:/usr/local
scp -r /usr/local/redis-sentinel/ root@10.210.111.16:/usr/local
<span class="copy-code-btn">复制代码</span></code></pre>
<p>在<code>10.210.111.15</code>中，修改redis.conf文件</p>
<pre><code class="hljs language-shell copyable" lang="shell">vim /usr/local/redis-sentinel/bin/sentinel.conf
<span class="hljs-meta">
#</span><span class="bash"> 将sentinel监控的redis主节点ip改为10.210.111.14</span>
sentinel monitor mymaster 10.210.111.14 6379 2
<span class="copy-code-btn">复制代码</span></code></pre>
<p>在<code>10.210.111.16</code>中，修改redis.conf文件</p>
<pre><code class="hljs language-shell copyable" lang="shell">sudo vim /usr/local/redis-sentinel/bin/sentinel.conf
<span class="hljs-meta">
#</span><span class="bash"> 将sentinel监控的redis主节点ip改为10.210.111.14</span>
sentinel monitor mymaster 10.210.111.14 6379 2
<span class="copy-code-btn">复制代码</span></code></pre>
<h4 data-id="heading-17">3.4 设置开机启动Redis及Redis Sentinel</h4>
<p>在<code>10.210.111.14</code>中，<strong>添加Redis开机启动服务</strong></p>
<pre><code class="hljs language-shell copyable" lang="shell">sudo vim /etc/systemd/system/redis.service
<span class="hljs-meta">
#</span><span class="bash"> 复制粘贴以下内容</span>
[Unit]
Description=redis-server
After=network.target

[Service]
Type=forking
ExecStart=/usr/local/redis/bin/redis-server /usr/local/redis/bin/redis.conf
PrivateTmp=true

[Install]
WantedBy=multi-user.target
<span class="copy-code-btn">复制代码</span></code></pre>
<p>在<code>10.210.111.14</code>中，<strong>添加Redis Sentinel开机启动服务</strong></p>
<pre><code class="hljs language-shell copyable" lang="shell">sudo vim /etc/systemd/system/redis-sentinel.service

[Unit]
Description=redis-sentinel
After=network.target
<span class="hljs-meta">
#</span><span class="bash"> 复制粘贴以下内容</span>
[Service]
Type=forking
ExecStart=/usr/local/redis-sentinel/bin/redis-sentinel /usr/local/redis-sentinel/bin/sentinel.conf
PrivateTmp=true

[Install]
WantedBy=multi-user.target
<span class="copy-code-btn">复制代码</span></code></pre>
<p>配置解释如下</p>
<pre><code class="hljs language-shell copyable" lang="shell"><span class="hljs-meta">#</span><span class="bash"> [Unit]: 服务单元</span>
<span class="hljs-meta">#</span><span class="bash"> Description: 描述服务</span>
<span class="hljs-meta">#</span><span class="bash"> After: 描述服务的类别</span>
<span class="hljs-meta">
#</span><span class="bash"> [Serivce]: 服务运行参数的设置</span>
<span class="hljs-meta">#</span><span class="bash"> Type=forking: 是后台运行的形式</span>
<span class="hljs-meta">#</span><span class="bash"> ExecStart: 服务的具体运行命令</span>
<span class="hljs-meta">#</span><span class="bash"> ExecReload: 服务的重启命令</span>
<span class="hljs-meta">#</span><span class="bash"> ExecStop: 服务的停止命令</span>
<span class="hljs-meta">#</span><span class="bash"> PrivateTmp=True: 表示给服务分配独立的临时空间</span>
<span class="hljs-meta">#</span><span class="bash"> ⚠️ 注意：[Service]的启动、重启、停止命令全部要求使用绝对路径</span>
<span class="hljs-meta">
#</span><span class="bash"> [Install]: 运行级别下服务安装的相关设置，可设置为多用户，即系统运行级别为3</span>
<span class="copy-code-btn">复制代码</span></code></pre>
<p>⚠️ 在<code>10.210.111.15</code>和<code>10.210.111.16</code>中重复以上表示<strong>添加Redis开机启动服务</strong>和<strong>添加Redis Sentinel开机启动服务</strong>步骤。</p>
<h4 data-id="heading-18">3.5 启动Redis及Redis Sentinel</h4>
<p>在<code>10.210.111.14</code>中，<strong>启动redis并加入开机自启动</strong></p>
<pre><code class="hljs language-shell copyable" lang="shell">sudo systemctl daemon-reload
sudo systemctl start redis.service 
sudo systemctl enable redis.service
<span class="copy-code-btn">复制代码</span></code></pre>
<p>在<code>10.210.111.14</code>中，<strong>启动Redis sentinel并加入开机自启动</strong></p>
<pre><code class="hljs language-shell copyable" lang="shell">sudo systemctl start redis-sentinel.service 
sudo systemctl enable redis-sentinel.service
<span class="copy-code-btn">复制代码</span></code></pre>
<p>⚠️ 在<code>10.210.111.15</code>和<code>10.210.111.16</code>中重复以上表示<strong>启动redis并加入开机自启动</strong>和<strong>启动Redis sentinel并加入开机自启动</strong>步骤。</p>
<h4 data-id="heading-19">3.6 测试</h4>
<p>在主Redis<code>10.210.111.14</code>进入redis控制台</p>
<pre><code class="hljs language-shell copyable" lang="shell">sudo /usr/local/redis/bin/redis-cli
<span class="copy-code-btn">复制代码</span></code></pre>
<p>输入命令</p>
<pre><code class="hljs language-shell copyable" lang="shell">info
<span class="copy-code-btn">复制代码</span></code></pre>
<p>若出现下图结果，连接了2个slaves则表示Redis主从（哨兵模式）安装成功</p>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d2a69a459e074a629cd0d2302113e6bd~tplv-k3u1fbpfcp-watermark.image" alt="image.png" loading="lazy" referrerpolicy="no-referrer">
⚠️ 输入info命令出来的结果由于网络或者同步状态的情况，<code>connected_slaves</code>不一定实时为2，可以多查看几次。</p>
<h3 data-id="heading-20">4. MySQL安装及配置（主从模式）</h3>
<p>服务器配置</p>




















<table><thead><tr><th>IP地址</th><th>系统</th><th>功能</th></tr></thead><tbody><tr><td>10.210.111.17</td><td>CentOS7.x</td><td>主數據庫</td></tr><tr><td>10.210.111.18</td><td>CentOS7.x</td><td>從數據庫</td></tr></tbody></table>
<h4 data-id="heading-21">4.1 安装MySQL</h4>
<p>以robin用户登入服务器<strong>db_01</strong><code>10.210.111.17</code>，通过YUM源方式安装MySQL。</p>
<p>下面链接很详细的官网安装步骤，读者照里面这个步骤安装MySQL即可</p>
<blockquote>
<p><a href="https://link.juejin.cn/?target=https%3A%2F%2Fdev.mysql.com%2Fdoc%2Frefman%2F5.7%2Fen%2Flinux-installation-yum-repo.html" target="_blank" rel="nofollow noopener noreferrer" title="https://dev.mysql.com/doc/refman/5.7/en/linux-installation-yum-repo.html" ref="nofollow noopener noreferrer">dev.mysql.com/doc/refman/…</a></p>
</blockquote>
<h4 data-id="heading-22">4.2 设置MySQL远程连接</h4>
<p>设置MySQL只能两个APP SERVER<code>10.210.111.19</code>和<code>10.210.111.20</code>连接</p>
<pre><code class="hljs language-shell copyable" lang="shell"><span class="hljs-meta">#</span><span class="bash"> 在MYSQL命令行中输入以下命令</span>
GRANT ALL PRIVILEGES ON *.* TO 'root'@'10.210.111.19' IDENTIFIED BY 'P@ssw0rd' WITH GRANT OPTION; 
GRANT ALL PRIVILEGES ON *.* TO 'root'@'10.210.111.20' IDENTIFIED BY 'P@ssw0rd' WITH GRANT OPTION;
GRANT ALL PRIVILEGES ON *.* TO 'root'@'10.210.111.14' IDENTIFIED BY 'P@ssw0rd' WITH GRANT OPTION; 
GRANT ALL PRIVILEGES ON *.* TO 'root'@'10.210.111.15' IDENTIFIED BY 'P@ssw0rd' WITH GRANT OPTION;
FLUSH PRIVILEGES; 
<span class="copy-code-btn">复制代码</span></code></pre>
<p>⚠️ 至此已完成<code>10.210.111.17</code>的MySQL安装，请登录<code>10.210.111.18</code>参考<strong>步骤[4.1 - 4.2]</strong> 在<code>10.210.111.18</code>上安装MySQL。</p>
<h4 data-id="heading-23">4.3 设置主从同步</h4>
<p>⚠️ 将<code>10.210.111.17</code>设置为主数据库，将<code>10.210.111.18</code>设置为从数据库</p>
<pre><code class="hljs language-shell copyable" lang="shell">mysql -uroot -p
<span class="hljs-meta">#</span><span class="bash"> 輸入密碼</span>
CREATE USER 'slave'@'%' IDENTIFIED BY 'slaveP@ssw0rd';
GRANT ALL PRIVILEGES ON *.* TO 'slave'@"%" IDENTIFIED BY "slaveP@ssw0rd";
<span class="copy-code-btn">复制代码</span></code></pre>
<p>修改<code>10.210.111.17</code>的my.cnf配置文件</p>
<pre><code class="hljs language-shell copyable" lang="shell">sudo vim /etc/my.cnf
<span class="hljs-meta">#</span><span class="bash"> 加入两行内容</span>
log-bin=mysql-bin
server-id=1
<span class="copy-code-btn">复制代码</span></code></pre>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e64c6106dbdd428397660a636320b067~tplv-k3u1fbpfcp-watermark.image" alt="image.png" loading="lazy" referrerpolicy="no-referrer"></p>
<p>说明</p>
<pre><code class="hljs language-shell copyable" lang="shell"><span class="hljs-meta">#</span><span class="bash"> 开启二进制日志，该日志是在事务提交时写日志文件的。默认大小是1G，后面加001,002这样的后缀顺加。</span>
log-bin=mysql-bin
<span class="hljs-meta">
#</span><span class="bash"> 唯一标识主机，mysql主从每个mysql实例配置都不一样就行。这个值默认是0，如果是0，主服务器拒绝任何从服务器的连接。</span>
server-id=1
<span class="hljs-meta">
#</span><span class="bash"> 其他配置（不是必须配置的）：</span>
<span class="hljs-meta">
#</span><span class="bash"> 指定mysql的binlog日志记录哪个db，配置需要同步的数据库，可以配置多个，如果没有此配置项则同步全部。</span>
binlog-do-db=db_001（主数据库配置）
<span class="hljs-meta">
#</span><span class="bash"> 配置不同步的数据库，可以配置多个。</span>
binlog-ignore-db=mysql（主数据库配置）
<span class="hljs-meta">
#</span><span class="bash"> 配置binlog的格式</span>
binlog_format=mixed
<span class="hljs-meta">
#</span><span class="bash"> 配置是否只读  0代表不只读，1代表只读</span>
read-only=0
<span class="hljs-meta">
#</span><span class="bash"> 用于设定双主情况下自增列的ID冲突使用的，主要用来设置自增步长</span>
auto-increament-increment=10
<span class="hljs-meta">
#</span><span class="bash"> 表示这台服务器的序号，从1开始，不超过auto-increament-increment</span>
auto-increment-offset=1
<span class="copy-code-btn">复制代码</span></code></pre>
<p>重启<code>10.210.111.17</code>的MySQL</p>
<pre><code class="hljs language-shell copyable" lang="shell">sudo systemctl restart mysqld
<span class="copy-code-btn">复制代码</span></code></pre>
<p>修改<code>10.210.111.18</code>的my.cnf配置文件</p>
<pre><code class="hljs language-shell copyable" lang="shell">sudo vim /etc/my.cnf
<span class="hljs-meta">#</span><span class="bash"> 加入两行内容</span>
server-id=2
relay_log=mysql-relay-bin
<span class="copy-code-btn">复制代码</span></code></pre>
<p>重启<code>10.210.111.18</code>的MySQL</p>
<pre><code class="hljs language-shell copyable" lang="shell">systemctl restart mysqld.service
<span class="copy-code-btn">复制代码</span></code></pre>
<p>获取 <code>10.210.111.17</code>MySQL的binlog信息</p>
<pre><code class="hljs language-shell copyable" lang="shell">mysql -uroot -p
<span class="hljs-meta">#</span><span class="bash"> 输入密码</span>
show master status;
<span class="copy-code-btn">复制代码</span></code></pre>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/06b99bff95224cb7a51afa18ac1bdad3~tplv-k3u1fbpfcp-watermark.image" alt="image.png" loading="lazy" referrerpolicy="no-referrer"></p>
<p>进入<code>10.210.111.18</code>的MySQL设置与主库同步</p>
<pre><code class="hljs language-shell copyable" lang="shell">mysql -uroot -p
<span class="hljs-meta">#</span><span class="bash"> 输入密码</span>
change master to master_host='10.210.111.17',master_user='slave',master_password='slaveP@ssw0rd',master_log_file='mysql-bin.000001', master_log_pos=154;
<span class="copy-code-btn">复制代码</span></code></pre>
<p>⚠️ 注意以下说明</p>
<pre><code class="hljs language-shell copyable" lang="shell">master_user和master_password是上面步骤中在主服务器上创建的用户名“slave”及其密码

master_log_file是在主服务器上查询出来的“MySQL binlog信息”中的File字段值。如上图中的mysql-bin.000001

master_log_pos是在主服务器上查询出来的“MySQL binlog信息”中的Position字段值。如上图中的154
<span class="copy-code-btn">复制代码</span></code></pre>
<p>开启<code>10.210.111.18</code>的从MySQL slave线程</p>
<pre><code class="copyable">start slave;
<span class="copy-code-btn">复制代码</span></code></pre>
<p>查看<code>10.210.111.18</code>的从MySQL slave状态</p>
<pre><code class="copyable">show slave status \G
<span class="copy-code-btn">复制代码</span></code></pre>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ccea649225364970a7368b5153ae7ed2~tplv-k3u1fbpfcp-watermark.image" alt="image.png" loading="lazy" referrerpolicy="no-referrer">
看到红框中两个Yes，就代表从从服务器已经成功从主服务器同步数据。</p>
<h4 data-id="heading-24">4.4 主从验证</h4>
<p>在<code>10.210.111.17</code>主MySQL執行建庫建表操作，驗證主從模式部署成功</p>
<pre><code class="copyable">mysql -uroot -p
# 输入密码
create database test;
use test;
create table user_test( id int comment'ID',name VARCHAR(20) comment'名称', create_time timestamp DEFAULT now() comment'创建时间' );
insert INTO user_test value(1,"A",NOW());
<span class="copy-code-btn">复制代码</span></code></pre>
<p>在<code>10.210.111.18</code>从MySQL查看是否有在主MySQL创建的表和数据</p>
<pre><code class="copyable">mysql -uroot -p
# 输入密码
show databases;
use test;
show tables;
select * from user_test;
<span class="copy-code-btn">复制代码</span></code></pre>
<p>从结果可以看出，数据已经从主MySQL同步至从MySQL，证明主从模式已经部署成功。接下来在<code>10.210.111.17</code>主MySQL删除测试数据即可。</p>
<pre><code class="copyable">drop database test;
<span class="copy-code-btn">复制代码</span></code></pre>
<h3 data-id="heading-25">5.静态资源同步安装</h3>
<p>这部分的内容仅供参考，因为现在看回这个设计其实是有些问题的。当初想通过Nginx做动静分离，静态文件直接通过Nginx访问，文件备份通过“静态资源同步服务”。对于公开的静态资源当然没问题，但是如果用户上传的静态资源是不能公开的，这里就存在了很大的风险，攻击者很可能通过Nginx直接下载用户的隐私资料。</p>
<p>综上所述得出两条建议：</p>
<ul>
<li>对于隐私文件，有条件的话可以使用OSS服务。如果无条件可参考如下的静态资源同步服务，我认为除了我下面的服务外，应该还会有更好的选择，读者可以自行查找；</li>
<li>对于可公开的静态资源可以采用动静分离方案，通过Nginx直接获取。对于隐私文件，切记不可通过配置Nginx直接。</li>
</ul>
<p>服务器配置</p>




















<table><thead><tr><th>IP地址</th><th>系统</th><th>功能</th></tr></thead><tbody><tr><td>10.210.111.13</td><td>CentOS7.x</td><td>rsync服務端</td></tr><tr><td>10.210.111.12</td><td>CentOS7.x</td><td>rsync客戶端</td></tr></tbody></table>
<h4 data-id="heading-26">5.1 rsync服務端</h4>
<p>在<code>10.210.111.13</code>安裝rsync</p>
<pre><code class="hljs language-shell copyable" lang="shell">cd /opt
sudo yum install -y rsync
<span class="copy-code-btn">复制代码</span></code></pre>
<p>配置/etc/rsyncd.conf</p>
<pre><code class="hljs language-shell copyable" lang="shell"><span class="hljs-meta">#</span><span class="bash"> 纪录传输文件日志</span>
transfer logging = yes
<span class="hljs-meta">#</span><span class="bash"> 指定日志文件</span>
log file = /var/log/rsyncd.log
<span class="hljs-meta">#</span><span class="bash"> pid文件路径</span>
pid file = /var/run/rsyncd.pid
<span class="hljs-meta">#</span><span class="bash"> 锁路径</span>
lock file = /var/run/rsync.lock
<span class="hljs-meta">#</span><span class="bash"> 运行rsync守护进程的用户</span>
uid = robin
<span class="hljs-meta">#</span><span class="bash"> 运行rsync守护进程的组</span>
gid = robin
<span class="hljs-meta">#</span><span class="bash"> 是否允许chroot，用于提升安全性。客户端连接模块，首先chroot到模块path参数指定的目录下，chroot为yes是必须使用root权限，且不能备份path路径外的连接文件</span>
use chroot = yes
<span class="hljs-meta">#</span><span class="bash"> 忽略错误</span>
ignore errors
<span class="hljs-meta">#</span><span class="bash"> 只读</span>
read only = no
<span class="hljs-meta">#</span><span class="bash"> 设置超时时间，单位秒</span>
timeout = 60
ignore nonreadable = yes
<span class="hljs-meta">
#</span><span class="bash"> 模块，可配置多个</span>
[sync_file]
<span class="hljs-meta">#</span><span class="bash"> 模块的根目录，同步目录，需要注意权限</span>
path = /home/robin/static
<span class="hljs-meta">#</span><span class="bash"> 模块认证的用户名称，可使用空格或逗号隔开多个用户名</span>
auth users = sync
<span class="hljs-meta">#</span><span class="bash"> 模块验证密码文件，可放在全局配置里</span>
secrets file = /etc/rsyncd.secrets
<span class="hljs-meta">#</span><span class="bash"> 设定白名单，可指定IP段（172.18.50.1/255.255.255.0），各IP段用空格分开</span>
hosts allow = 10.210.111.12
hosts deny = *
<span class="hljs-meta">#</span><span class="bash"> 是否允许列出模块内容</span>
list = no
<span class="copy-code-btn">复制代码</span></code></pre>
<p>新建/etc/rsyncd.secrets，此处用robin用户作为使用同步服务的用户</p>
<pre><code class="hljs language-shell copyable" lang="shell"><span class="hljs-meta">#</span><span class="bash"> 需要使用root角色执行<span class="hljs-built_in">echo</span> <span class="hljs-string">"robin:infoP@ssw0rd"</span> > /etc/rsyncd.secrets</span>
sudo -i
<span class="hljs-meta">#</span><span class="bash">输入密码使用root</span>
echo "sync:123456" > /etc/rsyncd.secrets
<span class="hljs-meta">#</span><span class="bash">再转回使用普通用户</span>
su robin
<span class="copy-code-btn">复制代码</span></code></pre>
<p>设置文件权限</p>
<pre><code class="hljs language-shell copyable" lang="shell">sudo chmod 600 /etc/rsyncd.secrets
<span class="copy-code-btn">复制代码</span></code></pre>
<p>启动服务</p>
<pre><code class="hljs language-shell copyable" lang="shell">sudo systemctl restart rsyncd
<span class="copy-code-btn">复制代码</span></code></pre>
<h4 data-id="heading-27">5.2 rsync客戶端</h4>
<p>在<code>10.210.111.12</code>安裝rsync</p>
<pre><code class="hljs language-shell copyable" lang="shell">cd /opt
sudo yum install -y rsync
<span class="copy-code-btn">复制代码</span></code></pre>
<p>新建/etc/rsync.passwd，內容如下：</p>
<pre><code class="hljs language-shell copyable" lang="shell"><span class="hljs-meta">#</span><span class="bash"> 需要使用root角色执行<span class="hljs-built_in">echo</span> <span class="hljs-string">"infoP@ssw0rd"</span> > /etc/rsync.passwd</span>
sudo -i
<span class="hljs-meta">#</span><span class="bash">输入密码使用root</span>
echo "123456" > /etc/rsync.passwd
<span class="hljs-meta">#</span><span class="bash">再转回使用普通用户</span>
su robin
<span class="copy-code-btn">复制代码</span></code></pre>
<p>⚠️ 客户端rsync只需要密码，此处密码填写robin用户的密码</p>
<p>更改权限</p>
<pre><code class="hljs language-shell copyable" lang="shell">sudo chmod 600 /etc/rsync.passwd
<span class="copy-code-btn">复制代码</span></code></pre>
<p>安裝inotify</p>
<blockquote>
<p>inotify-tools工具检测文件增加、删除、修改。</p>
</blockquote>
<pre><code class="hljs language-shell copyable" lang="shell">sudo yum install -y inotify-tools
<span class="copy-code-btn">复制代码</span></code></pre>
<p>编写启动脚本inotify_start.sh</p>
<pre><code class="hljs language-shell copyable" lang="shell">cd /home/robin
<span class="copy-code-btn">复制代码</span></code></pre>
<p>脚本内容如下：</p>
<pre><code class="hljs language-shell copyable" lang="shell"><span class="hljs-meta">#</span><span class="bash">!/bin/bash</span>

Path=/home/robin/static
<span class="hljs-meta">#</span><span class="bash"> 此處host填rsync服務器的IP</span>
Server=10.210.111.13
User=sync
module=sync_file

/usr/bin/inotifywait -mrq --format '%w%f' -e create,close_write,delete $Path  | while read line  
do
    if [ -f $line ];then
        rsync -az $line --delete $&#123;User&#125;@$&#123;Server&#125;::$&#123;module&#125; --password-file=/etc/rsync.passwd
    else
        cd $Path &&\
        rsync -az ./ --delete $&#123;User&#125;@$&#123;Server&#125;::$&#123;module&#125; --password-file=/etc/rsync.passwd
    fi
done
<span class="copy-code-btn">复制代码</span></code></pre>
<p>测试命令</p>
<pre><code class="hljs language-shell copyable" lang="shell">sudo rsync -avz --delete /home/robin/static/ sync@10.210.111.13::sync_file --password-file=/etc/rsync.passwd
<span class="copy-code-btn">复制代码</span></code></pre>
<h4 data-id="heading-28">5.3 編寫服務自啟動腳本</h4>
<p>编写inotifyd.service并将其拷贝到/usr/lib/systemd/system/目录下，内容如下</p>
<pre><code class="hljs language-shell copyable" lang="shell">[Unit]
Description=inotify rsync script
After=network.target
After=network-online.target
Wants=network-online.target

[Service]
Type=simple
User=root
Group=root
PIDFile=/var/run/inotify.pid
ExecStart=/usr/bin/nohup /home/robin/inotify_start.sh > /home/robin/inotify.log 2>&1 &
ExecReload=
ExecStop=/usr/bin/ps -ef | /usr/bin/grep inotify | /usr/bin/grep -v grep | /usr/bin/awk '&#123;print $2&#125;' | /usr/bin/xargs /usr/bin/kill -9
PrivateTmp=true

[Install]
WantedBy=multi-user.target
<span class="copy-code-btn">复制代码</span></code></pre>
<p>启动服务</p>
<pre><code class="hljs language-shell copyable" lang="shell">sudo systemctl start inotifyd.service
<span class="copy-code-btn">复制代码</span></code></pre>
<p>允许自动启动</p>
<pre><code class="hljs language-shell copyable" lang="shell">sudo systemctl enable inotifyd.service
<span class="copy-code-btn">复制代码</span></code></pre>
<p>重新读取重启脚本</p>
<pre><code class="hljs language-shell copyable" lang="shell">sudo systemctl daemon-reload
<span class="copy-code-btn">复制代码</span></code></pre></div>  
</div>
            