
---
title: '数仓系统 4次升级，过程中的一些思考。'
categories: 
 - 编程
 - 掘金
 - 标签
headimg: 'https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b30320379af24ba5a4737aa4c7899fbd~tplv-k3u1fbpfcp-watermark.image'
author: 掘金
comments: false
date: Sat, 10 Jul 2021 15:20:35 GMT
thumbnail: 'https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b30320379af24ba5a4737aa4c7899fbd~tplv-k3u1fbpfcp-watermark.image'
---

<div>   
<div class="markdown-body"><style>.markdown-body&#123;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333&#125;.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6&#123;line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px&#125;.markdown-body h1&#123;font-size:30px;margin-bottom:5px&#125;.markdown-body h2&#123;padding-bottom:12px;font-size:24px;border-bottom:1px solid #ececec&#125;.markdown-body h3&#123;font-size:18px;padding-bottom:0&#125;.markdown-body h4&#123;font-size:16px&#125;.markdown-body h5&#123;font-size:15px&#125;.markdown-body h6&#123;margin-top:5px&#125;.markdown-body p&#123;line-height:inherit;margin-top:22px;margin-bottom:22px&#125;.markdown-body img&#123;max-width:100%&#125;.markdown-body hr&#123;border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px&#125;.markdown-body code&#123;word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em&#125;.markdown-body code,.markdown-body pre&#123;font-family:Menlo,Monaco,Consolas,Courier New,monospace&#125;.markdown-body pre&#123;overflow:auto;position:relative;line-height:1.75&#125;.markdown-body pre>code&#123;font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8&#125;.markdown-body a&#123;text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff&#125;.markdown-body a:active,.markdown-body a:hover&#123;color:#275b8c&#125;.markdown-body table&#123;display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6&#125;.markdown-body thead&#123;background:#f6f6f6;color:#000;text-align:left&#125;.markdown-body tr:nth-child(2n)&#123;background-color:#fcfcfc&#125;.markdown-body td,.markdown-body th&#123;padding:12px 7px;line-height:24px&#125;.markdown-body td&#123;min-width:120px&#125;.markdown-body blockquote&#123;color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8&#125;.markdown-body blockquote:after&#123;display:block;content:""&#125;.markdown-body blockquote>p&#123;margin:10px 0&#125;.markdown-body ol,.markdown-body ul&#123;padding-left:28px&#125;.markdown-body ol li,.markdown-body ul li&#123;margin-bottom:0;list-style:inherit&#125;.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item&#123;list-style:none&#125;.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul&#123;margin-top:0&#125;.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul&#123;margin-top:3px&#125;.markdown-body ol li&#123;padding-left:6px&#125;.markdown-body .contains-task-list&#123;padding-left:0&#125;.markdown-body .task-list-item&#123;list-style:none&#125;@media (max-width:720px)&#123;.markdown-body h1&#123;font-size:24px&#125;.markdown-body h2&#123;font-size:20px&#125;.markdown-body h3&#123;font-size:18px&#125;&#125;</style><p>「本文已参与好文召集令活动，点击查看：<a href="https://juejin.cn/post/6978685539985653767" target="_blank" title="https://juejin.cn/post/6978685539985653767">后端、大前端双赛道投稿，2万元奖池等你挑战！</a>」</p>
<h1 data-id="heading-0">1：项目背景</h1>
<p>bi系统往往决定一家公司的日常决策，所以必须要够灵活、底层数据通用、指标体系归一、能快速接入相关指标体系至关重要。过程中不断的与产品、业务不断的沟通升级。从渠道分析、会员、核心数据、埋点体系验证、人群画像、自定义报表、漏斗、全平台数据打通、推荐系统ab/test，打磨出一套BI雏形。</p>
<h1 data-id="heading-1">2：数仓系统的衍变</h1>
<p>我们的数仓系统经过了4次大版本衍变，详细如下：</p>

























<table><thead><tr><th>数仓版本</th><th>相关的技术方案</th></tr></thead><tbody><tr><td>1.0</td><td>azkaban定制执行离线脚本(hive -f 执行脚本)，ads层建立es外表。bi系统仅支持离线数据。</td></tr><tr><td>2.0</td><td>迁移离线脚本到db，建立ods,dwd,dim,mid,dws ads层，通过spark sql 执行job。ads层的数据同步到es。</td></tr><tr><td>3.0</td><td>建立主题、指标，dws层的数据接入kylin 。通过指标完成底层的数据指标复用，降低指标入口来源维护，实时数据分析引入clickhouse。</td></tr><tr><td>4.0</td><td>维护所有的主题，字典，指标，组件，可视化（多组件整合），cube 自动化构建。所有离线、实时任务都迁移到dolphinscheduler 。</td></tr></tbody></table>
<p>看到上面的每一步，我很庆幸自己和团队的每一个人成员都敢于去挑战自己。当然我们在做的过程中也看过业内商业化产品（神策、友盟、字节），毕竟在跟着业内主流走，大方面不会偏。</p>
<h1 data-id="heading-2">3：数仓的治理</h1>
<p>bi系统是负责展示大数据的门户，背后的底层逻辑搭建、模型的抽离至关重要。我重点说下每一个版本，我们做了一些什么样的治理。首先大致了解一下数据中台的系统架构，详细如下：
<img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b30320379af24ba5a4737aa4c7899fbd~tplv-k3u1fbpfcp-watermark.image" alt="数据中台.jpg" loading="lazy" referrerpolicy="no-referrer"></p>
<h5 data-id="heading-3">1.石器时代（es  外表）</h5>
<p>刚开始搭建bi体系的时候，我们的各种体系都比较欠缺。当初为了快速响应业务，所有的报表都通过外表处理。（快速的创建报表体系，让相关人员看到初步的成果）详细如下：</p>
<pre><code class="hljs language-js copyable" lang="js">##hive对应的 es 外表

CREATE EXTERNAL TABLE <span class="hljs-string">`app.channel_hour_analyse_report`</span>(
  <span class="hljs-string">`id`</span> string COMMENT <span class="hljs-string">'doc_id'</span>, 
  <span class="hljs-string">`channel_number`</span> string COMMENT <span class="hljs-string">'渠道号'</span>, 
  <span class="hljs-string">`install_device_count`</span> bigint COMMENT <span class="hljs-string">'安装量'</span>, 
  <span class="hljs-string">`staticdate`</span> string COMMENT <span class="hljs-string">'时间'</span>, 
  <span class="hljs-string">`hour`</span> bigint COMMENT <span class="hljs-string">'小时'</span>)
ROW FORMAT SERDE 
  <span class="hljs-string">'org.elasticsearch.hadoop.hive.EsSerDe'</span> 
STORED BY 
  <span class="hljs-string">'org.elasticsearch.hadoop.hive.EsStorageHandler'</span> 
WITH SERDEPROPERTIES ( 
  <span class="hljs-string">'serialization.format'</span>=<span class="hljs-string">'1'</span>)
LOCATION
  <span class="hljs-string">'hdfs://nameservice1/user/hive/warehouse/app.db/channel_hour_analyse_report'</span>
TBLPROPERTIES (
  <span class="hljs-string">'es.mapping.id'</span>=<span class="hljs-string">'id'</span>, 
  <span class="hljs-string">'es.nodes'</span>=<span class="hljs-string">'prod-es1:9200,prod-es2:9200,prod-es3:9200'</span>, 
  <span class="hljs-string">'es.resource'</span>=<span class="hljs-string">'d_custom_channel_operation_day_hour_table/_doc'</span>, 
  <span class="hljs-string">'es.write.operation'</span>=<span class="hljs-string">'upsert'</span>, 
  <span class="hljs-string">'last_modified_by'</span>=<span class="hljs-string">'test'</span>, 
  <span class="hljs-string">'last_modified_time'</span>=<span class="hljs-string">'1603697145'</span>, 
  <span class="hljs-string">'transient_lastDdlTime'</span>=<span class="hljs-string">'1603697145'</span>)

##hive 对应的hbase 外表

create EXTERNAL table <span class="hljs-string">`dwd.dw_public_userid_deviceid_relation`</span>(
<span class="hljs-string">`rowkey`</span> string  COMMENT  <span class="hljs-string">'rowkey'</span>,
<span class="hljs-string">`userid`</span>  string  COMMENT  <span class="hljs-string">'userid'</span>,
<span class="hljs-string">`deviceid`</span>  string  COMMENT  <span class="hljs-string">'deviceid'</span> ,
<span class="hljs-string">`last_login_time`</span>  string  COMMENT  <span class="hljs-string">'last_login_time'</span>,
<span class="hljs-string">`use_count`</span>  INT  COMMENT  <span class="hljs-string">'use_count'</span>,
<span class="hljs-string">`reserve1`</span>  string  COMMENT  <span class="hljs-string">'预留字段1'</span>,
<span class="hljs-string">`reserve2`</span>  string  COMMENT  <span class="hljs-string">'预留字段2'</span> 
) STORED BY <span class="hljs-string">'org.apache.hadoop.hive.hbase.HBaseStorageHandler'</span> WITH 
SERDEPROPERTIES (<span class="hljs-string">"hbase.columns.mapping"</span>= 
<span class="hljs-string">":key, 
cf:userid, 
cf:deviceid, 
cf:last_login_time, 
cf:use_count, 
cf:reserve1, 
cf:reserve2"</span>) TBLPROPERTIES (<span class="hljs-string">"hbase.table.name"</span> = <span class="hljs-string">"userid_deviceid_relation"</span>);
<span class="copy-code-btn">复制代码</span></code></pre>
<h5 data-id="heading-4">2.青铜时代（脚本迁移到spark sql）</h5>
<p>所有的脚本迁移到db,建议分为ods、dwd、dim、dws、ads 层，同一层的数据设置优先级，因为同一层的数据可能存在相互依赖的情况。一定要把数据来源， sink 目标表，ddl,exec_sqls(建议 JsonArray存储),app项目，分区，exec_level(建议越小约优先执行)，状态，创建人，时间，修改人，时间(方便以后问题追踪)，还可以扩展到kylin，clickhouse 等olap场景是否使用。  所有的数据取消外表，通过spark job 写入es 。</p>
<pre><code class="hljs language-js copyable" lang="js">val frame: DataFrame = spark.sql(read).filter(_.getString(<span class="hljs-number">0</span>) != <span class="hljs-literal">null</span>).coalesce(<span class="hljs-number">10</span>)
frame.show()
EsSparkSQL.saveToEs(frame, index, esConfig)
<span class="copy-code-btn">复制代码</span></code></pre>
<h5 data-id="heading-5">3.铁器时代（引入kylin）</h5>
<p>通过spark sql 执行整体的执行时间降低40%。但是业务需要添加纬度过滤，我们对应的sql 就需要成倍的增加。对于后期的脚本维护成本是比较大的，所以引入kylin。建立纬度、度量，迁移历史spark 脚本。注意 kylin 提交spark 任务，刚开始通过hive on spark 执行任务。后续优化通过livy 提交任务到spark ,整合的性能有较大的提升。在本次项目中引入字典库、模型为工业时代打下基础。
<img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/838cb585dab74fbdaee657051084c2f4~tplv-k3u1fbpfcp-watermark.image" alt="kylin.jpg" loading="lazy" referrerpolicy="no-referrer"></p>
<h5 data-id="heading-6">4.工业时代（数仓建模）</h5>
<p>引入kylin以后所有的数据层还是通过dws load hive 数据到kylin ,但是底层的hive元数据管理，主题、指标管理、复合指标管理、组件管理、可视化管理都是人工维护。为了打通河西走廊，我们把底层所有的同一行为的数据收缩统一、所有的度量、纬度通过系统动态构建cube。并且适配其他的olap 组件接入。
<img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e71513c040cf452497f3368a00c84dde~tplv-k3u1fbpfcp-watermark.image" alt="指标说明.jpg" loading="lazy" referrerpolicy="no-referrer"></p>
<pre><code class="hljs language-js copyable" lang="js">private RestClient <span class="hljs-function"><span class="hljs-title">getOrCreateRestClient</span>(<span class="hljs-params">KylinRestClientType clientType</span>)</span> &#123;
        RestClient restClient = restClientHashMap.get(clientType);
        <span class="hljs-keyword">if</span> (restClient == <span class="hljs-literal">null</span>) &#123;
            <span class="hljs-keyword">switch</span> (clientType) &#123;
                <span class="hljs-keyword">case</span> CUBE:
                    restClient = <span class="hljs-keyword">new</span> CubeClient();
                    <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">case</span> MODEL:
                    restClient = <span class="hljs-keyword">new</span> ModelClient();
                    <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">case</span> METADATA:
                    restClient = <span class="hljs-keyword">new</span> MetadataClient();
                    <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">default</span>:
                    LOG.error(<span class="hljs-string">"Can't match Client:&#123;&#125;"</span>, clientType);
            &#125;
            LOG.info(<span class="hljs-string">"create Kylin restClient type:&#123;&#125;"</span>, clientType);
            restClientHashMap.put(clientType, restClient);
        &#125;
        <span class="hljs-keyword">return</span> restClient;
&#125;
<span class="copy-code-btn">复制代码</span></code></pre>
<h1 data-id="heading-7">4：总结</h1>
<p>每一次的新尝试，都会有一定的突破。过程中有一些地方不够完美或不是足够的合理,但思维的碰撞促使我们不断的进步。业界有很多开源的数据展示组件像superset,metabase等，但是这些都离不开底层的指标与建模。欢迎大家一起讨论数据建模管理,以上是个人的一些思考。个别出处有问题，欢迎大家指正。</p></div>  
</div>
            