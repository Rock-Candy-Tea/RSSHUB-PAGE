
---
title: '前端优化指南：我们该怎么去压缩图像？'
categories: 
 - 编程
 - 掘金
 - 标签
headimg: 'https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b7aeef66e93145c08630921df6f53c47~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp'
author: 掘金
comments: false
date: Wed, 31 Aug 2022 23:32:16 GMT
thumbnail: 'https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b7aeef66e93145c08630921df6f53c47~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp'
---

<div>   
<div class="markdown-body cache"><style>.markdown-body&#123;word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#333&#125;.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6&#123;line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px&#125;.markdown-body h1&#123;font-size:24px;margin-bottom:5px&#125;.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6&#123;font-size:20px&#125;.markdown-body h2&#123;padding-bottom:12px;border-bottom:1px solid #ececec&#125;.markdown-body h3&#123;font-size:18px;padding-bottom:0&#125;.markdown-body h6&#123;margin-top:5px&#125;.markdown-body p&#123;line-height:inherit;margin-top:22px;margin-bottom:22px&#125;.markdown-body img&#123;max-width:100%&#125;.markdown-body hr&#123;border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px&#125;.markdown-body code&#123;word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em&#125;.markdown-body code,.markdown-body pre&#123;font-family:Menlo,Monaco,Consolas,Courier New,monospace&#125;.markdown-body pre&#123;overflow:auto;position:relative;line-height:1.75&#125;.markdown-body pre>code&#123;font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8&#125;.markdown-body a&#123;text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff&#125;.markdown-body a:active,.markdown-body a:hover&#123;color:#275b8c&#125;.markdown-body table&#123;display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6&#125;.markdown-body thead&#123;background:#f6f6f6;color:#000;text-align:left&#125;.markdown-body tr:nth-child(2n)&#123;background-color:#fcfcfc&#125;.markdown-body td,.markdown-body th&#123;padding:12px 7px;line-height:24px&#125;.markdown-body td&#123;min-width:120px&#125;.markdown-body blockquote&#123;color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8&#125;.markdown-body blockquote:after&#123;display:block;content:""&#125;.markdown-body blockquote>p&#123;margin:10px 0&#125;.markdown-body ol,.markdown-body ul&#123;padding-left:28px&#125;.markdown-body ol li,.markdown-body ul li&#123;margin-bottom:0;list-style:inherit&#125;.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item&#123;list-style:none&#125;.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul&#123;margin-top:0&#125;.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul&#123;margin-top:3px&#125;.markdown-body ol li&#123;padding-left:6px&#125;.markdown-body .contains-task-list&#123;padding-left:0&#125;.markdown-body .task-list-item&#123;list-style:none&#125;@media (max-width:720px)&#123;.markdown-body h1&#123;font-size:24px&#125;.markdown-body h2&#123;font-size:20px&#125;.markdown-body h3&#123;font-size:18px&#125;&#125;</style><p>在网站性能优化中，图像的影响比其他大部分内容都要严重。</p>
<p>本文我们来聊聊如何在前端工程化中优化图像。</p>
<h1 data-id="heading-0">原理</h1>
<p>图像是由很多个像素点组成的，在电脑上以电脑方阵的形式表示。</p>
<p>也就是每个像素点对应一个 rgb 值。只有采取这种做法的图片格式才是真正未被压缩的格式，比如 bmp，全称 bitmap。</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b7aeef66e93145c08630921df6f53c47~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp" alt loading="lazy" referrerpolicy="no-referrer"></p>
<p>但是这种格式的图片体积过大，加载速度慢，已经逐渐被淘汰了。</p>
<p>如今主流的图片格式都是压缩过的图片格式，主流的比如 png 和 jpeg。</p>
<p>jpeg 压缩的思路是把一张图片切割成多个小格子，把每个格子中相同的 rgb 值转换为 YUV（亮度、色调、饱和度），再进行量化就可以降低图片的整体体积。</p>
<p>png 压缩的思路是复用相同的 rgb 值来降低体积。</p>
<p>但是在实际中具体的图像压缩过程非常复杂，本文不展开讲，我们主要来看看目前业界主流的做法。</p>
<h1 data-id="heading-1">主流打包器的做法</h1>
<p>图像压缩时通常会有一个 quality 参数，表示质量，最低为 1，最高为 100。质量越高体积越大，质量越低体积越小。</p>
<p>通常建议为 75-80，不建议小于 60。</p>
<p>webpack 的压缩主要是依靠 <a href="https://link.juejin.cn/?target=https%3A%2F%2Fwebpack.js.org%2Fplugins%2Fimage-minimizer-webpack-plugin%2F" target="_blank" rel="nofollow noopener noreferrer" title="https://webpack.js.org/plugins/image-minimizer-webpack-plugin/" ref="nofollow noopener noreferrer">image-minimizer-webpack-plugin</a> 这个插件，它的底层依赖了 <a href="https://link.juejin.cn/?target=http%3A%2F%2Fwebpack.js.org%2F" target="_blank" rel="nofollow noopener noreferrer" title="http://webpack.js.org/" ref="nofollow noopener noreferrer">imagemin</a> 这个库。</p>
<p>rollup由于更偏向于 JavaScript 库的打包，所以它会利用 <a href="https://link.juejin.cn/?target=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2F%40rollup%2Fplugin-image" target="_blank" rel="nofollow noopener noreferrer" title="https://www.npmjs.com/package/@rollup/plugin-image" ref="nofollow noopener noreferrer">@rollup/plugin-image</a> 将图片打包成 base64 编码的格式，底层使用了 <a href="https://link.juejin.cn/?target=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2Fmini-svg-data-uri" target="_blank" rel="nofollow noopener noreferrer" title="https://www.npmjs.com/package/mini-svg-data-uri" ref="nofollow noopener noreferrer">mini-svg-data-uri</a>。</p>
<p>next/image 采用 sharp 来压缩图像，默认的质量是 75。</p>
<p>parcel 也是采用了 sharp 来压缩图像。</p>
<h1 data-id="heading-2">sharp vs imagemin vs jimp</h1>
<p>我通过 npmtrends 对比了几个图像压缩库的使用趋势。</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/fadd8de431e04b3fb37c152db6e5fc18~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp" alt loading="lazy" referrerpolicy="no-referrer"></p>
<p>并且从其中又挑选了最主流的三个图像压缩库做对比，它们分别是 sharp、imagemin 和 jimp。</p>
<p>为了直观的对比它们的差异，我做了一个在线图像压缩的网站。</p>
<p><a href="https://link.juejin.cn/?target=https%3A%2F%2Fwww.webbuild.me%2Fcompress-image" target="_blank" rel="nofollow noopener noreferrer" title="https://www.webbuild.me/compress-image" ref="nofollow noopener noreferrer">www.webbuild.me/compress-im…</a></p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0e556bc833ec415c8ba9442c6ca351f9~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp" alt loading="lazy" referrerpolicy="no-referrer"></p>
<p>这个网站和其他图片压缩网站不同的地方是，它除了具备基本的 jpg、png 压缩、批量压缩、转换 webp、选择压缩质量以外，还可以选择不同的压缩器。</p>
<p>我选择了三张图片进行压缩对比：</p>





















































































<table><thead><tr><th></th><th>格式</th><th>质量</th><th>压缩前</th><th>压缩后</th><th>转换 webp 后</th></tr></thead><tbody><tr><td>sharp</td><td>jpeg</td><td>75</td><td>266kb</td><td>138kb</td><td>94kb</td></tr><tr><td>imagemin</td><td>jpeg</td><td>75</td><td>266kb</td><td>114kb</td><td>94kb</td></tr><tr><td>jimp</td><td>jpeg</td><td>75</td><td>266kb</td><td>174kb</td><td>不支持</td></tr><tr><td>sharp</td><td>jpeg</td><td>75</td><td>557kb</td><td>516kb</td><td>239kb</td></tr><tr><td>imagemin</td><td>jpeg</td><td>75</td><td>557kb</td><td>436kb</td><td>239kb</td></tr><tr><td>jimp</td><td>jpeg</td><td>75</td><td>557kb</td><td>682kb</td><td>不支持</td></tr><tr><td>sharp</td><td>png</td><td>75</td><td>66kb</td><td>23kb</td><td>9kb</td></tr><tr><td>imagemin</td><td>png</td><td>75</td><td>66kb</td><td>19kb</td><td>9kb</td></tr><tr><td>jimp</td><td>png</td><td>75</td><td>66kb</td><td>88kb</td><td>不支持</td></tr></tbody></table>
<p>其实很好看出，imagemin 在 jpeg 和 png 的优化能力上最强，webp 模式下 sharp 和 imagemin 没有区别。jimp 会莫名其妙的负压缩。</p>
<p>jimp 的优势是不依赖 runtime 平台，它是零依赖的纯 JavaScript 实现。</p>
<p>sharp 和 imagemin 都依赖特定平台，但是它们在压缩能力上更加优秀。</p>
<p>不过 sharp 更加成熟和稳定，没有特殊要求，还是建议首选 sharp。</p>
<h1 data-id="heading-3">总结</h1>
<p>作为打包网站类应用来讲的话，主流的方案很简单：</p>
<ul>
<li>体积小的图片（通常指小于 10kb）转换为 base64。</li>
<li>体积大的图片（通常值大于 10kb）使用 webp 格式。</li>
<li>体积大但不是特别重要的图片，建议按照 75 的质量进行压缩。</li>
</ul></div>  
</div>
            