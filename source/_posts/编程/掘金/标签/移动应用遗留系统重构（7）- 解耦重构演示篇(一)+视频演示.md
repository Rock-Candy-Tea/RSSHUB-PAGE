
---
title: '移动应用遗留系统重构（7）- 解耦重构演示篇(一)+视频演示'
categories: 
 - 编程
 - 掘金
 - 标签
headimg: 'https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4e5378783e684dbe9ef579d82727e3cf~tplv-k3u1fbpfcp-zoom-1.image'
author: 掘金
comments: false
date: Fri, 07 May 2021 03:15:35 GMT
thumbnail: 'https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4e5378783e684dbe9ef579d82727e3cf~tplv-k3u1fbpfcp-zoom-1.image'
---

<div>   
<div class="markdown-body"><style>.markdown-body&#123;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333&#125;.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6&#123;line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px&#125;.markdown-body h1&#123;font-size:30px;margin-bottom:5px&#125;.markdown-body h2&#123;padding-bottom:12px;font-size:24px;border-bottom:1px solid #ececec&#125;.markdown-body h3&#123;font-size:18px;padding-bottom:0&#125;.markdown-body h4&#123;font-size:16px&#125;.markdown-body h5&#123;font-size:15px&#125;.markdown-body h6&#123;margin-top:5px&#125;.markdown-body p&#123;line-height:inherit;margin-top:22px;margin-bottom:22px&#125;.markdown-body img&#123;max-width:100%&#125;.markdown-body hr&#123;border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px&#125;.markdown-body code&#123;word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em&#125;.markdown-body code,.markdown-body pre&#123;font-family:Menlo,Monaco,Consolas,Courier New,monospace&#125;.markdown-body pre&#123;overflow:auto;position:relative;line-height:1.75&#125;.markdown-body pre>code&#123;font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8&#125;.markdown-body a&#123;text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff&#125;.markdown-body a:active,.markdown-body a:hover&#123;color:#275b8c&#125;.markdown-body table&#123;display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6&#125;.markdown-body thead&#123;background:#f6f6f6;color:#000;text-align:left&#125;.markdown-body tr:nth-child(2n)&#123;background-color:#fcfcfc&#125;.markdown-body td,.markdown-body th&#123;padding:12px 7px;line-height:24px&#125;.markdown-body td&#123;min-width:120px&#125;.markdown-body blockquote&#123;color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8&#125;.markdown-body blockquote:after&#123;display:block;content:""&#125;.markdown-body blockquote>p&#123;margin:10px 0&#125;.markdown-body ol,.markdown-body ul&#123;padding-left:28px&#125;.markdown-body ol li,.markdown-body ul li&#123;margin-bottom:0;list-style:inherit&#125;.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item&#123;list-style:none&#125;.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul&#123;margin-top:0&#125;.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul&#123;margin-top:3px&#125;.markdown-body ol li&#123;padding-left:6px&#125;.markdown-body .contains-task-list&#123;padding-left:0&#125;.markdown-body .task-list-item&#123;list-style:none&#125;@media (max-width:720px)&#123;.markdown-body h1&#123;font-size:24px&#125;.markdown-body h2&#123;font-size:20px&#125;.markdown-body h3&#123;font-size:18px&#125;&#125;</style><h1 data-id="heading-0">前言</h1>
<p><a href="https://juejin.cn/post/6952298178095874055" target="_blank">移动应用遗留系统重构（5）- 重构方法篇</a>中我们分享了重构流程，主要为4个操作步骤。</p>
<ol>
<li>识别一个内聚的包</li>
<li>解除该包的异常依赖</li>
<li>移动该包对应的代码及资源到新的模块</li>
<li>包解耦验收</li>
</ol>
<p><a href="https://juejin.cn/post/6954635678982340622" target="_blank">移动应用遗留系统重构（6）- 测试篇</a>中我们为<a href="https://github.com/junbin1011/CloudDisk" target="_blank" rel="nofollow noopener noreferrer">CloudDisk</a>补充了一组基本的冒烟测试。有了基本的测试守护后，本篇我们将挑选library（基础组件库）及file（文件业务模块）2个包进行重构演示。文章中包含操作的流程，同时了录制了视频。</p>
<p><strong>library模块重构代码演示视频：<a href="https://mp.weixin.qq.com/s/C0nQRbgmp1cLhwoWzGpqFw" target="_blank" rel="nofollow noopener noreferrer">mp.weixin.qq.com/s/C0nQRbgmp…</a></strong></p>
<p><strong>file模块重构代码演示视频：<a href="https://mp.weixin.qq.com/s/xbAIu6bWS7pLLAgHe-a8Bg" target="_blank" rel="nofollow noopener noreferrer">mp.weixin.qq.com/s/xbAIu6bWS…</a></strong></p>
<h1 data-id="heading-1">安全重构演示</h1>
<h2 data-id="heading-2">library包重构</h2>
<ol>
<li>依赖分析</li>
</ol>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4e5378783e684dbe9ef579d82727e3cf~tplv-k3u1fbpfcp-zoom-1.image" alt loading="lazy" referrerpolicy="no-referrer"></p>
<p>通过分析我们发现library包存在对上层模块的反向依赖，该依赖为异常依赖，须要解除。</p>
<ol start="2">
<li>安全重构</li>
</ol>
<p>重构前代码：</p>
<pre><code class="copyable">public class HttpUtils &#123;
    public static void post(String url) &#123;
        //发送http post请求，需要用到userId做标识
        String params = UserController.userId;
    &#125;
    public static void get(String url) &#123;
        //发送http get请求，需要用到userId做标识
        String params = UserController.userId;
    &#125;
&#125;

<span class="copy-code-btn">复制代码</span></code></pre>
<p>重构手法：<strong>提取方法参数</strong></p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7fd063ccc36240af9dc917dc22347067~tplv-k3u1fbpfcp-zoom-1.image" alt loading="lazy" referrerpolicy="no-referrer"></p>
<p>重构后代码：</p>
<pre><code class="copyable">public class HttpUtils &#123;
    public static void post(String url, String userId) &#123;
        //发送http post请求，需要用到userId做标识
        String params = userId;
    &#125;
    public static void get(String url, String userId) &#123;
        //发送http get请求，需要用到userId做标识
        String params = userId;
    &#125;
&#125;
<span class="copy-code-btn">复制代码</span></code></pre>
<ol start="3">
<li>代码移动</li>
</ol>
<p>代码移动至独立的library，加上对应的Gradle依赖：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7710d9f223be476aa59e3aff799797b8~tplv-k3u1fbpfcp-zoom-1.image" alt loading="lazy" referrerpolicy="no-referrer"></p>
<p>移动后模块结构如下：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0a956bec3eae4972856462f21e8b81be~tplv-k3u1fbpfcp-zoom-1.image" alt loading="lazy" referrerpolicy="no-referrer"></p>
<ol start="4">
<li>功能验证</li>
</ol>
<p>执行冒烟测试，验证功能</p>
<pre><code class="copyable">./gradlew app:testDebug --tests SmokeTesting

<span class="copy-code-btn">复制代码</span></code></pre>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b6e9797c72ae489d9f3770540214c98b~tplv-k3u1fbpfcp-zoom-1.image" alt loading="lazy" referrerpolicy="no-referrer"></p>
<p><strong>代码演示：<a href="https://mp.weixin.qq.com/s/C0nQRbgmp1cLhwoWzGpqFw" target="_blank" rel="nofollow noopener noreferrer">mp.weixin.qq.com/s/C0nQRbgmp…</a></strong></p>
<p>具体的代码：<a href="https://github.com/junbin1011/CloudDisk/commit/852463774f69142cb2ecb2b20cc581da6e1f3db7" target="_blank" rel="nofollow noopener noreferrer">github链接</a></p>
<h2 data-id="heading-3">file包重构</h2>
<ol>
<li>依赖分析</li>
</ol>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b4d79404f0744a138079ec6ab4feb43c~tplv-k3u1fbpfcp-zoom-1.image" alt loading="lazy" referrerpolicy="no-referrer"></p>
<p>通过分析我们发现file包存在横向bundle模块的依赖，该依赖为异常依赖，须要解除。</p>
<ol start="2">
<li>安全重构</li>
</ol>
<p>重构前代码：</p>
<pre><code class="copyable">public class FileController &#123;
    public List<FileInfo> getFileList() &#123;
        return new ArrayList<>();
    &#125;

    public FileInfo upload(String path) &#123;
        //上传文件
        LogUtils.log("upload file");
        HttpUtils.post("http://file", UserController.userId);
        return new FileInfo();
    &#125;

    public FileInfo download(String url) &#123;
        //下载文件
        if (!UserController.isLogin) &#123;
            return null;
        &#125;
        return new FileInfo();
    &#125;
&#125;
<span class="copy-code-btn">复制代码</span></code></pre>
<p>重构手法：</p>
<p>2.1 抽取getUserId、isLogin方法</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3127d85339284f74a542d401c3d9b094~tplv-k3u1fbpfcp-zoom-1.image" alt loading="lazy" referrerpolicy="no-referrer"></p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/887a5f718256483d88bdceeefba8e1f4~tplv-k3u1fbpfcp-zoom-1.image" alt loading="lazy" referrerpolicy="no-referrer"></p>
<p>重构后代码如下：</p>
<pre><code class="copyable">public class FileController &#123;
    public List<FileInfo> getFileList() &#123;
        return new ArrayList<>();
    &#125;

    public FileInfo upload(String path) &#123;
        //上传文件
        LogUtils.log("upload file");
        HttpUtils.post("http://file", getUserId());
        return new FileInfo();
    &#125;

    public FileInfo download(String url) &#123;
        //下载文件
        if (!isLogin()) &#123;
            return null;
        &#125;
        return new FileInfo();
    &#125;

    private String getUserId() &#123;
        return UserController.userId;
    &#125;

    private boolean isLogin() &#123;
        return UserController.isLogin;
    &#125;
&#125;

<span class="copy-code-btn">复制代码</span></code></pre>
<p>2.2 抽取代理类，UserState</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3e72483a1bf3490b8d75bf712311053d~tplv-k3u1fbpfcp-zoom-1.image" alt loading="lazy" referrerpolicy="no-referrer"></p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/dcac912c9b2f42c199366538e423b180~tplv-k3u1fbpfcp-zoom-1.image" alt loading="lazy" referrerpolicy="no-referrer"></p>
<p>重构后代码如下：</p>
<pre><code class="copyable">public class FileController &#123;
    private final UserState userState = new UserState();

    public List<FileInfo> getFileList() &#123;
        return new ArrayList<>();
    &#125;

    public FileInfo upload(String path) &#123;
        //上传文件
        LogUtils.log("upload file");
        HttpUtils.post("http://file", userState.getUserId());
        return new FileInfo();
    &#125;

    public FileInfo download(String url) &#123;
        //下载文件
        if (!userState.isLogin()) &#123;
            return null;
        &#125;
        return new FileInfo();
    &#125;
&#125;
<span class="copy-code-btn">复制代码</span></code></pre>
<p>2.3 抽取接口</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/8e84f1de3a1449b8900c1b4abe095da4~tplv-k3u1fbpfcp-zoom-1.image" alt loading="lazy" referrerpolicy="no-referrer"></p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/71d6b21294224bb48b72b4cef27e01c8~tplv-k3u1fbpfcp-zoom-1.image" alt loading="lazy" referrerpolicy="no-referrer"></p>
<p>重构后代码如下：</p>
<pre><code class="copyable">public class FileController &#123;
    private final UserState userState = new UserStateImpl();

    public List<FileInfo> getFileList() &#123;
        return new ArrayList<>();
    &#125;

    public FileInfo upload(String path) &#123;
        //上传文件
        LogUtils.log("upload file");
        HttpUtils.post("http://file", userState.getUserId());
        return new FileInfo();
    &#125;

    public FileInfo download(String url) &#123;
        //下载文件
        if (!userState.isLogin()) &#123;
            return null;
        &#125;
        return new FileInfo();
    &#125;
&#125;
<span class="copy-code-btn">复制代码</span></code></pre>
<p>2.4 提取构造函数，依赖接口注入</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f17a4ab2aab04fab8c944ef9d73a7865~tplv-k3u1fbpfcp-zoom-1.image" alt loading="lazy" referrerpolicy="no-referrer"></p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a2ba19a9cb9e411bb688b055d3f786e2~tplv-k3u1fbpfcp-zoom-1.image" alt loading="lazy" referrerpolicy="no-referrer"></p>
<p>重构后代码如下：</p>
<pre><code class="copyable">public class FileController &#123;
    private final UserState userState;

    public FileController(UserState userState) &#123;
        this.userState = userState;
    &#125;

    public List<FileInfo> getFileList() &#123;
        return new ArrayList<>();
    &#125;

    public FileInfo upload(String path) &#123;
        //上传文件
        LogUtils.log("upload file");
        HttpUtils.post("http://file", userState.getUserId());
        return new FileInfo();
    &#125;

    public FileInfo download(String url) &#123;
        //下载文件
        if (!userState.isLogin()) &#123;
            return null;
        &#125;
        return new FileInfo();
    &#125;
&#125;

<span class="copy-code-btn">复制代码</span></code></pre>
<p>同样FileFragment我也也做相同的构造及接口注入。</p>
<ol start="3">
<li>代码移动</li>
</ol>
<p>同样使用moduraize进行移动，代码移动至独立的fileBundle，加上对应的Gradle依赖：
<img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/689a6b71b4e047bc874394b57de33dc5~tplv-k3u1fbpfcp-zoom-1.image" alt loading="lazy" referrerpolicy="no-referrer">
移动后模块结构如下：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/23ff0cf8c77843b4bb43de4a124ce5d5~tplv-k3u1fbpfcp-zoom-1.image" alt loading="lazy" referrerpolicy="no-referrer"></p>
<ol start="4">
<li>功能验证</li>
</ol>
<p>执行冒烟测试，验证功能</p>
<pre><code class="copyable">./gradlew app:testDebug --tests SmokeTesting

<span class="copy-code-btn">复制代码</span></code></pre>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d85f4d6b12a84b1b9eabf0394e1d52ac~tplv-k3u1fbpfcp-zoom-1.image" alt loading="lazy" referrerpolicy="no-referrer"></p>
<blockquote>
<p>每一小步重构时都可以频繁运行测试，提前发现问题</p>
</blockquote>
<p><strong>代码演示：<a href="https://mp.weixin.qq.com/s/xbAIu6bWS7pLLAgHe-a8Bg" target="_blank" rel="nofollow noopener noreferrer">mp.weixin.qq.com/s/xbAIu6bWS…</a></strong></p>
<p>具体的代码：<a href="https://github.com/junbin1011/CloudDisk/commit/b69bbc8e7d5d83b0c542ada06d7157a6fb997682" target="_blank" rel="nofollow noopener noreferrer">github链接</a></p>
<h1 data-id="heading-4">总结</h1>
<p>本篇我们按着重构的4个步骤，借助IDE的安全重构，小步的重构了library和file2个包。虽然依赖解除了，代码也移动到独立的模块里面。但是我们还是发现了一些问题。</p>
<ol>
<li>UserState接口的层层注入，我们需要手工维护了好多构造方法及对应的注入</li>
<li>App依赖了fileBundle的Fragment，UI跳转上存在编译的依赖</li>
</ol>
<p>下一篇，单体移动应用“模块化”演进之旅（8）- 依赖注入篇，我们将分享常见的注入方式及业内优秀的实践，并对DiskCloud继续进行改造优化。</p>
<h1 data-id="heading-5">CloudDisk示例代码</h1>
<p><a href="https://github.com/junbin1011/CloudDisk" target="_blank" rel="nofollow noopener noreferrer">CloudDisk</a></p>
<h1 data-id="heading-6">系列链接</h1>
<p><a href="https://juejin.cn/post/6943470229905211422" target="_blank">移动应用遗留系统重构（1）- 开篇</a></p>
<p><a href="https://juejin.cn/post/6945313969556946980" target="_blank">移动应用遗留系统重构（2）-架构篇</a></p>
<p><a href="https://juejin.cn/post/6947855094272491556" target="_blank">移动应用遗留系统重构（3）-示例篇</a></p>
<p><a href="https://juejin.cn/post/6950077521790500894" target="_blank">移动应用遗留系统重构（4）-分析篇</a></p>
<p><a href="https://juejin.cn/post/6952298178095874055" target="_blank">移动应用遗留系统重构（5）- 重构方法篇</a></p>
<p><a href="https://juejin.cn/post/6954635678982340622" target="_blank">移动应用遗留系统重构（6）- 测试篇</a></p>
<h1 data-id="heading-7">大纲</h1>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e4bed0bc95a248eabe3ce6712e50837e~tplv-k3u1fbpfcp-zoom-1.image" alt loading="lazy" referrerpolicy="no-referrer"></p>
<h1 data-id="heading-8">关于</h1>
<p><strong>欢迎关注CAC敏捷教练公众号</strong>。微信搜索：<strong>CAC敏捷教练</strong>。</p>
<ul>
<li>作者：黄俊彬</li>
<li><a href="https://junbin.tech/" target="_blank" rel="nofollow noopener noreferrer">博客：junbin.tech</a></li>
<li><a href="https://github.com/junbin1011" target="_blank" rel="nofollow noopener noreferrer">GitHub: junbin1011 </a></li>
<li><a href="https://www.zhihu.com/people/junbin-9-77" target="_blank" rel="nofollow noopener noreferrer">知乎: @JunBin</a></li>
</ul></div>  
</div>
            