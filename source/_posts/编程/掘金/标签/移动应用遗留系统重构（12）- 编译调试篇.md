
---
title: '移动应用遗留系统重构（12）- 编译调试篇'
categories: 
 - 编程
 - 掘金
 - 标签
headimg: 'https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/799881281217424dbada7c577bdd27e9~tplv-k3u1fbpfcp-zoom-1.image'
author: 掘金
comments: false
date: Wed, 16 Jun 2021 21:44:57 GMT
thumbnail: 'https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/799881281217424dbada7c577bdd27e9~tplv-k3u1fbpfcp-zoom-1.image'
---

<div>   
<div class="markdown-body"><style>.markdown-body&#123;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333&#125;.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6&#123;line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px&#125;.markdown-body h1&#123;font-size:30px;margin-bottom:5px&#125;.markdown-body h2&#123;padding-bottom:12px;font-size:24px;border-bottom:1px solid #ececec&#125;.markdown-body h3&#123;font-size:18px;padding-bottom:0&#125;.markdown-body h4&#123;font-size:16px&#125;.markdown-body h5&#123;font-size:15px&#125;.markdown-body h6&#123;margin-top:5px&#125;.markdown-body p&#123;line-height:inherit;margin-top:22px;margin-bottom:22px&#125;.markdown-body img&#123;max-width:100%&#125;.markdown-body hr&#123;border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px&#125;.markdown-body code&#123;word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em&#125;.markdown-body code,.markdown-body pre&#123;font-family:Menlo,Monaco,Consolas,Courier New,monospace&#125;.markdown-body pre&#123;overflow:auto;position:relative;line-height:1.75&#125;.markdown-body pre>code&#123;font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8&#125;.markdown-body a&#123;text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff&#125;.markdown-body a:active,.markdown-body a:hover&#123;color:#275b8c&#125;.markdown-body table&#123;display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6&#125;.markdown-body thead&#123;background:#f6f6f6;color:#000;text-align:left&#125;.markdown-body tr:nth-child(2n)&#123;background-color:#fcfcfc&#125;.markdown-body td,.markdown-body th&#123;padding:12px 7px;line-height:24px&#125;.markdown-body td&#123;min-width:120px&#125;.markdown-body blockquote&#123;color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8&#125;.markdown-body blockquote:after&#123;display:block;content:""&#125;.markdown-body blockquote>p&#123;margin:10px 0&#125;.markdown-body ol,.markdown-body ul&#123;padding-left:28px&#125;.markdown-body ol li,.markdown-body ul li&#123;margin-bottom:0;list-style:inherit&#125;.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item&#123;list-style:none&#125;.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul&#123;margin-top:0&#125;.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul&#123;margin-top:3px&#125;.markdown-body ol li&#123;padding-left:6px&#125;.markdown-body .contains-task-list&#123;padding-left:0&#125;.markdown-body .task-list-item&#123;list-style:none&#125;@media (max-width:720px)&#123;.markdown-body h1&#123;font-size:24px&#125;.markdown-body h2&#123;font-size:20px&#125;.markdown-body h3&#123;font-size:18px&#125;&#125;</style><h1 data-id="heading-0">前言</h1>
<p>上一篇<a href="https://juejin.cn/post/6973836199655899149" target="_blank">移动应用遗留系统重构（11）- 制品管理篇</a>我们完成通过本地maven进行二进制管理改造。在架构设计中App模块是整体工程的集成，用于进行最后的发布。业务Bundle在独立的仓库中维护，并且Bundle都是以Lib的形式存在，我们需要能够对各个业务Bundle进行独立的调试开发。</p>
<p>本篇我们将继续对CloudDisk进行改造，支持Bundle进行独立的调试。</p>
<h1 data-id="heading-1">调试方式</h1>
<h2 data-id="heading-2">1. 支持Lib及Application切换</h2>
<p>我们可以通过配置Gradle的形式，让Module支持Lib及Application的调试，这样既可以满足运行调试，也可以满足发布aar。但是缺点是Gradle要进行配置，并且调试代码和正式代码都在一个工程中。</p>
<p>我们以FileBundle为例，Gradle配置情况如下：</p>
<pre><code class="copyable">//gradle 文件修改如下

def isApp = false
if (isApp) &#123;
    //可运行
    apply plugin: 'com.android.application'
&#125; else &#123;
    //作为库
    apply plugin: 'com.android.library'
&#125;

defaultConfig &#123;
    if (isApp) &#123;
        applicationId 'com.cloud.filebundle'
    &#125;
&#125;
<span class="copy-code-btn">复制代码</span></code></pre>
<p>在src下新增debug目录，这样当打debug包时，该目录下的代码也会一起打包，当打release包时，则不会带上。这样也可方便把测试代码区分开。</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/799881281217424dbada7c577bdd27e9~tplv-k3u1fbpfcp-zoom-1.image" alt loading="lazy" referrerpolicy="no-referrer"></p>
<p>我们直接把FileFragment在DebugActivity中显示出来，运行情况如下：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1e6b29cfbd324f2186fefe1343b6a6d0~tplv-k3u1fbpfcp-zoom-1.image" alt loading="lazy" referrerpolicy="no-referrer"></p>
<p>完整代码示例见<a href="https://github.com/junbin1011/CloudDisk/commit/7ed0b1e3eff0d40708bcd60e5d0a34cd2b8f1f00" target="_blank" rel="nofollow noopener noreferrer">Github</a></p>
<h2 data-id="heading-3">2. 新增Debug工程用于调试</h2>
<p>接下来我们通过DynamicBundle进行演示，新增一个module用于专门调试,这种做法的好处是测试代码完全隔离。</p>
<p>新建名为DynamicDebug的Module，加上对于的依赖，如下：</p>
<pre><code class="copyable">   implementation 'com.cloud.disk:api:1.0.0'
   implementation project(':dynamicBundle')
<span class="copy-code-btn">复制代码</span></code></pre>
<p>同样新增DebugActivity用于调试DynamicFragment。</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/02f7540f2a7242489884ad1277b98b29~tplv-k3u1fbpfcp-zoom-1.image" alt loading="lazy" referrerpolicy="no-referrer"></p>
<p>但运行调试发现编译出错，具体的日志如下：</p>
<pre><code class="copyable"> error: [Dagger/MissingBinding] com.cloud.disk.api.file.TransferFile cannot be provided without an @Provides-annotated method.
  public abstract static class ApplicationC implements DebugApplication_GeneratedInjector,
                         ^
      com.cloud.disk.api.file.TransferFile is injected at
          com.cloud.disk.bundle.dynamic.DynamicFragment.transferFile
      com.cloud.disk.bundle.dynamic.DynamicFragment is injected at
          com.cloud.disk.bundle.dynamic.DynamicFragment_GeneratedInjector.injectDynamicFragment(com.cloud.disk.bundle.dynamic.DynamicFragment) [com.cloud.dynamicdebug.DebugApplication_HiltComponents.ApplicationC → com.cloud.dynamicdebug.DebugApplication_HiltComponents.ActivityRetainedC → com.cloud.dynamicdebug.DebugApplication_HiltComponents.ActivityC → com.cloud.dynamicdebug.DebugApplication_HiltComponents.FragmentC]
  It is also requested at:
      com.cloud.disk.bundle.dynamic.DynamicController.transferFile
<span class="copy-code-btn">复制代码</span></code></pre>
<p>因为DynamicBundle运行需要依赖TransferFile及UseState接口的实现，这个时候DynamicBundle我们独立调试，并没有将接口的实现加载进来。<strong>这个时候我们建议的做法是采用Mock，不再把具体的实现加载进来。</strong></p>
<p>新增TransferFile及UseState的接口Mock如下：</p>
<pre><code class="copyable">@Module
@InstallIn(ActivityComponent.class)
public abstract class MockFileModule &#123;
    @Binds
    public abstract TransferFile bindTransferFile(
            MockTransferFileImpl transferFileImpl
    );
&#125;

public class MockTransferFileImpl implements TransferFile &#123;
    @Inject
    public MockTransferFileImpl() &#123;
    &#125;

    @Override
    public FileInfo upload(String s) &#123;
        return new FileInfo();
    &#125;

    @Override
    public FileInfo download(String s) &#123;
        return new FileInfo();
    &#125;
&#125;

<span class="copy-code-btn">复制代码</span></code></pre>
<pre><code class="copyable">@Module
@InstallIn(ActivityComponent.class)
public abstract class MockUserModule &#123;
    @Binds
    public abstract UserState bindUserState(
            MockUserStateImpl userStateImpl
    );
&#125;

public class MockUserStateImpl implements UserState &#123;
    @Inject
    public MockUserStateImpl() &#123;
    &#125;

    @Override
    public String getUserId() &#123;
        return "";
    &#125;

    @Override
    public boolean isLogin() &#123;
        return true;
    &#125;
&#125;
<span class="copy-code-btn">复制代码</span></code></pre>
<p>增加mock后，编译正常，运行结果如下：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/47f7a3119a094cec9baa81d3fc4bf2ff~tplv-k3u1fbpfcp-zoom-1.image" alt loading="lazy" referrerpolicy="no-referrer"></p>
<p>完整代码示例见<a href="https://github.com/junbin1011/CloudDisk/commit/b868d2514aed69f1b6fab79e3a047ce8c5c63b2d" target="_blank" rel="nofollow noopener noreferrer">Github</a></p>
<h2 data-id="heading-4">3. 自动化测试</h2>
<p>这是非常推荐的一种方式，可重复执行且反馈速度快。前面我们已经有一组冒烟测试的示例。接下来介绍对userBundle的UserCenterFragment进行测试，我们同样使用Robolectric提高反馈的速度。</p>
<p>Gradle增加依赖配置，如下：</p>
<pre><code class="copyable">    testImplementation 'junit:junit:4.13.2'
    testImplementation "com.google.truth:truth:1.0.1"
    testImplementation 'com.tngtech.archunit:archunit-junit4:0.15.0'
    testImplementation 'org.robolectric:robolectric:4.5.1'
    testImplementation 'androidx.test:core:1.3.0'
    testImplementation 'androidx.test.ext:junit:1.1.2'
    testImplementation 'androidx.test.espresso:espresso-core:3.3.0'
    testImplementation 'androidx.test.espresso:espresso-intents:3.3.0'
    debugImplementation "androidx.fragment:fragment-testing:1.3.0"
<span class="copy-code-btn">复制代码</span></code></pre>
<p>编写测试用例如下：</p>
<pre><code class="copyable">@RunWith(AndroidJUnit4.class)
@LargeTest
public class UserCenterFragmentTest &#123;
    @Test
    public void show_show_user_center_ui_when_click_tab_dynamic() &#123;
        //given
        FragmentScenario<UserCenterFragment> scenario = FragmentScenario.launchInContainer(UserCenterFragment.class);
        scenario.onFragment(activity -> &#123;
            //then
            onView(withText("Hello user center fragment")).check(matches(isDisplayed()));
        &#125;);
    &#125;
&#125;
<span class="copy-code-btn">复制代码</span></code></pre>
<p>执行测试命令：</p>
<pre><code class="copyable"> ./gradlew userBundle:testDebug

<span class="copy-code-btn">复制代码</span></code></pre>
<p>运行结果如下：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/bb457be8da764cb4b749325698adb947~tplv-k3u1fbpfcp-zoom-1.image" alt loading="lazy" referrerpolicy="no-referrer"></p>
<p>完整代码示例见<a href="https://github.com/junbin1011/CloudDisk/commit/e8439d74c113e6ef73ee12bd8c9893a853525e2a" target="_blank" rel="nofollow noopener noreferrer">Github</a></p>
<h1 data-id="heading-5">总结</h1>
<p>经过了解耦、分库及编译调试的优化，一段时间内，CloudDisk的开发效率得到了很大的提升。</p>
<p>但随着业务的演进，由于历史的原因，代码中存在很多Activity及Controller的上帝类。团队发现独立的业务Bundle质量还是比较差，Bug也比较多。团队决定再次对模块类的代码进行优化重构，采用新的MVP、MVVM架构将数据及视图分离。</p>
<p>下一篇，移动应用遗留系统重构（13）- MVP重构示例篇，一镜到底，我们将通过视频及文章的方式进行演示。</p>
<h1 data-id="heading-6">CloudDisk示例代码</h1>
<p><a href="https://github.com/junbin1011/CloudDisk" target="_blank" rel="nofollow noopener noreferrer">CloudDisk</a></p>
<h1 data-id="heading-7">系列链接</h1>
<p><a href="https://juejin.cn/post/6943470229905211422" target="_blank">移动应用遗留系统重构（1）- 开篇</a></p>
<p><a href="https://juejin.cn/post/6945313969556946980" target="_blank">移动应用遗留系统重构（2）-架构篇</a></p>
<p><a href="https://juejin.cn/post/6947855094272491556" target="_blank">移动应用遗留系统重构（3）-示例篇</a></p>
<p><a href="https://juejin.cn/post/6950077521790500894" target="_blank">移动应用遗留系统重构（4）-分析篇</a></p>
<p><a href="https://juejin.cn/post/6952298178095874055" target="_blank">移动应用遗留系统重构（5）- 重构方法篇</a></p>
<p><a href="https://juejin.cn/post/6954635678982340622" target="_blank">移动应用遗留系统重构（6）- 测试篇</a></p>
<p><a href="https://juejin.cn/post/6959504791642832909" target="_blank">移动应用遗留系统重构（7）- 解耦重构演示篇(一)+视频演示</a></p>
<p><a href="https://juejin.cn/post/6963214120178941983" target="_blank">移动应用遗留系统重构（8）- 依赖注入篇</a></p>
<p><a href="https://juejin.cn/post/6966166367821103117" target="_blank">移动应用遗留系统重构（9）- 路由篇</a></p>
<p><a href="https://juejin.cn/post/6970870458660945934" target="_blank">移动应用遗留系统重构（10）- 解耦重构演示篇（二）</a></p>
<p><a href="https://juejin.cn/post/6973836199655899149" target="_blank">移动应用遗留系统重构（11）- 制品管理篇</a></p>
<h1 data-id="heading-8">大纲</h1>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7f6bf97ef858432db44753c96cdca3fc~tplv-k3u1fbpfcp-zoom-1.image" alt loading="lazy" referrerpolicy="no-referrer"></p>
<h1 data-id="heading-9">关于</h1>
<ul>
<li>作者：黄俊彬</li>
<li><a href="https://junbin.tech/" target="_blank" rel="nofollow noopener noreferrer">博客：junbin.tech</a></li>
<li><a href="https://github.com/junbin1011" target="_blank" rel="nofollow noopener noreferrer">GitHub: junbin1011 </a></li>
<li><a href="https://www.zhihu.com/people/junbin-9-77" target="_blank" rel="nofollow noopener noreferrer">知乎: @JunBin</a></li>
</ul></div>  
</div>
            