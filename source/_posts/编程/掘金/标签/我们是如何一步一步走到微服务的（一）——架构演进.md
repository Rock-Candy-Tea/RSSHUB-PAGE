
---
title: '我们是如何一步一步走到微服务的（一）——架构演进'
categories: 
 - 编程
 - 掘金
 - 标签
headimg: 'https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c42af188eeb045dfbb25228236cf1269~tplv-k3u1fbpfcp-watermark.image'
author: 掘金
comments: false
date: Fri, 26 Mar 2021 08:34:59 GMT
thumbnail: 'https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c42af188eeb045dfbb25228236cf1269~tplv-k3u1fbpfcp-watermark.image'
---

<div>   
<div class="markdown-body"><style>.markdown-body&#123;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333&#125;.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6&#123;line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px&#125;.markdown-body h1&#123;font-size:30px;margin-bottom:5px&#125;.markdown-body h2&#123;padding-bottom:12px;font-size:24px;border-bottom:1px solid #ececec&#125;.markdown-body h3&#123;font-size:18px;padding-bottom:0&#125;.markdown-body h4&#123;font-size:16px&#125;.markdown-body h5&#123;font-size:15px&#125;.markdown-body h6&#123;margin-top:5px&#125;.markdown-body p&#123;line-height:inherit;margin-top:22px;margin-bottom:22px&#125;.markdown-body img&#123;max-width:100%&#125;.markdown-body hr&#123;border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px&#125;.markdown-body code&#123;word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em&#125;.markdown-body code,.markdown-body pre&#123;font-family:Menlo,Monaco,Consolas,Courier New,monospace&#125;.markdown-body pre&#123;overflow:auto;position:relative;line-height:1.75&#125;.markdown-body pre>code&#123;font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8&#125;.markdown-body a&#123;text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff&#125;.markdown-body a:active,.markdown-body a:hover&#123;color:#275b8c&#125;.markdown-body table&#123;display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6&#125;.markdown-body thead&#123;background:#f6f6f6;color:#000;text-align:left&#125;.markdown-body tr:nth-child(2n)&#123;background-color:#fcfcfc&#125;.markdown-body td,.markdown-body th&#123;padding:12px 7px;line-height:24px&#125;.markdown-body td&#123;min-width:120px&#125;.markdown-body blockquote&#123;color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8&#125;.markdown-body blockquote:after&#123;display:block;content:""&#125;.markdown-body blockquote>p&#123;margin:10px 0&#125;.markdown-body ol,.markdown-body ul&#123;padding-left:28px&#125;.markdown-body ol li,.markdown-body ul li&#123;margin-bottom:0;list-style:inherit&#125;.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item&#123;list-style:none&#125;.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul&#123;margin-top:0&#125;.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul&#123;margin-top:3px&#125;.markdown-body ol li&#123;padding-left:6px&#125;.markdown-body .contains-task-list&#123;padding-left:0&#125;.markdown-body .task-list-item&#123;list-style:none&#125;@media (max-width:720px)&#123;.markdown-body h1&#123;font-size:24px&#125;.markdown-body h2&#123;font-size:20px&#125;.markdown-body h3&#123;font-size:18px&#125;&#125;</style><h2 data-id="heading-0">一、 前言</h2>
<p>在今天，大部分Java后端开发应该都对SpringCloud/Dubbo这样的框架以及生态耳熟能详，“<strong>微服务</strong>”，“<strong>高并发</strong>”更是招聘JD上的常客。但是回过头来看一看，我们到底是为什么需要它们呢，它们又是在什么场景下诞生的呢？</p>
<h2 data-id="heading-1">二、架构演进</h2>
<h3 data-id="heading-2">单体架构</h3>
<p>Robben是一家公司的后端组长，有一天老板让他负责一条新的产品线。Robben斗志昂扬，键盘哗啦啦作响，一个<strong>单体</strong>的SpringBoot Backend就搭建好了，他熟稔的按<strong>领域建模</strong>拆成订单、产品、用户、营销模块分给组员去开发，在团队加班加点的战斗下，系统很快就上线了。运营对新产品的反馈很不错，老板也高兴说：你他娘真是个人才。
系统架构如图：</p>
<p><img alt="image.png" class="lazyload" src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c42af188eeb045dfbb25228236cf1269~tplv-k3u1fbpfcp-watermark.image" data-width="800" data-height="600" referrerpolicy="no-referrer"></p>
<h3 data-id="heading-3">应用水平扩容</h3>
<p>在运营同学的努力下，公司业绩蒸蒸日上，系统也面临着流量增高的考验。Robben盯着运维的监控数据说：小问题，搞成<strong>集群</strong>就行了。于是Robben开始将后端服务部署多个，然后通过<strong>负载均衡</strong>的方式暴露API。这样就就通过<strong>水平扩容</strong>顶住了<strong>应用层</strong>海量并发。同时可以在这里引入缓存来缓解数据库压力。
系统架构如图：</p>
<p><img alt="image.png" class="lazyload" src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/179a9cac758b4a368c61e6cd16a9fed2~tplv-k3u1fbpfcp-watermark.image" data-width="800" data-height="600" referrerpolicy="no-referrer"></p>
<p>此时系统面临两个问题</p>
<ul>
<li>集群的负载均衡：这个我们用Nginx就可以搞定。其他的方案还有DNS或者F5硬负载均衡。</li>
<li>分布式Session：这个我们用Redis作为分布式Session就可以搞定。其他的还有JwtToken等方案也可以。</li>
<li>需要缓存分担数据库压力：也用Redis搞定。</li>
</ul>
<h3 data-id="heading-4">数据库读写分离</h3>
<p>随着服务层的扩容，数据的压力自然也会增大，电商场景读明显大于写，所以显然robben想到用读写分离来解决这个问题。
搜索引擎在这里也可也引入，本质上搜索引擎就是一个读库。
<img alt="image.png" class="lazyload" src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0cce2e549e0946459b90e74ebad40726~tplv-k3u1fbpfcp-watermark.image" data-width="800" data-height="600" referrerpolicy="no-referrer">
带来的问题：</p>
<ul>
<li>多个数据源配置支持：动态数据源+自定义注解搞定。</li>
<li>ES的数据同步：binlog同步，全量同步+mq增量同步。</li>
</ul>
<h3 data-id="heading-5">数据库垂直拆分</h3>
<p>随着业务继续增长，虽然有读写分离，可是单Master也已经支撑不住系统的访问量。运维频频向robben投诉说数据库cpu经常90%以上，悄咪咪的说你们开发团队写的代码是不是有问题。在排查了一遍又一遍的慢sql之后，拿着数据库的诊断报告，robben终于申请到经费对数据库进行垂直分库了。</p>
<p><img alt="image.png" class="lazyload" src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e555185dbf084fd8b6f93c81b375a975~tplv-k3u1fbpfcp-watermark.image" data-width="800" data-height="600" referrerpolicy="no-referrer">
带来的问题</p>
<ul>
<li>多个数据源配置支持：多个数据源的配置。</li>
<li>分布式事务：消息补偿。其他还有XA两阶段提交等等，云服务商也提供成熟解决方案。</li>
<li>关联查询：全局表，数据同步，或者在应用层实现join。</li>
</ul>
<h3 data-id="heading-6">数据水平拆分</h3>
<p>当某个业务导致某个表的数据量超过单张表的瓶颈，比如按照阿里巴巴RDS建议一张表不要超过500w数据，可以将这张表在同一个库中拆成两个或多个表，其实就是希望底层能存在两个文件上。如果单表超过单个数据库瓶颈的话，就需要把这个表拆到两个或多个数据库中。比如当订单达到亿级别的时候，如图：</p>
<p><img alt="image.png" class="lazyload" src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/73c13c94f21c494999bad04694fe20b3~tplv-k3u1fbpfcp-watermark.image" data-width="800" data-height="600" referrerpolicy="no-referrer">
带来的问题：</p>
<ul>
<li>sql路由的处理，因为同一张表会存放在不同的地方：数据中间件重写sql，像mycat，sharding-jdbc。</li>
<li>主键的问题： 主键需要分布式环境唯一、有序，高性能产生，雪花算法搞定。</li>
<li>分页的问题： 归并排序。</li>
</ul>
<h3 data-id="heading-7">应用拆分微服务</h3>
<p>随着版本的不断迭代，无穷无尽的业务使得原有的<strong>单体架构</strong>越来越复杂，越来越难以支撑业务体系的发展。提交代码总是会有冲突，<strong>模块直接耦合</strong>严重，一个小需求发布要牵扯到多个模块负责团队，主要业务和次要业务在一起，单个业务横向扩容复杂。在组员频繁的抱怨中，robben决定将单体的应用按模块拆成多个<strong>垂直应用</strong>。这样就解决了单一架构应用面临的部分业务扩容问题，流量能够分散到各个子系统里面，并且每个子系统有单独的软件开发周期，不同模块开发成员之间的协作和维护成本也降低了。Robben心想：这下代码不会被覆盖了。
架构如下：</p>
<p><img alt="image.png" class="lazyload" src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6fbe31b13bad47c898f87c60334c2b4c~tplv-k3u1fbpfcp-watermark.image" data-width="800" data-height="600" referrerpolicy="no-referrer">
带来的问题：</p>
<ul>
<li>不同模块之前的服务调用不再是内部方法调用，而是需要远程服务调用（RPC）</li>
<li>服务的治理变成了一个难题：服务治理框架，配置中心，网关。</li>
</ul>
<h2 data-id="heading-8">三、小结</h2>
<p>看到这里，很容易明白，当架构演进到需要拆分微服务的时候，自然而然需要相应的框架来满足服务层和数据层的需求。<br>
SpringCloud/Dubbo这些框架就是为了服务层应运而生。<br>
MyCat/Sharding-Jdbc这些框架就是为了数据层而产生的。<br>
还有像Mq、缓存都是一个大型分布式后端必不可少的中间件。</p>
<p>当然关系数据库搞不定的时候，数仓的概念就来了，像Hadoop全家桶/Es等大数据技术来满足海量数据的业务需求。这个系列就先不说了。
接下来主要是写一下服务层和数据层中间件的一些技术原理和使用要点。</p></div> <div class="image-viewer-box" data-v-78c9b824><!----></div>  
</div>
            