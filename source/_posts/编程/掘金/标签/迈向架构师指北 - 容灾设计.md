
---
title: '迈向架构师指北 - 容灾设计'
categories: 
 - 编程
 - 掘金
 - 标签
headimg: 'https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0ceed64a08414ce0a97dc1f08c2f90cb~tplv-k3u1fbpfcp-watermark.image'
author: 掘金
comments: false
date: Tue, 24 Aug 2021 17:57:28 GMT
thumbnail: 'https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0ceed64a08414ce0a97dc1f08c2f90cb~tplv-k3u1fbpfcp-watermark.image'
---

<div>   
<div class="markdown-body"><style>.markdown-body&#123;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333&#125;.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6&#123;line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px&#125;.markdown-body h1&#123;font-size:30px;margin-bottom:5px&#125;.markdown-body h2&#123;padding-bottom:12px;font-size:24px;border-bottom:1px solid #ececec&#125;.markdown-body h3&#123;font-size:18px;padding-bottom:0&#125;.markdown-body h4&#123;font-size:16px&#125;.markdown-body h5&#123;font-size:15px&#125;.markdown-body h6&#123;margin-top:5px&#125;.markdown-body p&#123;line-height:inherit;margin-top:22px;margin-bottom:22px&#125;.markdown-body img&#123;max-width:100%&#125;.markdown-body hr&#123;border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px&#125;.markdown-body code&#123;word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em&#125;.markdown-body code,.markdown-body pre&#123;font-family:Menlo,Monaco,Consolas,Courier New,monospace&#125;.markdown-body pre&#123;overflow:auto;position:relative;line-height:1.75&#125;.markdown-body pre>code&#123;font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8&#125;.markdown-body a&#123;text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff&#125;.markdown-body a:active,.markdown-body a:hover&#123;color:#275b8c&#125;.markdown-body table&#123;display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6&#125;.markdown-body thead&#123;background:#f6f6f6;color:#000;text-align:left&#125;.markdown-body tr:nth-child(2n)&#123;background-color:#fcfcfc&#125;.markdown-body td,.markdown-body th&#123;padding:12px 7px;line-height:24px&#125;.markdown-body td&#123;min-width:120px&#125;.markdown-body blockquote&#123;color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8&#125;.markdown-body blockquote:after&#123;display:block;content:""&#125;.markdown-body blockquote>p&#123;margin:10px 0&#125;.markdown-body ol,.markdown-body ul&#123;padding-left:28px&#125;.markdown-body ol li,.markdown-body ul li&#123;margin-bottom:0;list-style:inherit&#125;.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item&#123;list-style:none&#125;.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul&#123;margin-top:0&#125;.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul&#123;margin-top:3px&#125;.markdown-body ol li&#123;padding-left:6px&#125;.markdown-body .contains-task-list&#123;padding-left:0&#125;.markdown-body .task-list-item&#123;list-style:none&#125;@media (max-width:720px)&#123;.markdown-body h1&#123;font-size:24px&#125;.markdown-body h2&#123;font-size:20px&#125;.markdown-body h3&#123;font-size:18px&#125;&#125;</style><h2 data-id="heading-0">容灾是什么</h2>
<h3 data-id="heading-1">前言</h3>
<p>从字面上理解，容灾是指在自然灾难，设备故障，人为破环等灾难发生时，通过一些前置的兼容或包容性处理，保证整个持续有效的运行。</p>
<p>容灾是一个比较宽泛的概念，是一个系统性的工程，所以在我们谈及容灾的时候，往往需要先建立出面临灾难的场景，针对不同场景来实施不同容灾方案。</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0ceed64a08414ce0a97dc1f08c2f90cb~tplv-k3u1fbpfcp-watermark.image" alt="容灾.jpg" loading="lazy" referrerpolicy="no-referrer"></p>
<h3 data-id="heading-2">关键指标</h3>
<p>RTO 与 RPO 都是用来指导制定容灾方案，和衡量方案优劣的关键指标。</p>
<p>RTO：Recovery Time Objective，指从灾难发生到整个系统恢复正常所需要的最大时常。</p>
<p>例如 RTO 指标为 30 min，则代表当前业务系统能够容忍 30 min 时间的停止服务，在停止服务的期间对业务造成的损失是可承受的。但如果 30 min 后仍无法恢复服务，会导致业务损失不可承受。</p>
<p>RPO：Recovery Point Objective，指业务系统可容忍的数据丢失量，从时间维度上计算的数据丢失量。</p>
<p>例如 RPO 指标为 10 小时，业务系统数据会在每天 0 点进行数据备份，若当天早上 8 点系统故障导致数据全丢失，则丢失的数据量就是 8 小时的，小于 RPO 指标，是在可容忍范围的。若当天下午 14 点系统故障数据丢失，则是不可容忍的。</p>
<h3 data-id="heading-3">常见故障</h3>
<p>一般系统故障会分为三个大类型：状态型，区域型和业务型。根据不同的故障类型需要采取不同的容灾方案，甚至是多种容灾方案组合使用。</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e12420f99c1a4f379850484815954c9b~tplv-k3u1fbpfcp-watermark.image" alt="故障类型.png" loading="lazy" referrerpolicy="no-referrer"></p>
<p>容灾除了在发生故障后及时修复，如何在故障发生前制定合适的故障预防方案来避免故障的发生也是尤为重要。</p>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3daa0cf306b241c6b01050d7780f0a67~tplv-k3u1fbpfcp-watermark.image" alt="故障预防方案.png" loading="lazy" referrerpolicy="no-referrer"></p>
<h2 data-id="heading-4">云时代还需要容灾吗</h2>
<p>随着云原生时代的到来，企业纷纷倡导将业务容器化拥抱云原生，云原生也在这种趋势下发展出了适合云原生的容灾方案。</p>
<p>当前云原生容灾基本以数据备份，负载均衡和递进式多活容灾为核心，以数据迁移，备份和恢复为业务场景，实现高可靠性。以下<strong>未高亮</strong>的就是云原生容灾目前能够覆盖的范围。</p>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ee53936e18b9482a9f4389d696566ec3~tplv-k3u1fbpfcp-watermark.image" alt="故障类型（高亮）.png" loading="lazy" referrerpolicy="no-referrer"></p>
<p>可以看到，如今云原生容灾几乎能够覆盖绝大多数通用场景，但与业务类型强耦合的容灾方案还是需要工程师来制定实现。</p>
<h2 data-id="heading-5">容灾方案</h2>
<p>从上面的思维导图中可以发现，针对不同的故障有不同的容灾方案，没有一劳永逸的方案，合适的方案才是好方案。</p>
<h3 data-id="heading-6">中心化判定</h3>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1b7b3407f2bb47dabca40df3d750526f~tplv-k3u1fbpfcp-watermark.image" alt="中心判定.png" loading="lazy" referrerpolicy="no-referrer"></p>
<p>中心化判定通常是在客户端与服务端之间建立中心代理层，或者称网关层，有能力进行统一的流量管理，负载均衡等一系列容灾操作。</p>
<p>中心化判定的优势：</p>
<ol>
<li>切换快速，且无感知</li>
<li>与业务分离，专注于容灾</li>
<li>负载均衡控制更精确</li>
</ol>
<p>同时中心化也存在明显的劣势：</p>
<ol>
<li>存在单点故障风险，若中心代理服务出现问题，整个业务系统会受到影响</li>
<li>维护成本较高</li>
<li>自身容灾可能脑裂</li>
<li>异构适应性弱</li>
</ol>
<h3 data-id="heading-7">分布式判定</h3>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1031ef2b3a3b4a9fa2876dbe5eb4a428~tplv-k3u1fbpfcp-watermark.image" alt="分布式判定.png" loading="lazy" referrerpolicy="no-referrer"></p>
<p>分布式判定法通常是在每个客户端建立本地的代理层，每次客户端发出请求都会经过代理层，代理层根据当前策略转发至对应的服务器。</p>
<p>分布式模式解决了中心化两个比较重要的的问题，一是单点故障风险，因为每个客户端都有属于自己的代理层，即使一个客户端的代理层故障也不会影响到其他客户端；二是异构适应性强，因为每个代理层只服务对应客户端，所以代理层可以根据不同客户端做出定制化的配置。</p>
<p>但分布式模式存在一个比较大的缺点，就是代理层与客户端耦合性比较强，导致代理层的转发策略具有单点局限性，并且这个局限性会随着时间的推移越来越大，不能做到有效的负载均衡。所以我们需要引入一个策略管理中心的模块，正常情况下，客户端的每次请求经过本地的代理层，上报至策略管理中心，策略管理中心一面收集各客户端的请求，根据现状给出对应的转发策略下发至对应代理层，代理层再根据管理中心下发策略进行请求转发；若策略管理中心模块出现故障，则启用本地代理层策略进行转发。</p>
<p>分布式判定的优势：</p>
<ol>
<li>没有单点故障风险</li>
<li>运维成本比较低</li>
<li>异构适应性强</li>
</ol>
<p>同时中心化也存在明显的劣势：</p>
<ol>
<li>切换速度慢，且可能存在流量切换不干净的情况</li>
<li>对应用程序入侵较多，耦合性比较强</li>
<li>长链接负载均衡不理想</li>
</ol>
<h3 data-id="heading-8">单元化设计</h3>
<p>单元是指一个能完成所有业务的集合。</p>
<p>这里的单元化其实区别于模块化的概念，模块化通常是指将某个功能抽象成模块，不同的模块组合，协同工作来支撑所有业务。而单元化是指要包含所有业务模块的单元，意味着每个单元都需要有独立运行为所有业务提供服务的能力。</p>
<p>这里的所有业务并不一定是全部的业务，一般来说是指所有的核心业务。单元化容灾的初衷是保障核心业务不会受到或受到可接受的影响，所以在做单元化容灾时一定要做好取舍，要考虑清楚哪些业务是需要单元化。</p>
<p>常见的单元化设计方案有：同城双活，异地双活，多城多活等。</p>
<p>以同城双活为例，在同一个城市搭建两个机房，提供两套完整的服务和数据库，每套数据库通常是一主一备，以下是个简化模型。</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d767445c43db45789b710b392b7ed3f5~tplv-k3u1fbpfcp-watermark.image" alt="同城双活.jpg" loading="lazy" referrerpolicy="no-referrer"></p>
<p>两台 IDC 服务 A 和 服务 B  为保障强一致性，都访问 DB1。当 DB1 出现故障，访问数据库立即切换至 DB3，一般能保证秒级的 RTO。</p>
<p>其中 DB 之间的数据同步策略可以根据实际场景中 RPO 的要求来制定。例如：若在对 RPO 要求比较严格的场景中，可以使用 DB1 向 DB3 和 DB4 半同步的方式进行数据同步，牺牲部分性能来换取强一致性。</p>
<p>单元化设计的前提是需要业务数据具备可水平切分性，比如按照用户 ID 的规则进行切分等。这也看出来单元化设计不仅仅是针对于容灾，也可以解决随着业务扩张数据库连接数过多等一系列扩容问题。</p>
<h3 data-id="heading-9">过载保护</h3>
<p>过载保护通常会采用三种思路保护系统：限流，降级和熔断。</p>
<h4 data-id="heading-10">限流</h4>
<p>限流一般是指限制入口流量。在流量过大时，触发预设限流开关，采取相应的限流行为，保护下游服务。通常触发开关的机制有三种，分别是：设定阈值，下游通知和资源过载定时检测。保护下游的限流行为也有两种，一种是刚性的，指流量超过预设阈值后，关闭与下游服务的通讯，不再提供服务；一种是弹性的，一般指降级处理。</p>
<h4 data-id="heading-11">降级</h4>
<p>降级一般是指限制业务能力或是限制用户行为。限制业务能力一般会保留主要功能，限制次要功能，使整个系统处于一个可承受压力且主要可用的状态，来尽可能的保证用户体验。限制用户行为一般是指通过策略限制部分用户无法访问部分业务。</p>
<h4 data-id="heading-12">熔断</h4>
<p>熔断一般指发现自身或下游无法提供正常服务，上游主动关闭与下游之间的通讯。目前也有不少弹性熔断的机制，如：Google SRE 弹性熔断等。</p>
<p>过载保护的具体措施有：队列限流，耗时限流，频率限流，随机限流，终端限流，轻重分离，动态过载等。</p>
<p>举个频率限流的例子</p>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/db132831ee274fbbb76002662b5ad36d~tplv-k3u1fbpfcp-watermark.image" alt="频率限流.png" loading="lazy" referrerpolicy="no-referrer"></p>
<p>其中 “当前 QPS 超过平均值的判断和根据当前 QPS 计算请求丢弃概率” 这部分就是自定义的限流策略，这个策略可以是超过平均值也可以是达到理论峰值的百分之八十等，需要根据实际场景来制定。</p>
<p>总的来说，要做好过载保护，上下游的服务要做到互相信任，但不能互相依赖。</p>
<h3 data-id="heading-13">柔性处理</h3>
<p>柔性处理通常指在有限的条件下无法提供完美的用户体验时，需要对业务系统进行取舍，为用户提供有损的完整服务。</p>
<p>因此实现柔性处理的前提是需要清楚的认识到哪些服务提供系统的核心功能，所以在产品设计阶段就应该结合当前资源和场景开始制定柔性处理方案。通常设计柔性处理方案的方法如下：</p>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f95cfc6ea74049e890fb9af2b75ac042~tplv-k3u1fbpfcp-watermark.image" alt="柔性处理方法.jpg" loading="lazy" referrerpolicy="no-referrer"></p>
<p>通常柔性处理的实际方案有以下几种方式：</p>
<ol>
<li>功能消减</li>
<li>本地化</li>
<li>渠道备用</li>
<li>异步化</li>
</ol>
<p>柔性处理是容灾中最为常用，也是成本较低的一种手段，例如网络差看视频时，会将视频画质自动降级；网络差打开网站时，有些网站会提供纯文字内容，图片和视频等部分不显示等。</p>
<p>如果对以上哪种方案具体实现有兴趣的可以评论区留言，交流学习一下。</p>
<h2 data-id="heading-14">尾言</h2>
<p>了解容灾设计后，在日常业务开发的过程中，有部分开发者时常会有疑惑，容灾应该是大型系统级的方案应该考虑的问题，我开发的业务模块需要做容灾吗？如果需要做，在有限的开发周期内容灾应该做到什么程度呢？</p>
<p>首先容灾设计不是针对一个固定场景的，大型系统级的容灾可能需要考虑到多城多活等因素，而小的业务模块可能需要考虑的则是柔性方案等。真正好的容灾设计是针对不同的业务场景采用不同的容灾方案组合以达到真实容灾的目的。</p>
<p>而在有限的开发周期判断一个模块的容灾应该做到何种程度，取决于模块的价值，如果这个模块是关键模块，毫无疑问，对于关键模块需要制定完善的容灾方案。而如果模块价值不高，则可以进行一些简单的容灾。</p>
<p>学会权衡取舍，有限资源价值最大化是迈向架构师的重要一步。</p></div>  
</div>
            