
---
title: '极低成本构建一个可靠的短链系统'
categories: 
 - 编程
 - 掘金
 - 标签
headimg: 'https://picsum.photos/400/300?random=4475'
author: 掘金
comments: false
date: Tue, 25 May 2021 00:20:44 GMT
thumbnail: 'https://picsum.photos/400/300?random=4475'
---

<div>   
<div class="markdown-body"><style>.markdown-body&#123;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333&#125;.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6&#123;line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px&#125;.markdown-body h1&#123;font-size:30px;margin-bottom:5px&#125;.markdown-body h2&#123;padding-bottom:12px;font-size:24px;border-bottom:1px solid #ececec&#125;.markdown-body h3&#123;font-size:18px;padding-bottom:0&#125;.markdown-body h4&#123;font-size:16px&#125;.markdown-body h5&#123;font-size:15px&#125;.markdown-body h6&#123;margin-top:5px&#125;.markdown-body p&#123;line-height:inherit;margin-top:22px;margin-bottom:22px&#125;.markdown-body img&#123;max-width:100%&#125;.markdown-body hr&#123;border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px&#125;.markdown-body code&#123;word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em&#125;.markdown-body code,.markdown-body pre&#123;font-family:Menlo,Monaco,Consolas,Courier New,monospace&#125;.markdown-body pre&#123;overflow:auto;position:relative;line-height:1.75&#125;.markdown-body pre>code&#123;font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8&#125;.markdown-body a&#123;text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff&#125;.markdown-body a:active,.markdown-body a:hover&#123;color:#275b8c&#125;.markdown-body table&#123;display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6&#125;.markdown-body thead&#123;background:#f6f6f6;color:#000;text-align:left&#125;.markdown-body tr:nth-child(2n)&#123;background-color:#fcfcfc&#125;.markdown-body td,.markdown-body th&#123;padding:12px 7px;line-height:24px&#125;.markdown-body td&#123;min-width:120px&#125;.markdown-body blockquote&#123;color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8&#125;.markdown-body blockquote:after&#123;display:block;content:""&#125;.markdown-body blockquote>p&#123;margin:10px 0&#125;.markdown-body ol,.markdown-body ul&#123;padding-left:28px&#125;.markdown-body ol li,.markdown-body ul li&#123;margin-bottom:0;list-style:inherit&#125;.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item&#123;list-style:none&#125;.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul&#123;margin-top:0&#125;.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul&#123;margin-top:3px&#125;.markdown-body ol li&#123;padding-left:6px&#125;.markdown-body .contains-task-list&#123;padding-left:0&#125;.markdown-body .task-list-item&#123;list-style:none&#125;@media (max-width:720px)&#123;.markdown-body h1&#123;font-size:24px&#125;.markdown-body h2&#123;font-size:20px&#125;.markdown-body h3&#123;font-size:18px&#125;&#125;</style><h2 data-id="heading-0">原始需求</h2>
<p>最近接到一个需求：运营需要对某些H5页面发短信进行推广，但是一条短信会限制字数，所以需要想办法将H5链接的URL变得短一些。短信限制字符在70个以内，也就是说URL+运营话术的长度必须控制在70个字符以内，如果URL太长，则会挤占运营的话术空间，容易表达不清楚。</p>
<h2 data-id="heading-1">需求分析</h2>
<p>简单看一眼，这就是要做一个短链服务。短链接是什么？就是访问一个短链接的时候自动跳转至某个配置好的地址。网上这样的短链接工具很多，比如短链接bitly这个工具，网址是<a href="https://bitly.com/" target="_blank" rel="nofollow noopener noreferrer">bitly.com/</a>，可以体验一下。
​</p>
<p>关于短链接，网上的文章比较多，有些还涉及到比较复杂的短链接算法。但是我们这里的场景其实相对简单，用不了太复杂的技术。我们需要认真分析需求，不能生搬硬套别人的方案。这里我们的需求有两个特点：
​</p>
<h4 data-id="heading-2">1. 生成短链接的频率很低</h4>
<p>因为是运营手动生成需要推广的短链接，即使全公司的运营一起生成短链，频率也很低，所以生成短链的性能要求很低。
​</p>
<h4 data-id="heading-3">2. 短链生成的量很少</h4>
<p>由于都是人去手工生成短链，那么生成的短链的总量肯定是很少的，所以我们的数据量也是比较小的。
​</p>
<h4 data-id="heading-4">3. 短链接解析需要尽可能高性能</h4>
<p>因为运营发一波短信下去，刚发的时候肯定是一个打开的高峰期，很快打开的量就会降下来，整个过程的量都集中在前面几分钟。所以短链接还原应该尽可能快速的响应，不应该消耗太多资源。</p>
<h2 data-id="heading-5">短链接系统设计</h2>
<p>通过对上面的需求分析，frank做出了如下设计：</p>
<h4 data-id="heading-6">1. 存储设计</h4>
<p>数据存储方面只使用Mysql，建立一张链接表，表只包含两个字段，一个是自增ID，另一个是长链接URL，给长链接URL加上唯一索引，确保同一个长链接不会生成两个短链接。
​</p>
<h4 data-id="heading-7">2. 长链接如何变短</h4>
<p>基于上面的存储设计，每一条长链接记录都会有一个唯一ID，用这个ID就能唯一定位到长链接。
唯一的问题在于这个ID可能稍微有些长，比如运营已经对10000条URL进行了推广，那么后面的ID就至少要占用5个字符了，怎么样优化优化？答案是把10进制的数字转化为62进制，为什么是62进制，26个大写字母 + 26个小写字母 + 10个数字 = 62。为什么不选其他自符？URL里的特殊字符都会重新编码，这62个字符不会。这样选的话能将字符缩短多少呢？先看下表：</p>

























<table><thead><tr><th>62进制数</th><th>对应10进制数</th></tr></thead><tbody><tr><td>1位62进制最大数Z</td><td>61</td></tr><tr><td>2位62进制最大数ZZ</td><td>3843</td></tr><tr><td>3位62进制最大数ZZZ</td><td>238327</td></tr><tr><td>4位62进制最大数ZZZZ</td><td>14776335</td></tr></tbody></table>
<p>从上表可以看出，对于23万条范围以内的ID都限制在3个字符的范围内，基本已经够运营用了。即使再多，预计运营需要的长链接也绝对不会超过1400万条，也就是说最多最多短链的ID也就用4个字符表示就足够了，相对于1000万的8个字符，只需要4个字符就够了，足足压缩了一倍。
​</p>
<h4 data-id="heading-8">3. 进制转化</h4>
<p>进制转化怎么做呢？首先有对应关系如下表：</p>













































<table><thead><tr><th>10进制数</th><th>62进制数</th></tr></thead><tbody><tr><td>0</td><td>0</td></tr><tr><td>...</td><td>...</td></tr><tr><td>9</td><td>9</td></tr><tr><td>a</td><td>10</td></tr><tr><td>...</td><td>...</td></tr><tr><td>z</td><td>35</td></tr><tr><td>A</td><td>36</td></tr><tr><td>...</td><td>...</td></tr><tr><td>Z</td><td>61</td></tr></tbody></table>
<p>按照上面的表先构建两个map： 一个将map将10进制转为62进制，叫map_to_62, 另一个map将62进制转为10进制，叫map_to_10。构建两个map的python代码如下：</p>
<pre><code class="hljs language-python copyable" lang="python"><span class="hljs-keyword">import</span> string
chars = string.digits + string.ascii_lowercase + string.ascii_uppercase
map_to_62 = <span class="hljs-built_in">dict</span>(<span class="hljs-built_in">zip</span>(<span class="hljs-built_in">range</span>(<span class="hljs-number">62</span>), chars))
map_to_10 = <span class="hljs-built_in">dict</span>(<span class="hljs-built_in">zip</span>(chars, <span class="hljs-built_in">range</span>(<span class="hljs-number">62</span>)))
<span class="copy-code-btn">复制代码</span></code></pre>
<p>10进制转62进制python实现代码如下：</p>
<pre><code class="hljs language-python copyable" lang="python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">int_to_62chars</span>(<span class="hljs-params">n</span>):</span>
    chars = []
    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:
        c = map_to_62[n % <span class="hljs-number">62</span>] // 上面生成的<span class="hljs-number">10</span>进制数字转<span class="hljs-number">62</span>进制字符的<span class="hljs-built_in">map</span>
        chars.append(c)
        n = n // <span class="hljs-number">62</span>
        <span class="hljs-keyword">if</span> n == <span class="hljs-number">0</span>:
            <span class="hljs-keyword">break</span>
    chars.reverse()
    <span class="hljs-keyword">return</span> <span class="hljs-string">''</span>.join(chars)
<span class="copy-code-btn">复制代码</span></code></pre>
<p>62进制转10进制python实现代码如下：</p>
<pre><code class="hljs language-python copyable" lang="python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">chars_to_10int</span>(<span class="hljs-params">chars</span>):</span>
    rv = <span class="hljs-number">0</span>
    <span class="hljs-keyword">for</span> c <span class="hljs-keyword">in</span> chars:
        rv = rv * <span class="hljs-number">62</span> + map_to_10[c] // 上面生成的<span class="hljs-number">62</span>进制字符转<span class="hljs-number">10</span>进制数字的<span class="hljs-built_in">map</span>
    <span class="hljs-keyword">return</span> rv
<span class="copy-code-btn">复制代码</span></code></pre>
<h4 data-id="heading-9"></h4>
<h4 data-id="heading-10">4.短链生成</h4>
<p>短链生成接口的调用场景：运营在管理后台填上要转换的h5，调用短链生成接口，如果这条长链接没有人生成过短链，则往数据库插入一条记录，并通过其ID构造短链；若已经有人生成过，则用生成好的ID构建短链。
伪代码如下：</p>
<pre><code class="hljs language-python copyable" lang="python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">generate_short_url</span>(<span class="hljs-params">url</span>):</span>
    <span class="hljs-keyword">try</span>:
        <span class="hljs-built_in">id</span> = insert(url) // 尝试写入
    <span class="hljs-keyword">except</span> DuplicateKeyError:
        <span class="hljs-built_in">id</span> = find_by_url(url) // 这个错误说明唯一索引冲突了，也就是已经插入过了，直接查<span class="hljs-built_in">id</span>即可
        
    short_id = int_to_62chars(<span class="hljs-built_in">id</span>) // 上面实现的<span class="hljs-number">10</span>进制数字转<span class="hljs-number">62</span>进制字符的函数
    <span class="hljs-keyword">return</span> short_domain + <span class="hljs-string">'/'</span> + short_id
<span class="copy-code-btn">复制代码</span></code></pre>
<p>​</p>
<h4 data-id="heading-11">5.短链还原</h4>
<p>用户点击短链接之后，服务端将短链ID转化为数据库的ID，再从mysql查出长链接，然后302重定向到长链接即可。伪代码如下：</p>
<pre><code class="hljs language-python copyable" lang="python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">parse_short_url</span>(<span class="hljs-params">short_id</span>):</span>
    <span class="hljs-built_in">id</span> = chars_to_10int(short_id) // 前面实现的<span class="hljs-number">62</span>进制字符串转<span class="hljs-number">10</span>进制数字
    url = find(<span class="hljs-built_in">id</span>) // 查数据库获取长链接
    redirect(url)   // <span class="hljs-number">302</span>重定向 
<span class="copy-code-btn">复制代码</span></code></pre>
<h2 data-id="heading-12">总结分析</h2>
<h4 data-id="heading-13">优点</h4>
<ol>
<li>这个实现非常简单，依赖的东西非常少，只需要一个mysql，且数据库库表也很简单</li>
<li>短链还原的时候只需执行一次mysql查询，考虑到实际业务场景中，很多人会同时查一个短链，考虑到Mysql的内存缓存，Mysql的性能应该是非常好的。预估几千qps的查询量完全无压力。</li>
</ol>
<h4 data-id="heading-14">缺点</h4>
<ol>
<li>查询量太大的话一台mysql不够（但是这一点其实大多情况下也遇不到）</li>
<li>由于是主键ID构造的短链，所以是可以猜出全部url的，但是这个其实是否重要要看场景，比如frank碰到的场景就无所谓。</li>
</ol>
<h4 data-id="heading-15">总评</h4>
<p>这个实现无疑是一个成本非常低的短链系统，但是对于大多数公司来说也完全够用了，我们在实际工作中一定要结合实际业务场景来设计系统，不能盲目投入资源做一个非常牛逼但不实用的系统。</p>
<blockquote>
<p><strong>旧文推荐</strong>：</p>
<ol>
<li><a href="https://juejin.cn/post/6956044823971233806" target="_blank">微信小程序又双叒叕改重要接口了！</a></li>
<li><a href="https://juejin.cn/post/6959461587044925454" target="_blank">微信标准版交易组件使用入门</a></li>
<li><a href="https://juejin.cn/post/6959904658097700878" target="_blank">如何利用小程序广告赚钱？</a></li>
</ol>
</blockquote>
<p>PS： 欢迎关注我的<a href="https://wxop-pic.0-1-byte.com/byte01/web_link/index.html#/?link_id=60acb2d65f9cac78bd74a1a7&account_id=1&target_link=https%3A%2F%2Fbytemall.0-1-byte.com%2Fadmin%2Findex.html" target="_blank" rel="nofollow noopener noreferrer">商城项目</a>, <a href="https://github.com/frank-say/bytemall" target="_blank" rel="nofollow noopener noreferrer">Github</a>, <a href="https://gitee.com/frank-say/bytemall" target="_blank" rel="nofollow noopener noreferrer">Gitee</a></p></div>  
</div>
            