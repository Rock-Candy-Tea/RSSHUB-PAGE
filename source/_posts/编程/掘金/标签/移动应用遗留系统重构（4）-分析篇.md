
---
title: '移动应用遗留系统重构（4）-分析篇'
categories: 
 - 编程
 - 掘金
 - 标签
headimg: 'https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ef9a448908e64747bd7d43df1777a006~tplv-k3u1fbpfcp-zoom-1.image'
author: 掘金
comments: false
date: Sun, 11 Apr 2021 17:35:02 GMT
thumbnail: 'https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ef9a448908e64747bd7d43df1777a006~tplv-k3u1fbpfcp-zoom-1.image'
---

<div>   
<div class="markdown-body"><style>.markdown-body&#123;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333&#125;.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6&#123;line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px&#125;.markdown-body h1&#123;font-size:30px;margin-bottom:5px&#125;.markdown-body h2&#123;padding-bottom:12px;font-size:24px;border-bottom:1px solid #ececec&#125;.markdown-body h3&#123;font-size:18px;padding-bottom:0&#125;.markdown-body h4&#123;font-size:16px&#125;.markdown-body h5&#123;font-size:15px&#125;.markdown-body h6&#123;margin-top:5px&#125;.markdown-body p&#123;line-height:inherit;margin-top:22px;margin-bottom:22px&#125;.markdown-body img&#123;max-width:100%&#125;.markdown-body hr&#123;border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px&#125;.markdown-body code&#123;word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em&#125;.markdown-body code,.markdown-body pre&#123;font-family:Menlo,Monaco,Consolas,Courier New,monospace&#125;.markdown-body pre&#123;overflow:auto;position:relative;line-height:1.75&#125;.markdown-body pre>code&#123;font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8&#125;.markdown-body a&#123;text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff&#125;.markdown-body a:active,.markdown-body a:hover&#123;color:#275b8c&#125;.markdown-body table&#123;display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6&#125;.markdown-body thead&#123;background:#f6f6f6;color:#000;text-align:left&#125;.markdown-body tr:nth-child(2n)&#123;background-color:#fcfcfc&#125;.markdown-body td,.markdown-body th&#123;padding:12px 7px;line-height:24px&#125;.markdown-body td&#123;min-width:120px&#125;.markdown-body blockquote&#123;color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8&#125;.markdown-body blockquote:after&#123;display:block;content:""&#125;.markdown-body blockquote>p&#123;margin:10px 0&#125;.markdown-body ol,.markdown-body ul&#123;padding-left:28px&#125;.markdown-body ol li,.markdown-body ul li&#123;margin-bottom:0;list-style:inherit&#125;.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item&#123;list-style:none&#125;.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul&#123;margin-top:0&#125;.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul&#123;margin-top:3px&#125;.markdown-body ol li&#123;padding-left:6px&#125;.markdown-body .contains-task-list&#123;padding-left:0&#125;.markdown-body .task-list-item&#123;list-style:none&#125;@media (max-width:720px)&#123;.markdown-body h1&#123;font-size:24px&#125;.markdown-body h2&#123;font-size:20px&#125;.markdown-body h3&#123;font-size:18px&#125;&#125;</style><h1 data-id="heading-0">前言</h1>
<p>上一篇<a href="https://juejin.cn/post/6947855094272491556" target="_blank">移动应用遗留系统重构（3）-示例篇</a>我们介绍了CloudDisk的业务及代码现状。分享了“理想”（未来的架构设计）与“现实”（目前的代码现状），接下来在我们开始动手进行重构时，我们首先得知道往理想的设计架构演化，中间存在多少问题。一方面作为开始重构的输入，另外一方面我们有数据指标，也能更好评估工作量及衡量进度。</p>
<p>接下来我们将根据架构篇团队采用的架构设计，结合目前的代码，总结分析工具及方法。</p>
<h1 data-id="heading-1">架构设计</h1>
<p>我们先回忆一下<a href="https://juejin.cn/post/6945313969556946980" target="_blank">架构篇</a>里团队采用的架构设计。</p>
<p><img alt class="lazyload" src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ef9a448908e64747bd7d43df1777a006~tplv-k3u1fbpfcp-zoom-1.image" data-width="800" data-height="600" referrerpolicy="no-referrer"></p>
<ol>
<li>代码复用</li>
</ol>
<ul>
<li>公共能力复用，有一层专门统一管理应用公用的基础能力，如图片、网络、存储能力、安全等</li>
<li>公用业务能力复用，有一层专门统一管理应用的业务通用组件，如分享、推送、登录等</li>
</ul>
<ol start="2">
<li>低耦合</li>
</ol>
<ul>
<li>业务模块间通过API方式依赖，不依赖具体的模块实现</li>
<li>依赖方向清晰，上层模块依赖下层模块</li>
</ul>
<ol start="3">
<li>并行研发</li>
</ol>
<ul>
<li>业务模块支持独立编译调试</li>
<li>业务模块独立发布</li>
</ul>
<p>结合该4层架构、已有的代码，以及业务的后续演化，团队设计的新架构如下</p>
<p><img alt class="lazyload" src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ee03da85960a4f719d42bbfe7faa24d5~tplv-k3u1fbpfcp-zoom-1.image" data-width="800" data-height="600" referrerpolicy="no-referrer"></p>
<h1 data-id="heading-2">分析工具</h1>
<h2 data-id="heading-3"><a href="https://www.archunit.org/" target="_blank" rel="nofollow noopener noreferrer">ArchUnit</a></h2>
<p>有了架构设计后，我们就能识别代码的边界，这里我们可以通过<a href="https://www.archunit.org/" target="_blank" rel="nofollow noopener noreferrer">Archunit</a>进行边界约束描述。我们可以得到2条通用的守护规则。</p>
<ol>
<li>垂直方向，下层模块不能反向依赖上层</li>
<li>横向方向，组件之间不能存在相互的依赖</li>
</ol>
<p>转化为ArchUnit的测试用例如下:</p>
<pre><code class="hljs language-java copyable" lang="java">  <span class="hljs-meta">@ArchTest</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> ArchRule architecture_layer_should_has_right_dependency =layeredArchitecture()
            .layer(<span class="hljs-string">"Library"</span>).definedBy(<span class="hljs-string">"..cloud.disk.library.."</span>)
            .layer(<span class="hljs-string">"PlatForm"</span>).definedBy(<span class="hljs-string">"..cloud.disk.platform.."</span>)
            .layer(<span class="hljs-string">"FileBundle"</span>).definedBy(<span class="hljs-string">"..cloud.disk.bundle.file.."</span>)
            .layer(<span class="hljs-string">"DynamicBundle"</span>).definedBy(<span class="hljs-string">"..cloud.disk.bundle.dynamic.."</span>)
            .layer(<span class="hljs-string">"UserBundle"</span>).definedBy(<span class="hljs-string">"..cloud.disk.bundle.user.."</span>)
            .layer(<span class="hljs-string">"AllBundle"</span>).definedBy(<span class="hljs-string">"..cloud.disk.bundle.."</span>)
            .layer(<span class="hljs-string">"App"</span>).definedBy(<span class="hljs-string">"..cloud.disk.app.."</span>)
            .whereLayer(<span class="hljs-string">"App"</span>).mayOnlyBeAccessedByLayers()
            .whereLayer(<span class="hljs-string">"FileBundle"</span>).mayOnlyBeAccessedByLayers(<span class="hljs-string">"App"</span>)
            .whereLayer(<span class="hljs-string">"DynamicBundle"</span>).mayOnlyBeAccessedByLayers(<span class="hljs-string">"App"</span>)
            .whereLayer(<span class="hljs-string">"UserBundle"</span>).mayOnlyBeAccessedByLayers(<span class="hljs-string">"App"</span>)
            .whereLayer(<span class="hljs-string">"PlatForm"</span>).mayOnlyBeAccessedByLayers(<span class="hljs-string">"App"</span>,<span class="hljs-string">"AllBundle"</span>)
            .whereLayer(<span class="hljs-string">"Library"</span>).mayOnlyBeAccessedByLayers(<span class="hljs-string">"App"</span>,<span class="hljs-string">"AllBundle"</span>,<span class="hljs-string">"PlatForm"</span>);
<span class="copy-code-btn">复制代码</span></code></pre>
<p>当然这个用例的执行是失败的，因为我们基本的包结构还没有调整。但有了架构守护测试用例，我们就可以逐步把代码移动到对应的Package中，直到守护用例运行通过为止。</p>
<p>接下来我们先运用IDE工具进行基础的包结构调整，调整后的结构如下</p>
<p><img alt class="lazyload" src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1e62dd4db6a14118a4900a3ac34d774f~tplv-k3u1fbpfcp-zoom-1.image" data-width="800" data-height="600" referrerpolicy="no-referrer"></p>
<p>调整后运行ArchUnit测试运行结果如下
<img alt class="lazyload" src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1706451a359646c19b2a4ef4cb0e1daf~tplv-k3u1fbpfcp-zoom-1.image" data-width="800" data-height="600" referrerpolicy="no-referrer"></p>
<p>这些异常的提示就是我们需要处理的异常依赖。但是ArchUnit的这个提示比较不不友好，接下来我们介绍另外一种分析异常依赖的方式，使用Intellij Dependencies 。</p>
<h2 data-id="heading-4">Intellij Dependencies</h2>
<p>我们选择对应的Package，选择Analyze菜单，点击Dependencies，可以找出该Package所依赖的相关类。
<img alt class="lazyload" src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5b56ef5706064b22b44a559b4bd71ac5~tplv-k3u1fbpfcp-zoom-1.image" data-width="800" data-height="600" referrerpolicy="no-referrer"></p>
<p>我们选择dynamic Package进行分析后，发现根据现有的架构约束，存在横向的Bundle依赖需要进行解除依赖。</p>
<p><img alt class="lazyload" src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e0c6ff5913084b3cba7061bdbdbe56c1~tplv-k3u1fbpfcp-zoom-1.image" data-width="800" data-height="600" referrerpolicy="no-referrer"></p>
<p>我是在实际重构过程中，我们可以频繁借助该功能验证耦合解除情况，并且同时通过ArchUnit测试做好守护。</p>
<p><strong>详细代码见<a href="https://github.com/junbin1011/CloudDisk/commit/d4b81762177b3a5e38d9d622170786540bcc7478" target="_blank" rel="nofollow noopener noreferrer">Cloud Disk</a></strong></p>
<h1 data-id="heading-5">总结</h1>
<p>这一篇我们分享了如何借助工具进行异常依赖的分析。当我们有了未来的架构设计后，可以借助ArchUnit进行架构测试守护，通过Intellij的Dependendencies 我们可以方便以Package或者Class为单位进行依赖分析。</p>
<p>当我们已经分析出需要处理的异常依赖，接下来我们就可以逐步进行重构。下一篇，我们将给大家分享实践总结的一些重构套路，移动应用遗留系统重构（5）- 重构方法篇。</p>
<h1 data-id="heading-6">系列链接</h1>
<p><a href="https://juejin.cn/post/6943470229905211422" target="_blank">移动应用遗留系统重构（1）- 开篇</a></p>
<p><a href="https://juejin.cn/post/6945313969556946980" target="_blank">移动应用遗留系统重构（2）-架构篇</a></p>
<p><a href="https://juejin.cn/post/6947855094272491556" target="_blank">移动应用遗留系统重构（3）-示例篇</a></p>
<h1 data-id="heading-7">大纲</h1>
<p><img alt class="lazyload" src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7ce59f00952e40989e04cd61a421e4f1~tplv-k3u1fbpfcp-zoom-1.image" data-width="800" data-height="600" referrerpolicy="no-referrer"></p>
<h1 data-id="heading-8">关于</h1>
<p><strong>欢迎关注CAC敏捷教练公众号</strong>。微信搜索：<strong>CAC敏捷教练</strong>。</p>
<ul>
<li>作者：黄俊彬</li>
<li><a href="https://junbin.tech/" target="_blank" rel="nofollow noopener noreferrer">博客：junbin.tech</a></li>
<li><a href="https://github.com/junbin1011" target="_blank" rel="nofollow noopener noreferrer">GitHub: junbin1011 </a></li>
<li><a href="https://www.zhihu.com/people/junbin-9-77" target="_blank" rel="nofollow noopener noreferrer">知乎: @JunBin</a></li>
</ul></div> <div class="image-viewer-box" data-v-78c9b824><!----></div>  
</div>
            