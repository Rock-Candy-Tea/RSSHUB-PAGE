
---
title: '「论道架构师」拒绝无脑搬砖，从分库分表开始'
categories: 
 - 编程
 - 掘金
 - 标签
headimg: 'https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/75647bbe02aa476385ba6e65e210fc73~tplv-k3u1fbpfcp-watermark.image'
author: 掘金
comments: false
date: Tue, 06 Jul 2021 19:47:49 GMT
thumbnail: 'https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/75647bbe02aa476385ba6e65e210fc73~tplv-k3u1fbpfcp-watermark.image'
---

<div>   
<div class="markdown-body"><style>.markdown-body&#123;color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%&#125;.markdown-body p&#123;color:#595959;font-size:15px;line-height:2;font-weight:400&#125;.markdown-body p+p&#123;margin-top:16px&#125;.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6&#123;padding:30px 0;margin:0;color:#135ce0&#125;.markdown-body h1&#123;position:relative;text-align:center;font-size:22px;margin:50px 0&#125;.markdown-body h1:before&#123;position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)&#125;.markdown-body h2&#123;position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0&#125;.markdown-body h3&#123;font-size:16px&#125;.markdown-body ul&#123;list-style:disc outside;margin-left:2em;margin-top:1em&#125;.markdown-body li&#123;line-height:2;color:#595959&#125;.markdown-body img.loaded&#123;margin:0 auto;display:block&#125;.markdown-body blockquote&#123;background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5&#125;.markdown-body blockquote p&#123;color:#666;line-height:2&#125;.markdown-body a&#123;color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none&#125;.markdown-body em strong,.markdown-body strong&#123;color:#036aca&#125;.markdown-body hr&#123;border-top:1px solid #135ce0&#125;.markdown-body pre&#123;overflow:auto&#125;.markdown-body code,.markdown-body pre&#123;overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace&#125;.markdown-body pre>code&#123;font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8&#125;.markdown-body code&#123;word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em&#125;.markdown-body table&#123;border-collapse:collapse;margin:1rem 0;overflow-x:auto&#125;.markdown-body table td,.markdown-body table th&#123;border:1px solid #dfe2e5;padding:.6em 1em&#125;.markdown-body table tr&#123;border-top:1px solid #dfe2e5&#125;.markdown-body table tr:nth-child(2n)&#123;background-color:#f6f8fa&#125;</style><h1 data-id="heading-0">「论道架构师」拒绝无脑搬砖，从分库分表开始</h1>
<blockquote>
<p>⚠️本文为掘金社区首发签约文章，未获授权禁止转载</p>
</blockquote>
<br>
<h2 data-id="heading-1">事件起因</h2>
<p>6月初我负责的商家数据某功能由于业务原因导致数据量不断上涨，当时使用的MySQL单表已经难以提供高效的查询，因此基于商家维度（商家主键ID）对它进行了分表，问题得以解决。</p>
<p>6月中旬我沉浸在无止尽的需求之中，边做边发出感慨：<strong>进大厂又能怎么样呢，还不是CRUD，面试造火箭罢了</strong>。</p>
<p>此时，架构师笑了笑，于是乎有了本篇文章。</p>
<br>
<h2 data-id="heading-2">我的方式：取模水平分割</h2>
<p>亮架构：说一下你上次分表的实现方案吧，Kerwin。</p>
<p>我：我是参照其他系统的方式进行的，利用<code>商家主键Id（商家系统自增的Long型主键）</code>对100取模，由此计算出它应该落在哪一张表，唯一的变动就是这个环节以及数据迁移了。</p>
<p>大概思路如下：</p>
<pre><code class="hljs language-java copyable" lang="java"><span class="hljs-comment">// 业务层代码...</span>
String tableName = <span class="hljs-string">"orgcode_datas_"</span> + orgcode % <span class="hljs-number">100</span>;
String insertUserSql = <span class="hljs-string">"INSERT INTO "</span> + tableName + <span class="hljs-string">" VALUES ('"</span> ... <span class="hljs-string">"');"</span>;
<span class="copy-code-btn">复制代码</span></code></pre>
<p>亮架构：所以你采用的就是最简单的方式，而且还把<strong>取模逻辑</strong>耦合在了业务层吗？</p>
<p>我：是啊，其他系统也都是这么做的，这样搞最快，最安全。</p>
<p>亮架构：你的系统用的是<strong>MyBatis</strong>对吧，你稍微调研一下就知道，我们可以借助<strong>MyBatis的拦截器实现刚刚业务代码中耦合取模的那部分逻辑</strong>，虽然本质上没有高明多少，但让它的数据操作底层变得更加清晰明了了，这不就是一种进步吗？</p>
<p>我（略感羞愧）：你说的有道理，回去我研究研究。</p>
<p>亮架构：再来看另一个问题，你说了这次分表涉及到数据迁移，你现在分了100个表，万一以后还不够用怎么办？难道要再全部迁移一遍吗？</p>
<p>我（非常羞愧）：啊这个，应该不会不够用吧...</p>
<br>
<h2 data-id="heading-3">一致性哈希方案</h2>
<p>亮架构：Kerwin，你面试的时候有没有被问到过<strong>Redis的一致性哈希问题</strong>？</p>
<p>我（来劲了）：有，Redis中引入了<strong>一致性Hash算法</strong>。该算法<strong>对2^32 取模，将Hash值空间组成虚拟的圆环</strong>，整个圆环按<strong>顺时针</strong>方向组织，每个节点依次为0、1、2...2^32-1，之后将每个服务器进行Hash运算，确定服务器在这个Hash环上的地址，确定了服务器地址后，对数据使用同样的Hash算法，将数据定位到特定的Redis服务器上。如果定位到的地方没有Redis服务器实例，则继续顺时针寻找，找到的第一台服务器即该数据最终的服务器位置。</p>
<p>相关文章：<a href="https://juejin.cn/post/6857667542652190728" target="_blank" title="https://juejin.cn/post/6857667542652190728">「查缺补漏」巩固你的Redis知识体系（笑）</a></p>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/75647bbe02aa476385ba6e65e210fc73~tplv-k3u1fbpfcp-watermark.image" alt="image-20210704155443807.png" loading="lazy" referrerpolicy="no-referrer"></p>
<p>亮架构：Redis的这个知识点你知道，MySQL的你就不知道了？如果我让你把简单取模法更换为一致性哈希方案，你该怎么做？</p>
<p>我（忐忑）：如果参考Redis的话，我会这么做：</p>
<ol>
<li>从表的命名开始，尽量取名为取模后相对均匀的名称，不以连续后缀结尾了</li>
<li>我需要找一个碰撞相对较少的哈希算法</li>
<li>取模的逻辑需要修改为两步，首先是建立<strong>数据表</strong>落点（即上图中的蓝球）并存储，再计算<strong>数据</strong>的落点（即红球），然后动态的计算它应该归属到哪一张表即可</li>
</ol>
<p>亮架构：差不多，命名的部分可以再思考思考，但是你知道你这么做会遇到什么问题吗？提示：和Redis一样的问题。</p>
<p>我（信心满满）：这个我知道，可能会出现<strong>数据过于集中</strong>的问题，这是由于数据和服务器分布不均匀导致的，例如上图中的情况，<strong>归属到一号服务器（顺时针第一个蓝球）的概率太大了</strong>，这个简单，我们只需要增加虚拟节点，或者从命名上考虑让它尽量平铺，均匀就好啦。</p>
<p>亮架构：孺子可教也，你说说看，这个方式和你刚刚的方式耗费的精力，优劣对比吧。</p>
<p>我（不好意思）：从精力上讲，一致性哈希方案多了一步二次计算位置的动作，但是按您说的，如果我们在拦截器中去实现这一步动作的话，整体都是无感知的，只是多了一个方法而已，而从扩展性来讲，那就好多了，无论是增加节点还是减少节点，我们只需要迁移的对应的数据节点即可。</p>
<blockquote>
<p>Tips：如下图中，如果我们增加了第四个服务器节点，第四个服务器节点的数据来源只可能是第一个服务器节点</p>
</blockquote>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b13e6bdfb1644ca5bbba997d854398ea~tplv-k3u1fbpfcp-watermark.image" alt="image-20210704162853406.png" loading="lazy" referrerpolicy="no-referrer"></p>
<br>
<h2 data-id="heading-4">Range方式分表</h2>
<p>亮架构：那我再考考你，假如让你去订单组，对订单快照或者说订单流水进行分表，你怎么做？</p>
<p>我（思考状）：订单流水信息有一个<strong>明显的不同点在于它的主键Id是一个真正的无意义自增长整型</strong>，刚才提到的方式是可行且通用的，但是针对这种特殊场景，我会采用分段分表的方式，比如 1 - 100万为表1，100万01到200万为表2，以此类推，反正这个表只有插入和按Id查询，至于按订单人查询的功能，其他模块就满足了，不用我考虑。</p>
<p>我（瞬间反应过来）：不对啊，那订单流水Id基于什么获取呢？我们都要分表了，难道用自增Id？</p>
<p>亮架构：你能想到这一点还挺好的，现在有很多分布式算法都可以解决这种问题，比如Twitter的分布式自增ID算法（Snowflake）、Redis的incr命令、百度的uid-generator算法等等，很好，你也有一点程序员的样子了，知道反问了。</p>
<br>
<h2 data-id="heading-5">把上述知识总结抽象，你能得到什么？</h2>
<p>亮架构：<strong>你刚才提到了很关键的一点，你说你之所以用最简单的水平分割方式去处理，是因为其他系统的代码也都是这么写的？</strong></p>
<p>我：是的，所以我就把它们复制粘贴，改了一下。</p>
<p>亮架构：OK，你看，无论是简单的水平取模方式，还是一致性哈希，亦或是Range方式，它的本质都是：<code>SQL解析 =》SQL重写 =》 路由 =》 数据库执行 =》 结果返回</code>，</p>
<p>不同点在于，几个方案的路由策略不一样而已，你把这些东西抽象成可配置化的解决方案，放到咱们的Lib库中，以后别人再用的时候是不是就没那么麻烦了？</p>
<p>我：是的，既省时间，又省精力，只要咱们都用的是Mybatis和MySQL就行。</p>
<p>亮架构（扶额）：你再想想...</p>
<p>我（思考状）：对，是我狭隘了，我们刚刚所说的策略根本不用在乎是什么数据库，是什么ORM框架，无论是MongoDB也好，MySQL也罢，它真正的流程就那么几步，我只需要依赖Spring体系，获取到数据库连接信息，然后重写SQL为它分配路由即可。</p>
<p>亮架构（笑了笑，起身走了）：<strong>孺子可教也，你还觉得每天都是CRUD了吗？明明有一个研究和学习的机会放在你的面前，是你自己选择了最简单的方式，因为你既追求速度，又害怕出问题，所以你用了和前人一样的方式来解决这个问题，工作中很难遇到造火箭的机会，但是造个自行车，哪怕是车轮，也是挺好的吧，认真学习，以后要抓住机会啊。</strong></p>
<p>我看着架构师远去的背影，心中无比的激动，感谢他把本可以摸鱼的时间拿来教导我（手动狗头🤪）。</p>
<br>
<h2 data-id="heading-6">最后</h2>
<p>推荐另一篇具有 “设计” 思想的文章：<a href="https://juejin.cn/post/6905896943080177671" target="_blank" title="https://juejin.cn/post/6905896943080177671">「奇淫技巧」如何写最少的代码</a></p>
<p>如果你觉得这篇内容对你有帮助的话：</p>
<ol>
<li>当然要点赞支持一下啦~</li>
<li>另外，可以搜索并关注公众号「<strong>是Kerwin啊</strong>」，一起在技术的路上走下去吧~ 😋</li>
</ol></div>  
</div>
            