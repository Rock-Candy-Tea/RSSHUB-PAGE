
---
title: '好家伙，成都核酸检测系统 出问题了？'
categories: 
 - 编程
 - 掘金
 - 标签
headimg: 'https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/59b282f6898643e394e056d95d7f2de0~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp?'
author: 掘金
comments: false
date: Sat, 03 Sep 2022 16:51:16 GMT
thumbnail: 'https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/59b282f6898643e394e056d95d7f2de0~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp?'
---

<div>   
<div class="markdown-body cache"><style>.markdown-body&#123;color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%&#125;.markdown-body p&#123;color:#595959;font-size:15px;line-height:2;font-weight:400&#125;.markdown-body p+p&#123;margin-top:16px&#125;.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6&#123;padding:30px 0;margin:0;color:#135ce0&#125;.markdown-body h1&#123;position:relative;text-align:center;font-size:22px;margin:50px 0&#125;.markdown-body h1:before&#123;position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)&#125;.markdown-body h2&#123;position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0&#125;.markdown-body h3&#123;font-size:16px&#125;.markdown-body ul&#123;list-style:disc outside;margin-left:2em;margin-top:1em&#125;.markdown-body li&#123;line-height:2;color:#595959&#125;.markdown-body img.loaded&#123;margin:0 auto;display:block&#125;.markdown-body blockquote&#123;background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5&#125;.markdown-body blockquote p&#123;color:#666;line-height:2&#125;.markdown-body a&#123;color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none&#125;.markdown-body em strong,.markdown-body strong&#123;color:#036aca&#125;.markdown-body hr&#123;border-top:1px solid #135ce0&#125;.markdown-body pre&#123;overflow:auto&#125;.markdown-body code,.markdown-body pre&#123;overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace&#125;.markdown-body pre>code&#123;font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8&#125;.markdown-body code&#123;word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em&#125;.markdown-body table&#123;border-collapse:collapse;margin:1rem 0;overflow-x:auto&#125;.markdown-body table td,.markdown-body table th&#123;border:1px solid #dfe2e5;padding:.6em 1em&#125;.markdown-body table tr&#123;border-top:1px solid #dfe2e5&#125;.markdown-body table tr:nth-child(2n)&#123;background-color:#f6f8fa&#125;</style><p>我正在参与掘金创作者训练营第6期，<a href="https://juejin.cn/post/7134166674160222221/" title="https://juejin.cn/post/7134166674160222221/" target="_blank">点击了解活动详情</a></p>
<h1 data-id="heading-0">序</h1>
<p>昨天下午 看到东软的 之前朋友 群发朋友圈，把我朋友圈刷屏了。。。。这是发生了什么，看这个截图 是东软 解释 健康码 核酸系统的问题 和自己无关。。。哎</p>
<p>去看看怎么回事，可是我不在成都啊，问问朋友 发生了什么，走起</p>
<h1 data-id="heading-1">声明</h1>
<p><strong>纯从 百度的来的消息，一切都是猜想 具体事情请看官方通知，本文章主要说 健康码技术的猜想, 不涉及其他的</strong></p>
<h1 data-id="heading-2">目前了解到的</h1>
<p>消息来源不一定正确</p>
<h2 data-id="heading-3">百度信息</h2>
<p>9月2日晚间，成都“天府健康通”的核酸系统出现“卡死”情况，导致信息登记、核酸检测采集等无法正常进行。现场的医护人员尝试各种办法，试图解决“网络信号”或“核酸检测系统”的问题。</p>
<p>　　据悉，成都市的“全场景疫情病原体检测信息系统”由<a href="https://link.juejin.cn/?target=http%3A%2F%2Fquote.eastmoney.com%2Funify%2Fr%2F1.600718" target="_blank" rel="nofollow noopener noreferrer" title="http://quote.eastmoney.com/unify/r/1.600718" ref="nofollow noopener noreferrer">东软集团</a>股份有限公司开发上线。</p>
<p>　　9月3日，<a href="https://link.juejin.cn/?target=http%3A%2F%2Fquote.eastmoney.com%2Funify%2Fr%2F1.600718" target="_blank" rel="nofollow noopener noreferrer" title="http://quote.eastmoney.com/unify/r/1.600718" ref="nofollow noopener noreferrer">东软集团</a>及时发布官方声明称，成都疫情以来，为应对成都大规模检测并发的系统稳定性问题，东软核酸检测系统紧急上线并于9月2日凌晨4时投入使用。系统上线后，发现有响应延迟、卡顿等现象。据技术专家研判，上述现象与核酸检测系统软件无关。<a href="https://link.juejin.cn/?target=http%3A%2F%2Fquote.eastmoney.com%2Funify%2Fr%2F1.600718" target="_blank" rel="nofollow noopener noreferrer" title="http://quote.eastmoney.com/unify/r/1.600718" ref="nofollow noopener noreferrer">东软集团</a>称，具体网络故障的原因，相关部门正在排查。</p>
<h2 data-id="heading-4">核酸检测系统异常处置应对情况</h2>
<p><strong>核酸检测系统异常处置应对情况——专访成都市疫情防控指挥部相关负责人</strong></p>
<p>　　9月1日，成都市新型冠状病毒肺炎疫情防控指挥部发布《关于在全市开展全员核酸检测的通告》，决定自2022年9月1日至9月4日在全市范围内开展全员核酸检测。9月2日晚，核酸检测系统出现异常，导致采样排队时间过长，核酸检测进度缓慢，给市民群众带来困扰和不便。今日，记者就市民关心的问题，采访了成都市新型冠状病毒肺炎疫情防控指挥部相关负责同志。</p>
<p>　　1、昨晚全员核酸检测期间，核酸检测系统为什么出现异常情况？采取了哪些处置措施？</p>
<p>　　答：昨天下午至晚上，全市核酸检测系统出现异常情况，导致检测进度缓慢。雨夜风凉，群众长时间排队，一线检测人员辛苦坚守 ，我们感同身受、焦急万分、深感愧疚，诚恳接受社会批评，向全市人民表示最真诚的歉意，也感谢市民群众的充分理解和大力支持。</p>
<p>　　9月2日17时30分左右，成都市核酸检测系统因对短时超大并发量预估不足，导致系统出现卡顿问题。故障发生后，我们立即组织专业技术团队与承建商一起排查原因，积极抢修，<strong>系统在增加多台服务器、优化关键参数设置后逐步恢复</strong>，但还存在不确定性，我们正在努力加以解决。下一步，我市将采取错峰核酸检测采样、强化系统运行监控、加强问题响应等措施，努力保障核酸检测平稳顺利进行。</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/59b282f6898643e394e056d95d7f2de0~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp?" alt="image.png" loading="lazy" referrerpolicy="no-referrer"></p>
<h2 data-id="heading-5">东软声明</h2>
<p>和我们无关 ，是<strong>网络的事</strong></p>
<h2 data-id="heading-6">总结下</h2>
<p>因为 对短时高并发预估不足，没做好<strong>系统稳定性</strong>，没有应对<strong>临时高并发的承载能力</strong>导致的问题？</p>
<p>没有nginx 弹性扩容？</p>
<p>扩容 提高承载能力 解决的问题？</p>
<p><strong>一切是猜想，毕竟我们不是 现场的人，没有调查就没有发言权</strong></p>
<h1 data-id="heading-7">整理下</h1>
<p>其实 上面看下来 主要是2点</p>
<ol>
<li>网络的事</li>
<li>应对短时高并发的能力</li>
</ol>
<p>思考的时候 大概花了个图</p>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ed654939987f4c07bb73ac8c52c6bfe2~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp?" alt="image.png" loading="lazy" referrerpolicy="no-referrer"></p>
<h2 data-id="heading-8">网络的事</h2>
<p>干开发的都知道 有的时候系统临时上线，可能系统环境 都需要从头搭建，中间件也要搭建，网络不通 都是会发生的。</p>
<p>这个很正常，临时情况嘛</p>
<h2 data-id="heading-9">应对短时高并发的能力</h2>
<p>弹性扩缩容</p>
<ol>
<li>流量削峰</li>
<li>限流 <strong>通过减少请求频率来减轻服务器压力</strong></li>
<li>容错</li>
<li>降级 把不重要的服务暂时关闭，节省服务器资源，从而保证核心服务的正常运行</li>
<li>异步：客户抢购成功后立即返回响应，之后通过消息队列，异步处理后续步骤，如发短信、更新数据库等，从而缓解服务器峰值压力。</li>
<li>弹性扩缩容</li>
</ol>
<p>1 - 4 其实公司都应该有现成的解决方案，第6点 结合运维也ok。
对于码代码的可能 第五点 可能因为 我们是<strong>高并发的读</strong>，不是说链路太长，可以通过消息队列 减少响应时间，提高吞吐量。</p>
<p>异步 可以是 非阻塞异步的框架，</p>
<p>这里就不细说 <strong>响应式编程</strong>，只是给出一个大概的概念 和 性能比较 让大家有一个简单的了解</p>
<h1 data-id="heading-10">响应式编程之 Project Reactor</h1>
<p>传统服务端程序一般采用同步阻塞模型，通过分配更多线程来支撑更多请求，这符合常人思维模式，但在突发流量的情况下，同步模型可能会导致线程池耗尽，基于一个请求一个线程的服务模式无法做到动态伸缩。</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e3b7cb18adc7492cb0c352c7127047e2~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp" alt="0f1bdab84b4c7340348863025ca4c891.png" loading="lazy" referrerpolicy="no-referrer"></p>
<p>而异步编程的做法是基于一个共享的线程池，所有操作都是回调。如果遇到耗时的操作，线程并不会阻塞等待操作完成，而是会被释放回线程池中继续接受新的请求。等到耗时操作完成后（一般都是IO操作），通过消息机制重新向线程池申请线程恢复之前的请求代码。</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/95e29e78a5b840a9be4b21bf0871b429~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp" alt="34c056ef0c1cac25f7850b7a22e45e77.png" loading="lazy" referrerpolicy="no-referrer"></p>
<p>我们可以简单写个程序简单实验一下，实现相同逻辑：1. 查询 db 2. 查询外部系统 3. 组装信息返回。唯一区别是一个是同步调用的实现，另一个是采用完全异步的方式实现。</p>
<p>本地使用相同的 jmeter 参数模拟并发测试，得到结果如下，从左到右每列的含义分别为：请求名称、请求数目、失败请求数目、错误率(本次测试中出现错误的请求的数量/请求的总数)、平均响应时间、最短响应时间、最大响应时间、90%用户响应时间、95%用户响应时间、99%用户响应时间、吞吐量。</p>
<p>总体测试结果如下：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3a6cf5e3ecc54dbc8efc3b10d3390bb4~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp" alt="db47302ae2778e3c21958795c3288126.png" loading="lazy" referrerpolicy="no-referrer"></p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/dae831c9026c457ba3dcf0d9a0a8207c~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp" alt="a40ee4caf9c7fe3095c533e40fd0cb0a.png" loading="lazy" referrerpolicy="no-referrer"></p>
<p>同步代码测试结果</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2596f57a87f94766a3b0699539dddfe3~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp" alt="a3f99c4c400ddefc3b656e9b3dd55aba.png" loading="lazy" referrerpolicy="no-referrer"></p>
<p>异步代码测试结果</p>
<p>同步代码总共完成了 260 次请求，平均响应时间约 5 秒，因为阻塞程序耗尽了线程池导致程序出现了拒绝服务的情况，产生了 13% 的错误率。</p>
<p>异步代码整体吞吐量有明显提升，相同时间内完成了 3000 次请求。错误率为 0 ，并且整体没有出现拒绝服务的情况。</p>
<p>可以看到基于消息驱动机制的异步系统能极大提高资源利用率，提高系统的吞吐量。而响应式系统则在消息驱动的基础上增加了三个要求：及时响应性、回弹性和可扩展性。</p>
<p>简单来说具备以下四个特点的系统可以称为一个响应式系统：</p>
<ol>
<li>即时响应性，这个是响应式系统的核心目标。一个具有响应性的系统就是一个无论在什么情况下都能快速对客户的操作做出反馈的系统，包括事件、用户请求、失败场景，最终目的是保证客户良好的体验。</li>
<li>回弹性，指的是系统从故障灾难中恢复的能力。主要分两部分，一个是系统需要考虑失败的情况，二是系统要能从失败中恢复回来。</li>
<li>扩展性（弹性），指的是系统在不断变化的工作负载之下依然保持即时响应性。可扩展分为单机纵向扩展和横向线性扩展。这里主要指的是系统可以通过分片、复制等方式进行横向扩展，从而避免系统产生明显的性能瓶颈。</li>
<li>消息驱动的，这是响应式系统的基础。从上面异步系统的优势和原理分析可以看到，基于消息驱动的程序能最大化利用机器资源，同时松散耦合的设计创建了一个能让业务逻辑保持清洁的环境，显式的隔离失败有利于系统自动恢复。</li>
</ol>
<h1 data-id="heading-11">和 西安健康码 的思考</h1>
<p><strong>（西安 健康码当时的 主要问题</strong></p>
<p>1.<strong>限流问题</strong>：市民在长时间无法刷出健康码的情况下，多次退出刷新重试，新的流量到达服务器，导致服务器压力变大、承受负载增加，说明“西安一码通”系统没有做好限流措施。\</p>
<p>2. <strong>服务器问题</strong>：无论是企业和个人在租用服务器的时候都会受到峰值承受限制的，一旦超过服务器的承受能力，就会导致服务器瘫痪，应用程序暂停，网站无法访问。服务器是有峰值限制的，不可能承受无上限的并发能力。而造成服务器瘫痪的原因就是在同一段时间内，访问人数多，造成高流量的突进，超出了服务器的承受范围。</p>
<p>3. <strong>架构问题</strong>：“西安一码通”功能影响“核酸检测”服务，说明模块间从界面到数据调用互相影响，可能不是微服务架构。</p>
<p>4. <strong>性能过载</strong>：典型的性能过载场景，不论内部根因是数据库瓶颈点，还是网络链接数瓶颈点等等，外因都是因为过载导致。</p>
<h1 data-id="heading-12">共性的问题</h1>
<p>都是 短时高并发导致的</p>
<p><strong>页面优化</strong>：友好提醒用户耐心等待 ; 当出现不能显示查询结果的时候，为避免社会恐慌和公众猜测，应当在页面做出友好提示为宜，而不是“繁忙、无响应”等。</p>
<p><strong>访问节流</strong>：</p>
<ul>
<li>短时间内多次请求可做防抖机制；</li>
<li>核酸结果是24小时(或更长或更短)内不变，建议做缓存机制，24小时候间隔后再次访问强制刷新，接口可带时间戳参数；</li>
<li>非关键渲染数据延迟请求，即发起一个聚合接口请求来获取主体模块的数据，而非主体模块的数据则从另一个接口获取，通过拆分的手段来降低主接口的调用时延；静态页面使用 CDN</li>
<li>接口聚合，请求合并，减少并发；</li>
<li>减少接口通讯数据，传输的数据量越多，线程间通信的耗时越长，渲染速度就越慢；</li>
<li>剥离并建立异步无关联性并发请求；</li>
</ul>
<p><strong>压测要做好</strong></p>
<h1 data-id="heading-13">总结</h1>
<p>开发可能会遇到各种问题，其实<strong>时间和质量 真的没办法兼得</strong> 当然了具体事情我也不清楚，只是<strong>猜想</strong></p>
<h1 data-id="heading-14">思考题</h1>
<p>如果让你做一个省的健康码，你会怎么做，可以结合画图 看看你的落地能力，每个点需要什么资源？能支持多少并发？<strong>如果你想测试并发，你可以把代码写出来，我给你提供服务器，给你出性能测试报告</strong>。</p>
<p>都是一个 互相学习 一起成长的过程，慢慢完善，欢迎加入。wx yuyezhiji</p></div>  
</div>
            