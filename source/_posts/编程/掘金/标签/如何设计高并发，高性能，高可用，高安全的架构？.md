
---
title: '如何设计高并发，高性能，高可用，高安全的架构？'
categories: 
 - 编程
 - 掘金
 - 标签
headimg: 'https://picsum.photos/400/300?random=960'
author: 掘金
comments: false
date: Wed, 14 Apr 2021 02:03:29 GMT
thumbnail: 'https://picsum.photos/400/300?random=960'
---

<div>   
<div class="markdown-body"><style>.markdown-body&#123;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333&#125;.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6&#123;line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px&#125;.markdown-body h1&#123;font-size:30px;margin-bottom:5px&#125;.markdown-body h2&#123;padding-bottom:12px;font-size:24px;border-bottom:1px solid #ececec&#125;.markdown-body h3&#123;font-size:18px;padding-bottom:0&#125;.markdown-body h4&#123;font-size:16px&#125;.markdown-body h5&#123;font-size:15px&#125;.markdown-body h6&#123;margin-top:5px&#125;.markdown-body p&#123;line-height:inherit;margin-top:22px;margin-bottom:22px&#125;.markdown-body img&#123;max-width:100%&#125;.markdown-body hr&#123;border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px&#125;.markdown-body code&#123;word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em&#125;.markdown-body code,.markdown-body pre&#123;font-family:Menlo,Monaco,Consolas,Courier New,monospace&#125;.markdown-body pre&#123;overflow:auto;position:relative;line-height:1.75&#125;.markdown-body pre>code&#123;font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8&#125;.markdown-body a&#123;text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff&#125;.markdown-body a:active,.markdown-body a:hover&#123;color:#275b8c&#125;.markdown-body table&#123;display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6&#125;.markdown-body thead&#123;background:#f6f6f6;color:#000;text-align:left&#125;.markdown-body tr:nth-child(2n)&#123;background-color:#fcfcfc&#125;.markdown-body td,.markdown-body th&#123;padding:12px 7px;line-height:24px&#125;.markdown-body td&#123;min-width:120px&#125;.markdown-body blockquote&#123;color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8&#125;.markdown-body blockquote:after&#123;display:block;content:""&#125;.markdown-body blockquote>p&#123;margin:10px 0&#125;.markdown-body ol,.markdown-body ul&#123;padding-left:28px&#125;.markdown-body ol li,.markdown-body ul li&#123;margin-bottom:0;list-style:inherit&#125;.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item&#123;list-style:none&#125;.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul&#123;margin-top:0&#125;.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul&#123;margin-top:3px&#125;.markdown-body ol li&#123;padding-left:6px&#125;.markdown-body .contains-task-list&#123;padding-left:0&#125;.markdown-body .task-list-item&#123;list-style:none&#125;@media (max-width:720px)&#123;.markdown-body h1&#123;font-size:24px&#125;.markdown-body h2&#123;font-size:20px&#125;.markdown-body h3&#123;font-size:18px&#125;&#125;</style><h2 data-id="heading-0">高并发</h2>
<p>是一个容量的概念，服务可以接受的最大任务数量。根据二八定律（80/20定律）架构需要满足那部分20%的突发流量</p>
<ul>
<li>超时，重试，熔断，限流，双发，负载均衡，自动弹性伸缩</li>
<li>空间换时间（多级缓存架构-需考虑每层的命中率）</li>
<li>时间换空间 压缩（解决带宽问题）</li>
<li>异步</li>
<li>服务拆分+业务隔离</li>
<li>并行化</li>
</ul>
<h2 data-id="heading-1">高性能</h2>
<p>是一个速度的概念，单位时间内可以处理的任务数量</p>
<h3 data-id="heading-2">衡量的指标</h3>
<h4 data-id="heading-3">响应时间RT（Response Time）</h4>
<p>就是用户发出请求到收到响应数据的时间</p>
<ul>
<li>平均响应时间</li>
</ul>
<pre><code class="copyable">我们最常用的指标，即平均响应时间(AVG)，该指标能够体现服务接口的平均处理能力。
它的本质是把所有的请求耗时加起来，然后除以请求的次数。举个最简单的例子，
有10 个请求，其中有 2个1ms、3个5ms、5个10ms，那么它的平均耗时就是(2*1+3*5+5*10)/10=6.7ms。
除非服务在一段时间内出现了严重的问题，否则平均响应时间都会比较平缓。
因为高并发应用请求量都特别大，所以长尾请求的影响会被很快平均，
导致很多用户的请求变慢，但这不能体现在平均耗时指标中。
为了解决这个问题，另外一个比较常用的指标，就是百分位数(Percentile)。
<span class="copy-code-btn">复制代码</span></code></pre>
<ul>
<li>百分位数</li>
</ul>
<pre><code class="copyable">超过N%的请求都在X时间内返回。比如TP90=50ms，意思是超过90th的请求，都在50ms
内返回。我们一般分为 TP50、TP90、TP95、TP99、TP99.9等多个段，
对高百分位的值要求越高，对系统响应能力的稳定性要求越高，目标就是要干掉严重影响系统的长尾请求
<span class="copy-code-btn">复制代码</span></code></pre>
<h4 data-id="heading-4">并发数量</h4>
<p>就是系统同时能处理多少用户请求；针对响应时间进行设计，一般来说是万能的。因为响应时间减少，同一时间能够处理的请求必然会增加。值得注意的是，即使是一个秒杀系统，经过层层过滤处理，最终到达某个节点的并发数，也会比较小</p>
<h4 data-id="heading-5">吞吐量</h4>
<p>就是单位时间内系统处理的请求数量</p>
<h4 data-id="heading-6">秒开率</h4>
<p>通常而言，可以根据业务情况设定不同的页面打开标准，比如低于1 秒内的数据占比是秒开率。</p>
<ul>
<li>名词解释</li>
</ul>
<pre><code class="copyable">QPS（Queries Per Second）每秒查询的数量
TPS（Transactions Per Second 每秒事务的数量）
HPS（Http Per Second每秒的HTTP请求数量）

QPS=并发数/RT
并发数=QPS*RT

A服务同时调用B服务+C服务，QPS=2，TPS=1
单个接口请求，单机，QPS = TPS。
Throughput = (number of requests) / (total time) 
total time = 测试结束时间 - 测试开始时间 
测试结束时间 = MAX(请求开始时间 + Elapsed Time) 
测试开始时间 = MIN(请求开始时间) 

一般情况下，我们认为：
响应速度是串行执行的优化，通过优化执行步骤解决问题；
吞吐量是并行执行的优化，通过合理利用计算资源达到目标。
我们平常的优化主要侧重于响应速度，因为一旦响应速度提升了，那么整个吞吐量自然也会跟着提升。
但对于高并发的互联网应用来说，响应速度和吞吐量两者都需要。
这些应用都会标榜为高吞吐、高并发的场景，用户对系统的延迟忍耐度很差，
我们需要使用有限的硬件资源，从中找到一个平衡点。
<span class="copy-code-btn">复制代码</span></code></pre>
<h2 data-id="heading-7">高可用</h2>
<h3 data-id="heading-8">衡量手段</h3>
<p>7x24 小时无中断无异常的服务提供</p>



































<table><thead><tr><th>描述</th><th>N个9</th><th>可用性级别</th><th>年度停机时间</th></tr></thead><tbody><tr><td>基本可用</td><td>2个9</td><td>99%</td><td>87.6小时</td></tr><tr><td>较高可用</td><td>3个9</td><td>99.9%</td><td>8.8小时</td></tr><tr><td>具备自动恢复能力可用</td><td>4个9</td><td>99.99%</td><td>53分钟</td></tr><tr><td>极高可用</td><td>5个9</td><td>99.999%</td><td>5分钟</td></tr></tbody></table>
<h3 data-id="heading-9">优化手段</h3>
<pre><code class="copyable">冗余（机器（混合云），服务（无状态）），解决单点问题，解决脑裂问题。
故障切换。冷，热备份
限流，降级，熔断，弹性设计 
柔性化，兜底（获取通用商品不用个性化推荐，如果也没有可以读取一些静态文字进行展示，包容下一层的错误）
隔离（秒杀单独服务器）
应急预案，演练
自动化监控，告警（业务监控，硬件监控，服务监控（sql，调用次数，延迟，错误率），各个端监控，埋点监控）
同城多活(尽量同城，服务器延迟小)，异地多活，两地三中心
<span class="copy-code-btn">复制代码</span></code></pre>
<h2 data-id="heading-10">高安全</h2>
<h3 data-id="heading-11">前端代码安全：</h3>
<p>代码混淆，加入无关联代码，反调试</p>
<h3 data-id="heading-12">后端代码，服务器安全：</h3>
<p>服务器等级保护，风控，黑白名单，反爬虫，waf防火墙（Ddos），加密,
https HTTP2 http3
防刷、限量和防重，验证码，sql安全，社会工程学安全，地址隐藏</p>
<h3 data-id="heading-13">其它：</h3>
<p>办公室电脑人员，电脑，邮件，聊天工具消息往来安全，开发工具，中间件，弱口令</p>
<h2 data-id="heading-14">常用优化手段及思想</h2>
<pre><code class="copyable">尽早返回原则
第一段在用户和浏览器端，主要负责发出请求，及接受响应数据进行计算渲染显示给用户；
第二段在网络上，负责对请求数据、响应数据的传输；
第三段在网站服务器端，负责对请求数据进行处理（执行程序、访问数据库、文件等）并将结果返回

第一路径：
js，css压缩合并(varinish)，去除无用注释（基于安全考虑）
图片：有损格式用JPEG，无损格式用Webp格式
流媒体，静态资源走CDN，图片走适合大小
浏览器缓存，app缓存

第二路径：
带宽（即根据一次响应数据的大小，乘以PV数，除以对应的高峰时间段，从而大致估算出网站带宽的需求）
互联互通

第三路径：
代码最佳实践优化
业务流程最佳
异步，MQ
并行化，分而治之，无锁化编程，协程
文件静态化
应用层缓存，分布式缓存（多级缓存）
数据库优化（换商业数据库，分库分表，冷热数据分离，读写分离，NoSql-海量数据，NewSql，Hbase）
硬件升级（CPU、内存、带宽，SD磁盘阵列，服务器数量，机房，硬件负载）
高性能nginx，http2，http3,gzip/br以及参数优化
<span class="copy-code-btn">复制代码</span></code></pre>
<h2 data-id="heading-15">总结10年开发管理历程心得：</h2>
<pre><code class="copyable">面向失败设计，架构师要把自己当成一个悲观主义者，
需要在一开始的系统设计阶段就考虑各种失败以及被外部攻击场景，
把面向失败当成系统设计的一部分，随时有Plan A,Plan B。

世界上解决一个计算机问题最简单的方法:“恰好”不需要解决它。
可以通过优化业务流程，合理的设计来规避问题。

冗余思维（大部分问题都可以通过加一个中间层解决）
分治思维（将一个大任务拆分成很多个小的任务来解决）
空间时间互换思维
并发思维
设计模式思维
池化思维
悲观主义思维
<span class="copy-code-btn">复制代码</span></code></pre>
<h2 data-id="heading-16">参考：</h2>
<p><a href="https://blog.csdn.net/z69183787/article/details/105554908" target="_blank" rel="nofollow noopener noreferrer">blog.csdn.net/z69183787/a…</a>
<a href="https://www.cnblogs.com/kumufengchun/p/11065413.html" target="_blank" rel="nofollow noopener noreferrer">www.cnblogs.com/kumufengchu…</a>
<a href="https://blog.csdn.net/qq_37651267/article/details/93368908" target="_blank" rel="nofollow noopener noreferrer">blog.csdn.net/qq_37651267…</a>
<a href="https://juejin.cn/post/6844903701195276295" target="_blank">juejin.cn/post/684490…</a></p></div> <div class="image-viewer-box" data-v-78c9b824><!----></div>  
</div>
            