
---
title: '老板要我开发一个简单的工作流引擎'
categories: 
 - 编程
 - 掘金
 - — 标签
headimg: 'https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/57a5923187124e4cb11961404746df5c~tplv-k3u1fbpfcp-watermark.image'
author: 掘金
comments: false
date: Fri, 19 Mar 2021 18:53:32 GMT
thumbnail: 'https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/57a5923187124e4cb11961404746df5c~tplv-k3u1fbpfcp-watermark.image'
---

<div>   
<div class="markdown-body"><style>.markdown-body&#123;color:#383838;font-size:15px;line-height:37.5px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:120px&#125;.markdown-body ::selection&#123;color:#fff;background-color:#a862ea&#125;.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6&#123;margin:30px 0 15px;color:#a862ea&#125;.markdown-body h1&#123;line-height:2;font-size:1.4em&#125;.markdown-body h1~p:first-of-type:first-letter&#123;color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder&#125;.markdown-body h2&#123;font-size:1.2em&#125;.markdown-body h3&#123;font-size:1.1em&#125;.markdown-body ol,.markdown-body ul&#123;padding-left:2em&#125;.markdown-body ol li,.markdown-body ul li&#123;margin-bottom:0;padding-left:.2em&#125;.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item&#123;list-style:none&#125;.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul&#123;margin-top:0&#125;.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul&#123;margin-top:10px&#125;.markdown-body li::marker&#123;color:#a862ea&#125;.markdown-body li,.markdown-body p&#123;opacity:.9;vertical-align:baseline;transition:all .1s ease&#125;.markdown-body li:hover,.markdown-body p:hover&#123;opacity:1&#125;.markdown-body a&#123;display:inline-block;color:#a862ea;cursor:pointer;padding-bottom:2px;text-decoration:none;position:relative&#125;.markdown-body a:after&#123;content:"";position:absolute;width:98%;height:2px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out&#125;.markdown-body a:hover:after&#123;transform:scaleX(1);transform-origin:bottom left&#125;.markdown-body a:active,.markdown-body a:link&#123;color:#a862ea&#125;.markdown-body img&#123;max-width:100%;user-select:none;margin:1em 0;box-shadow:0 0 20px 0 #e7daff;transition:transform .2s ease 0s;background-color:#f8f5ff&#125;.markdown-body img:hover&#123;opacity:1;transform:translateY(-2px)&#125;.markdown-body blockquote&#123;padding:.5em 1em;margin:15px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:4px solid #a862ea;background-color:#f8f5ff&#125;.markdown-body blockquote>p&#123;margin:0&#125;.markdown-body code&#123;padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff&#125;.markdown-body pre&#123;margin:2em 0;box-shadow:0 0 20px #e7daff&#125;.markdown-body pre>code&#123;display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:22.5px;color:#383838;border-radius:3px;scroll-behavior:smooth&#125;.markdown-body pre>code::-webkit-scrollbar&#123;height:6px;background-color:#f8f5ff&#125;.markdown-body pre>code::-webkit-scrollbar-thumb&#123;background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px&#125;.markdown-body hr&#123;margin:2em 0;border-top:1px solid #a862ea&#125;.markdown-body table&#123;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse;border:1px solid #e7daff&#125;.markdown-body thead&#123;color:#a862ea;background:#f8f5ff&#125;.markdown-body td,.markdown-body th&#123;padding:1em .5em&#125;.markdown-body tr&#123;background-color:#fcfcfc&#125;@media (max-width:720px)&#123;.markdown-body&#123;font-size:12px&#125;&#125;</style><blockquote>
<p>公众号：<a href="https://t.1yb.co/jwkk" target="_blank" rel="nofollow noopener noreferrer">Java小咖秀</a>，网站：<a href="https://www.javaxks.com/" target="_blank" rel="nofollow noopener noreferrer">javaxks.com</a></p>
</blockquote>
<blockquote>
<p>作者 : MCTW ,链接: <a href="https://cnblogs.com/duck-and-duck/p/14436373.html" target="_blank" rel="nofollow noopener noreferrer">cnblogs.com/duck-and-du…</a></p>
</blockquote>
<blockquote>
<p>一天，老板找到我，说要做个简单的工作流引擎。 我查了一天啥是工作流，然后做出了如下版本： 按顺序添加任意个审批人组成一个链表，最后加一个结束节点 记录当前审批人，当审批完后，审批人向后移动一位</p>
</blockquote>
<h3 data-id="heading-0">第 1 关</h3>
<p>一天，老板找到我，说要做个简单的工作流引擎。</p>
<p>我查了一天啥是工作流，然后做出了如下版本：</p>
<p><img alt class="lazyload" src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/57a5923187124e4cb11961404746df5c~tplv-k3u1fbpfcp-watermark.image" data-width="800" data-height="600" referrerpolicy="no-referrer"></p>
<ul>
<li>按顺序添加任意个审批人组成一个链表，最后加一个结束节点</li>
<li>记录当前审批人，当审批完后，审批人向后移动一位</li>
<li>当审批人对应结束节点时，流程结束</li>
</ul>
<p>老板：简陋了点。</p>
<h3 data-id="heading-1">第 2 关</h3>
<p>老板又来了：要支持会签节点。</p>
<p>我又查了一天啥是会签节点，发现会签节点就是一个大节点，里面有很多审批人，当这个大节点里的所有人都审批通过后，才能进入下一个节点。</p>
<p>我想了一个星期，推翻了原来的链表式设计：</p>
<p><img alt="image.png" class="lazyload" src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e56e316760bb411e9f77c9a854c745c1~tplv-k3u1fbpfcp-watermark.image" data-width="800" data-height="600" referrerpolicy="no-referrer"></p>
<p>结构上我做了如下调整:</p>
<ul>
<li>把节点分为两大类：简单节点 (上图中长方形) 和复杂节点(上图中圆形)。</li>
<li>用一棵树表示整个流程，其中叶子节点都是简单节点，简单节点都是叶子节点。</li>
<li>每个简单节点里都有且仅有有一个审批人。</li>
<li>复杂节点包含若干个子节点。</li>
<li>加入会签节点: 会签节点激活后，所有的子节点都可以审批，当所有的子节点都审批完毕后，会签节点完成。</li>
<li>加入串行节点：子节点只能从左到右依次进行审批，当最后一个子节点审批完成后，串行节点完成。</li>
<li>所有的工作流最外层都是一个串行节点，该节点完成后代表整个工作流完成。</li>
</ul>
<p>为了控制审批流程，我设计了一些节点状态:</p>
<ul>
<li>Ready: 可以进行审批操作的简单节点是 Ready 状态。</li>
<li>Complete: 已经审批完成的节点状态。</li>
<li>Future: 现在还没有走到的节点状态。</li>
<li>Waiting: 只有复杂节点有该状态，表示在等待子节点审批。</li>
</ul>
<p>借助上述规则，一次带会签节点的工作流审批过程如下：</p>
<p><img alt class="lazyload" src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b719bbcbae6b4febb87b0a5496c84c04~tplv-k3u1fbpfcp-watermark.image" data-width="800" data-height="600" referrerpolicy="no-referrer"></p>
<p><img alt class="lazyload" src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/bd4a8d03962d4addb132710be0220c7e~tplv-k3u1fbpfcp-watermark.image" data-width="800" data-height="600" referrerpolicy="no-referrer"></p>
<p>老板：有点意思。</p>
<h3 data-id="heading-2">第 3 关</h3>
<p>老板来了：要支持并行节点。</p>
<p>我查了一下午啥是并行节点，发现并行节点是一个包含很多审批人的大节点，这个大节点里任何一个人审批通过，则该节点就完成。</p>
<p>然后很快就加入了并行节点：</p>
<ul>
<li>并行节点是一个复杂节点，该节点激活时，任何一个子节点都可以进行审批，且任何一个子节点是完成状态时，该节点完成。</li>
</ul>
<p>加入新状态 Skip:</p>
<ul>
<li>当一个并行节点的子节点状态为非 (Ready, Waiting) 时，其它兄弟节点及其子节点的状态被置为 Skip。</li>
</ul>
<p>举个栗子🌰：</p>
<p><img alt class="lazyload" src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/400b7ef70c0a40cbb6b35973f43ff38b~tplv-k3u1fbpfcp-watermark.image" data-width="800" data-height="600" referrerpolicy="no-referrer"></p>
<p>老板：这个设计添加新节点还挺方便的。</p>
<h3 data-id="heading-3">第 4 关</h3>
<p>老板又来了：节点要支持嵌套，比如会签节点里有个并行节点，并行节点里又有个复杂节点，要可以嵌套任意层的那种。</p>
<p>我：其实已经支持了~</p>
<p><img alt class="lazyload" src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1740fb81d9444680b5d2b732b0b3a329~tplv-k3u1fbpfcp-watermark.image" data-width="800" data-height="600" referrerpolicy="no-referrer"></p>
<ul>
<li>能无限扩展的树形结构可以支持任意复杂流程。</li>
</ul>
<p>老板：小伙子有点东西！</p>
<h3 data-id="heading-4">第 5 关</h3>
<p>老板又来了：要支持条件节点。</p>
<p>工作流附带一个表单，要根据表单的内容确定下一步进入哪个分支。</p>
<p>经过几天的冥思苦想，我加入了条件节点：</p>
<ul>
<li>条件节点类似并行节点，只不过只有满足条件的子节点才能进入接下来的审批。</li>
</ul>
<p><img alt class="lazyload" src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1c16ed52d7f142a088a931fabf7ccc3a~tplv-k3u1fbpfcp-watermark.image" data-width="800" data-height="600" referrerpolicy="no-referrer"></p>
<p>老板：已阅。</p>
<h3 data-id="heading-5">第 6 关</h3>
<p>老板又来了：审批人多加两种类型，比如可以从表单中选择下一个审批人，还有根据发起人不同选择不同的审批人。</p>
<p>经过一番考虑，我把简单节点分成了 3 类：</p>
<ul>
<li>第一种：审批人是写死的。</li>
<li>第二种：审批人从表单中读取。</li>
<li>第三种：根据发起人和一个映射函数，算出审批人。比如 get_主管 ("钱某") 得到钱某的主管 李某。</li>
</ul>
<p><img alt class="lazyload" src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2d999f7de50145698360210696acb4b0~tplv-k3u1fbpfcp-watermark.image" data-width="800" data-height="600" referrerpolicy="no-referrer"></p>
<p>老板：嗯。</p>
<h3 data-id="heading-6">第 7 关</h3>
<p>老板又来了：节点可以从前往后审批，那能不能从后往前驳回？</p>
<p>我: ......</p>
<p>首先实现了驳回到发起人的功能，相当于一切从头开始：</p>
<ul>
<li>只有 Ready 状态的节点有权利驳回。（就像只有 Ready 状态的节点有权利审批一样）</li>
</ul>
<p><img alt class="lazyload" src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/af0bfbdb508746eba460142b853539dd~tplv-k3u1fbpfcp-watermark.image" data-width="800" data-height="600" referrerpolicy="no-referrer"></p>
<p>老板：你小子偷懒。</p>
<h3 data-id="heading-7">第 8 关</h3>
<p>老板又来了：先实现驳回到上一个审批人吧。</p>
<p>驳回到上一个审批人其实是个很复杂的逻辑，因为工作流中的节点可以无限嵌套，所以如何确定上一个状态有哪些审批人并不简单。</p>
<p>牺牲了一些头发，我终于实现了驳回上一级的功能：</p>
<p><img alt class="lazyload" src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f8f8ab117f334cee8b32828e8553a95f~tplv-k3u1fbpfcp-watermark.image" data-width="800" data-height="600" referrerpolicy="no-referrer"></p>
<p>老板：阅。</p>
<h3 data-id="heading-8">第 9 关</h3>
<p>老板又来了：实现一个驳回到任意节点的功能。</p>
<p>我发现这个需求并不难实现：</p>
<ul>
<li>不断的驳回上一级，直到 Ready 状态的节点包含要驳回到的节点为止。</li>
</ul>
<p>老板：嗯。</p>
<p>第 10 关
老板又来了：在普通节点加一个时间限制，要是在规定时间内没完成就显示已超时。</p>
<p>我：还有这种需求?</p>
<p>不过还是实现了。</p>
<p><img alt class="lazyload" src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0783553379e4417cab2f135f11b14f39~tplv-k3u1fbpfcp-watermark.image" data-width="800" data-height="600" referrerpolicy="no-referrer"></p>
<p>此时我明白了需求和头发呈负相关，需求越多，头发越少。</p>
<h3 data-id="heading-9">第 11 关</h3>
<p>老板又来了：加一个代理功能，比如有件事让你审批，但是你拿不准，那就转给拿得准的人审批。</p>
<p>马上我发现这个需求跟以往有本质的不同，以往的工作流的节点关系一开始就是固定的，就是在发起流程之前确定的，</p>
<p>但是现在要在审批过程中更改。</p>
<p>无非是加了一些班，掉了一些头发，最终设计了如下方案：</p>
<ul>
<li>代理操作的本质是，新建一个并行节点作为本节点的父节点，再新建一个兄弟节点放代理人，这样自己和代理人都能审批通过。</li>
<li>代理操作可以无限嵌套，即代理人也可以找人代理。</li>
</ul>
<p><img alt class="lazyload" src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4b85acf1b0484e5786d6f14619e5c4b9~tplv-k3u1fbpfcp-watermark.image" data-width="800" data-height="600" referrerpolicy="no-referrer"></p>
<h3 data-id="heading-10">第 12 关</h3>
<p>老板又来了：能不能再加一个取消代理的功能？</p>
<p>。。。我已经宠辱不惊了，加就加：</p>
<ul>
<li>取消代理是代理的逆操作</li>
<li>如果代理人审批过了那就不能取消代理</li>
</ul>
<p><img alt class="lazyload" src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1b98e1d4516c4b98b167c50a48ad2bd8~tplv-k3u1fbpfcp-watermark.image" data-width="800" data-height="600" referrerpolicy="no-referrer"></p>
<h3 data-id="heading-11">第 13 关</h3>
<p>老板又来了：给每个节点加个前后置条件吧，满足前置条件才能进入该节点，满足后置条件该节点才能审批完成。</p>
<p>我的内心：啊老板再见，啊老板再见吧再见吧再见吧！</p>
<p>我的嘴：好的老板，收到收到。</p>
<p>后来：后来我真的给每个节点加了前后置条件，与此同时审批逻辑的相关代码增加了一倍。</p>
<h3 data-id="heading-12">第 14 关</h3>
<p>老板又来了：现在有的工作流已经非常复杂了，审批起来耗时较长，能不能对每个进行中的工作流计算一个指标：直观的显示目前审批进行的百分比。</p>
<p>我：收到。</p>
<p>其实跟之前的需求比起来这个并不复杂，因为不涉及核心逻辑的改动，本质只是输入一棵树形结构然后根据不同节点的状态输出一个整数。</p>
<p>经过测试思考，最终敲定的方案如下：</p>
<ul>
<li>工作流完成的百分比指的是树中最右侧 Ready 状态的节点到最左侧节点的距离 / 最右侧节点的距离。</li>
</ul>
<h3 data-id="heading-13">第 15 关</h3>
<p>老板又来了：能不能给每个节点挂两个可以执行的脚本，分别在开始审批该节点和审批完成该节点后执行？</p>
<p>我：收.. 到。</p>
<p>后来我当然实现了这个功能，同时也发现正值壮年的我已经秃了。</p>
<h3 data-id="heading-14">后记</h3>
<p>老板是清华毕业的高才生，不然大概想不出这么多巧夺天工的需求，后来老板把这一套工作流系统卖给了广 * 证券等公司，我也去别的公司各奔前程，当然那个时候我以为我还有前程。</p>
<p>开始做这个工作流的时候我刚刚本科毕业，后来从这家公司公司离职的时候看镜子已经垂垂老矣。这已经是 3 年前的事情了，现在回想起那些加班改工作流的日子，仍然心惊。</p>
<p>最后愿天下的同行们都没有 bug，身心健康，攒的钱够在一线城市买两套房，在若干年后能无病无灾的过上领养老金的休闲退休生活。</p></div> <div class="image-viewer-box" data-v-78c9b824><!----></div>  
</div>
            