
---
title: '为技术系统打_疫苗_，爱奇艺攻防演练平台的探索实践'
categories: 
 - 编程
 - 掘金
 - 标签
headimg: 'https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f1975bd145734a6595cad9412990e57a~tplv-k3u1fbpfcp-zoom-1.image'
author: 掘金
comments: false
date: Fri, 02 Jul 2021 00:58:26 GMT
thumbnail: 'https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f1975bd145734a6595cad9412990e57a~tplv-k3u1fbpfcp-zoom-1.image'
---

<div>   
<div class="markdown-body"><style>.markdown-body&#123;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333&#125;.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6&#123;line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px&#125;.markdown-body h1&#123;font-size:30px;margin-bottom:5px&#125;.markdown-body h2&#123;padding-bottom:12px;font-size:24px;border-bottom:1px solid #ececec&#125;.markdown-body h3&#123;font-size:18px;padding-bottom:0&#125;.markdown-body h4&#123;font-size:16px&#125;.markdown-body h5&#123;font-size:15px&#125;.markdown-body h6&#123;margin-top:5px&#125;.markdown-body p&#123;line-height:inherit;margin-top:22px;margin-bottom:22px&#125;.markdown-body img&#123;max-width:100%&#125;.markdown-body hr&#123;border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px&#125;.markdown-body code&#123;word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em&#125;.markdown-body code,.markdown-body pre&#123;font-family:Menlo,Monaco,Consolas,Courier New,monospace&#125;.markdown-body pre&#123;overflow:auto;position:relative;line-height:1.75&#125;.markdown-body pre>code&#123;font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8&#125;.markdown-body a&#123;text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff&#125;.markdown-body a:active,.markdown-body a:hover&#123;color:#275b8c&#125;.markdown-body table&#123;display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6&#125;.markdown-body thead&#123;background:#f6f6f6;color:#000;text-align:left&#125;.markdown-body tr:nth-child(2n)&#123;background-color:#fcfcfc&#125;.markdown-body td,.markdown-body th&#123;padding:12px 7px;line-height:24px&#125;.markdown-body td&#123;min-width:120px&#125;.markdown-body blockquote&#123;color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8&#125;.markdown-body blockquote:after&#123;display:block;content:""&#125;.markdown-body blockquote>p&#123;margin:10px 0&#125;.markdown-body ol,.markdown-body ul&#123;padding-left:28px&#125;.markdown-body ol li,.markdown-body ul li&#123;margin-bottom:0;list-style:inherit&#125;.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item&#123;list-style:none&#125;.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul&#123;margin-top:0&#125;.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul&#123;margin-top:3px&#125;.markdown-body ol li&#123;padding-left:6px&#125;.markdown-body .contains-task-list&#123;padding-left:0&#125;.markdown-body .task-list-item&#123;list-style:none&#125;@media (max-width:720px)&#123;.markdown-body h1&#123;font-size:24px&#125;.markdown-body h2&#123;font-size:20px&#125;.markdown-body h3&#123;font-size:18px&#125;&#125;</style><p>在程序员的江湖里，流传着一些经典的老梗：</p>
<p>**编程第一法则：**如果代码莫名运行成功了，那就别动了~</p>
<p>**架构第一法则：**稳定运行多年的老系统，千万不要碰~</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f1975bd145734a6595cad9412990e57a~tplv-k3u1fbpfcp-zoom-1.image" alt="为技术系统打“疫苗”，爱奇艺攻防演练平台的探索实践" loading="lazy" referrerpolicy="no-referrer">图片来自网络</p>
<p>初入行的程序员们接受前辈的洗礼，将如上的法则深深印入脑海，并广泛应用于日后的职业生涯中。</p>
<p><strong>对于正在运行中的线上生产环境，不仅不敢乱碰，恨不得烧香供奉起来。</strong></p>
<p>然而，<strong>技术系统的脆弱性来源是多方面的</strong>，不仅包含<strong>硬件的故障</strong>，<strong>代码的Bug</strong>，还有<strong>架构和逻辑的漏洞</strong>，<strong>线上流量的各种突发性与不确定性</strong>等等。随着各个技术系统向云原生架构的迁移，<strong>架构中引入的依赖和不确定性也越来越多。</strong></p>
<p>如何在日益复杂的技术架构下，实现系统的反脆弱，成为了一个程序员向架构师提升之路上的<strong>必修课。</strong></p>
<p>2010年，NetFlix的工程师提出了<strong>混沌工程</strong>的概念，<strong>通过对线上生产系统主动注入故障，来验证系统在各种故障场景下的响应行为，提前识别并修复系统隐患。</strong></p>
<p>它就像**“疫苗”**一样，故意将有害物质注入体内以防止未来疾病。对于复杂的技术系统，工程师们同样可以通过注入有限可控的故障，提前发现系统的弱点并进行修复，从而规避可能产生严重后果的大型故障。</p>
<p>混沌工程的引入，<strong>既是一个技术上的革新，也是一个观念上的突破。<strong>它抛弃行业前辈们过去死守的“线上系统千万不能碰”的老旧维稳观念，提出了</strong>“以攻代守”的稳定性建设的新思路</strong>，开启了在生产环境做<strong>攻防演练</strong>的新时代。</p>
<h2 data-id="heading-0">01 混沌工程在爱奇艺的发展</h2>
<p>爱奇艺的攻防演练工作，<strong>最早是由各个业务自行组织开展的</strong>。如金融支付团队，因其业务特点对稳定性要求极高，很早就开展混沌工程相关工作。详见之前的文章<a href="https://mp.weixin.qq.com/s/qBjrzBueD3pOz8anmrQNqg" target="_blank" rel="nofollow noopener noreferrer">《攻防大战的背后》。</a></p>
<p>在这个阶段，各个团队攻防演练<strong>使用的方法和工具都比较分散多样，没有形成一个统一的平台和工具标准。</strong></p>
<p>在2020年初的疫情流量高峰期间，爱奇艺发生了一次播放失败故障。</p>
<p>在复盘后总结发现，<strong>这个大型故障其实是由一个小的网络抖动和代码bug引发的雪崩。<strong>这样的小问题平时</strong>隐藏在复杂的技术架构中</strong>，<strong>很难被一般的测试发现</strong>，然而庞大的系统却因为这一个小的异常，触发<strong>巨大的连锁反应。</strong></p>
<p>自此，爱奇艺的技术团队开始<strong>大规模</strong>地在<strong>重点服务的生产环境里</strong>，推动落地<strong>常态化，标准化的攻防演练工作</strong>，同时建设了<strong>公司级的攻防演练平台</strong>—<strong>小鹿乱撞平台</strong>，用于支持各业务攻防演练的相关需求，提升攻防演练的安全性和执行效率。</p>
<p>截止到2021年Q2，爱奇艺内部已有<strong>20+重点业务</strong>通过小鹿乱撞平台进行攻防演练，<strong>平均每个重点服务的线上环境都经历了3到4轮的真实故障攻击演练。</strong></p>
<h2 data-id="heading-1">02 小鹿乱撞平台的使用介绍</h2>
<p>小鹿乱撞平台在爱奇艺承担着<strong>两个角色</strong>：</p>
<p>**（1）业务自测：**各业务系统的Owner可以通过小鹿乱撞平台，对自己系统的生产或测试环境进行故障自测，检验自己在服务中预设的各类高可用保障措施（报警/降级/熔断/灾备切流等）是否生效。</p>
<p>**（2）红蓝攻防：**由公司成立的独立的架构评估团队，从第三方视角，用随机化的攻击实验，验证重点业务系统的高可用水平，对关键服务进行第三方检验保障。</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/24b5756cb2bc4ea097f6a11ba3edbc6e~tplv-k3u1fbpfcp-zoom-1.image" alt="为技术系统打“疫苗”，爱奇艺攻防演练平台的探索实践" loading="lazy" referrerpolicy="no-referrer">小鹿乱撞平台模块图</p>
<p>小鹿乱撞平台参考了公有<strong>云攻防演练优秀产品</strong>的设计，用户可以通过如下<strong>简单步骤来进行攻防配置</strong>：</p>
<p><strong>1.选择攻击对象</strong></p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1d1f50d3e9ed4e6a831a77dad4398c8b~tplv-k3u1fbpfcp-zoom-1.image" alt="为技术系统打“疫苗”，爱奇艺攻防演练平台的探索实践" loading="lazy" referrerpolicy="no-referrer"></p>
<p><strong>2.配置攻击方式</strong></p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/8b5643853ed341a285c559f754791c1a~tplv-k3u1fbpfcp-zoom-1.image" alt="为技术系统打“疫苗”，爱奇艺攻防演练平台的探索实践" loading="lazy" referrerpolicy="no-referrer"></p>
<p><strong>3.编排演练方案</strong></p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c3ec7ccfb4e249cf9220703a6fb4e8ec~tplv-k3u1fbpfcp-zoom-1.image" alt="为技术系统打“疫苗”，爱奇艺攻防演练平台的探索实践" loading="lazy" referrerpolicy="no-referrer"></p>
<p>按照上面编排好的演练方案，<strong>提交审批</strong>之后就可以执行了。</p>
<p><strong>4.演练观测</strong></p>
<p>小鹿乱撞平台除了配置和编排演练方案之外，<strong>还打通了公司内部各个资源管理和监控观测系统，<strong>解决攻防演练中的</strong>权限，流程，可观测性等问题</strong>，为用户<strong>输出简洁有效的故障演练报告。</strong></p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/bf91c85289d545df8c06fb88007d51a4~tplv-k3u1fbpfcp-zoom-1.image" alt="为技术系统打“疫苗”，爱奇艺攻防演练平台的探索实践" loading="lazy" referrerpolicy="no-referrer">攻防演练进行中的观测：监控和告警</p>
<h2 data-id="heading-2">03 重点业务攻防演练案例介绍</h2>
<h3 data-id="heading-3">1.案例一：视频播放服务Couchbase缓存故障演练</h3>
<p><strong>（1）演练背景</strong></p>
<p>在上文提到的播放故障里，其中一个原因是由于<strong>网络抖动导致播放服务访问Couchbase的SDK连接使用异常</strong>，引发后续的连锁反应。</p>
<p>在故障后，播放服务的同学对架构中的依赖进行了一系列的<strong>熔断加固</strong>，当服务访问Couchbase依赖超时会触发<strong>自动熔断</strong>，服务请求改成访问<strong>备用KV数据库</strong>，并通过攻防演练<strong>重放网络故障</strong>，<strong>验证熔断加固的效果。</strong></p>
<p><strong>（2）演练过程</strong></p>
<p>在攻防演练中，我们选择攻击的方式是注入<strong>点对点网络故障</strong>，使视频播放服务所在的服务器与Couchbase集群之间增加<strong>1000ms延迟</strong>，模拟网络故障造成业务访问Couchbase超时。</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b2c1392a72604104b7d421613e3cb7b4~tplv-k3u1fbpfcp-zoom-1.image" alt="为技术系统打“疫苗”，爱奇艺攻防演练平台的探索实践" loading="lazy" referrerpolicy="no-referrer"></p>
<p><strong>（3）演练效果</strong></p>
<p><strong>顺利触发熔断，Couchbase访问超时后，业务请求立即切换到HiKV。</strong></p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/fb3a2c8898924761b907774c542e6d65~tplv-k3u1fbpfcp-zoom-1.image" alt="为技术系统打“疫苗”，爱奇艺攻防演练平台的探索实践" loading="lazy" referrerpolicy="no-referrer"></p>
<h3 data-id="heading-4">2.案例二：会员服务Redis分布式锁攻防演练</h3>
<p><strong>（1）演练背景</strong></p>
<p>爱奇艺会员服务团队统一切换到新的<strong>Redis分布式锁</strong>，并通过攻防演练<strong>检验新的分布式锁在各种故障极端场景下的可靠性。</strong></p>
<p><strong>（2）演练过程</strong></p>
<p>对Redis分布式锁进行<strong>三种不同故障攻击</strong>，分别检验分布式锁在这三类不同攻击下的效果表现：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/aa77e326fa29418f9fc7c1b20ff297ef~tplv-k3u1fbpfcp-zoom-1.image" alt="为技术系统打“疫苗”，爱奇艺攻防演练平台的探索实践" loading="lazy" referrerpolicy="no-referrer"></p>
<ul>
<li>
<p>**场景1：**业务服务和Redis之间的网络断开，5分钟后恢复</p>
</li>
<li>
<p>**场景2：**Redis主库故障，触发主从切换到Redis从库</p>
</li>
<li>
<p>**场景3：**Redis主库故障，不进行主从切换，经过5分钟后，重启Redis服务</p>
</li>
</ul>
<p><strong>（3）演练效果</strong></p>
<p>验证了Redis分布式锁在这三种极端场景下的<strong>业务影响</strong>，确定了<strong>业务侧</strong>在分布式锁故障期间的<strong>等待/重试等机制</strong>。根据Redis故障期间的分布式锁请求响应状况，<strong>指导业务调用方按照各自业务场景设置合理的等待间隔和重试配置等。</strong></p>
<h2 data-id="heading-5">04 演练中常见的隐患和经验</h2>
<p>回顾过去一年，在20多个业务线的生产环境里做攻防演练的经验，**我们总结了一些具有普遍性或者较大危害性的问题，**这里简单整理如下：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d9e4d73a6e884dfcbd7c369ab5c4f3f2~tplv-k3u1fbpfcp-zoom-1.image" alt loading="lazy" referrerpolicy="no-referrer"></p>
<h2 data-id="heading-6">05 总结</h2>
<p>在爱奇艺，<strong>经过一年多的混沌工程文化布道和系统性的线上攻防实操</strong>，核心业务的一线技术Leader都已经具备了相当的攻防意识。<strong>作者这里总结了各业务优秀的架构师们的两个共同特点：</strong></p>
<h3 data-id="heading-7">1.零信任</h3>
<p><strong>任何一个服务都不是孤立的</strong>，包括DNS、负载均衡、网关、虚机/容器、数据库、中间件、存储、网络、Cache等大量基础服务依赖，以及大量的外部接口依赖，<strong>即使每个单独的依赖都有99.99%的可用性，几十项依赖叠乘在一起的可用性也是不高的。</strong></p>
<p>优秀的架构师从不会抱着一种 “某某依赖是基础服务，我的架构里假设它100%可用，出了故障我直接给它甩锅” 的想法来做技术服务，而是<strong>尽量假设任意一个环节都可能出问题，以此来设计自己系统的高可用方案。</strong></p>
<h3 data-id="heading-8">2.探索欲</h3>
<p>优秀的技术负责人，<strong>对自己的服务架构的可靠性做到心中有数</strong>，能够明确地对着架构图中的任意一个点回答，这里的异常能抵挡，那里的异常会让服务故障。<strong>如果有不确定的异常点，会主动通过攻防演练进行探索。<strong>在</strong>测试/灰度</strong>等环境验证过的<strong>各类灾备/切流/熔断/降级机制，同样也敢去线上环境做攻击验证。</strong></p>
<p><strong>敢于对自己负责的线上服务进行真实攻击，是对未来云原生时代下架构师们的新要求，体现了技术Leader们的架构自信和技术自信。</strong></p>
<p>自信源于对代码逻辑的深刻把握，对架构原理的理性思考，对业务责任的勇敢担当。</p>
<p>在未来云时代复杂的技术架构中，坚持这种技术自信，<strong>积极地参与到攻防演练的工作中</strong>，有利于<strong>加深架构理解，发现和修复服务隐患，为技术同学的能力成长开辟新前景，为公司业务的稳定发展保驾护航。</strong></p>
<p>部分图片来源于网络，如有版权问题请及时与我方联系。</p></div>  
</div>
            