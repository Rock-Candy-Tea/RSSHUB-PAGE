
---
title: '我在公司项目上用了微前端，差点....出了大事故'
categories: 
 - 编程
 - 掘金
 - 标签
headimg: 'https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/39d2877f9c1049e3903fc75f363af2d3~tplv-k3u1fbpfcp-zoom-1.image'
author: 掘金
comments: false
date: Fri, 16 Jul 2021 09:09:02 GMT
thumbnail: 'https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/39d2877f9c1049e3903fc75f363af2d3~tplv-k3u1fbpfcp-zoom-1.image'
---

<div>   
<div class="markdown-body"><style>.markdown-body&#123;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333&#125;.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6&#123;line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px&#125;.markdown-body h1&#123;font-size:30px;margin-bottom:5px&#125;.markdown-body h2&#123;padding-bottom:12px;font-size:24px;border-bottom:1px solid #ececec&#125;.markdown-body h3&#123;font-size:18px;padding-bottom:0&#125;.markdown-body h4&#123;font-size:16px&#125;.markdown-body h5&#123;font-size:15px&#125;.markdown-body h6&#123;margin-top:5px&#125;.markdown-body p&#123;line-height:inherit;margin-top:22px;margin-bottom:22px&#125;.markdown-body img&#123;max-width:100%&#125;.markdown-body hr&#123;border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px&#125;.markdown-body code&#123;word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em&#125;.markdown-body code,.markdown-body pre&#123;font-family:Menlo,Monaco,Consolas,Courier New,monospace&#125;.markdown-body pre&#123;overflow:auto;position:relative;line-height:1.75&#125;.markdown-body pre>code&#123;font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8&#125;.markdown-body a&#123;text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff&#125;.markdown-body a:active,.markdown-body a:hover&#123;color:#275b8c&#125;.markdown-body table&#123;display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6&#125;.markdown-body thead&#123;background:#f6f6f6;color:#000;text-align:left&#125;.markdown-body tr:nth-child(2n)&#123;background-color:#fcfcfc&#125;.markdown-body td,.markdown-body th&#123;padding:12px 7px;line-height:24px&#125;.markdown-body td&#123;min-width:120px&#125;.markdown-body blockquote&#123;color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8&#125;.markdown-body blockquote:after&#123;display:block;content:""&#125;.markdown-body blockquote>p&#123;margin:10px 0&#125;.markdown-body ol,.markdown-body ul&#123;padding-left:28px&#125;.markdown-body ol li,.markdown-body ul li&#123;margin-bottom:0;list-style:inherit&#125;.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item&#123;list-style:none&#125;.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul&#123;margin-top:0&#125;.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul&#123;margin-top:3px&#125;.markdown-body ol li&#123;padding-left:6px&#125;.markdown-body .contains-task-list&#123;padding-left:0&#125;.markdown-body .task-list-item&#123;list-style:none&#125;@media (max-width:720px)&#123;.markdown-body h1&#123;font-size:24px&#125;.markdown-body h2&#123;font-size:20px&#125;.markdown-body h3&#123;font-size:18px&#125;&#125;</style><h4 data-id="heading-0">故事的开头</h4>
<ul>
<li>从微前端的<code>qiankun</code>去年开始火的时候，我就注意到了，我们公司的<code>Saas</code>系统是可以用这个去解决UI、体验上的一些问题，以及让技术栈平滑过渡迁移，但是奈何时机不够成熟</li>
<li>今年抓住了时机，感觉是时候推进微前端了，加上公司内部的<code>星舟</code>平台（Devops平台）也开始推广，我开始寻思改造这个事</li>
</ul>
<blockquote>
<p>改造不为了炫技，仅仅为了提升开发、用户体验！当你需要微前端的时候，再用它</p>
</blockquote>
<h4 data-id="heading-1">我在公司内部做了一个技术分享</h4>
<ul>
<li>我的微前端改造是利用k8s + qiankun + ingress(path)的配置，达到快速部署的目的，完全无跨域问题</li>
</ul>
<h4 data-id="heading-2">改造背景</h4>
<ul>
<li>目前存在几个站点，但是站点之间的UI展现不一样，我们看起来很不专业</li>
<li>不同站点明明都所属于我们部门的系统，但是跳转时却需要整体的跳转并且出全部的白屏，用户体验很差</li>
<li>无法承接全局性的需求，例如：多个站点技术栈版本不一样，这里要做一个需求，需要去几个不同的版本技术栈中实现一次，还很难保持效果一致</li>
</ul>
<h4 data-id="heading-3">why not iframe</h4>
<ul>
<li>
<p>为什么不用 iframe，这几乎是所有微前端方案第一个会被 diss 的问题。</p>
</li>
<li>
<p>但是大部分微前端方案又不约而同放弃了 iframe 方案，自然是有原因的，并不是为了 "炫技" 或者刻意追求 "特立独行"。</p>
</li>
<li>
<p>如果不考虑体验问题，iframe 几乎是最完美的微前端解决方案了。</p>
</li>
<li>
<p>iframe 最大的特性就是提供了浏览器原生的硬隔离方案，不论是样式隔离、js 隔离这类问题统统都能被完美解决。但他的最大问题也在于他的隔离性无法被突破，导致应用间上下文无法被共享，随之带来的开发体验、产品体验的问题。</p>
</li>
<li>
<p>url 不同步。浏览器刷新 iframe url 状态丢失、后退前进按钮无法使用。</p>
</li>
</ul>
<p>UI 不同步，DOM 结构不共享。想象一下屏幕右下角 1/4 的 iframe 里来一个带遮罩层的弹框，同时我们要求这个弹框要浏览器居中显示，还要浏览器 resize 时自动居中..</p>
<ul>
<li>
<p>全局上下文完全隔离，内存变量不共享。iframe 内外系统的通信、数据同步等需求，主应用的 cookie 要透传到根域名都不同的子应用中实现免登效果。慢。每次子应用进入都是一次浏览器上下文重建、资源重新加载的过程。</p>
</li>
<li>
<p>其中有的问题比较好解决(问题1)，有的问题我们可以睁一只眼闭一只眼(问题4)，但有的问题我们则很难解决(问题3)甚至无法解决(问题2)，而这些无法解决的问题恰恰又会给产品带来非常严重的体验问题， 最终导致我们舍弃了 iframe 方案。</p>
</li>
</ul>
<blockquote>
<p>上面抄的阿里的对于qiankun的介绍，我觉得挺好，已经拿小本本记下来默默背诵了</p>
</blockquote>
<h4 data-id="heading-4">微前端对我来说它的核心价值</h4>
<ul>
<li>技术栈无关 -  解构巨石应用</li>
<li>方案上跟使用 iframe 做微前端一样简单，同时又解决了 iframe 带来的各种体验上的问题。理想状态下，以此为目标的微前端应用，是自动具备流通能力的，且这个流通能力不会因为主应用的实现升级而丧失（也就是说在 21 年能接入主应用的微前端应用，到了 2025 年也应该能正常接入正常运行，并同样保有在不同主应用间流通的能力）</li>
<li>B端产品生命周期长,确保我们的祖传代码能平滑的迁移，以及如何确保我在若干年后还能用上时下热门的技术栈</li>
<li>加强我们平台、产品的集成能力，企业级项目非常需要这个</li>
</ul>
<hr>
<h4 data-id="heading-5">正式开始</h4>
<h4 data-id="heading-6">什么是微前端？</h4>
<blockquote>
<p>微前端是一种多个团队通过独立发布功能的方式来共同构建现代化 web 应用的技术手段及方法策略</p>
</blockquote>
<ul>
<li>微前端架构旨在解决单体应用在一个相对长的时间跨度下，由于参与的人员、团队的增多、变迁，从一个普通应用演变成一个巨石应用后，随之而来的应用不可维护的问题。</li>
<li>这类问题在企业级 Web 应用中尤其常见</li>
</ul>
<h4 data-id="heading-7">微前端原理</h4>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/39d2877f9c1049e3903fc75f363af2d3~tplv-k3u1fbpfcp-zoom-1.image" alt loading="lazy" referrerpolicy="no-referrer"></p>
<h4 data-id="heading-8">子应用通信机制</h4>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2757be14e6ce4974a2390ed3e7349fe6~tplv-k3u1fbpfcp-zoom-1.image" alt loading="lazy" referrerpolicy="no-referrer"></p>
<h4 data-id="heading-9">多方考虑,选择了业内主流成熟的 微前端框架：qiankun</h4>
<h4 data-id="heading-10">qiankun 的核心设计理念</h4>
<ul>
<li>🥄 简单 由于主应用微应用都能做到技术栈无关，qiankun 对于用户而言只是一个类似 jQuery 的库，你需要调用几个 qiankun 的 API 即可完成应用的微前端改造。同时由于 qiankun 的 HTML entry 及沙箱的设计，使得微应用的接入像使用 iframe 一样简单。</li>
<li>🍡 解耦/技术栈无关 微前端的核心目标是将巨石应用拆解成若干可以自治的松耦合微应用，而 qiankun 的诸多设计均是秉持这一原则，如 HTML entry、沙箱、应用间通信等。这样才能确保微应用真正具备 独立开发、独立运行 的能力。</li>
</ul>
<h4 data-id="heading-11">改造前的部署</h4>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6319c89d8bdf40a0901592cd7a48fb66~tplv-k3u1fbpfcp-zoom-1.image" alt loading="lazy" referrerpolicy="no-referrer"></p>
<ul>
<li>改造前的部署，解析域名的<code>path</code>,根据<code>path</code>的不同，例如:myfuwu.com.cn/A 就指向了 项目1</li>
</ul>
<h4 data-id="heading-12">改造后的部署</h4>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b15646ee802e440e92ab6224a3557f2d~tplv-k3u1fbpfcp-zoom-1.image" alt loading="lazy" referrerpolicy="no-referrer"></p>
<ul>
<li>由于<code>k8s</code>有配置多个<code>ingress path</code>的能力，所以我将之前的<code>A B C D</code>的<code>path</code>全部指向了微前端的基座项目，这样用户访问的时候，只会先访问到基座项目</li>
<li>基座项目再解析url,根据url去匹配加载真正的子应用。（此时有一个维护的注册表，例如当<code>path</code>为<code>A</code>的时候，就去请求部署在<code>F</code>的项目）</li>
</ul>
<blockquote>
<p>这样就做到了，微前端不跨域，不改任何代码里面的跳转路径，就实现了部署。</p>
</blockquote>
<ul>
<li>从开始部署到部署成功，我仅仅用了20分钟，所以专业的Devops平台很重要</li>
</ul>
<h4 data-id="heading-13">遇到的问题</h4>
<ul>
<li>微前端模式再去通过iframe嵌套某个微前端模式下子应用页面的时候，写在子应用里面的window.xx方法会找不到，这个时候需要写在基座的window里面</li>
<li>建议通过script等加载的依赖统一放到oss或者自己的文件服务上，这样方便设置跨域等</li>
<li>如果有可能加载两次的script,要加上ignore属性，不然会报错</li>
<li>样式隔离很重要，建议用class区分</li>
<li>开发模式不用开启预加载，生产模式开启预加载体验好很多</li>
</ul>
<h4 data-id="heading-14">总结</h4>
<ul>
<li>
<p>整体来说，微前端的难点在于最低成本的实现改造，像我这样不改项目里面的代码，做到最低的成本，让其他小伙伴既能单独开发部署子应用，也可以被集成到微前端模式下</p>
</li>
<li>
<p>当时我遇到最奇葩的问题是OSS，阿里云的OSS经常返回不带跨域的cors头，导致用户可能白屏，我直接把OSS去掉，自己做了一个文件服务，专门存放静态资源（这个问题，真的很严重，我们是企业级应用，白屏可以说是超级严重的问题，但是还好及时把流量切走了，后面解决了这个问题）</p>
</li>
</ul>
<blockquote>
<p>顺便吐槽一下今天客户使用我们的系统，一个小姐姐，电话里面我跟她说：您好，我是xxx的研发，请问您今天是登录不了了吗？可以远程帮您看看吗？</p>
</blockquote>
<ul>
<li>结果小姐姐让我们排查了一天，最后发现，她的账号是小写，结果她填了大写导致登录不上，差点让我们连夜买火车站票跑路</li>
</ul>
<blockquote>
<p>如果感觉写得不错，帮我点个<code>星标/在看/赞/关注/转发</code>吧</p>
</blockquote>
<p>或者你需要微前端更多资料也可以<code>加我微信</code>，<code>关注公众号：前端巅峰</code>后<code>菜单栏有联系我的方式</code>～</p></div>  
</div>
            