
---
title: '灰度发布系统架构设计'
categories: 
 - 编程
 - 掘金
 - 标签
headimg: 'https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/8587fd56136649718d4699084d62f376~tplv-k3u1fbpfcp-watermark.image'
author: 掘金
comments: false
date: Mon, 19 Apr 2021 22:20:22 GMT
thumbnail: 'https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/8587fd56136649718d4699084d62f376~tplv-k3u1fbpfcp-watermark.image'
---

<div>   
<div class="markdown-body"><style>.markdown-body&#123;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333&#125;.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6&#123;line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px&#125;.markdown-body h1&#123;font-size:30px;margin-bottom:5px&#125;.markdown-body h2&#123;padding-bottom:12px;font-size:24px;border-bottom:1px solid #ececec&#125;.markdown-body h3&#123;font-size:18px;padding-bottom:0&#125;.markdown-body h4&#123;font-size:16px&#125;.markdown-body h5&#123;font-size:15px&#125;.markdown-body h6&#123;margin-top:5px&#125;.markdown-body p&#123;line-height:inherit;margin-top:22px;margin-bottom:22px&#125;.markdown-body img&#123;max-width:100%&#125;.markdown-body hr&#123;border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px&#125;.markdown-body code&#123;word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em&#125;.markdown-body code,.markdown-body pre&#123;font-family:Menlo,Monaco,Consolas,Courier New,monospace&#125;.markdown-body pre&#123;overflow:auto;position:relative;line-height:1.75&#125;.markdown-body pre>code&#123;font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8&#125;.markdown-body a&#123;text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff&#125;.markdown-body a:active,.markdown-body a:hover&#123;color:#275b8c&#125;.markdown-body table&#123;display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6&#125;.markdown-body thead&#123;background:#f6f6f6;color:#000;text-align:left&#125;.markdown-body tr:nth-child(2n)&#123;background-color:#fcfcfc&#125;.markdown-body td,.markdown-body th&#123;padding:12px 7px;line-height:24px&#125;.markdown-body td&#123;min-width:120px&#125;.markdown-body blockquote&#123;color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8&#125;.markdown-body blockquote:after&#123;display:block;content:""&#125;.markdown-body blockquote>p&#123;margin:10px 0&#125;.markdown-body ol,.markdown-body ul&#123;padding-left:28px&#125;.markdown-body ol li,.markdown-body ul li&#123;margin-bottom:0;list-style:inherit&#125;.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item&#123;list-style:none&#125;.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul&#123;margin-top:0&#125;.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul&#123;margin-top:3px&#125;.markdown-body ol li&#123;padding-left:6px&#125;.markdown-body .contains-task-list&#123;padding-left:0&#125;.markdown-body .task-list-item&#123;list-style:none&#125;@media (max-width:720px)&#123;.markdown-body h1&#123;font-size:24px&#125;.markdown-body h2&#123;font-size:20px&#125;.markdown-body h3&#123;font-size:18px&#125;&#125;</style><h3 data-id="heading-0">灰度发布的定义</h3>
<p>互联网产品需要快速迭代开发上线，又要保证质量，保证刚上线的系统，一旦出现问题可以很快控制影响面，就需要设计一套灰度发布系统。</p>
<p>灰度发布系统的作用，可以根据配置，将用户的流量导到新上线的系统上，来快速验证新的功能，而一旦出现问题，也可以马上的修复，简单的说，就是一套A/B Test系统。</p>
<p>灰度发布允许带着bug上线，只要bug不是致命的，当然这个bug是不知道的情况下，如果知道就要很快的改掉</p>
<h3 data-id="heading-1">简单灰度发布系统的设计</h3>
<p><img alt class="lazyload" src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/8587fd56136649718d4699084d62f376~tplv-k3u1fbpfcp-watermark.image" data-width="800" data-height="600" referrerpolicy="no-referrer"></p>
<p>灰度简单架构如上图所示，其中的必要组件如下：</p>
<p>1、策略的配置平台，存放灰度的策略</p>
<p>2、灰度功能的执行程序</p>
<p>3、注册中心，注册的服务携带ip/Port/name/version</p>
<p>有了上面三个组件，才算一个完整的灰度平台</p>
<h3 data-id="heading-2">灰度的策略</h3>
<p>灰度必须要有灰度策略，灰度策略常见的方式有以下几种</p>
<p>1、基于Request Header进行流量切分</p>
<p>2、基于Cookie进行流量切分</p>
<p>3、基于请求参数进行流量切分</p>
<p>举例：根据请求中携带的用户uid进行取模，灰度的范围是百分之一，那么uid取模的范围就是100，模是0访问新版服务，模是1~99的访问老版服务。</p>
<p><strong>灰度发布策略分为两类，单策略和组合策略</strong></p>
<p>单策略：比如按照用户的uid、token、ip进行取模</p>
<p>组合策略：多个服务同时灰度，比如我有A/B/C三个服务，需要同时对A和C进行灰度，但是B不需要灰度，这个时候就需要一个tag字段，具体实现在下文详述</p>
<h3 data-id="heading-3">灰度发布具体的执行控制</h3>
<p>在上面的简单灰度发布系统架构中我们了解到，灰度发布服务分为上游和下游服务，上游服务是具体的执行灰度策略的程序，这个服务可以是nginx，也可以是微服务架构中的网关层/业务逻辑层，下面我们就来分析一下不同的上游服务，如何落地</p>
<h3 data-id="heading-4">Nginx</h3>
<p>如果上游服务是nginx，那么就需要nginx通过Lua扩展nginx实现灰度策略的配置和转发，因为nginx本身并不具备灰度策略的执行</p>
<p>通过lua扩展实现了灰度策略的执行，但是问题又来了，nginx本身并不具备接收配置管理平台的灰度策略，这个时候应该怎么办呢？</p>
<p>解决方案：本地部署Agent（需要自己开发），接收服务配置管理平台下发的灰度策略，更新nginx配置，优雅重启Nginx服务</p>
<h3 data-id="heading-5">0网关层/业务逻辑层/数据访问层</h3>
<p>只需要集成配置管理平台客户端SDK，接收服务配置管理平台下发的灰度策略，在通过集成的SDK进行灰度策略的执行即可</p>
<h3 data-id="heading-6">灰度发布复杂场景</h3>
<p>下面举例两个稍微复杂的灰度发布场景，灰度策略假设都按照uid取模灰度百分之一的用户，看一下如何实现。</p>
<p><strong>场景1：调用链上同时灰度多个服务</strong></p>
<p>功能升级涉及到多个服务变动，网关层和数据访问层灰度，业务逻辑层不变，这个时候应该如何进行灰度？</p>
<p>解决方案：</p>
<p>经过新版本网关层的请求，全部打上tag T，在业务逻辑层根据tag T进行转发， 标记Tag T的请求全部转发到新版数据访问层服务上，没有tag T的请求全部转发到老版数据访问层上。</p>
<p><img alt class="lazyload" src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/880f8444f781490aa04f0758f357f701~tplv-k3u1fbpfcp-watermark.image" data-width="800" data-height="600" referrerpolicy="no-referrer"></p>
<p><strong>场景2：涉及数据的灰度服务</strong></p>
<p>涉及到数据的灰度服务，一定会使用到数据库，使用到数据库就会涉及到你使用数据库前后的表字段不一致，我老版本是A/B/C三个字段，新版本是A/B/C/D四个字段。这时新版的灰度，就不能往老版的数据库进行修改了，这个时候就需要把数据copy一份出来做这个事情了</p>
<p>数据库其实并没有灰度的概念，这个时候我们只能把数据重新拷贝一份出来进行读和写，因为这时你的写必须是全量的（双写），不能说90%的数据写入到老版本，10%的数据写入到新版本，因为这个时候你会发现两个数据库的数据都不是全量的。</p>
<p>离线全量复制数据的过程中一定会有数据丢失，这个时候就需要业务逻辑层写一份数据到MQ中，等数据同步完成之后，新版的数据访问层再将MQ的数据写入到新版本的DB中，实现数据的一致性，这个也是引入MQ的主要目的。</p>
<p><img alt class="lazyload" src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/250292fc496f40a4a49cd58df38a7ce2~tplv-k3u1fbpfcp-watermark.image" data-width="800" data-height="600" referrerpolicy="no-referrer"></p>
<p>灰度过程中需要对两个数据库的数据进行对比，观察数据是否一致。这样不管是灰度失败，放弃新版DB，还是灰度成功切换到新版DB，数据都不会产生丢失。</p></div> <div class="image-viewer-box" data-v-78c9b824><!----></div>  
</div>
            