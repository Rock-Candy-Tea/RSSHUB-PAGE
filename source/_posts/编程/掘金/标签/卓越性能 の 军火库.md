
---
title: '卓越性能 の 军火库'
categories: 
 - 编程
 - 掘金
 - 标签
headimg: 'https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/86c55af3c6d54bc9ad8c1717d40613e8~tplv-k3u1fbpfcp-zoom-1.image'
author: 掘金
comments: false
date: Thu, 27 May 2021 01:24:55 GMT
thumbnail: 'https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/86c55af3c6d54bc9ad8c1717d40613e8~tplv-k3u1fbpfcp-zoom-1.image'
---

<div>   
<div class="markdown-body"><style>.markdown-body&#123;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333&#125;.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6&#123;line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px&#125;.markdown-body h1&#123;font-size:30px;margin-bottom:5px&#125;.markdown-body h2&#123;padding-bottom:12px;font-size:24px;border-bottom:1px solid #ececec&#125;.markdown-body h3&#123;font-size:18px;padding-bottom:0&#125;.markdown-body h4&#123;font-size:16px&#125;.markdown-body h5&#123;font-size:15px&#125;.markdown-body h6&#123;margin-top:5px&#125;.markdown-body p&#123;line-height:inherit;margin-top:22px;margin-bottom:22px&#125;.markdown-body img&#123;max-width:100%&#125;.markdown-body hr&#123;border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px&#125;.markdown-body code&#123;word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em&#125;.markdown-body code,.markdown-body pre&#123;font-family:Menlo,Monaco,Consolas,Courier New,monospace&#125;.markdown-body pre&#123;overflow:auto;position:relative;line-height:1.75&#125;.markdown-body pre>code&#123;font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8&#125;.markdown-body a&#123;text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff&#125;.markdown-body a:active,.markdown-body a:hover&#123;color:#275b8c&#125;.markdown-body table&#123;display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6&#125;.markdown-body thead&#123;background:#f6f6f6;color:#000;text-align:left&#125;.markdown-body tr:nth-child(2n)&#123;background-color:#fcfcfc&#125;.markdown-body td,.markdown-body th&#123;padding:12px 7px;line-height:24px&#125;.markdown-body td&#123;min-width:120px&#125;.markdown-body blockquote&#123;color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8&#125;.markdown-body blockquote:after&#123;display:block;content:""&#125;.markdown-body blockquote>p&#123;margin:10px 0&#125;.markdown-body ol,.markdown-body ul&#123;padding-left:28px&#125;.markdown-body ol li,.markdown-body ul li&#123;margin-bottom:0;list-style:inherit&#125;.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item&#123;list-style:none&#125;.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul&#123;margin-top:0&#125;.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul&#123;margin-top:3px&#125;.markdown-body ol li&#123;padding-left:6px&#125;.markdown-body .contains-task-list&#123;padding-left:0&#125;.markdown-body .task-list-item&#123;list-style:none&#125;@media (max-width:720px)&#123;.markdown-body h1&#123;font-size:24px&#125;.markdown-body h2&#123;font-size:20px&#125;.markdown-body h3&#123;font-size:18px&#125;&#125;</style><p>在介绍性能优化的军火库之前，先来扯几句题外话。希望这些题外话，能打消你追求卓越性能的理想，来甘心当一枚圆滑的钉子。</p>
<p>我是非常不推荐程序员，对公司的业务，进行性能优化的。说这话，纯粹是基于个人自身安全考虑。因为性能优化，在大多数公司，属于费力不讨好的工作项。</p>
<p>追求极简的代码，性能卓越的代码，是有追求的程序员的目标。但随着经历了大大小小的公司，我发现很多优秀的程序员，在经受着这种追求的反嗜，以至于痛不欲生。下</p>
<p>有下面几点原因，虽然我们知道它肯定是错的，但我们无能无力：</p>
<ol>
<li>公司按照完成的功能，对程序员进行考核。性能优化属于额外的工期，也就是浪费成本的一种存在。</li>
<li>团队不Care程序运行的效率，慢一点无所谓，等出问题了再救火就行。</li>
<li>性能优化的风险大，通常要调整代码结构，甚至修改代码逻辑。不优化可能没事，一优化可能出事，没人愿意碰。</li>
</ol>
<p><strong>就一句话，整个团队深陷<code>进行时</code>泥潭，没有<code>展望性</code>思想，大家就那么浆糊着，得过且过。</strong></p>
<p>以上是很多公司的现状，尤其集中在中小型公司。在这种公司里，除非系统慢到极点，优化之后有效果，或者领导要求你这么做，否则我都不建议你去碰。如果你执意如此，惹火烧身的时候不要后悔。</p>
<p>当然，有很多团队的技术氛围还是很nice的，甚至在代码review的时候，都会提出一些更优的建议。遇到这样的团队，就要珍惜，我们的军火库，毫无疑问是为了这些团队而准备的。</p>
<p><code>Brendan D. Gregg</code>大叔，天马行空过《性能之巅》这本书。但这本书的内容有点深，很多工具都是从资源层面进行分析的。他更广为人知的一张图，就是下面这张工具的集合。当然还有现在无处不在的火焰图。</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/86c55af3c6d54bc9ad8c1717d40613e8~tplv-k3u1fbpfcp-zoom-1.image" alt loading="lazy" referrerpolicy="no-referrer"><img alt title="点击并拖拽以移动" loading="lazy" src="https://juejin.cn/post/undefined" referrerpolicy="no-referrer">​</p>
<p>这密密麻麻的工具，都是偏低层的，大多数时候，我们用不到。所以<code>我</code>整理了一个稍微上层的，靠近平常使用习惯的军火库。大多数工具，你不需要再使用<code>yum</code>或者<code>apt</code>安装，都是自带的。</p>
<h2 data-id="heading-0">通用问题发现</h2>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/bca27d41eca24fa691a7bd8b1f7ba1c0~tplv-k3u1fbpfcp-zoom-1.image" alt loading="lazy" referrerpolicy="no-referrer"><img alt title="点击并拖拽以移动" loading="lazy" src="https://juejin.cn/post/undefined" referrerpolicy="no-referrer">​</p>
<p>如上图，就是我平常所使用的性能问题排查工具集合，可以排查一些通用的性能问题，比如CPU、内存、网络、I/O等。</p>
<p>大多数监控系统，抓取的也都是这些指标。由于这些性能数据都是发生在<code>某一时间</code>的，所以都只能排查问题发生<code>当时</code>的一些性能数据。强烈建议使用监控系统保存这些历史数据，可以进行问题追随，不用再傻乎乎等着问题复现了。</p>
<h2 data-id="heading-1">专用工具</h2>
<p>不过，再怎么看，上面的这些工具也太零散了，学习的成本比较大，还需要记忆很多参数配置，才能再<code>救火</code>的环境中反应灵敏。</p>
<p>比较幸运的是，有一些可以获取性能概览的工具可以帮助我们减少脑细胞的损耗。</p>
<p>就拿top来说，有经验的同学，仅凭这一个命令，就能够判断系统中的资源，是否达到了瓶颈。这样的工具还有vmstat、sar、nmon等。尤其是nmon，是一个老牌的性能汇总工具，能够自动生成压测期间所产生的性能报告。</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/eb87c450c04a443d9e2057127070f823~tplv-k3u1fbpfcp-zoom-1.image" alt loading="lazy" referrerpolicy="no-referrer"><img alt title="点击并拖拽以移动" loading="lazy" src="https://juejin.cn/post/undefined" referrerpolicy="no-referrer">​ 这里面的几个性能深挖工具，学习曲线有点陡峭，但一旦掌握必使你产生主宰的感觉。但很多时候轮不到它们上场，因为总有一种大炮打蚊子的感觉。</p>
<h2 data-id="heading-2">Java专用工具</h2>
<p>但是不要忘了，我们是搞Java的，碰到的性能问题，多属于JVM层面的。就拿perf这个工具来说，很强大，可以追踪到每一个c语言的函数调用的次数和耗时，但对Java来说是没用的，它生成的火焰图也没用。</p>
<p>所以Java自有一套这样的解决方案。</p>
<p>不仅有，而且更强大。尤其推荐jmc集成的JFR功能，这个记录的信息可真是太详细了。</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0bb4175b928243dd9348b4ac48127593~tplv-k3u1fbpfcp-zoom-1.image" alt loading="lazy" referrerpolicy="no-referrer"><img alt title="点击并拖拽以移动" loading="lazy" src="https://juejin.cn/post/undefined" referrerpolicy="no-referrer">​ 单机环境下，arthas是调试单机调用耗时的好工具，我不止一次使用它的<code>trace</code>命令完成了性能调优。在分布式环境下，skywalking类似的分布式调用链工具，也能助我们一臂之力。</p>
<h2 data-id="heading-3">END</h2>
<p>有人可能觉得，我们上面列出的这些工具命令，实在是太多了，学不完，其实不是这样的。</p>
<p>在遇到性能问题，想要找到它的具体原因之时，你才会恨手头的工具太少，以至于期望有更加强劲的工具。</p>
<p>书到用时方恨少，事非经过不知难。</p>
<p>作为工程师，我们的工作，就是从这诸多的工具里，选择合适的组合，直捣黄龙。</p>
<p>当然，如果你捣的不太对，那后果就不太好了。参考文章开头的题外话，永远不要抢着去做这种费力不讨好的事情。性能优化这个东西，是一把双刃剑。可能会让你扶摇直上，也可能会让跌入谷底。，一切和你所处的团队有关。</p>
<h1 data-id="heading-4">可关注我的B站账号→→→→<a href="https://space.bilibili.com/618498318" target="_blank" rel="nofollow noopener noreferrer">B站账号</a></h1>
<h1 data-id="heading-5">学习交流群→→→→<a href="https://docs.qq.com/doc/DVURTSlpDZUJxVlNM" target="_blank" rel="nofollow noopener noreferrer">交流群</a></h1></div>  
</div>
            