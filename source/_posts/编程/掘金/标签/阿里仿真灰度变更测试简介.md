
---
title: '阿里仿真灰度变更测试简介'
categories: 
 - 编程
 - 掘金
 - 标签
headimg: 'https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/8d1ae1dd7f9f45b1af6b59e40a55d4b2~tplv-k3u1fbpfcp-zoom-1.image'
author: 掘金
comments: false
date: Thu, 29 Jul 2021 21:58:53 GMT
thumbnail: 'https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/8d1ae1dd7f9f45b1af6b59e40a55d4b2~tplv-k3u1fbpfcp-zoom-1.image'
---

<div>   
<div class="markdown-body"><style>.markdown-body&#123;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333&#125;.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6&#123;line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px&#125;.markdown-body h1&#123;font-size:30px;margin-bottom:5px&#125;.markdown-body h2&#123;padding-bottom:12px;font-size:24px;border-bottom:1px solid #ececec&#125;.markdown-body h3&#123;font-size:18px;padding-bottom:0&#125;.markdown-body h4&#123;font-size:16px&#125;.markdown-body h5&#123;font-size:15px&#125;.markdown-body h6&#123;margin-top:5px&#125;.markdown-body p&#123;line-height:inherit;margin-top:22px;margin-bottom:22px&#125;.markdown-body img&#123;max-width:100%&#125;.markdown-body hr&#123;border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px&#125;.markdown-body code&#123;word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em&#125;.markdown-body code,.markdown-body pre&#123;font-family:Menlo,Monaco,Consolas,Courier New,monospace&#125;.markdown-body pre&#123;overflow:auto;position:relative;line-height:1.75&#125;.markdown-body pre>code&#123;font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8&#125;.markdown-body a&#123;text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff&#125;.markdown-body a:active,.markdown-body a:hover&#123;color:#275b8c&#125;.markdown-body table&#123;display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6&#125;.markdown-body thead&#123;background:#f6f6f6;color:#000;text-align:left&#125;.markdown-body tr:nth-child(2n)&#123;background-color:#fcfcfc&#125;.markdown-body td,.markdown-body th&#123;padding:12px 7px;line-height:24px&#125;.markdown-body td&#123;min-width:120px&#125;.markdown-body blockquote&#123;color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8&#125;.markdown-body blockquote:after&#123;display:block;content:""&#125;.markdown-body blockquote>p&#123;margin:10px 0&#125;.markdown-body ol,.markdown-body ul&#123;padding-left:28px&#125;.markdown-body ol li,.markdown-body ul li&#123;margin-bottom:0;list-style:inherit&#125;.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item&#123;list-style:none&#125;.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul&#123;margin-top:0&#125;.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul&#123;margin-top:3px&#125;.markdown-body ol li&#123;padding-left:6px&#125;.markdown-body .contains-task-list&#123;padding-left:0&#125;.markdown-body .task-list-item&#123;list-style:none&#125;@media (max-width:720px)&#123;.markdown-body h1&#123;font-size:24px&#125;.markdown-body h2&#123;font-size:20px&#125;.markdown-body h3&#123;font-size:18px&#125;&#125;</style><p>简介： 基础网络产品的生命周期大致包含研发、架构、交付、优化和运营等几个环节，每一个环节的质量保证都涉及重要的一环，即预期验证测试。本文将重点讲解一下如何在仿真测试平台进行灰度变更测试，从而保证变更的稳定性。</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/8d1ae1dd7f9f45b1af6b59e40a55d4b2~tplv-k3u1fbpfcp-zoom-1.image" alt loading="lazy" referrerpolicy="no-referrer"></p>
<p>作者 | 聪敬、苏玮、玖玄、林涛<br>
来源 | 阿里技术公众号</p>
<h1 data-id="heading-0">一 前言</h1>
<p>基础网络产品的生命周期大致包含研发、架构、交付、优化和运营等几个环节，每一个环节的质量保证都涉及重要的一环，即预期验证测试。比如研发的功能测试，架构的POC测试/AVL测试，交付的配置验收，优化的灰度变更和方案测试，运营的GNOC模版测试/演练/LANDING测试等等。如何安全、高效和低成本地保证这些环节能够稳定持续运行呢？自动化测试平台Full-Automation-Simple-Touch（FAST）应运而生，为网络全生命周期测试提供了平台，提升网络的稳定性。</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1532d28c5db34575a4ebe5f923fa7528~tplv-k3u1fbpfcp-zoom-1.image" alt loading="lazy" referrerpolicy="no-referrer"></p>
<p>本文将重点讲解一下如何在仿真测试平台进行灰度变更测试，从而保证变更的稳定性。</p>
<h1 data-id="heading-1">二 技术引领稳定变更的必要性</h1>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0f170987ddee4ba49ad53c4b35e20025~tplv-k3u1fbpfcp-zoom-1.image" alt loading="lazy" referrerpolicy="no-referrer"></p>
<p>众所周知，网络变更的数量在逐年递增，从2016到2020年，变更数量增加了5倍，同时网络规模复杂度也在提升，如何在人力资源没有增加的前提下保证变更的稳定性，是一件非常具有挑战而且非常重要的事情。设想如果能在真正变更前把变更方案在测试环境中提前灰度验证，保证提前发现并解决潜在的问题，将大幅度提高变更稳定性。</p>
<h1 data-id="heading-2">三 变更稳定性流程剖析</h1>
<p>灰度变更测试是为变更流程中的各个环节提供提前验证的能力。比如说验证方案中的CLI是否能正确下发到设备，验证配置下发到设备后的行为是否符合预期，验证设备之间的状态交互是否正常。还可以模拟异常条件，提供紧急应对措施的验证。提前发现问题并且验证解决方案，是灰度变更测试的核心价值之一（保证稳定性）。</p>
<p>另外一个核心价值就是成本效率的提升，使用了厂商提供的镜像，通过仿真技术可以快速搭建一个灰度测试环境， 一般是在分钟/小时级别，具体要看规模。而搭建一个相同的物理环境需要几个星期，甚至是几个月，因为涉及到采购，交付上架，连线等等，另外仿真设备本身的成本也远低于物理设备的成本。</p>
<h1 data-id="heading-3">四 阿里巴巴AIS网络仿真系统</h1>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e1c629c93f864c8da602215cac9f60cb~tplv-k3u1fbpfcp-zoom-1.image" alt loading="lazy" referrerpolicy="no-referrer"></p>
<p>阿里巴巴AIS网络仿真系统是什么样的呢？</p>
<p>在2018年前是没有网络仿真环境的，2018后我们开始着手搭建了核心网的仿真灰度环境，根据现网设备配置/现网拓扑/现网路由，加上厂商提供的设备镜像，通过仿真技术，搭建了一个协议1：1低成本高保真的仿真环境，并且完成了和线上自动化运维系统的对接，实现了灰度变更测试从0到1的飞跃。</p>
<p>上图的左半边是一个典型的阿里生产网络，2个IDC数据中心通过骨干网链接起来，操作人员通过跳板机链接到物理目标设备，然后进行一系列操作。上图的右半边是我们仿真出来的一个仿真网络。从操作人员的角度来看，也是通过跳板机，经过仿真和真实之间的TCP/IP代理服务，就可以轻松地进入虚拟世界，对仿真设备进行相应的操作。除了基本的操作能力外，在仿真系统中也加入仿真特有的功能，比如预期判断/故障演练/健康检查/安全防护等等。</p>
<p>同时由于是仿真环境，我们可以轻松地制造出多个仿真环境，用于不同的场景。</p>
<h1 data-id="heading-4">五 仿真系统构建的挑战示例</h1>
<p>构建仿真系统挑战很多，这里列举了几个比较重要的挑战：</p>
<p><strong>大规模光纤仿真</strong></p>
<p>我们模拟了整个近千台设备的互联，怎么保证这些链接的稳定可靠至关重要，因为链接不可靠，容易导致丢包/延迟等，严重影响环境质量。</p>
<p><strong>镜像和物理设备端口不一致</strong></p>
<p>仿真镜像自身有一些无法改动的设置，包括端口名字和数目，无法直接和现实网络做到严格1:1。</p>
<p><strong>自身可信度保障</strong></p>
<p>建立仿真环境后，面临的很大的挑战就是，怎么验证和线上的一致性。</p>
<p><strong>路由注入</strong></p>
<p>仿真环境镜像/连线/配置完成后，还需要引入实际业务数据，比较关注的就是自动化的路由注入。</p>
<p><strong>厂商镜像不足</strong></p>
<p>IDC内部分厂商的镜像还没有镜像，我们采用了混部多协议逻辑验证 （HPLV hybrid protocols logic verification）来扩展IDC设备。</p>
<h1 data-id="heading-5">六 业界产品比较</h1>
<p>相对于其他公司，其实阿里的网络更复杂，主要体现架构更多，设备的厂商更多，这些都给网络带来了更大的复杂度，所以可以想象，要在阿里的网络里面完成灰度测试环境的搭建难度要远比想象中的大。</p>
<h1 data-id="heading-6">七 流程规范化的挑战</h1>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/bab3b420bf53440594de2763d9d1156b~tplv-k3u1fbpfcp-zoom-1.image" alt loading="lazy" referrerpolicy="no-referrer"></p>
<p>有了仿真环境后，还需要有可靠的流程来保障灰度变更，为此我们在变更流程中引入了方案测试和灰度测试两个环节。</p>
<p>方案测试是在方案设计之后，评审上线之前，用于判断测试方案的各个环节是否都有被测试覆盖、不同维度测试是否完整。理论上只有经过方案测试达标后的方案才能评审上线，为方案的稳定性设立的第一道关卡。</p>
<p>方案测试的特点如下：</p>
<ul>
<li>根据维度自动生成用例（这里的维度指的是一类属性的概念，比如厂商，角色等等）</li>
<li>批量并发执行，提高执行效率。</li>
<li>执行完后有统计数据支持维度级别的精确上线控制。</li>
</ul>
<p>变更测试的第二个关卡是在变更工单审核之前做了流程卡点，对于核心网变更，如果没有经过灰度测试是无法提交工单审核的，从流程中保证了“无灰度不变更”。</p>
<h1 data-id="heading-7">八 落地场景与结果</h1>
<ul>
<li>自动化系统能力的保障</li>
<li>月平均拦截40次变更风险</li>
</ul>
<h1 data-id="heading-8">九 未来展望</h1>
<ul>
<li>扩大支持覆盖率</li>
<li>平台自助化/智能化</li>
<li>商业化</li>
</ul>
<p><a href="https://link.juejin.cn/?target=http%3A%2F%2Fclick.aliyun.com%2Fm%2F1000286550%2F" target="_blank" rel="nofollow noopener noreferrer" title="http://click.aliyun.com/m/1000286550/" ref="nofollow noopener noreferrer">原文链接</a></p>
<p>本文为阿里云原创内容，未经允许不得转载。</p></div>  
</div>
            