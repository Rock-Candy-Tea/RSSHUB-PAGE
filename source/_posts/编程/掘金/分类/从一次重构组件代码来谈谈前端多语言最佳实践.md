
---
title: '从一次重构组件代码来谈谈前端多语言最佳实践'
categories: 
 - 编程
 - 掘金
 - 分类
headimg: 'https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/90d8c6b032de4dc6b8375a1166da7a9a~tplv-k3u1fbpfcp-zoom-1.image'
author: 掘金
comments: false
date: Sun, 16 May 2021 19:34:39 GMT
thumbnail: 'https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/90d8c6b032de4dc6b8375a1166da7a9a~tplv-k3u1fbpfcp-zoom-1.image'
---

<div>   
<div class="markdown-body"><style>.markdown-body&#123;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333&#125;.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6&#123;line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px&#125;.markdown-body h1&#123;font-size:30px;margin-bottom:5px&#125;.markdown-body h2&#123;padding-bottom:12px;font-size:24px;border-bottom:1px solid #ececec&#125;.markdown-body h3&#123;font-size:18px;padding-bottom:0&#125;.markdown-body h4&#123;font-size:16px&#125;.markdown-body h5&#123;font-size:15px&#125;.markdown-body h6&#123;margin-top:5px&#125;.markdown-body p&#123;line-height:inherit;margin-top:22px;margin-bottom:22px&#125;.markdown-body img&#123;max-width:100%&#125;.markdown-body hr&#123;border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px&#125;.markdown-body code&#123;word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em&#125;.markdown-body code,.markdown-body pre&#123;font-family:Menlo,Monaco,Consolas,Courier New,monospace&#125;.markdown-body pre&#123;overflow:auto;position:relative;line-height:1.75&#125;.markdown-body pre>code&#123;font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8&#125;.markdown-body a&#123;text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff&#125;.markdown-body a:active,.markdown-body a:hover&#123;color:#275b8c&#125;.markdown-body table&#123;display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6&#125;.markdown-body thead&#123;background:#f6f6f6;color:#000;text-align:left&#125;.markdown-body tr:nth-child(2n)&#123;background-color:#fcfcfc&#125;.markdown-body td,.markdown-body th&#123;padding:12px 7px;line-height:24px&#125;.markdown-body td&#123;min-width:120px&#125;.markdown-body blockquote&#123;color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8&#125;.markdown-body blockquote:after&#123;display:block;content:""&#125;.markdown-body blockquote>p&#123;margin:10px 0&#125;.markdown-body ol,.markdown-body ul&#123;padding-left:28px&#125;.markdown-body ol li,.markdown-body ul li&#123;margin-bottom:0;list-style:inherit&#125;.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item&#123;list-style:none&#125;.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul&#123;margin-top:0&#125;.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul&#123;margin-top:3px&#125;.markdown-body ol li&#123;padding-left:6px&#125;.markdown-body .contains-task-list&#123;padding-left:0&#125;.markdown-body .task-list-item&#123;list-style:none&#125;@media (max-width:720px)&#123;.markdown-body h1&#123;font-size:24px&#125;.markdown-body h2&#123;font-size:20px&#125;.markdown-body h3&#123;font-size:18px&#125;&#125;</style><h2 data-id="heading-0">重构代码背景</h2>
<p>我们的一些业务组件需要支持多语言，这些<strong>单独发包</strong>的组件翻译文案通常都维护在项目一些文件夹下，并且每个需要翻译的文案在代码中都需要手动用 intl.get(key)包裹来实现运行时翻译，开发者也需要根据这些文案一个一个去谷歌进行多种语言翻译，然后再写到项目中。这在无形中给组件开发者加重了开发成本，并且如果翻译有误，PM 和运营同学也无法去代码仓库去修改这些翻译。所以业务组件需要一套更标准，更轻量的多语言方案，来替代上面这些手动工作。经过一些调研后，<strong>决定采用公司的 translate-cli</strong> <strong>+ 国际化翻译平台 + 外部开源的</strong> <strong><a href="https://github.com/alibaba/react-intl-universal" target="_blank" rel="nofollow noopener noreferrer">react-intl-universal</a></strong> <strong>来完成组件的多语言。</strong></p>
<p>既然决定了采用新的多语言方案，那么目前翻译文案维护在本地的现存组件就要去改造来接入新的多语言方案。<strong>但是现存的组件有 30+个，如果让这些组件的开发者每个组件一个一个文件去改造，会带来很大的成本</strong>。而且这些组件的修改内容其实都是一样的，那么完全可以开发一个 CLI 命令去让开发者在自己的组件根目录执行一次，一键完成组件的多语言方案迁移。这样就能很大的减轻了开发者的改造成本。</p>
<h2 data-id="heading-1">业界 React 项目多语言实践的一些探索</h2>
<p>GitHub 上有一些比较成熟的多语言库如下：</p>
<p><a href="https://github.com/i18next/react-i18next" target="_blank" rel="nofollow noopener noreferrer">react-i18next</a></p>
<p><a href="https://github.com/yahoo/react-intl" target="_blank" rel="nofollow noopener noreferrer">react-intl</a></p>
<p><a href="https://github.com/alibaba/react-intl-universal" target="_blank" rel="nofollow noopener noreferrer">react-intl-universal</a></p>
<p>以上这些库基本上就是业界用到最多的用于解决 React 项目多语言的工具库了。上面这些库的用法我就不一一介绍了，其 API 设计和使用上十分类似，基本上就是项目需要将每种语言的文案维护在不同文件下,类似于下图，英日中各维护一个文件,每增加一种语言就需要多维护一个 JSON</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/90d8c6b032de4dc6b8375a1166da7a9a~tplv-k3u1fbpfcp-zoom-1.image" alt loading="lazy" referrerpolicy="no-referrer"></p>
<p>每个文件的内容如下图：类似 key: value 的形式，key 就是我们定义的标识某条文案的 code，value 则是文案在中英日语言下的翻译文案。</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d3379dd2501d4b3c95fad148a8fd4498~tplv-k3u1fbpfcp-zoom-1.image" alt loading="lazy" referrerpolicy="no-referrer"></p>
<p>然后这些库会提供一些<strong>Init, translate 等函数</strong></p>
<h3 data-id="heading-2">初始化(init)</h3>
<p>init 函数需在项目初始化时调用，传入当前的语言和语言对应的文案 JSON。这样就相当于把翻译文案给注册到这些工具内部了</p>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-keyword">import</span> intl <span class="hljs-keyword">from</span> <span class="hljs-string">'react-intl-universal'</span>;
<span class="hljs-keyword">const</span> locales = &#123;
    <span class="hljs-string">"en"</span>: <span class="hljs-built_in">require</span>(<span class="hljs-string">'./locales/en.json'</span>),
    <span class="hljs-string">"zh"</span>: <span class="hljs-built_in">require</span>(<span class="hljs-string">'./locales/zh.json'</span>)
 &#125;;
intl.init(&#123;
     <span class="hljs-attr">currentLocale</span>: <span class="hljs-string">'en'</span>,
     locales
&#125;)
<span class="copy-code-btn">复制代码</span></code></pre>
<h3 data-id="heading-3">调用(translate)</h3>
<p>然后在需要多语言的代码侧，使用这些工具提供的<strong>translate 函数，如下的 intl.get。translate 函数就会拿入参中的 key 去上一步注册到工具内部的 json 去取对应的翻译文案。</strong></p>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-keyword">import</span> intl <span class="hljs-keyword">from</span> <span class="hljs-string">'react-intl-universal'</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Component</span> </span>&#123;
    <span class="hljs-function"><span class="hljs-title">render</span>(<span class="hljs-params"></span>)</span> &#123;
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag"><<span class="hljs-name">div</span>></span>&#123;intl.get('INPUT_MOBILE')&#125;<span class="hljs-tag"></<span class="hljs-name">div</span>></span></span>
    )
  &#125;
&#125;
<span class="copy-code-btn">复制代码</span></code></pre>
<p>这样就能简单的实现一个项目国际化了。</p>
<h3 data-id="heading-4">缺点</h3>
<p>业界目前的这些方案也有一些缺点</p>
<ol>
<li>项目中需要进行多语言的文案，开发者都需手动去用 translate 函数替换。</li>
<li>开发者还需要手动维护 en.json,ja.json 等多种语言的翻译文案。</li>
<li>开发者需要自己保证 lang.json 中的 key 和 intl.get(key)中的 key 是正确对应的，一旦需要多语言的文案有成百上千条，很容易造成 intl.get(key)中对应的翻译错误。这无形中也给开发者带来心智负担。</li>
<li>因为我们大部分项目都是有产品和运营的，一般翻译也是靠产品和运营来检查维护。json 维护在项目内，产品如果需要修改翻译，就需要联系开发者去修改。这也增大了翻译的维护成本。</li>
</ol>
<h2 data-id="heading-5">名词解释</h2>
<p>由于文章中用到了一些公司内尚未开源的技术，所以就给这些技术暂时起了一些化名，如果后面这些技术开源了，欢迎大家使用。下面主要进行一些名词解释，方便读者阅读</p>
<h3 data-id="heading-6">国际化翻译平台</h3>
<p>字节跳动国际化团队自研的智能国际化翻译平台，为业务提供高效专业的【平台+服务】一站式多语言解决方案。该平台主要负责维护公司海外业务系统中用到的多种语言的翻译文案，目前还在内部使用阶段，预计今年对外开放</p>
<h3 data-id="heading-7">translate-cli(尚未开源)</h3>
<p>字节跳动国际化团队自研的一个命令行工具，主要作用是对代码一键文案扫描，机器翻译，文案上传至国际化翻译平台，文案替换等工作，解决开发者手动维护文案翻译的问题</p>
<h3 data-id="heading-8">文案扫描</h3>
<p>利用 translate-cli 来对项目代码进行扫描，并把代码中的中文扫描出来。并会在浏览器显示代码中有多少中文没有被 translate 函数包裹</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e253a7b87260406796d28ba8f48b3439~tplv-k3u1fbpfcp-zoom-1.image" alt loading="lazy" referrerpolicy="no-referrer"></p>
<p>扫描后还会根据中文文案生成一个多语言 key，并对该文案进行多种语言的机器翻译(可以是谷歌翻译)，最终生成如下的 JSON</p>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// en.json</span>
&#123;
    <span class="hljs-string">"component.template.multilingual_test"</span>: <span class="hljs-string">"Multilingual test"</span>
&#125;
<span class="copy-code-btn">复制代码</span></code></pre>
<h3 data-id="heading-9">文案上传</h3>
<p>translate-cli 会将上面文案扫描生成的 key，还有中文文案，以及 JSON(en,zh,ja 等)上传到国际化翻译平台平台，平台对应如下图,维护了各个语言的文案对应的 key 和翻译。</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f55ab013b5aa4abbb2fee2de471bd7ec~tplv-k3u1fbpfcp-zoom-1.image" alt loading="lazy" referrerpolicy="no-referrer"></p>
<h3 data-id="heading-10">文案替换</h3>
<p>translate-cli <strong>自动将代码中的'多语言'替换为 intl.get('component.template.multilingual_test')</strong> 或其他工具提供的 translate 函数，以实现代码在运行时能够显示对应的翻译文案</p>
<h3 data-id="heading-11">文案下载</h3>
<p>利用 translate-cli 将国际化翻译平台对应项目下的文案下载到本地，解决开发者手动维护翻译 JSON 的问题，也解决产品同学无法修改维护在代码中的翻译文案的问题</p>
<h2 data-id="heading-12">利用 CLI 工具重构组件代码</h2>
<h3 data-id="heading-13">CLI 工具选型</h3>
<p>CLI 工具使用<a href="https://github.com/tj/commander.js/blob/HEAD/Readme_zh-CN.md" target="_blank" rel="nofollow noopener noreferrer">commander</a>即可实现命令行工具的效果。</p>
<p>至于要实现 CLI 命令修改项目文件的功能，经过一些调研，最终选择了 facebook 开源的<a href="https://github.com/facebook/jscodeshift" target="_blank" rel="nofollow noopener noreferrer">jscodeshift</a>来实现组件代码的修改。</p>
<p>jscodeshift 的优点主要有：</p>
<ol>
<li>同时支持 JavaScript or TypeScript 的解析</li>
<li>API 简洁，只通过几个 API 即可完成代码修改</li>
<li>提供可视化的 code->AST 的网站：<a href="https://astexplorer.net/" target="_blank" rel="nofollow noopener noreferrer">astexplorer.net/</a> 。只需要把我们的 js 或 ts 代码贴进去，即可转换成一棵 AST 语法树。利用这个语法树再加上 API，很容易就能通过 js 代码找到文件指定的代码片段去修改。</li>
</ol>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2c2a291f96ca4cbabf1c093b1dbd1e11~tplv-k3u1fbpfcp-zoom-1.image" alt loading="lazy" referrerpolicy="no-referrer"></p>
<h3 data-id="heading-14">CLI 帮助组件开发者完成的事</h3>
<p>既然改造组件代码的工具确定了，接下来就该确定如何修改组件代码以实现多语言方案的迁移</p>
<p>下面列举了组件要改动的点</p>
<h4 data-id="heading-15">1. 修改组件 package.json</h4>
<p>既然组件多语言要采用 translate-cli，就需要在 package.json 提供 translate-cli 相关的命令供开发者执行。</p>
<h4 data-id="heading-16">解决方案</h4>
<p>修改 package.json，比较简单，只需要通过下面的代码即可完成 package.json 的 script 的修改。</p>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-keyword">const</span> data = <span class="hljs-built_in">require</span>(<span class="hljs-string">`<span class="hljs-subst">$&#123;process.cwd()&#125;</span>/package.json`</span>)
data.scripts.i18n =
<span class="hljs-string">"translate scan && translate upload && translate replace --force
   && translate scan --fallback && translate clean"</span>
<span class="copy-code-btn">复制代码</span></code></pre>
<h4 data-id="heading-17">2. 给组件安装 translate-cli, 添加 translate.config.js 配置文件</h4>
<h4 data-id="heading-18">解决方案</h4>
<p>给组件安装依赖的原理其实就是<strong>利用 node child_process 模块的 exec 函数，执行 npm 或 yarn 命令</strong></p>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-keyword">import</span> &#123; exec &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">'child_process'</span>
exec(<span class="hljs-string">'yarn add dependenceName'</span>, &#123;&#125;, fallback)
<span class="copy-code-btn">复制代码</span></code></pre>
<p>CLI 工具也会内置一份通用的 translate.config.js 在执行 CLI 命令时通过 node fs 模块将文件写入组件根目录下。</p>
<h4 data-id="heading-19">3. 修改组件 src 下的代码</h4>
<p>具体要改造的点为：之前组件内部自己维护了一个工具类<strong>intl</strong>，包含<strong>init</strong>和<strong>get</strong>方法，用于字典初始化和翻译。现在要替换成 react-intl-universal，和团队工具规范保持一致。那代码中使用相对路径 import 本地类的语句：<strong>import intl from '../i18n'</strong> 要全部删除，替换为<strong>import intl from 'react-intl-universal'</strong></p>
<h4 data-id="heading-20">解决方案</h4>
<p>这就需要用到我们上面提到的 jscodeshift 工具了。拿 import Intl from '../i18n' 改为 import Intl from 'react-intl-universal' 举例</p>
<p>下图可以看到左侧代码中的'../i18n'在右侧 AST 语法树中对应的是一个 type 为'<strong>StringLiteral</strong>'的 node。并且 node 的 value 为'../i18n'</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c452be0d663f40f88c158f617b55d39a~tplv-k3u1fbpfcp-zoom-1.image" alt loading="lazy" referrerpolicy="no-referrer"></p>
<p>要将组件代码中 import 声明中的'../i18n'转换为'react-intl-universal' ，具体过程如下：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1b8b1cdb0f1048dfa9ddfa8bfa874813~tplv-k3u1fbpfcp-zoom-1.image" alt loading="lazy" referrerpolicy="no-referrer"></p>
<p>具体代码如下：</p>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-keyword">const</span> jscodeshift = <span class="hljs-built_in">require</span>(<span class="hljs-string">'jscodeshift'</span>)
<span class="hljs-keyword">const</span> j = jscodeshift.withParser(<span class="hljs-string">'tsx'</span>)

<span class="hljs-keyword">const</span> modifyCommonFile = <span class="hljs-function">(<span class="hljs-params">source</span>) =></span> &#123;
  <span class="hljs-comment">// source为源代码，通过node fs.readFile获取的string</span>
  <span class="hljs-keyword">const</span> ast = j(source)
  <span class="hljs-keyword">const</span> imports = ast.find(j.StringLiteral)
  imports.filter(<span class="hljs-function"><span class="hljs-params">item</span> =></span> item.value.value.includes(<span class="hljs-string">'/i18n'</span>)).replaceWith(<span class="hljs-string">"'react-intl-universal'"</span>)
  <span class="hljs-keyword">return</span> ast.toSource()
&#125;
<span class="hljs-comment">// writeFile和readFile均是基于fs.writeFile和fs.readFile封装的函数</span>
<span class="hljs-keyword">const</span> originData = readFile(<span class="hljs-string">'filePath'</span>)
<span class="hljs-keyword">const</span> newData = modifyCommonFile(originData)
writeFile(<span class="hljs-string">'filePath'</span>, newData)
<span class="copy-code-btn">复制代码</span></code></pre>
<p>这样就完成了一个文件的修改，如果把组件 src 目录进行递归遍历一遍，取到 src 下所有文件的路径，然后执行上面的代码，就完成了组件整个 src 下文件的修改。</p>
<p>最后我们把上面 3 个改造方案实现代码放到我们封装的 cli 工具中，然后在组件根目录执行 cli 命令，即可完成组件的多语言工具一键迁移至 translate-cli 和 react-intl-universal。</p>
<h2 data-id="heading-21">多语言实践</h2>
<h3 data-id="heading-22">最佳多语言实践？！</h3>
<h4 data-id="heading-23">translate-cli 工具使用</h4>
<p>既然通过上面的 CLI 命令完成了组件多语言方案的迁移，给 package.json 添加了"i18n"的 script。那么我们就可以利用 package.json 中的 i18n 命令利用 translate-cli 进行组件多语言工作</p>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-string">"script"</span>: &#123;
   <span class="hljs-string">"i18n"</span>: <span class="hljs-string">"translate scan && translate upload && translate replace --force
   && translate scan --fallback && translate clean"</span>
&#125;
<span class="copy-code-btn">复制代码</span></code></pre>
<p>i18n 命令<strong>会串行的执行文案扫描，文案上传，文案替换，文案下载(参见名词解释)</strong></p>
<p><strong>这样组件开发者既不用手动去用 intl.get(key) 这个 translate 函数包裹需要翻译的文案了，也不用手动维护多种语言的翻译 json 和 key 了。开发者只需要在代码中写中文，然后开发完成后执行 npm run i18n。翻译问题 translate-cli 都会帮开发者搞定。如果 PM 或运营觉得部分机器翻译不准确，想要修改，只需要在国际化翻译平台修改翻译文案，然后开发者再次执行 npm run i18n 即可从国际化翻译平台拉取最新的文案到本地。这样既方便了开发者，也方便了产品。</strong></p>
<h4 data-id="heading-24">总结</h4>
<p>综上，我们 translate-cli+国际化翻译平台+i18n 工具库(react-intl-universal 等)，我们研发再也不用关心项目如何支持多语言了，这些工具会从编译+运行时来完成整个多语言的流程。PM 也只需去国际化翻译平台检查机器翻译的结果即可。这样岂不是一举两得？</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/493812f6087f449cb8c85998a5bd9a21~tplv-k3u1fbpfcp-zoom-1.image" alt loading="lazy" referrerpolicy="no-referrer"></p>
<h2 data-id="heading-25">展望</h2>
<p>本文从自己项目目前多语言的现状和问题出发，列举了目前业界一些多语言实践，并结合公司内部的一些实践，总结了一套最低成本解决项目多语言的方案。并阐述了如何利用<a href="https://github.com/tj/commander.js/blob/HEAD/Readme_zh-CN.md" target="_blank" rel="nofollow noopener noreferrer">commander</a>+<a href="https://github.com/facebook/jscodeshift" target="_blank" rel="nofollow noopener noreferrer">jscodeshift</a>来开发一个 CLI 帮助组件完成代码改造，从而实现组件多语言方案的迁移</p>
<p>希望阅读该文章后，能对阅读者在利用 CLI 批量改造项目代码或者项目多语言上有所帮助。</p>
<h2 data-id="heading-26">招聘硬广</h2>
<p>字节跳动商业变现部门成立于 2014 年，承担了抖音、头条、西瓜、TikTok 等字节全产品矩阵、国内海外的收入变现职责，持续数年为公司提供了极高增速的收入贡献！</p>
<p>如果想要加入我们的话，欢迎发送简历至 <a href="mailto:xuyunfang@bytedance.com">xuyunfang@bytedance.com</a>，我将第一时间为你内推。</p></div>  
</div>
            