
---
title: '云对象 - 重新定义前后端交互'
categories: 
 - 编程
 - 掘金
 - 分类
headimg: 'https://picsum.photos/400/300?random=1913'
author: 掘金
comments: false
date: Wed, 07 Sep 2022 19:11:50 GMT
thumbnail: 'https://picsum.photos/400/300?random=1913'
---

<div>   
<div class="markdown-body cache"><style>.markdown-body&#123;word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#333&#125;.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6&#123;line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px&#125;.markdown-body h1&#123;font-size:24px;margin-bottom:5px&#125;.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6&#123;font-size:20px&#125;.markdown-body h2&#123;padding-bottom:12px;border-bottom:1px solid #ececec&#125;.markdown-body h3&#123;font-size:18px;padding-bottom:0&#125;.markdown-body h6&#123;margin-top:5px&#125;.markdown-body p&#123;line-height:inherit;margin-top:22px;margin-bottom:22px&#125;.markdown-body img&#123;max-width:100%&#125;.markdown-body hr&#123;border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px&#125;.markdown-body code&#123;word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em&#125;.markdown-body code,.markdown-body pre&#123;font-family:Menlo,Monaco,Consolas,Courier New,monospace&#125;.markdown-body pre&#123;overflow:auto;position:relative;line-height:1.75&#125;.markdown-body pre>code&#123;font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8&#125;.markdown-body a&#123;text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff&#125;.markdown-body a:active,.markdown-body a:hover&#123;color:#275b8c&#125;.markdown-body table&#123;display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6&#125;.markdown-body thead&#123;background:#f6f6f6;color:#000;text-align:left&#125;.markdown-body tr:nth-child(2n)&#123;background-color:#fcfcfc&#125;.markdown-body td,.markdown-body th&#123;padding:12px 7px;line-height:24px&#125;.markdown-body td&#123;min-width:120px&#125;.markdown-body blockquote&#123;color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8&#125;.markdown-body blockquote:after&#123;display:block;content:""&#125;.markdown-body blockquote>p&#123;margin:10px 0&#125;.markdown-body ol,.markdown-body ul&#123;padding-left:28px&#125;.markdown-body ol li,.markdown-body ul li&#123;margin-bottom:0;list-style:inherit&#125;.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item&#123;list-style:none&#125;.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul&#123;margin-top:0&#125;.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul&#123;margin-top:3px&#125;.markdown-body ol li&#123;padding-left:6px&#125;.markdown-body .contains-task-list&#123;padding-left:0&#125;.markdown-body .task-list-item&#123;list-style:none&#125;@media (max-width:720px)&#123;.markdown-body h1&#123;font-size:24px&#125;.markdown-body h2&#123;font-size:20px&#125;.markdown-body h3&#123;font-size:18px&#125;&#125;</style><h2 data-id="heading-0">背景</h2>
<p>从2000年开始，<code>xml</code>作为数据交换格式开始流行，服务器拼接<code>xml</code>接口，客户端js获取<code>xml</code>内容，动态修改页面。</p>
<p>几年后，数据量更小的<code>json</code>替代了<code>xml</code>。</p>
<p>移动互联网到来后，因为客户端分裂，加剧了接口的泛滥。</p>
<p>一转眼，接口已经玩了20年了。其他技术飞速发展，而前后端交互却一直是接口，没有什么创新。</p>
<p>js已经有了<code>import</code>、<code>export</code>，为什么调用后端接口，不能像调用一个前端模块一样呢？</p>
<p>serverless，让这一切开始了变化。</p>
<p>亚马逊<code>lambda</code>提出了云函数的概念，不再使用<code>restful</code>的<code>url</code>，但仍然是基于<code>json</code>交换前后端数据。</p>
<p><code>uniCloud</code>最初也以支持云函数为开始，但我们发现这仍不够优雅、简洁、直观、统一。</p>
<p>从<code>HBuilderX 3.4</code> 开始，<code>uniCloud</code>推出了“<strong>云对象</strong>”，让调用云端服务，真正变成像调用前端模块一样简单。</p>
<h2 data-id="heading-1">什么是云对象</h2>
<p>云对象：服务器编写API，客户端调用API，不再开发传输json的接口。思路更清晰、代码更精简。</p>
<p>比如服务端编写一个云对象news，该对象导出若干方法：add()、getList()、getDetailById()、softDel()、changeContent()、allowPublic()、addComment()、getComments()...等方法。</p>
<p>客户端的js则可以直接<code>import</code>这个<code>news</code>云对象，然后直接调用<code>add</code>等方法。</p>
<p>服务器示例代码如下：</p>
<p>HBuilderX中在uniCloud/cloudfunctions目录新建云函数/云对象，选择类型为云对象，起名为news。打开云对象入口<code>index.obj.js</code>，添加一个add方法。</p>
<pre><code class="hljs language-scss copyable" lang="scss"><span class="hljs-comment">// 云对象名：news</span>
module<span class="hljs-selector-class">.exports</span> = &#123;
<span class="hljs-built_in">add</span>(title, content) &#123;
title = title<span class="hljs-selector-class">.trim</span>()
<span class="hljs-attribute">content</span> = <span class="hljs-attribute">content</span><span class="hljs-selector-class">.trim</span>()
<span class="hljs-built_in">if</span>(!title || !content) &#123;
return &#123;
errCode: <span class="hljs-string">'INVALID_NEWS'</span>,
errMsg: <span class="hljs-string">'标题或内容不可为空'</span>
&#125;
&#125;
<span class="hljs-comment">// ...其他逻辑</span>
return &#123;
errCode: <span class="hljs-number">0</span>,
errMsg: <span class="hljs-string">'创建成功'</span>
&#125;
&#125;
&#125;
<span class="copy-code-btn">复制代码</span></code></pre>
<p>然后在客户端的js中，<code>import</code>这个<code>news</code>对象，调用它的<code>add</code>方法。</p>
<pre><code class="hljs language-csharp copyable" lang="csharp"><span class="hljs-keyword">const</span> news = uniCloud.importObject(<span class="hljs-string">'news'</span>) <span class="hljs-comment">//第一步导入云对象</span>
<span class="hljs-function"><span class="hljs-keyword">async</span> function <span class="hljs-title">add</span> ()</span> &#123;
<span class="hljs-keyword">try</span> &#123;
<span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> news.<span class="hljs-keyword">add</span>(<span class="hljs-string">'title demo'</span>, <span class="hljs-string">'content demo'</span>) <span class="hljs-comment">//导入云对象后就可以直接调用该对象的方法了，注意使用异步await</span>
uni.showToast(&#123;
title: <span class="hljs-string">'创建成功'</span>
&#125;)
&#125; <span class="hljs-keyword">catch</span> (e) &#123; <span class="hljs-comment">// 符合uniCloud响应体规范 https://uniapp.dcloud.net.cn/uniCloud/cf-functions?id=resformat，自动抛出此错误 </span>
&#125;
&#125;
<span class="copy-code-btn">复制代码</span></code></pre>
<p>可以看到云对象的代码非常清晰，代码行数也只有<strong>27</strong>行。</p>
<p>而同样的逻辑，使用传统的接口方式则需要更多代码，见下：</p>
<pre><code class="hljs language-javascript copyable" lang="javascript"><span class="hljs-comment">// 传统方式调用云函数-云函数代码</span>
<span class="hljs-comment">// 云函数名：news</span>
<span class="hljs-comment">// 云函数入口index.js内容如下</span>
<span class="hljs-meta">'use strict'</span>;
<span class="hljs-built_in">exports</span>.<span class="hljs-property">main</span> = <span class="hljs-keyword">async</span> (event, context) => &#123;
<span class="hljs-keyword">const</span> &#123;
method,
params
&#125; = event
<span class="hljs-keyword">switch</span>(method) &#123;
<span class="hljs-keyword">case</span> <span class="hljs-string">'add'</span>: &#123;
<span class="hljs-keyword">let</span> &#123;
title,
content
&#125; = params
title = title.<span class="hljs-title function_">trim</span>()
content = content.<span class="hljs-title function_">trim</span>()
<span class="hljs-keyword">if</span>(!title || !content) &#123;
<span class="hljs-keyword">return</span> &#123;
<span class="hljs-attr">errCode</span>: <span class="hljs-string">'INVALID_NEWS'</span>,
<span class="hljs-attr">errMsg</span>: <span class="hljs-string">'NEWS标题或内容不可为空'</span>
&#125;
&#125;
<span class="hljs-comment">// ...省略其他逻辑</span>
<span class="hljs-keyword">return</span> &#123;
<span class="hljs-attr">errCode</span>: <span class="hljs-number">0</span>,
<span class="hljs-attr">errMsg</span>: <span class="hljs-string">'创建成功'</span>
&#125;
&#125;
&#125;
<span class="hljs-keyword">return</span> &#123;
<span class="hljs-attr">errCode</span>: <span class="hljs-string">'METHOD_NOT_FOUND'</span>,
<span class="hljs-attr">errMsg</span>: <span class="hljs-string">`Method[<span class="hljs-subst">$&#123;method&#125;</span>] not found`</span>
&#125;
&#125;;
<span class="copy-code-btn">复制代码</span></code></pre>
<p>传统方式调用云函数-客户端代码</p>
<pre><code class="hljs language-php copyable" lang="php">async <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">add</span> (<span class="hljs-params"></span>) </span>&#123;
<span class="hljs-keyword">try</span> &#123;
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">res</span> = uniCloud.<span class="hljs-title function_ invoke__">callFunction</span>(&#123;
<span class="hljs-attr">name</span>: <span class="hljs-string">'news'</span>, 
<span class="hljs-attr">data</span>: &#123;
<span class="hljs-attr">method</span>: <span class="hljs-string">'add'</span>,
<span class="hljs-attr">params</span>: &#123;
<span class="hljs-attr">title</span>: <span class="hljs-string">'title demo'</span>,
<span class="hljs-attr">content</span>: <span class="hljs-string">'content demo'</span>
&#125;
&#125;
&#125;)
<span class="hljs-keyword">const</span> &#123;
errCode,
errMsg
&#125; = res.result
<span class="hljs-keyword">if</span>(errCode) &#123;
uni.<span class="hljs-title function_ invoke__">showModal</span>(&#123;
<span class="hljs-attr">title</span>: <span class="hljs-string">'创建失败'</span>,
<span class="hljs-attr">content</span>: errMsg,
<span class="hljs-attr">showCancel</span>: <span class="hljs-literal">false</span>
&#125;)
<span class="hljs-keyword">return</span>
&#125;
uni.<span class="hljs-title function_ invoke__">showToast</span>(&#123;
<span class="hljs-attr">title</span>: <span class="hljs-string">'创建成功'</span>
&#125;)
&#125; <span class="hljs-keyword">catch</span> (e) &#123;
uni.<span class="hljs-title function_ invoke__">showModal</span>(&#123;
<span class="hljs-attr">title</span>: <span class="hljs-string">'创建失败'</span>,
<span class="hljs-attr">content</span>: e.message,
<span class="hljs-attr">showCancel</span>: <span class="hljs-literal">false</span>
&#125;)
&#125;
&#125;
<span class="copy-code-btn">复制代码</span></code></pre>
<p>以上传统开发需要<strong>68</strong>行代码，对比云对象的<strong>27</strong>行代码，可以说“又丑又长”</p>
<h2 data-id="heading-2">更多强大功能</h2>
<p><strong>1. 预处理与后处理</strong></p>
<p>无论请求云对象的哪个方法，开始前都会经过<code>_before</code>方法，结束会执行<code>_after</code>方法。这有助于统一的提前校验和格式化错误。</p>
<p>示例：</p>
<pre><code class="hljs language-javascript copyable" lang="javascript"><span class="hljs-comment">// news/index.obj.js</span>
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = &#123;
<span class="hljs-attr">_before</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;
<span class="hljs-variable language_">this</span>.<span class="hljs-property">startTime</span> = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() <span class="hljs-comment">// 在before内记录开始时间并在this上挂载，以供后续流程使用</span>
<span class="hljs-keyword">const</span> methodName = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getMethodName</span>() <span class="hljs-comment">// 获取当前请求的云对象方法名</span>
<span class="hljs-keyword">if</span>(methodName === <span class="hljs-string">'add'</span> && !<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUniIdToken</span>()) &#123;
<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'token不存在'</span>)
&#125;
&#125;,
<span class="hljs-attr">add</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">title = <span class="hljs-string">''</span>, content = <span class="hljs-string">''</span></span>) &#123;
<span class="hljs-keyword">if</span>(title === <span class="hljs-string">'abc'</span>) &#123;
<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'abc不是一个合法的news标题'</span>)
&#125;
<span class="hljs-keyword">return</span> &#123;
<span class="hljs-attr">errCode</span>: <span class="hljs-number">0</span>,
<span class="hljs-attr">errMsg</span>: <span class="hljs-string">'创建成功'</span>
&#125;
&#125;,
<span class="hljs-title function_">_after</span>(<span class="hljs-params">error, result</span>) &#123;
<span class="hljs-keyword">if</span>(error) &#123;
<span class="hljs-keyword">throw</span> error <span class="hljs-comment">// 如果方法抛出错误，也直接抛出不处理</span>
&#125;
result.<span class="hljs-property">timeCost</span> = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() - <span class="hljs-variable language_">this</span>.<span class="hljs-property">startTime</span>
<span class="hljs-keyword">return</span> result
&#125;
&#125;
<span class="copy-code-btn">复制代码</span></code></pre>
<p><strong>2. 云对象的返回值兼容uniCloud响应体规范</strong></p>
<p>云对象返回值默认为<code>uniCloud响应体规范</code>，方便客户端统一拦截错误。</p>
<p>无论网络异常，还是token过期，都可以统一拦截提示。</p>
<p>详见<a href="https://link.juejin.cn/?target=https%3A%2F%2Funiapp.dcloud.net.cn%2FuniCloud%2Fcf-functions%23resformat" target="_blank" rel="nofollow noopener noreferrer" title="https://uniapp.dcloud.net.cn/uniCloud/cf-functions#resformat" ref="nofollow noopener noreferrer">uniCloud响应体规范</a></p>
<p><strong>3. 自动显示交互界面</strong></p>
<p>每次写客户端联网的代码时，开发者都免不了重复写一堆代码：先调用loading等待框，联网结束后再关闭loading，如果服务器异常则弹出提示框。</p>
<p>原来的写法（22行）：</p>
<pre><code class="hljs language-js copyable" lang="js">uni.<span class="hljs-title function_">showLoading</span>(&#123;
<span class="hljs-attr">title</span>: <span class="hljs-string">'联网中...'</span>
&#125;)
uni.<span class="hljs-title function_">request</span>(&#123;
<span class="hljs-attr">url</span>: <span class="hljs-string">"xxxx"</span>,
<span class="hljs-attr">success</span>: <span class="hljs-function">(<span class="hljs-params">res</span>) =></span> &#123;
uni.<span class="hljs-title function_">showToast</span>(&#123;
<span class="hljs-attr">title</span>: <span class="hljs-string">'添加成功'</span>,
<span class="hljs-attr">icon</span>: <span class="hljs-string">'success'</span>,
<span class="hljs-attr">mask</span>: <span class="hljs-literal">true</span>,
<span class="hljs-attr">duration</span>: duration
&#125;);
&#125;,
<span class="hljs-attr">fail</span>: <span class="hljs-function">(<span class="hljs-params">err</span>) =></span> &#123;
uni.<span class="hljs-title function_">showModal</span>(&#123;
<span class="hljs-attr">content</span>: err.<span class="hljs-property">errMsg</span>,
<span class="hljs-attr">showCancel</span>: <span class="hljs-literal">false</span>
&#125;);
&#125;,
<span class="hljs-attr">complete</span>: <span class="hljs-function">() =></span> &#123;
uni.<span class="hljs-title function_">hideLoading</span>();
&#125;
&#125;);
<span class="copy-code-btn">复制代码</span></code></pre>
<p>现在，调用云对象的方法时，默认自带上述功能。</p>
<ul>
<li>在请求联网开始时显示loading等待框，</li>
<li>结束后隐藏loading</li>
<li>如果请求报错，显示弹窗（也可配置为显示Toast）</li>
</ul>
<pre><code class="hljs language-csharp copyable" lang="csharp"><span class="hljs-keyword">const</span> news = uniCloud.importObject(<span class="hljs-string">'news'</span>) <span class="hljs-comment">//第一步导入云对象</span>
<span class="hljs-keyword">try</span> &#123;
<span class="hljs-keyword">await</span> news.<span class="hljs-keyword">add</span>(<span class="hljs-string">'title demo'</span>, <span class="hljs-string">'content demo'</span>) <span class="hljs-comment">//导入云对象后就可以直接调用该对象的方法了，注意使用异步await</span>
uni.showToast(&#123;
title: <span class="hljs-string">'添加成功'</span>
&#125;)
&#125; <span class="hljs-keyword">catch</span> (e) &#123;&#125;
<span class="copy-code-btn">复制代码</span></code></pre>
<p>如上，原来需要<strong>23</strong>行的代码，现在<strong>7</strong>行就可以搞定！</p>
<p>当然，这些UI策略都可以自定义。</p>
<ol start="4">
<li>URL化</li>
</ol>
<p>为了历史兼容考虑，云对象同时提供了URL化方案。开发者仍然可以把一个云对象转换为一个<code>http</code>的<code>url</code>接口。</p>
<h2 data-id="heading-3">总结</h2>
<p>使用云对象带来的诸多好处：</p>
<ol>
<li>更清晰的逻辑</li>
<li>更精简的代码</li>
<li>更少的协作成本（以及矛盾~）</li>
<li>客户端调用时在ide里有完善的代码提示，方法参数均可提示。（传输<code>json</code>可没法在<code>ide</code>里提示）</li>
<li>自动支持<a href="https://link.juejin.cn/?target=uniCloud%2Fcf-functions.md%3Fid%3Dresformat" target="_blank" title="uniCloud/cf-functions.md?id=resformat" ref="nofollow noopener noreferrer">uniCloud响应体规范</a>，方便错误拦截和统一处理</li>
</ol>
<p>更多云对象介绍，参见：<a href="https://link.juejin.cn/?target=https%3A%2F%2Funiapp.dcloud.net.cn%2FuniCloud%2Fcloud-obj.html" target="_blank" rel="nofollow noopener noreferrer" title="https://uniapp.dcloud.net.cn/uniCloud/cloud-obj.html" ref="nofollow noopener noreferrer">uniapp.dcloud.net.cn/uniCloud/cl…</a></p></div>  
</div>
            