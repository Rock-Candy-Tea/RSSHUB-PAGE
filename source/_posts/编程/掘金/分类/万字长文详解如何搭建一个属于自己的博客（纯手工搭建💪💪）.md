
---
title: 'ä¸‡å­—é•¿æ–‡è¯¦è§£å¦‚ä½•æ­å»ºä¸€ä¸ªå±äºè‡ªå·±çš„åšå®¢ï¼ˆçº¯æ‰‹å·¥æ­å»ºğŸ’ªğŸ’ªï¼‰'
categories: 
 - ç¼–ç¨‹
 - æ˜é‡‘
 - åˆ†ç±»
headimg: 'https://assets.open.dzblog.cn/images/markdown/auth.png'
author: æ˜é‡‘
comments: false
date: Sat, 24 Apr 2021 02:04:34 GMT
thumbnail: 'https://assets.open.dzblog.cn/images/markdown/auth.png'
---

<div>   
<div class="markdown-body"><style>.markdown-body&#123;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333&#125;.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6&#123;line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px&#125;.markdown-body h1&#123;font-size:30px;margin-bottom:5px&#125;.markdown-body h2&#123;padding-bottom:12px;font-size:24px;border-bottom:1px solid #ececec&#125;.markdown-body h3&#123;font-size:18px;padding-bottom:0&#125;.markdown-body h4&#123;font-size:16px&#125;.markdown-body h5&#123;font-size:15px&#125;.markdown-body h6&#123;margin-top:5px&#125;.markdown-body p&#123;line-height:inherit;margin-top:22px;margin-bottom:22px&#125;.markdown-body img&#123;max-width:100%&#125;.markdown-body hr&#123;border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px&#125;.markdown-body code&#123;word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em&#125;.markdown-body code,.markdown-body pre&#123;font-family:Menlo,Monaco,Consolas,Courier New,monospace&#125;.markdown-body pre&#123;overflow:auto;position:relative;line-height:1.75&#125;.markdown-body pre>code&#123;font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8&#125;.markdown-body a&#123;text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff&#125;.markdown-body a:active,.markdown-body a:hover&#123;color:#275b8c&#125;.markdown-body table&#123;display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6&#125;.markdown-body thead&#123;background:#f6f6f6;color:#000;text-align:left&#125;.markdown-body tr:nth-child(2n)&#123;background-color:#fcfcfc&#125;.markdown-body td,.markdown-body th&#123;padding:12px 7px;line-height:24px&#125;.markdown-body td&#123;min-width:120px&#125;.markdown-body blockquote&#123;color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8&#125;.markdown-body blockquote:after&#123;display:block;content:""&#125;.markdown-body blockquote>p&#123;margin:10px 0&#125;.markdown-body ol,.markdown-body ul&#123;padding-left:28px&#125;.markdown-body ol li,.markdown-body ul li&#123;margin-bottom:0;list-style:inherit&#125;.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item&#123;list-style:none&#125;.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul&#123;margin-top:0&#125;.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul&#123;margin-top:3px&#125;.markdown-body ol li&#123;padding-left:6px&#125;.markdown-body .contains-task-list&#123;padding-left:0&#125;.markdown-body .task-list-item&#123;list-style:none&#125;@media (max-width:720px)&#123;.markdown-body h1&#123;font-size:24px&#125;.markdown-body h2&#123;font-size:20px&#125;.markdown-body h3&#123;font-size:18px&#125;&#125;</style><h2 data-id="heading-0">å‰è¨€</h2>
<p>å› ä¸ºè‡ªå·±ä»¥å‰å°±æ­å»ºäº†è‡ªå·±çš„åšå®¢ç³»ç»Ÿï¼Œé‚£æ—¶å€™åšå®¢ç³»ç»Ÿå‰ç«¯åŸºæœ¬ä¸Šéƒ½æ˜¯åŸºäº<code>vue</code>çš„ï¼Œè€Œç°åœ¨ç”¨çš„<code>react</code>åå¤šï¼Œäºæ˜¯ç”¨<code>react</code>å¯¹æ•´ä¸ªåšå®¢ç³»ç»Ÿè¿›è¡Œäº†ä¸€æ¬¡é‡æ„ï¼Œè¿˜æœ‰å¯¹ä»¥å‰å­˜åœ¨çš„å¾ˆå¤šé—®é¢˜è¿›è¡Œäº†æ›´æ”¹ä¸ä¼˜åŒ–ã€‚ç³»ç»Ÿéƒ½è¿›è¡Œäº†æœåŠ¡ç«¯æ¸²æŸ“<code>SSR</code>çš„å¤„ç†ã€‚</p>
<blockquote>
<p><a href="https://dzblog.cn/" target="_blank" rel="nofollow noopener noreferrer">åšå®¢åœ°å€ä¼ é€é—¨</a></p>
</blockquote>
<blockquote>
<p>æœ¬é¡¹ç›®å®Œæ•´çš„ä»£ç ï¼š<a href="https://github.com/cd-dongzi/BlogSource" target="_blank" rel="nofollow noopener noreferrer">GitHub ä»“åº“</a></p>
</blockquote>
<p>æœ¬æ–‡ç¯‡å¹…è¾ƒé•¿ï¼Œä¼šä»ä»¥ä¸‹å‡ ä¸ªæ–¹é¢è¿›è¡Œå±•å¼€ä»‹ç»ï¼š</p>
<ol>
<li><a href="https://juejin.cn/post/6954661977469747213#1.1">æ ¸å¿ƒæŠ€æœ¯æ ˆ</a></li>
<li><a href="https://juejin.cn/post/6954661977469747213#2.1">ç›®å½•ç»“æ„è¯¦è§£</a></li>
<li><a href="https://juejin.cn/post/6954661977469747213#3.1">é¡¹ç›®ç¯å¢ƒå¯åŠ¨</a></li>
<li><a href="https://juejin.cn/post/6954661977469747213#4.1">Serverç«¯æºç è§£æ</a></li>
<li><a href="https://juejin.cn/post/6954661977469747213#5.1">Clientç«¯æºç è§£æ</a></li>
<li><a href="https://juejin.cn/post/6954661977469747213#6.1">Adminç«¯æºç è§£æ</a></li>
<li><a href="https://juejin.cn/post/6954661977469747213#7.1">HTTPSåˆ›å»º</a></li>
</ol>
<h2 data-id="heading-1">æ ¸å¿ƒæŠ€æœ¯æ ˆ</h2>
<ol>
<li><code>React 17.x</code> (React å…¨å®¶æ¡¶)</li>
<li><code>Typescript 4.x</code></li>
<li><code>Koa 2.x</code></li>
<li><code>Webpack 5.x</code></li>
<li><code>Babel 7.x</code></li>
<li><code>Mongodb</code> (æ•°æ®åº“)</li>
<li><code>eslint</code> + <code>stylelint</code> + <code>prettier</code> (è¿›è¡Œä»£ç æ ¼å¼æ§åˆ¶)</li>
<li><code>husky</code> + <code>lint-staged</code> + <code>commitizen</code> +<code>commitlint</code> (è¿›è¡Œ git æäº¤çš„ä»£ç æ ¼å¼æ ¡éªŒè·Ÿ commit æµç¨‹æ ¡éªŒ)</li>
</ol>
<p>æ ¸å¿ƒå¤§æ¦‚å°±æ˜¯ä»¥ä¸Šçš„ä¸€äº›æŠ€æœ¯æ ˆï¼Œç„¶ååŸºäºåšå®¢çš„å„ç§éœ€æ±‚è¿›è¡ŒåŠŸèƒ½å¼€å‘ã€‚åƒä¾‹å¦‚æˆæƒç”¨åˆ°çš„<code>jsonwebtoken</code>,<code>@loadable</code>,<code>log4js</code>æ¨¡å—ç­‰ç­‰ä¸€äº›åŠŸèƒ½ï¼Œæˆ‘ä¼šä¸‹é¢å„ä¸ªåŠŸèƒ½æ¨¡å—å±•å¼€ç¯‡å¹…è¿›è¡Œè®²è§£ã€‚</p>
<blockquote>
<p><a href="https://github.com/cd-dongzi/BlogSource/blob/master/package.json" target="_blank" rel="nofollow noopener noreferrer">package.json é…ç½®æ–‡ä»¶åœ°å€</a></p>
</blockquote>
<h2 data-id="heading-2">ç›®å½•ç»“æ„è¯¦è§£</h2>
<pre><code class="copyable">|-- blog-source
    |-- .babelrc.js   // babelé…ç½®æ–‡ä»¶
    |-- .commitlintrc.js // git commitæ ¼å¼æ ¡éªŒæ–‡ä»¶ï¼Œcommitæ ¼å¼ä¸é€šè¿‡ï¼Œç¦æ­¢commit
    |-- .cz-config.js // cz-customizableçš„é…ç½®æ–‡ä»¶ã€‚æˆ‘é‡‡ç”¨çš„cz-customizableæ¥åšçš„commitè§„èŒƒï¼Œè‡ªå·±è‡ªå®šä¹‰çš„ä¸€å¥—
    |-- .eslintignore // eslintå¿½ç•¥é…ç½®
    |-- .eslintrc.js // eslinté…ç½®æ–‡ä»¶
    |-- .gitignore // gitå¿½ç•¥é…ç½®
    |-- .npmrc // npmé…ç½®æ–‡ä»¶
    |-- .postcssrc.js // æ·»åŠ cssæ ·å¼å‰ç¼€ä¹‹ç±»çš„ä¸œè¥¿
    |-- .prettierrc.js // æ ¼å¼ä»£ç ç”¨çš„ï¼Œç»Ÿä¸€é£æ ¼
    |-- .sentryclirc // é¡¹ç›®ç›‘æ§Sentry
    |-- .stylelintignore // styleå¿½ç•¥é…ç½®
    |-- .stylelintrc.js // stylelinté…ç½®æ–‡ä»¶
    |-- package.json
    |-- tsconfig.base.json // tsé…ç½®æ–‡ä»¶
    |-- tsconfig.json // tsé…ç½®æ–‡ä»¶
    |-- tsconfig.server.json // tsé…ç½®æ–‡ä»¶
    |-- build // Webpackæ„å»ºç›®å½•, åˆ†åˆ«ç»™clientç«¯ï¼Œadminç«¯ï¼Œserverç«¯è¿›è¡ŒåŒºåˆ«æ„å»º
    |   |-- paths.ts
    |   |-- utils.ts
    |   |-- config
    |   |   |-- dev.ts
    |   |   |-- index.ts
    |   |   |-- prod.ts
    |   |-- webpack
    |       |-- admin.base.ts
    |       |-- admin.dev.ts
    |       |-- admin.prod.ts
    |       |-- base.ts
    |       |-- client.base.ts
    |       |-- client.dev.ts
    |       |-- client.prod.ts
    |       |-- index.ts
    |       |-- loaders.ts
    |       |-- plugins.ts
    |       |-- server.base.ts
    |       |-- server.dev.ts
    |       |-- server.prod.ts
    |-- dist // æ‰“åŒ…outputç›®å½•
    |-- logs // æ—¥å¿—æ‰“å°ç›®å½•
    |-- private // é™æ€èµ„æºå…¥å£ç›®å½•ï¼Œè®¾ç½®äº†å¤šä¸ª
    |   |-- third-party-login.html
    |-- publice // é™æ€èµ„æºå…¥å£ç›®å½•ï¼Œè®¾ç½®äº†å¤šä¸ª
    |-- scripts // é¡¹ç›®æ‰§è¡Œè„šæœ¬ï¼ŒåŒ…æ‹¬å¯åŠ¨ï¼Œæ‰“åŒ…ç­‰ç­‰
    |   |-- build.ts
    |   |-- config.ts
    |   |-- dev.ts
    |   |-- start.ts
    |   |-- utils.ts
    |   |-- plugins
    |       |-- open-browser.ts
    |       |-- webpack-dev.ts
    |       |-- webpack-hot.ts
    |-- src // æ ¸å¿ƒæºç 
    |   |-- client // å®¢æˆ·ç«¯ä»£ç 
    |   |   |-- main.tsx // å…¥å£æ–‡ä»¶
    |   |   |-- tsconfig.json // tsé…ç½®
    |   |   |-- api // apiæ¥å£
    |   |   |-- app // å…¥å£ç»„ä»¶
    |   |   |-- appComponents // ä¸šåŠ¡ç»„ä»¶
    |   |   |-- assets // é™æ€èµ„æº
    |   |   |-- components // å…¬å…±ç»„ä»¶
    |   |   |-- config // å®¢æˆ·ç«¯é…ç½®æ–‡ä»¶
    |   |   |-- contexts // context, å°±æ˜¯ç”¨useContextåˆ›å»ºçš„ï¼Œç”¨æ¥ç»„ä»¶å…±äº«çŠ¶æ€çš„
    |   |   |-- global // å…¨å±€è¿›å…¥clientéœ€è¦è¿›è¡Œè°ƒç”¨çš„æ–¹æ³•ã€‚åƒç±»ä¼¼windowä¸Šçš„æ–¹æ³•
    |   |   |-- hooks // react hooks
    |   |   |-- pages // é¡µé¢
    |   |   |-- router // è·¯ç”±
    |   |   |-- store // Storeç›®å½•
    |   |   |-- styles // æ ·å¼æ–‡ä»¶
    |   |   |-- theme // æ ·å¼ä¸»é¢˜æ–‡ä»¶ï¼Œåšæ¢è‚¤æ•ˆæœçš„
    |   |   |-- types // tsç±»å‹æ–‡ä»¶
    |   |   |-- utils // å·¥å…·ç±»æ–¹æ³•
    |   |-- admin // åå°ç®¡ç†ç«¯ä»£ç ï¼ŒåŒå®¢æˆ·ç«¯å·®ä¸å¤ªå¤š
    |   |   |-- .babelrc.js
    |   |   |-- app.tsx
    |   |   |-- main.tsx
    |   |   |-- tsconfig.json
    |   |   |-- api
    |   |   |-- appComponents
    |   |   |-- assets
    |   |   |-- components
    |   |   |-- config
    |   |   |-- hooks
    |   |   |-- pages
    |   |   |-- router
    |   |   |-- store
    |   |   |-- styles
    |   |   |-- types
    |   |   |-- utils
    |   |-- models // æ¥å£æ¨¡å‹
    |   |-- server // æœåŠ¡ç«¯ä»£ç 
    |   |   |-- main.ts // å…¥å£æ–‡ä»¶
    |   |   |-- config // é…ç½®æ–‡ä»¶
    |   |   |-- controllers // æ§åˆ¶å™¨
    |   |   |-- database // æ•°æ®åº“
    |   |   |-- decorators // è£…é¥°å™¨ï¼Œå°è£…äº†@Get,@Post,@Put,@Delete,@Cookieä¹‹ç±»çš„
    |   |   |-- middleware // ä¸­é—´ä»¶
    |   |   |-- models // mongodbæ¨¡å‹
    |   |   |-- router // è·¯ç”±ã€æ¥å£
    |   |   |-- ssl // httpsè¯ä¹¦,ç›®å‰æˆ‘æ˜¯æœ¬åœ°å¼€å‘ç”¨çš„ï¼Œçº¿ä¸Šå¦‚æœç”¨nginxçš„è¯ï¼Œåœ¨nginxå¤„é…ç½®å°±è¡Œ
    |   |   |-- ssr // é¡µé¢SSRå¤„ç†
    |   |   |-- timer // å®šæ—¶å™¨
    |   |   |-- utils // å·¥å…·ç±»æ–¹æ³•
    |   |-- shared // å¤šç«¯å…±äº«çš„ä»£ç 
    |   |   |-- loadInitData.ts
    |   |   |-- type.ts
    |   |   |-- config
    |   |   |-- utils
    |   |-- types // tsç±»å‹æ–‡ä»¶
    |-- static // é™æ€èµ„æº
    |-- template // htmlæ¨¡æ¿

<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<p>ä»¥ä¸Šå°±æ˜¯é¡¹ç›®å¤§æ¦‚çš„æ–‡ä»¶ç›®å½•ï¼Œä¸Šé¢å·²ç»æè¿°äº†æ–‡ä»¶çš„åŸºæœ¬ä½œç”¨ï¼Œä¸‹é¢æˆ‘ä¼šè¯¦ç»†åšå®¢åŠŸèƒ½çš„å®ç°è¿‡ç¨‹ã€‚ç›®å‰åšå®¢ç³»ç»Ÿå„ç«¯æ²¡æœ‰æ‹†åˆ†å‡ºæ¥ï¼Œæ¥ä¸‹é‡Œä¼šæœ‰è¿™ä¸ªæ‰“ç®—ã€‚</p>
<h2 data-id="heading-3">é¡¹ç›®ç¯å¢ƒå¯åŠ¨</h2>
<p>ç¡®ä¿ä½ çš„<code>node</code>ç‰ˆæœ¬åœ¨<code>10.13.0 (LTS)</code>ä»¥ä¸Šï¼Œå› ä¸º<code>Webpack 5</code> å¯¹ <code>Node.js</code> çš„ç‰ˆæœ¬è¦æ±‚è‡³å°‘æ˜¯ <code>10.13.0 (LTS)</code></p>
<h3 data-id="heading-4">æ‰§è¡Œè„šæœ¬,å¯åŠ¨é¡¹ç›®</h3>
<p>é¦–å…ˆä»å…¥å£æ–‡ä»¶å¼€å§‹ï¼š</p>
<pre><code class="hljs language-json copyable" lang="json"><span class="hljs-string">"dev"</span>: <span class="hljs-string">"cross-env NODE_ENV=development TS_NODE_PROJECT=tsconfig.server.json ts-node --files scripts/start.ts"</span>
<span class="hljs-string">"prod"</span>: <span class="hljs-string">"cross-env NODE_ENV=production TS_NODE_PROJECT=tsconfig.server.json ts-node --files scripts/start.ts"</span>
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<h3 data-id="heading-5">1. æ‰§è¡Œå…¥å£æ–‡ä»¶scripts/start.js</h3>
<pre><code class="hljs language-typescript copyable" lang="typescript"><span class="hljs-comment">// scripts/start.js</span>
<span class="hljs-keyword">import</span> path <span class="hljs-keyword">from</span> <span class="hljs-string">'path'</span>
<span class="hljs-keyword">import</span> moduleAlias <span class="hljs-keyword">from</span> <span class="hljs-string">'module-alias'</span>

moduleAlias.addAliases(&#123;
  <span class="hljs-string">'@root'</span>: path.resolve(__dirname, <span class="hljs-string">'../'</span>),
  <span class="hljs-string">'@server'</span>: path.resolve(__dirname, <span class="hljs-string">'../src/server'</span>),
  <span class="hljs-string">'@client'</span>: path.resolve(__dirname, <span class="hljs-string">'../src/client'</span>),
  <span class="hljs-string">'@admin'</span>: path.resolve(__dirname, <span class="hljs-string">'../src/admin'</span>),
&#125;)

<span class="hljs-keyword">if</span> (process.env.NODE_ENV === <span class="hljs-string">'production'</span>) &#123;
  <span class="hljs-built_in">require</span>(<span class="hljs-string">'./build'</span>)
&#125; <span class="hljs-keyword">else</span> &#123;
  <span class="hljs-built_in">require</span>(<span class="hljs-string">'./dev'</span>)
&#125;
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<p>è®¾ç½®è·¯å¾„åˆ«åï¼Œå› ä¸ºç›®å‰å„ç«¯æ²¡æœ‰æ‹†åˆ†ï¼Œæ‰€ä»¥å»ºç«‹åˆ«å<code>(alias)</code>å¥½æŸ¥æ‰¾æ–‡ä»¶ã€‚</p>
<h3 data-id="heading-6">2. ç”±å…¥å£æ–‡ä»¶è¿›å…¥å¼€å‘developmentç¯å¢ƒçš„æ­å»º</h3>
<p>é¦–å…ˆå¯¼å‡º<code>webpack</code>å„ç«¯çš„å„è‡ªç¯å¢ƒçš„é…ç½®æ–‡ä»¶ã€‚</p>
<pre><code class="hljs language-typescript copyable" lang="typescript"><span class="hljs-comment">// dev.ts</span>
<span class="hljs-keyword">import</span> clientDev <span class="hljs-keyword">from</span> <span class="hljs-string">'./client.dev'</span>
<span class="hljs-keyword">import</span> adminDev <span class="hljs-keyword">from</span> <span class="hljs-string">'./admin.dev'</span>
<span class="hljs-keyword">import</span> serverDev <span class="hljs-keyword">from</span> <span class="hljs-string">'./server.dev'</span>
<span class="hljs-keyword">import</span> clientProd <span class="hljs-keyword">from</span> <span class="hljs-string">'./client.prod'</span>
<span class="hljs-keyword">import</span> adminProd <span class="hljs-keyword">from</span> <span class="hljs-string">'./admin.prod'</span>
<span class="hljs-keyword">import</span> serverProd <span class="hljs-keyword">from</span> <span class="hljs-string">'./server.prod'</span>
<span class="hljs-keyword">import</span> webpack <span class="hljs-keyword">from</span> <span class="hljs-string">'webpack'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> Configuration = webpack.Configuration & &#123;
  <span class="hljs-attr">output</span>: &#123;
    <span class="hljs-attr">path</span>: <span class="hljs-built_in">string</span>
  &#125;
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>
  <span class="hljs-attr">entry</span>: <span class="hljs-built_in">any</span>
&#125;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> (NODE_ENV: ENV): [Configuration, Configuration, Configuration] => &#123;
  <span class="hljs-keyword">if</span> (NODE_ENV === <span class="hljs-string">'development'</span>) &#123;
    <span class="hljs-keyword">return</span> [clientDev <span class="hljs-keyword">as</span> Configuration, serverDev <span class="hljs-keyword">as</span> Configuration, adminDev <span class="hljs-keyword">as</span> Configuration]
  &#125;
  <span class="hljs-keyword">return</span> [clientProd <span class="hljs-keyword">as</span> Configuration, serverProd <span class="hljs-keyword">as</span> Configuration, adminProd <span class="hljs-keyword">as</span> Configuration]
&#125;

<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<p><code>webpack</code>çš„é…ç½®æ–‡ä»¶ï¼ŒåŸºæœ¬ä¸ä¼šæœ‰å¤ªå¤§çš„åŒºåˆ«ï¼Œç›®å‰å°±è´´ä¸€æ®µç®€å•çš„<code>webpack</code>é…ç½®ï¼Œåˆ†åˆ«æœ‰ server,client,admin ä¸åŒç¯å¢ƒçš„é…ç½®æ–‡ä»¶ã€‚å…·ä½“å¯ä»¥çœ‹<a href="https://github.com/cd-dongzi/BlogSource" target="_blank" rel="nofollow noopener noreferrer">åšå®¢æºç </a></p>
<pre><code class="hljs language-typescript copyable" lang="typescript"><span class="hljs-keyword">import</span> webpack <span class="hljs-keyword">from</span> <span class="hljs-string">'webpack'</span>
<span class="hljs-keyword">import</span> merge <span class="hljs-keyword">from</span> <span class="hljs-string">'webpack-merge'</span>
<span class="hljs-keyword">import</span> &#123; clientPlugins &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">'./plugins'</span> <span class="hljs-comment">// pluginsé…ç½®</span>
<span class="hljs-keyword">import</span> &#123; clientLoader &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">'./loaders'</span> <span class="hljs-comment">// loadersé…ç½®</span>
<span class="hljs-keyword">import</span> paths <span class="hljs-keyword">from</span> <span class="hljs-string">'../paths'</span>
<span class="hljs-keyword">import</span> config <span class="hljs-keyword">from</span> <span class="hljs-string">'../config'</span>
<span class="hljs-keyword">import</span> createBaseConfig <span class="hljs-keyword">from</span> <span class="hljs-string">'./base'</span> <span class="hljs-comment">// å¤šç«¯é»˜è®¤é…ç½®</span>

<span class="hljs-keyword">const</span> baseClientConfig: webpack.Configuration = merge(createBaseConfig(), &#123;
  <span class="hljs-attr">mode</span>: config.NODE_ENV,
  <span class="hljs-attr">context</span>: paths.rootPath,
  <span class="hljs-attr">name</span>: <span class="hljs-string">'client'</span>,
  <span class="hljs-attr">target</span>: [<span class="hljs-string">'web'</span>, <span class="hljs-string">'es5'</span>],
  <span class="hljs-attr">entry</span>: &#123;
    <span class="hljs-attr">main</span>: paths.clientEntryPath,
  &#125;,
  <span class="hljs-attr">resolve</span>: &#123;
    <span class="hljs-attr">extensions</span>: [<span class="hljs-string">'.js'</span>, <span class="hljs-string">'.json'</span>, <span class="hljs-string">'.ts'</span>, <span class="hljs-string">'.tsx'</span>],
    <span class="hljs-attr">alias</span>: &#123;
      <span class="hljs-string">'@'</span>: paths.clientPath,
      <span class="hljs-string">'@client'</span>: paths.clientPath,
      <span class="hljs-string">'@root'</span>: paths.rootPath,
      <span class="hljs-string">'@server'</span>: paths.serverPath,
    &#125;,
  &#125;,
  <span class="hljs-attr">output</span>: &#123;
    <span class="hljs-attr">path</span>: paths.buildClientPath,
    <span class="hljs-attr">publicPath</span>: paths.publicPath,
  &#125;,
  <span class="hljs-attr">module</span>: &#123;
    <span class="hljs-attr">rules</span>: [...clientLoader],
  &#125;,
  <span class="hljs-attr">plugins</span>: [...clientPlugins],
&#125;)
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> baseClientConfig
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<p>ç„¶ååˆ†åˆ«æ¥å¤„ç†<code>admin</code>å’Œ<code>client</code>å’Œ<code>server</code>ç«¯çš„<code>webpack</code>é…ç½®æ–‡ä»¶</p>
<p>ä»¥ä¸Šå‡ ä¸ªç‚¹éœ€è¦æ³¨æ„ï¼š</p>
<ul>
<li><code>admin</code>ç«¯è·Ÿ<code>client</code>ç«¯åˆ†åˆ«å¼€äº†ä¸€ä¸ªæœåŠ¡å¤„ç†webpackçš„æ–‡ä»¶ï¼Œéƒ½æ‰“åŒ…åœ¨å†…å­˜ä¸­ã€‚</li>
<li><code>client</code>ç«¯éœ€è¦æ³¨æ„æ‰“åŒ…å‡ºæ¥æ–‡ä»¶çš„å¼•ç”¨è·¯å¾„ï¼Œå› ä¸ºæ˜¯<code>SSR</code>,éœ€è¦åœ¨æœåŠ¡ç«¯è·å–æ–‡ä»¶ç›´æ¥æ¸²æŸ“ï¼Œæˆ‘æŠŠæœåŠ¡ç«¯è·Ÿå®¢æˆ·ç«¯æ‰“åœ¨ä¸åŒçš„ä¸¤ä¸ªæœåŠ¡ï¼Œæ‰€ä»¥åœ¨æœåŠ¡ç«¯å¼•ç”¨<code>client</code>ç«¯æ–‡ä»¶çš„æ—¶å€™éœ€è¦æ³¨æ„å¼•ç”¨è·¯å¾„ã€‚</li>
<li><code>server</code>ç«¯ä»£ç ç›´æ¥æ‰“åŒ…åœ¨<code>dist</code>æ–‡ä»¶ä¸‹ï¼Œç”¨äºå¯åŠ¨ï¼Œå¹¶æ²¡æœ‰æ‰“åœ¨å†…å­˜ä¸­ã€‚</li>
</ul>
<pre><code class="hljs language-typescript copyable" lang="typescript"><span class="hljs-keyword">const</span> WEBPACK_URL = <span class="hljs-string">`<span class="hljs-subst">$&#123;__WEBPACK_HOST__&#125;</span>:<span class="hljs-subst">$&#123;__WEBPACK_PORT__&#125;</span>`</span>
<span class="hljs-keyword">const</span> [clientWebpackConfig, serverWebpackConfig, adminWebpackConfig] = getConfig(process.env.NODE_ENV <span class="hljs-keyword">as</span> ENV)
<span class="hljs-comment">// æ„å»ºclient è·Ÿ server</span>
<span class="hljs-keyword">const</span> start = <span class="hljs-keyword">async</span> () => &#123;
  <span class="hljs-comment">// å› ä¸ºclientæŒ‡å‘çš„å¦ä¸€ä¸ªæœåŠ¡ï¼Œæ‰€ä»¥é‡å†™publicPathè·¯å¾„ï¼Œä¸ç„¶ä¼š404</span>
  clientWebpackConfig.output.publicPath = serverWebpackConfig.output.publicPath = <span class="hljs-string">`<span class="hljs-subst">$&#123;WEBPACK_URL&#125;</span><span class="hljs-subst">$&#123;clientWebpackConfig.output.publicPath&#125;</span>`</span>
  clientWebpackConfig.entry.main = [<span class="hljs-string">`webpack-hot-middleware/client?path=<span class="hljs-subst">$&#123;WEBPACK_URL&#125;</span>/__webpack_hmr`</span>, clientWebpackConfig.entry.main]
  <span class="hljs-keyword">const</span> multiCompiler = webpack([clientWebpackConfig, serverWebpackConfig])
  <span class="hljs-keyword">const</span> compilers = multiCompiler.compilers
  <span class="hljs-keyword">const</span> clientCompiler = compilers.find(<span class="hljs-function">(<span class="hljs-params">compiler</span>) =></span> compiler.name === <span class="hljs-string">'client'</span>) <span class="hljs-keyword">as</span> webpack.Compiler
  <span class="hljs-keyword">const</span> serverCompiler = compilers.find(<span class="hljs-function">(<span class="hljs-params">compiler</span>) =></span> compiler.name === <span class="hljs-string">'server'</span>) <span class="hljs-keyword">as</span> webpack.Compiler

  <span class="hljs-comment">// é€šè¿‡compiler.hooksç”¨æ¥ç›‘å¬Compilerç¼–è¯‘æƒ…å†µ</span>
  <span class="hljs-keyword">const</span> clientCompilerPromise = setCompilerTip(clientCompiler, clientWebpackConfig.name)
  <span class="hljs-keyword">const</span> serverCompilerPromise = setCompilerTip(serverCompiler, serverWebpackConfig.name)

  <span class="hljs-comment">// ç”¨äºåˆ›å»ºæœåŠ¡çš„æ–¹æ³•ï¼Œåœ¨æ­¤åˆ›å»ºclientç«¯çš„æœåŠ¡,è‡³æ­¤ï¼Œclientç«¯çš„ä»£ç ä¾¿æ‰“å…¥è¿™ä¸ªæœåŠ¡ä¸­, å¯ä»¥é€šè¿‡åƒ https://192.168.0.47:3012/js/lib.js è®¿é—®æ–‡ä»¶</span>
  createService(&#123;
    <span class="hljs-attr">webpackConfig</span>: clientWebpackConfig,
    <span class="hljs-attr">compiler</span>: clientCompiler,
    <span class="hljs-attr">port</span>: __WEBPACK_PORT__
  &#125;)
  <span class="hljs-keyword">let</span> script: <span class="hljs-built_in">any</span> = <span class="hljs-literal">null</span>
  <span class="hljs-comment">// é‡å¯</span>
  <span class="hljs-keyword">const</span> nodemonRestart = <span class="hljs-function">() =></span> &#123;
    <span class="hljs-keyword">if</span> (script) &#123;
      script.restart()
    &#125;
  &#125;

  <span class="hljs-comment">// ç›‘å¬serveræ–‡ä»¶æ›´æ”¹</span>
  serverCompiler.watch(&#123; <span class="hljs-attr">ignored</span>: <span class="hljs-regexp">/node_modules/</span> &#125;, <span class="hljs-function">(<span class="hljs-params">err, stats</span>) =></span> &#123;
    nodemonRestart()
    <span class="hljs-keyword">if</span> (err) &#123;
      <span class="hljs-keyword">throw</span> err
    &#125;
    <span class="hljs-comment">// ...</span>
  &#125;)

  <span class="hljs-keyword">try</span> &#123;
    <span class="hljs-comment">// ç­‰å¾…ç¼–è¯‘å®Œæˆ</span>
    <span class="hljs-keyword">await</span> clientCompilerPromise
    <span class="hljs-keyword">await</span> serverCompilerPromise
    <span class="hljs-comment">// è¿™æ˜¯adminç¼–è¯‘æƒ…å†µï¼Œadminç«¯çš„ç¼–è¯‘æƒ…å†µå·®ä¸å¤ªå¤šï¼ŒåŸºæœ¬ä¹Ÿæ˜¯è¿è¡Œ`webpack(config)`è¿›è¡Œç¼–è¯‘ï¼Œé€šè¿‡`createService`ç”Ÿæˆä¸€ä¸ªæœåŠ¡ç”¨æ¥è®¿é—®æ‰“åŒ…çš„ä»£ç ã€‚</span>
    <span class="hljs-keyword">await</span> startAdmin()

    closeCompiler(clientCompiler)
    closeCompiler(serverCompiler)
    logMsg(<span class="hljs-string">`Build time <span class="hljs-subst">$&#123;<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().getTime() - startTime&#125;</span>`</span>)
  &#125; <span class="hljs-keyword">catch</span> (err) &#123;
    logMsg(err, <span class="hljs-string">'error'</span>)
  &#125;

  <span class="hljs-comment">// å¯åŠ¨serverç«¯ç¼–è¯‘å‡ºæ¥çš„å…¥å£æ–‡ä»¶æ¥å¯åŠ¨é¡¹ç›®æœåŠ¡</span>
  script = nodemon(&#123;
    <span class="hljs-attr">script</span>: path.join(serverWebpackConfig.output.path, <span class="hljs-string">'entry.js'</span>)
  &#125;)
&#125;
start()
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<p><code>createService</code>æ–¹æ³•ç”¨æ¥ç”ŸæˆæœåŠ¡, ä»£ç å¤§æ¦‚å¦‚ä¸‹</p>
<pre><code class="hljs language-typescript copyable" lang="typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> createService = <span class="hljs-function">(<span class="hljs-params">&#123;webpackConfig, compiler&#125;: &#123;webpackConfig: Configurationcompiler: Compiler&#125;</span>) =></span> &#123;
  <span class="hljs-keyword">const</span> app = <span class="hljs-keyword">new</span> Koa()
  ...
  <span class="hljs-keyword">const</span> dev = webpackDevMiddleware(compiler, &#123;
    <span class="hljs-attr">publicPath</span>: webpackConfig.output.publicPath <span class="hljs-keyword">as</span> <span class="hljs-built_in">string</span>,
    <span class="hljs-attr">stats</span>: webpackConfig.stats
  &#125;)
  app.use(dev)
  app.use(webpackHotMiddleware(compiler))
  http.createServer(app.callback()).listen(port, cb)
  <span class="hljs-keyword">return</span> app
&#125;
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<p>å¼€å‘(<code>development</code>)ç¯å¢ƒä¸‹çš„<code>webpack</code>ç¼–è¯‘æƒ…å†µçš„å¤§ä½“é€»è¾‘å°±æ˜¯è¿™æ ·ï¼Œé‡Œé¢ä¼šæœ‰äº›<code>webpack-dev-middle</code>è¿™äº›ä¸­é—´ä»¶åœ¨koaä¸­çš„å¤„ç†ç­‰ï¼Œè¿™é‡Œæˆ‘åªæä¾›äº†å¤§ä½“æ€è·¯ï¼Œå¯ä»¥å…·ä½“ç»†çœ‹æºç ã€‚</p>
<h3 data-id="heading-7">3. ç”Ÿæˆç¯å¢ƒproductionç¯å¢ƒçš„æ­å»º</h3>
<p>å¯¹äºç”Ÿæˆç¯å¢ƒçš„ä¸‹æ­å»ºï¼Œå¤„ç†å°±æ¯”è¾ƒå°‘äº†ï¼Œç›´æ¥é€šè¿‡<code>webpack</code>æ‰“åŒ…å°±è¡Œ</p>
<pre><code class="hljs language-typescript copyable" lang="typescript">webpack([clientWebpackConfig, serverWebpackConfig, adminWebpackConfig], <span class="hljs-function">(<span class="hljs-params">err, stats</span>) =></span> &#123;
    spinner.stop()
    <span class="hljs-keyword">if</span> (err) &#123;
      <span class="hljs-keyword">throw</span> err
    &#125;
    <span class="hljs-comment">// ...</span>
  &#125;)
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<p>ç„¶åå¯åŠ¨æ‰“åŒ…å‡ºæ¥çš„å…¥å£æ–‡ä»¶ <em><code>cross-env NODE_ENV=production node dist/server/entry.js</code></em></p>
<p>è¿™å—ä¸»è¦å°±æ˜¯<code>webpack</code>çš„é…ç½®ï¼Œè¿™äº›é…ç½®æ–‡ä»¶å¯ä»¥ç›´æ¥<a href="https://github.com/cd-dongzi/BlogSource/tree/master/build/webpack" target="_blank" rel="nofollow noopener noreferrer">ç‚¹å‡»è¿™é‡Œè¿›è¡ŒæŸ¥çœ‹</a></p>
<h2 data-id="heading-8">Serverç«¯æºç è§£æ</h2>
<p>ç”±ä¸Šé¢çš„é…ç½®webpacké…ç½®å»¶ä¼¸åˆ°ä»–ä»¬çš„å…¥å£æ–‡ä»¶</p>
<pre><code class="hljs language-typescript copyable" lang="typescript"><span class="hljs-comment">// clientå…¥å£</span>
<span class="hljs-keyword">const</span> clientPath = utils.resolve(<span class="hljs-string">'src/client'</span>)
<span class="hljs-keyword">const</span> clientEntryPath = path.join(clientPath, <span class="hljs-string">'main.tsx'</span>)
<span class="hljs-comment">// serverå…¥å£</span>
<span class="hljs-keyword">const</span> serverPath = utils.resolve(<span class="hljs-string">'src/server'</span>)
<span class="hljs-keyword">const</span> serverEntryPath = path.join(serverPath, <span class="hljs-string">'main.ts'</span>)
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<ul>
<li>clientç«¯çš„å…¥å£æ˜¯<code>/src/client/main.tsx</code></li>
<li>serverç«¯çš„å…¥å£æ˜¯<code>/src/server/main.ts</code></li>
</ul>
<p>å› ä¸ºé¡¹ç›®ç”¨åˆ°äº†<code>SSR</code>,æˆ‘ä»¬ä»<code>serverç«¯</code>æ¥è¿›è¡Œé€æ­¥åˆ†æã€‚</p>
<h3 data-id="heading-9">1. /src/server/main.tså…¥å£æ–‡ä»¶</h3>
<pre><code class="hljs language-typescript copyable" lang="typescript"><span class="hljs-keyword">import</span> Koa <span class="hljs-keyword">from</span> <span class="hljs-string">'koa'</span>
...
<span class="hljs-keyword">const</span> app = <span class="hljs-keyword">new</span> Koa()
<span class="hljs-comment">/* 
  ä¸­é—´ä»¶ï¼š
    sendMidddleware: å¯¹ctx.bodyçš„å°è£…
    etagMiddlewareï¼šè®¾ç½®etagåšç¼“å­˜ å¯ä»¥å‚è€ƒkoa-etag,æˆ‘åšäº†ä¸‹ç®€å•ä¿®æ”¹ï¼Œ
    conditionalMiddlewareï¼š åˆ¤æ–­ç¼“å­˜æ˜¯å¦æ˜¯å¦ç”Ÿæ•ˆï¼Œé€šè¿‡ctx.freshæ¥åˆ¤æ–­å°±å¥½ï¼Œkoaå†…éƒ¨å·²ç»å°è£…å¥½äº†
    loggerMiddlewareï¼š ç”¨æ¥æ‰“å°æ—¥å¿—
    authTokenMiddlewareï¼š æƒé™æ‹¦æˆªï¼Œè¿™æ˜¯adminç«¯å¯¹apiåšçš„æ‹¦æˆªå¤„ç†
    routerErrorMiddlewareï¼šè¿™æ˜¯å¯¹apiè¿›è¡Œçš„é”™è¯¯å¤„ç†
    koa-static: å¯¹äºé™æ€æ–‡ä»¶çš„å¤„ç†ï¼Œè®¾ç½®max-ageè®©æ–‡ä»¶å¼ºç¼“ï¼Œé…ç½®etagæˆ–Last-Modifiedç»™èµ„æºè®¾ç½®å¼ºç¼“è·Ÿåå•†ç¼“å­˜
    ...
*/</span>
middleware(app)
<span class="hljs-comment">/* 
  å¯¹apiè¿›è¡Œç®¡ç†
*/</span>
router(app)
<span class="hljs-comment">/* 
  å¯åŠ¨æ•°æ®åº“ï¼Œæ­å»ºSSRé…ç½®
*/</span>
<span class="hljs-built_in">Promise</span>.all([startMongodb(), SSR(app)])
  .then(<span class="hljs-function">() =></span> &#123;
    <span class="hljs-comment">// å¼€å¯æœåŠ¡</span>
    https.createServer(serverConfig.httpsOptions, app.callback()).listen(rootConfig.app.server.httpsPort, <span class="hljs-string">'0.0.0.0'</span>)
  &#125;)
  .catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =></span> &#123;
    process.exit()
  &#125;)

<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<h3 data-id="heading-10">2.ä¸­é—´ä»¶çš„å¤„ç†</h3>
<p>å¯¹äºä¸­é—´ä»¶ä¸»è¦å°±è®²ä¸€è®²æ—¥å¿—å¤„ç†ä¸­é—´ä»¶<code>loggerMiddleware</code>å’Œæƒé™ä¸­é—´ä»¶<code>authTokenMiddleware</code>,åˆ«çš„ä¸­é—´ä»¶æ²¡æœ‰å¤ªå¤šä¸œè¥¿ï¼Œå°±ä¸æµªè´¹ç¯‡å¹…ä»‹ç»äº†ã€‚</p>
<p>æ—¥å¿—æ‰“å°ä¸»è¦ç”¨åˆ°äº†<code>log4js</code>è¿™ä¸ªåº“ï¼Œç„¶ååŸºäºè¿™ä¸ªåº“åšçš„ä¸Šå±‚å°è£…,é€šè¿‡ä¸åŒç±»å‹çš„Loggeræ¥åˆ›å»ºä¸åŒçš„æ—¥å¿—æ–‡ä»¶ã€‚
å°è£…äº†æ‰€æœ‰è¯·æ±‚çš„æ—¥å¿—æ‰“å°ï¼Œapiçš„æ—¥å¿—æ‰“å°ï¼Œä¸€äº›ç¬¬ä¸‰æ–¹çš„è°ƒç”¨çš„æ—¥å¿—æ‰“å°</p>
<h4 data-id="heading-11">1. loggerMiddlewareçš„å®ç°</h4>
<pre><code class="hljs language-typescript copyable" lang="typescript"><span class="hljs-comment">// log.ts</span>
<span class="hljs-keyword">const</span> createLogger = (options = &#123;&#125; <span class="hljs-keyword">as</span> LogOptions): <span class="hljs-function"><span class="hljs-params">Logger</span> =></span> &#123;
  <span class="hljs-comment">// é…ç½®é¡¹</span>
  <span class="hljs-keyword">const</span> opts = &#123;
    ...serverConfig.log,
    ...options
  &#125;
  <span class="hljs-comment">// é…ç½®æ–‡ä»¶</span>
  log4js.configure(&#123;
    <span class="hljs-attr">appenders</span>: &#123;
      <span class="hljs-comment">// stoutå¯ä»¥ç”¨äºå¼€å‘ç¯å¢ƒï¼Œç›´æ¥æ‰“å°å‡ºæ¥</span>
      <span class="hljs-attr">stdout</span>: &#123;
        <span class="hljs-attr">type</span>: <span class="hljs-string">'stdout'</span>
      &#125;,
      <span class="hljs-comment">// ç”¨multiFileç±»å‹ï¼Œé€šè¿‡å˜é‡ç”Ÿæˆä¸åŒçš„æ–‡ä»¶ï¼Œæˆ‘è¯•äº†åˆ«çš„å‡ ç§typeã€‚æ„Ÿè§‰éƒ½æ²¡è¿™ç§æ–¹ä¾¿</span>
      <span class="hljs-attr">multi</span>: &#123; <span class="hljs-attr">type</span>: <span class="hljs-string">'multiFile'</span>, <span class="hljs-attr">base</span>: opts.dir, <span class="hljs-attr">property</span>: <span class="hljs-string">'dir'</span>, <span class="hljs-attr">extension</span>: <span class="hljs-string">'.log'</span> &#125;
    &#125;,
    <span class="hljs-attr">categories</span>: &#123;
      <span class="hljs-attr">default</span>: &#123; <span class="hljs-attr">appenders</span>: [<span class="hljs-string">'stdout'</span>], <span class="hljs-attr">level</span>: <span class="hljs-string">'off'</span> &#125;,
      <span class="hljs-attr">http</span>: &#123; <span class="hljs-attr">appenders</span>: [<span class="hljs-string">'multi'</span>], <span class="hljs-attr">level</span>: opts.logLevel &#125;,
      <span class="hljs-attr">api</span>: &#123; <span class="hljs-attr">appenders</span>: [<span class="hljs-string">'multi'</span>], <span class="hljs-attr">level</span>: opts.logLevel &#125;,
      <span class="hljs-attr">external</span>: &#123; <span class="hljs-attr">appenders</span>: [<span class="hljs-string">'multi'</span>], <span class="hljs-attr">level</span>: opts.logLevel &#125;
    &#125;
  &#125;)
  <span class="hljs-keyword">const</span> create = <span class="hljs-function">(<span class="hljs-params">appender: <span class="hljs-built_in">string</span></span>) =></span> &#123;
    <span class="hljs-keyword">const</span> methods: LogLevel[] = [<span class="hljs-string">'trace'</span>, <span class="hljs-string">'debug'</span>, <span class="hljs-string">'info'</span>, <span class="hljs-string">'warn'</span>, <span class="hljs-string">'error'</span>, <span class="hljs-string">'fatal'</span>, <span class="hljs-string">'mark'</span>]
    <span class="hljs-keyword">const</span> context = &#123;&#125; <span class="hljs-keyword">as</span> LoggerContext
    <span class="hljs-keyword">const</span> logger = log4js.getLogger(appender)
    <span class="hljs-comment">// é‡å†™log4jsæ–¹æ³•ï¼Œç”Ÿæˆå˜é‡ï¼Œç”¨æ¥ç”Ÿæˆä¸åŒçš„æ–‡ä»¶</span>
    methods.forEach(<span class="hljs-function">(<span class="hljs-params">method</span>) =></span> &#123;
      context[method] = <span class="hljs-function">(<span class="hljs-params">message: <span class="hljs-built_in">string</span></span>) =></span> &#123;
        logger.addContext(<span class="hljs-string">'dir'</span>, <span class="hljs-string">`/<span class="hljs-subst">$&#123;appender&#125;</span>/<span class="hljs-subst">$&#123;method&#125;</span>/<span class="hljs-subst">$&#123;dayjs().format(<span class="hljs-string">'YYYY-MM-DD'</span>)&#125;</span>`</span>)
        logger[method](message)
      &#125;
    &#125;)
    <span class="hljs-keyword">return</span> context
  &#125;
  <span class="hljs-keyword">return</span> &#123;
    <span class="hljs-attr">http</span>: create(<span class="hljs-string">'http'</span>),
    <span class="hljs-attr">api</span>: create(<span class="hljs-string">'api'</span>),
    <span class="hljs-attr">external</span>: create(<span class="hljs-string">'external'</span>)
  &#125;
&#125;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> createLogger


<span class="hljs-comment">// loggerMiddleware</span>
<span class="hljs-keyword">import</span> createLogger, &#123; LogOptions &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">'@server/utils/log'</span>
<span class="hljs-comment">// æ‰€æœ‰è¯·æ±‚æ‰“å°</span>
<span class="hljs-keyword">const</span> loggerMiddleware = <span class="hljs-function">(<span class="hljs-params">options = &#123;&#125; <span class="hljs-keyword">as</span> LogOptions</span>) =></span> &#123;
  <span class="hljs-keyword">const</span> logger = createLogger(options)
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">async</span> (ctx: Koa.Context, <span class="hljs-attr">next</span>: Next) => &#123;
    <span class="hljs-keyword">const</span> start = <span class="hljs-built_in">Date</span>.now()
    ctx.log = logger
    <span class="hljs-keyword">try</span> &#123;
      <span class="hljs-keyword">await</span> next()
      <span class="hljs-keyword">const</span> end = <span class="hljs-built_in">Date</span>.now() - start
      <span class="hljs-comment">// æ­£å¸¸è¯·æ±‚æ—¥å¿—æ‰“å°</span>
      logger.http.info(
        logInfo(ctx, &#123;
          <span class="hljs-attr">responseTime</span>: <span class="hljs-string">`<span class="hljs-subst">$&#123;end&#125;</span>ms`</span>
        &#125;)
      )
    &#125; <span class="hljs-keyword">catch</span> (e) &#123;
      <span class="hljs-keyword">const</span> message = ErrorUtils.getErrorMsg(e)
      <span class="hljs-keyword">const</span> end = <span class="hljs-built_in">Date</span>.now() - start
      <span class="hljs-comment">// é”™è¯¯è¯·æ±‚æ—¥å¿—æ‰“å°</span>
      logger.http.error(
        logInfo(ctx, &#123;
          message,
          <span class="hljs-attr">responseTime</span>: <span class="hljs-string">`<span class="hljs-subst">$&#123;end&#125;</span>ms`</span>
        &#125;)
      )
    &#125;
  &#125;
&#125;
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<h4 data-id="heading-12">2. authTokenMiddlewareçš„å®ç°</h4>
<p><img src="https://assets.open.dzblog.cn/images/markdown/auth.png" alt="authTokenMiddlewareä¸­é—´ä»¶çš„å¤„ç†é€»è¾‘" title="authTokenMiddlewareä¸­é—´ä»¶çš„å¤„ç†é€»è¾‘" loading="lazy" referrerpolicy="no-referrer"></p>
<pre><code class="hljs language-typescript copyable" lang="typescript"><span class="hljs-comment">// authTokenMiddleware.ts</span>
<span class="hljs-keyword">const</span> authTokenMiddleware = <span class="hljs-function">() =></span> &#123;
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">async</span> (ctx: Koa.Context, <span class="hljs-attr">next</span>: Next) => &#123;
    <span class="hljs-comment">// apiç™½åå•ï¼š å¯ä»¥æŠŠ ç™»å½• æ³¨å†Œæ¥å£ä¹‹ç±»çš„è®¾å…¥ç™½åå•ï¼Œå…è®¸è®¿é—®</span>
    <span class="hljs-keyword">if</span> (serverConfig.adminAuthApiWhiteList.some(<span class="hljs-function">(<span class="hljs-params">path</span>) =></span> path === ctx.path)) &#123;
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> next()
    &#125;
    <span class="hljs-comment">// é€šè¿‡ jsonwebtoken æ¥æ£€éªŒtokençš„æœ‰æ•ˆæ€§</span>
    <span class="hljs-keyword">const</span> token = ctx.cookies.get(rootConfig.adminTokenKey)
    <span class="hljs-keyword">if</span> (!token) &#123;
      <span class="hljs-keyword">throw</span> &#123;
        <span class="hljs-attr">code</span>: <span class="hljs-number">401</span>
      &#125;
    &#125; <span class="hljs-keyword">else</span> &#123;
      <span class="hljs-keyword">try</span> &#123;
        jwt.verify(token, serverConfig.adminJwtSecret)
      &#125; <span class="hljs-keyword">catch</span> (e) &#123;
        <span class="hljs-keyword">throw</span> &#123;
          <span class="hljs-attr">code</span>: <span class="hljs-number">401</span>
        &#125;
      &#125;
    &#125;
    <span class="hljs-keyword">await</span> next()
  &#125;
&#125;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> authTokenMiddleware
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<p>ä»¥ä¸Šæ˜¯å¯¹ä¸­é—´ä»¶çš„å¤„ç†ã€‚</p>
<h3 data-id="heading-13">3. Routerçš„å¤„ç†é€»è¾‘</h3>
<p>ä¸‹é¢æ˜¯å…³äº<code>router</code>è¿™å—çš„å¤„ç†ï¼Œ<code>api</code>è¿™å—ä¸»è¦æ˜¯é€šè¿‡è£…é¥°å™¨æ¥è¿›è¡Œè¯·æ±‚çš„å¤„ç†</p>
<h4 data-id="heading-14">1. åˆ›å»ºrouterï¼ŒåŠ è½½apiæ–‡ä»¶</h4>
<pre><code class="hljs language-typescript copyable" lang="typescript"><span class="hljs-comment">// router.ts</span>
<span class="hljs-keyword">import</span> &#123; bootstrapControllers &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">'@server/controllers'</span>
<span class="hljs-keyword">const</span> router = <span class="hljs-keyword">new</span> KoaRouter<DefaultState, Context>()

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> (app: Koa) => &#123;
  <span class="hljs-comment">// è¿›è¡Œapiçš„ç»‘å®š, </span>
  bootstrapControllers(&#123;
    router, <span class="hljs-comment">// è·¯ç”±å¯¹è±¡</span>
    <span class="hljs-attr">basePath</span>: <span class="hljs-string">'/api'</span>, <span class="hljs-comment">// è·¯ç”±å‰ç¼€</span>
    <span class="hljs-attr">controllerPaths</span>: [<span class="hljs-string">'controllers/api/*/**/*.ts'</span>], <span class="hljs-comment">// æ–‡ä»¶ç›®å½•</span>
    <span class="hljs-attr">middlewares</span>: [routerErrorMiddleware(), loggerApiMiddleware()]
  &#125;)
  app.use(router.routes()).use(router.allowedMethods())
  <span class="hljs-comment">// api 404</span>
  app.use(<span class="hljs-keyword">async</span> (ctx, next) => &#123;
    <span class="hljs-keyword">if</span> (ctx.path.startsWith(<span class="hljs-string">'/api'</span>)) &#123;
      <span class="hljs-keyword">return</span> ctx.sendCodeError(<span class="hljs-number">404</span>)
    &#125;
    <span class="hljs-keyword">await</span> next()
  &#125;)
&#125;


<span class="hljs-comment">// bootstrapControllersæ–¹æ³•</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> bootstrapControllers = <span class="hljs-function">(<span class="hljs-params">options: ControllerOptions</span>) =></span> &#123;
  <span class="hljs-keyword">const</span> &#123; router, controllerPaths &#125; = options
  <span class="hljs-comment">// å¼•å…¥æ–‡ä»¶, è¿›è€Œè§¦å‘è£…é¥°å™¨ç»‘å®šcontrollers</span>
  controllerPaths.forEach(<span class="hljs-function">(<span class="hljs-params">path</span>) =></span> &#123;
    <span class="hljs-comment">// é€šè¿‡globæ¨¡å—æŸ¥æ‰¾æ–‡ä»¶</span>
    <span class="hljs-keyword">const</span> files = glob.sync(Utils.resolve(<span class="hljs-string">`src/server/<span class="hljs-subst">$&#123;path&#125;</span>`</span>))
    files.forEach(<span class="hljs-function">(<span class="hljs-params">file</span>) =></span> &#123;
      <span class="hljs-comment">/* 
        é€šè¿‡åˆ«åå¼•å…¥æ–‡ä»¶
        Why?
        å› ä¸ºç›´æ¥webpackæ‰“åŒ…å¼•ç”¨å˜é‡æ— æ³•æ‰¾åˆ°æ¨¡å—
        webpackæ‰“åŒ…å‡ºæ¥çš„æ–‡ä»¶éƒ½å¾—åˆ°æ‰“åŒ…å‡ºæ¥çš„å¼•ç”¨è·¯å¾„é‡Œé¢å»æ‰¾ï¼Œå¹¶ä¸æ˜¯å®é™…è·¯å¾„(__webpack_require__)
        æ‰€ä»¥ç›´æ¥å¼•å…¥è·¯å¾„ä¼šæœ‰é—®é¢˜ã€‚ç”¨åˆ«åå¼•å…¥ã€‚
        æœ‰ä¸ªé—®é¢˜è¿˜å¾…è§£å†³ï¼Œå°±æ˜¯ä»–ä¼šè§£æå­—ç¬¦ä¸²æ‹¼æ¥çš„é‚£ä¸ªè·¯å¾„ä¸‹é¢çš„æ‰€æœ‰æ–‡ä»¶
        ä¾‹å¦‚ï¼š require(`@root/src/server/controllers$&#123;fileName&#125;`) ä¼šè§£æ@root/src/server/controllersä¸‹çš„æ‰€æœ‰æ–‡ä»¶ï¼Œ
        ç›®å‰å®šä½åœ¨è¿™ä¸ªæ–‡ä»¶ä¸‹å¯ä»¥é˜²æ­¢è§£æè¿‡å¤šçš„æ–‡ä»¶å¯¼è‡´nodeå†…å­˜ä¸å¤Ÿï¼Œ
        è¿™ä¸ªé—®é¢˜å¾…è§£å†³
      */</span>
      <span class="hljs-keyword">const</span> p = Utils.resolve(<span class="hljs-string">'src/server/controllers'</span>)
      <span class="hljs-keyword">const</span> fileName = file.replace(p, <span class="hljs-string">''</span>)
      <span class="hljs-comment">// ç›´æ¥requireå¼•å…¥å¯¹åº”çš„æ–‡ä»¶ã€‚ç›´æ¥å¼•å…¥ä¾¿å¯ä»¥äº†ï¼Œåˆ°æ—¶å€™ä¼šè‡ªåŠ¨è§¦å‘è£…é¥°å™¨è¿›è¡Œapiçš„æ”¶é›†ã€‚</span>
      <span class="hljs-comment">// ä¼šæŠŠè¿™äº›æ–‡ä»¶é‡Œé¢çš„æ‰€æœ‰è¯·æ±‚æ”¶é›†åˆ° metaData é‡Œé¢çš„ã€‚ä¸‹é¢ä¼šè¯´åˆ° metaData</span>
      <span class="hljs-built_in">require</span>(<span class="hljs-string">`@root/src/server/controllers<span class="hljs-subst">$&#123;fileName&#125;</span>`</span>)
    &#125;)
    <span class="hljs-comment">// ç»‘å®šrouter</span>
    generateRoutes(router, metadata, options)
  &#125;)
&#125;
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<p>ä»¥ä¸Šå°±æ˜¯å¼•å…¥<code>api</code>çš„æ–¹æ³•ï¼Œä¸‹é¢å°±æ˜¯è£…é¥°å™¨çš„å¦‚ä½•å¤„ç†æ¥å£ä»¥åŠå‚æ•°ã€‚</p>
<p>å¯¹äºè£…é¥°å™¨æœ‰å‡ ä¸ªéœ€è¦æ³¨æ„çš„ç‚¹:</p>
<ol>
<li>vscodeéœ€è¦å¼€å¯è£…é¥°å™¨<code>javascript.implicitProjectConfig.experimentalDecorators: true</code>,ç°åœ¨å¥½åƒä¸éœ€è¦äº†ï¼Œä¼šè‡ªåŠ¨æ£€æµ‹tsconfig.jsonæ–‡ä»¶ï¼Œå¦‚æœéœ€è¦å°±åŠ ä¸Š</li>
<li>babeléœ€è¦é…ç½®<code>['@babel/plugin-proposal-decorators', &#123; legacy: true &#125;]</code>è·Ÿ<code>babel-plugin-parameter-decorator</code>è¿™ä¸¤ä¸ªæ’ä»¶ï¼Œå› ä¸º<code>@babel/plugin-proposal-decorators</code>è¿™ä¸ªæ’ä»¶æ— æ³•è§£æ@Argï¼Œæ‰€ä»¥è¿˜è¦åŠ ä¸Š<code>babel-plugin-parameter-decorator</code>æ’ä»¶ç”¨æ¥è§£æ@Arg</li>
</ol>
<p>æ¥åˆ°<code>@server/decorators</code>æ–‡ä»¶ä¸‹ï¼Œåˆ†åˆ«å®šä¹‰äº†ä»¥ä¸‹è£…é¥°å™¨</p>
<h4 data-id="heading-15">2. è£…é¥°å™¨çš„æ±‡æ€»</h4>
<ul>
<li><code>@Controller</code>  apiä¸‹çš„æŸä¸ªæ¨¡å— ä¾‹å¦‚<code>@Controller('/user) => /api/user</code></li>
<li><code>@Get</code>  Getè¯·æ±‚</li>
<li><code>@Post</code>  Postè¯·æ±‚</li>
<li><code>@Delete</code>  Deleteè¯·æ±‚</li>
<li><code>@Put</code>  Putè¯·æ±‚</li>
<li><code>@Patch</code>  Patchè¯·æ±‚</li>
<li><code>@Query</code>  Queryå‚æ•° ä¾‹å¦‚<code>https://localhost:3000?a=1&b=2 => &#123;a: 1, b: 2&#125;</code></li>
<li><code>@Body</code>  ä¼ å…¥Bodyçš„å‚æ•°</li>
<li><code>@Params</code>  Paramså‚æ•° ä¾‹å¦‚ <code>https://localhost:3000/api/user/123 => /api/user/:id => @Params('id') id:string => 123</code></li>
<li><code>@Ctx</code>  Ctxå¯¹è±¡</li>
<li><code>@Header</code>  Headerå¯¹è±¡ ä¹Ÿå¯ä»¥å•ç‹¬è·å–Headerä¸­æŸä¸ªå€¼ <code>@Header() è·å–headeræ•´ä¸ªçš„å¯¹è±¡</code>, <code>@Header('Content-Type') è·å–headeré‡Œé¢çš„Content-Typeå±æ€§å€¼</code></li>
<li><code>@Req</code>  Reqå¯¹è±¡</li>
<li><code>@Request</code>  Requestå¯¹è±¡</li>
<li><code>@Res</code>  Reså¯¹è±¡</li>
<li><code>@Response</code>  Responseå¯¹è±¡</li>
<li><code>@Cookie</code>  Cookieå¯¹è±¡ ä¹Ÿå¯ä»¥å•ç‹¬è·å–Cookieä¸­æŸä¸ªå€¼</li>
<li><code>@Session</code>  Sessionå¯¹è±¡ ä¹Ÿå¯ä»¥å•ç‹¬è·å–Sessionä¸­æŸä¸ªå€¼</li>
<li><code>@Middleware</code>  ç»‘å®šä¸­é—´ä»¶ï¼Œå¯ä»¥ç²¾ç¡®åˆ°æŸä¸ªè¯·æ±‚</li>
<li><code>@Token</code>  è·å–tokenå€¼ï¼Œå®šä¹‰è¿™ä¸ªä¸»è¦æ˜¯æ–¹ä¾¿è·å–token</li>
</ul>
<p>ä¸‹é¢æ¥è¯´ä¸‹è¿™äº›è£…é¥°å™¨æ˜¯å¦‚ä½•è¿›è¡Œå¤„ç†çš„</p>
<h4 data-id="heading-16">3. åˆ›å»ºå…ƒæ•°æ®metaData</h4>
<pre><code class="hljs language-typescript copyable" lang="typescript"><span class="hljs-comment">// MetaDataçš„æ•°æ®æ ¼å¼</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> Method = <span class="hljs-string">'get'</span> | <span class="hljs-string">'post'</span> | <span class="hljs-string">'put'</span> | <span class="hljs-string">'patch'</span> | <span class="hljs-string">'delete'</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> argumentSource = <span class="hljs-string">'ctx'</span> | <span class="hljs-string">'query'</span> | <span class="hljs-string">'params'</span> | <span class="hljs-string">'body'</span> | <span class="hljs-string">'header'</span> | <span class="hljs-string">'request'</span> | <span class="hljs-string">'req'</span> | <span class="hljs-string">'response'</span> | <span class="hljs-string">'res'</span> | <span class="hljs-string">'session'</span> | <span class="hljs-string">'cookie'</span> | <span class="hljs-string">'token'</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> argumentOptions =
  | <span class="hljs-built_in">string</span>
  | &#123;
      value?: <span class="hljs-built_in">string</span>
      required?: <span class="hljs-built_in">boolean</span>
      requiredList?: <span class="hljs-built_in">string</span>[]
    &#125;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> MetaDataArguments = &#123;
  <span class="hljs-attr">source</span>: argumentSource
  options?: argumentOptions
&#125;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> MetaDataActions &#123;
  [k: <span class="hljs-built_in">string</span>]: &#123;
    <span class="hljs-attr">method</span>: Method
    <span class="hljs-attr">path</span>: <span class="hljs-built_in">string</span>
    <span class="hljs-attr">target</span>: <span class="hljs-function">(<span class="hljs-params">...args: <span class="hljs-built_in">any</span></span>) =></span> <span class="hljs-built_in">void</span>
    <span class="hljs-built_in">arguments</span>?: &#123;
      [k: <span class="hljs-built_in">string</span>]: MetaDataArguments
    &#125;
    middlewares?: Koa.Middleware[]
  &#125;
&#125;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> MetaDataController &#123;
  <span class="hljs-attr">actions</span>: MetaDataActions
  basePath?: <span class="hljs-built_in">string</span> | <span class="hljs-built_in">string</span>[]
  middlewares?: Koa.Middleware[]
&#125;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> MetaData &#123;
  <span class="hljs-attr">controllers</span>: &#123;
    [k: <span class="hljs-built_in">string</span>]: MetaDataController
  &#125;
&#125;
<span class="hljs-comment">/* 
  å£°æ˜ä¸€ä¸ªæ•°æ®æºï¼Œç”¨æ¥æŠŠæ‰€æœ‰apiçš„æ–¹å¼ï¼Œurl,å‚æ•°è®°å½•ä¸‹æ¥
  åœ¨ä¸Šé¢bootstrapControllersæ–¹é¢é‡Œé¢æœ‰ä¸ªå‡½æ•°`generateRoutes(router, metadata, options)`
  å°±æ˜¯è§£æmetaDataæ•°æ®ç„¶åç»‘å®šåˆ°routerä¸Šçš„
*/</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> metadata: MetaData = &#123;
  <span class="hljs-attr">controllers</span>: &#123;&#125;
&#125;
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<h4 data-id="heading-17">4. @Controllerå®ç°</h4>
<pre><code class="hljs language-typescript copyable" lang="typescript"><span class="hljs-comment">// ç¤ºä¾‹ï¼Œ æ‰€æœ‰TestControllerå†…éƒ¨çš„è¯·æ±‚éƒ½ä¼šå¸¦ä¸Š`/test`å‰ç¼€ => /api/test/example</span>
<span class="hljs-comment">// @Controller(['/test', '/test1'])ä¹Ÿå¯ä»¥æ˜¯æ•°ç»„ï¼Œé‚£æ ·å°±ä¼šåˆ›å»ºä¸¤ä¸ªè¯·æ±‚ /api/test/example è·Ÿ /api/test1/example</span>
<span class="hljs-meta">@Controller</span>(<span class="hljs-string">'/test'</span>)
<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestController</span></span>&#123;
  <span class="hljs-meta">@Get</span>(<span class="hljs-string">'/example'</span>)
  <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-title">getExample</span>(<span class="hljs-params"></span>)</span> &#123;
    <span class="hljs-keyword">return</span> <span class="hljs-string">'example'</span>
  &#125;
&#125;
<span class="hljs-comment">// ä»£ç å®ç°ï¼Œç»‘å®šclass controlleråˆ°metaDataä¸Šï¼Œ</span>
<span class="hljs-comment">/* 
  metadata.controllers = &#123;
    TestController: &#123;
      basePath: '/test'
    &#125;
  &#125;
*/</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> Controller = <span class="hljs-function">(<span class="hljs-params">basePath: <span class="hljs-built_in">string</span> | <span class="hljs-built_in">string</span>[]</span>) =></span> &#123;
  <span class="hljs-keyword">return</span> (classDefinition: <span class="hljs-built_in">any</span>): <span class="hljs-function"><span class="hljs-params">void</span> =></span> &#123;
    <span class="hljs-comment">// è·å–ç±»åï¼Œä½œä¸ºmetadata.controllersä¸­æ¯ä¸ªcontrollerçš„keyåï¼Œæ‰€ä»¥è¦ä¿è¯æ§åˆ¶å™¨ç±»åçš„å”¯ä¸€ï¼Œå…å¾—æœ‰å†²çª</span>
    <span class="hljs-keyword">const</span> controller = metadata.controllers[classDefinition.name] || &#123;&#125;
    <span class="hljs-comment">// basePathå°±æ˜¯ä¸Šé¢çš„ /test</span>
    controller.basePath = basePath
    metadata.controllers[classDefinition.name] = controller
  &#125;
&#125;
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<h4 data-id="heading-18">5. @Get,@Post,@put,@Patch,@Deleteå®ç°</h4>
<p>è¿™å‡ ä¸ªè£…é¥°å™¨çš„å®ç°æ–¹å¼åŸºæœ¬ä¸€è‡´ï¼Œå°±åˆ—ä¸¾ä¸€ä¸ªè¿›è¡Œæ¼”ç¤º</p>
<pre><code class="hljs language-typescript copyable" lang="typescript"><span class="hljs-comment">// ç¤ºä¾‹ï¼ŒæŠŠ@Getè£…é¥°å™¨å£°æ˜åˆ°æŒ‡å®šçš„æ–¹æ³•å‰é¢å°±è¡Œäº†ã€‚æ¯ä¸ªæ–¹æ³•ä½œä¸ºä¸€ä¸ªè¯·æ±‚(action)</span>
<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestController</span></span>&#123;
  <span class="hljs-comment">// @Post('/example')</span>
  <span class="hljs-comment">// @put('/example')</span>
  <span class="hljs-comment">// @Patch('/example')</span>
  <span class="hljs-comment">// @Delete('/example')</span>
  <span class="hljs-meta">@Get</span>(<span class="hljs-string">'/example'</span>) <span class="hljs-comment">// => ä¼šç”ŸæˆGetè¯·æ±‚ /example</span>
  <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-title">getExample</span>(<span class="hljs-params"></span>)</span> &#123;
    <span class="hljs-keyword">return</span> <span class="hljs-string">'example'</span>
  &#125;
&#125;
<span class="hljs-comment">// ä»£ç å®ç°</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> Get = <span class="hljs-function">(<span class="hljs-params">path: <span class="hljs-built_in">string</span></span>) =></span> &#123;
  <span class="hljs-comment">// è£…é¥°å™¨ç»‘å®šæ–¹æ³•ä¼šè·å–ä¸¤ä¸ªå‚æ•°ï¼Œå®ä¾‹å¯¹è±¡ï¼Œè·Ÿæ–¹æ³•å</span>
  <span class="hljs-keyword">return</span> <span class="hljs-function">(<span class="hljs-params"><span class="hljs-built_in">object</span>: <span class="hljs-built_in">any</span>, methodName: <span class="hljs-built_in">string</span></span>) =></span> &#123;
    _addMethod(&#123;
      <span class="hljs-attr">method</span>: <span class="hljs-string">'get'</span>,
      <span class="hljs-attr">path</span>: path,
      <span class="hljs-built_in">object</span>,
      methodName
    &#125;)
  &#125;
&#125;
<span class="hljs-comment">// ç»‘å®šåˆ°æŒ‡å®šcontrollerä¸Š</span>
<span class="hljs-keyword">const</span> _addMethod = <span class="hljs-function">(<span class="hljs-params">&#123; method, path, <span class="hljs-built_in">object</span>, methodName &#125;: AddMethodParmas</span>) =></span> &#123;
  <span class="hljs-comment">// è·å–è¯¥æ–¹æ³•å¯¹åº”çš„controller</span>
  <span class="hljs-keyword">const</span> controller = metadata.controllers[<span class="hljs-built_in">object</span>.constructor.name] || &#123;&#125;
  <span class="hljs-keyword">const</span> actions = controller.actions || &#123;&#125;
  <span class="hljs-keyword">const</span> o = &#123;
    method,
    path,
    <span class="hljs-attr">target</span>: <span class="hljs-built_in">object</span>[methodName].bind(<span class="hljs-built_in">object</span>)
  &#125;
  <span class="hljs-comment">/* 
    æŠŠè¯¥æ–¹æ³•ç»‘å®šcontroller.actionä¸Šï¼Œæ–¹æ³•åä¸ºkey,å˜æˆä»¥ä¸‹æ ¼å¼
    controller.actions = &#123;
      getExample: &#123;
        method: 'get', // è¯·æ±‚æ–¹å¼
        path: '/example', // è¯·æ±‚è·¯å¾„
        target: () &#123; // è¯¥æ–¹æ³•å‡½æ•°ä½“
          return 'example'
        &#125;
      &#125;
    &#125;
    åœ¨æŠŠcontrollerèµ‹å€¼åˆ°metadataä¸­çš„controllersä¸Šï¼Œè®°å½•æ‰€æœ‰è¯·æ±‚ã€‚
  */</span>
  actions[methodName] = &#123;
    ...(actions[methodName] || &#123;&#125;),
    ...o
  &#125;
  controller.actions = actions
  metadata.controllers[<span class="hljs-built_in">object</span>.constructor.name] = controller
&#125;
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<p>ä¸Šé¢ä¾¿æ˜¯<code>action</code>çš„ç»‘å®š</p>
<h4 data-id="heading-19">6. @Query,@Body,@Params,@Ctx,@Header,@Req,@Request,@Res,@Response,@Cookie,@Sessionå®ç°</h4>
<p>å› ä¸ºè¿™äº›è£…é¥°éƒ½æ˜¯è£…é¥°æ–¹æ³•å‚æ•°<code>arguments</code>çš„ï¼Œæ‰€ä»¥ä¹Ÿå¯ä»¥ç»Ÿä¸€å¤„ç†</p>
<pre><code class="hljs language-typescript copyable" lang="typescript"><span class="hljs-comment">// ç¤ºä¾‹  /api/example?a=1&b=3</span>
<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestController</span></span>&#123;
  <span class="hljs-meta">@Get</span>(<span class="hljs-string">'/example'</span>) <span class="hljs-comment">// => ä¼šç”ŸæˆGetè¯·æ±‚ /example</span>
  <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-title">getExample</span>(<span class="hljs-params"><span class="hljs-meta">@Query</span>() query: &#123;[k: <span class="hljs-built_in">string</span>]: <span class="hljs-built_in">any</span>&#125;, <span class="hljs-meta">@Query</span>(<span class="hljs-string">'a'</span>) a: <span class="hljs-built_in">string</span></span>)</span> &#123;
    <span class="hljs-built_in">console</span>.log(query) <span class="hljs-comment">// -> &#123;a: 1, b: 2&#125;</span>
    <span class="hljs-built_in">console</span>.log(a) <span class="hljs-comment">// -> 1</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">'example'</span>
  &#125;
&#125;
<span class="hljs-comment">// å…¶ä½™è£…é¥°å™¨ç”¨æ³•ç±»ä¼¼</span>

<span class="hljs-comment">// ä»£ç å®ç°</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> Query = <span class="hljs-function">(<span class="hljs-params">options?: <span class="hljs-built_in">string</span> | argumentOptions, required?: <span class="hljs-built_in">boolean</span></span>) =></span> &#123;
  <span class="hljs-comment">// ç¤ºä¾‹ @Query('id): options => ä¼ å…¥ 'id'  </span>
  <span class="hljs-keyword">return</span> <span class="hljs-function">(<span class="hljs-params"><span class="hljs-built_in">object</span>: <span class="hljs-built_in">any</span>, methodName: <span class="hljs-built_in">string</span>, index: <span class="hljs-built_in">number</span></span>) =></span> &#123;
    _addMethodArgument(&#123;
      <span class="hljs-built_in">object</span>,
      methodName,
      index,
      <span class="hljs-attr">source</span>: <span class="hljs-string">'query'</span>,
      <span class="hljs-attr">options</span>: _mergeArgsParamsToOptions(options, required)
    &#125;)
  &#125;
&#125;
<span class="hljs-comment">// è®°å½•æ¯ä¸ªactionçš„å‚æ•°</span>
<span class="hljs-keyword">const</span> _addMethodArgument = <span class="hljs-function">(<span class="hljs-params">&#123; <span class="hljs-built_in">object</span>, methodName, index, source, options &#125;: AddMethodArgumentParmas</span>) =></span> &#123;
  <span class="hljs-comment">/* 
    object -> class å®ä¾‹: TestController
    methodName -> æ–¹æ³•å: getExample
    index -> å‚æ•°æ‰€åœ¨ä½ç½® 0
    source -> è·å–ç±»å‹: query
    options -> ä¸€äº›é€‰é¡¹å¿…å¡«ä»€ä¹ˆçš„
  */</span>
  <span class="hljs-keyword">const</span> controller = metadata.controllers[<span class="hljs-built_in">object</span>.constructor.name] || &#123;&#125;
  controller.actions = controller.actions || &#123;&#125;
  controller.actions[methodName] = controller.actions[methodName] || &#123;&#125;
  <span class="hljs-comment">// è·Ÿå‰é¢ä¸€ä¸ªä¸€æ ·ï¼Œè·å–è¿™ä¸ªæ–¹æ³•å¯¹åº”çš„action, å¾€è¿™ä¸ªactionä¸Šé¢æ·»åŠ ä¸€ä¸ªargumentså‚æ•°</span>
  <span class="hljs-comment">/* 

      getExample: &#123;
        method: 'get', // è¯·æ±‚æ–¹å¼
        path: '/example', // è¯·æ±‚è·¯å¾„
        target: () &#123; // è¯¥æ–¹æ³•å‡½æ•°ä½“
          return 'example'
        &#125;,
        arguments: &#123;
          0: &#123;
            source: 'query',
            options: 'id'
          &#125;
        &#125;
      &#125;
  */</span>
  <span class="hljs-keyword">const</span> args = controller.actions[methodName].arguments || &#123;&#125;
  args[<span class="hljs-built_in">String</span>(index)] = &#123;
    source,
    options
  &#125;
  controller.actions[methodName].arguments = args
  metadata.controllers[<span class="hljs-built_in">object</span>.constructor.name] = controller
&#125;
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<p>ä¸Šé¢å°±æ˜¯å¯¹äºæ¯ä¸ª<code>action</code>ä¸Šçš„<code>arguments</code>ç»‘å®šçš„å®ç°</p>
<h4 data-id="heading-20">7. @Middlewareå®ç°</h4>
<p><code>@Middleware</code>è¿™ä¸ªè£…é¥°å™¨ï¼Œä¸ä»…åº”è¯¥èƒ½åœ¨<code>Controller</code>ä¸Šç»‘å®šï¼Œè¿˜èƒ½åœ¨æŸä¸ª<code>action</code>ä¸Šç»‘å®š</p>
<pre><code class="hljs language-typescript copyable" lang="typescript"><span class="hljs-comment">// ç¤ºä¾‹ æ‰§è¡Œæµç¨‹</span>
<span class="hljs-comment">// router.get('/api/test/example', TestMiddleware(), ExampleMiddleware(), async (ctx, next) => &#123;&#125;)</span>

<span class="hljs-meta">@Middleware</span>([TestMiddleware()])
<span class="hljs-meta">@Controller</span>(<span class="hljs-string">'/test'</span>)
<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestController</span></span>&#123;
  <span class="hljs-meta">@Middleware</span>([ExampleMiddleware()])
  <span class="hljs-meta">@Get</span>(<span class="hljs-string">'/example'</span>)
  <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-title">getExample</span>(<span class="hljs-params"></span>)</span> &#123;
    <span class="hljs-keyword">return</span> <span class="hljs-string">'example'</span>
  &#125;
&#125;

<span class="hljs-comment">// ä»£ç å®ç°</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> Middleware = <span class="hljs-function">(<span class="hljs-params">middleware: Koa.Middleware | Koa.Middleware[]</span>) =></span> &#123;
  <span class="hljs-keyword">const</span> middlewares = <span class="hljs-built_in">Array</span>.isArray(middleware) ? middleware : [middleware]
  <span class="hljs-keyword">return</span> <span class="hljs-function">(<span class="hljs-params"><span class="hljs-built_in">object</span>: <span class="hljs-built_in">any</span>, methodName?: <span class="hljs-built_in">string</span></span>) =></span> &#123;
    <span class="hljs-comment">// objectæ˜¯function, è¯æ˜æ˜¯åœ¨ç»™controlleråŠ ä¸­é—´ä»¶</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-built_in">object</span> === <span class="hljs-string">'function'</span>) &#123;
      <span class="hljs-keyword">const</span> controller = metadata.controllers[<span class="hljs-built_in">object</span>.name] || &#123;&#125;
      controller.middlewares = middlewares
    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-built_in">object</span> === <span class="hljs-string">'object'</span> && methodName) &#123;
      <span class="hljs-comment">// å­˜åœ¨methodNameè¯æ˜æ˜¯ç»™actionæ·»åŠ ä¸­é—´ä»¶</span>
      <span class="hljs-keyword">const</span> controller = metadata.controllers[<span class="hljs-built_in">object</span>.constructor.name] || &#123;&#125;
      controller.actions = controller.actions || &#123;&#125;
      controller.actions[methodName] = controller.actions[methodName] || &#123;&#125;
      controller.actions[methodName].middlewares = middlewares
      metadata.controllers[<span class="hljs-built_in">object</span>.constructor.name] = controller
    &#125;
    <span class="hljs-comment">/* 
      ä»£ç æ ¼å¼
      metadata.controllers = &#123;
        TestController: &#123;
          basePath: '/test',
          middlewares: [TestMiddleware()],
          actions: &#123;
            getExample: &#123;
              method: 'get', // è¯·æ±‚æ–¹å¼
              path: '/example', // è¯·æ±‚è·¯å¾„
              target: () &#123; // è¯¥æ–¹æ³•å‡½æ•°ä½“
                return 'example'
              &#125;,
              arguments: &#123;
                0: &#123;
                  source: 'query',
                  options: 'id'
                &#125;
              &#125;,
              middlewares: [ExampleMiddleware()]
            &#125;
          &#125;
        &#125;
      &#125;
    */</span>
  &#125;
&#125;

<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<p>ä»¥ä¸Šçš„è£…é¥°å™¨åŸºæœ¬å°±æŠŠæ•´ä¸ªè¯·æ±‚è¿›è¡Œçš„åŒ…è£…è®°å½•åœ¨<code>metadata</code>ä¸­ï¼Œ
æˆ‘ä»¬å›åˆ°<code>bootstrapControllers</code>æ–¹æ³•é‡Œé¢çš„<code>generateRoutes</code>ä¸Šï¼Œ
è¿™é‡Œæ˜¯ç”¨æ¥è§£æ<code>metadata</code>æ•°æ®ï¼Œç„¶åæŠŠè¿™äº›æ•°æ®ç»‘å®šåˆ°routerä¸Šã€‚</p>
<h4 data-id="heading-21">8. è§£æmetadataå…ƒæ•°æ®,ç»‘å®šrouter</h4>
<pre><code class="hljs language-typescript copyable" lang="typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> bootstrapControllers = <span class="hljs-function">(<span class="hljs-params">options: ControllerOptions</span>) =></span> &#123;
  <span class="hljs-keyword">const</span> &#123; router, controllerPaths &#125; = options
  <span class="hljs-comment">// å¼•å…¥æ–‡ä»¶, è¿›è€Œè§¦å‘è£…é¥°å™¨ç»‘å®šcontrollers</span>
  controllerPaths.forEach(<span class="hljs-function">(<span class="hljs-params">path</span>) =></span> &#123;
    <span class="hljs-comment">// require()å¼•å…¥æ–‡ä»¶ä¹‹åï¼Œå°±ä¼šè§¦å‘è£…é¥°å™¨è¿›è¡Œæ•°æ®æ”¶é›†</span>
    <span class="hljs-built_in">require</span>(...)
    <span class="hljs-comment">// è¿™ä¸ªæ—¶å€™metadataæ•°æ®å°±æ˜¯æ”¶é›†å¥½æ‰€æœ‰actionçš„æ•°æ®ç»“æ„</span>
    <span class="hljs-comment">// æ•°æ®ç»“æ„æ˜¯å¦‚ä¸‹æ ·å­, ä»¥ä¸Šé¢çš„ä¸¾ä¾‹</span>
    metadata.controllers = &#123;
      <span class="hljs-attr">TestController</span>: &#123;
        <span class="hljs-attr">basePath</span>: <span class="hljs-string">'/test'</span>,
        <span class="hljs-attr">middlewares</span>: [TestMiddleware()],
        <span class="hljs-attr">actions</span>: &#123;
          <span class="hljs-attr">getExample</span>: &#123;
            <span class="hljs-attr">method</span>: <span class="hljs-string">'get'</span>, <span class="hljs-comment">// è¯·æ±‚æ–¹å¼</span>
            <span class="hljs-attr">path</span>: <span class="hljs-string">'/example'</span>, <span class="hljs-comment">// è¯·æ±‚è·¯å¾„</span>
            <span class="hljs-attr">target</span>: () &#123; <span class="hljs-comment">// è¯¥æ–¹æ³•å‡½æ•°ä½“</span>
              <span class="hljs-keyword">return</span> <span class="hljs-string">'example'</span>
            &#125;,
            <span class="hljs-attr">arguments</span>: &#123;
              <span class="hljs-number">0</span>: &#123;
                <span class="hljs-attr">source</span>: <span class="hljs-string">'query'</span>,
                <span class="hljs-attr">options</span>: <span class="hljs-string">'id'</span>
              &#125;
            &#125;,
            <span class="hljs-attr">middlewares</span>: [ExampleMiddleware()]
          &#125;
        &#125;
      &#125;
    &#125;
    <span class="hljs-comment">// æ‰§è¡Œç»‘å®šrouteræµç¨‹</span>
    generateRoutes(router, metadata, options)
  &#125;)
&#125;
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<h4 data-id="heading-22">9. generateRoutesæ–¹æ³•çš„å®ç°</h4>
<pre><code class="hljs language-typescript copyable" lang="typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> generateRoutes = <span class="hljs-function">(<span class="hljs-params">router: Router, metadata: MetaData, options: ControllerOptions</span>) =></span> &#123;
  <span class="hljs-keyword">const</span> rootBasePath = options.basePath || <span class="hljs-string">''</span>
  <span class="hljs-keyword">const</span> controllers = <span class="hljs-built_in">Object</span>.values(metadata.controllers)
  controllers.forEach(<span class="hljs-function">(<span class="hljs-params">controller</span>) =></span> &#123;
    <span class="hljs-keyword">if</span> (controller.basePath) &#123;
      controller.basePath = <span class="hljs-built_in">Array</span>.isArray(controller.basePath) ? controller.basePath : [controller.basePath]
      controller.basePath.forEach(<span class="hljs-function">(<span class="hljs-params">basePath</span>) =></span> &#123;
        <span class="hljs-comment">// ä¼ å…¥router, controller, æ¯ä¸ªactionçš„urlå‰ç¼€(rootBasePath + basePath)</span>
        _generateRoute(router, controller, rootBasePath + basePath, options)
      &#125;)
    &#125;
  &#125;)
&#125;


<span class="hljs-comment">// ç”Ÿæˆè·¯ç”±</span>
<span class="hljs-keyword">const</span> _generateRoute = <span class="hljs-function">(<span class="hljs-params">router: Router, controller: MetaDataController, basePath: <span class="hljs-built_in">string</span>, options: ControllerOptions</span>) =></span> &#123;
  <span class="hljs-comment">// æŠŠactionç½®åï¼ŒååŠ çš„actionä¼šæ·»åŠ åˆ°å‰é¢å»ï¼Œç½®åä½¿å…¶è§£ææ­£ç¡®ï¼ŒæŒ‰é¡ºåºåŠ è½½ï¼Œé¿å…ä»¥ä¸‹æƒ…å†µ</span>
  <span class="hljs-comment">/* 
    @Get('/user/:id')
    @Get('/user/add')
    æ‰€ä»¥è·¯ç”±åŠ è½½é¡ºåºè¦æŒ‰ç…§ä½ ä¹¦å†™çš„é¡ºåºæ‰§è¡Œï¼Œé¿å…å†²çª
  */</span>
  <span class="hljs-keyword">const</span> actions = <span class="hljs-built_in">Object</span>.values(controller.actions).reverse()
  actions.forEach(<span class="hljs-function">(<span class="hljs-params">action</span>) =></span> &#123;
    <span class="hljs-comment">// æ‹¼æ¥actionçš„å…¨è·¯å¾„</span>
    <span class="hljs-keyword">const</span> path =
      <span class="hljs-string">'/'</span> +
      (basePath + action.path)
        .split(<span class="hljs-string">'/'</span>)
        .filter(<span class="hljs-function">(<span class="hljs-params">i</span>) =></span> i.length)
        .join(<span class="hljs-string">'/'</span>)
    <span class="hljs-comment">// ç»™æ¯ä¸ªè¯·æ±‚æ·»åŠ ä¸Šmiddlewaresï¼ŒæŒ‰ç…§é¡ºåºæ‰§è¡Œ</span>
    <span class="hljs-keyword">const</span> midddlewares = [...(options.middlewares || []), ...(controller.middlewares || []), ...(action.middlewares || [])]
    <span class="hljs-comment">/* 
      router['get'](
        '/api', // è¯·æ±‚è·¯å¾„
        ...(options.middlewares || []), // ä¸­é—´ä»¶
        ...(controller.middlewares || []), // ä¸­é—´ä»¶
        ...(action.middlewares || []), // ä¸­é—´ä»¶
        async (ctx, next) => &#123;  // æ‰§è¡Œæœ€åçš„å‡½æ•°ï¼Œè¿”å›æ•°æ®ç­‰ç­‰
          ctx.send(....)
        &#125;
      )
    */</span>
    midddlewares.push(<span class="hljs-keyword">async</span> (ctx) => &#123;
      <span class="hljs-keyword">const</span> targetArguments: <span class="hljs-built_in">any</span>[] = []
      <span class="hljs-comment">// è§£æå‚æ•°</span>
      <span class="hljs-keyword">if</span> (action.arguments) &#123;
        <span class="hljs-keyword">const</span> keys = <span class="hljs-built_in">Object</span>.keys(action.arguments)
        <span class="hljs-comment">// æ¯ä¸ªä½ç½®å¯¹åº”çš„argumentæ•°æ®</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> key <span class="hljs-keyword">of</span> keys) &#123;
          <span class="hljs-keyword">const</span> argumentData = action.arguments[key]
          <span class="hljs-comment">// è§£æå‚æ•°çš„å‡½æ•°ï¼Œä¸‹é¢ç¯‡å¹…è¯´æ˜</span>
          targetArguments[<span class="hljs-built_in">Number</span>(key)] = _determineArgument(ctx, argumentData, options)
        &#125;
      &#125;
      <span class="hljs-comment">// æ‰§è¡Œ action.target å‡½æ•°ï¼Œè·å–è¿”å›çš„æ•°æ®,åœ¨é€šè¿‡ctxè¿”å›å‡ºå»</span>
      <span class="hljs-keyword">const</span> data: <span class="hljs-built_in">any</span> = <span class="hljs-keyword">await</span> action.target(...targetArguments)
      <span class="hljs-comment">// data === 'CUSTOM' è‡ªå®šä¹‰è¿”å›,ä¾‹å¦‚ä¸‹è½½æ–‡ä»¶ç­‰ç­‰ä¹‹ç±»çš„</span>
      <span class="hljs-keyword">if</span> (data !== <span class="hljs-string">'CUSTOM'</span>) &#123;
        ctx.send(data === <span class="hljs-literal">undefined</span> ? <span class="hljs-literal">null</span> : data)
      &#125;
    &#125;)
    router[action.method](path, ...(midddlewares <span class="hljs-keyword">as</span> Middleware[]))
  &#125;)
&#125;

<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<p>ä¸Šé¢å°±æ˜¯è§£æè·¯ç”±çš„å¤§æ¦‚æµç¨‹ï¼Œé‡Œé¢æœ‰ä¸ªæ–¹æ³• <code>_determineArgument</code>ç”¨æ¥è§£æå‚æ•°</p>
<h4 data-id="heading-23">9. _determineArgumentæ–¹æ³•çš„å®ç°</h4>
<ol>
<li><code>ctx</code>, <code>session</code>, <code>cookie</code>, <code>token</code>, <code>query</code>, <code>params</code>, <code>body</code> è¿™ä¸ªå‚æ•°æ²¡æ³•ç›´æ¥é€šè¿‡<code>ctx[source]</code>è·å–ï¼Œæ‰€ä»¥å•ç‹¬å¤„ç†</li>
<li>å…¶ä½™å¯ä»¥é€šè¿‡<code>ctx[source]</code>è·å–ï¼Œå°±ç›´æ¥è·å–äº†</li>
</ol>
<pre><code class="hljs language-typescript copyable" lang="typescript"><span class="hljs-comment">// å¯¹å‚æ•°è¿›è¡Œå¤„ç†è·ŸéªŒè¯</span>
<span class="hljs-keyword">const</span> _determineArgument = <span class="hljs-function">(<span class="hljs-params">ctx: Context, &#123; options, source &#125;: MetaDataArguments, opts: ControllerOptions</span>) =></span> &#123;
  <span class="hljs-keyword">let</span> result
  <span class="hljs-comment">// ç‰¹æ®Šå¤„ç†çš„å‚æ•°, `ctx`, `session`, `cookie`, `token`, `query`, `params`, `body`</span>
  <span class="hljs-keyword">if</span> (_argumentInjectorTranslations[source]) &#123;
    result = _argumentInjectorTranslations[source](ctx, options, source)
  &#125; <span class="hljs-keyword">else</span> &#123;
    <span class="hljs-comment">// æ™®é€šèƒ½ç›´æ¥ctxè·å–çš„ï¼Œä¾‹å¦‚header, @header() -> ctx['header'], @Header('Content-Type') -> ctx['header']['Content-Type']</span>
    result = ctx[source]
    <span class="hljs-keyword">if</span> (result && options && <span class="hljs-keyword">typeof</span> options === <span class="hljs-string">'string'</span>) &#123;
      result = result[options]
    &#125;
  &#125;
  <span class="hljs-keyword">return</span> result
&#125;

<span class="hljs-comment">// éœ€è¦æ£€éªŒçš„å‚æ•°ï¼Œå•ç‹¬å¤„ç†</span>
<span class="hljs-keyword">const</span> _argumentInjectorTranslations = &#123;
  <span class="hljs-attr">ctx</span>: <span class="hljs-function">(<span class="hljs-params">ctx: Context</span>) =></span> ctx,
  <span class="hljs-attr">session</span>: <span class="hljs-function">(<span class="hljs-params">ctx: Context, options: argumentOptions</span>) =></span> &#123;
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> options === <span class="hljs-string">'string'</span>) &#123;
      <span class="hljs-keyword">return</span> ctx.session[options]
    &#125;
    <span class="hljs-keyword">return</span> ctx.session
  &#125;,
  <span class="hljs-attr">cookie</span>: <span class="hljs-function">(<span class="hljs-params">ctx: Context, options: argumentOptions</span>) =></span> &#123;
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> options === <span class="hljs-string">'string'</span>) &#123;
      <span class="hljs-keyword">return</span> ctx.cookies.get(options)
    &#125;
    <span class="hljs-keyword">return</span> ctx.cookies
  &#125;,
  <span class="hljs-attr">token</span>: <span class="hljs-function">(<span class="hljs-params">ctx: Context, options: argumentOptions</span>) =></span> &#123;
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> options === <span class="hljs-string">'string'</span>) &#123;
      <span class="hljs-keyword">return</span> ctx.cookies.get(options) || ctx.header[options]
    &#125;
    <span class="hljs-keyword">return</span> <span class="hljs-string">''</span>
  &#125;,
  <span class="hljs-attr">query</span>: <span class="hljs-function">(<span class="hljs-params">ctx: Context, options: argumentOptions, source: argumentSource</span>) =></span> &#123;
    <span class="hljs-keyword">return</span> _argumentInjectorProcessor(source, ctx.query, options)
  &#125;,
  <span class="hljs-attr">params</span>: <span class="hljs-function">(<span class="hljs-params">ctx: Context, options: argumentOptions, source: argumentSource</span>) =></span> &#123;
    <span class="hljs-keyword">return</span> _argumentInjectorProcessor(source, ctx.params, options)
  &#125;,
  <span class="hljs-attr">body</span>: <span class="hljs-function">(<span class="hljs-params">ctx: Context, options: argumentOptions, source: argumentSource</span>) =></span> &#123;
    <span class="hljs-keyword">return</span> _argumentInjectorProcessor(source, ctx.request.body, options)
  &#125;
&#125; <span class="hljs-keyword">as</span> Record<argumentSource, <span class="hljs-function">(<span class="hljs-params">...args: <span class="hljs-built_in">any</span></span>) =></span> <span class="hljs-built_in">any</span>>

<span class="hljs-comment">// éªŒè¯æ“ä½œè¿”å›å€¼</span>
<span class="hljs-keyword">const</span> _argumentInjectorProcessor = <span class="hljs-function">(<span class="hljs-params">source: argumentSource, data: <span class="hljs-built_in">any</span>, options: argumentOptions</span>) =></span> &#123;
  <span class="hljs-keyword">if</span> (!options) &#123;
    <span class="hljs-keyword">return</span> data
  &#125;
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> options === <span class="hljs-string">'string'</span> && Type.isObject(data)) &#123;
    <span class="hljs-keyword">return</span> data[options]
  &#125;
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> options === <span class="hljs-string">'object'</span>) &#123;
    <span class="hljs-keyword">if</span> (options.value) &#123;
      <span class="hljs-keyword">const</span> val = data[options.value]
      <span class="hljs-comment">// å¿…å¡«ï¼Œä½†æ˜¯å€¼ä¸ºç©ºï¼ŒæŠ¥é”™</span>
      <span class="hljs-keyword">if</span> (options.required && Type.isEmpty(val)) &#123;
        ErrorUtils.error(<span class="hljs-string">`[<span class="hljs-subst">$&#123;source&#125;</span>] [<span class="hljs-subst">$&#123;options.value&#125;</span>]å‚æ•°ä¸èƒ½ä¸ºç©º`</span>)
      &#125;
      <span class="hljs-keyword">return</span> val
    &#125;
    <span class="hljs-comment">// requireæ•°ç»„æ ¡éªŒ</span>
    <span class="hljs-keyword">if</span> (options.requiredList && Type.isArray(options.requiredList) && Type.isObject(data)) &#123;
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> key <span class="hljs-keyword">of</span> options.requiredList) &#123;
        <span class="hljs-keyword">if</span> (Type.isEmpty(data[key])) &#123;
          ErrorUtils.error(<span class="hljs-string">`[<span class="hljs-subst">$&#123;source&#125;</span>] [<span class="hljs-subst">$&#123;key&#125;</span>]å‚æ•°ä¸èƒ½ä¸ºç©º`</span>)
        &#125;
      &#125;
      <span class="hljs-keyword">return</span> data
    &#125;
    <span class="hljs-keyword">if</span> (options.required) &#123;
      <span class="hljs-keyword">if</span> (Type.isEmptyObject(data)) &#123;
        ErrorUtils.error(<span class="hljs-string">`<span class="hljs-subst">$&#123;source&#125;</span>ä¸­æœ‰å¿…å¡«å‚æ•°`</span>)
      &#125;
      <span class="hljs-keyword">return</span> data
    &#125;
  &#125;
  ErrorUtils.error(<span class="hljs-string">`[<span class="hljs-subst">$&#123;source&#125;</span>] <span class="hljs-subst">$&#123;<span class="hljs-built_in">JSON</span>.stringify(options)&#125;</span> å‚æ•°é”™è¯¯`</span>)
&#125;
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<h4 data-id="heading-24">10. Router Controlleræ–‡ä»¶æ•´ä½“é¢„è§ˆ</h4>
<pre><code class="hljs language-typescript copyable" lang="typescript"><span class="hljs-keyword">import</span> &#123;
  Get,
  Post,
  Put,
  Patch,
  Delete,
  Query,
  Params,
  Body,
  Ctx,
  Header,
  Req,
  Request,
  Res,
  Response,
  Session,
  Cookie,
  Controller,
  Middleware
&#125; <span class="hljs-keyword">from</span> <span class="hljs-string">'@server/decorators'</span>
<span class="hljs-keyword">import</span> &#123; Context, Next &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">'koa'</span>
<span class="hljs-keyword">import</span> &#123; IncomingHttpHeaders &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">'http'</span>

<span class="hljs-keyword">const</span> TestMiddleware = <span class="hljs-function">() =></span> &#123;
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">async</span> (ctx: Context, <span class="hljs-attr">next</span>: Next) => &#123;
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'start TestMiddleware'</span>)
    <span class="hljs-keyword">await</span> next()
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'end TestMiddleware'</span>)
  &#125;
&#125;
<span class="hljs-keyword">const</span> ExampleMiddleware = <span class="hljs-function">() =></span> &#123;
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">async</span> (ctx: Context, <span class="hljs-attr">next</span>: Next) => &#123;
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'start ExampleMiddleware'</span>)
    <span class="hljs-keyword">await</span> next()
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'end ExampleMiddleware'</span>)
  &#125;
&#125;

<span class="hljs-meta">@Middleware</span>([TestMiddleware()])
<span class="hljs-meta">@Controller</span>(<span class="hljs-string">'/test'</span>)
<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestController</span> </span>&#123;
  <span class="hljs-meta">@Middleware</span>([ExampleMiddleware()])
  <span class="hljs-meta">@Get</span>(<span class="hljs-string">'/example'</span>)
  <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-title">getExample</span>(<span class="hljs-params">
    <span class="hljs-meta">@Ctx</span>() ctx: Context,
    <span class="hljs-meta">@Header</span>() header: IncomingHttpHeaders,
    <span class="hljs-meta">@Request</span>() request: Request,
    <span class="hljs-meta">@Req</span>() req: Request,
    <span class="hljs-meta">@Response</span>() response: Response,
    <span class="hljs-meta">@Res</span>() res: Response,
    <span class="hljs-meta">@Session</span>() session: <span class="hljs-built_in">any</span>,
    <span class="hljs-meta">@Cookie</span>(<span class="hljs-string">'token'</span>) Cookie: <span class="hljs-built_in">any</span>
  </span>)</span> &#123;
    <span class="hljs-built_in">console</span>.log(ctx.response)
    <span class="hljs-keyword">return</span> &#123;
      ctx,
      header,
      request,
      response,
      Cookie,
      session
    &#125;
  &#125;
  <span class="hljs-meta">@Get</span>(<span class="hljs-string">'/get/:name/:age'</span>)
  <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-title">getFn</span>(<span class="hljs-params">
    <span class="hljs-meta">@Query</span>(<span class="hljs-string">'id'</span>) id: <span class="hljs-built_in">string</span>,
    <span class="hljs-meta">@Query</span>(&#123; required: <span class="hljs-literal">true</span> &#125;) query: <span class="hljs-built_in">any</span>,
    <span class="hljs-meta">@Params</span>(<span class="hljs-string">'name'</span>) name: <span class="hljs-built_in">string</span>,
    <span class="hljs-meta">@Params</span>(<span class="hljs-string">'age'</span>) age: <span class="hljs-built_in">string</span>,
    <span class="hljs-meta">@Params</span>() params: <span class="hljs-built_in">any</span>
  </span>)</span> &#123;
    <span class="hljs-keyword">return</span> &#123;
      <span class="hljs-attr">method</span>: <span class="hljs-string">'get'</span>,
      id,
      query,
      name,
      age,
      params
    &#125;
  &#125;
  <span class="hljs-meta">@Post</span>(<span class="hljs-string">'/post/:name/:age'</span>)
  <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-title">getPost</span>(<span class="hljs-params">
    <span class="hljs-meta">@Query</span>(<span class="hljs-string">'id'</span>) id: <span class="hljs-built_in">string</span>,
    <span class="hljs-meta">@Params</span>(<span class="hljs-string">'name'</span>) name: <span class="hljs-built_in">string</span>,
    <span class="hljs-meta">@Params</span>(<span class="hljs-string">'age'</span>) age: <span class="hljs-built_in">string</span>,
    <span class="hljs-meta">@Params</span>() params: <span class="hljs-built_in">any</span>,
    <span class="hljs-meta">@Body</span>(<span class="hljs-string">'sex'</span>) sex: <span class="hljs-built_in">string</span>,
    <span class="hljs-meta">@Body</span>(<span class="hljs-string">'hobby'</span>, <span class="hljs-literal">true</span>) hobby: <span class="hljs-built_in">any</span>,
    <span class="hljs-meta">@Body</span>() body: <span class="hljs-built_in">any</span>
  </span>)</span> &#123;
    <span class="hljs-keyword">return</span> &#123;
      <span class="hljs-attr">method</span>: <span class="hljs-string">'post'</span>,
      id,
      name,
      age,
      params,
      sex,
      hobby,
      body
    &#125;
  &#125;
  <span class="hljs-meta">@Put</span>(<span class="hljs-string">'/put/:name/:age'</span>)
  <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-title">getPut</span>(<span class="hljs-params">
    <span class="hljs-meta">@Query</span>(<span class="hljs-string">'id'</span>) id: <span class="hljs-built_in">string</span>,
    <span class="hljs-meta">@Params</span>(<span class="hljs-string">'name'</span>) name: <span class="hljs-built_in">string</span>,
    <span class="hljs-meta">@Params</span>(<span class="hljs-string">'age'</span>) age: <span class="hljs-built_in">string</span>,
    <span class="hljs-meta">@Params</span>() params: <span class="hljs-built_in">any</span>,
    <span class="hljs-meta">@Body</span>(<span class="hljs-string">'sex'</span>) sex: <span class="hljs-built_in">string</span>,
    <span class="hljs-meta">@Body</span>(<span class="hljs-string">'hobby'</span>, <span class="hljs-literal">true</span>) hobby: <span class="hljs-built_in">any</span>,
    <span class="hljs-meta">@Body</span>() body: <span class="hljs-built_in">any</span>
  </span>)</span> &#123;
    <span class="hljs-keyword">return</span> &#123;
      <span class="hljs-attr">method</span>: <span class="hljs-string">'put'</span>,
      id,
      name,
      age,
      params,
      sex,
      hobby,
      body
    &#125;
  &#125;
  <span class="hljs-meta">@Patch</span>(<span class="hljs-string">'/patch/:name/:age'</span>)
  <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-title">getPatch</span>(<span class="hljs-params">
    <span class="hljs-meta">@Query</span>(<span class="hljs-string">'id'</span>) id: <span class="hljs-built_in">string</span>,
    <span class="hljs-meta">@Params</span>(<span class="hljs-string">'name'</span>) name: <span class="hljs-built_in">string</span>,
    <span class="hljs-meta">@Params</span>(<span class="hljs-string">'age'</span>) age: <span class="hljs-built_in">string</span>,
    <span class="hljs-meta">@Params</span>() params: <span class="hljs-built_in">any</span>,
    <span class="hljs-meta">@Body</span>(<span class="hljs-string">'sex'</span>) sex: <span class="hljs-built_in">string</span>,
    <span class="hljs-meta">@Body</span>(<span class="hljs-string">'hobby'</span>, <span class="hljs-literal">true</span>) hobby: <span class="hljs-built_in">any</span>,
    <span class="hljs-meta">@Body</span>() body: <span class="hljs-built_in">any</span>
  </span>)</span> &#123;
    <span class="hljs-keyword">return</span> &#123;
      <span class="hljs-attr">method</span>: <span class="hljs-string">'patch'</span>,
      id,
      name,
      age,
      params,
      sex,
      hobby,
      body
    &#125;
  &#125;
  <span class="hljs-meta">@Delete</span>(<span class="hljs-string">'/delete/:name/:age'</span>)
  <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-title">getDelete</span>(<span class="hljs-params">
    <span class="hljs-meta">@Query</span>(<span class="hljs-string">'id'</span>) id: <span class="hljs-built_in">string</span>,
    <span class="hljs-meta">@Params</span>(<span class="hljs-string">'name'</span>) name: <span class="hljs-built_in">string</span>,
    <span class="hljs-meta">@Params</span>(<span class="hljs-string">'age'</span>) age: <span class="hljs-built_in">string</span>,
    <span class="hljs-meta">@Params</span>() params: <span class="hljs-built_in">any</span>,
    <span class="hljs-meta">@Body</span>(<span class="hljs-string">'sex'</span>) sex: <span class="hljs-built_in">string</span>,
    <span class="hljs-meta">@Body</span>(<span class="hljs-string">'hobby'</span>, <span class="hljs-literal">true</span>) hobby: <span class="hljs-built_in">any</span>,
    <span class="hljs-meta">@Body</span>() body: <span class="hljs-built_in">any</span>
  </span>)</span> &#123;
    <span class="hljs-keyword">return</span> &#123;
      <span class="hljs-attr">method</span>: <span class="hljs-string">'delete'</span>,
      id,
      name,
      age,
      params,
      sex,
      hobby,
      body
    &#125;
  &#125;
&#125;

<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<p>ä»¥ä¸Šå°±æ˜¯æ•´ä¸ª<code>router</code>ç›¸å…³çš„<code>action</code>ç»‘å®š</p>
<h3 data-id="heading-25">4. SSRçš„å®ç°</h3>
<p>SSRåŒæ„çš„ä»£ç å…¶å®è®²è§£æŒºå¤šçš„ï¼ŒåŸºæœ¬éšä¾¿åœ¨æœç´¢å¼•æ“æœç´¢å°±èƒ½æœ‰å¾ˆå¤šæ•™ç¨‹ï¼Œæˆ‘è¿™é‡Œè´´ä¸€ä¸ªç®€å•çš„æµç¨‹å›¾å¸®åŠ©å¤§å®¶ç†è§£ä¸‹ï¼Œé¡ºä¾¿è®²ä¸‹æˆ‘çš„æµç¨‹æ€è·¯
<img src="https://assets.open.dzblog.cn/images/markdown/ssr.png" alt="SSRåŒæ„" title="SSRåŒæ„" loading="lazy" referrerpolicy="no-referrer"></p>
<p>ä¸Šé¢æµç¨‹å›¾è¿™åªæ˜¯ä¸€ä¸ªå¤§æ¦‚çš„æµç¨‹ï¼Œå…·ä½“é‡Œé¢æ•°æ®çš„è·å–ï¼Œæ•°æ®çš„æ³¨æ°´ï¼Œä¼˜åŒ–é¦–å±æ ·å¼ç­‰ç­‰ï¼Œæˆ‘ä¼šåœ¨ä¸‹æ–¹ç”¨éƒ¨åˆ†ä»£ç è¿›è¡Œè¯´æ˜
æ­¤å¤„æœ‰ç”¨åˆ°æ’ä»¶<code>@loadable/server</code>ï¼Œ<code>@loadable/component</code>ï¼Œ<code>@loadable/babel-plugin</code></p>
<ul>
<li><a href="https://loadable-components.com/docs/api-loadable-component/" target="_blank" rel="nofollow noopener noreferrer"><code>@loadable/component</code></a>: ç”¨äºåŠ¨æ€åŠ è½½ç»„ä»¶</li>
<li><a href="https://loadable-components.com/docs/api-loadable-server/" target="_blank" rel="nofollow noopener noreferrer"><code>@loadable/server</code></a>: æ”¶é›†æœåŠ¡ç«¯çš„è„šæœ¬å’Œæ ·å¼æ–‡ä»¶ï¼Œæ’å…¥æœåŠ¡ç«¯ç›´å‡ºçš„htmlä¸­ï¼Œç”¨äºå®¢æˆ·ç«¯çš„å†æ¬¡æ¸²æŸ“ã€‚</li>
<li><a href="https://loadable-components.com/docs/api-loadable-webpack-plugin/" target="_blank" rel="nofollow noopener noreferrer"><code>@loadable/babel-plugin</code></a>: ç”Ÿæˆjsonæ–‡ä»¶ï¼Œç»Ÿè®¡ä¾èµ–æ–‡ä»¶</li>
</ul>
<h4 data-id="heading-26">1. å‰ç«¯éƒ¨åˆ†ä»£ç </h4>
<pre><code class="hljs language-typescript copyable" lang="typescript"><span class="hljs-comment">/* home.tsx */</span>
<span class="hljs-keyword">const</span> Home = <span class="hljs-function">() =></span> &#123;
  <span class="hljs-keyword">return</span> Home
&#125;
<span class="hljs-comment">// è¯¥ç»„ä»¶éœ€è¦ä¾èµ–çš„æ¥å£æ•°æ®</span>
Home._init = <span class="hljs-keyword">async</span> (store: IStore, <span class="hljs-attr">routeParams</span>: RouterParams) => &#123;
  <span class="hljs-keyword">const</span> &#123; data &#125; = <span class="hljs-keyword">await</span> api.getData()
  store.dispatch(setDataState(&#123; data &#125;))
  <span class="hljs-keyword">return</span>
&#125;

<span class="hljs-comment">/* router.ts */</span>
<span class="hljs-keyword">const</span> routes = [
  &#123;
    <span class="hljs-attr">path</span>: <span class="hljs-string">'/'</span>,
    <span class="hljs-attr">name</span>: <span class="hljs-string">'Home'</span>,
    <span class="hljs-attr">exact</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">component</span>: _import_(<span class="hljs-string">'home'</span>)
  &#125;,
  ...
]

<span class="hljs-comment">/* app.ts */</span>
<span class="hljs-keyword">const</span> App = <span class="hljs-function">() =></span> &#123;
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag"><<span class="hljs-name">Switch</span> <span class="hljs-attr">location</span>=<span class="hljs-string">&#123;location&#125;</span>></span>
      &#123;routes.map((route, index) => &#123;
        return (
          <span class="hljs-tag"><<span class="hljs-name">Route</span>
            <span class="hljs-attr">key</span>=<span class="hljs-string">&#123;</span>`$&#123;<span class="hljs-attr">index</span>&#125; + $&#123;<span class="hljs-attr">route.path</span>&#125;`&#125;
            <span class="hljs-attr">path</span>=<span class="hljs-string">&#123;route.path&#125;</span>
            <span class="hljs-attr">render</span>=<span class="hljs-string">&#123;(props)</span> =></span> &#123;
              return (
                <span class="hljs-tag"><<span class="hljs-name">RouterGuard</span> <span class="hljs-attr">Com</span>=<span class="hljs-string">&#123;route.component&#125;</span> &#123;<span class="hljs-attr">...props</span>&#125;></span>
                  &#123;children&#125;
                <span class="hljs-tag"></<span class="hljs-name">RouterGuard</span>></span>
              )
            &#125;&#125;
            exact=&#123;route.exact&#125;
          />
        )
      &#125;)&#125;
      <span class="hljs-tag"><<span class="hljs-name">Redirect</span> <span class="hljs-attr">to</span>=<span class="hljs-string">"/404"</span> /></span>
    <span class="hljs-tag"></<span class="hljs-name">Switch</span>></span></span>
  )
&#125;
<span class="hljs-comment">// è·¯ç”±æ‹¦æˆªåˆ¤æ–­æ˜¯å¦éœ€è¦ç”±å‰ç«¯å‘èµ·è¯·æ±‚</span>
<span class="hljs-keyword">const</span> RouterGuard = <span class="hljs-function">(<span class="hljs-params">&#123; Com, children, ...props &#125;: <span class="hljs-built_in">any</span></span>) =></span> &#123;
  useEffect(<span class="hljs-function">() =></span> &#123;
    <span class="hljs-keyword">const</span> isServerRender = store.getState().app.isServerRender
    <span class="hljs-keyword">const</span> options = &#123;
      <span class="hljs-attr">disabled</span>: <span class="hljs-literal">false</span>
    &#125;
    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">load</span>(<span class="hljs-params"></span>) </span>&#123;
      <span class="hljs-comment">// å› ä¸ºå‰é¢æˆ‘ä»¬æŠŠé¡µé¢çš„æ¥å£æ•°æ®æ”¾åœ¨ç»„ä»¶çš„_initæ–¹æ³•ä¸­ï¼Œç›´æ¥è°ƒç”¨è¿™ä¸ªæ–¹æ³•å°±å¯ä»¥è·å–æ•°æ®</span>
      <span class="hljs-comment">// é¦–æ¬¡è¿›å…¥ï¼Œæ•°æ®æ˜¯äº¤ç”±æœåŠ¡ç«¯è¿›è¡Œæ¸²æŸ“ï¼Œæ‰€ä»¥åœ¨å®¢æˆ·ç«¯ä¸éœ€è¦è¿›è¡Œè°ƒç”¨ã€‚</span>
      <span class="hljs-comment">// æ»¡è¶³éæœåŠ¡ç«¯æ¸²æŸ“çš„é¡µé¢ï¼Œå­˜åœ¨_initå‡½æ•°ï¼Œè°ƒç”¨å‘èµ·æ•°æ®è¯·æ±‚ï¼Œä¾¿å¯åœ¨å‰ç«¯å‘èµ·è¯·æ±‚ï¼Œè·å–æ•°æ®</span>
      <span class="hljs-comment">// è¿™æ ·å°±èƒ½å‰ç«¯è·ŸæœåŠ¡ç«¯å…±ç”¨ä¸€ä»½ä»£ç å‘èµ·è¯·æ±‚ã€‚</span>
      <span class="hljs-comment">// è¿™æœ‰å¾ˆå¤šå®ç°æ–¹æ³•ï¼Œä¹Ÿæœ‰æŠŠæ¥å£å‡½æ•°ç»‘å®šåœ¨routeä¸Šçš„ï¼Œçœ‹ä¸ªäººçˆ±å¥½ã€‚</span>
      <span class="hljs-keyword">if</span> (!isServerRender && Com._init && history.action !== <span class="hljs-string">'POP'</span>) &#123;
        setLoading(<span class="hljs-literal">true</span>)
        <span class="hljs-keyword">await</span> Com._init(store, routeParams.current, options)
        !options.disabled && setLoading(<span class="hljs-literal">false</span>)
      &#125;
    &#125;
    load()
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =></span> &#123;
      options.disabled = <span class="hljs-literal">true</span>
    &#125;
  &#125;, [Com, store, history])
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag"><<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"page-view"</span>></span>
      <span class="hljs-tag"><<span class="hljs-name">Com</span> &#123;<span class="hljs-attr">...props</span>&#125; /></span>
      &#123;children&#125;
    <span class="hljs-tag"></<span class="hljs-name">div</span>></span></span>
  )
&#125;

<span class="hljs-comment">/* main.tsx */</span>
<span class="hljs-comment">// å‰ç«¯è·å–åå°æ³¨å…¥çš„storeæ•°æ®ï¼ŒåŒæ­¥storeæ•°æ®,å®¢æˆ·ç«¯è¿›è¡Œæ¸²æŸ“</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> getStore = <span class="hljs-function">(<span class="hljs-params">preloadedState?: <span class="hljs-built_in">any</span>, enhancer?: StoreEnhancer</span>) =></span> &#123;
  <span class="hljs-keyword">const</span> store = createStore(rootReducers, preloadedState, enhancer) <span class="hljs-keyword">as</span> IStore
  <span class="hljs-keyword">return</span> store
&#125;
<span class="hljs-keyword">const</span> store = getStore(<span class="hljs-built_in">window</span>.__PRELOADED_STATE__, <span class="hljs-built_in">window</span>.__REDUX_DEVTOOLS_EXTENSION__ && <span class="hljs-built_in">window</span>.__REDUX_DEVTOOLS_EXTENSION__())
loadableReady(<span class="hljs-function">() =></span> &#123;
  ReactDom.hydrate(
    <span class="xml"><span class="hljs-tag"><<span class="hljs-name">Provider</span> <span class="hljs-attr">store</span>=<span class="hljs-string">&#123;store&#125;</span>></span>
      <span class="hljs-tag"><<span class="hljs-name">BrowserRouter</span>></span>
        <span class="hljs-tag"><<span class="hljs-name">HelmetProvider</span>></span>
          <span class="hljs-tag"><<span class="hljs-name">Entry</span> /></span>
        <span class="hljs-tag"></<span class="hljs-name">HelmetProvider</span>></span>
      <span class="hljs-tag"></<span class="hljs-name">BrowserRouter</span>></span>
    <span class="hljs-tag"></<span class="hljs-name">Provider</span>></span></span>,
    <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">'app'</span>)
  )
&#125;)

<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<p>å‰ç«¯éœ€è¦çš„é€»è¾‘å¤§æ¦‚å°±æ˜¯è¿™äº›ï¼Œé‡ç‚¹è¿˜æ˜¯åœ¨æœåŠ¡ç«¯çš„å¤„ç†</p>
<h4 data-id="heading-27">2. æœåŠ¡ç«¯å¤„ç†ä»£ç </h4>
<pre><code class="hljs language-typescript copyable" lang="typescript"><span class="hljs-comment">// ç”±@loadable/babel-pluginæ’ä»¶æ‰“åŒ…å‡ºæ¥çš„loadable-stats.jsonè·¯å¾„ä¾èµ–è¡¨ï¼Œç”¨æ¥ç´¢å¼•å„ä¸ªé¡µé¢ä¾èµ–çš„jsï¼Œcssæ–‡ä»¶ç­‰ã€‚</span>
<span class="hljs-keyword">const</span> getStatsFile = <span class="hljs-keyword">async</span> () => &#123;
  <span class="hljs-keyword">const</span> statsFile = path.join(paths.buildClientPath, <span class="hljs-string">'loadable-stats.json'</span>)
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> ChunkExtractor(&#123; statsFile &#125;)
&#125;
<span class="hljs-comment">// è·å–ä¾èµ–æ–‡ä»¶å¯¹è±¡</span>
<span class="hljs-keyword">const</span> clientExtractor = <span class="hljs-keyword">await</span> getStatsFile()

<span class="hljs-comment">// storeæ¯æ¬¡åŠ è½½æ—¶ï¼Œéƒ½å¾—é‡æ–°ç”Ÿæˆï¼Œä¸èƒ½æ˜¯å•ä¾‹ï¼Œå¦åˆ™æ‰€æœ‰ç”¨æˆ·éƒ½ä¼šå…±äº«ä¸€ä¸ªstoreäº†ã€‚</span>
<span class="hljs-keyword">const</span> store = getStore()
<span class="hljs-comment">// åŒ¹é…å½“å‰è·¯ç”±å¯¹åº”çš„routeå¯¹è±¡</span>
<span class="hljs-keyword">const</span> &#123; route &#125; = matchRoutes(routes, ctx.path)
<span class="hljs-keyword">if</span> (route) &#123;
  <span class="hljs-keyword">const</span> match = matchPath(<span class="hljs-built_in">decodeURI</span>(ctx.path), route)
  <span class="hljs-keyword">const</span> routeParams = &#123;
    <span class="hljs-attr">params</span>: match?.params,
    <span class="hljs-attr">query</span>: ctx.query
  &#125;
  <span class="hljs-keyword">const</span> component = route.component
  <span class="hljs-comment">// @loadable/componentåŠ¨æ€åŠ è½½çš„ç»„ä»¶å…·æœ‰loadæ–¹æ³•ï¼Œç”¨æ¥åŠ è½½ç»„ä»¶çš„</span>
  <span class="hljs-keyword">if</span> (component.load) &#123;
    <span class="hljs-keyword">const</span> c = (<span class="hljs-keyword">await</span> component.load()).default
    <span class="hljs-comment">// æœ‰_initæ–¹æ³•ï¼Œç­‰å¾…è°ƒç”¨ï¼Œç„¶åæ•°æ®ä¼šå­˜å…¥Storeä¸­</span>
    c._init && (<span class="hljs-keyword">await</span> c._init(store, routeParams))
  &#125;
&#125;
<span class="hljs-comment">// é€šè¿‡ctx.urlç”Ÿæˆå¯¹åº”çš„æœåŠ¡ç«¯htmlï¼Œ clientExtractorè·å–å¯¹åº”è·¯å¾„ä¾èµ–</span>
<span class="hljs-keyword">const</span> appHtml = renderToString(
  clientExtractor.collectChunks(
    <span class="xml"><span class="hljs-tag"><<span class="hljs-name">Provider</span> <span class="hljs-attr">store</span>=<span class="hljs-string">&#123;store&#125;</span>></span>
      <span class="hljs-tag"><<span class="hljs-name">StaticRouter</span> <span class="hljs-attr">location</span>=<span class="hljs-string">&#123;ctx.url&#125;</span> <span class="hljs-attr">context</span>=<span class="hljs-string">&#123;context&#125;</span>></span>
        <span class="hljs-tag"><<span class="hljs-name">HelmetProvider</span> <span class="hljs-attr">context</span>=<span class="hljs-string">&#123;helmetContext&#125;</span>></span>
          <span class="hljs-tag"><<span class="hljs-name">App</span> /></span>
        <span class="hljs-tag"></<span class="hljs-name">HelmetProvider</span>></span>
      <span class="hljs-tag"></<span class="hljs-name">StaticRouter</span>></span>
    <span class="hljs-tag"></<span class="hljs-name">Provider</span>></span></span>
  )
)

<span class="hljs-comment">/* 
  clientExtractorï¼š
    getInlineStyleElementsï¼šstyleæ ‡ç­¾ï¼Œè¡Œå†…cssæ ·å¼
    getScriptElementsï¼š scriptæ ‡ç­¾
    getLinkElementsï¼š Linkæ ‡ç­¾ï¼ŒåŒ…æ‹¬é¢„åŠ è½½çš„js css linkæ–‡ä»¶
    getStyleElements: linkæ ‡ç­¾çš„æ ·å¼æ–‡ä»¶
*/</span>
<span class="hljs-keyword">const</span> inlineStyle = <span class="hljs-keyword">await</span> clientExtractor.getInlineStyleElements()
<span class="hljs-keyword">const</span> html = createTemplate(
  renderToString(
    <span class="xml"><span class="hljs-tag"><<span class="hljs-name">HTML</span>
      <span class="hljs-attr">helmetContext</span>=<span class="hljs-string">&#123;helmetContext&#125;</span>
      <span class="hljs-attr">scripts</span>=<span class="hljs-string">&#123;clientExtractor.getScriptElements()&#125;</span>
      <span class="hljs-attr">styles</span>=<span class="hljs-string">&#123;clientExtractor.getStyleElements()&#125;</span>
      <span class="hljs-attr">inlineStyle</span>=<span class="hljs-string">&#123;inlineStyle&#125;</span>
      <span class="hljs-attr">links</span>=<span class="hljs-string">&#123;clientExtractor.getLinkElements()&#125;</span>
      <span class="hljs-attr">favicon</span>=<span class="hljs-string">&#123;</span>`$&#123;
        <span class="hljs-attr">serverConfig.isProd</span> ? '/' <span class="hljs-attr">:</span> `$&#123;<span class="hljs-attr">scriptsConfig.__WEBPACK_HOST__</span>&#125;<span class="hljs-attr">:</span>$&#123;<span class="hljs-attr">scriptsConfig.__WEBPACK_PORT__</span>&#125;/`
      &#125;<span class="hljs-attr">static</span>/<span class="hljs-attr">client_favicon.ico</span>`&#125;
      <span class="hljs-attr">state</span>=<span class="hljs-string">&#123;store.getState()&#125;</span>
    ></span>
      &#123;appHtml&#125;
    <span class="hljs-tag"></<span class="hljs-name">HTML</span>></span></span>
  )
)
<span class="hljs-comment">// HTMLç»„ä»¶æ¨¡æ¿</span>
<span class="hljs-comment">// é€šè¿‡æ’å…¥styleæ ‡ç­¾çš„æ ·å¼é˜²æ­¢é¦–å±åŠ è½½æ ·å¼é”™ä¹±</span>
<span class="hljs-comment">// æŠŠstoreé‡Œé¢çš„æ•°æ®æ³¨å…¥åˆ° window.__PRELOADED_STATE__ å¯¹è±¡ä¸Šï¼Œç„¶ååœ¨å®¢æˆ·ç«¯è¿›è¡Œè·å–ï¼ŒåŒæ­¥storeæ•°æ®</span>
<span class="hljs-keyword">const</span> HTML = <span class="hljs-function">(<span class="hljs-params">&#123; children, helmetContext: &#123; helmet &#125;, scripts, styles, inlineStyle, links, state, favicon &#125;: Props</span>) =></span> &#123;
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag"><<span class="hljs-name">html</span> <span class="hljs-attr">data-theme</span>=<span class="hljs-string">"light"</span>></span>
      <span class="hljs-tag"><<span class="hljs-name">head</span>></span>
        <span class="hljs-tag"><<span class="hljs-name">meta</span> <span class="hljs-attr">charSet</span>=<span class="hljs-string">"utf-8"</span> /></span>
        &#123;hasTitle ? titleComponents : <span class="hljs-tag"><<span class="hljs-name">title</span>></span>&#123;rootConfig.head.title&#125;<span class="hljs-tag"></<span class="hljs-name">title</span>></span>&#125;
        &#123;helmet.base.toComponent()&#125;
        &#123;metaComponents&#125;
        &#123;helmet.link.toComponent()&#125;
        &#123;helmet.script.toComponent()&#125;
        &#123;links&#125;
        <span class="hljs-tag"><<span class="hljs-name">style</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"style-variables"</span>></span>
          &#123;`:root &#123;$&#123;Object.keys(theme.light)
            .map((key) => `$&#123;key&#125;:$&#123;theme.light[key]&#125;;`)
            .join('')&#125;&#125;`&#125;
        <span class="hljs-tag"></<span class="hljs-name">style</span>></span>
        // æ­¤å¤„ç›´æ¥ä¼ å…¥styleæ ‡ç­¾çš„æ ·å¼ï¼Œé¿å…é¦–æ¬¡è¿›å…¥æ ·å¼é”™è¯¯çš„é—®é¢˜
        &#123;inlineStyle&#125;
        // åœ¨æ­¤å¤„å®ç°æ•°æ®æ³¨æ°´ï¼ŒæŠŠstoreä¸­çš„æ•°æ®èµ‹å€¼åˆ°window.__PRELOADED_STATE__ä¸Š
        <span class="hljs-tag"><<span class="hljs-name">script</span>
          <span class="hljs-attr">dangerouslySetInnerHTML</span>=<span class="hljs-string">&#123;&#123;</span>
            <span class="hljs-attr">__html:</span> `<span class="hljs-attr">window.__PRELOADED_STATE__</span> = <span class="hljs-string">$&#123;JSON.stringify(state).replace(/</span></<span class="hljs-attr">g</span>, '\\<span class="hljs-attr">u003c</span>')&#125;`
          &#125;&#125;
        /></span><span class="handlebars"><span class="xml">
        <span class="hljs-tag"><<span class="hljs-name">script</span> <span class="hljs-attr">async</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"//at.alicdn.com/t/font_2062907_scf16rx8d6.js"</span>></span></span></span><span class="hljs-tag"></<span class="hljs-name">script</span>></span>
      <span class="hljs-tag"></<span class="hljs-name">head</span>></span>
      <span class="hljs-tag"><<span class="hljs-name">body</span>></span>
        <span class="hljs-tag"><<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"app"</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"app"</span> <span class="hljs-attr">dangerouslySetInnerHTML</span>=<span class="hljs-string">&#123;&#123;</span> <span class="hljs-attr">__html:</span> <span class="hljs-attr">children</span> &#125;&#125;></span><span class="hljs-tag"></<span class="hljs-name">div</span>></span>
        &#123;scripts&#125;
      <span class="hljs-tag"></<span class="hljs-name">body</span>></span>
    <span class="hljs-tag"></<span class="hljs-name">html</span>></span></span>
  )
&#125;
ctx.type = <span class="hljs-string">'html'</span>
ctx.body = html
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<h4 data-id="heading-28">3. æ‰§è¡Œæµç¨‹</h4>
<ul>
<li>é€šè¿‡<code>@loadable/babel-plugin</code>æ‰“åŒ…å‡ºæ¥çš„<code>loadable-stats.json</code>æ–‡ä»¶ç¡®å®šä¾èµ–</li>
<li>é€šè¿‡<code>@loadable/server</code>ä¸­çš„<code>ChunkExtractor</code>æ¥è§£æè¿™ä¸ªæ–‡ä»¶ï¼Œè¿”å›ç›´æ¥æ“ä½œçš„å¯¹è±¡</li>
<li><code>ChunkExtractor.collectChunks</code>å…³è”ç»„ä»¶ï¼Œè·å–jsè·Ÿæ ·å¼æ–‡ä»¶</li>
<li>æŠŠè·å–çš„jsï¼Œcssæ–‡ä»¶èµ‹å€¼åˆ°HTMLæ¨¡æ¿ä¸Šå»ï¼Œè¿”å›ç»™å‰ç«¯ï¼Œ</li>
<li>ç”¨è¡Œå†…æ ·å¼styleæ ‡ç­¾æ¸²æŸ“é¦–å±çš„æ ·å¼ï¼Œé¿å…é¦–å±å‡ºç°æ ·å¼é”™è¯¯ã€‚</li>
<li>æŠŠé€šè¿‡è°ƒç”¨ç»„ä»¶<code>_init</code>æ–¹æ³•è·å–åˆ°çš„æ•°æ®ï¼Œæ³¨æ°´åˆ°<code>window.__PRELOADED_STATE__</code>ä¸­</li>
<li>å‰ç«¯è·å–<code>window.__PRELOADED_STATE__</code>æ•°æ®åŒæ­¥åˆ°å®¢æˆ·ç«¯çš„storeé‡Œé¢</li>
<li>å‰ç«¯å–åˆ°jsæ–‡ä»¶,é‡æ–°æ‰§è¡Œæ¸²æŸ“æµç¨‹ã€‚ç»‘å®šreactäº‹ä»¶ç­‰ç­‰</li>
<li>å‰ç«¯æ¥ç®¡é¡µé¢</li>
</ul>
<h4 data-id="heading-29">4. Tokençš„å¤„ç†</h4>
<p>åš<code>SSR</code>çš„æ—¶å€™ç”¨æˆ·è¿›è¡Œç™»å½•è¿˜ä¼šæ‰¯å‡ºä¸€ä¸ªå…³äºtokençš„é—®é¢˜ã€‚ç™»å½•å®Œåä¼šæŠŠ<code>token</code>å­˜åˆ°<code>cookie</code>ä¸­ã€‚åˆ°æ—¶å€™ç›´æ¥é€šè¿‡<code>token</code>è·å–ä¸ªäººä¿¡æ¯
æ­£å¸¸æ¥è¯´ä¸åš<code>SSR</code>ï¼Œæ­£å¸¸å‰åç«¯åˆ†ç¦»è¿›è¡Œæ¥å£è¯·æ±‚ï¼Œéƒ½æ˜¯ä» <code>clientç«¯ => serverç«¯</code>ï¼Œæ‰€ä»¥æ¥å£ä¸­çš„<code>cookie</code>æ¯æ¬¡éƒ½ä¼šæºå¸¦<code>token</code>,æ¯æ¬¡ä¹Ÿéƒ½èƒ½åœ¨æ¥å£ä¸­å–åˆ°<code>token</code>ã€‚
ä½†æ˜¯åœ¨åš<code>SSR</code>çš„æ—¶å€™ï¼Œé¦–æ¬¡åŠ è½½æ—¶åœ¨æœåŠ¡ç«¯è¿›è¡Œçš„ï¼Œæ‰€ä»¥æ¥å£è¯·æ±‚æ˜¯åœ¨æœåŠ¡ç«¯è¿›è¡Œçš„ï¼Œè¿™ä¸ªæ—¶å€™ä½ åœ¨æ¥å£ä¸­æ˜¯è·å–ä¸åˆ°<code>token</code>çš„ã€‚</p>
<p>æˆ‘å°è¯•äº†å·²ä¸‹å‡ ç§æ–¹æ³•ï¼š</p>
<ul>
<li>åœ¨è¯·æ±‚è¿‡æ¥çš„æ—¶å€™ï¼ŒæŠŠ<code>token</code>è·å–åˆ°ï¼Œç„¶åå­˜å…¥<code>store</code>,åœ¨è¿›è¡Œç”¨æˆ·ä¿¡æ¯è·å–çš„æ—¶å€™ï¼Œå–å‡ºstoreä¸­çš„tokenä¼ å…¥url,å°±åƒè¿™æ ·ï¼š <code>/api/user?token=$&#123;token&#125;</code>ï¼Œä½†æ˜¯è¿™æ ·çš„è¯ï¼Œå‡å¦‚æœ‰å¥½å¤šæ¥å£éœ€è¦tokenï¼Œé‚£æˆ‘ä¸æ˜¯æ¯ä¸ªéƒ½è¦ä¼ ã€‚é‚£ä¹Ÿå¤ªéº»çƒ¦äº†ã€‚</li>
<li>ç„¶åæˆ‘å°±å¯»æ€èƒ½ä¸èƒ½æŠŠstoreé‡Œé¢çš„tokenä¼ åˆ°axiosçš„headeré‡Œé¢ï¼Œé‚£æ ·ä¸å°±ä¸éœ€è¦æ¯ä¸ªéƒ½å†™äº†ã€‚ä½†æˆ‘æƒ³äº†å¥½å‡ ç§åŠæ³•ï¼Œéƒ½æ²¡æœ‰æƒ³åˆ°æ€ä¹ˆæŠŠstoreé‡Œé¢çš„tokenæ”¾åˆ°è¯·æ±‚headerä¸­ï¼Œå› ä¸ºstoreæ˜¯è¦éš”ç¦»çš„ã€‚æˆ‘ç”Ÿæˆstoreä¹‹åï¼Œåªèƒ½æŠŠä»–ä¼ åˆ°ç»„ä»¶é‡Œé¢ï¼Œæœ€å¤šå°±æ˜¯åœ¨ç»„ä»¶é‡Œé¢è°ƒç”¨è¯·æ±‚çš„æ—¶å€™ï¼Œä¼ å‚ä¼ ä¸‹å»ï¼Œé‚£ä¸è¿˜æ˜¯ä¸€æ ·æ¯ä¸ªéƒ½è¦å†™ä¹ˆã€‚</li>
<li>æœ€åæˆ‘ä¹Ÿå¿˜äº†æ˜¯åœ¨å“ªçœ‹åˆ°ä¸€ç¯‡æ–‡ç« ï¼Œå¯ä»¥æŠŠtokenå­˜åˆ°è¯·æ±‚çš„å®ä¾‹ä¸Šï¼Œæˆ‘ç”¨çš„axiosï¼Œæ‰€ä»¥æˆ‘å°±æƒ³æŠŠä»–èµ‹å€¼åˆ°axioså®ä¾‹ä¸Šï¼Œä½œä¸ºä¸€ä¸ªå±æ€§ã€‚ä½†æ˜¯è¦æ³¨æ„ä¸€ä¸ªé—®é¢˜ï¼Œaxiosè¿™ä¸ªæ—¶å€™åœ¨æœåŠ¡ç«¯å°±å¾—åšéš”ç¦»äº†ã€‚ä¸ç„¶å°±æ‰€æœ‰ç”¨æˆ·å°±å…±ç”¨äº†ã€‚</li>
</ul>
<blockquote>
<p>ä»£ç å®ç°</p>
</blockquote>
<pre><code class="hljs language-typescript copyable" lang="typescript"><span class="hljs-comment">/* @client/utils/request.ts */</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Axios</span> </span>&#123;
  <span class="hljs-function"><span class="hljs-title">request</span>(<span class="hljs-params"></span>)</span> &#123;
    <span class="hljs-comment">// åŒºåˆ†æ˜¯æœåŠ¡ç«¯ï¼Œè¿˜æ˜¯æµè§ˆå™¨ç«¯ï¼ŒæœåŠ¡ç«¯æŠŠtokenå­˜åœ¨ axioså®ä¾‹å±æ€§tokenä¸Š, æµè§ˆå™¨ç«¯å°±ç›´æ¥ä»cookieä¸­è·å–tokenå°±è¡Œ</span>
    <span class="hljs-keyword">const</span> key = process.env.BROWSER_ENV ? Cookie.get(<span class="hljs-string">'token'</span>) : <span class="hljs-built_in">this</span>[<span class="hljs-string">'token'</span>]
    <span class="hljs-keyword">if</span> (key) &#123;
      headers[<span class="hljs-string">'token'</span>] = key
    &#125;
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.axios(&#123;
      method,
      url,
      [q]: data,
      headers
    &#125;)
  &#125;
&#125;
<span class="hljs-keyword">import</span> Axios <span class="hljs-keyword">from</span> <span class="hljs-string">'./Axios'</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">new</span> Axios()

<span class="hljs-comment">/* ssr.ts */</span>
<span class="hljs-comment">// ä¸è¦åœ¨å¤–éƒ¨å¼•å…¥ï¼Œé‚£æ ·å°±æ‰€æœ‰ç”¨æˆ·å…±ç”¨äº†</span>
<span class="hljs-comment">// import Axios from @client/utils/request</span>

<span class="hljs-comment">// ssrä»£ç å®ç°</span>
app.use(<span class="hljs-keyword">async</span> (ctx, next) => &#123;
  ...
  <span class="hljs-comment">// åœ¨æ­¤å¤„å¼•å…¥axios, ç»™ä»–æ·»åŠ tokenå±æ€§,è¿™ä¸ªæ—¶å€™æ¯æ¬¡è¯·æ±‚éƒ½å¯ä»¥åœ¨headerä¸­æ”¾å…¥tokenäº†ï¼Œå°±è§£å†³äº†SSR tokençš„é—®é¢˜</span>
  <span class="hljs-keyword">const</span> request = <span class="hljs-built_in">require</span>(<span class="hljs-string">'@client/utils/request'</span>).default
  request[<span class="hljs-string">'token'</span>] = ctx.cookies.get(<span class="hljs-string">'token'</span>) || <span class="hljs-string">''</span>
&#125;)

<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<p>åŸºæœ¬ä¸ŠæœåŠ¡ç«¯çš„åŠŸèƒ½å¤§æ¦‚å°±æ˜¯è¿™äº›ï¼Œè¿˜æœ‰ä¸€äº›åˆ«çš„åŠŸèƒ½ç‚¹å°±ä¸æµªè´¹ç¯‡å¹…è¿›è¡Œè®²è§£äº†ã€‚</p>
<h2 data-id="heading-30">Clientç«¯æºç è§£æ</h2>
<h3 data-id="heading-31">1. è·¯ç”±å¤„ç†</h3>
<p>å› ä¸ºæœ‰çš„è·¯ç”±æœ‰layoutå¸ƒå±€ï¼Œåƒé¦–é¡µï¼Œåšå®¢è¯¦æƒ…ç­‰ç­‰é¡µé¢ï¼Œéƒ½æœ‰å…¬å…±çš„å¯¼èˆªä¹‹ç±»çš„ã€‚è€Œåƒ404é¡µé¢ï¼Œé”™è¯¯é¡µé¢æ˜¯æ²¡æœ‰è¿™äº›å¸ƒå±€çš„ã€‚
æ‰€ä»¥åŒºåˆ†äº†çš„è¿™ä¸¤ç§è·¯ç”±ï¼Œå› ä¸ºä¹Ÿé…å¥—äº†ä¸¤å¥—loadingåŠ¨ç”»ã€‚
åŸºäºlayoutéƒ¨åˆ†çš„è¿‡æ¸¡çš„åŠ¨ç”»ï¼Œä¹ŸåŒºåˆ†äº†pc è·Ÿ mobileçš„è¿‡æ¸¡æ–¹å¼ï¼Œ</p>
<p>PCè¿‡æ¸¡åŠ¨ç”»
<img src="https://assets.open.dzblog.cn/images/markdown/957253747.gif" alt="pcè¿‡æ¸¡åŠ¨ç”»" loading="lazy" referrerpolicy="no-referrer"></p>
<p>Mobileè¿‡æ¸¡åŠ¨ç”»
<img src="https://assets.open.dzblog.cn/images/markdown/863612537.gif" alt="mobileè¿‡æ¸¡åŠ¨ç”»" loading="lazy" referrerpolicy="no-referrer"></p>
<p>è¿‡æ¸¡åŠ¨ç”»æ˜¯ç”± <code>react-transition-group</code> å®ç°çš„ã€‚
é€šè¿‡è·¯ç”±çš„å‰è¿›åé€€æ¥æ”¹å˜ä¸åŒçš„classNameæ¥æ‰§è¡Œä¸åŒçš„åŠ¨ç”»ã€‚</p>
<ul>
<li><code>router-forward</code>ï¼š å‰è¿›ï¼Œè¿›å…¥æ–°é¡µé¢</li>
<li><code>router-back</code>ï¼š è¿”å›</li>
<li><code>router-fade</code>ï¼š é€æ˜åº¦å˜åŒ–ï¼Œç”¨äºé¡µé¢replace</li>
</ul>
<pre><code class="hljs language-typescript copyable" lang="typescript"><span class="hljs-keyword">const</span> RenderLayout = <span class="hljs-function">() =></span> &#123;
  useRouterEach()
  <span class="hljs-keyword">const</span> routerDirection = getRouterDirection(store, location)
  <span class="hljs-keyword">if</span> (!isPageTransition) &#123;
    <span class="hljs-comment">// æ‰‹åŠ¨æˆ–è€…Linkè§¦å‘pushæ“ä½œ</span>
    <span class="hljs-keyword">if</span> (history.action === <span class="hljs-string">'PUSH'</span>) &#123;
      classNames = <span class="hljs-string">'router-forward'</span>
    &#125;
    <span class="hljs-comment">// æµè§ˆå™¨æŒ‰é’®è§¦å‘ï¼Œæˆ–ä¸»åŠ¨popæ“ä½œ</span>
    <span class="hljs-keyword">if</span> (history.action === <span class="hljs-string">'POP'</span>) &#123;
      classNames = <span class="hljs-string">`router-<span class="hljs-subst">$&#123;routerDirection&#125;</span>`</span>
    &#125;
    <span class="hljs-keyword">if</span> (history.action === <span class="hljs-string">'REPLACE'</span>) &#123;
      classNames = <span class="hljs-string">'router-fade'</span>
    &#125;
  &#125;
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag"><<span class="hljs-name">TransitionGroup</span> <span class="hljs-attr">appear</span> <span class="hljs-attr">enter</span> <span class="hljs-attr">exit</span> <span class="hljs-attr">component</span>=<span class="hljs-string">&#123;null&#125;</span> <span class="hljs-attr">childFactory</span>=<span class="hljs-string">&#123;(child)</span> =></span> React.cloneElement(child, &#123; classNames &#125;)&#125;>
      <span class="hljs-tag"><<span class="hljs-name">CSSTransition</span>
        <span class="hljs-attr">key</span>=<span class="hljs-string">&#123;location.pathname&#125;</span>
        <span class="hljs-attr">timeout</span>=<span class="hljs-string">&#123;500&#125;</span>
      ></span>
        <span class="hljs-tag"><<span class="hljs-name">Switch</span> <span class="hljs-attr">location</span>=<span class="hljs-string">&#123;location&#125;</span>></span>
          &#123;layoutRoutes.map((route, index) => &#123;
            return (
              <span class="hljs-tag"><<span class="hljs-name">Route</span>
                <span class="hljs-attr">key</span>=<span class="hljs-string">&#123;</span>`$&#123;<span class="hljs-attr">index</span>&#125; + $&#123;<span class="hljs-attr">route.path</span>&#125;`&#125;
                <span class="hljs-attr">path</span>=<span class="hljs-string">&#123;route.path&#125;</span>
                <span class="hljs-attr">render</span>=<span class="hljs-string">&#123;(props)</span> =></span> &#123;
                  return (
                    <span class="hljs-tag"><<span class="hljs-name">RouterGuard</span> <span class="hljs-attr">Com</span>=<span class="hljs-string">&#123;route.component&#125;</span> &#123;<span class="hljs-attr">...props</span>&#125;></span>
                      &#123;children&#125;
                    <span class="hljs-tag"></<span class="hljs-name">RouterGuard</span>></span>
                  )
                &#125;&#125;
                exact=&#123;route.exact&#125;
              />
            )
          &#125;)&#125;
          <span class="hljs-tag"><<span class="hljs-name">Redirect</span> <span class="hljs-attr">to</span>=<span class="hljs-string">"/404"</span> /></span>
        <span class="hljs-tag"></<span class="hljs-name">Switch</span>></span>
      <span class="hljs-tag"></<span class="hljs-name">CSSTransition</span>></span>
    <span class="hljs-tag"></<span class="hljs-name">TransitionGroup</span>></span></span>
  )
&#125;
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<p>åŠ¨ç”»å‰è¿›åé€€çš„å®ç°å› ä¸ºæ¶‰åŠåˆ°æµè§ˆå™¨æœ¬èº«çš„å‰è¿›åé€€ï¼Œä¸å•çº¯åªæ˜¯é¡µé¢å†…æˆ‘ä»¬æ“æ§çš„å‰è¿›åé€€ã€‚
æ‰€ä»¥å°±éœ€è¦è®°å½•è·¯ç”±å˜åŒ–ï¼Œæ¥ç¡®å®šæ˜¯å‰è¿›è¿˜æ˜¯åé€€ï¼Œä¸èƒ½åªé historyçš„actionæ¥åˆ¤æ–­</p>
<ul>
<li><code>history.action === 'PUSH'</code>è‚¯å®šæ˜¯ç®—å‰è¿›ï¼Œå› ä¸ºè¿™æ˜¯æˆ‘ä»¬è§¦å‘ç‚¹å‡»è¿›å…¥æ–°é¡µé¢æ‰ä¼šè§¦å‘</li>
<li><code>history.action === 'POP'</code>æœ‰å¯èƒ½æ˜¯history.back()è§¦å‘ï¼Œä¹Ÿæœ‰å¯èƒ½æ˜¯æµè§ˆå™¨ç³»ç»Ÿè‡ªå¸¦çš„å‰è¿›ï¼Œåé€€æŒ‰é’®è§¦å‘ï¼Œ</li>
<li>æ¥ä¸‹æ¥è¦åšçš„å°±æ˜¯å¦‚ä½•åŒºåˆ†æµè§ˆå™¨ç³»ç»Ÿçš„å‰è¿›å’Œåé€€ã€‚ä»£ç å®ç°å°±åœ¨<code>useRouterEach</code>è¿™ä¸ªhookå’Œ<code>getRouterDirection</code>æ–¹æ³•é‡Œé¢ã€‚</li>
<li><code>useRouterEach</code>hookå‡½æ•°</li>
</ul>
<pre><code class="hljs language-typescript copyable" lang="typescript"><span class="hljs-comment">// useRouterEach</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> useRouterEach = <span class="hljs-function">() =></span> &#123;
  <span class="hljs-keyword">const</span> location = useLocation()
  <span class="hljs-keyword">const</span> dispatch = useDispatch()
  <span class="hljs-comment">// æ›´æ–°å¯¼èˆªè®°å½•</span>
  useEffect(<span class="hljs-function">() =></span> &#123;
    dispatch(
      updateNaviagtion(&#123;
        <span class="hljs-attr">path</span>: location.pathname,
        <span class="hljs-attr">key</span>: location.key || <span class="hljs-string">''</span>
      &#125;)
    )
  &#125;, [location, dispatch])
&#125;
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<ul>
<li><code>updateNaviagtion</code>é‡Œé¢åšäº†ä¸€ä¸ªè·¯ç”±è®°å½•çš„å¢åˆ æ”¹,å› ä¸ºæ¯æ¬¡è¿›å…¥æ–°é¡µé¢<code>location.key</code>ä¼šç”Ÿæˆä¸€ä¸ªæ–°çš„<code>key</code>,æˆ‘ä»¬å¯ä»¥ç”¨<code>key</code>æ¥è®°å½•è¿™ä¸ªè·¯ç”±æ˜¯æ–°çš„è¿˜æ˜¯æ—§çš„ï¼Œæ–°çš„å°±<code>push</code>åˆ°<code>navigations</code>é‡Œé¢,å¦‚æœå·²ç»å­˜åœ¨è¿™æ¡è®°å½•ï¼Œå°±å¯ä»¥ç›´æ¥æˆªå–è¿™æ¡è®°å½•ä»¥å‰çš„è·¯ç”±è®°å½•å°±è¡Œï¼Œç„¶åæŠŠ<code>navigations</code>æ›´æ–°ã€‚è¿™é‡Œåšçš„æ˜¯æ•´ä¸ªå¯¼èˆªçš„è®°å½•</li>
</ul>
<pre><code class="hljs language-typescript copyable" lang="typescript"><span class="hljs-keyword">const</span> navigation = (state = INIT_STATE, <span class="hljs-attr">action</span>: NavigationAction): <span class="hljs-function"><span class="hljs-params">NavigationState</span> =></span> &#123;
  <span class="hljs-keyword">switch</span> (action.type) &#123;
    <span class="hljs-keyword">case</span> UPDATE_NAVIGATION: &#123;
      <span class="hljs-keyword">const</span> payload = action.payload
      <span class="hljs-keyword">let</span> navigations = [...state.navigations]
      <span class="hljs-keyword">const</span> index = navigations.findIndex(<span class="hljs-function">(<span class="hljs-params">p</span>) =></span> p.key === payload.key)
      <span class="hljs-comment">// å­˜åœ¨ç›¸åŒè·¯å¾„,åˆ é™¤</span>
      <span class="hljs-keyword">if</span> (index > -<span class="hljs-number">1</span>) &#123;
        navigations = navigations.slice(<span class="hljs-number">0</span>, index + <span class="hljs-number">1</span>)
      &#125; <span class="hljs-keyword">else</span> &#123;
        navigations.push(payload)
      &#125;
      Session.set(navigationKey, navigations)
      <span class="hljs-keyword">return</span> &#123;
        ...state,
        navigations
      &#125;
    &#125;
  &#125;
&#125;
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<ul>
<li><code>getRouterDirection</code>æ–¹æ³•ï¼Œè·å–<code>navigations</code>æ•°æ®ï¼Œé€šè¿‡<code>location.key</code>æ¥åˆ¤æ–­è¿™ä¸ªè·¯ç”±æ˜¯å¦åœ¨<code>navigations</code>é‡Œé¢ï¼Œåœ¨çš„è¯è¯æ˜æ˜¯è¿”å›ï¼Œå¦‚æœä¸åœ¨çš„è¯æ˜æ˜¯å‰è¿›ã€‚è¿™æ ·ä¾¿èƒ½åŒºåˆ†æµè§ˆå™¨æ˜¯åœ¨å‰è¿›è¿›å…¥çš„æ–°é¡µé¢ï¼Œè¿˜æ˜¯åé€€è¿”å›çš„æ—§é¡µé¢ã€‚</li>
</ul>
<pre><code class="hljs language-typescript copyable" lang="typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> getRouterDirection = <span class="hljs-function">(<span class="hljs-params">store: Store<IStoreState>, location: Location</span>) =></span> &#123;
  <span class="hljs-keyword">const</span> state = store.getState()
  <span class="hljs-keyword">const</span> navigations = state.navigation?.navigations
  <span class="hljs-keyword">if</span> (!navigations) &#123;
    <span class="hljs-keyword">return</span> <span class="hljs-string">'forward'</span>
  &#125;
  <span class="hljs-keyword">const</span> index = navigations.findIndex(<span class="hljs-function">(<span class="hljs-params">p</span>) =></span> p.key === (location.key || <span class="hljs-string">''</span>))
  <span class="hljs-keyword">if</span> (index > -<span class="hljs-number">1</span>) &#123;
    <span class="hljs-keyword">return</span> <span class="hljs-string">'back'</span>
  &#125; <span class="hljs-keyword">else</span> &#123;
    <span class="hljs-keyword">return</span> <span class="hljs-string">'forward'</span>
  &#125;
&#125;
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<blockquote>
<p>è·¯ç”±åˆ‡æ¢é€»è¾‘</p>
</blockquote>
<ol>
<li><code>history.action === 'PUSH'</code> è¯æ˜æ˜¯å‰è¿›</li>
<li>å¦‚æœæ˜¯<code>history.action === 'POP'</code>,é€šè¿‡<code>location.key</code>å»è®°å½•å¥½çš„<code>navigations</code>æ¥åˆ¤æ–­è¿™ä¸ªé¡µé¢æ˜¯æ–°çš„é¡µé¢ï¼Œè¿˜æ˜¯å·²ç»åˆ°è¿‡çš„é¡µé¢ã€‚æ¥åŒºåˆ†æ˜¯å‰è¿›è¿˜æ˜¯åé€€</li>
<li>é€šè¿‡è·å–çš„ <code>forward</code> æˆ– <code>back</code> æ‰§è¡Œå„è‡ªçš„è·¯ç”±è¿‡æ¸¡åŠ¨ç”»ã€‚</li>
</ol>
<h3 data-id="heading-32">2. ä¸»é¢˜æ¢è‚¤</h3>
<p>é€šè¿‡<code>csså˜é‡</code>æ¥åšæ¢è‚¤æ•ˆæœï¼Œåœ¨<code>theme</code>æ–‡ä»¶é‡Œé¢å£°æ˜å¤šä¸ªä¸»é¢˜æ ·å¼</p>
<pre><code class="copyable">|-- theme
    |-- dark
    |-- light
    |-- index.ts
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<pre><code class="hljs language-typescript copyable" lang="typescript"><span class="hljs-comment">// dark.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> &#123;
  <span class="hljs-string">'--primary'</span>: <span class="hljs-string">'#20a0ff'</span>,
  <span class="hljs-string">'--analogous'</span>: <span class="hljs-string">'#20baff'</span>,
  <span class="hljs-string">'--gray'</span>: <span class="hljs-string">'#738192'</span>
  <span class="hljs-string">'--red'</span>: <span class="hljs-string">'#E6454A'</span>
&#125;
<span class="hljs-comment">// light.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> &#123;
  <span class="hljs-string">'--primary'</span>: <span class="hljs-string">'#20a0ff'</span>,
  <span class="hljs-string">'--analogous'</span>: <span class="hljs-string">'#20baff'</span>,
  <span class="hljs-string">'--gray'</span>: <span class="hljs-string">'#738192'</span>
  <span class="hljs-string">'--red'</span>: <span class="hljs-string">'#E6454A'</span>
&#125;
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<p>ç„¶åé€‰æ‹©ä¸€ä¸ªæ ·å¼èµ‹å€¼åˆ°styleæ ‡ç­¾é‡Œé¢ä½œä¸ºå…¨å±€csså˜é‡æ ·å¼,åœ¨æœåŠ¡ç«¯æ¸²æŸ“çš„æ—¶å€™ï¼Œåœ¨HTMLæ¨¡æ¿é‡Œé¢æ’å…¥äº†ä¸€æ¡<code>id=style-variables</code>çš„styleæ ‡ç­¾ã€‚
å¯ä»¥é€šè¿‡JSæ¥æ§åˆ¶styleæ ‡ç­¾é‡Œé¢çš„å†…å®¹ï¼Œç›´æ¥æ›¿æ¢å°±å¥½,æ¯”è¾ƒæ–¹ä¾¿çš„è¿›è¡Œä¸»é¢˜åˆ‡æ¢ï¼Œä¸è¿‡è¿™ç©æ„ä¸å…¼å®¹IEï¼Œå¦‚æœä½ æƒ³ç”¨ä»–ï¼Œåˆéœ€è¦å…¼å®¹ieï¼Œå¯ä»¥ä½¿ç”¨<a href="https://www.npmjs.com/package/css-vars-ponyfill" target="_blank" rel="nofollow noopener noreferrer">css-vars-ponyfill</a>æ¥å¤„ç†csså˜é‡ã€‚</p>
<pre><code class="hljs language-javascript copyable" lang="javascript"><style id=<span class="hljs-string">"style-variables"</span>>
  &#123;<span class="hljs-string">`:root &#123;<span class="hljs-subst">$&#123;<span class="hljs-built_in">Object</span>.keys(theme.light)
    .map((key) => <span class="hljs-string">`<span class="hljs-subst">$&#123;key&#125;</span>:<span class="hljs-subst">$&#123;theme.light[key]&#125;</span>;`</span>)
    .join(<span class="hljs-string">''</span>)&#125;</span>&#125;`</span>&#125;
</style>

<span class="hljs-keyword">const</span> onChangeTheme = <span class="hljs-function">(<span class="hljs-params">type = <span class="hljs-string">'dark'</span></span>) =></span> &#123;
  <span class="hljs-keyword">const</span> dom = <span class="hljs-built_in">document</span>.querySelector(<span class="hljs-string">'#style-variables'</span>)
  <span class="hljs-keyword">if</span> (dom) &#123;
    dom.innerHTML = <span class="hljs-string">`
    :root &#123;<span class="hljs-subst">$&#123;<span class="hljs-built_in">Object</span>.keys(theme[type])
      .map((key) => <span class="hljs-string">`<span class="hljs-subst">$&#123;key&#125;</span>:<span class="hljs-subst">$&#123;theme[type][key]&#125;</span>;`</span>)
      .join(<span class="hljs-string">''</span>)&#125;</span>&#125;
    `</span>
  &#125;
&#125;
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<p>ä¸è¿‡åšå®¢æ²¡æœ‰åšä¸»é¢˜åˆ‡æ¢ï¼Œä¸»é¢˜åˆ‡æ¢å€’æ˜¯ç®€å•ï¼Œåæ­£æˆ‘ä¹Ÿä¸æ‰“ç®—å…¼å®¹ieä»€ä¹ˆçš„ï¼Œæœ¬æ¥æƒ³åšæ¥ç€ï¼Œä½†æ˜¯æ­é…é¢œè‰²å®åœ¨å¯¹æˆ‘æœ‰ç‚¹å›°éš¾ğŸ˜¢ğŸ˜¢ï¼Œå¯»æ€ä¸€ä¸‹æš‚æ—¶ä¸è€ƒè™‘äº†ã€‚æœ¬æ¥UIä¹Ÿæ˜¯å„ç§çœ‹åˆ«äººå¥½çœ‹çš„åšå®¢æ€ä¹ˆè®¾è®¡çš„ï¼Œè‡ªå·±ä¹Ÿæ˜¯ä»¿ç€åˆ«äººçš„è®¾è®¡ï¼Œåœ¨åŠ ä¸Šè‡ªå·±çš„ä¸€ç‚¹ç‚¹è®¾è®¡ã€‚æ‰å¼„å‡ºçš„UIã€‚æ­£å¸¸èƒ½çœ‹å°±æŒºå¥½äº†ï¼Œå°±æ²¡æä¸»é¢˜äº†ï¼Œä»¥åå†åŠ ï¼Œå“ˆå“ˆã€‚</p>
<h3 data-id="heading-33">3. ä½¿ç”¨Sentryåšé¡¹ç›®ç›‘æ§</h3>
<p><a href="https://sentry.io/" target="_blank" rel="nofollow noopener noreferrer">Sentryåœ°å€</a></p>
<pre><code class="hljs language-typescript copyable" lang="typescript"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> Sentry <span class="hljs-keyword">from</span> <span class="hljs-string">'@sentry/react'</span>
<span class="hljs-keyword">import</span> rootConfig <span class="hljs-keyword">from</span> <span class="hljs-string">'@root/src/shared/config'</span>

Sentry.init(&#123;
  <span class="hljs-attr">dsn</span>: rootConfig.sentry.dsn,
  <span class="hljs-attr">enabled</span>: rootConfig.openSentry
&#125;)

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> Sentry

<span class="hljs-comment">/* aap.ts */</span>
<ErrorBoundary>
  <span class="xml"><span class="hljs-tag"><<span class="hljs-name">Switch</span>></span>
    ...
  <span class="hljs-tag"></<span class="hljs-name">Switch</span>></span></span>
</ErrorBoundary>

<span class="hljs-comment">// é”™è¯¯ä¸ŠæŠ¥ï¼Œå› ä¸ºæ²¡æœ‰å¯¹åº”çš„ componentDidCatch hookæ‰€ä»¥åˆ›å»ºclassç»„ä»¶æ¥æ•è·é”™è¯¯</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ErrorBoundary</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">React</span>.<span class="hljs-title">Component</span><<span class="hljs-title">Props</span>, <span class="hljs-title">State</span>> </span>&#123;
  <span class="hljs-function"><span class="hljs-title">componentDidCatch</span>(<span class="hljs-params">error: <span class="hljs-built_in">Error</span>, errorInfo: <span class="hljs-built_in">any</span></span>)</span> &#123;
    <span class="hljs-comment">// ä½ åŒæ ·å¯ä»¥å°†é”™è¯¯æ—¥å¿—ä¸ŠæŠ¥ç»™æœåŠ¡å™¨</span>
    Sentry.captureException(error)
    <span class="hljs-built_in">this</span>.props.history.push(<span class="hljs-string">'/error'</span>)
  &#125;
  <span class="hljs-function"><span class="hljs-title">render</span>(<span class="hljs-params"></span>)</span> &#123;
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.props.children
  &#125;
&#125;

<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<p>æœåŠ¡ç«¯åŒç†ï¼Œé€šè¿‡<code>Sentry.captureException</code>æ¥æäº¤é”™è¯¯ï¼Œå£°æ˜å¯¹åº”çš„ä¸­é—´ä»¶è¿›è¡Œé”™è¯¯æ‹¦æˆªç„¶åæäº¤é”™è¯¯å°±è¡Œ</p>
<h3 data-id="heading-34">4. å‰ç«¯éƒ¨åˆ†åŠŸèƒ½ç‚¹</h3>
<p>ç®€å•ä»‹ç»ä¸‹å…¶ä½™çš„åŠŸèƒ½ç‚¹ï¼Œæœ‰äº›å°±ä¸è¿›è¡Œè®²è§£äº†ï¼ŒåŸºæœ¬éƒ½æ¯”è¾ƒç®€å•ï¼Œç›´æ¥çœ‹<a href="https://github.com/cd-dongzi/BlogSource" target="_blank" rel="nofollow noopener noreferrer">åšå®¢æºç </a>å°±è¡Œ</p>
<h4 data-id="heading-35">1. ReactDom.createPortal</h4>
<p>é€šè¿‡ <code>ReactDom.createPortal</code> æ¥åšå…¨å±€å¼¹çª—ï¼Œæç¤ºä¹‹ç±»ï¼Œ<code>ReactDom.createPortal</code>å¯ä»¥æ¸²æŸ“åœ¨çˆ¶èŠ‚ç‚¹ä»¥å¤–çš„<code>dom</code>ä¸Š,æ‰€ä»¥å¯ä»¥ç›´æ¥æŠŠå¼¹çª—ä»€ä¹ˆçš„æŒ‚è½½åˆ°<code>body</code>ä¸Šã€‚
å¯ä»¥å°è£…æˆç»„ä»¶</p>
<pre><code class="hljs language-typescript copyable" lang="typescript"><span class="hljs-keyword">import</span> &#123; useRef &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>
<span class="hljs-keyword">import</span> ReactDom <span class="hljs-keyword">from</span> <span class="hljs-string">'react-dom'</span>
<span class="hljs-keyword">import</span> &#123; canUseDom &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">'@/utils/app'</span>

<span class="hljs-keyword">type</span> Props = &#123;
  <span class="hljs-attr">children</span>: <span class="hljs-built_in">any</span>
  container?: <span class="hljs-built_in">any</span>
&#125;
<span class="hljs-keyword">interface</span> Portal &#123;
  (props: Props): JSX.Element | <span class="hljs-literal">null</span>
&#125;

<span class="hljs-keyword">const</span> Portal: Portal = <span class="hljs-function">(<span class="hljs-params">&#123; children, container &#125;</span>) =></span> &#123;
  <span class="hljs-keyword">const</span> containerRef = useRef<HTMLElement>()
  <span class="hljs-keyword">if</span> (canUseDom()) &#123;
    <span class="hljs-keyword">if</span> (!container) &#123;
      containerRef.current = <span class="hljs-built_in">document</span>.body
    &#125; <span class="hljs-keyword">else</span> &#123;
      containerRef.current = container
    &#125;
  &#125;
  <span class="hljs-keyword">return</span> containerRef.current ? ReactDom.createPortal(children, containerRef.current) : <span class="hljs-literal">null</span>
&#125;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> Portal
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<h4 data-id="heading-36">2. å¸¸ç”¨hookçš„å°è£…</h4>
<ol>
<li><a href="https://github.com/cd-dongzi/BlogSource/blob/master/src/client/hooks/useResize.ts" target="_blank" rel="nofollow noopener noreferrer">useResize</a>, å±å¹•å®½åº¦å˜åŒ–</li>
<li><a href="https://github.com/cd-dongzi/BlogSource/blob/master/src/client/hooks/useQuery.ts" target="_blank" rel="nofollow noopener noreferrer">useQuery</a>, queryå‚æ•°è·å–</li>
</ol>
<p>...ç­‰ç­‰ä¸€äº›å¸¸ç”¨çš„hook,å°±ä¸åšå¤ªå¤šä»‹ç»äº†ã€‚ç¨å¾®è®²è§£ä¸€ä¸‹é®ç½©å±‚æ»šåŠ¨çš„hook</p>
<p><strong>useDisabledScrollByMaskä½œç”¨ï¼šåœ¨æœ‰é®ç½©å±‚çš„æ—¶å€™æ§åˆ¶æ»šåŠ¨</strong></p>
<ul>
<li>é®ç½©å±‚åº•ä¸‹éœ€ä¸éœ€è¦ç¦æ­¢æ»šåŠ¨ã€‚</li>
<li>é®ç½©å±‚éœ€ä¸éœ€è¦ç¦æ­¢æ»šåŠ¨ã€‚</li>
<li>é®ç½©å±‚ç¦æ­¢æ»šåŠ¨äº†ï¼Œé‡Œé¢å†…å®¹å‡å¦‚æœ‰æ»šåŠ¨ï¼Œå¦‚ä½•è®©å…¶å¯ä»¥æ»šåŠ¨ã€‚ä¸ä¼šå› ä¸ºè§¦åº•æˆ–è§¦é¡¶å¯¼è‡´è§¦å‘é®ç½©å±‚åº•éƒ¨çš„æ»šåŠ¨ã€‚</li>
</ul>
<p>ä»£ç å®ç°</p>
<pre><code class="hljs language-typescript copyable" lang="typescript"><span class="hljs-keyword">import</span> &#123; useEffect &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> Options = &#123;
  <span class="hljs-attr">show</span>: <span class="hljs-built_in">boolean</span> <span class="hljs-comment">// å¼€å¯é®ç½©å±‚</span>
  disabledScroll?: <span class="hljs-built_in">boolean</span> <span class="hljs-comment">// ç¦æ­¢æ»šåŠ¨ï¼Œ é»˜è®¤: true</span>
  maskEl?: HTMLElement | <span class="hljs-literal">null</span> <span class="hljs-comment">// é®ç½©å±‚dom</span>
  contentEl?: HTMLElement | <span class="hljs-literal">null</span> <span class="hljs-comment">// æ»šåŠ¨å†…å®¹dom</span>
&#125;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> useDisabledScrollByMask = <span class="hljs-function">(<span class="hljs-params">&#123; show, disabledScroll = <span class="hljs-literal">true</span>, maskEl, contentEl &#125;: Options = &#123;&#125; <span class="hljs-keyword">as</span> Options</span>) =></span> &#123;
  <span class="hljs-comment">// document.body æ»šåŠ¨ç¦æ­¢ï¼Œç»™bodyæ·»åŠ overflow: hidden;æ ·å¼ï¼Œç¦æ­¢æ»šåŠ¨</span>
  useEffect(<span class="hljs-function">() =></span> &#123;
    <span class="hljs-comment">/* 
      .disabled-scroll &#123;
        overflow: hidden;
      &#125;
    */</span>
    <span class="hljs-keyword">if</span> (disabledScroll) &#123;
      <span class="hljs-keyword">if</span> (show) &#123;
        <span class="hljs-built_in">document</span>.body.classList.add(<span class="hljs-string">'disabled-scroll'</span>)
      &#125; <span class="hljs-keyword">else</span> &#123;
        <span class="hljs-built_in">document</span>.body.classList.remove(<span class="hljs-string">'disabled-scroll'</span>)
      &#125;
    &#125;
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =></span> &#123;
      <span class="hljs-keyword">if</span> (disabledScroll) &#123;
        <span class="hljs-built_in">document</span>.body.classList.remove(<span class="hljs-string">'disabled-scroll'</span>)
      &#125;
    &#125;
  &#125;, [disabledScroll, show])

  <span class="hljs-comment">// é®ç½©å±‚ç¦æ­¢æ»šåŠ¨</span>
  useEffect(<span class="hljs-function">() =></span> &#123;
    <span class="hljs-keyword">if</span> (disabledScroll && maskEl) &#123;
      maskEl.addEventListener(<span class="hljs-string">'touchmove'</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =></span> &#123;
        e.preventDefault()
      &#125;)
    &#125;
  &#125;, [disabledScroll, maskEl])
  <span class="hljs-comment">// å†…å®¹ç¦æ­¢æ»šåŠ¨</span>
  useEffect(<span class="hljs-function">() =></span> &#123;
    <span class="hljs-keyword">if</span> (disabledScroll && contentEl) &#123;
      <span class="hljs-keyword">const</span> children = contentEl.children
      <span class="hljs-keyword">const</span> target = (children.length === <span class="hljs-number">1</span> ? children[<span class="hljs-number">0</span>] : contentEl) <span class="hljs-keyword">as</span> HTMLElement
      <span class="hljs-keyword">let</span> targetY = <span class="hljs-number">0</span>
      <span class="hljs-keyword">let</span> hasScroll = <span class="hljs-literal">false</span> <span class="hljs-comment">// æ˜¯å¦æœ‰æ»šåŠ¨çš„ç©ºé—´</span>
      target.addEventListener(<span class="hljs-string">'touchstart'</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =></span> &#123;
        targetY = e.targetTouches[<span class="hljs-number">0</span>].clientY
        <span class="hljs-keyword">const</span> scrollH = target.scrollHeight
        <span class="hljs-keyword">const</span> clientH = target.clientHeight

        <span class="hljs-comment">// ç”¨æ»šåŠ¨é«˜åº¦è·Ÿå…ƒç´ é«˜åº¦æ¥åˆ¤æ–­è¿™ä¸ªå…ƒç´ æ˜¯ä¸æ˜¯æœ‰éœ€è¦æ»šåŠ¨çš„éœ€æ±‚</span>
        hasScroll = scrollH - clientH > <span class="hljs-number">0</span>
      &#125;)
      <span class="hljs-comment">// é€šè¿‡ç›‘å¬å…ƒç´ </span>
      target.addEventListener(<span class="hljs-string">'touchmove'</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =></span> &#123;
        <span class="hljs-keyword">if</span> (!hasScroll) &#123;
          <span class="hljs-keyword">return</span> e.cancelable && e.preventDefault()
        &#125;
        <span class="hljs-keyword">const</span> newTargetY = e.targetTouches[<span class="hljs-number">0</span>].clientY
        <span class="hljs-comment">// distanceY > 0, ä¸‹æ‹‰ï¼›distanceY < 0, ä¸Šæ‹‰</span>
        <span class="hljs-keyword">const</span> distanceY = newTargetY - targetY
        <span class="hljs-keyword">const</span> scrollTop = target.scrollTop
        <span class="hljs-keyword">const</span> scrollH = target.scrollHeight
        <span class="hljs-keyword">const</span> clientH = target.clientHeight
        <span class="hljs-comment">// ä¸‹æ‹‰çš„æ—¶å€™ï¼Œ scrollTop = 0çš„æ—¶å€™ï¼Œè¯æ˜å…ƒç´ æ»šåŠ¨åˆ°é¡¶éƒ¨äº†ï¼Œæ‰€ä»¥è°ƒç”¨preventDefaultç¦æ­¢æ»šåŠ¨ï¼Œé˜²æ­¢è¿™ä¸ªæ»šåŠ¨è§¦å‘åº•éƒ¨bodyçš„æ»šåŠ¨</span>
        <span class="hljs-keyword">if</span> (distanceY > <span class="hljs-number">0</span> && scrollTop <= <span class="hljs-number">0</span>) &#123;
          <span class="hljs-comment">// ä¸‹æ‹‰åˆ°é¡¶</span>
          <span class="hljs-keyword">return</span> e.cancelable && e.preventDefault()
        &#125;
        <span class="hljs-comment">// ä¸Šæ‹‰åŒç†</span>
        <span class="hljs-keyword">if</span> (distanceY < <span class="hljs-number">0</span> && scrollTop >= scrollH - clientH) &#123;
          <span class="hljs-comment">// ä¸Šæ‹‰åˆ°åº•</span>
          <span class="hljs-keyword">return</span> e.cancelable && e.preventDefault()
        &#125;
      &#125;)
    &#125;
  &#125;, [disabledScroll, contentEl])
&#125;

<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<p><code>clientç«¯</code>è¿˜æœ‰ä¸€äº›åˆ«çš„åŠŸèƒ½ç‚¹å°±ä¸è¿›è¡Œè®²è§£äº†ï¼Œå› ä¸ºåšå®¢éœ€è¦æ­å»ºçš„æ¨¡å—ä¹Ÿä¸å¤šã€‚å¯ä»¥ç›´æ¥å»è§‚çœ‹<a href="https://github.com/cd-dongzi/BlogSource" target="_blank" rel="nofollow noopener noreferrer">åšå®¢æºç </a></p>
<h2 data-id="heading-37">6. Adminç«¯æºç è§£æ</h2>
<p>åå°ç®¡ç†ç«¯å…¶å®è·Ÿå®¢æˆ·ç«¯å·®ä¸å¤šï¼Œæˆ‘ç”¨çš„<code>antd</code>UIæ¡†æ¶è¿›è¡Œæ­å»ºçš„ï¼Œç›´æ¥ç”¨UIæ¡†æ¶å¸ƒå±€å°±è¡Œã€‚åŸºæœ¬ä¸Šæ²¡æœ‰å¤ªå¤šå¯è¯´çš„ï¼Œå› ä¸ºæ¨¡å—ä¹Ÿä¸å¤šã€‚
æœ¬æ¥è¿˜æƒ³åšç”¨æˆ·æ¨¡å—ï¼Œæ´¾å‘ä¸åŒæƒé™çš„ï¼Œå¯»æ€ä¸ªäººåšå®¢ä¹Ÿå°±æˆ‘è‡ªå·±ç”¨ï¼Œå®åœ¨ç”¨ä¸ä¸Šã€‚å¦‚æœå¤§å®¶æœ‰éœ€è¦ï¼Œæˆ‘ä¼šåœ¨åå°ç®¡ç†æ·»åŠ ä¸€ä¸ªå…³äºæƒé™åˆ†é…çš„æ¨¡å—ï¼Œæ¥å®ç°å¯¹äºèœå•ï¼ŒæŒ‰é’®çš„æƒé™æ§åˆ¶ã€‚
ä¸»è¦è¯´ä¸‹ä¸‹é¢ä¸¤ä¸ªåŠŸèƒ½ç‚¹</p>
<h3 data-id="heading-38">1.ç”¨æˆ·ç™»å½•æ‹¦æˆªçš„å®ç°</h3>
<p>é…åˆæˆ‘ä¸Šé¢æ‰€è¯´çš„<a href="https://github.com/cd-dongzi/BlogSource/blob/master/src/server/middleware/authToken/index.tsx" target="_blank" rel="nofollow noopener noreferrer">authTokenMiddleware</a>ä¸­é—´ä»¶ï¼Œå¯ä»¥å®ç°ç”¨æˆ·ç™»å½•æ‹¦æˆªï¼Œå·²ç™»å½•çš„è¯ï¼Œä¸åœ¨éœ€è¦ç™»å½•ç›´æ¥è·³è½¬é¦–é¡µï¼Œæœªç™»å½•æ‹¦æˆªè¿›å…¥ç™»å½•é¡µé¢ã€‚</p>
<p>é€šè¿‡ä¸€ä¸ªæƒé™ç»„ä»¶<a href="https://github.com/cd-dongzi/BlogSource/blob/master/src/admin/appComponents/AuthRoute/index.tsx" target="_blank" rel="nofollow noopener noreferrer">AuthRoute</a>æ¥æ§åˆ¶</p>
<pre><code class="hljs language-typescript copyable" lang="typescript"><span class="hljs-keyword">const</span> signOut = <span class="hljs-function">() =></span> &#123;
  Cookie.remove(rootConfig.adminTokenKey)
  store.dispatch(clearUserState())
  history.push(<span class="hljs-string">'/login'</span>)
&#125;
<span class="hljs-keyword">const</span> AuthRoute: AuthRoute = <span class="hljs-function">(<span class="hljs-params">&#123; Component, ...props &#125;</span>) =></span> &#123;
  <span class="hljs-keyword">const</span> location = useLocation()
  <span class="hljs-keyword">const</span> isLoginPage = location.pathname === <span class="hljs-string">'/login'</span>
  <span class="hljs-keyword">const</span> user = useSelector(<span class="hljs-function">(<span class="hljs-params">state: IStoreState</span>) =></span> state.user)
  <span class="hljs-comment">// æ²¡æœ‰ç”¨æˆ·ä¿¡æ¯ä¸”ä¸æ˜¯ç™»å½•é¡µé¢</span>
  <span class="hljs-keyword">const</span> [loading, setLoading] = useState(!user._id && !isLoginPage)
  <span class="hljs-keyword">const</span> token = Cookie.get(rootConfig.adminTokenKey)
  <span class="hljs-keyword">const</span> dispatch = useDispatch()
  useEffect(<span class="hljs-function">() =></span> &#123;
    <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">load</span>(<span class="hljs-params"></span>) </span>&#123;
      <span class="hljs-keyword">if</span> (token && !user._id) &#123;
        <span class="hljs-keyword">try</span> &#123;
          setLoading(<span class="hljs-literal">true</span>)
          <span class="hljs-comment">/* 
            é€šè¿‡tokenè·å–ä¿¡æ¯
            1. å¦‚æœtokenè¿‡æœŸï¼Œä¼šåœ¨axiosé‡Œé¢è¿›è¡Œå¤„ç†,è·³è½¬åˆ°ç™»å½•é¡µ
              if (error.response?.status === 401) &#123;
                Modal.warning(&#123;
                  title: 'é€€å‡ºç™»å½•',
                  content: 'tokenè¿‡æœŸ',
                  okText: 'é‡æ–°ç™»å½•',
                  onOk: () => &#123;
                    signOut()
                  &#125;
                &#125;)
                return
              &#125;

            2. æ­£å¸¸è¿”å›å€¼ï¼Œä¾¿ä¼šè·å–åˆ°ä¿¡æ¯ï¼Œè®¾loadingä¸ºfalseï¼Œè¿›å…¥ä¸‹è¾¹æµç¨‹æ¸²æŸ“
          */</span>
          <span class="hljs-keyword">const</span> &#123; data &#125; = <span class="hljs-keyword">await</span> api.user.getUserInfoByToken()
          dispatch(setUserState(data))
          setLoading(<span class="hljs-literal">false</span>)
        &#125; <span class="hljs-keyword">catch</span> (e) &#123;
          signOut()
        &#125;
      &#125;
    &#125;
    load()
  &#125;, [token, user._id, dispatch])
  
  <span class="hljs-comment">// æœ‰tokenæ²¡æœ‰ç”¨æˆ·ä¿¡æ¯ï¼Œè¿›å…¥loading,é€šè¿‡tokenå»è·å–ç”¨æˆ·ä¿¡æ¯</span>
  <span class="hljs-keyword">if</span> (loading && token) &#123;
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag"><<span class="hljs-name">LoadingPage</span> /></span></span>
  &#125;
  <span class="hljs-comment">// æœ‰tokençš„æ—¶å€™</span>
  <span class="hljs-keyword">if</span> (token) &#123;
    <span class="hljs-comment">// åœ¨ç™»å½•é¡µï¼Œè·³è½¬åˆ°é¦–é¡µå»</span>
    <span class="hljs-keyword">if</span> (isLoginPage) &#123;
      <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag"><<span class="hljs-name">Redirect</span> <span class="hljs-attr">exact</span> <span class="hljs-attr">to</span>=<span class="hljs-string">"/"</span> /></span></span>
    &#125;
    <span class="hljs-comment">// éç™»å½•é¡µï¼Œç›´æ¥è¿›å…¥</span>
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag"><<span class="hljs-name">Component</span> &#123;<span class="hljs-attr">...props</span>&#125; /></span></span>
  &#125; <span class="hljs-keyword">else</span> &#123;
    <span class="hljs-comment">// æ²¡æœ‰tokençš„æ—¶å€™</span>
    <span class="hljs-comment">// ä¸æ˜¯ç™»å½•é¡µï¼Œè·³è½¬ç™»å½•é¡µ</span>
    <span class="hljs-keyword">if</span> (!isLoginPage) &#123;
      <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag"><<span class="hljs-name">Redirect</span> <span class="hljs-attr">exact</span> <span class="hljs-attr">to</span>=<span class="hljs-string">"/login"</span> /></span></span>
    &#125; <span class="hljs-keyword">else</span> &#123;
      <span class="hljs-comment">// æ˜¯ç™»å½•é¡µï¼Œç›´æ¥è¿›å…¥</span>
      <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag"><<span class="hljs-name">Component</span> &#123;<span class="hljs-attr">...props</span>&#125; /></span></span>
    &#125;
  &#125;
&#125;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> AuthRoute
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<h3 data-id="heading-39">2. ä¸Šä¼ æ–‡ä»¶ä»¥åŠæ–‡ä»¶å¤¹</h3>
<p>ä¸Šä¼ æ–‡ä»¶éƒ½æ˜¯é€šè¿‡<code>FormData</code>è¿›è¡Œç»Ÿä¸€ä¸Šä¼ ï¼Œåå°é€šè¿‡<code>busboy</code>æ¨¡å—è¿›è¡Œæ¥æ”¶ï¼Œ<a href="https://github.com/cd-dongzi/BlogSource/blob/master/src/server/utils/file.ts" target="_blank" rel="nofollow noopener noreferrer">uploadFileä»£ç åœ°å€</a></p>
<pre><code class="hljs language-typescript copyable" lang="typescript"><span class="hljs-comment">// å‰ç«¯é€šè¿‡appendä¼ å…¥formData</span>
<span class="hljs-keyword">const</span> formData = <span class="hljs-keyword">new</span> FormData()
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> key <span class="hljs-keyword">in</span> value) &#123;
  <span class="hljs-keyword">const</span> val = value[key]
  <span class="hljs-comment">// ä¼ å¤šä¸ªæ–‡ä»¶çš„è¯ï¼Œå­—æ®µååé¢è¦åŠ  [], ä¾‹å¦‚ï¼š formData.append('images[]', val)</span>
  formData.append(key, val)
&#125;

<span class="hljs-comment">// åå°é€šè¿‡busboyæ¥æ¥æ”¶</span>
<span class="hljs-keyword">type</span> Options = &#123;
  oss?: <span class="hljs-built_in">boolean</span> <span class="hljs-comment">// æ˜¯å¦ä¸Šä¼ oss</span>
  rename?: <span class="hljs-built_in">boolean</span> <span class="hljs-comment">// æ˜¯å¦é‡å‘½å</span>
  fileDir?: <span class="hljs-built_in">string</span> <span class="hljs-comment">// æ–‡ä»¶å†™å…¥ç›®å½•</span>
  overlay?: <span class="hljs-built_in">boolean</span> <span class="hljs-comment">// æ–‡ä»¶æ˜¯å¦å¯è¦†ç›–</span>
&#125;
<span class="hljs-keyword">const</span> uploadFile = <T extends AnyObject>(ctx: Context, options: Options | Record<string, Options> = File.defaultOptions) => &#123;
  const busboy = new Busboy(&#123;
    headers: ctx.req.headers
  &#125;)
  console.log('start uploading...')
  return new Promise<T>((resolve, reject) => &#123;
    const formObj: AnyObject = &#123;&#125;
    const promiseFiles: Promise<any>[] = []
    busboy.on('file', async (fieldname, file, filename, encoding, mimetype) => &#123;
      console.log('File [' + fieldname + ']: filename: ' + filename)
      /* 
        åœ¨è¿™é‡Œæ¥å—æ–‡ä»¶ï¼Œ
        é€šè¿‡optionsé€‰é¡¹æ¥åˆ¤æ–­æ–‡ä»¶å†™å…¥æ–¹å¼
      */

      /* 
        è¿™é‡Œæ¯æ¬¡åªä¼šæ¥å—ä¸€ä¸ªæ–‡ä»¶ï¼Œå¦‚æœä¼ äº†å¤šå¼ å›¾ç‰‡ï¼Œè¦æˆªå–ä¸€ä¸‹å­—æ®µåœ¨è®¾ç½®å€¼ï¼Œä¸è¦è¢«è¦†ç›–ã€‚
        const index = fieldname.lastIndexOf('[]')
        // åˆ—è¡¨ä¸Šä¼ 
        formObj[fieldname.slice(0, index)] = [...(formObj[fieldname.slice(0, index)] || []), val]
      */
      const realFieldname = fieldname.endsWith('[]') ? fieldname.slice(0, -2) : fieldname
    &#125;)

    busboy.on('field', (fieldname, val, fieldnameTruncated, valTruncated, encoding, mimetype) => &#123;
      // æ™®é€šå­—æ®µ
    &#125;)
    busboy.on('finish', async () => &#123;
      try &#123;
        if (promiseFiles.length > 0) &#123;
          await Promise.all(promiseFiles)
        &#125;
        console.log('finished...')
        resolve(formObj as T)
      &#125; catch (e) &#123;
        reject(e)
      &#125;
    &#125;)
    busboy.on('error', (err: Error) => &#123;
      reject(err)
    &#125;)
    ctx.req.pipe(busboy)
  &#125;)
&#125;
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<h2 data-id="heading-40">7. HTTPSåˆ›å»º</h2>
<p>å› ä¸ºåšå®¢ä¹Ÿå…¨éƒ¨è¿ç§»åˆ°äº†<code>https</code>,è¿™é‡Œå°±è®²è§£ä¸€ä¸‹å¦‚ä½•åœ¨æœ¬åœ°ç”Ÿæˆè¯ä¹¦ï¼Œåœ¨æœ¬åœ°è¿›è¡Œ<code>https</code>å¼€å‘ã€‚
é€šè¿‡<code>openssl</code>é¢å‘è¯ä¹¦</p>
<blockquote>
<p>æ–‡ç« å‚è€ƒ<a href="https://heara.in/nodejs-localhost-https/" target="_blank" rel="nofollow noopener noreferrer">æ­å»ºNode.jsæœ¬åœ°httpsæœåŠ¡</a></p>
</blockquote>
<p>æˆ‘ä»¬åœ¨<code>src/servers/ssl</code>æ–‡ä»¶ä¸‹åˆ›å»ºæˆ‘ä»¬çš„è¯ä¹¦</p>
<ol>
<li>ç”ŸæˆCAç§é’¥ <code>openssl genrsa -out ca.key 4096</code></li>
</ol>
<p><img src="https://assets.open.dzblog.cn/images/markdown/1841.png" alt="ç”ŸæˆCAç§é’¥" loading="lazy" referrerpolicy="no-referrer"></p>
<ol start="2">
<li>ç”Ÿæˆè¯ä¹¦ç­¾åè¯·æ±‚ <code>openssl req -new -key ca.key -out ca.csr</code></li>
</ol>
<p><img src="https://assets.open.dzblog.cn/images/markdown/1842.png" alt="ç”Ÿæˆè¯ä¹¦ç­¾åè¯·æ±‚" loading="lazy" referrerpolicy="no-referrer"></p>
<ol start="3">
<li>è¯ä¹¦ç­¾åï¼Œç”Ÿæˆæ ¹è¯ä¹¦ <code>openssl x509 -req -in ca.csr -signkey ca.key -out ca.crt</code></li>
</ol>
<p><img src="https://assets.open.dzblog.cn/images/markdown/1843.png" alt="è¯ä¹¦ç­¾åï¼Œç”Ÿæˆæ ¹è¯ä¹¦" loading="lazy" referrerpolicy="no-referrer"></p>
<p>é€šè¿‡ä¸Šé¢çš„æ­¥éª¤ç”Ÿæˆçš„æ ¹è¯ä¹¦ca.crtï¼ŒåŒå‡»å¯¼å…¥è¿™ä¸ªè¯ä¹¦ï¼Œè®¾ä¸ºå§‹ç»ˆä¿¡ä»»
<img src="https://assets.open.dzblog.cn/images/markdown/1844.png" alt="å§‹ç»ˆä¿¡ä»»" loading="lazy" referrerpolicy="no-referrer"></p>
<p>ä¸Šé¢æˆ‘ä»¬å°±æŠŠè‡ªå·±å˜æˆäº†<code>CA</code>,æ¥ä¸‹ä¸ºæˆ‘ä»¬çš„<code>server</code>æœåŠ¡ç”³è¯·è¯ä¹¦</p>
<ol>
<li>åˆ›å»ºä¸¤ä¸ªé…ç½®æ–‡ä»¶</li>
</ol>
<ul>
<li>server.csr.conf</li>
</ul>
<pre><code class="hljs language-conf copyable" lang="conf"># server.csr.conf
# ç”Ÿæˆè¯ä¹¦ç­¾åè¯·æ±‚çš„é…ç½®æ–‡ä»¶
[req]
default_bits = 4096
prompt = no
distinguished_name = dn

[dn]
CN = localhost # Common Name åŸŸå
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<ul>
<li>v3.ext,è¿™é‡Œåœ¨<code>[alt_names]</code>ä¸‹é¢å¡«å…¥ä½ å½“å‰çš„ipï¼Œå› ä¸ºåœ¨ä»£ç ä¸­çš„æˆ‘ä¼šé€šè¿‡ipè®¿é—®åœ¨æœ¬åœ°æ‰‹æœºè®¿é—®ã€‚æ‰€ä»¥æˆ‘æ‰“åŒ…çš„æ—¶å€™æ˜¯é€šè¿‡ipè®¿é—®çš„ä¸€äº›æ–‡ä»¶ã€‚</li>
</ul>
<pre><code class="hljs language-conf copyable" lang="conf">authorityKeyIdentifier=keyid,issuer
basicConstraints=CA:FALSE
keyUsage = digitalSignature, nonRepudiation, keyEncipherment, dataEncipherment
subjectAltName = @alt_names

[alt_names]
DNS.1 = localhost
DNS.2 = 127.0.0.1
IP.1 = 192.168.0.47
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<ol start="2">
<li>ç”³è¯·è¯ä¹¦</li>
</ol>
<ul>
<li>ç”ŸæˆæœåŠ¡å™¨çš„ç§é’¥ <code>openssl genrsa -out server.key 4096</code></li>
</ul>
<p><img src="https://assets.open.dzblog.cn/images/markdown/1845.png" alt="ç”ŸæˆæœåŠ¡å™¨çš„ç§é’¥" loading="lazy" referrerpolicy="no-referrer"></p>
<ul>
<li>ç”Ÿæˆè¯ä¹¦ç­¾åè¯·æ±‚ <code>openssl req -new -out server.csr -key server.key -config <( cat server.csr.conf )</code></li>
</ul>
<p><img src="https://assets.open.dzblog.cn/images/markdown/1846.png" alt="ç”Ÿæˆè¯ä¹¦ç­¾åè¯·æ±‚" loading="lazy" referrerpolicy="no-referrer"></p>
<ul>
<li>CAå¯¹csrç­¾å <code>openssl x509 -req -in server.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out server.crt  -sha256 -days 365 -extfile v3.ext</code></li>
</ul>
<p><img src="https://assets.open.dzblog.cn/images/markdown/1847.png" alt="CAå¯¹csrç­¾å" loading="lazy" referrerpolicy="no-referrer"></p>
<p>ç”Ÿæˆçš„æ‰€æœ‰æ–‡ä»¶</p>
<p><img src="https://assets.open.dzblog.cn/images/markdown/1848.png" alt="ç”Ÿæˆçš„æ‰€æœ‰æ–‡ä»¶" loading="lazy" referrerpolicy="no-referrer"></p>
<p>åœ¨nodeæœåŠ¡å¼•å…¥è¯ä¹¦</p>
<pre><code class="hljs language-typescript copyable" lang="typescript"><span class="hljs-keyword">const</span> serverConfig.httpsOptions = &#123;
  <span class="hljs-attr">key</span>: fs.readFileSync(path.resolve(paths.serverPath, <span class="hljs-string">`ssl/server.key`</span>)),
  <span class="hljs-attr">cert</span>: fs.readFileSync(path.resolve(paths.serverPath, <span class="hljs-string">`ssl/server.crt`</span>))
&#125;

https.createServer(serverConfig.httpsOptions, app.callback()).listen(rootConfig.app.server.httpsPort, <span class="hljs-string">'0.0.0.0'</span>, <span class="hljs-function">() =></span> &#123;
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'é¡¹ç›®å¯åŠ¨å•¦~~~~~'</span>)
&#125;)
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<p>è‡³æ­¤ï¼Œæœ¬åœ°çš„httpsè¯ä¹¦æ­å»ºå®Œæˆï¼Œä½ å°±å¯ä»¥å¿«ä¹çš„åœ¨æœ¬åœ°å¼€å¯<code>https</code>ä¹‹æ—…äº†</p>
<h2 data-id="heading-41">ç»“è¯­</h2>
<p>æ•´ä¸ªåšå®¢æµç¨‹å¤§æ¦‚å°±æ˜¯è¿™äº›äº†ï¼Œè¿˜æœ‰ä¸€äº›æ²¡æœ‰åšå¤ªå¤šè®²è§£ï¼Œä¸»è¦æ˜¯æ˜é‡‘å­—æ•°è¶…å‡ºäº†ğŸ˜­ğŸ˜­ï¼Œåªæ˜¯è´´äº†ä¸ªå¤§æ¦‚çš„ä»£ç ã€‚æ‰€ä»¥æƒ³çœ‹å…·ä½“çš„è¯ï¼Œç›´æ¥å»çœ‹æºç å°±è¡Œã€‚</p>
<p>è¿™ç¯‡æ–‡ç« è®²çš„ä¸»è¦æ˜¯æœ¬åœ°è¿›è¡Œé¡¹ç›®çš„å¼€å‘ï¼Œåç»­è¿˜æœ‰å¦‚ä½•æŠŠæœ¬åœ°æœåŠ¡æ”¾åˆ°çº¿ä¸Šã€‚å› ä¸ºå‘è¡¨åšå®¢æœ‰æ–‡å­—é•¿åº¦é™åˆ¶ï¼Œè¿™ç¯‡æ–‡ç« æˆ‘å°±æ²¡æœ‰ä»‹ç»å¦‚ä½•æŠŠå¼€å‘ç¯å¢ƒçš„é¡¹ç›®å‘å¸ƒåˆ°ç”Ÿæˆç¯å¢ƒä¸Šã€‚åç»­æˆ‘ä¼šå‘è¡¨ä¸€ç¯‡å¦‚ä½•åœ¨é˜¿é‡Œäº‘ä¸Šæ­å»ºä¸€ä¸ªæœåŠ¡ï¼Œhttpså…è´¹è¯ä¹¦ä»¥åŠè§£æåŸŸåè¿›è¡Œnginxé…ç½®æ¥å»ºç«‹ä¸åŒçš„æœåŠ¡ã€‚</p>
<p>åšå®¢å…¶å®è¿˜æœ‰ä¸å°‘æœ‰ç¼ºé™·çš„ã€‚è¿˜æœ‰ä¸€äº›æˆ‘æƒ³å¥½è¦å¼„è¿˜æ²¡å¼„ä¸Šå»çš„ä¸œè¥¿ã€‚</p>
<ul>
<li>åå°ç®¡ç†å•ç‹¬æ‹†åˆ†å‡ºæ¥ã€‚</li>
<li>æœåŠ¡ç«¯apiæ¨¡å—å•ç‹¬æ‹†åˆ†å‡ºæ¥ï¼Œå»ºç«‹ä¸€ä¸ªç®¡ç†apiç›¸å…³çš„æœåŠ¡ã€‚</li>
<li>å…±ç”¨çš„å·¥å…·ç±»ï¼ŒåŒ…æ‹¬å®¢æˆ·ç«¯è·Ÿç®¡ç†åå°æœ‰ä¸å°‘å…±ç”¨çš„ç»„ä»¶å’Œhooksï¼Œç»Ÿä¸€æ”¾åˆ°ç§æœä¸Šï¼Œæ¯•ç«Ÿåˆ°æ—¶å€™è¿™å‡ ä¸ªç«¯éƒ½è¦æ‹†åˆ†çš„ã€‚</li>
<li>ç”¨Dockeræ¥æ­å»ºéƒ¨ç½²ï¼Œå› ä¸ºæ–°äººä¹°æœåŠ¡å™¨ä¾¿å®œä¹ˆï¼Œæˆ‘ä¹°äº†å‡ æ¬¡ï¼Œç„¶ååˆ°æœŸå°±å¾—è¿ç§»ï¼Œæ¯æ¬¡éƒ½æ˜¯å„ç§ç¯å¢ƒé…ç½®ï¼Œå¯éº»çƒ¦ï¼Œåé¢å¬è¯´æœ‰dockerå¯ä»¥è§£å†³è¿™å†™é—®é¢˜ï¼Œæˆ‘å°±ç®€å•çš„ç ”ç©¶è¿‡ä¸€ä¸‹ï¼Œæ‰€ä»¥è¿™æ¬¡ä¹Ÿæ‰“ç®—ä½¿ç”¨docker,ä¸»è¦æ˜¯æœåŠ¡å™¨ä¹Ÿå¿«åˆ°æœŸäº†ï¼Œç»­è´¹ä¹Ÿä¸ä¾¿å®œğŸ˜­ğŸ˜­ã€‚ä»¥å‰åŒåä¸€ç›´æ¥ä¹°çš„ï¼Œç°åœ¨ç»­è´¹ï¼Œè¿˜æŒºè´µã€‚æˆ‘éƒ½å¯»æ€æ˜¯ä¸æ˜¯æ¢ä¸ªæœåŠ¡å™¨ã€‚æ‰€ä»¥æ¢ä¸Šdockerçš„è¯ï¼Œåº”è¯¥èƒ½çœç‚¹äº‹</li>
<li>CI/CDæŒç»­é›†æˆï¼Œæˆ‘ç°åœ¨å¼€å‘éƒ½æ˜¯ä¸Šä¼ git,ç„¶åè¿›å…¥æœåŠ¡å™¨ï¼Œpullä¸‹æ¥å†æ‰“åŒ…ï¼Œä¹Ÿå¯éº»çƒ¦ğŸ˜‚ğŸ˜‚ï¼Œæ‰€ä»¥è¿™ä¸ªä¹Ÿæ˜¯æ‰“ç®—é›†æˆä¸Šå»çš„ã€‚</li>
</ul>
<blockquote>
<p><a href="https://github.com/cd-dongzi/BlogSource" target="_blank" rel="nofollow noopener noreferrer">Githubå®Œæ•´ä»£ç åœ°å€</a></p>
</blockquote>
<blockquote>
<p><a href="https://dzblog.cn/" target="_blank" rel="nofollow noopener noreferrer">åšå®¢åœ¨çº¿åœ°å€</a></p>
</blockquote>
<blockquote>
<p>ä½œä¸ºä¸€ä¸ªéç§‘ç­çš„é‡è·¯å­è¿‡æ¥äººï¼ŒåŸºæœ¬éƒ½æ˜¯è‡ªå·±æ‘¸ç´¢è¿‡æ²³çš„ã€‚å¯¹äºå¾ˆå¤šä¸œè¥¿ä¹Ÿæ˜¯ä¸€çŸ¥åŠè§£ï¼Œä½†æ˜¯æˆ‘å°½é‡ä¼šåœ¨è‡ªå·±äº†è§£çš„èŒƒå›´è¿›è¡Œè®²è§£ï¼Œå¯èƒ½ä¼šå‡ºç°æŠ€æœ¯ä¸Šçš„ä¸€äº›é—®é¢˜ç†è§£ä¸æ­£ç¡®ã€‚è¿˜æœ‰åšå®¢åŠŸèƒ½åŸºæœ¬æ˜¯è‡ªå·±æ­çš„ï¼Œå¾ˆå¤šä¸œè¥¿ä¸ä¸€å®šå…¨é¢ï¼ŒåŒ…æ‹¬ä¹Ÿæ²¡åšå¤ªå¤šçš„æµ‹è¯•ï¼Œéš¾å…ä¼šæœ‰å¾ˆå¤šä¸è¶³ä¹‹å¤„ï¼Œå¦‚æœ‰é”™è¯¯ä¹‹å¤„ï¼Œå¸Œæœ›å¤§å®¶æŒ‡å‡ºï¼Œæˆ‘ä¼šå°½é‡å®Œå–„è¿™äº›ç¼ºé™·ï¼Œè°¢è°¢ã€‚</p>
</blockquote>
<blockquote>
<p>æˆ‘è‡ªå·±æ–°åˆ›å»ºäº†ä¸€ä¸ªç›¸äº’å­¦ä¹ çš„ç¾¤ï¼Œå¤§å®¶å¦‚æœæœ‰ä¸æ‡‚çš„ï¼Œæˆ‘èƒ½çŸ¥é“çš„ï¼Œæˆ‘ä¼šå°½é‡è§£ç­”ã€‚å¦‚æœæˆ‘æœ‰ä¸æ‡‚çš„åœ°æ–¹ï¼Œä¹Ÿå¸Œæœ›å¤§å®¶æŒ‡æ•™ã€‚</p>
</blockquote>
<blockquote>
<p><a href="https://jq.qq.com/?_wv=1027&k=yy8ZWGDQ" target="_blank" rel="nofollow noopener noreferrer">QQç¾¤ï¼š810018802, ç‚¹å‡»åŠ å…¥</a></p>
</blockquote>
<p><img src="https://assets.open.dzblog.cn/images/other/qq-group.png" alt="QQç¾¤ï¼š810018802" loading="lazy" referrerpolicy="no-referrer"></p></div>  
</div>
            