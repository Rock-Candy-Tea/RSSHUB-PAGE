
---
title: '机顶盒环境下h5焦点控制组件的实现'
categories: 
 - 编程
 - 掘金
 - 分类
headimg: 'https://picsum.photos/400/300?random=1395'
author: 掘金
comments: false
date: Fri, 30 Apr 2021 23:14:34 GMT
thumbnail: 'https://picsum.photos/400/300?random=1395'
---

<div>   
<div class="markdown-body"><style>.markdown-body&#123;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333&#125;.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6&#123;line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px&#125;.markdown-body h1&#123;font-size:30px;margin-bottom:5px&#125;.markdown-body h2&#123;padding-bottom:12px;font-size:24px;border-bottom:1px solid #ececec&#125;.markdown-body h3&#123;font-size:18px;padding-bottom:0&#125;.markdown-body h4&#123;font-size:16px&#125;.markdown-body h5&#123;font-size:15px&#125;.markdown-body h6&#123;margin-top:5px&#125;.markdown-body p&#123;line-height:inherit;margin-top:22px;margin-bottom:22px&#125;.markdown-body img&#123;max-width:100%&#125;.markdown-body hr&#123;border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px&#125;.markdown-body code&#123;word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em&#125;.markdown-body code,.markdown-body pre&#123;font-family:Menlo,Monaco,Consolas,Courier New,monospace&#125;.markdown-body pre&#123;overflow:auto;position:relative;line-height:1.75&#125;.markdown-body pre>code&#123;font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8&#125;.markdown-body a&#123;text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff&#125;.markdown-body a:active,.markdown-body a:hover&#123;color:#275b8c&#125;.markdown-body table&#123;display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6&#125;.markdown-body thead&#123;background:#f6f6f6;color:#000;text-align:left&#125;.markdown-body tr:nth-child(2n)&#123;background-color:#fcfcfc&#125;.markdown-body td,.markdown-body th&#123;padding:12px 7px;line-height:24px&#125;.markdown-body td&#123;min-width:120px&#125;.markdown-body blockquote&#123;color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8&#125;.markdown-body blockquote:after&#123;display:block;content:""&#125;.markdown-body blockquote>p&#123;margin:10px 0&#125;.markdown-body ol,.markdown-body ul&#123;padding-left:28px&#125;.markdown-body ol li,.markdown-body ul li&#123;margin-bottom:0;list-style:inherit&#125;.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item&#123;list-style:none&#125;.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul&#123;margin-top:0&#125;.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul&#123;margin-top:3px&#125;.markdown-body ol li&#123;padding-left:6px&#125;.markdown-body .contains-task-list&#123;padding-left:0&#125;.markdown-body .task-list-item&#123;list-style:none&#125;@media (max-width:720px)&#123;.markdown-body h1&#123;font-size:24px&#125;.markdown-body h2&#123;font-size:20px&#125;.markdown-body h3&#123;font-size:18px&#125;&#125;</style><h1 data-id="heading-0">前言</h1>
<p>因为工作需要，最近在做广电机顶盒app的开发工作。因此对焦点控制进行了组件化。</p>
<p>为了提高开发速度，我们使用了app套壳，内部引用h5页面的开发方式。</p>
<h1 data-id="heading-1">摘要</h1>
<p>开发环境：机顶盒，安卓系统</p>
<p>前端框架：vue-cli3、vue2、vuex、vue-router</p>
<h1 data-id="heading-2">正文</h1>
<h2 data-id="heading-3">一、环境</h2>
<h3 data-id="heading-4">1、机顶盒环境下的焦点获取：</h3>
<p>遥控器可以通过上下左右，自动获取到有焦点的dom元素。默认可以获得焦点的dom元素，都可以被遥控器选中，同时，没有焦点的元素，可以通过设置tabindex属性来实现焦点的获取。</p>
<h3 data-id="heading-5">2、app和安卓环境介绍</h3>
<p>因为安全考虑，这里就不提及机顶盒的安卓版本了，只能说它的版本比较低。我们在使用app套壳后，可以支持部分es6语法。这里再提下浏览器的差异，和pc上的chrome浏览器的样式是有差异的，开发完成后，一定要在机顶盒上实机运行下看看效果。</p>
<h3 data-id="heading-6">3、为什么需要焦点控制</h3>
<p>通过路由跳转页面是不会有焦点控制问题的，因为只有可见域的焦点，才能被遥控器选择到。但是，我们的项目需要弹窗功能，这时，就需要对父页面的焦点进行控制了，因为蒙层是阻止不了焦点的获取的。</p>
<h2 data-id="heading-7">二、实现</h2>
<p>我的设计思路是通过vuex的响应式编程功能，实现全局的焦点控制。具体实现方式是将所有需要获取焦点的元素封装成组件，在组建中通过computed属性来监听vuex中全局焦点的变化，从而实现焦点的管理。</p>
<h3 data-id="heading-8">1、vuex中的实现</h3>
<p>首先新建一个tabindex.js文件，文件中声明焦点控制相关的属性：enable、enablePage、markEnable</p>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-keyword">const</span> tabindex = &#123;
    <span class="hljs-attr">namespaced</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">state</span>: &#123;
        <span class="hljs-attr">enable</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 全局焦点开关</span>
        <span class="hljs-attr">enablePage</span>: [], <span class="hljs-comment">// 可获取焦点页面的pageName</span>
        <span class="hljs-attr">markEnable</span>: <span class="hljs-literal">true</span> <span class="hljs-comment">// 蒙层：弹出蒙层时，不能获取焦点。</span>
    &#125;,
    <span class="hljs-attr">mutations</span>: &#123;
        <span class="hljs-attr">SET_ENABLE</span>: <span class="hljs-function">(<span class="hljs-params">state, enable</span>) =></span> &#123;
            state.enable = enable;
            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"SET_ENABLE"</span>, state.enable);
        &#125;,
        <span class="hljs-attr">SET_MARK_ENABLE</span>: <span class="hljs-function">(<span class="hljs-params">state, enable</span>) =></span> &#123;
            state.markEnable = enable;
            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"SET_MARK_ENABLE"</span>, state.markEnable);
        &#125;,
        <span class="hljs-attr">PUSH_TABINDEX</span>: <span class="hljs-function">(<span class="hljs-params">state, enablePage</span>) =></span> &#123;
            <span class="hljs-keyword">if</span> (!state.enablePage.includes(enablePage)) &#123;
                state.enablePage.push(enablePage);
            &#125;
            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"PUSH_TABINDEX"</span>, state.enablePage);
        &#125;,
        <span class="hljs-attr">REMOVE_TABINDEX</span>: <span class="hljs-function">(<span class="hljs-params">state, enablePage</span>) =></span> &#123;
            <span class="hljs-keyword">let</span> index = state.enablePage.indexOf(enablePage); 
            <span class="hljs-keyword">if</span> (index > -<span class="hljs-number">1</span>) &#123; 
                state.enablePage.splice(index, <span class="hljs-number">1</span>);
            &#125;
            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"REMOVE_TABINDEX"</span>, state.enablePage);
        &#125;
    &#125;,
    <span class="hljs-attr">actions</span>: &#123;
        <span class="hljs-function"><span class="hljs-title">disabled</span>(<span class="hljs-params">&#123;commit&#125;, enablePage</span>)</span>&#123;
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =></span> &#123;
                commit(<span class="hljs-string">'SET_ENABLE'</span>, <span class="hljs-literal">false</span>);
                commit(<span class="hljs-string">'PUSH_TABINDEX'</span>, enablePage);
                resolve();
            &#125;);
        &#125;,
        <span class="hljs-function"><span class="hljs-title">enable</span>(<span class="hljs-params">&#123;commit&#125;, enablePage</span>)</span>&#123;
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =></span> &#123;
                commit(<span class="hljs-string">'SET_ENABLE'</span>, <span class="hljs-literal">true</span>);
                commit(<span class="hljs-string">'REMOVE_TABINDEX'</span>, enablePage);
                resolve();
            &#125;);
        &#125;,
        <span class="hljs-function"><span class="hljs-title">markDisabled</span>(<span class="hljs-params">&#123;commit&#125;</span>)</span>&#123;
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =></span> &#123;
                commit(<span class="hljs-string">'SET_MARK_ENABLE'</span>, <span class="hljs-literal">false</span>);
                resolve();
            &#125;);
        &#125;,
        <span class="hljs-function"><span class="hljs-title">markEnable</span>(<span class="hljs-params">&#123;commit&#125;</span>)</span>&#123;
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =></span> &#123;
                commit(<span class="hljs-string">'SET_MARK_ENABLE'</span>, <span class="hljs-literal">true</span>);
                resolve();
            &#125;);
        &#125;,
    &#125;
&#125;;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> tabindex;
<span class="copy-code-btn">复制代码</span></code></pre>
<ol>
<li>enable： 用来控制全局焦点是否可用</li>
<li>enablePage： 用来记录在全局焦点不可用的情况下，可以例外的页面的pageName属性的名称</li>
<li>markEnable：蒙层出现时，所有焦点都不可用，比如loading时</li>
</ol>
<p><strong>注：pageName属性是个自定义的props属性，可以在弹窗组件中赋值，也可以通过Math.random()方法随机生成，会在弹窗组建中提及。</strong></p>
<h3 data-id="heading-9">2、组件中的实现</h3>
<p>只要在组件中监听vuex相关属性的变化，来控制组件的tabindex属性，就能实现焦点的统一管理了</p>
<pre><code class="hljs language-js copyable" lang="js"><template>
    <span class="xml"><span class="hljs-tag"><<span class="hljs-name">div</span> <span class="hljs-attr">:class</span>=<span class="hljs-string">"getClass()"</span> <span class="hljs-attr">:tabindex</span>=<span class="hljs-string">"computedTabindex"</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"main"</span> <span class="hljs-attr">v-on</span>=<span class="hljs-string">"$listeners"</span> ></span>
        <span class="hljs-tag"><<span class="hljs-name">slot</span>></span><span class="hljs-tag"></<span class="hljs-name">slot</span>></span>
    <span class="hljs-tag"></<span class="hljs-name">div</span>></span></span>
</template>
<span class="xml"><span class="hljs-tag"><<span class="hljs-name">script</span>></span><span class="javascript">
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> &#123;
    <span class="hljs-attr">name</span>: <span class="hljs-string">"box-tabindex-box"</span>,
    <span class="hljs-attr">props</span>: &#123;
        <span class="hljs-attr">tabindex</span>: &#123;
            <span class="hljs-attr">type</span>: <span class="hljs-built_in">Number</span>,
            <span class="hljs-attr">default</span>: <span class="hljs-number">1</span>
        &#125;,
        <span class="hljs-attr">focusFlag</span>: &#123;
            <span class="hljs-attr">type</span>: <span class="hljs-built_in">Boolean</span>,
            <span class="hljs-attr">default</span>: <span class="hljs-literal">false</span>
        &#125;,
        <span class="hljs-attr">useFocusClass</span>: &#123;
            <span class="hljs-attr">type</span>: <span class="hljs-built_in">Boolean</span>,
            <span class="hljs-attr">default</span>: <span class="hljs-literal">true</span>
        &#125;
    &#125;,
    <span class="hljs-attr">inject</span>: &#123;
        <span class="hljs-attr">pageName</span>: &#123;
            <span class="hljs-attr">default</span>: <span class="hljs-string">""</span>
        &#125;
    &#125;,
    <span class="hljs-attr">computed</span>: &#123;
        <span class="hljs-attr">computedTabindex</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>&#123;
            <span class="hljs-keyword">let</span> tabindex = <span class="hljs-built_in">this</span>.$store.state.tabindex;
            <span class="hljs-keyword">if</span> (tabindex.markEnable === <span class="hljs-literal">false</span>) &#123;
                <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;
            &#125;
            <span class="hljs-keyword">if</span> (tabindex.enable === <span class="hljs-literal">false</span>) &#123;
                <span class="hljs-keyword">if</span> (tabindex.enablePage[tabindex.enablePage.length - <span class="hljs-number">1</span>] == (<span class="hljs-built_in">this</span>.pageName)) &#123;
                    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.tabindex;
                &#125;
                <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;
            &#125;
            <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.tabindex;
        &#125;
    &#125;,
    <span class="hljs-function"><span class="hljs-title">mounted</span>(<span class="hljs-params"></span>)</span>&#123;
        <span class="hljs-keyword">let</span> that = <span class="hljs-built_in">this</span>;
        <span class="hljs-built_in">this</span>.$nextTick(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>&#123;
            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.focusFlag) &#123;
                that.$refs.main.focus();
            &#125;
        &#125;);
    &#125;,
    <span class="hljs-attr">methods</span>: &#123;
        <span class="hljs-function"><span class="hljs-title">getClass</span>(<span class="hljs-params"></span>)</span>&#123;
            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.useFocusClass) &#123;

                <span class="hljs-keyword">return</span> <span class="hljs-string">"u-tab-box"</span>;
            &#125; <span class="hljs-keyword">else</span> &#123;

                <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>;
            &#125;
        &#125;
    &#125;
&#125;
</span><span class="hljs-tag"></<span class="hljs-name">script</span>></span></span>
<span class="xml"><span class="hljs-tag"><<span class="hljs-name">style</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"scss"</span> ></span><span class="css">
    <span class="hljs-selector-class">.u-tab-box</span>&#123;

    &#125;
    <span class="hljs-selector-class">.u-tab-box</span><span class="hljs-selector-pseudo">:focus</span>&#123;
        <span class="hljs-attribute">background-color</span>: <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0.4</span>);
        <span class="hljs-attribute">box-sizing</span>: border-box;
    &#125;
</span><span class="hljs-tag"></<span class="hljs-name">style</span>></span></span>
<span class="copy-code-btn">复制代码</span></code></pre>
<p>vue中通过computed计算属性来实现vuex变化的监听，可能还有其他方法，知道的大佬还请多指教。</p>
<p>input这种输入框也可以通过以上方式来实现焦点控制，这里就不再赘述了。</p>
<h3 data-id="heading-10">3、弹窗组件</h3>
<p>弹窗组件需要增加一个pageName属性，来标识该弹窗页面。同时，通过provide和组件的inject进行匹配传参，让组件知道自己在哪个页面中。</p>
<pre><code class="hljs language-js copyable" lang="js"><template>
    <span class="xml"><span class="hljs-tag"><<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"g-mark"</span> <span class="hljs-attr">v-show</span>=<span class="hljs-string">"params.openFlag === true"</span> ></span>
        <span class="hljs-tag"><<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"g-win menu-background bg-image"</span> <span class="hljs-attr">:class</span>=<span class="hljs-string">"winClass"</span> ></span>
            <span class="hljs-tag"><<span class="hljs-name">slot</span>></span><span class="hljs-tag"></<span class="hljs-name">slot</span>></span>
        <span class="hljs-tag"></<span class="hljs-name">div</span>></span>
    <span class="hljs-tag"></<span class="hljs-name">div</span>></span></span>
</template>
<span class="xml"><span class="hljs-tag"><<span class="hljs-name">script</span>></span><span class="javascript">

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> &#123;
    <span class="hljs-attr">name</span>: <span class="hljs-string">"open-win"</span>,
    <span class="hljs-attr">props</span>: &#123;
        <span class="hljs-attr">pageName</span>: &#123;
            <span class="hljs-attr">type</span>: <span class="hljs-built_in">String</span>,
            <span class="hljs-attr">default</span>: <span class="hljs-string">"win: "</span> + <span class="hljs-built_in">Math</span>.random()
        &#125;,
        <span class="hljs-attr">winClass</span>: &#123;
            <span class="hljs-attr">type</span>: <span class="hljs-built_in">String</span>,
            <span class="hljs-attr">default</span>: <span class="hljs-string">""</span>
        &#125;
    &#125;,
    <span class="hljs-function"><span class="hljs-title">data</span>(<span class="hljs-params"></span>)</span>&#123;
        <span class="hljs-keyword">return</span> &#123;
            <span class="hljs-attr">params</span>: &#123;
                <span class="hljs-attr">openFlag</span>: <span class="hljs-literal">false</span>
            &#125;
        &#125;
    &#125;,
    <span class="hljs-function"><span class="hljs-title">provide</span>(<span class="hljs-params"></span>)</span> &#123;
        <span class="hljs-keyword">return</span> &#123;
            <span class="hljs-attr">pageParams</span>: <span class="hljs-built_in">this</span>.params,
            <span class="hljs-attr">pageName</span>: <span class="hljs-built_in">this</span>.pageName
        &#125;;
    &#125;,
    <span class="hljs-attr">watch</span>: &#123;
        <span class="hljs-string">"params.openFlag"</span>(newVal)&#123;
            <span class="hljs-keyword">if</span> (newVal === <span class="hljs-literal">true</span>) &#123;
                <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"tabindex/disabled"</span>, <span class="hljs-built_in">this</span>.pageName);
                <span class="hljs-built_in">this</span>.$store.dispatch(<span class="hljs-string">"tabindex/disabled"</span>, <span class="hljs-built_in">this</span>.pageName);

            &#125; <span class="hljs-keyword">else</span> &#123;
                <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"tabindex/enable"</span>, <span class="hljs-built_in">this</span>.pageName);
                <span class="hljs-built_in">this</span>.$store.dispatch(<span class="hljs-string">"tabindex/enable"</span>, <span class="hljs-built_in">this</span>.pageName);
            &#125;
        &#125;
    &#125;,
    <span class="hljs-attr">methods</span>: &#123;
        <span class="hljs-function"><span class="hljs-title">open</span>(<span class="hljs-params"></span>)</span>&#123;
            <span class="hljs-built_in">this</span>.params.openFlag = <span class="hljs-literal">true</span>;
        &#125;,
        <span class="hljs-function"><span class="hljs-title">close</span>(<span class="hljs-params"></span>)</span>&#123;
            <span class="hljs-built_in">this</span>.params.openFlag = <span class="hljs-literal">false</span>;
            <span class="hljs-built_in">this</span>.$emit(<span class="hljs-string">"winClose"</span>);
        &#125;
    &#125;
&#125;
</span><span class="hljs-tag"></<span class="hljs-name">script</span>></span></span>
<span class="xml"><span class="hljs-tag"><<span class="hljs-name">style</span> <span class="hljs-attr">scoped</span>></span><span class="css">
<span class="hljs-selector-class">.g-mark</span> &#123;
    <span class="hljs-attribute">position</span>: absolute;
    <span class="hljs-attribute">top</span>: <span class="hljs-number">0</span>;
    <span class="hljs-attribute">left</span>: <span class="hljs-number">0</span>;
    <span class="hljs-attribute">background-color</span>: <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0.2</span>);
    <span class="hljs-attribute">display</span>: flex;
    <span class="hljs-attribute">align-items</span>:center;
    <span class="hljs-attribute">justify-content</span>:center;
    <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
    <span class="hljs-attribute">height</span>: <span class="hljs-number">100%</span>;
    <span class="hljs-attribute">z-index</span>: <span class="hljs-number">99999</span>;
&#125;
<span class="hljs-selector-class">.g-win</span>&#123;
    <span class="hljs-attribute">display</span>: flex;
    <span class="hljs-attribute">min-width</span>: <span class="hljs-number">800px</span>;
    <span class="hljs-attribute">min-height</span>: <span class="hljs-number">600px</span>;
&#125;
</span><span class="hljs-tag"></<span class="hljs-name">style</span>></span></span>
<span class="copy-code-btn">复制代码</span></code></pre>
<h3 data-id="heading-11">4、页面实现</h3>
<p>页面通过引入组件box-open-win并设置pageName属性即可，当然也可以不设置，组件会自动生成随机名称</p>
<pre><code class="hljs language-js copyable" lang="js">      <box-open-win ref=<span class="hljs-string">"selectUser"</span> pageName=<span class="hljs-string">"SelectUser"</span> winClass=<span class="hljs-string">"user-win"</span> >
          <span class="xml"><span class="hljs-tag"><<span class="hljs-name">select-user</span> /></span></span>
      </box-open-win>
<span class="copy-code-btn">复制代码</span></code></pre>
<h2 data-id="heading-12">备注：</h2>
<p>1、如果出现焦点获取后，无法选择其他元素的情况，可能是因为父级元素的overflow: scroll样式导致的，因为按方向键时，滚动效果优先于焦点移动。</p></div>  
</div>
            