
---
title: '实现一个拖动旋转图片的安全验证器'
categories: 
 - 编程
 - 掘金
 - 分类
headimg: 'https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f9919f246eab4023ad230c660b37b787~tplv-k3u1fbpfcp-watermark.image'
author: 掘金
comments: false
date: Sat, 07 Aug 2021 20:12:20 GMT
thumbnail: 'https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f9919f246eab4023ad230c660b37b787~tplv-k3u1fbpfcp-watermark.image'
---

<div>   
<div class="markdown-body"><style>.markdown-body&#123;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333&#125;.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6&#123;line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px&#125;.markdown-body h1&#123;font-size:30px;margin-bottom:5px&#125;.markdown-body h2&#123;padding-bottom:12px;font-size:24px;border-bottom:1px solid #ececec&#125;.markdown-body h3&#123;font-size:18px;padding-bottom:0&#125;.markdown-body h4&#123;font-size:16px&#125;.markdown-body h5&#123;font-size:15px&#125;.markdown-body h6&#123;margin-top:5px&#125;.markdown-body p&#123;line-height:inherit;margin-top:22px;margin-bottom:22px&#125;.markdown-body img&#123;max-width:100%&#125;.markdown-body hr&#123;border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px&#125;.markdown-body code&#123;word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em&#125;.markdown-body code,.markdown-body pre&#123;font-family:Menlo,Monaco,Consolas,Courier New,monospace&#125;.markdown-body pre&#123;overflow:auto;position:relative;line-height:1.75&#125;.markdown-body pre>code&#123;font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8&#125;.markdown-body a&#123;text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff&#125;.markdown-body a:active,.markdown-body a:hover&#123;color:#275b8c&#125;.markdown-body table&#123;display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6&#125;.markdown-body thead&#123;background:#f6f6f6;color:#000;text-align:left&#125;.markdown-body tr:nth-child(2n)&#123;background-color:#fcfcfc&#125;.markdown-body td,.markdown-body th&#123;padding:12px 7px;line-height:24px&#125;.markdown-body td&#123;min-width:120px&#125;.markdown-body blockquote&#123;color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8&#125;.markdown-body blockquote:after&#123;display:block;content:""&#125;.markdown-body blockquote>p&#123;margin:10px 0&#125;.markdown-body ol,.markdown-body ul&#123;padding-left:28px&#125;.markdown-body ol li,.markdown-body ul li&#123;margin-bottom:0;list-style:inherit&#125;.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item&#123;list-style:none&#125;.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul&#123;margin-top:0&#125;.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul&#123;margin-top:3px&#125;.markdown-body ol li&#123;padding-left:6px&#125;.markdown-body .contains-task-list&#123;padding-left:0&#125;.markdown-body .task-list-item&#123;list-style:none&#125;@media (max-width:720px)&#123;.markdown-body h1&#123;font-size:24px&#125;.markdown-body h2&#123;font-size:20px&#125;.markdown-body h3&#123;font-size:18px&#125;&#125;</style><h2 data-id="heading-0">安全验证</h2>
<p>在很多网站，都会在发送短信验证码的时候，让用户输入图形验证码，或者拖动图片拼图，或者从几张图片中选择自来水龙头，或者在图片中点击文字，或者选择图片中的红绿灯（我老是选不对），也或者是把一张歪掉的图片旋转至正确的角度。这篇文章就来说说如何实现图片旋转验证。说是安全验证，其实也就是验证这个用户是真实的人而不是机器人。</p>
<h2 data-id="heading-1">效果一览</h2>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f9919f246eab4023ad230c660b37b787~tplv-k3u1fbpfcp-watermark.image" alt="动画4.gif" loading="lazy" referrerpolicy="no-referrer"></p>
<h2 data-id="heading-2">图片和旋转角度</h2>
<p>一般来说，应该由后端返回一张旋转过的图片，然后前端把图片顺时针转正，再返回给后端一个前端旋转的角度，后端把自己旋转的角度和前端旋转的角度加起来，差不多360度的时候，就表示用户旋转的角度是正确的。这里解释一下为什么要用差不多，因为如果强行要和360相等，那么用户将很难完成验证，所以需要理由一定的误差范围。</p>
<p>因为文章条件的原因，不好演示后端，<strong>这里直接用一张旋转了90度的照片</strong>，然后角度校验这事，前端来做。</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b2b3927210054cdda0bb84e114bd0882~tplv-k3u1fbpfcp-watermark.image" alt="验证图片" loading="lazy" referrerpolicy="no-referrer"></p>
<h2 data-id="heading-3">构建基础布局</h2>
<p>因为状态蛮多的，所以用vue来写。</p>
<p><strong>html</strong></p>
<pre><code class="hljs language-html copyable" lang="html"><span class="hljs-tag"><<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"app"</span>></span>
  <span class="hljs-tag"><<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"check"</span>></span>
    <span class="hljs-tag"><<span class="hljs-name">p</span>></span>拖动滑块使图片角度为正<span class="hljs-tag"></<span class="hljs-name">p</span>></span>
    <span class="hljs-tag"><<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"img-con"</span>></span>
      <span class="hljs-tag"><<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://z3.ax1x.com/2021/08/06/fn7X4S.png"</span> /></span>
    <span class="hljs-tag"></<span class="hljs-name">div</span>></span>
    <span class="hljs-tag"><<span class="hljs-name">div</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"sliderCon"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"slider-con"</span>></span>
      <span class="hljs-tag"><<span class="hljs-name">div</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"slider"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"slider"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"slider"</span> <span class="hljs-attr">:class</span>=<span class="hljs-string">"slider"</span>></span>
      <span class="hljs-tag"></<span class="hljs-name">div</span>></span>
    <span class="hljs-tag"></<span class="hljs-name">div</span>></span>
  <span class="hljs-tag"></<span class="hljs-name">div</span>></span>
<span class="hljs-tag"></<span class="hljs-name">div</span>></span>
<span class="copy-code-btn">复制代码</span></code></pre>
<p><strong>css</strong></p>
<pre><code class="hljs language-css copyable" lang="css"><span class="hljs-selector-id">#app</span> &#123;
  <span class="hljs-attribute">width</span>: <span class="hljs-number">100vw</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">100vh</span>;
  <span class="hljs-attribute">display</span>: flex;
  <span class="hljs-attribute">flex-direction</span>: column;
  <span class="hljs-attribute">align-items</span>: center;
  <span class="hljs-attribute">justify-content</span>: center;
&#125;
<span class="hljs-selector-class">.check</span> &#123;
  --slider-size: <span class="hljs-number">50px</span>;
  <span class="hljs-attribute">margin-top</span>: <span class="hljs-number">20px</span>;
  <span class="hljs-attribute">width</span>: <span class="hljs-number">300px</span>;
  <span class="hljs-attribute">background</span>: white;
  <span class="hljs-attribute">box-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">5px</span> grey;
  <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">5px</span>;
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">20px</span> <span class="hljs-number">0</span>;

  <span class="hljs-attribute">display</span>: flex;
  <span class="hljs-attribute">flex-direction</span>: column;
  <span class="hljs-attribute">align-items</span>: center;
&#125;

<span class="hljs-selector-class">.check</span> <span class="hljs-selector-class">.img-con</span> &#123;
  <span class="hljs-attribute">position</span>: relative;
  <span class="hljs-attribute">overflow</span>: hidden;
  <span class="hljs-attribute">width</span>: <span class="hljs-number">120px</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">120px</span>;
  <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">50%</span>;
&#125;

<span class="hljs-selector-class">.check</span> <span class="hljs-selector-class">.img-con</span> <span class="hljs-selector-tag">img</span> &#123;
  <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">100%</span>;
  user-select: none;
&#125;

<span class="hljs-selector-class">.check</span> <span class="hljs-selector-class">.slider-con</span> &#123;
  <span class="hljs-attribute">width</span>: <span class="hljs-number">80%</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-built_in">var</span>(--slider-size);
  <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">50px</span>;
  <span class="hljs-attribute">margin-top</span>: <span class="hljs-number">1rem</span>;
  <span class="hljs-attribute">position</span>: relative;
  <span class="hljs-attribute">background</span>: <span class="hljs-number">#f5f5f5</span>;
  <span class="hljs-attribute">box-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">5px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0.1</span>) inset;
&#125;

<span class="hljs-selector-class">.slider-con</span> <span class="hljs-selector-class">.slider</span> &#123;
  <span class="hljs-attribute">background</span>: white;
  <span class="hljs-attribute">width</span>: <span class="hljs-built_in">var</span>(--slider-size);
  <span class="hljs-attribute">height</span>: <span class="hljs-built_in">var</span>(--slider-size);
  <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">50%</span>;
  <span class="hljs-attribute">box-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">5px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0.2</span>);
  <span class="hljs-attribute">cursor</span>: move;
&#125;

<span class="hljs-selector-tag">body</span> &#123;
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">background</span>: <span class="hljs-number">#fef5e0</span>;
&#125;

<span class="copy-code-btn">复制代码</span></code></pre>
<p><strong>js</strong></p>
<pre><code class="hljs language-javascript copyable" lang="javascript">Vue.createApp(&#123;
  <span class="hljs-function"><span class="hljs-title">data</span>(<span class="hljs-params"></span>)</span> &#123;
    <span class="hljs-keyword">return</span> &#123;&#125;
  &#125;,
  <span class="hljs-attr">methods</span>: &#123;&#125;
&#125;).mount(<span class="hljs-string">'#app'</span>)
<span class="copy-code-btn">复制代码</span></code></pre>
<p>这就是基础布局了，代码量比较大，你忍一下。</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/78d968bbb5ac45998eae5b5343053380~tplv-k3u1fbpfcp-watermark.image" alt="image.png" loading="lazy" referrerpolicy="no-referrer"></p>
<h2 data-id="heading-4">动起来！</h2>
<h3 data-id="heading-5">按下滑块</h3>
<p>我们先让下面的滑块动起来，更新 vue 的 data ，设置需要的状态数据</p>
<pre><code class="hljs language-javascript copyable" lang="javascript">  <span class="hljs-function"><span class="hljs-title">data</span>(<span class="hljs-params"></span>)</span> &#123;
    <span class="hljs-keyword">return</span> &#123;
      <span class="hljs-attr">showError</span>: <span class="hljs-literal">false</span>, <span class="hljs-comment">// 显示错误提示</span>
      <span class="hljs-attr">showSuccess</span>: <span class="hljs-literal">false</span>, <span class="hljs-comment">// 显示成功提示</span>
      <span class="hljs-attr">checking</span>: <span class="hljs-literal">false</span>, <span class="hljs-comment">// 显示检查中提示</span>
      <span class="hljs-attr">sliding</span>: <span class="hljs-literal">false</span>, <span class="hljs-comment">// 当前是否正在拖动滑块</span>
      <span class="hljs-attr">slidMove</span>: <span class="hljs-number">0</span> <span class="hljs-comment">// 滑块移动的距离(px)</span>
    &#125;;
  &#125;,
<span class="copy-code-btn">复制代码</span></code></pre>
<p>在 methods 中新增三个函数，处理鼠标按下的事件和抬起事件以及重置滑块的函数</p>
<pre><code class="hljs language-javascript copyable" lang="javascript"><span class="hljs-comment">// 鼠标按下</span>
<span class="hljs-function"><span class="hljs-title">onMouseDown</span>(<span class="hljs-params">event</span>)</span> &#123;
  <span class="hljs-comment">// 当用户鼠标按下时，目标不是滑块，则不处理</span>
  <span class="hljs-keyword">if</span> (event.target.id !== <span class="hljs-string">"slider"</span>) &#123;
    <span class="hljs-keyword">return</span>;
  &#125;
  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.checking) <span class="hljs-keyword">return</span>;
  <span class="hljs-comment">// 设置状态为滑动中</span>
  <span class="hljs-built_in">this</span>.sliding = <span class="hljs-literal">true</span>;
  <span class="hljs-comment">// 下面三个变量不需要监听变化，因此不放到 data 中</span>
  
  <span class="hljs-comment">// clientX 事件属性返回当事件被触发时鼠标指针相对于浏览器页面（或客户区）的水平坐标。</span>
  <span class="hljs-comment">// 记录鼠标按下时的x位置</span>
  <span class="hljs-built_in">this</span>.sliderLeft = event.clientX;
  <span class="hljs-built_in">this</span>.sliderConWidth = <span class="hljs-built_in">this</span>.$refs.sliderCon.clientWidth; <span class="hljs-comment">// 记录滑槽的宽度</span>
  <span class="hljs-built_in">this</span>.sliderWidth = <span class="hljs-built_in">this</span>.$refs.slider.clientWidth; <span class="hljs-comment">// 记录滑块的宽度</span>
&#125;
<span class="hljs-comment">// 鼠标抬起</span>
<span class="hljs-function"><span class="hljs-title">onMouseUp</span>(<span class="hljs-params">event</span>)</span> &#123;
  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.sliding) &#123;
    <span class="hljs-built_in">this</span>.resetSlider()
  &#125;
&#125;
<span class="hljs-comment">// 重置滑块</span>
<span class="hljs-function"><span class="hljs-title">resetSlider</span>(<span class="hljs-params"></span>)</span> &#123;
  <span class="hljs-built_in">this</span>.sliding = <span class="hljs-literal">false</span>;
  <span class="hljs-built_in">this</span>.slidMove = <span class="hljs-number">0</span>;
  <span class="hljs-built_in">this</span>.checking = <span class="hljs-literal">false</span>;
  <span class="hljs-built_in">this</span>.showSuccess = <span class="hljs-literal">false</span>;
  <span class="hljs-built_in">this</span>.showError = <span class="hljs-literal">false</span>;
&#125;
<span class="copy-code-btn">复制代码</span></code></pre>
<p>给验证卡片绑定上事件和数据。</p>
<p>给 <code>div.check</code> 绑定鼠标事件:</p>
<p><code><div class="check" @mousedown="onMouseDown" @mouseup="onMouseUp"></code></p>
<p>给 <code>#slider</code> 动态绑定class :</p>
<pre><code class="hljs language-html copyable" lang="html"><span class="hljs-tag"><<span class="hljs-name">div</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"slider"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"slider"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"slider"</span> <span class="hljs-attr">:class</span>=<span class="hljs-string">"&#123;sliding&#125;"</span>></span>
<span class="hljs-tag"></<span class="hljs-name">div</span>></span>
<span class="copy-code-btn">复制代码</span></code></pre>
<p>在 css 中新增一个 css 选择器</p>
<pre><code class="hljs language-css copyable" lang="css"><span class="hljs-selector-class">.slider-con</span> <span class="hljs-selector-class">.slider</span><span class="hljs-selector-class">.sliding</span> &#123;
  <span class="hljs-attribute">background</span>: <span class="hljs-number">#4ed3ff</span>;
&#125;
<span class="copy-code-btn">复制代码</span></code></pre>
<p>这样在按下滑块时，就会记录滑动状态为 true ，然后滑块会变为蓝色，松开时，滑块的滑动状态为 false ,失去 <code>.sliding</code> 类，颜色恢复白色。</p>
<p>初始状态有了后，来专心处理滑动。</p>
<p>修改 css ,找到 <code>.slider-con .slider</code> 这个选择器，在里面新增两个 css 属性</p>
<pre><code class="hljs language-css copyable" lang="css"><span class="hljs-selector-class">.slider-con</span> <span class="hljs-selector-class">.slider</span> &#123;
  <span class="hljs-comment">/* ...其他属性... */</span>
  
  --move: <span class="hljs-number">0px</span>;
  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateX</span>(<span class="hljs-built_in">var</span>(--move));
&#125;
<span class="copy-code-btn">复制代码</span></code></pre>
<p>这样在鼠标移动时，只需要改变 <code>--move</code> 这个 css 变量即可。接下来绑定这个变量即可，修改　<code>id="slider"</code> 的 div。也就是滑块 div。</p>
<pre><code class="hljs language-html copyable" lang="html"><span class="hljs-tag"><<span class="hljs-name">div</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"slider"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"slider"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"slider"</span> <span class="hljs-attr">:class</span>=<span class="hljs-string">"&#123;sliding&#125;"</span> <span class="hljs-attr">:style</span>=<span class="hljs-string">"&#123;'--move': `$&#123;slidMove&#125;px`&#125;"</span>></span>
<span class="hljs-tag"></<span class="hljs-name">div</span>></span>
<span class="copy-code-btn">复制代码</span></code></pre>
<p>这里通过 <code>:style</code> 的方式动态绑定了 <code>--move</code> css变量和 <code>slidMove</code>变量</p>
<p>新增一个 <code>onMouseMove</code> 函数，用于处理鼠标移动。</p>
<pre><code class="hljs language-javascript copyable" lang="javascript"><span class="hljs-comment">// 处理鼠标移动</span>
<span class="hljs-function"><span class="hljs-title">onMouseMove</span>(<span class="hljs-params">event</span>)</span> &#123;
  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.sliding && <span class="hljs-built_in">this</span>.checking === <span class="hljs-literal">false</span>) &#123;
    <span class="hljs-comment">// 滑块向右的平移距离等于鼠标移动事件的X坐标减去鼠标按下时的初始坐标。</span>
    <span class="hljs-keyword">let</span> m = event.clientX - <span class="hljs-built_in">this</span>.sliderLeft;
    <span class="hljs-keyword">if</span> (m < <span class="hljs-number">0</span>) &#123;
      <span class="hljs-comment">// 如果m小于0表示用户鼠标向左移动超出了初始位置，也就是0</span>
      <span class="hljs-comment">// 所以直接等于 0，以防止越界</span>
      m = <span class="hljs-number">0</span>;
    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (m > <span class="hljs-built_in">this</span>.sliderConWidth - <span class="hljs-built_in">this</span>.sliderWidth) &#123;
      <span class="hljs-comment">// 滑块向右移动的最大距离是滑槽的宽度减去滑块的宽度。</span>
      <span class="hljs-comment">// 因为css的 translateX 函数是以元素的左上角坐标计算的</span>
      <span class="hljs-comment">// 所以要减去滑块的宽度，这样滑块在最右边时，才不会左上角和滑槽右上角重合。</span>
      m = <span class="hljs-built_in">this</span>.sliderConWidth - <span class="hljs-built_in">this</span>.sliderWidth;
    &#125;
    <span class="hljs-built_in">this</span>.slidMove = m;
  &#125;
&#125;
<span class="copy-code-btn">复制代码</span></code></pre>
<p>好了，这样就可以拖动滑块了。</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0fa6ea1f6add49da83738472b9664450~tplv-k3u1fbpfcp-watermark.image" alt="play.gif" loading="lazy" referrerpolicy="no-referrer"></p>
<h3 data-id="heading-6">图片旋转</h3>
<p>先增加两个 vue 的计算属性，需要根据滑块移动相对滑槽可移动空间的移动比例来计算旋转的角度。</p>
<pre><code class="hljs language-javascript copyable" lang="javascript">  computed: &#123;
    <span class="hljs-function"><span class="hljs-title">angle</span>(<span class="hljs-params"></span>)</span> &#123;
      <span class="hljs-keyword">let</span> sliderConWidth = <span class="hljs-built_in">this</span>.sliderConWidth ?? <span class="hljs-number">0</span>;
      <span class="hljs-keyword">let</span> sliderWidth = <span class="hljs-built_in">this</span>.sliderWidth ?? <span class="hljs-number">0</span>;
      <span class="hljs-keyword">let</span> ratio = <span class="hljs-built_in">this</span>.slidMove / (sliderConWidth - sliderWidth);
      <span class="hljs-comment">// 360度乘以滑块的移动比例，就是旋转的角度</span>
      <span class="hljs-keyword">return</span> <span class="hljs-number">360</span> * ratio;
    &#125;,
    <span class="hljs-function"><span class="hljs-title">imgAngle</span>(<span class="hljs-params"></span>)</span> &#123;
      <span class="hljs-keyword">return</span> <span class="hljs-string">`rotate(<span class="hljs-subst">$&#123;<span class="hljs-built_in">this</span>.angle&#125;</span>deg)`</span>;
    &#125;
  &#125;
<span class="copy-code-btn">复制代码</span></code></pre>
<p>随后绑定到 dom 上去即可。找到 img 元素，修改它。</p>
<pre><code class="hljs language-html copyable" lang="html"><span class="hljs-tag"><<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://z3.ax1x.com/2021/08/06/fn7X4S.png"</span> <span class="hljs-attr">:style</span>=<span class="hljs-string">"&#123;transform: imgAngle&#125;"</span> /></span>
<span class="copy-code-btn">复制代码</span></code></pre>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3a5f32ac0bc246248ab7afa84c34b504~tplv-k3u1fbpfcp-watermark.image" alt="动画.gif" loading="lazy" referrerpolicy="no-referrer"></p>
<h2 data-id="heading-7">验证旋转角度是否正确</h2>
<p>修改 html 部分，显示各种状态。</p>
<pre><code class="hljs language-html copyable" lang="html"><span class="hljs-tag"><<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"img-con"</span>></span>
  <span class="hljs-tag"><<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://z3.ax1x.com/2021/08/06/fn7X4S.png"</span> <span class="hljs-attr">:style</span>=<span class="hljs-string">"&#123;transform: imgAngle&#125;"</span> /></span>
  <span class="hljs-tag"><<span class="hljs-name">div</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"showError"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"check-state"</span>></span>
    错误
  <span class="hljs-tag"></<span class="hljs-name">div</span>></span>
  <span class="hljs-tag"><<span class="hljs-name">div</span> <span class="hljs-attr">v-else-if</span>=<span class="hljs-string">"showSuccess"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"check-state"</span>></span>
    正确
  <span class="hljs-tag"></<span class="hljs-name">div</span>></span>
  <span class="hljs-tag"><<span class="hljs-name">div</span> <span class="hljs-attr">v-else-if</span>=<span class="hljs-string">"checking"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"check-state"</span>></span>
    验证中
  <span class="hljs-tag"></<span class="hljs-name">div</span>></span>
<span class="hljs-tag"></<span class="hljs-name">div</span>></span>
<span class="copy-code-btn">复制代码</span></code></pre>
<p>新增 <code>.check-state</code> 样式</p>
<pre><code class="hljs language-css copyable" lang="css"><span class="hljs-selector-class">.check-state</span> &#123;
  <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">100%</span>;
  <span class="hljs-attribute">background</span>: <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0.5</span>);
  <span class="hljs-attribute">color</span>: white;
  <span class="hljs-attribute">position</span>: absolute;
  <span class="hljs-attribute">top</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">left</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">display</span>: flex;
  <span class="hljs-attribute">justify-content</span>:center;
  <span class="hljs-attribute">align-items</span>:center;
&#125;
<span class="copy-code-btn">复制代码</span></code></pre>
<p>再新增一个 <code>validApi</code> 函数到 methods 中，用于模拟后端 api 验证角度是否正确。</p>
<pre><code class="hljs language-javascript copyable" lang="javascript"><span class="hljs-comment">// 验证角度是否正确</span>
<span class="hljs-function"><span class="hljs-title">validApi</span>(<span class="hljs-params">angle</span>)</span> &#123;
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =></span> &#123;
    <span class="hljs-comment">// 模拟网络请求</span>
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =></span> &#123;
      <span class="hljs-comment">// 图片已旋转的角度</span>
      <span class="hljs-keyword">const</span> imgAngle = <span class="hljs-number">90</span>;
      <span class="hljs-comment">// 图片已旋转角度和用户旋转角度之和</span>
      <span class="hljs-keyword">let</span> sum = imgAngle + angle;
      <span class="hljs-comment">// 误差范围</span>
      <span class="hljs-keyword">const</span> errorRang = <span class="hljs-number">10</span>;
      <span class="hljs-comment">// 当用户旋转角度和已旋转角度之和为360度时，表示旋转了一整圈，也就是转正了</span>
      <span class="hljs-comment">// 但是不能指望用户刚好转到那么多，所以需要留有一定的误差</span>
      <span class="hljs-keyword">let</span> isOk = <span class="hljs-built_in">Math</span>.abs(<span class="hljs-number">360</span> - sum) <= errorRang;

      resolve(isOk);
    &#125;, <span class="hljs-number">1000</span>);
  &#125;);
&#125;
<span class="copy-code-btn">复制代码</span></code></pre>
<p>接下来修改 <code>onMouseUp</code> 函数，来验证和处理旋转角度及状态。</p>
<pre><code class="hljs language-javascript copyable" lang="javascript"><span class="hljs-function"><span class="hljs-title">onMouseUp</span>(<span class="hljs-params">event</span>)</span> &#123;
  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.sliding && <span class="hljs-built_in">this</span>.checking === <span class="hljs-literal">false</span>) &#123;
    <span class="hljs-built_in">this</span>.checking = <span class="hljs-literal">true</span>;
    <span class="hljs-built_in">this</span>.validApi(<span class="hljs-built_in">this</span>.angle)
      .then(<span class="hljs-function">(<span class="hljs-params">isok</span>) =></span> &#123;
        <span class="hljs-keyword">if</span> (isok) &#123;
          <span class="hljs-built_in">this</span>.showSuccess = <span class="hljs-literal">true</span>;
        &#125; <span class="hljs-keyword">else</span> &#123;
          <span class="hljs-built_in">this</span>.showError = <span class="hljs-literal">true</span>;
        &#125;
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =></span> &#123;
          <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =></span> &#123;
            <span class="hljs-keyword">if</span> (isok) &#123;
              resolve(<span class="hljs-built_in">Math</span>.round(<span class="hljs-built_in">this</span>.angle));
            &#125; <span class="hljs-keyword">else</span> &#123;
              reject();
            &#125;
            <span class="hljs-built_in">this</span>.resetSlider();
          &#125;, <span class="hljs-number">1000</span>);
        &#125;);
      &#125;)
      .then(<span class="hljs-function">(<span class="hljs-params">angle</span>) =></span> &#123;
        <span class="hljs-comment">// 处理业务，或者通知调用者验证成功</span>
        alert(<span class="hljs-string">"旋转正确: "</span> + angle + <span class="hljs-string">"度"</span>);
      &#125;)
      .catche(<span class="hljs-function">(<span class="hljs-params">e</span>) =></span> &#123;
        alert(<span class="hljs-string">"旋转错误"</span>);
      &#125;);
  &#125;
&#125;
<span class="copy-code-btn">复制代码</span></code></pre>
<p>来看看效果</p>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9db8f35717d34100b7200f07687ed708~tplv-k3u1fbpfcp-watermark.image" alt="动画2.gif" loading="lazy" referrerpolicy="no-referrer"></p>
<h2 data-id="heading-8">丰富样式</h2>
<p>现在基础功能做好了，滑块部分的样式还是不够好，只有一个按下状态，现在可以给他加一个错误的时候抖动的动画。</p>
<p>首先新增一个 css 动画</p>
<pre><code class="hljs language-css copyable" lang="css"><span class="hljs-keyword">@keyframes</span> jitter &#123;
  <span class="hljs-number">20%</span> &#123;
    <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateX</span>(-<span class="hljs-number">5px</span>);
  &#125;
  <span class="hljs-number">40%</span> &#123;
    <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateX</span>(<span class="hljs-number">10px</span>);
  &#125;
  <span class="hljs-number">60%</span> &#123;
    <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateX</span>(-<span class="hljs-number">5px</span>);
  &#125;
  <span class="hljs-number">80%</span> &#123;
    <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateX</span>(<span class="hljs-number">10px</span>);
  &#125;
  <span class="hljs-number">100%</span> &#123;
    <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateX</span>(<span class="hljs-number">0</span>);
  &#125;
&#125;

<span class="hljs-selector-class">.slider-con</span><span class="hljs-selector-class">.err-anim</span> &#123;
  <span class="hljs-attribute">animation</span>: jitter <span class="hljs-number">0.5s</span>;
&#125;
<span class="hljs-comment">/** 错误动画下的滑块颜色为红色 **/</span>
<span class="hljs-selector-class">.slider-con</span><span class="hljs-selector-class">.err-anim</span> <span class="hljs-selector-class">.slider</span> &#123;
  <span class="hljs-attribute">background</span>: <span class="hljs-number">#ff4e4e</span>;
&#125;
<span class="copy-code-btn">复制代码</span></code></pre>
<p>然后绑定到滑槽上面去。</p>
<pre><code class="hljs language-html copyable" lang="html"><span class="hljs-tag"><<span class="hljs-name">div</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"sliderCon"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"slider-con"</span> <span class="hljs-attr">:class</span>=<span class="hljs-string">"&#123;'err-anim':showError&#125;"</span>></span>
    ...
<span class="hljs-tag"></<span class="hljs-name">div</span>></span>
<span class="copy-code-btn">复制代码</span></code></pre>
<p>查看效果</p>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/af35ba98bc84442ca77467aab1b313aa~tplv-k3u1fbpfcp-watermark.image" alt="动画3.gif" loading="lazy" referrerpolicy="no-referrer"></p>
<h2 data-id="heading-9">完整代码</h2>
<p>代码都是在 codepen 编写的，因此可直接前往 codepen 查看完整代码</p>
<p><a href="https://link.juejin.cn/?target=https%3A%2F%2Fcodepen.io%2Fjethrohuang%2Fpen%2FjOmeaBV" target="_blank" rel="nofollow noopener noreferrer" title="https://codepen.io/jethrohuang/pen/jOmeaBV" ref="nofollow noopener noreferrer">SafeCheck (codepen.io)</a></p></div>  
</div>
            