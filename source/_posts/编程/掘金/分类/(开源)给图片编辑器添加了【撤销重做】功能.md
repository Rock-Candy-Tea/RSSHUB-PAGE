
---
title: '(开源)给图片编辑器添加了【撤销重做】功能'
categories: 
 - 编程
 - 掘金
 - 分类
headimg: 'https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ba554190ddb142108dfdbe3abcb98a62~tplv-k3u1fbpfcp-watermark.image'
author: 掘金
comments: false
date: Thu, 19 Aug 2021 15:51:39 GMT
thumbnail: 'https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ba554190ddb142108dfdbe3abcb98a62~tplv-k3u1fbpfcp-watermark.image'
---

<div>   
<div class="markdown-body"><style>.markdown-body&#123;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333&#125;.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6&#123;line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px&#125;.markdown-body h1&#123;font-size:30px;margin-bottom:5px&#125;.markdown-body h2&#123;padding-bottom:12px;font-size:24px;border-bottom:1px solid #ececec&#125;.markdown-body h3&#123;font-size:18px;padding-bottom:0&#125;.markdown-body h4&#123;font-size:16px&#125;.markdown-body h5&#123;font-size:15px&#125;.markdown-body h6&#123;margin-top:5px&#125;.markdown-body p&#123;line-height:inherit;margin-top:22px;margin-bottom:22px&#125;.markdown-body img&#123;max-width:100%&#125;.markdown-body hr&#123;border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px&#125;.markdown-body code&#123;word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em&#125;.markdown-body code,.markdown-body pre&#123;font-family:Menlo,Monaco,Consolas,Courier New,monospace&#125;.markdown-body pre&#123;overflow:auto;position:relative;line-height:1.75&#125;.markdown-body pre>code&#123;font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8&#125;.markdown-body a&#123;text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff&#125;.markdown-body a:active,.markdown-body a:hover&#123;color:#275b8c&#125;.markdown-body table&#123;display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6&#125;.markdown-body thead&#123;background:#f6f6f6;color:#000;text-align:left&#125;.markdown-body tr:nth-child(2n)&#123;background-color:#fcfcfc&#125;.markdown-body td,.markdown-body th&#123;padding:12px 7px;line-height:24px&#125;.markdown-body td&#123;min-width:120px&#125;.markdown-body blockquote&#123;color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8&#125;.markdown-body blockquote:after&#123;display:block;content:""&#125;.markdown-body blockquote>p&#123;margin:10px 0&#125;.markdown-body ol,.markdown-body ul&#123;padding-left:28px&#125;.markdown-body ol li,.markdown-body ul li&#123;margin-bottom:0;list-style:inherit&#125;.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item&#123;list-style:none&#125;.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul&#123;margin-top:0&#125;.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul&#123;margin-top:3px&#125;.markdown-body ol li&#123;padding-left:6px&#125;.markdown-body .contains-task-list&#123;padding-left:0&#125;.markdown-body .task-list-item&#123;list-style:none&#125;@media (max-width:720px)&#123;.markdown-body h1&#123;font-size:24px&#125;.markdown-body h2&#123;font-size:20px&#125;.markdown-body h3&#123;font-size:18px&#125;&#125;</style><p>本文已参与掘金创作者训练营第三期，详情查看：<a href="https://juejin.cn/post/6994417198164869133" title="https://juejin.cn/post/6994417198164869133" target="_blank">掘力计划｜创作者训练营第三期正在进行，「写」出个人影响力</a>。</p>
<h2 data-id="heading-0">前言</h2>
<p>上篇文章我们实现了图片编辑器的辅助线，大多数的工具类型软件都支持撤销和重做，趁热打铁，我们图片编辑器的撤销重做的功能给实现一下，丰富我们的图片编辑器的功能。</p>
<h2 data-id="heading-1">演示</h2>
<p><a href="https://link.juejin.cn/?target=http%3A%2F%2F39.97.252.98%3A3000%2F" target="_blank" rel="nofollow noopener noreferrer" title="http://39.97.252.98:3000/" ref="nofollow noopener noreferrer">演示地址</a></p>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ba554190ddb142108dfdbe3abcb98a62~tplv-k3u1fbpfcp-watermark.image" alt="rudoundo.gif" loading="lazy" referrerpolicy="no-referrer"></p>
<h2 data-id="heading-2">实现流程</h2>
<h3 data-id="heading-3">原理讲解</h3>
<p>通过上面的演示我们分析有这三种类型的操作，分别是<code>push</code>,<code>undo</code>,<code>redo</code></p>
<h4 data-id="heading-4">1. 在操作的过程中记录状态<code>push</code></h4>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/aff056c113bc4198878a0ecf2e8ef4a2~tplv-k3u1fbpfcp-watermark.image" alt="image.png" loading="lazy" referrerpolicy="no-referrer">
通过流程图我们可以看到，正常的操作直接记录状态就可以。</p>
<h4 data-id="heading-5">2.在操作过程中撤销操作<code>undo</code></h4>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/02f246c09bf440f3a86d2aaf0a1c28d9~tplv-k3u1fbpfcp-watermark.image" alt="image.png" loading="lazy" referrerpolicy="no-referrer">
通过流程图我们可以看到在<code>撤销1</code>操作后，当前的状态会到<code>操作2</code>的状态。在进一步点击<code>撤销2</code>会回到<code>操作1</code>的状态</p>
<h4 data-id="heading-6">3.在操作过程中执行重做操作<code>rudo</code></h4>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f245fe7a5e4644abb9f514eac10d2a7d~tplv-k3u1fbpfcp-watermark.image" alt="image.png" loading="lazy" referrerpolicy="no-referrer">
通过流程图我们可以看到在操作<code>重做1</code>后，图片会回到<code>操作2</code>的状态。</p>
<h4 data-id="heading-7">4.继续在操作的过程中记录状态<code>again push</code></h4>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/42ec0c5eaf3e45fda03230e82d454a29~tplv-k3u1fbpfcp-watermark.image" alt="image.png" loading="lazy" referrerpolicy="no-referrer"></p>
<p><code>注意</code>：此时我们可以有<code>两种操作</code>,一是继续点击<code>重做</code>，图片会回到<code>操作3</code>的状态。这个我们就不画流程图了。另一种可以直接在操作图片内的元素，此时要把<code>操作3</code>的状态记录给<code>移除掉</code>.流程图如下：</p>
<h2 data-id="heading-8">代码实现</h2>
<p>大致思路是，我们用了<code>状态管理</code>库，通过<code>快照的方式</code>，在状态变更的过程中<code>记录到数组</code>中，<code>撤销</code>的时候通过<code>索引</code>执向要显示的状态，<code>重做</code>的时候也是通过<code>索引</code>回复到之前状态状态。在<code>继续操作</code>的时候，可能会<code>删除</code>部分状态</p>
<h3 data-id="heading-9">定义保存记录的数据结构</h3>
<pre><code class="copyable">// 撤销重做数据结构
undoRedoData: &#123;
    activeSnapshot: null, // 当前激活的快照数据
    snapshots: [], // 存储的快照数据
    current: -1, // 当前索引
&#125;
<span class="copy-code-btn">复制代码</span></code></pre>
<h3 data-id="heading-10">更新快照数据</h3>
<ul>
<li>我们定义了操作的类型<code>type</code>, 分别是<code>push</code>,<code>undo</code>,<code>redo</code></li>
</ul>
<pre><code class="copyable">// 操作类型
export type UndoRedoActionType = &#123;
  type: 'push' | 'undo' | 'redo';
  data: DatModelItem | null;
&#125;;

<span class="copy-code-btn">复制代码</span></code></pre>
<ul>
<li>执行<code>push</code>操作代码内容为</li>
</ul>
<pre><code class="copyable">if (type === 'push') &#123;
    // 深度拷贝要保存的记录
    const newData = _.cloneDeep(data);
    if (current === -1) &#123;
      newUndoRedoData.snapshots = [...snapshots, newData];
    &#125; else &#123;
      // 当前已经撤销，重新操作的时候要把某些记录取消
      newUndoRedoData.snapshots = snapshots
        .slice(0, current)
        .concat([newData]);
    &#125;
    // 重置当前激活的数据和索引
    newUndoRedoData.activeSnapshot = null;
    newUndoRedoData.current = -1;
&#125;
<span class="copy-code-btn">复制代码</span></code></pre>
<p><code>注意:</code>由于我们用了<code>flooks</code>状态库，它目前不支持不可变数据，所以我们在报存记录的时候用了<code>深拷贝</code>,这里性能会有影响。如果不深拷贝，对象应用传递，会引发bug。之后我们会改造这个flooks,让他支持不可变数据。</p>
<ul>
<li>执行<code>undo</code>操作代码内容为</li>
</ul>
<pre><code class="copyable"> if (type === 'undo') &#123;
    // 第一次执行撤销操作
    if (current === -1) &#123;
      newUndoRedoData.current = snapshots.length - 1;
    &#125; else &#123; // 连续执行撤销操作
      newUndoRedoData.current = current - 1;
    &#125;
    // 设置当前激活的快照数据
    newUndoRedoData.activeSnapshot = snapshots[newUndoRedoData.current];
&#125;
<span class="copy-code-btn">复制代码</span></code></pre>
<ul>
<li>执行<code>redo</code>操作代码内容为</li>
</ul>
<pre><code class="copyable">if (type === 'redo') &#123;
    // 可以执行重做操作
    if (current != -1) &#123;
      newUndoRedoData.current = current + 1;
    &#125;
    // 重做操作已经到最后一步，重置激活的状态和索引
    if (current === snapshots.length - 1) &#123;
      newUndoRedoData.activeSnapshot = null;
      newUndoRedoData.current = -1;
    &#125; else &#123;
      newUndoRedoData.activeSnapshot = snapshots[newUndoRedoData.current];
    &#125;
&#125;
<span class="copy-code-btn">复制代码</span></code></pre>
<h3 data-id="heading-11">设置阈值，避免内存爆栈</h3>
<p>我们一直是在往数组里添加记录，没有做上线判断，操作多的情况下可能会引发内存爆栈。设置<code>阈值</code>来判断记录上线。代码如下</p>
<pre><code class="copyable">//阈值设置100，最多报错100次操作
let threshold = 100;
// 快照数据大于阈值
if (newUndoRedoData?.snapshots?.length > threshold) &#123;
    //保留最后的100条数据
    newUndoRedoData.snapshots = newUndoRedoData.snapshots.splice(-threshold);
&#125;
<span class="copy-code-btn">复制代码</span></code></pre>
<p>这里用了<code>Array</code>的<code>splice</code>方法，改方法<code>负值</code>会从后向前截取。</p>
<h3 data-id="heading-12">页面逻辑</h3>
<ul>
<li>撤销回退按钮</li>
</ul>
<pre><code class="copyable"> <Tooltip placement="bottom" title="撤销">
  <Button
    onClick=&#123;undo&#125;
    disabled=&#123;
      undoRedoData.snapshots.length === 0 || undoRedoData.current === 0
    &#125;
    icon=&#123;<UndoOutlined />&#125;
  />
</Tooltip>
<Tooltip placement="bottom" title="重做">
  <Button
    disabled=&#123;undoRedoData.current === -1&#125;
    onClick=&#123;redo&#125;
    icon=&#123;<RedoOutlined />&#125;
  />
</Tooltip>
<span class="copy-code-btn">复制代码</span></code></pre>
<p>这里主要注意下禁用的判断条件。</p>
<ul>
<li>主页面渲染</li>
</ul>
<pre><code class="copyable">const getJsx = () => &#123;
    // 有激活的快照数据说明有撤销或者重做的操作
    const data = undoRedoData.activeSnapshot || nodes;
    return data.map((item: DatModelItem) => &#123;
      return getJsxItem(item);
    &#125;);
&#125;;
<span class="copy-code-btn">复制代码</span></code></pre>
<h2 data-id="heading-13">地址</h2>
<ul>
<li><a href="https://link.juejin.cn/?target=http%3A%2F%2F39.97.252.98%3A3000%2F" target="_blank" rel="nofollow noopener noreferrer" title="http://39.97.252.98:3000/" ref="nofollow noopener noreferrer">演示地址</a></li>
<li><a href="https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Fjiechud%2Ffast-image-editor" target="_blank" rel="nofollow noopener noreferrer" title="https://github.com/jiechud/fast-image-editor" ref="nofollow noopener noreferrer">代码地址</a></li>
</ul>
<h2 data-id="heading-14">交流沟通</h2>
<p>建立了一个微信交流群，如需沟通讨论，请加入。</p>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/71dca834d43f4912bc8c30956e67f14a~tplv-k3u1fbpfcp-watermark.image" alt="image.png" loading="lazy" referrerpolicy="no-referrer"></p>
<p>二维码过期，请添加微信号<code>q1454763497</code>,备注<code>image editor</code>,我会拉你进群</p>
<h2 data-id="heading-15">总结</h2>
<p>以上我们实现了编辑器的撤销和重做，需要注意的是我们最好要用不可变数据，用深拷贝性能不好，最好用immer，后期我们会改造。功能部分大致代码介绍上面已经描述出来，如需要查看更详细的内容，请移步<a href="https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Fjiechud%2Ffast-image-editor" target="_blank" rel="nofollow noopener noreferrer" title="https://github.com/jiechud/fast-image-editor" ref="nofollow noopener noreferrer">fast-image-editor</a>。
大家觉得有帮忙，请在<a href="https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Fjiechud%2Ffast-image-editor" target="_blank" rel="nofollow noopener noreferrer" title="https://github.com/jiechud/fast-image-editor" ref="nofollow noopener noreferrer">github</a>帮忙star一下。</p>
<h2 data-id="heading-16">历史文章</h2>
<ul>
<li><a href="https://juejin.cn/post/6996926544182542366" target="_blank" title="https://juejin.cn/post/6996926544182542366">(开源)两个周末写了个图片编辑器</a></li>
<li><a href="https://juejin.cn/post/6997926959917318181" target="_blank" title="https://juejin.cn/post/6997926959917318181">(开源)给图片编辑器添加了辅助线</a></li>
</ul></div>  
</div>
            