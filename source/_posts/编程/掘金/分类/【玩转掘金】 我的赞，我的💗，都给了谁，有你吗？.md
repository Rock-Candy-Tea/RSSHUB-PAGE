
---
title: '【玩转掘金】 我的赞，我的💗，都给了谁，有你吗？'
categories: 
 - 编程
 - 掘金
 - 分类
headimg: 'https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/84bac01d8fa8425785ab5079462e897e~tplv-k3u1fbpfcp-watermark.image'
author: 掘金
comments: false
date: Tue, 17 Aug 2021 16:22:30 GMT
thumbnail: 'https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/84bac01d8fa8425785ab5079462e897e~tplv-k3u1fbpfcp-watermark.image'
---

<div>   
<div class="markdown-body"><style>.markdown-body&#123;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333&#125;.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6&#123;line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px&#125;.markdown-body h1&#123;font-size:30px;margin-bottom:5px&#125;.markdown-body h2&#123;padding-bottom:12px;font-size:24px;border-bottom:1px solid #ececec&#125;.markdown-body h3&#123;font-size:18px;padding-bottom:0&#125;.markdown-body h4&#123;font-size:16px&#125;.markdown-body h5&#123;font-size:15px&#125;.markdown-body h6&#123;margin-top:5px&#125;.markdown-body p&#123;line-height:inherit;margin-top:22px;margin-bottom:22px&#125;.markdown-body img&#123;max-width:100%&#125;.markdown-body hr&#123;border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px&#125;.markdown-body code&#123;word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em&#125;.markdown-body code,.markdown-body pre&#123;font-family:Menlo,Monaco,Consolas,Courier New,monospace&#125;.markdown-body pre&#123;overflow:auto;position:relative;line-height:1.75&#125;.markdown-body pre>code&#123;font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8&#125;.markdown-body a&#123;text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff&#125;.markdown-body a:active,.markdown-body a:hover&#123;color:#275b8c&#125;.markdown-body table&#123;display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6&#125;.markdown-body thead&#123;background:#f6f6f6;color:#000;text-align:left&#125;.markdown-body tr:nth-child(2n)&#123;background-color:#fcfcfc&#125;.markdown-body td,.markdown-body th&#123;padding:12px 7px;line-height:24px&#125;.markdown-body td&#123;min-width:120px&#125;.markdown-body blockquote&#123;color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8&#125;.markdown-body blockquote:after&#123;display:block;content:""&#125;.markdown-body blockquote>p&#123;margin:10px 0&#125;.markdown-body ol,.markdown-body ul&#123;padding-left:28px&#125;.markdown-body ol li,.markdown-body ul li&#123;margin-bottom:0;list-style:inherit&#125;.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item&#123;list-style:none&#125;.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul&#123;margin-top:0&#125;.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul&#123;margin-top:3px&#125;.markdown-body ol li&#123;padding-left:6px&#125;.markdown-body .contains-task-list&#123;padding-left:0&#125;.markdown-body .task-list-item&#123;list-style:none&#125;@media (max-width:720px)&#123;.markdown-body h1&#123;font-size:24px&#125;.markdown-body h2&#123;font-size:20px&#125;.markdown-body h3&#123;font-size:18px&#125;&#125;</style><p>这是我参与8月更文挑战的第18天，活动详情查看：<a href="https://juejin.cn/post/6987962113788493831" title="https://juejin.cn/post/6987962113788493831" target="_blank">8月更文挑战</a>。</p>
<h2 data-id="heading-0">前言</h2>
<p><a href="https://juejin.cn/column/6993674706347884580" target="_blank" title="https://juejin.cn/column/6993674706347884580">玩转掘金</a> 系列，对掘金扩展一些有意思的功能，比如：</p>
<ul>
<li><a href="https://juejin.cn/post/6990140519342932004" target="_blank" title="https://juejin.cn/post/6990140519342932004">【玩转掘金】掘金专栏文章正生成pdf文档</a></li>
<li><a href="https://juejin.cn/post/6995717142318415880" target="_blank" title="https://juejin.cn/post/6995717142318415880">【玩转掘金】掘金签约作者，战力参数分析，数据篇</a></li>
</ul>
<p>某天进入个人主页一看，自己已经给别人点赞过<code>千</code>了，我滴个神。<br>
作为新人，互相支持一下，也算正常，我的这些💗，都给了谁呢，追寻真像，自己动手实现一个吧。</p>
<h2 data-id="heading-1">效果演示</h2>
<p><strong>详情列表是可以点击进入文章页面的</strong><br>
<img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/84bac01d8fa8425785ab5079462e897e~tplv-k3u1fbpfcp-watermark.image" alt="stars.gif" loading="lazy" referrerpolicy="no-referrer"></p>
<h2 data-id="heading-2">源码地址</h2>
<p>源码地址：<strong><a href="https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Fxiangwenhu%2FjuejinBlogsCodes%2Ftree%2Fmaster%2FJJMyStarAndC" target="_blank" rel="nofollow noopener noreferrer" title="https://github.com/xiangwenhu/juejinBlogsCodes/tree/master/JJMyStarAndC" ref="nofollow noopener noreferrer">JJMyStarAndC </a></strong></p>
<p>后端服务采用nodejs编写，你需要安装对应的安装包。</p>
<h2 data-id="heading-3">实现思路</h2>
<p>可行的思路：</p>
<ol>
<li>Chrome插件 + 游猴脚本</li>
<li>静态页面 + nginx代理</li>
<li>静态页面 + 服务转发</li>
<li>......</li>
</ol>
<p>本文的思路是  <code>静态页面</code> + <code>nodejs自定义服务</code>,<br>
纯属为了好玩额外用了 <a href="https://link.juejin.cn/?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-TW%2Fdocs%2FWeb%2FAPI%2FServer-sent_events" target="_blank" rel="nofollow noopener noreferrer" title="https://developer.mozilla.org/zh-TW/docs/Web/API/Server-sent_events" ref="nofollow noopener noreferrer">Server Sent Events</a> , 简称SSE，服务器端单边推送，<strong>其作用是服务端获取数据后，单边推动给客服端。</strong></p>
<p>有人可能会说，咋不用 <code>socket.io</code>, 我这里额外说一下， <code>socket.io</code>号称socket中的jQuery， 这个意思，大家懂了吧，而且还要配套其服务端库一起使用，讨厌！！</p>
<p>更好的实现方案：透传即可<br>
<code>express</code> + <code>http-proxy-middleware</code></p>
<h2 data-id="heading-4">实现细节</h2>
<h3 data-id="heading-5">数据获取</h3>
<p>一切均围绕数据展开，没有数据，别画饼，别谈理想。</p>
<p>对于Star获取，一个接口足以！</p>
<p><strong>请求地址：</strong> <a href="https://api.juejin.cn/interact_api/v1/digg/query_page" target="_blank" title="https://api.juejin.cn/interact_api/v1/digg/query_page">api.juejin.cn/interact_ap…</a><br>
<strong>请求方式：</strong> <strong>post</strong><br>
<strong>请求参数：</strong><br>
其有没有隐藏的<code>limit</code>参数选项呢？ 大家可以尝试一波！</p>
<pre><code class="hljs language-js copyable" lang="js"> &#123;
    <span class="hljs-attr">cursor</span>: <span class="hljs-string">`<span class="hljs-subst">$&#123;cursor&#125;</span>`</span>,  <span class="hljs-comment">// 起始查询位置</span>
    <span class="hljs-attr">item_type</span>: <span class="hljs-number">2</span>,    <span class="hljs-comment">// 文章点赞，对应有沸点点赞</span>
    <span class="hljs-attr">sort_type</span>: <span class="hljs-number">2</span>,   <span class="hljs-comment">// 排序，有近导员</span>
    <span class="hljs-attr">user_id</span>: uid, <span class="hljs-comment">// 用户id</span>
  &#125;
<span class="copy-code-btn">复制代码</span></code></pre>
<p><strong>返回结果：</strong></p>
<pre><code class="hljs language-js copyable" lang="js">&#123;
   <span class="hljs-attr">has_more</span>: <span class="hljs-literal">true</span>,
   <span class="hljs-attr">data</span>: [&#123;
       <span class="hljs-attr">author_user_info</span>:&#123;
           <span class="hljs-attr">user_id</span>: <span class="hljs-string">"3465271329953806"</span>, <span class="hljs-comment">// 用户ID</span>
           <span class="hljs-attr">user_name</span>: <span class="hljs-string">"小魔童哪吒"</span> <span class="hljs-comment">// 用户名</span>
       &#125;, 
       <span class="hljs-attr">article_info</span>: &#123;
           <span class="hljs-attr">article_id</span>: <span class="hljs-string">"6996484371305725965"</span>  <span class="hljs-comment">// 文章ID</span>
           <span class="hljs-attr">title</span>: <span class="hljs-string">"k8s 学习二"</span>  <span class="hljs-comment">// 文章标题</span>
       &#125;
   &#125;]
&#125;
<span class="copy-code-btn">复制代码</span></code></pre>
<p>请求的时候， <code>cursor</code>参数非常重要，表示指针位置，从哪继续往后走。<br>
返回结果里面，很重要的字段<code>has_more</code>， 表示还没有数据，如果有，继续获取。</p>
<p>掘金很多的接口，起初没做限制的，当初我记得某些接口可以传入<code>limit</code>参数为1000，也可以，后来做了改进，值得赞一波。</p>
<p>其循环获取核心代码：</p>
<pre><code class="hljs language-js copyable" lang="js"> <span class="hljs-keyword">while</span> (res.has_more) &#123;
    data.cursor = <span class="hljs-string">`<span class="hljs-subst">$&#123;cursor&#125;</span>`</span>
    
    res = (<span class="hljs-keyword">await</span> axios.default.post(url, data, &#123;
      headers
    &#125;)).data;
    
    cursor += <span class="hljs-number">10</span>;
    <span class="hljs-keyword">await</span> delay(<span class="hljs-literal">undefined</span>, <span class="hljs-number">16</span>).run();  <span class="hljs-comment">// 暂停16ms, 故意的</span>
  &#125;
<span class="copy-code-btn">复制代码</span></code></pre>
<p>我们说了，这里是服务端获取了数据，还没推动到前端。</p>
<h3 data-id="heading-6">数据推送</h3>
<p>nodejs端使用SSE，也很简单，我这里就没有使用三方库了。</p>
<ol>
<li>request传了uid，rid两个参数
uid表示用户ID, rid表示requestId</li>
<li><code>getStars</code> 表示开始查询</li>
<li>SSE的核心就在于<code>Content-Type</code>与<code>Connection</code><br>
<code>'Content-Type': 'text/event-stream'</code>申明类型<br>
<code>'Connection': 'keep-alive'</code>表示不关闭连接</li>
<li>因为这里也属于一个请求，所以我们借助事件中心来派发事件给请求，请求再回写数据</li>
</ol>
<pre><code class="hljs language-js copyable" lang="js">app.get(<span class="hljs-string">'/sseStream'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">request, response</span>) </span>&#123;
  response.writeHead(<span class="hljs-number">200</span>, &#123;
    <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'text/event-stream'</span>,
    <span class="hljs-string">'Cache-Control'</span>: <span class="hljs-string">'no-cache'</span>,
    <span class="hljs-string">'Connection'</span>: <span class="hljs-string">'keep-alive'</span>
  &#125;);

  <span class="hljs-keyword">const</span> &#123; uid, rid &#125; = request.query;
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"uid:"</span>, uid);

  <span class="hljs-comment">// 查询用户的点赞</span>
  getStars(uid, rid);

  <span class="hljs-comment">// 产线可别这么用</span>
  eventsCenter.removeAllListeners(<span class="hljs-string">"ssePush"</span>);
  <span class="hljs-comment">// 事件中心</span>
  eventsCenter.on(<span class="hljs-string">"ssePush"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">event, data</span>) </span>&#123;
    <span class="hljs-comment">// console.log("push message to clients");</span>
    response.write(<span class="hljs-string">"event: "</span> + <span class="hljs-built_in">String</span>(event) + <span class="hljs-string">"\n"</span> + <span class="hljs-string">"data: "</span> + <span class="hljs-built_in">JSON</span>.stringify(data) + <span class="hljs-string">"\n\n"</span>);

  &#125;);
&#125;);
<span class="copy-code-btn">复制代码</span></code></pre>
<p>那事件是哪派发出来的，就是数据获取那里派发的，我补上代码, 这里多了两种外的事件<code>messageTotal</code>, <code>messageEnd</code>, 一个是总数消息，有个是表示请求结束的消息。</p>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getStars</span>(<span class="hljs-params">uid, rid</span>) </span>&#123;
  <span class="hljs-keyword">let</span> cursor = <span class="hljs-number">0</span>
  <span class="hljs-keyword">const</span> data = &#123;
    <span class="hljs-attr">cursor</span>: <span class="hljs-string">`<span class="hljs-subst">$&#123;cursor&#125;</span>`</span>,
    <span class="hljs-attr">item_type</span>: <span class="hljs-number">2</span>,
    <span class="hljs-attr">sort_type</span>: <span class="hljs-number">2</span>,
    <span class="hljs-attr">user_id</span>: uid,
  &#125;
  <span class="hljs-keyword">let</span> res = &#123;
    <span class="hljs-attr">has_more</span>: <span class="hljs-literal">true</span>
  &#125;;

  <span class="hljs-keyword">while</span> (res.has_more) &#123;
    data.cursor = <span class="hljs-string">`<span class="hljs-subst">$&#123;cursor&#125;</span>`</span>

    res = (<span class="hljs-keyword">await</span> axios.default.post(url, data, &#123;
      headers
    &#125;)).data;

    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"res:"</span>, data, res)

    eventsCenter.emit(<span class="hljs-string">"ssePush"</span>, <span class="hljs-string">"messageTotal"</span>, &#123;
      uid,
      rid,
      <span class="hljs-attr">count</span>: res.count
    &#125;);
    eventsCenter.emit(<span class="hljs-string">"ssePush"</span>, <span class="hljs-string">"message"</span>, &#123;
      uid,
      rid,
      <span class="hljs-attr">datas</span>: (res.data || []).map(<span class="hljs-function"><span class="hljs-params">d</span> =></span> (&#123;
        <span class="hljs-attr">user_id</span>: d.author_user_info.user_id,
        <span class="hljs-attr">user_name</span>: d.author_user_info.user_name,
        <span class="hljs-attr">title</span>: d.article_info.title
      &#125;))
    &#125;);
    cursor += <span class="hljs-number">10</span>;
    <span class="hljs-keyword">await</span> delay(<span class="hljs-literal">undefined</span>, <span class="hljs-number">16</span>).run();
  &#125;
  eventsCenter.emit(<span class="hljs-string">"ssePush"</span>, <span class="hljs-string">"messageEnd"</span>, &#123;
    uid,
    rid
  &#125;)
&#125;
<span class="copy-code-btn">复制代码</span></code></pre>
<h3 data-id="heading-7">前端数据获取</h3>
<p>前台对应监听事件就好了, 就这么简单。</p>
<pre><code class="hljs language-js copyable" lang="js">    <span class="hljs-keyword">const</span> source = <span class="hljs-keyword">new</span> EventSource(<span class="hljs-string">`/sseStream?uid=<span class="hljs-subst">$&#123;uid&#125;</span>&rid=<span class="hljs-subst">$&#123;rid&#125;</span>`</span>);

    <span class="hljs-comment">// 收到新数据</span>
    source.addEventListener(<span class="hljs-string">'message'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">e</span>) </span>&#123;
        <span class="hljs-keyword">let</span> data = <span class="hljs-built_in">JSON</span>.parse(e.data)
        <span class="hljs-comment">// 不是需要的数据</span>
        <span class="hljs-keyword">if</span> (data.uid != uid || data.rid != rid) &#123;
            <span class="hljs-keyword">return</span>;
        &#125;

        listArr.push(...data.datas);
        <span class="hljs-comment">// console.log("listArr:", listArr);</span>
        renderList(listArr);
        gotStarsEl.innerHTML = listArr.length;

    &#125;, <span class="hljs-literal">false</span>)

    <span class="hljs-comment">// 收到总数据消息</span>
    source.addEventListener(<span class="hljs-string">'messageTotal'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">e</span>) </span>&#123;
        <span class="hljs-keyword">let</span> data = <span class="hljs-built_in">JSON</span>.parse(e.data)

        <span class="hljs-comment">// 不是需要的数据</span>
        <span class="hljs-keyword">if</span> (data.uid != uid || data.rid != rid) &#123;
            <span class="hljs-keyword">return</span>;
        &#125;
        totalStarsEl.innerHTML = data.count;
    &#125;, <span class="hljs-literal">false</span>)

    <span class="hljs-comment">// 统计完毕</span>
    source.addEventListener(<span class="hljs-string">'messageEnd'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">e</span>) </span>&#123;
        <span class="hljs-keyword">let</span> data = <span class="hljs-built_in">JSON</span>.parse(e.data)
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"meesage"</span>, data);
    &#125;, <span class="hljs-literal">false</span>)
<span class="copy-code-btn">复制代码</span></code></pre>
<h3 data-id="heading-8">统计和分组</h3>
<ol>
<li>统计： 以用户ID为key，没有则新建，有则修改基数。</li>
<li>对keys进行map转数组，然后sort。</li>
</ol>
<p>就这么简单！</p>
<pre><code class="hljs language-js copyable" lang="js">    <span class="hljs-keyword">const</span> statObj = list.reduce(<span class="hljs-function">(<span class="hljs-params">obj, cur</span>) =></span> &#123;
        <span class="hljs-keyword">if</span> (hasOwnProperty.call(obj, cur.user_id)) &#123;
            obj[cur.user_id].count += <span class="hljs-number">1</span>;
            obj[cur.user_id].items.push(cur);
        &#125; <span class="hljs-keyword">else</span> &#123;
            obj[cur.user_id] = &#123;
                <span class="hljs-attr">items</span>: [cur],
                <span class="hljs-attr">count</span>: <span class="hljs-number">1</span>,
                ...cur
            &#125;;
        &#125;
        <span class="hljs-keyword">return</span> obj;
    &#125;, &#123;&#125;);

    <span class="hljs-comment">// 分组</span>
    <span class="hljs-keyword">const</span> groupList = <span class="hljs-built_in">Object</span>
        .keys(statObj)
        .map(<span class="hljs-function"><span class="hljs-params">k</span> =></span> statObj[k])  <span class="hljs-comment">//分组</span>
        .sort(<span class="hljs-function">(<span class="hljs-params">a, b</span>) =></span> a.count > b.count ? -<span class="hljs-number">1</span> : <span class="hljs-number">1</span>);  <span class="hljs-comment">// 排序</span>
<span class="copy-code-btn">复制代码</span></code></pre>
<p>更多的实现细节，请移步源码。</p>
<h2 data-id="heading-9">写在最后</h2>
<p>3-5分钟，500-1000字，有所得，而不为所累，如果你觉得不错，你的一赞一评就是我前行的最大动力。</p>
<p>技术交流群请到 <a href="https://juejin.cn/pin/6994350401550024741" title="https://juejin.cn/pin/6994350401550024741" target="_blank">这里来</a>。
或者添加我的微信 dirge-cloud，一起学习。</p></div>  
</div>
            