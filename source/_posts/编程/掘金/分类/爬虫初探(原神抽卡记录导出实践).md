
---
title: '爬虫初探(原神抽卡记录导出实践)'
categories: 
 - 编程
 - 掘金
 - 分类
headimg: 'https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/fa1781975eac43b18ec5fde5f14f022a~tplv-k3u1fbpfcp-watermark.image'
author: 掘金
comments: false
date: Sat, 10 Apr 2021 01:16:51 GMT
thumbnail: 'https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/fa1781975eac43b18ec5fde5f14f022a~tplv-k3u1fbpfcp-watermark.image'
---

<div>   
<div class="markdown-body"><style>.markdown-body&#123;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333&#125;.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6&#123;line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px&#125;.markdown-body h1&#123;font-size:30px;margin-bottom:5px&#125;.markdown-body h2&#123;padding-bottom:12px;font-size:24px;border-bottom:1px solid #ececec&#125;.markdown-body h3&#123;font-size:18px;padding-bottom:0&#125;.markdown-body h4&#123;font-size:16px&#125;.markdown-body h5&#123;font-size:15px&#125;.markdown-body h6&#123;margin-top:5px&#125;.markdown-body p&#123;line-height:inherit;margin-top:22px;margin-bottom:22px&#125;.markdown-body img&#123;max-width:100%&#125;.markdown-body hr&#123;border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px&#125;.markdown-body code&#123;word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em&#125;.markdown-body code,.markdown-body pre&#123;font-family:Menlo,Monaco,Consolas,Courier New,monospace&#125;.markdown-body pre&#123;overflow:auto;position:relative;line-height:1.75&#125;.markdown-body pre>code&#123;font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8&#125;.markdown-body a&#123;text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff&#125;.markdown-body a:active,.markdown-body a:hover&#123;color:#275b8c&#125;.markdown-body table&#123;display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6&#125;.markdown-body thead&#123;background:#f6f6f6;color:#000;text-align:left&#125;.markdown-body tr:nth-child(2n)&#123;background-color:#fcfcfc&#125;.markdown-body td,.markdown-body th&#123;padding:12px 7px;line-height:24px&#125;.markdown-body td&#123;min-width:120px&#125;.markdown-body blockquote&#123;color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8&#125;.markdown-body blockquote:after&#123;display:block;content:""&#125;.markdown-body blockquote>p&#123;margin:10px 0&#125;.markdown-body ol,.markdown-body ul&#123;padding-left:28px&#125;.markdown-body ol li,.markdown-body ul li&#123;margin-bottom:0;list-style:inherit&#125;.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item&#123;list-style:none&#125;.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul&#123;margin-top:0&#125;.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul&#123;margin-top:3px&#125;.markdown-body ol li&#123;padding-left:6px&#125;.markdown-body .contains-task-list&#123;padding-left:0&#125;.markdown-body .task-list-item&#123;list-style:none&#125;@media (max-width:720px)&#123;.markdown-body h1&#123;font-size:24px&#125;.markdown-body h2&#123;font-size:20px&#125;.markdown-body h3&#123;font-size:18px&#125;&#125;</style><h1 data-id="heading-0">背景</h1>
<p>  二月份入坑了原神，原神的抽卡记录网页没有汇总的扇形图且展示Table被定死为了6，对于自己抽卡次数，每次的出货频率以及下一次保底的距离的计算是很麻烦的，本着技术服务生活，于是我打算自制一个网页,用于获取原神抽卡数据,自制为更加清晰的统计+扇形图展示<br>
  先上结果图～</p>
<p><img alt="image.png" class="lazyload" src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/fa1781975eac43b18ec5fde5f14f022a~tplv-k3u1fbpfcp-watermark.image" data-width="800" data-height="600" referrerpolicy="no-referrer"></p>
<h1 data-id="heading-1">预备工作</h1>
<p>  获取原神抽卡页面的URL,手机打开原神抽卡页面,开启飞行模式，刷新页面即可获得一个错误网页，将其URL复制下来即可
<img alt="BBA2EE465EBCE68C7A65726D71282E8D.jpg" class="lazyload" src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7cdb9a6d77fe4329a6b859f6d57c820e~tplv-k3u1fbpfcp-watermark.image" data-width="800" data-height="600" referrerpolicy="no-referrer"></p>
<h1 data-id="heading-2">获取数据的几种尝试</h1>
<h3 data-id="heading-3">静态爬虫</h3>
<p>  初探爬虫我做的第一件事就是去百度,看网上说的爬取一个网页只需要用http或者一些第三方库访问对应页面,获取dom节点中的元素即可。于是开始了我的第一次尝试,我采用的是<code>superagent</code>库</p>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// 引入所需要的第三方包</span>
<span class="hljs-keyword">const</span> superagent= <span class="hljs-built_in">require</span>(<span class="hljs-string">'superagent'</span>);
<span class="hljs-keyword">let</span> recordData = [];
superagent.get(<span class="hljs-string">'目标URL'</span>).end(<span class="hljs-function">(<span class="hljs-params">err, res</span>) =></span> &#123;
<span class="hljs-keyword">if</span> (err) &#123;
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`抽卡记录抓取失败 - <span class="hljs-subst">$&#123;err&#125;</span>`</span>)
&#125; <span class="hljs-keyword">else</span> &#123;
 <span class="hljs-comment">// 抓取热点新闻数据</span>
 recordData = getRecord(res);<span class="hljs-comment">// 从res中</span>
&#125;
&#125;);

<span class="hljs-keyword">const</span> cheerio = <span class="hljs-built_in">require</span>(<span class="hljs-string">'cheerio'</span>);
<span class="hljs-keyword">let</span> getRecord = <span class="hljs-function">(<span class="hljs-params">res</span>) =></span> &#123;
<span class="hljs-keyword">let</span> recordData = [];

<span class="hljs-comment">/* 使用cheerio模块的cherrio.load()方法，将HTMLdocument作为参数传入函数
   以后就可以使用类似jQuery的$(selectior)的方式来获取页面元素
 */</span>
<span class="hljs-keyword">let</span> $ = cheerio.load(res.text);

<span class="hljs-comment">// 找到目标数据所在的页面元素，获取数据</span>
$(<span class="hljs-string">'.table-content>div>type'</span>).each(<span class="hljs-function">(<span class="hljs-params">idx, ele</span>) =></span> &#123;
  <span class="hljs-comment">// cherrio中$('selector').each()用来遍历所有匹配到的DOM元素</span>
  <span class="hljs-comment">// 参数idx是当前遍历的元素的索引，ele就是当前便利的DOM元素</span>
  recordData.push(&#123;
      <span class="hljs-attr">type</span>:$(ele).text()
  &#125;)              <span class="hljs-comment">// 存入最终结果数组</span>
&#125;);
<span class="hljs-comment">// ... 将其他数据填入数组</span>
<span class="hljs-keyword">return</span> recordData
&#125;;
<span class="copy-code-btn">复制代码</span></code></pre>
<p>  于是尴尬的事情发生了,我一步一步<code>log</code> 发现返回的res里面压根就没有内部的表格元素,查阅资料以后才知道是因为<code>Table</code>的数据是请求了另一个接口获取的,对于这种动态页面有两种方案<br>采取能够模拟浏览器或者通过抓包分析接口,自行请求。</p>
<h3 data-id="heading-4">模拟浏览器</h3>
<p>  模拟浏览器我采取了<code>puppeteer</code>库,通过模拟对于按钮，选择器的点击进行不同的请求从而获取最终的数据</p>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-keyword">const</span> puppeteer = <span class="hljs-built_in">require</span>(<span class="hljs-string">"puppeteer"</span>);
<span class="hljs-keyword">const</span> TEST_URL =<span class="hljs-string">""</span>
<span class="hljs-keyword">const</span> getTargetData = <span class="hljs-keyword">async</span> () => &#123;
  <span class="hljs-comment">// 启动浏览器</span>
  <span class="hljs-keyword">const</span> browser = <span class="hljs-keyword">await</span> puppeteer.launch(&#123;
    <span class="hljs-attr">headless</span>: <span class="hljs-literal">false</span>, <span class="hljs-comment">// 默认是无头模式，这里为了示范所以使用正常模式</span>
  &#125;);

  <span class="hljs-comment">// 控制浏览器打开新标签页面</span>
  <span class="hljs-keyword">const</span> page = <span class="hljs-keyword">await</span> browser.newPage();
  page.setViewport(&#123;
    <span class="hljs-attr">width</span>: <span class="hljs-number">0</span>,
    <span class="hljs-attr">height</span>: <span class="hljs-number">1500</span>,
  &#125;);
  <span class="hljs-comment">// 在新标签中打开要爬取的网页</span>
  <span class="hljs-keyword">await</span> page.goto(TEST_URL);
  <span class="hljs-comment">// 存储数据</span>
  <span class="hljs-keyword">const</span> types = [];
  <span class="hljs-keyword">const</span> names = [];
  <span class="hljs-keyword">const</span> dates = [];
  <span class="hljs-keyword">let</span> poolSelect = [
    &#123; <span class="hljs-attr">poolName</span>: <span class="hljs-string">"常驻"</span>, <span class="hljs-attr">records</span>: [] &#125;,
    &#123; <span class="hljs-attr">poolName</span>: <span class="hljs-string">"新手"</span>, <span class="hljs-attr">records</span>: [] &#125;,
    &#123; <span class="hljs-attr">poolName</span>: <span class="hljs-string">"角色"</span>, <span class="hljs-attr">records</span>: [] &#125;,
    &#123; <span class="hljs-attr">pullName</span>: <span class="hljs-string">"武器"</span>, <span class="hljs-attr">records</span>: [] &#125;,
  ];
  <span class="hljs-keyword">return</span>  <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =></span> &#123;
    <span class="hljs-keyword">const</span> loadData = <span class="hljs-keyword">async</span> (index) => &#123;
      <span class="hljs-keyword">let</span> end = <span class="hljs-literal">false</span>;
      <span class="hljs-keyword">await</span> page.waitForTimeout(<span class="hljs-number">600</span> * index);
      <span class="hljs-keyword">await</span> page.click(<span class="hljs-string">".select-container"</span>);
      <span class="hljs-keyword">await</span> page.waitForSelector(<span class="hljs-string">".ul-list"</span>);
      <span class="hljs-keyword">await</span> page.click(<span class="hljs-string">`.item:nth-child(<span class="hljs-subst">$&#123;index+<span class="hljs-number">1</span>&#125;</span>)`</span>);
      <span class="hljs-keyword">await</span> page.waitForTimeout(<span class="hljs-number">300</span>);
      <span class="hljs-keyword">while</span> (!end) &#123;
        <span class="hljs-keyword">const</span> &#123; currentData, length &#125; = <span class="hljs-keyword">await</span> page.evaluate(<span class="hljs-keyword">async</span> () => &#123;
          <span class="hljs-comment">// 因为需要请求时间 所以需要一个delay</span>
          <span class="hljs-keyword">const</span> getData = <span class="hljs-keyword">async</span> () => &#123;
            <span class="hljs-keyword">const</span> currentTypes = <span class="hljs-built_in">document</span>
              .querySelectorAll(<span class="hljs-string">".table-content>div"</span>)[<span class="hljs-number">1</span>]
              .querySelectorAll(<span class="hljs-string">".type"</span>);
            <span class="hljs-keyword">const</span> currentNames = <span class="hljs-built_in">document</span>
              .querySelectorAll(<span class="hljs-string">".table-content>div"</span>)[<span class="hljs-number">1</span>]
              .querySelectorAll(<span class="hljs-string">".name"</span>);
            <span class="hljs-keyword">const</span> currentTimes = <span class="hljs-built_in">document</span>
              .querySelectorAll(<span class="hljs-string">".table-content>div"</span>)[<span class="hljs-number">1</span>]
              .querySelectorAll(<span class="hljs-string">".time"</span>);
            <span class="hljs-keyword">const</span> currentData = [...currentTypes].map(<span class="hljs-function">(<span class="hljs-params">item, index</span>) =></span> &#123;
              <span class="hljs-keyword">const</span> [name, level] = currentNames[index].innerHTML
                .split(<span class="hljs-string">"\n"</span>)
                .filter(
                  <span class="hljs-function">(<span class="hljs-params">item</span>) =></span>
                    item != <span class="hljs-literal">undefined</span> &&
                    item != <span class="hljs-literal">null</span> &&
                    item.trim().length !== <span class="hljs-number">0</span>
                )
                .map(<span class="hljs-function">(<span class="hljs-params">item</span>) =></span> item.trim());
              <span class="hljs-keyword">return</span> &#123;
                <span class="hljs-attr">type</span>: currentTypes[index].innerHTML,
                name,
                <span class="hljs-attr">level</span>: level ? level : <span class="hljs-string">"(三星)"</span>,
                <span class="hljs-attr">time</span>: currentTimes[index].innerHTML,
              &#125;;
            &#125;);
            <span class="hljs-built_in">console</span>.log(currentData);

            <span class="hljs-keyword">return</span> &#123;
              <span class="hljs-attr">length</span>: currentTypes.length,
              currentData,
            &#125;;
          &#125;;
          <span class="hljs-keyword">let</span> &#123; length, currentData &#125; = <span class="hljs-keyword">await</span> getData();
          <span class="hljs-built_in">console</span>.log(currentData);
          <span class="hljs-keyword">return</span> &#123;
            length,
            currentData,
          &#125;;
        &#125;);
        poolSelect[index] = &#123;
          ...poolSelect[index],
          <span class="hljs-attr">records</span>: [...poolSelect[index].records, ...currentData],
        &#125;;

        <span class="hljs-keyword">if</span> (length < <span class="hljs-number">6</span>) &#123;
          end = <span class="hljs-literal">true</span>;
          <span class="hljs-keyword">if</span> (index >= poolSelect.length) &#123;
            <span class="hljs-keyword">break</span>;
          &#125;
          loadData(index + <span class="hljs-number">1</span>);
        &#125; <span class="hljs-keyword">else</span> &#123;
          page.click(<span class="hljs-string">".page-item.to-next.selected"</span>);
          <span class="hljs-keyword">await</span> page.waitForTimeout(<span class="hljs-number">300</span>);
        &#125;
      &#125;
    &#125;;
    loadData(<span class="hljs-number">0</span>);
    resolve(poolSelect);
  &#125;)
    .then(<span class="hljs-function">(<span class="hljs-params">res</span>) =></span> <span class="hljs-built_in">console</span>.log(res))
    .catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =></span> <span class="hljs-built_in">console</span>.log(err));
&#125;;
<span class="copy-code-btn">复制代码</span></code></pre>
<p>这回是可以获取一些数据的,但是可能是因为我网络的原因，对于一些请求速度较慢的数据产生了丢失，需要增长点击以后的等待时间才能正确的获取数据,那这样就导致爬取的时间很长。</p>
<h3 data-id="heading-5">抓包分析接口</h3>
<p>抓包我采取的是 Mac 的 <code>Charles</code>青花瓷。访问目标网站即可抓包<br></p>
<h4 data-id="heading-6">踩了一些坑</h4>
<ul>
<li>抓到的数据包访问的显示是<code><unknown></code>，<img alt="image.png" class="lazyload" src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2ddee206c4184e05a5c00b096ced2faf~tplv-k3u1fbpfcp-watermark.image" data-width="800" data-height="600" referrerpolicy="no-referrer"></li>
</ul>
<p>这是因为原神抽卡记录的网址是https。需要配置<code>SSL Proxying</code></p>
<ul>
<li><code>Help>SSL Proxying>Install Charles Root Certificate</code> 然后在<code>钥匙串</code>对于证书配置<code>始终信任</code>
<img alt="image.png" class="lazyload" src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2d42c58cff05421db7370b0950d585ba~tplv-k3u1fbpfcp-watermark.image" data-width="800" data-height="600" referrerpolicy="no-referrer"></li>
<li>以上是搜索到的内容,但是我昨晚这些仍然显示<code>unknown</code>，后来发现还需要<code>Proxy>SSL Proxy Setting</code>中设置</li>
</ul>
<p><img alt="image.png" class="lazyload" src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3329d3a75d4e4e37953b3b95fc236a7c~tplv-k3u1fbpfcp-watermark.image" data-width="800" data-height="600" referrerpolicy="no-referrer"></p>
<ul>
<li>做完以上工作以后就可以开始对于数据包分析了</li>
</ul>
<p><img alt="image.png" class="lazyload" src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/77005bbdf9834cd7846cf5b78ff49118~tplv-k3u1fbpfcp-watermark.image" data-width="800" data-height="600" referrerpolicy="no-referrer"></p>
<h4 data-id="heading-7">正式编码</h4>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-keyword">const</span> router = <span class="hljs-built_in">require</span>(<span class="hljs-string">"koa-router"</span>)();
<span class="hljs-keyword">const</span> https = <span class="hljs-built_in">require</span>(<span class="hljs-string">"https"</span>);
<span class="hljs-keyword">const</span> queryString = <span class="hljs-built_in">require</span>(<span class="hljs-string">"query-string"</span>);
<span class="hljs-keyword">const</span> targetUrl =
<span class="hljs-string">"https://hk4e-api.mihoyo.com/event/gacha_info/api/getGachaLog"</span>;
router.get(<span class="hljs-string">"/test"</span>, <span class="hljs-keyword">async</span> (ctx, next) => &#123;
<span class="hljs-keyword">const</span> &#123; url &#125; = ctx.request.query;
<span class="hljs-keyword">const</span> &#123; query &#125; = queryString.parseUrl(url);
<span class="hljs-comment">// 新手100 常驻200 角色301 武器302</span>
<span class="hljs-keyword">const</span> gacha_types = [<span class="hljs-number">100</span>,<span class="hljs-number">200</span>,<span class="hljs-number">301</span>,<span class="hljs-number">302</span>];
<span class="hljs-keyword">const</span> page = <span class="hljs-number">1</span>;
<span class="hljs-keyword">const</span> size = <span class="hljs-number">6</span>;
<span class="hljs-keyword">const</span> end_id = <span class="hljs-number">0</span>;
<span class="hljs-keyword">const</span> createReq = <span class="hljs-function">(<span class="hljs-params">page, size, gacha_type, end_id</span>) =></span> &#123;
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =></span> &#123;
    <span class="hljs-comment">// 抓包可知 首次请求end_id 为 0 之后每下一页 end_id 为上一页的最后一个,直到返回结果长度小于size说明最大,结束递归</span>
    <span class="hljs-keyword">const</span> targetQuery = &#123; ...query, gacha_type, page, size, end_id &#125;;
    <span class="hljs-keyword">const</span> finalUrl = <span class="hljs-string">`<span class="hljs-subst">$&#123;targetUrl&#125;</span>?<span class="hljs-subst">$&#123;queryString.stringify(targetQuery)&#125;</span>`</span>;
    https.get(finalUrl,  <span class="hljs-function">(<span class="hljs-params">res</span>) =></span> &#123;
      <span class="hljs-keyword">let</span> info = <span class="hljs-string">""</span>;
      res.on(<span class="hljs-string">"data"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">chunk</span>) </span>&#123;
        info += chunk;
      &#125;);

      res.on(<span class="hljs-string">"end"</span>, <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err</span>) </span>&#123;
        <span class="hljs-keyword">const</span> resultList = <span class="hljs-built_in">JSON</span>.parse(info).data.list;
        <span class="hljs-keyword">if</span> (resultList.length < size) &#123;
          <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`====正在请求==<span class="hljs-subst">$&#123;gacha_type&#125;</span>==页码<span class="hljs-subst">$&#123;page&#125;</span>`</span>);
          <span class="hljs-keyword">return</span> resolve(resultList);
        &#125;
        <span class="hljs-comment">// end_id 上一页最后一个 </span>
        <span class="hljs-keyword">const</span> afterResultList = <span class="hljs-keyword">await</span> createReq(page + <span class="hljs-number">1</span>, size, gacha_type, resultList[resultList.length-<span class="hljs-number">1</span>].id)
        resolve([
          ...resultList,
          ...afterResultList
        ]);
      &#125;);
    &#125;);
  &#125;);
&#125;;
ctx.body = <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =></span> &#123;
  <span class="hljs-keyword">const</span> promiseList = gacha_types.map(<span class="hljs-function">(<span class="hljs-params">gacha_type</span>) =></span> &#123;
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-keyword">async</span> (resolve) => &#123;
      <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> createReq(page, size, gacha_type, end_id);
      resolve(&#123;
        gacha_type,
        <span class="hljs-attr">data</span>: (<span class="hljs-keyword">await</span> createReq(page, size, gacha_type, end_id)).reverse(),
      &#125;);
    &#125;);
  &#125;);
  resolve(
    <span class="hljs-built_in">Promise</span>.all(promiseList).then(<span class="hljs-function">(<span class="hljs-params">values</span>) =></span> &#123;
      <span class="hljs-built_in">console</span>.log(values);
      <span class="hljs-keyword">return</span> values;
    &#125;)
  );
&#125;);
&#125;);
<span class="copy-code-btn">复制代码</span></code></pre>
<h1 data-id="heading-8">前端编码</h1>
<p>使用<code>antd+umi+axios+echarts</code>进行前端页面的Code.<br></p>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">//App.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>&#123;
  <span class="hljs-keyword">const</span> [url, setUrl] = useState(<span class="hljs-string">''</span>);
  <span class="hljs-keyword">const</span> [loading, setLoading] = useState(<span class="hljs-literal">false</span>);
  <span class="hljs-keyword">const</span> [result, setResult] = useState(&#123;&#125;);
  <span class="hljs-keyword">const</span> poolNameMap = &#123;
    <span class="hljs-attr">newHandPool</span>: &#123;
      <span class="hljs-attr">gacha_type</span>: <span class="hljs-number">100</span>,
      <span class="hljs-attr">name</span>: <span class="hljs-string">'新手池'</span>,
    &#125;,
    <span class="hljs-attr">alwaysPool</span>: &#123;
      <span class="hljs-attr">gacha_type</span>: <span class="hljs-number">200</span>,
      <span class="hljs-attr">name</span>: <span class="hljs-string">'常驻池'</span>,
    &#125;,
    <span class="hljs-attr">rolePool</span>: &#123;
      <span class="hljs-attr">gacha_type</span>: <span class="hljs-number">301</span>,
      <span class="hljs-attr">name</span>: <span class="hljs-string">'角色池'</span>,
    &#125;,
    <span class="hljs-attr">armsPool</span>: &#123;
      <span class="hljs-attr">gacha_type</span>: <span class="hljs-number">302</span>,
      <span class="hljs-attr">name</span>: <span class="hljs-string">'武器池'</span>,
    &#125;,
  &#125;;
  <span class="hljs-keyword">const</span> handleSearch = <span class="hljs-keyword">async</span> () => &#123;
    setLoading(<span class="hljs-literal">true</span>);
    <span class="hljs-keyword">const</span> &#123; data &#125; = <span class="hljs-keyword">await</span> Axios.get(<span class="hljs-string">'/test'</span>, &#123; <span class="hljs-attr">params</span>: &#123; url &#125; &#125;);
    setResult(groupBy(data, <span class="hljs-string">'gacha_type'</span>));
    setLoading(<span class="hljs-literal">false</span>);
  &#125;;
  useEffect(<span class="hljs-function">() =></span> &#123;
    <span class="hljs-built_in">console</span>.log(result);
  &#125;, [result]);
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag"><<span class="hljs-name">Spin</span> <span class="hljs-attr">tip</span>=<span class="hljs-string">"Loading... 读取数据中,可能需要几十秒"</span> <span class="hljs-attr">delay</span>=<span class="hljs-string">&#123;200&#125;</span> <span class="hljs-attr">spinning</span>=<span class="hljs-string">&#123;loading&#125;</span>></span>
      <span class="hljs-tag"><<span class="hljs-name">div</span>
        <span class="hljs-attr">style</span>=<span class="hljs-string">&#123;&#123;</span>
          <span class="hljs-attr">width:</span> '<span class="hljs-attr">100vw</span>',
          <span class="hljs-attr">display:</span> '<span class="hljs-attr">flex</span>',
          <span class="hljs-attr">flexDirection:</span> '<span class="hljs-attr">column</span>',
          <span class="hljs-attr">alignItems:</span> '<span class="hljs-attr">center</span>',
          <span class="hljs-attr">justifyContent:</span> '<span class="hljs-attr">center</span>',
        &#125;&#125;
      ></span>
        <span class="hljs-tag"><<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">&#123;&#123;</span> <span class="hljs-attr">display:</span> '<span class="hljs-attr">flex</span>', <span class="hljs-attr">width:</span> '<span class="hljs-attr">30</span>%', <span class="hljs-attr">marginBottom:</span> <span class="hljs-attr">16</span> &#125;&#125;></span>
          <span class="hljs-tag"><<span class="hljs-name">Input</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&#123;url&#125;</span> <span class="hljs-attr">onChange</span>=<span class="hljs-string">&#123;setUrl&#125;</span> /></span>
          <span class="hljs-tag"><<span class="hljs-name">Button</span>
            <span class="hljs-attr">type</span>=<span class="hljs-string">"primary"</span>
            <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;()</span> =></span> &#123;
              handleSearch();
            &#125;&#125;
            style=&#123;&#123; marginLeft: 8 &#125;&#125;
          >
            查询
          <span class="hljs-tag"></<span class="hljs-name">Button</span>></span>
        <span class="hljs-tag"></<span class="hljs-name">div</span>></span>
        <span class="hljs-tag"><<span class="hljs-name">Row</span> <span class="hljs-attr">gutter</span>=<span class="hljs-string">&#123;[16,</span> <span class="hljs-attr">16</span>]&#125; <span class="hljs-attr">style</span>=<span class="hljs-string">&#123;&#123;</span> <span class="hljs-attr">width:</span> '<span class="hljs-attr">40</span>%' &#125;&#125;></span>
          <span class="hljs-tag"><<span class="hljs-name">Col</span> <span class="hljs-attr">span</span>=<span class="hljs-string">&#123;24&#125;</span>></span>
            <span class="hljs-tag"><<span class="hljs-name">PoolCard</span>
              <span class="hljs-attr">name</span>=<span class="hljs-string">&#123;poolNameMap.alwaysPool.name&#125;</span>
              <span class="hljs-attr">data</span>=<span class="hljs-string">&#123;get(result,</span> `$&#123;<span class="hljs-attr">poolNameMap.alwaysPool.gacha_type</span>&#125;<span class="hljs-attr">.0.data</span>`)&#125;
            /></span>
          <span class="hljs-tag"></<span class="hljs-name">Col</span>></span>
          <span class="hljs-tag"><<span class="hljs-name">Col</span> <span class="hljs-attr">span</span>=<span class="hljs-string">&#123;24&#125;</span>></span>
            <span class="hljs-tag"><<span class="hljs-name">PoolCard</span>
              <span class="hljs-attr">name</span>=<span class="hljs-string">&#123;poolNameMap.rolePool.name&#125;</span>
              <span class="hljs-attr">data</span>=<span class="hljs-string">&#123;get(result,</span> `$&#123;<span class="hljs-attr">poolNameMap.rolePool.gacha_type</span>&#125;<span class="hljs-attr">.0.data</span>`)&#125;
            /></span>
          <span class="hljs-tag"></<span class="hljs-name">Col</span>></span>
          <span class="hljs-tag"><<span class="hljs-name">Col</span> <span class="hljs-attr">span</span>=<span class="hljs-string">&#123;24&#125;</span>></span>
            <span class="hljs-tag"><<span class="hljs-name">PoolCard</span>
              <span class="hljs-attr">name</span>=<span class="hljs-string">&#123;poolNameMap.armsPool.name&#125;</span>
              <span class="hljs-attr">data</span>=<span class="hljs-string">&#123;get(result,</span> `$&#123;<span class="hljs-attr">poolNameMap.armsPool.gacha_type</span>&#125;<span class="hljs-attr">.0.data</span>`)&#125;
            /></span>
          <span class="hljs-tag"></<span class="hljs-name">Col</span>></span>
          <span class="hljs-tag"><<span class="hljs-name">Col</span> <span class="hljs-attr">span</span>=<span class="hljs-string">&#123;24&#125;</span>></span>
            <span class="hljs-tag"><<span class="hljs-name">PoolCard</span>
              <span class="hljs-attr">name</span>=<span class="hljs-string">&#123;poolNameMap.newHandPool.name&#125;</span>
              <span class="hljs-attr">data</span>=<span class="hljs-string">&#123;get(result,</span> `$&#123;<span class="hljs-attr">poolNameMap.newHandPool.gacha_type</span>&#125;<span class="hljs-attr">.0.data</span>`)&#125;
            /></span>
          <span class="hljs-tag"></<span class="hljs-name">Col</span>></span>
        <span class="hljs-tag"></<span class="hljs-name">Row</span>></span>
      <span class="hljs-tag"></<span class="hljs-name">div</span>></span>
    <span class="hljs-tag"></<span class="hljs-name">Spin</span>></span></span>
  );
&#125;

<span class="copy-code-btn">复制代码</span></code></pre>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// PoolCard.jsx</span>
<span class="hljs-keyword">import</span> React, &#123; useState, useEffect &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>
<span class="hljs-keyword">import</span> &#123; Card, Empty, Tag &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">'antd'</span>
<span class="hljs-keyword">import</span> &#123; isNil, filter, get, map &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">'lodash'</span>
<span class="hljs-keyword">import</span> PieChart <span class="hljs-keyword">from</span> <span class="hljs-string">'../PieChart'</span>
<span class="hljs-keyword">const</span> PoolCard = <span class="hljs-function">(<span class="hljs-params">&#123; name, data &#125;</span>) =></span> &#123;
    <span class="hljs-keyword">const</span> [goldCards, setGoldCards] = useState([]);
    <span class="hljs-keyword">const</span> [noGoldTimes, setNoGoldTimes] = useState();
    useEffect(<span class="hljs-function">() =></span> &#123;
        setGoldCards(get5LevelDetail(data))
    &#125;, [data])
    <span class="hljs-keyword">const</span> get5LevelDetail = <span class="hljs-function">(<span class="hljs-params">data</span>) =></span> &#123;
        <span class="hljs-keyword">if</span> (isNil(data)) &#123;
            <span class="hljs-keyword">return</span>;
        &#125;
        <span class="hljs-keyword">let</span> lastLocation = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">let</span> goldThings = []
        data.forEach(<span class="hljs-function">(<span class="hljs-params">item, index</span>) =></span> &#123;
            <span class="hljs-keyword">if</span> (get(item, <span class="hljs-string">`rank_type`</span>) === <span class="hljs-string">'5'</span>) &#123;
                goldThings.push(
                    &#123;
                        <span class="hljs-attr">nums</span>: index - lastLocation + <span class="hljs-number">1</span>,
                        <span class="hljs-attr">datail</span>: item,
                    &#125;
                )
                lastLocation = index + <span class="hljs-number">1</span>;
            &#125;
        &#125;)
        setNoGoldTimes(data.length - lastLocation);
        <span class="hljs-keyword">return</span> goldThings;
    &#125;
    <span class="hljs-keyword">const</span> getChartData = <span class="hljs-function">(<span class="hljs-params">data</span>) =></span> &#123;
        <span class="hljs-keyword">if</span> (isNil(data)) &#123;
            <span class="hljs-keyword">return</span>;
        &#125;
        <span class="hljs-keyword">let</span> level_5 = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">let</span> level_4 = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">let</span> level_3 = <span class="hljs-number">0</span>;
        data.forEach(<span class="hljs-function">(<span class="hljs-params">item, index</span>) =></span> &#123;
            <span class="hljs-keyword">if</span> (get(item, <span class="hljs-string">`rank_type`</span>) === <span class="hljs-string">'5'</span>) &#123;
                level_5++;
            &#125;
            <span class="hljs-keyword">if</span> (get(item, <span class="hljs-string">`rank_type`</span>) === <span class="hljs-string">'4'</span>) &#123;
                level_4++;
            &#125;
            <span class="hljs-keyword">if</span> (get(item, <span class="hljs-string">`rank_type`</span>) === <span class="hljs-string">'3'</span>) &#123;
                level_3++;
            &#125;
        &#125;)
        <span class="hljs-keyword">return</span> [&#123;
            <span class="hljs-attr">name</span>: <span class="hljs-string">'五星'</span>, <span class="hljs-attr">value</span>: level_5
        &#125;, &#123;
            <span class="hljs-attr">name</span>: <span class="hljs-string">'四星'</span>, <span class="hljs-attr">value</span>: level_4
        &#125;, &#123;
            <span class="hljs-attr">name</span>: <span class="hljs-string">'三星'</span>, <span class="hljs-attr">value</span>: level_3
        &#125;];
    &#125;
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag"><<span class="hljs-name">Card</span> <span class="hljs-attr">style</span>=<span class="hljs-string">&#123;&#123;</span> <span class="hljs-attr">position:</span>'<span class="hljs-attr">relative</span>' &#125;&#125;></span>
            <span class="hljs-tag"><<span class="hljs-name">div</span>></span>
                <span class="hljs-tag"><<span class="hljs-name">h3</span>></span>&#123;name&#125;<span class="hljs-tag"></<span class="hljs-name">h3</span>></span>
                <span class="hljs-tag"><<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">&#123;&#123;</span> <span class="hljs-attr">display:</span> '<span class="hljs-attr">flex</span>', <span class="hljs-attr">alignItems:</span> '<span class="hljs-attr">center</span>' &#125;&#125;></span>
                    &#123;!isNil(noGoldTimes) ? <span class="hljs-tag"><<span class="hljs-name">div</span>></span>
                        已经<span class="hljs-tag"><<span class="hljs-name">Tag</span> <span class="hljs-attr">color</span>=<span class="hljs-string">'processing'</span> <span class="hljs-attr">style</span>=<span class="hljs-string">&#123;&#123;</span> <span class="hljs-attr">marginLeft:</span> <span class="hljs-attr">8</span> &#125;&#125;></span>&#123;noGoldTimes&#125;<span class="hljs-tag"></<span class="hljs-name">Tag</span>></span>发没出金,
                    距离大保底还有<span class="hljs-tag"><<span class="hljs-name">Tag</span> <span class="hljs-attr">color</span>=<span class="hljs-string">'warning'</span> <span class="hljs-attr">style</span>=<span class="hljs-string">&#123;&#123;</span> <span class="hljs-attr">marginLeft:</span> <span class="hljs-attr">8</span> &#125;&#125;></span>&#123;90 - noGoldTimes&#125;<span class="hljs-tag"></<span class="hljs-name">Tag</span>></span>发
                <span class="hljs-tag"></<span class="hljs-name">div</span>></span> : null&#125;
                <span class="hljs-tag"></<span class="hljs-name">div</span>></span>
            <span class="hljs-tag"></<span class="hljs-name">div</span>></span>
            &#123;!isNil(data) ? <span class="hljs-tag"><<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">&#123;&#123;position:</span>'<span class="hljs-attr">absolute</span>',<span class="hljs-attr">right:0</span>,<span class="hljs-attr">top:0</span>,<span class="hljs-attr">bottom:0</span>,<span class="hljs-attr">margin:</span>'<span class="hljs-attr">auto</span> <span class="hljs-attr">0</span>'&#125;&#125;></span>
                <span class="hljs-tag"><<span class="hljs-name">PieChart</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&#123;name&#125;</span> <span class="hljs-attr">data</span>=<span class="hljs-string">&#123;getChartData(data)&#125;</span> /></span>
            <span class="hljs-tag"></<span class="hljs-name">div</span>></span> : null&#125;
            &#123;!isNil(data) ? <span class="hljs-tag"><></span>
                <span class="hljs-tag"><<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">&#123;&#123;</span> <span class="hljs-attr">display:</span> '<span class="hljs-attr">flex</span>', <span class="hljs-attr">justifyContent:</span> '<span class="hljs-attr">space-between</span>',<span class="hljs-attr">maxWidth:300</span> &#125;&#125;></span>
                    <span class="hljs-tag"><<span class="hljs-name">div</span>></span>
                        <span class="hljs-tag"><<span class="hljs-name">p</span>></span>
                            抽取次数:&#123;data.length&#125;
                        <span class="hljs-tag"></<span class="hljs-name">p</span>></span>
                        <span class="hljs-tag"><<span class="hljs-name">p</span>></span>
                            五星次数:
                        <span class="hljs-tag"><<span class="hljs-name">span</span> <span class="hljs-attr">style</span>=<span class="hljs-string">&#123;&#123;</span> <span class="hljs-attr">marginRight:</span> <span class="hljs-attr">8</span> &#125;&#125;></span>
                                &#123;
                                    get(goldCards, 'length')
                                &#125;
                            <span class="hljs-tag"></<span class="hljs-name">span</span>></span>
                            &#123;
                                map(goldCards, goldCard => <span class="hljs-tag"><<span class="hljs-name">Tag</span> <span class="hljs-attr">color</span>=<span class="hljs-string">'success'</span>></span>
                                    &#123;goldCard.datail.name&#125;(&#123;goldCard.nums&#125;)
                            <span class="hljs-tag"></<span class="hljs-name">Tag</span>></span>)
                            &#125;
                        <span class="hljs-tag"></<span class="hljs-name">p</span>></span>
                        <span class="hljs-tag"><<span class="hljs-name">p</span>></span>
                            四星次数:
                    &#123;
                                filter(
                                    data,
                                    item => get(item, `rank_type`) === '4',
                                ).length
                            &#125;
                        <span class="hljs-tag"></<span class="hljs-name">p</span>></span>
                        <span class="hljs-tag"><<span class="hljs-name">p</span>></span>
                            三星次数:
                    &#123;
                                filter(
                                    data,
                                    item => get(item, `rank_type`) === '3',
                                ).length
                            &#125;
                        <span class="hljs-tag"></<span class="hljs-name">p</span>></span>
                    <span class="hljs-tag"></<span class="hljs-name">div</span>></span>
                <span class="hljs-tag"></<span class="hljs-name">div</span>></span>
            <span class="hljs-tag"></></span></span> : (
                    <span class="xml"><span class="hljs-tag"><<span class="hljs-name">Empty</span> /></span></span>
                )&#125;
        </Card>
    )
&#125;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> PoolCard
<span class="copy-code-btn">复制代码</span></code></pre>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// PieChart.jsx</span>
<span class="hljs-keyword">import</span> React, &#123; useEffect, useState &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>
<span class="hljs-keyword">import</span> ReactEcharts <span class="hljs-keyword">from</span> <span class="hljs-string">'echarts-for-react'</span>;
<span class="hljs-keyword">import</span> config <span class="hljs-keyword">from</span> <span class="hljs-string">'./config'</span>
<span class="hljs-keyword">const</span> colorMap = &#123;
    <span class="hljs-string">'五星'</span>: <span class="hljs-string">'yellow'</span>,
    <span class="hljs-string">'四星'</span>: <span class="hljs-string">'purple'</span>,
    <span class="hljs-string">'三星'</span>: <span class="hljs-string">'blue'</span>
&#125;
<span class="hljs-keyword">const</span> RecordPieChart = <span class="hljs-function">(<span class="hljs-params">&#123; name, data &#125;</span>) =></span> &#123;
    <span class="hljs-keyword">const</span> [options, setOptions] = useState(&#123;&#125;);
    useEffect(<span class="hljs-function">() =></span> &#123;
        config.title.text = <span class="hljs-string">''</span>;
        config.legend.data = data.map(<span class="hljs-function"><span class="hljs-params">item</span> =></span> &#123;
            <span class="hljs-keyword">return</span> &#123;
                <span class="hljs-attr">name</span>: item,
                <span class="hljs-attr">textStyle</span>: &#123;
                    <span class="hljs-attr">color</span>: colorMap[item.name]
                &#125;
            &#125;
        &#125;);
        config.series[<span class="hljs-number">0</span>].data = data;;
        setOptions(config);
    &#125;, [name, data])
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag"><<span class="hljs-name">div</span>></span>
            <span class="hljs-tag"><<span class="hljs-name">ReactEcharts</span> <span class="hljs-attr">style</span>=<span class="hljs-string">&#123;&#123;</span> <span class="hljs-attr">width:</span> <span class="hljs-attr">400</span>, <span class="hljs-attr">height:</span> <span class="hljs-attr">250</span> &#125;&#125; <span class="hljs-attr">option</span>=<span class="hljs-string">&#123;options&#125;</span> /></span>
        <span class="hljs-tag"></<span class="hljs-name">div</span>></span></span>
    )
&#125;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> RecordPieChart

<span class="copy-code-btn">复制代码</span></code></pre>
<h1 data-id="heading-9">小结</h1>
<p>  经过一天的努力，终于可以愉快的查看自己的抽卡记录，安心抽卡了。<br>
  于是</p>
<p><img alt="438472A769F9A9954D09A4719DE7A78A.jpg" class="lazyload" src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6b913e6cba55475b8d741dba69b8d79c~tplv-k3u1fbpfcp-watermark.image" data-width="800" data-height="600" referrerpolicy="no-referrer">
<br></p>
<p><img alt="image.png" class="lazyload" src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7cd6f061fa254967bd98a4fb620d1572~tplv-k3u1fbpfcp-watermark.image" data-width="800" data-height="600" referrerpolicy="no-referrer">
<br></p>
<p><code>即使最后没有人为你鼓掌，也要优雅的谢幕，感谢自己的认真付出</code></p></div> <div class="image-viewer-box" data-v-78c9b824><!----></div>  
</div>
            