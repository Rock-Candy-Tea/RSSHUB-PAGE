
---
title: '华为前端工程师分享：查明网站访问故障原因，教你 4 招快速应对'
categories: 
 - 编程
 - 掘金
 - 分类
headimg: 'https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/493dd3ae5b224b8fafc1e0f21fbfbd5a~tplv-k3u1fbpfcp-zoom-1.image'
author: 掘金
comments: false
date: Thu, 01 Jul 2021 18:28:20 GMT
thumbnail: 'https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/493dd3ae5b224b8fafc1e0f21fbfbd5a~tplv-k3u1fbpfcp-zoom-1.image'
---

<div>   
<div class="markdown-body"><style>.markdown-body&#123;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333&#125;.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6&#123;line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px&#125;.markdown-body h1&#123;font-size:30px;margin-bottom:5px&#125;.markdown-body h2&#123;padding-bottom:12px;font-size:24px;border-bottom:1px solid #ececec&#125;.markdown-body h3&#123;font-size:18px;padding-bottom:0&#125;.markdown-body h4&#123;font-size:16px&#125;.markdown-body h5&#123;font-size:15px&#125;.markdown-body h6&#123;margin-top:5px&#125;.markdown-body p&#123;line-height:inherit;margin-top:22px;margin-bottom:22px&#125;.markdown-body img&#123;max-width:100%&#125;.markdown-body hr&#123;border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px&#125;.markdown-body code&#123;word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em&#125;.markdown-body code,.markdown-body pre&#123;font-family:Menlo,Monaco,Consolas,Courier New,monospace&#125;.markdown-body pre&#123;overflow:auto;position:relative;line-height:1.75&#125;.markdown-body pre>code&#123;font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8&#125;.markdown-body a&#123;text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff&#125;.markdown-body a:active,.markdown-body a:hover&#123;color:#275b8c&#125;.markdown-body table&#123;display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6&#125;.markdown-body thead&#123;background:#f6f6f6;color:#000;text-align:left&#125;.markdown-body tr:nth-child(2n)&#123;background-color:#fcfcfc&#125;.markdown-body td,.markdown-body th&#123;padding:12px 7px;line-height:24px&#125;.markdown-body td&#123;min-width:120px&#125;.markdown-body blockquote&#123;color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8&#125;.markdown-body blockquote:after&#123;display:block;content:""&#125;.markdown-body blockquote>p&#123;margin:10px 0&#125;.markdown-body ol,.markdown-body ul&#123;padding-left:28px&#125;.markdown-body ol li,.markdown-body ul li&#123;margin-bottom:0;list-style:inherit&#125;.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item&#123;list-style:none&#125;.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul&#123;margin-top:0&#125;.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul&#123;margin-top:3px&#125;.markdown-body ol li&#123;padding-left:6px&#125;.markdown-body .contains-task-list&#123;padding-left:0&#125;.markdown-body .task-list-item&#123;list-style:none&#125;@media (max-width:720px)&#123;.markdown-body h1&#123;font-size:24px&#125;.markdown-body h2&#123;font-size:20px&#125;.markdown-body h3&#123;font-size:18px&#125;&#125;</style><blockquote>
<p>​​​​​​​​​​摘要：在第七届全球软件大会上，华为软件工程师杜志刚，就为广大开发者分享了华为云官网的高可用保障方案，深度分析了网站在各类极端重大灾难场景下，如何快速恢复的方案和工程化实践。</p>
</blockquote>
<p>本文分享自华为云社区<a href="https://bbs.huaweicloud.com/blogs/281434?utm_source=juejin&utm_medium=bbs-ex&utm_campaign=other&utm_content=content" target="_blank" rel="nofollow noopener noreferrer">《网站访问故障背后发生了什么？华为工程师教你快速应对【全球软件技术大会技术分享】》</a>，原文作者：技术火炬手 。</p>
<p>最近，某 CDN 服务故障，导致海外大批知名新闻网站无法正常访问或加载，一石激起千层浪。确实，随着越来越多的业务上云，一个网站或者某个业务能否保证持续的在线，非常考验背后的高可用、高可靠方案设计。</p>
<p>在第七届全球软件大会上，<strong>华为软件工程师杜志刚，就为广大开发者分享了华为云官网的高可用保障方案，深度分析了网站在各类极端重大灾难场景下，如何快速恢复的方案和工程化实践。</strong></p>
<h2 data-id="heading-0">网站不靠谱，损失不可估量</h2>
<p>从网站所有者角度来看：网站不可用直接导致的是经济收入方面的影响，特别对于电商类网站，每分每秒都在产生交易，一旦访问中断，经济损失的影响显而易见。除此之外，从客户角度来看，面对网站不可访问，最直观的感受是不靠谱，对网站以及网站背后的企业品牌产生不可挽回的口碑及信任度方面的负面影响。</p>
<p>从近十年的互联网重大故障事件来看，DNS、CDN 导致的大范围影响历历在目，其他 IT 基础设施导致的区域型及全局型故障也影响甚大。</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/493dd3ae5b224b8fafc1e0f21fbfbd5a~tplv-k3u1fbpfcp-zoom-1.image" alt loading="lazy" referrerpolicy="no-referrer"></p>
<p>业界广泛使用的网站可用性指标包括网站不可用时间及网站年度可用率，不同类型的网站和应用对可用性的要求也不尽相同。</p>
<p>其中网站不可用时间（故障时间）=故障恢复时间点-故障发生时间点。网站年度可用率（Yearly Uptime Percentage）=（1-网站不可用时间/年度总时间）*100%。</p>
<p>华为云官网作为云基础设施提供商的互联网访问入口，对可用性有着极高的要求，面向最终用户的核心页面要做到 7*24 小时在线，如果出现重大故障，如云服务区级别，或基础设施导致的单云全局故障，5 分钟内告警通知到相关责任人，15 分钟内完成故障切换。</p>
<h2 data-id="heading-1">网站访问出现故障，背后发生了什么？</h2>
<p>下面结合图例分析一下网站页面访问的整体流程及关键故障点：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f7b05b677f314e5bb4e75be3de527017~tplv-k3u1fbpfcp-zoom-1.image" alt loading="lazy" referrerpolicy="no-referrer"></p>
<p>在①处，DNS 故障会通常会导致网站整体不可访问，到了②是 CDN 故障会让部分地理区域用户不可访问，③是单云全局故障会导致网站整体不可访问，④是云服务区级别故障会导致分流到该区域的用户不可访问，⑤是云服务可用区级别故障会导致路由到故障 AZ 的用户不可访问，⑥是容器集群故障导致路由到对应容器服务的用户不可访问，⑦是服务节点故障会导致路由到故障服务节点的用户不可访问。</p>
<p>综上，云化场景下，页面访问面临诸多的关键技术挑战，包括</p>
<ul>
<li>
<p>单个 DNS 服务商整体故障如何应对?</p>
</li>
<li>
<p>单个 CDN 厂商整体或多个区域故障如何应对？</p>
</li>
<li>
<p>基础设施故障导致的单云整体故障如何保证页面还可以正常访问？</p>
</li>
<li>
<p>单个云服务区级别故障如何对用户访问影响时间降到最小？</p>
</li>
<li>
<p>页面访问依赖的后端服务众多，如何最大限度较少故障点，降低方案整体复杂度及成本，保证方案通用可行？</p>
</li>
</ul>
<h2 data-id="heading-2">四个方案，轻松应对网站各种故障</h2>
<p>针对以上关键挑战，通过华为云官网近几年的实践，总结了 4 个方案分享给大家，我们将一一拆解，为大家展示这些方案的实际效果。</p>
<h3 data-id="heading-3">1、单个 DNS 服务商整体故障：双 DNS 服务商解析</h3>
<p>DNS 是相对来说非常重要但却没有得到应有重视的薄弱环节，对于可用性要求极高的商业门户网站，<strong>将 DNS 依托于一家服务商，不出问题风平浪静，一旦发生全局性故障，导致的影响可能是灾难性的。</strong></p>
<p>我们当前的策略是：采用双 DNS 厂商域名解析方案，在一家服务商发生部分或整体故障时，可以在短时间内自动实现故障切换，将域名解析工作交给其他服务商完成。此外，我们还构建了统一运维平台实现多厂商域名解析的统一配置，以及 DNS 可用性监控、故障服务的快速剔除能力。</p>
<p>双厂商 DNS 配置如图所示：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7d836a1509374dcfa06f34f2919066af~tplv-k3u1fbpfcp-zoom-1.image" alt loading="lazy" referrerpolicy="no-referrer"></p>
<p>这个配置的前提是域名注册商及域名解析商支持多厂商 Name Server 配置。具体配置方面，首先将域名注册托管迁移到支持多厂商 NS 配置的注册商，然后同步 DNS 厂商配置的解析记录到新厂商，最后域名注册服务及解析服务同时配置 NS 记录指向双厂商 Name Server（0~72 小时生效）</p>
<p>这样配置可以在单个产商 NameServer 发生故障时，ISP Local DNS 自动将故障 NameServer 降低选择优先级（BIND SRTT 算法，失败惩罚），使用优选的 Name Server 进行 A 记录或 CNAME 域名解析。</p>
<p>演练步骤可以拆解为：</p>
<p>第一步：双厂商 NS 记录配置。</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e07e0c567ec7432396a5f0bed9edce1a~tplv-k3u1fbpfcp-zoom-1.image" alt loading="lazy" referrerpolicy="no-referrer"></p>
<p>第二步：通过浏览器检查服务可正常访问。</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c9e9f3276b4b4bea91d834d2b2346ba4~tplv-k3u1fbpfcp-zoom-1.image" alt loading="lazy" referrerpolicy="no-referrer"></p>
<p>第三步：拨测 NameServer 可用性，验证不同地域 ISP 是否使用了不同厂商的 NameServer 进行域名解析。</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/25b42bb2a1e34d5385d57d3cf4484ff5~tplv-k3u1fbpfcp-zoom-1.image" alt loading="lazy" referrerpolicy="no-referrer"></p>
<p>第四步：关停 Bind 模拟单个厂商 DNS 故障。</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/bc122ee84a6949038eb9df31f2f0b5a7~tplv-k3u1fbpfcp-zoom-1.image" alt loading="lazy" referrerpolicy="no-referrer"></p>
<p>最后，通过 HTTP 从多个地域拨测服务是否可以正常访问。</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5eaf3374756b4d8da0df0f1c1153403f~tplv-k3u1fbpfcp-zoom-1.image" alt loading="lazy" referrerpolicy="no-referrer"></p>
<h3 data-id="heading-4">2、单个 CDN 厂商区域性故障：多 CDN 服务商方案</h3>
<p>下面介绍一下多 CDN 厂商的配置与切换，如图所示：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/8735cc50a44c48a4a3e7827360d56669~tplv-k3u1fbpfcp-zoom-1.image" alt loading="lazy" referrerpolicy="no-referrer"></p>
<p>使用这个方案的限制条件有三个：DNS 协议不支持多厂商 CDN 的 CNAME 解析配置；DNS 智能解析支持不同地域或网络配置不同的 CNAME 解析记录；CDN 出现整体故障概率较低，更多是区域性故障。</p>
<p>多 CDN 厂商的配置要先对国内及海外访问分别做主备 CDN 加速，然后 CDN CNAME 解析 TTL 设置为 60s，让单 CDN 厂商服务不可用时，故障切换生效时间更短；最后是构建 CDN 管理平台，对接多厂商 DNS 管理 API，预先配置切换和回切策略，出现故障一键切换。</p>
<p>最后的配置效果也很明显，CDN 告警厂商 A 大面积故障后，可通过 CDN 运维管理平台，将对应区域的 CNAME 解析 Failover 到厂商 B 提供服务，生效时间 1 分钟。</p>
<p>下图是我们运维平台的切换界面示例，可按不同二级域名分国内及海外用户访问场景分别切换。</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c37e7994fa2e4307adf1a7d3dbeeef1f~tplv-k3u1fbpfcp-zoom-1.image" alt loading="lazy" referrerpolicy="no-referrer"></p>
<p>2020 年和 2021 年我们都遇到了实际的现网故障，CDN 的故障切换功能得到了有效应用，让页面访问实现了快速故障恢复。</p>
<h3 data-id="heading-5">3、区域性地理灾难场景：页面访问异地多活方案</h3>
<p>这里介绍了我们中国站和国际站双站异地多活的组网策略，如图所示：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/54f9b2e9ab9145e586137a5e3ad03deb~tplv-k3u1fbpfcp-zoom-1.image" alt loading="lazy" referrerpolicy="no-referrer"></p>
<p><strong>如果发生区域性地理灾难场景，我们使用站点多 Region 多活部署，</strong> 使用这个解决方案要保证内容管理服务发布的页面内容在多云服务区保持同步。同时，LB 及网关路由配置多活云服务区保持一致。</p>
<p>具体配置时，先将国内及海外用户 CDN 回源流量按比例分流至不同云服务区；随后配置健康检查策略，当出现云服务区级别故障时告警，便于自动或手动切换回源流量至健康的云服务区；如果海外与国内服务存在差异时，通过云厂商内部专线在 LB 或网关进行跨云服务区路由。</p>
<p>这样，在非容灾场景下，多云服务区同时提供页面访问服务，降低单云服务区回源压力。即便出现云服务区级别故障时，也可通过 CDN Admin API 实现一键故障切换，CDN 回源快速回到可用状态。</p>
<p>如图所示，通过我们的运维平台，在单个云服务区故障场景下，可实现故障云服务区的快速剔除，这个过程主要通过批量切换二级域名 Region 级别回源 DNS A 记录实现的。</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5f981e013e084d569e6da92240df0274~tplv-k3u1fbpfcp-zoom-1.image" alt loading="lazy" referrerpolicy="no-referrer"></p>
<h3 data-id="heading-6">4、单云全局故障场景：网站备份与切换方案</h3>
<p>最后介绍一下整个高可用方案的最底层的保底方案：网站备份与故障切换，首先来看一下网站的备份流程，如图所示：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/10d09491063a41d3b5856f6dbb61ebbe~tplv-k3u1fbpfcp-zoom-1.image" alt loading="lazy" referrerpolicy="no-referrer"></p>
<p>运维人员先配置站点元数据及配置备份策略，站点管理根据备份策略下发备份任务到调度服务，然后调度服务再定时调用备份服务执行备份任务。</p>
<p>采集的话是由备份服务启动 HeadlessBrowser 加载入口页，再加载静态页面资源，执行页面脚本加载动态页面资源，然后执行预置脚本加载动态页面资源，最后识别页面跳转 URL，包括 HTML 标记及脚本触发的动态跳转点，启动新 Headless Browser 实例，实现级联爬取。</p>
<p>采集完是存储，页面主文档及相关页面资源加载完成后通过 OBS 接口转储到对象存储服务，再通过云厂商提供的对象存储跨 Region 同步能力实现页面内容异地容灾。跨云复制则通过跨云同步工具将备份站点页面内容，同步到其他云厂商对象存储服务，实现跨云容灾。</p>
<p>备份结束后，再看一下故障切换流程。当基础设施问题等原因导致的单云多 Region 故障使得 Web 服务整体不可用时，开始故障检测，页面可用性拨测服务监测到云服务区 A、B 不可用，在 5 分钟内发出告警。</p>
<p>往下是故障转移，成立重大问题应急处理作战小组，同时打开运维容灾管理平台，查看不可用区域、备份站点拨测是否正常。如果同云备份站点可用，优先切换同云备份站点；如果不可用，第三方云厂商备份站点可用，切换到备份站点。整个切换通过更新回源域名 A 记录解析地址指向 OBS 公网访问地址实现。</p>
<p>最后是故障修复阶段，先定位解决问题，拨测 Web Server 可用，再手动执行故障回切，然后用户回归正常访问。</p>
<h2 data-id="heading-7">总结</h2>
<p>以上是在各种极端场景下如何保证网站持续在线的一些实践经验的总结，<strong>相关方案已经在实际场景下验证有效，并且做到持续的例行化演练。</strong></p>
<p>另外，对于不同类型或规模的网站，高可用并没有具体量化的标准，可以给几个比较粗的级别供参考：最基础的保证功能可用，不考虑网元的单点问题。要求再高一点，考虑应用服务集群化部署、DB、缓存等中间件进行相应的高可用部署，确保没有基本的单点问题。再往上考虑多数据中心部署，解决单数据中心不可用问题。最后是考虑异地多活或容灾，应对某一地理区域灾难的场景。</p>
<p>除了以上传统套路外，随着越来越多的企业都在上云，还要考虑单个云厂商基础设施发生整体故障时如何快速替换及逃生的问题，例如 CDN，DNS 等，这些都是网站访问基础场景要重点考虑的故障点。</p>
<h2 data-id="heading-8">福利</h2>
<p>了解保证网站高可用可靠的几个常用方案，大家是否有收获或者有问题想交流呢，<strong>欢迎在</strong><a href="https://bbs.huaweicloud.com/blogs/281434?utm_source=juejin&utm_medium=bbs-ex&utm_campaign=other&utm_content=content" target="_blank" rel="nofollow noopener noreferrer">原文</a><strong>评论区留下你的问题或感想，我们将抽取 3 条，请专家与你 1V1 交流，</strong> 并且送出开发者大礼包一份。</p>
<p>本次，还有两位华为的专家给大家带来<a href="https://bbs.huaweicloud.com/blogs/281134" target="_blank" rel="nofollow noopener noreferrer">《华为云官网智能化实践的五大关键举措》</a>和<a href="https://bbs.huaweicloud.com/blogs/280921" target="_blank" rel="nofollow noopener noreferrer">《华为云官网前端的技术演进与低代码实践》</a>的分享，他们也回答了开发者关心的问题，例如网站智能推荐的实践心得，低代码平台的选型等等。欢迎<strong>扫码观看视频。</strong></p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/04c7093860b14e90b8db51b3f2522ecc~tplv-k3u1fbpfcp-zoom-1.image" alt loading="lazy" referrerpolicy="no-referrer"></p>
<p><strong>最后，附上华为软件工程师杜志刚在本次全球软件大会上的技术分享 PPT，</strong> <a href="https://bbs.huaweicloud.com/blogs/281434?utm_source=juejin&utm_medium=bbs-ex&utm_campaign=other&utm_content=content" target="_blank" rel="nofollow noopener noreferrer">文末可点击下载</a><strong>。</strong></p>
<p><a href="https://bbs.huaweicloud.com/blogs?utm_source=juejin&utm_medium=bbs-ex&utm_campaign=other&utm_content=content" target="_blank" rel="nofollow noopener noreferrer">点击关注，第一时间了解华为云新鲜技术~</a></p></div>  
</div>
            