
---
title: '自动化构建'
categories: 
 - 编程
 - 掘金
 - 分类
headimg: 'https://picsum.photos/400/300?random=6690'
author: 掘金
comments: false
date: Tue, 08 Jun 2021 09:04:34 GMT
thumbnail: 'https://picsum.photos/400/300?random=6690'
---

<div>   
<div class="markdown-body"><style>.markdown-body&#123;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333&#125;.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6&#123;line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px&#125;.markdown-body h1&#123;font-size:30px;margin-bottom:5px&#125;.markdown-body h2&#123;padding-bottom:12px;font-size:24px;border-bottom:1px solid #ececec&#125;.markdown-body h3&#123;font-size:18px;padding-bottom:0&#125;.markdown-body h4&#123;font-size:16px&#125;.markdown-body h5&#123;font-size:15px&#125;.markdown-body h6&#123;margin-top:5px&#125;.markdown-body p&#123;line-height:inherit;margin-top:22px;margin-bottom:22px&#125;.markdown-body img&#123;max-width:100%&#125;.markdown-body hr&#123;border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px&#125;.markdown-body code&#123;word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em&#125;.markdown-body code,.markdown-body pre&#123;font-family:Menlo,Monaco,Consolas,Courier New,monospace&#125;.markdown-body pre&#123;overflow:auto;position:relative;line-height:1.75&#125;.markdown-body pre>code&#123;font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8&#125;.markdown-body a&#123;text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff&#125;.markdown-body a:active,.markdown-body a:hover&#123;color:#275b8c&#125;.markdown-body table&#123;display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6&#125;.markdown-body thead&#123;background:#f6f6f6;color:#000;text-align:left&#125;.markdown-body tr:nth-child(2n)&#123;background-color:#fcfcfc&#125;.markdown-body td,.markdown-body th&#123;padding:12px 7px;line-height:24px&#125;.markdown-body td&#123;min-width:120px&#125;.markdown-body blockquote&#123;color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8&#125;.markdown-body blockquote:after&#123;display:block;content:""&#125;.markdown-body blockquote>p&#123;margin:10px 0&#125;.markdown-body ol,.markdown-body ul&#123;padding-left:28px&#125;.markdown-body ol li,.markdown-body ul li&#123;margin-bottom:0;list-style:inherit&#125;.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item&#123;list-style:none&#125;.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul&#123;margin-top:0&#125;.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul&#123;margin-top:3px&#125;.markdown-body ol li&#123;padding-left:6px&#125;.markdown-body .contains-task-list&#123;padding-left:0&#125;.markdown-body .task-list-item&#123;list-style:none&#125;@media (max-width:720px)&#123;.markdown-body h1&#123;font-size:24px&#125;.markdown-body h2&#123;font-size:20px&#125;.markdown-body h3&#123;font-size:18px&#125;&#125;</style><h3 data-id="heading-0">一. 自动化构建</h3>
<h4 data-id="heading-1">1. 简介</h4>
<ul>
<li>
<p>把开发时的源代码自动化的转化为生产环境代码</p>
</li>
<li>
<p>实现自动化构建</p>
<ul>
<li>
<p>npm scripts</p>
<ul>
<li>
<p>package.json</p>
<pre><code class="copyable">&#123;
  "name": "my-auto-build1",
  "version": "1.0.0",
  "description": "my-auto-build1",
  "main": "index.js",
  "scripts": &#123;
    "build": "sass ./scss/main.scss ./css/style.css --watch",
    "serve": "browser-sync . --files ./scss/main.scss",
    "start": "run-p build serve"
  &#125;,
  "author": "康小源",
  "license": "MIT",
  "dependencies": &#123;
    "browser-sync": "^2.26.13",
    "npm-run-all": "^4.1.5",
    "sass": "^1.29.0"
  &#125;
&#125;

<span class="copy-code-btn">复制代码</span></code></pre>
</li>
<li></li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 data-id="heading-2">2. 常用的自动化构建工具</h4>
<ul>
<li>
<p>grunt</p>
<ul>
<li>
<p>最早的前端构建系统</p>
</li>
<li>
<p>基于临时文件实现</p>
</li>
<li>
<p>基本使用</p>
<ul>
<li>
<p>初始化 package.json</p>
</li>
<li>
<p>安装 grunt，yarn add grunt --dev</p>
<pre><code class="copyable">/**
 * Grunt 的入口文件
 * 用于定义一些需要 Grunt 自动执行的任务
 * 需要导出一个函数
 * 此函数接收一个 grunt 的形式参数，内部提供一些创建任务时可以用到的 api
 */
module.exports = grunt => &#123;
  // 注册一个任务
  // 第一个参数是任务的名字
  // 第二个参数是执行任务时的程序
  grunt.registerTask('foo', () => &#123;
    console.log('hello grunt')
  &#125;)

  // 第二个参数如果是字符串，将成为任务描述
  grunt.registerTask('bar', '任务描述', () => &#123;
    console.log('other task')
  &#125;)

  // 如果任务名称为 default，这个任务将称为默认任务，运行时可以不加任务名称
  // grunt.registerTask('default', () => &#123;
  //   console.log('default task')
  // &#125;)

  // 映射其他任务，第二个参数传入一个数组，数组中指定任务
  grunt.registerTask('default', ['foo', 'bar'])

  // grunt 对异步任务的支持
  // 通过 this.async() 实现异步操作
  grunt.registerTask('async-task', function() &#123;
    const done = this.async()
    setTimeout(() => &#123;
      console.log('async task')
      done()
    &#125;, 2000)
  &#125;)
&#125;
<span class="copy-code-btn">复制代码</span></code></pre>
</li>
</ul>
</li>
<li>
<p>标记失败让任务</p>
<pre><code class="copyable">/**
 * Grunt 的入口文件
 * 用于定义一些需要 Grunt 自动执行的任务
 * 需要导出一个函数
 * 此函数接收一个 grunt 的形式参数，内部提供一些创建任务时可以用到的 api
 */
module.exports = grunt => &#123;

  // 标记任务失败
  // 一个任务失败了，后续任务将不在被执行
  // --force 可以跳过失败任务
  grunt.registerTask('fail-task', () => &#123;
    console.log('fail task')
    return false
  &#125;)

  // 异步任务标记失败
  // 给 done 方法一个 false 的实参来标记任务失败
  grunt.registerTask('fail-async-task', function()&#123;
    const done = this.async()
    setTimeout(() => &#123;
      console.log('fail async task')
      done(false)
    &#125;, 2000)
  &#125;)
&#125;
<span class="copy-code-btn">复制代码</span></code></pre>
</li>
<li>
<p>grunt 配置方法</p>
<pre><code class="copyable">module.exports = grunt => &#123;
  // grunt 的配置方法
  // 此方法接收一个对象形式的参数
  // 对象的属性名和任务名称保持一致
  // 属性值可以是任意类型的数据
  grunt.initConfig(&#123;
    // foo: 'bar'
    foo: &#123;
      bar: 123
    &#125;
  &#125;)

  // grunt.config() 获取在initConfig 中定义的配置
  grunt.registerTask('foo', () => &#123;
    // console.log(grunt.config('foo')) // bar
    console.log(grunt.config('foo.bar')) // 123

  &#125;)
&#125;
<span class="copy-code-btn">复制代码</span></code></pre>
</li>
<li>
<p>多目标任务</p>
<pre><code class="copyable">module.exports = grunt => &#123;
  // 通过 initConfig 配置任务目标
  // 目标必须是一个对象
  // 运行指定目标 build:css
  // 在 initConfig 中所有的属性都是目标，除了 options 以外
  grunt.initConfig(&#123;
    build: &#123;
      // 作为任务的配置选项
      options: &#123;
        foo: 'bar'
      &#125;,
      css: '1',
      js: '2'
    &#125;
  &#125;)
  // 通过 grunt.resgisterMultiTask() 定义多目标任务
  // 多目标任务需要配置不同的目标
  // 接收两个参数
  // 第一个参数：任务名字
  // 第二个参数：任务逻辑
  // 可以通过 this.target 拿到目标名称，通过 this.data 拿到目标数据
  grunt.registerMultiTask('build', function () &#123;
    console.log(`target: $&#123;this.target&#125;, data: $&#123;this.data&#125;`)
  &#125;)
&#125;
<span class="copy-code-btn">复制代码</span></code></pre>
</li>
<li>
<p>插件的使用</p>
<ul>
<li>
<p>使用过程</p>
<ul>
<li>
<p>通过 npm 安装插件</p>
</li>
<li>
<p>在 gruntfile 中载入插件</p>
</li>
<li>
<p>根据插件的配置文档使用插件</p>
<pre><code class="copyable">/**
 * grunt-contrib-clean
 * 用来清除项目中产生的临时文件
 */

 module.exports = grunt => &#123;
   grunt.initConfig(&#123;
     clean: &#123;
      //  temp: 'temp/app.js'
       temp: 'temp/*.txt'
     &#125;
   &#125;)
   // grunt.loadNpmTasks() 加载插件中提供的任务
   grunt.loadNpmTasks('grunt-contrib-clean')
 &#125;
<span class="copy-code-btn">复制代码</span></code></pre>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p>常用的插件</p>
</li>
<li>
<p>安装 grunt-sass，yarn add grunt-sass sass --dev</p>
</li>
<li>
<p>安装 grunt-babel，yarn add grunt-babel @babel/core @babel/preset-env --dev</p>
</li>
<li>
<p>安装 load-grunt-tasks 模块，减少 grunt.loadNpmTasks() 的使用</p>
</li>
<li>
<p>安装 grunt-contrib-watch 模块，yarn add grunt-contrib-watch --dev，用于监视文件修改，自动编译</p>
<pre><code class="copyable">const sass = require('sass')
const loadGruntTasks = require('load-grunt-tasks')
module.exports = grunt => &#123;
  grunt.initConfig(&#123;
    sass: &#123;
      options: &#123;
        sourceMap: true,
        implementation: sass
      &#125;,
      main: &#123;
        files: &#123;
          './dist/css/main.css': './src/scss/main.scss'
        &#125;
      &#125;
    &#125;,
    babel: &#123;
      options: &#123;
        sourceMap: true,
        presets: ['@babel/preset-env']
      &#125;,
      main: &#123;
        files: &#123;
          './dist/js/app.js': './src/js/app.js'
        &#125;
      &#125;
    &#125;,
    watch: &#123;
      js: &#123;
        files: ['./src/js/*.js'],
        tasks: ['babel']
      &#125;,
      css: &#123;
        files: ['./src/scss/*.scss'],
        tasks: ['sass']
      &#125;
    &#125;
  &#125;)
  loadGruntTasks(grunt) // 自动加载所有的 grunt 插件任务

  grunt.registerTask('default', ['sass', 'babel', 'watch'])
&#125;
<span class="copy-code-btn">复制代码</span></code></pre>
</li>
</ul>
</li>
<li>
<p>gulp</p>
<ul>
<li>
<p>基于内存实现</p>
</li>
<li>
<p>基本使用</p>
<ul>
<li>
<p>初始化 package.json，yarn init</p>
</li>
<li>
<p>安装 gulp, yarn add gulp --dev</p>
</li>
<li>
<p>gulp 以导出函数成员的方式定义任务</p>
<pre><code class="copyable">// gulp 的入口文件

exports.foo = done => &#123;
  console.log('foo task')
  done() // 标识任务完成
&#125;

// 如果导出的任务为 default，会作为默认任务
exports.default = done => &#123;
  console.log('default task')
  done()
&#125;
<span class="copy-code-btn">复制代码</span></code></pre>
</li>
</ul>
</li>
<li>
<p>组合任务</p>
<ul>
<li>
<p>series 串行</p>
</li>
<li>
<p>parallel 并行</p>
<pre><code class="copyable">const &#123; series, parallel &#125; = require('gulp')
const task1 = done => &#123;
  setTimeout(() => &#123;
    console.log('task1')
    done()
  &#125;, 1000)
&#125;

const task2 = done => &#123;
  setTimeout(() => &#123;
    console.log('task2')
    done()
  &#125;, 1000)
&#125;

const task3 = done => &#123;
  setTimeout(() => &#123;
    console.log('task3')
    done()
  &#125;, 1000)
&#125;

// 串行任务
exports.foo = series(task1, task2, task3)

// 并行任务
exports.bar = parallel(task1, task2, task3)
<span class="copy-code-btn">复制代码</span></code></pre>
</li>
<li>
<p>异步任务</p>
<pre><code class="copyable">const fs = require('fs')
// 通过回调标记任务结束
exports.callback = done => &#123;
  console.log('callback')
  done()
&#125;

// 错误任务
// gulp 为错误优先的方式
// gulp 任务一旦出错，则后续任务不会执行
exports.callback_error = done => &#123;
  console.log('callback_error')
  done(new Error('task failed'))
&#125;

// 返回 promise 标记任务结束
exports.promise = () => &#123;
  console.log('promise task')
  // 不用给 resolve 传值，gulp 会忽略这个值
  return Promise.resolve()
&#125;

// 返回失败的 promise
exports.promise_error = () => &#123;
  console.log('promise_error task')
  return Promise.reject(new Error('task failed'))
&#125;

// 定义异步函数
const timeout = time => &#123;
  return new Promise(resolve => &#123;
    setTimeout(resolve, time)
  &#125;)
&#125;

// 通过 async await 的方式标记任务结束
exports.async = async () => &#123;
  await timeout(1000)
  console.log('async task')
&#125;

// 返回文件流结束任务
exports.stream = () => &#123;
  const readStream = fs.createReadStream('package.json')
  const writeStream = fs.createWriteStream('temp.txt')
  readStream.pipe(writeStream)
  return readStream
&#125;
<span class="copy-code-btn">复制代码</span></code></pre>
</li>
<li>
<p>构建过程核心工作原理</p>
<pre><code class="copyable">const fs = require('fs')
const &#123; Transform &#125; = require('stream')
exports.default = () => &#123;
  // 文件读取流
  const read = fs.createReadStream('normalize.css')
  // 文件写入流
  const write = fs.createWriteStream('normalize.min.css')
  // 文件转换流
  const transform = new Transform(&#123;
    transform: (chunk, encoding, callback) => &#123;
      // 核心转换过程
      // chunk  => 读取流中读取的内容（buffer）
      const input = chunk.toString()
      const output = input.replace(/\s+/g, '').replace(/\/\*.+?\*\//g, '')
      callback(null, output)
    &#125;
  &#125;)
  // 把读取到的读取流写入到 normalize.min.css 中
  read
    .pipe(transform) // 转换
    .pipe(write) // 写入
  return read
&#125;
<span class="copy-code-btn">复制代码</span></code></pre>
</li>
<li>
<p>文件操作 API</p>
<pre><code class="copyable">const &#123; src, dest &#125; = require('gulp')
const cleanCss = require('gulp-clean-css')
const rename = require('gulp-rename')

exports.default = () => &#123;
  return src('./src/*.css') // 读取流
    .pipe(cleanCss()) // 压缩 css
    .pipe(rename(&#123; extname: '.min.css' &#125;))
    .pipe(dest('dist')) // 写入流
&#125;
<span class="copy-code-btn">复制代码</span></code></pre>
</li>
<li>
<p>案例</p>
<ul>
<li>
<p>安装模块</p>
<ul>
<li>
<p>安装 gulp，yarn add gulp --dev</p>
</li>
<li>
<p>安装 gulp-sass，yarn add gulp-sass --dev</p>
</li>
<li>
<p>安装 gulp-babel，yarn add gulp-babel @babel/core @babel/preset-env --dev</p>
</li>
<li>
<p>安装 gulp-swig，yarn add gulp-swig --dev</p>
</li>
<li>
<p>安装 gulp-imagemin，yarn add gulp-imagemin --dev</p>
</li>
<li>
<p>安装 gulp-load-plugins，yarn add gulp-load-plugins --dev</p>
</li>
<li>
<p>安装 del，yarn add del --dev</p>
</li>
<li>
<p>安装 browser-sync，yarn add browser-sync --dev</p>
</li>
<li>
<p>安装 gulp-useref，yarn add gulp-useref --dev</p>
</li>
<li>
<p>安装 gulp-if，yarn add gulp-if --dev</p>
</li>
<li>
<p>安装 gulp-clean-css，yarn add gulp-clean-css --dev</p>
</li>
<li>
<p>安装 gulp-uglify，yarn add gulp-uglify --dev</p>
</li>
<li>
<p>安装 gulp-htmlmin，yarn add gulp-htmlmin --dev</p>
<pre><code class="copyable">const &#123; src, dest, series, parallel, watch, tree &#125; = require('gulp')

// 清除文件插件
const del = require('del')

// 自动加载插件
const loadPlugins = require('gulp-load-plugins')

const plugins = loadPlugins()

// 开发服务器
const browserSync = require('browser-sync')
const bs = browserSync.create()

// // scss 转换插件
// const sass = require('gulp-sass')
// // es6 转换插件
// const babel = require('gulp-babel')
// // 模板引擎转换插件
// const swig = require('gulp-swig')
// // 图片转换插件
// const imagemin = require('gulp-imagemin')

const data = &#123;
  menus: [
    &#123;
      name: 'Home',
      icon: 'aperture',
      link: 'index.html'
    &#125;,
    &#123;
      name: 'Features',
      link: 'features.html'
    &#125;,
    &#123;
      name: 'About',
      link: 'about.html'
    &#125;,
    &#123;
      name: 'Contact',
      link: '#',
      children: [
        &#123;
          name: 'Twitter',
          link: 'https://twitter.com/w_zce'
        &#125;,
        &#123;
          name: 'About',
          link: 'https://weibo.com/zceme'
        &#125;,
        &#123;
          name: 'divider'
        &#125;,
        &#123;
          name: 'About',
          link: 'https://github.com/zce'
        &#125;
      ]
    &#125;
  ],
  pkg: require('./package.json'),
  date: new Date()
&#125;

const clean = () => &#123;
  return del(['dist', 'temp'])
&#125;

const style = () => &#123;
  // 指定 src 函数的选项参数 base，指定基准路径
  return src('./src/assets/styles/*.scss', &#123; base: 'src' &#125;)
    // sass 会认为以下划线开头的样式文件是在主文件依赖的文件
    // 指定参数 &#123; outputStyle: expanded &#125; 完全展开 
    .pipe(plugins.sass(&#123; outputStyle: 'expanded' &#125;))
    .pipe(dest('temp'))
    // 指定参数 &#123; stream: true &#125; 以流的方式推送至浏览器
    .pipe(bs.reload(&#123; stream: true &#125;))
&#125;

const script = () => &#123;
  return src('./src/assets/scripts/*.js', &#123; base: 'src' &#125;)
    // 指定参数 &#123; presets: ['@babel/preset-env'] &#125; 转换插件
    .pipe(plugins.babel(&#123; presets: ['@babel/preset-env'] &#125;))
    .pipe(dest('temp'))
    .pipe(bs.reload(&#123; stream: true &#125;))
&#125;

const page = () => &#123;
  return src('./src/*.html', &#123; base: 'src' &#125;)
    .pipe(plugins.swig(&#123; data, defaults: &#123; cache: false &#125; &#125;)) // 防止模板缓存导致页面不能刷新
    .pipe(dest('temp'))
    .pipe(bs.reload(&#123; stream: true &#125;))
&#125;

const image = () => &#123;
  return src('./src/assets/images/**', &#123; base: 'src' &#125;)
    .pipe(plugins.imagemin())
    .pipe(dest('dist'))
&#125;

const font = () => &#123;
  return src('./src/assets/fonts/**', &#123; base: 'src' &#125;)
    .pipe(plugins.imagemin())
    .pipe(dest('dist'))
&#125;

const extra = () => &#123;
  return src('./public/**', &#123; base: 'public' &#125;)
    .pipe(dest('dist'))
&#125;

const serve = () => &#123;
  watch('./src/assets/styles/*.scss', style)
  watch('./src/assets/scripts/*.js', script)
  watch('./src/*.html', page)
  // watch('./src/assets/images/**', image)
  // watch('./src/assets/fonts/**', font)
  // watch('./public/**', extra)
  // bs.reload 刷新服务
  watch([
    './src/assets/images/**',
    './src/assets/fonts/**',
    './public/**'
  ], bs.reload)
  // 通过 init 方法初始化开发服务器配置
  bs.init(&#123;
    // 关闭 browser-sync 启动时的小提示
    nitify: false,
    // 设置端口
    prot: 8080,
    // 自动打开浏览器
    // open: false,
    // 配置 server
    // files: './dist/**',
    server: &#123;
      // 指定网站根目录
      baseDir: ['temp', 'src', 'public'],
      // 优先 baseDir 的配置
      routes: &#123;
        '/node_modules': './node_modules'
      &#125;
    &#125;
  &#125;)
&#125;

// useref 会自动处理 html 中的构建注释
const useref = () => &#123;
  return src('./temp/*.html', &#123; base: 'temp' &#125;)
    .pipe(plugins.useref(&#123; searchPath: ['temp', '.'] &#125;))
    // 文件压缩
    .pipe(plugins.if(/\.js$/, plugins.uglify()))
    .pipe(plugins.if(/\.css$/, plugins.cleanCss()))
    .pipe(plugins.if(/\.html$/, plugins.htmlmin(&#123;
      // 去除空白字符
      collapseWhitespace: true,
      // 压缩 style
      minifyCSS: true,
      // 压缩 script
      minifyJS: true
    &#125;)))
    .pipe(dest('dist'))
&#125;

const compile = parallel(style, script, page)
const build = series(clean, parallel(series(compile, useref), image, font, extra))
const develop = series(compile, serve)

module.exports = &#123;
  clean,
  build,
  develop
&#125;
<span class="copy-code-btn">复制代码</span></code></pre>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p>封装工作流</p>
<ul>
<li>构建工作流 = gulpfile + gulp</li>
</ul>
</li>
</ul>
</li>
</ul></div>  
</div>
            