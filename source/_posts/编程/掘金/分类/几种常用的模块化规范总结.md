
---
title: '几种常用的模块化规范总结'
categories: 
 - 编程
 - 掘金
 - 分类
headimg: 'https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6cafc15a4faf48758648737db1a15e36~tplv-k3u1fbpfcp-watermark.image'
author: 掘金
comments: false
date: Sun, 04 Apr 2021 23:26:59 GMT
thumbnail: 'https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6cafc15a4faf48758648737db1a15e36~tplv-k3u1fbpfcp-watermark.image'
---

<div>   
<div class="markdown-body"><style>.markdown-body&#123;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333&#125;.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6&#123;line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px&#125;.markdown-body h1&#123;font-size:30px;margin-bottom:5px&#125;.markdown-body h2&#123;padding-bottom:12px;font-size:24px;border-bottom:1px solid #ececec&#125;.markdown-body h3&#123;font-size:18px;padding-bottom:0&#125;.markdown-body h4&#123;font-size:16px&#125;.markdown-body h5&#123;font-size:15px&#125;.markdown-body h6&#123;margin-top:5px&#125;.markdown-body p&#123;line-height:inherit;margin-top:22px;margin-bottom:22px&#125;.markdown-body img&#123;max-width:100%&#125;.markdown-body hr&#123;border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px&#125;.markdown-body code&#123;word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em&#125;.markdown-body code,.markdown-body pre&#123;font-family:Menlo,Monaco,Consolas,Courier New,monospace&#125;.markdown-body pre&#123;overflow:auto;position:relative;line-height:1.75&#125;.markdown-body pre>code&#123;font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8&#125;.markdown-body a&#123;text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff&#125;.markdown-body a:active,.markdown-body a:hover&#123;color:#275b8c&#125;.markdown-body table&#123;display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6&#125;.markdown-body thead&#123;background:#f6f6f6;color:#000;text-align:left&#125;.markdown-body tr:nth-child(2n)&#123;background-color:#fcfcfc&#125;.markdown-body td,.markdown-body th&#123;padding:12px 7px;line-height:24px&#125;.markdown-body td&#123;min-width:120px&#125;.markdown-body blockquote&#123;color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8&#125;.markdown-body blockquote:after&#123;display:block;content:""&#125;.markdown-body blockquote>p&#123;margin:10px 0&#125;.markdown-body ol,.markdown-body ul&#123;padding-left:28px&#125;.markdown-body ol li,.markdown-body ul li&#123;margin-bottom:0;list-style:inherit&#125;.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item&#123;list-style:none&#125;.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul&#123;margin-top:0&#125;.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul&#123;margin-top:3px&#125;.markdown-body ol li&#123;padding-left:6px&#125;.markdown-body .contains-task-list&#123;padding-left:0&#125;.markdown-body .task-list-item&#123;list-style:none&#125;@media (max-width:720px)&#123;.markdown-body h1&#123;font-size:24px&#125;.markdown-body h2&#123;font-size:20px&#125;.markdown-body h3&#123;font-size:18px&#125;&#125;</style><h1 data-id="heading-0">一、CommonJS规范</h1>
<p>在CommonJS目录下创建三个文件：</p>
<ul>
<li>CommonJS/moduleB.js</li>
</ul>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-built_in">module</span>.exports = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().getTime();
<span class="copy-code-btn">复制代码</span></code></pre>
<ul>
<li>CommonJS/moduleA.js</li>
</ul>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-keyword">const</span> timestamp = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./moduleB'</span>);
<span class="hljs-built_in">console</span>.log(<span class="hljs-string">'moduleA:::'</span>, timestamp);
<span class="copy-code-btn">复制代码</span></code></pre>
<ul>
<li>CommonJS/index.js</li>
</ul>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-built_in">require</span>(<span class="hljs-string">'./moduleA'</span>);
<span class="hljs-keyword">const</span> timestamp = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./moduleB'</span>);
<span class="hljs-built_in">console</span>.log(<span class="hljs-string">'index:::'</span>, timestamp);
<span class="copy-code-btn">复制代码</span></code></pre>
<p>其中，CommonJS/index.js引用了moduleA，而moduleA中引用了moduleB，另外，CommonJS/index.js还直接引用了moduleB，可见moduleB是被引用了两次。在这样的ModuleB被两次依赖的情况下，ModuleB是否会被执行两次呢？</p>
<p>通过执行<code>node CommonJS/index.js</code>我们来看看输出结果：</p>
<pre><code class="copyable">moduleA::: 1617595616025
index::: 1617595616025
<span class="copy-code-btn">复制代码</span></code></pre>
<p>可以看出，虽然ModuleB被依赖了两次，但是输出的时间戳的值是一样的，可见，ModuleB并没有被执行两次。</p>
<p>总结一下，关于CommonJS规范：</p>
<p>1、JavaScript原生并不支持该规范，在没有经过打包工具打包的情况下，它是只可以在Node.js环境中运作的（在浏览器环境下不支持该规范，会报错）；</p>
<p>2、CommonJS模块被多次引用时，会保持模块是一个单例，而不会被重复执行多次；</p>
<p>3、用module.exports导出模块，用require引入模块。</p>
<h1 data-id="heading-1">二、AMD规范</h1>
<p>受到CommonJS模块化规范的启发，浏览器端逐步发展起来了AMD规范。AMD全称为Asynchronous module definition，意为异步的模块定义。正如其名，所有模块默认都是异步加载的，这也是当时为了满足Web开发的需要，因为如果在Web端也像CommonJS规范那样同步加载的话，那么页面在解析脚本文件的过程中可能由于耗时过长，而使得页面暂停响应。</p>
<p>在AMD文件夹下新建4个文件：</p>
<ul>
<li>AMD/index.html</li>
</ul>
<pre><code class="hljs language-html copyable" lang="html"><span class="hljs-meta"><!DOCTYPE <span class="hljs-meta-keyword">html</span>></span>
<span class="hljs-tag"><<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>></span>
<span class="hljs-tag"><<span class="hljs-name">head</span>></span>
  <span class="hljs-tag"><<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>></span>
  <span class="hljs-tag"><<span class="hljs-name">meta</span> <span class="hljs-attr">http-equiv</span>=<span class="hljs-string">"X-UA-Compatible"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"IE=edge"</span>></span>
  <span class="hljs-tag"><<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>></span>
  <span class="hljs-tag"><<span class="hljs-name">title</span>></span>test AMD<span class="hljs-tag"></<span class="hljs-name">title</span>></span>
<span class="hljs-tag"></<span class="hljs-name">head</span>></span>
<span class="hljs-tag"><<span class="hljs-name">body</span>></span>
  <span class="hljs-tag"><<span class="hljs-name">h2</span>></span>test AMD<span class="hljs-tag"></<span class="hljs-name">h2</span>></span>
  <span class="hljs-tag"><<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://requirejs.org/docs/release/2.1.16/minified/require.js"</span>></span><span class="hljs-tag"></<span class="hljs-name">script</span>></span>
  <span class="hljs-tag"><<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"./index.js"</span>></span><span class="hljs-tag"></<span class="hljs-name">script</span>></span>
<span class="hljs-tag"></<span class="hljs-name">body</span>></span>
<span class="hljs-tag"></<span class="hljs-name">html</span>></span>
<span class="copy-code-btn">复制代码</span></code></pre>
<ul>
<li>AMD/index.js</li>
</ul>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-built_in">require</span>([
  <span class="hljs-string">'./moduleA.js'</span>,
  <span class="hljs-string">'./moduleB.js'</span>
], <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">moduleA, moduleB</span>) </span>&#123;
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'index:::'</span>, moduleB);
&#125;);
<span class="copy-code-btn">复制代码</span></code></pre>
<ul>
<li>AMD/moduleA.js</li>
</ul>
<pre><code class="hljs language-js copyable" lang="js">define(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"><span class="hljs-built_in">require</span></span>) </span>&#123;
  <span class="hljs-keyword">const</span> timestamp = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./moduleB.js'</span>);
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'moduleA:::'</span>, timestamp);
&#125;);
<span class="copy-code-btn">复制代码</span></code></pre>
<ul>
<li>AMD/moduleB.js</li>
</ul>
<pre><code class="hljs language-js copyable" lang="js">define(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"><span class="hljs-built_in">require</span></span>) </span>&#123;
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().getTime();
&#125;);
<span class="copy-code-btn">复制代码</span></code></pre>
<p>然后执行<code>npm install -g anywhere</code>安装静态服务启动工具anywhere，并执行</p>
<pre><code class="hljs language-sh copyable" lang="sh"><span class="hljs-built_in">cd</span> AMD
anywhere -p 80
<span class="copy-code-btn">复制代码</span></code></pre>
<p>在80端口上启动静态资源服务器。</p>
<p>然后通过 <a href="http://localhost/" target="_blank" rel="nofollow noopener noreferrer">http://localhost</a> 访问该服务，在Chrome Devtools的console面板上可看到如下输出：</p>
<pre><code class="copyable">moduleA::: 1617597603392
index::: 1617597603392
<span class="copy-code-btn">复制代码</span></code></pre>
<p>这表明同CommonJS规范一样，AMD规范中，模块被多次引用时，也是单例的，不会被执行多次。</p>
<p>接下来，我们把AMD/index.js文件的内容改成如下，即去除AMD/index.js对moduleB的依赖：</p>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-built_in">require</span>([
  <span class="hljs-string">'./moduleA.js'</span>,
], <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">moduleA</span>) </span>&#123;
&#125;);
<span class="copy-code-btn">复制代码</span></code></pre>
<p>然后，我们打开Chrome Devtools的Network面板，把网络模式Slow 3G（如下图）。</p>
<p><img alt="image.png" class="lazyload" src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6cafc15a4faf48758648737db1a15e36~tplv-k3u1fbpfcp-watermark.image" data-width="800" data-height="600" referrerpolicy="no-referrer"></p>
<p>然后刷新一下页面，查看到各JS文件的加载顺序如下图：</p>
<p><img alt="image.png" class="lazyload" src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/15c1780533da4e0291ed5aa6740a6682~tplv-k3u1fbpfcp-watermark.image" data-width="800" data-height="600" referrerpolicy="no-referrer"></p>
<p>可见，ModuleA和ModuleB这两个AMD模块确实是异步加载的，且因为ModuleA所依赖的ModuleB，也是在ModuleA加载完之后才去异步地加载ModueB的。</p>
<p>AMD异步加载的核心原理是使用了JSONP来加载模块。</p>
<p>总结一下：</p>
<p>1、AMD规范是运行在浏览器端的，不能运行在Node.js环境中。</p>
<p>2、AMD默认是支持模块异步加载的。因为如果在Web端也像CommonJS规范那样同步加载的话，那么页面在解析脚本文件的过程中可能由于耗时过长，而使得页面暂停响应。</p>
<p>3、AMD模块被多次引用时，会保持模块是一个单例，而不会被重复执行多次；</p>
<p>4、用<code>define(function (require) &#123;&#125;)</code>（匿名模块，以文件名为模块名） 或者 <code>define('模块id', ['依赖数组'], function([依赖数组])&#123;&#125;);</code>（具名模块）定义模块，用<code>require(['./xxx.js'], function(xxx) &#123;&#125;)</code>引入模块，其中第二个参数是回调。</p>
<h1 data-id="heading-2">三、UMD规范</h1>
<p>UMD全称是Universal Module Definition（通用模块规范），它是由社区想出来的一种整合了CommonJS和AMD两个模块定义规范的方法。所以，严格意义上说，它并不是一个独立的模块化规范。其基本原理是用一个工厂函数来统一不同的模块定义规范。</p>
<p>下面基于UMD规范写一个简单的例子（模块内容只是纯演示，该内容不是一个值得封装成模块的东西）：</p>
<ul>
<li>UMD/index.html</li>
</ul>
<pre><code class="hljs language-html copyable" lang="html"><span class="hljs-meta"><!DOCTYPE <span class="hljs-meta-keyword">html</span>></span>
<span class="hljs-tag"><<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>></span>
<span class="hljs-tag"><<span class="hljs-name">head</span>></span>
  <span class="hljs-tag"><<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>></span>
  <span class="hljs-tag"><<span class="hljs-name">meta</span> <span class="hljs-attr">http-equiv</span>=<span class="hljs-string">"X-UA-Compatible"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"IE=edge"</span>></span>
  <span class="hljs-tag"><<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>></span>
  <span class="hljs-tag"><<span class="hljs-name">title</span>></span>test 111<span class="hljs-tag"></<span class="hljs-name">title</span>></span>
<span class="hljs-tag"></<span class="hljs-name">head</span>></span>
<span class="hljs-tag"><<span class="hljs-name">body</span>></span>
  <span class="hljs-tag"><<span class="hljs-name">button</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"btn"</span>></span>按钮<span class="hljs-tag"></<span class="hljs-name">button</span>></span>
  <span class="hljs-tag"><<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"container"</span>></span><span class="hljs-tag"></<span class="hljs-name">div</span>></span>
  <span class="hljs-tag"><<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"./jquery.js"</span>></span><span class="hljs-tag"></<span class="hljs-name">script</span>></span>
  <span class="hljs-tag"><<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"./moduleA.js"</span>></span><span class="hljs-tag"></<span class="hljs-name">script</span>></span>
  <span class="hljs-tag"><<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"./index.js"</span>></span><span class="hljs-tag"></<span class="hljs-name">script</span>></span>
<span class="hljs-tag"></<span class="hljs-name">body</span>></span>
<span class="hljs-tag"></<span class="hljs-name">html</span>></span>
<span class="copy-code-btn">复制代码</span></code></pre>
<ul>
<li>UMD/index.js</li>
</ul>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-built_in">window</span>.moduleA.init();
<span class="copy-code-btn">复制代码</span></code></pre>
<ul>
<li>UMD/jquery.js</li>
</ul>
<p>略去，从网上下载一个jQuery.js文件放在这里即可。</p>
<ul>
<li>UMD/moduleA.js</li>
</ul>
<pre><code class="hljs language-js copyable" lang="js">(<span class="hljs-function">(<span class="hljs-params"><span class="hljs-built_in">global</span>, factory</span>) =></span> &#123;
  <span class="hljs-comment">//如果 当前的上下文有define函数，并且AMD  说明处于AMD 环境下</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> define === <span class="hljs-string">'function'</span> && define.amd) &#123;
    <span class="hljs-comment">// 检查AMD是否可用</span>
    define([<span class="hljs-string">'./jquery'</span>], factory);
  &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-built_in">exports</span> === <span class="hljs-string">'object'</span>) &#123;
    <span class="hljs-comment">// 检查CommonJS是否可用</span>
    modules.exports = factory(<span class="hljs-built_in">require</span>(<span class="hljs-string">'./jquery'</span>));
  &#125; <span class="hljs-keyword">else</span> &#123;
    <span class="hljs-comment">// 两种都不能用，把模块添加到JavaScript的全局命名空间中</span>
    <span class="hljs-built_in">global</span>.moduleA = factory(<span class="hljs-built_in">global</span>.jQuery);
  &#125;
&#125;)(<span class="hljs-built_in">this</span>, <span class="hljs-function">(<span class="hljs-params">$</span>) =></span> &#123;
  <span class="hljs-comment">//本模块的定义</span>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">init</span>(<span class="hljs-params"></span>) </span>&#123;
    <span class="hljs-keyword">var</span> $container = $(<span class="hljs-string">'#container'</span>);
    <span class="hljs-keyword">var</span> count = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">var</span> text = [<span class="hljs-string">'关'</span>, <span class="hljs-string">'开'</span>];
    <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">'btn'</span>).addEventListener(<span class="hljs-string">'click'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>&#123;
      count += <span class="hljs-number">1</span>;
      $container.html(text[count % <span class="hljs-number">2</span>]);
    &#125;);
  &#125;

  <span class="hljs-keyword">return</span> &#123;
    <span class="hljs-attr">init</span>: init
  &#125;
&#125;)
<span class="copy-code-btn">复制代码</span></code></pre>
<h1 data-id="heading-3">四、ESModule</h1>
<p>不管是CommonJS还是AMD，都是由语言上层的运行环境中实现的模块化规范，模块化规范由环境自己定义。但是ESModule是在语言层面实现的。</p>
<p><img alt="image.png" class="lazyload" src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/99b97a1c7eb84df0a75e87d1282b484f~tplv-k3u1fbpfcp-watermark.image" data-width="800" data-height="600" referrerpolicy="no-referrer"></p>
<p>先创建如下5个文件：</p>
<ul>
<li>ESModule/index.html</li>
</ul>
<pre><code class="hljs language-html copyable" lang="html"><span class="hljs-meta"><!DOCTYPE <span class="hljs-meta-keyword">html</span>></span>
<span class="hljs-tag"><<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>></span>
<span class="hljs-tag"><<span class="hljs-name">head</span>></span>
  <span class="hljs-tag"><<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>></span>
  <span class="hljs-tag"><<span class="hljs-name">meta</span> <span class="hljs-attr">http-equiv</span>=<span class="hljs-string">"X-UA-Compatible"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"IE=edge"</span>></span>
  <span class="hljs-tag"><<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>></span>
  <span class="hljs-tag"><<span class="hljs-name">title</span>></span>test ESModule<span class="hljs-tag"></<span class="hljs-name">title</span>></span>
<span class="hljs-tag"></<span class="hljs-name">head</span>></span>
<span class="hljs-tag"><<span class="hljs-name">body</span>></span>
  <span class="hljs-tag"><<span class="hljs-name">h2</span>></span>test ESModule<span class="hljs-tag"></<span class="hljs-name">h2</span>></span>
  <span class="hljs-tag"><<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"./dist/index.bundle.js"</span>></span><span class="hljs-tag"></<span class="hljs-name">script</span>></span>
<span class="hljs-tag"></<span class="hljs-name">body</span>></span>
<span class="hljs-tag"></<span class="hljs-name">html</span>></span>
<span class="copy-code-btn">复制代码</span></code></pre>
<ul>
<li>ESModule/index.js</li>
</ul>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-keyword">import</span> <span class="hljs-string">'./moduleA.js'</span>;
<span class="hljs-keyword">import</span> timestamp <span class="hljs-keyword">from</span> <span class="hljs-string">'./moduleB.js'</span>;

<span class="hljs-built_in">console</span>.log(<span class="hljs-string">'index:::'</span>, timestamp);
<span class="copy-code-btn">复制代码</span></code></pre>
<ul>
<li>ESModule/moduleA.js</li>
</ul>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-keyword">import</span> timestamp <span class="hljs-keyword">from</span> <span class="hljs-string">'./moduleB.js'</span>;

<span class="hljs-built_in">console</span>.log(<span class="hljs-string">'moduleA:::'</span>, timestamp);
<span class="copy-code-btn">复制代码</span></code></pre>
<ul>
<li>ESModule/moduleB.js</li>
</ul>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().getTime();
<span class="copy-code-btn">复制代码</span></code></pre>
<p>然后安装依赖：</p>
<pre><code class="hljs language-sh copyable" lang="sh">yarn add webpack webpack-cli @babel/core babel-loader @babel/preset-env
<span class="copy-code-btn">复制代码</span></code></pre>
<p>并修改package.json中的scripts为：</p>
<pre><code class="hljs language-json copyable" lang="json"><span class="hljs-string">"scripts"</span>: &#123;
    <span class="hljs-attr">"build"</span>: <span class="hljs-string">"webpack"</span>
&#125;,
<span class="copy-code-btn">复制代码</span></code></pre>
<p>执行<code>npm run build</code>进行打包。然后执行<code>anywhere -p 80</code>启动静态服务器。</p>
<p>然后通过 <a href="http://localhost/" target="_blank" rel="nofollow noopener noreferrer">http://localhost</a> 访问该服务，在Chrome Devtools的console面板上可看到如下输出：</p>
<pre><code class="copyable">moduleA::: 1617601623808
index::: 1617601623808
<span class="copy-code-btn">复制代码</span></code></pre>
<p>不过，由于兼容性的问题，ESModule目前在浏览器环境下还不能直接使用，需要进行打包编译。</p>
<p>Babel会将ES6中的<code>import</code>和<code>export</code>编译成CommonJS规范的<code>require</code>和<code>exports</code>。如下图所致，左边是编译前的代码，右边是编译后的代码（可以到<a href="https://www.babeljs.cn/" target="_blank" rel="nofollow noopener noreferrer">www.babeljs.cn/</a>中体验测试）：</p>
<p><img alt="image.png" class="lazyload" src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ff8a079c608a4be58e1841d0c834708d~tplv-k3u1fbpfcp-watermark.image" data-width="800" data-height="600" referrerpolicy="no-referrer"></p>
<p>但是我们知道，CommonJS是无法运行在浏览器端的，怎么让它能够变成能运行在浏览器端的代码呢？这就是打包要做的事情了。</p>
<p>那么Node.js中是如何做到能运行CommonJS模块的呢？</p>
<p>例如，对于这样一段CommonJS代码：</p>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-built_in">require</span>(<span class="hljs-string">'./moduleA'</span>);
<span class="hljs-keyword">const</span> timestamp = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./moduleB'</span>);
<span class="hljs-built_in">console</span>.log(<span class="hljs-string">'index:::'</span>, timestamp);
<span class="copy-code-btn">复制代码</span></code></pre>
<p>它是这样处理的，通过fs模块读到模块的代码字符串，然后在其头部拼接上function(require, module, exports) &#123;，在其尾部拼接上&#125;，最后将拼接得到的字符串放入<code>vm.runInNewContext</code>API中执行：</p>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-keyword">const</span> str = <span class="hljs-string">'require('</span>./moduleA<span class="hljs-string">');const timestamp = require('</span>./moduleB<span class="hljs-string">');console.log('</span>index:::<span class="hljs-string">', timestamp);'</span>

<span class="hljs-keyword">const</span> functionWrapper = [
    <span class="hljs-string">'function(require, module, exports) &#123;'</span>,
    <span class="hljs-string">'&#125;'</span>
];

<span class="hljs-keyword">const</span> result = functionWrapper[<span class="hljs-number">0</span>] + str + functionWrapper[<span class="hljs-number">1</span>];
<span class="hljs-keyword">const</span> vm = <span class="hljs-built_in">require</span>(<span class="hljs-string">'vm'</span>);

vm.runInNewContext(result);
<span class="copy-code-btn">复制代码</span></code></pre>
<p>vm是Node.js中的一个内置模块，其runInNewContext方法的作用相当于<code>new Function(codeStr)()</code> （<a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank" rel="nofollow noopener noreferrer">参见这里</a>）或者 <code>eval(codeStr)</code>（<a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/eval" target="_blank" rel="nofollow noopener noreferrer">参见这里</a>），关于runInNewContext方法的用法可参见<a href="https://nodejs.org/dist/latest-v14.x/docs/api/vm.html#vm_vm_runincontext_code_contextifiedobject_options" target="_blank" rel="nofollow noopener noreferrer">Node.js的官方文档</a>。</p>
<p>此外，还有人可能用过<a href="https://github.com/seajs/seajs/issues/242" target="_blank" rel="nofollow noopener noreferrer">CMD规范</a>，但因为它毕竟当前应用已经不那么多了，这里就不介绍了，感兴趣的可以自行了解下。</p></div> <div class="image-viewer-box" data-v-78c9b824><!----></div>  
</div>
            