
---
title: '搭建一个属于自己的图床'
categories: 
 - 编程
 - 掘金
 - 分类
headimg: 'https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b3b42aa3f7f442ef9aa271c33dfbf005~tplv-k3u1fbpfcp-zoom-1.image'
author: 掘金
comments: false
date: Sun, 18 Jul 2021 09:34:04 GMT
thumbnail: 'https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b3b42aa3f7f442ef9aa271c33dfbf005~tplv-k3u1fbpfcp-zoom-1.image'
---

<div>   
<div class="markdown-body"><style>.markdown-body&#123;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333&#125;.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6&#123;line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px&#125;.markdown-body h1&#123;font-size:30px;margin-bottom:5px&#125;.markdown-body h2&#123;padding-bottom:12px;font-size:24px;border-bottom:1px solid #ececec&#125;.markdown-body h3&#123;font-size:18px;padding-bottom:0&#125;.markdown-body h4&#123;font-size:16px&#125;.markdown-body h5&#123;font-size:15px&#125;.markdown-body h6&#123;margin-top:5px&#125;.markdown-body p&#123;line-height:inherit;margin-top:22px;margin-bottom:22px&#125;.markdown-body img&#123;max-width:100%&#125;.markdown-body hr&#123;border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px&#125;.markdown-body code&#123;word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em&#125;.markdown-body code,.markdown-body pre&#123;font-family:Menlo,Monaco,Consolas,Courier New,monospace&#125;.markdown-body pre&#123;overflow:auto;position:relative;line-height:1.75&#125;.markdown-body pre>code&#123;font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8&#125;.markdown-body a&#123;text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff&#125;.markdown-body a:active,.markdown-body a:hover&#123;color:#275b8c&#125;.markdown-body table&#123;display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6&#125;.markdown-body thead&#123;background:#f6f6f6;color:#000;text-align:left&#125;.markdown-body tr:nth-child(2n)&#123;background-color:#fcfcfc&#125;.markdown-body td,.markdown-body th&#123;padding:12px 7px;line-height:24px&#125;.markdown-body td&#123;min-width:120px&#125;.markdown-body blockquote&#123;color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8&#125;.markdown-body blockquote:after&#123;display:block;content:""&#125;.markdown-body blockquote>p&#123;margin:10px 0&#125;.markdown-body ol,.markdown-body ul&#123;padding-left:28px&#125;.markdown-body ol li,.markdown-body ul li&#123;margin-bottom:0;list-style:inherit&#125;.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item&#123;list-style:none&#125;.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul&#123;margin-top:0&#125;.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul&#123;margin-top:3px&#125;.markdown-body ol li&#123;padding-left:6px&#125;.markdown-body .contains-task-list&#123;padding-left:0&#125;.markdown-body .task-list-item&#123;list-style:none&#125;@media (max-width:720px)&#123;.markdown-body h1&#123;font-size:24px&#125;.markdown-body h2&#123;font-size:20px&#125;.markdown-body h3&#123;font-size:18px&#125;&#125;</style><h2 data-id="heading-0">前言</h2>
<p>我们在使用Typora进行创作时，文章中的图片可以选择保存到本地或者上传到第三方服务方的图床。</p>
<p>如果图片保存到本地，当我们需要在互联网和别人分享自己创作的内容时，图片是无法显示的，而第三方图床基本上都是收费的。</p>
<p>本文就将跟大家分享下如何搭建一个属于自己的图床，欢迎各位感兴趣的开发者阅读本文。</p>
<h2 data-id="heading-1">环境搭建</h2>
<p>在typora的偏好配置中，我们切换到图像一栏，如下所示：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b3b42aa3f7f442ef9aa271c33dfbf005~tplv-k3u1fbpfcp-zoom-1.image" alt="image-20210717193829888" loading="lazy" referrerpolicy="no-referrer"></p>
<ul>
<li>图中序号1位置，可以选择插入图片时的行为，点开后我们选择上传图片选项</li>
<li>图中序号2位置，可以选择上传图片时用哪个图床客户端，点开后我们选择uPic选项</li>
</ul>
<h3 data-id="heading-2">安装图床客户端</h3>
<p>进入uPic项目的<a href="https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Fgee1k%2FuPic" target="_blank" rel="nofollow noopener noreferrer" title="https://github.com/gee1k/uPic" ref="nofollow noopener noreferrer">GitHub主页</a>，在<a href="https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Fgee1k%2FuPic%2Freleases" target="_blank" rel="nofollow noopener noreferrer" title="https://github.com/gee1k/uPic/releases" ref="nofollow noopener noreferrer">Releases</a>页面<a href="https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Fgee1k%2FuPic%2Freleases%2Fdownload%2Fv0.21.1%2FuPic.zip" target="_blank" rel="nofollow noopener noreferrer" title="https://github.com/gee1k/uPic/releases/download/v0.21.1/uPic.zip" ref="nofollow noopener noreferrer">下载</a>安装包即可。</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/78aa650750434882a2b903cff1b6a39a~tplv-k3u1fbpfcp-zoom-1.image" alt="image-20210717200041404" loading="lazy" referrerpolicy="no-referrer"></p>
<p>下载完成，解压后，将其拖拽到 <strong>应用程序</strong> 文件夹中。</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/8f31ae3d36f040d7ac1ebf579f0bc853~tplv-k3u1fbpfcp-zoom-1.image" alt="image-20210717200357604" loading="lazy" referrerpolicy="no-referrer"></p>
<h3 data-id="heading-3">配置客户端</h3>
<p>打开应用程序后，会在菜单栏出现一个图标，点击后在出现的选项中，点击“偏好设置”，如下所示：<img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/645874b9622a4a398c27a0cb8ffc9fb4~tplv-k3u1fbpfcp-zoom-1.image" alt="image-20210717201111583" loading="lazy" referrerpolicy="no-referrer"></p>
<p>在打开的界面中，点击左下角的加号，在弹出的选项中点击自定义，如下图所示：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/176174d814d94aab83dffa7190a767dd~tplv-k3u1fbpfcp-zoom-1.image" alt="image-20210717201448420" loading="lazy" referrerpolicy="no-referrer"></p>
<p>选择自定义后，会出现如下所示的界面：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/8a587e70561b4cbb98a4e003ab49922c~tplv-k3u1fbpfcp-zoom-1.image" alt="image-20210717202944353" loading="lazy" referrerpolicy="no-referrer"></p>
<h4 data-id="heading-4">上传资源所需配置</h4>
<p>我们先来降下前4个标注的作用：</p>
<ul>
<li>序号1标注为上传服务的接口地址</li>
<li>序号2标注为接口的请求方式</li>
<li>序号3标注，接口解析文件流时的字段名</li>
<li>序号4标注为调用上传接口时所需的其他字段，界面如下所示：</li>
</ul>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/40381f14890d430194ad4d636cd44be6~tplv-k3u1fbpfcp-zoom-1.image" alt="image-20210717203729412" loading="lazy" referrerpolicy="no-referrer"></p>
<blockquote>
<p>注意：我们需要增加一个Header字段，键名为：<code>Content-Type</code>，值为：<code>multipart/form-data; charset=utf-8;</code>。</p>
<p>如果不添加，你的接口则会报错。</p>
<p>body字段则是你调用上传接口时，所需的其它额外参数。</p>
</blockquote>
<h4 data-id="heading-5">获取资源所需配置</h4>
<p>接下来，我们继续看下其他标注的作用：</p>
<ul>
<li>
<p>标注5的值为上传成功后，接口所返回的文件路径地址。例如返回<code>&#123;path:"/uploads/20199afrj.png"&#125;</code>，我们需要取出path的值，这里就需要写<code>["path"]</code>，层级深的话则需要继续向数组中追加元素，详情请移步：<a href="https://link.juejin.cn/?target=https%3A%2F%2Fblog.svend.cc%2Fupic%2Ftutorials%2Fcustom%2F%23URL-%25E8%258E%25B7%25E5%258F%2596%25E8%25A7%2584%25E5%2588%2599" target="_blank" rel="nofollow noopener noreferrer" title="https://blog.svend.cc/upic/tutorials/custom/#URL-%E8%8E%B7%E5%8F%96%E8%A7%84%E5%88%99" ref="nofollow noopener noreferrer">URL 获取规则</a></p>
</li>
<li>
<p>标注6为获取到上传的文件后，需要进行拼接的域名前缀</p>
</li>
<li>
<p>配置完成后，我们可以点击验证来看下服务是否正常，如果正常你会看到如下所示的提示：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f6e581bd189f4c65880c51f494167aff~tplv-k3u1fbpfcp-zoom-1.image" alt="image-20210717212425413" loading="lazy" referrerpolicy="no-referrer"></p>
</li>
</ul>
<p>最后，点击标注7的保存，我们的配置就完成了。</p>
<h2 data-id="heading-6">上传服务</h2>
<p>上传服务可以使用任何一门后端语言来编写，只要遵循文件上传规范即可，由于后端语言我只会Java，本文就以Java+SpringBoot框架为例，写一段示例代码。</p>
<h3 data-id="heading-7">控制层</h3>
<p>我们先来看下<code>controller</code>层的代码，如下所示：</p>
<pre><code class="hljs language-java copyable" lang="java"><span class="hljs-keyword">import</span> org.springframework.stereotype.Controller;
<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.*;
<span class="hljs-keyword">import</span> com.lk.service.FileUploadService;
<span class="hljs-keyword">import</span> javax.annotation.Resource;
<span class="hljs-keyword">import</span> java.io.IOException;
<span class="hljs-keyword">import</span> java.util.HashMap;
<span class="hljs-keyword">import</span> java.util.Map;
<span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;

<span class="hljs-meta">@Slf4j</span>
<span class="hljs-meta">@Controller</span>
<span class="hljs-comment">// 允许跨域访问</span>
<span class="hljs-meta">@CrossOrigin()</span>
<span class="hljs-meta">@RequestMapping("/uploads")</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FileUploadController</span> </span>&#123;
    <span class="hljs-comment">// 注入文件上传服务</span>
    <span class="hljs-meta">@Resource(name = "FileUploadServiceImpl")</span>
    <span class="hljs-keyword">private</span> FileUploadService fileUploadService;
  
    <span class="hljs-meta">@PostMapping("/singleFileUploadToPath")</span>
    <span class="hljs-meta">@ResponseBody</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> Map<String, Object> <span class="hljs-title">singleFileUploadToPath</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam("file")</span> MultipartFile file, <span class="hljs-meta">@RequestParam("path")</span> String path)</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;
        Map<String, Object> result = <span class="hljs-keyword">new</span> HashMap<>(<span class="hljs-number">16</span>);
        <span class="hljs-comment">// 调用单文件上传接口</span>
        <span class="hljs-keyword">return</span> fileUploadService.singleFileUpload(file, path);
    &#125;
&#125;
<span class="copy-code-btn">复制代码</span></code></pre>
<p>上述代码中，我们接受两个参数：</p>
<ul>
<li>file：上传过来的文件流</li>
<li>path：上传路径名</li>
</ul>
<h3 data-id="heading-8">接口层</h3>
<p>接下来，我们来看下<code>service</code>层的代码，如下所示：</p>
<pre><code class="hljs language-java copyable" lang="java"><span class="hljs-keyword">import</span> org.springframework.web.multipart.MultipartFile;

<span class="hljs-comment">// 文件上传接口</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">FileUploadService</span> </span>&#123;
      <span class="hljs-function">Map<String, Object> <span class="hljs-title">singleFileUpload</span><span class="hljs-params">(MultipartFile file, String path)</span> <span class="hljs-keyword">throws</span> IOException</span>;
&#125;
<span class="copy-code-btn">复制代码</span></code></pre>
<h3 data-id="heading-9">实现层</h3>
<p>最后，我们来看下<code>serviceimpl</code>层的代码，如下所示：</p>
<pre><code class="hljs language-java copyable" lang="java"><span class="hljs-keyword">import</span> java.util.Map;
<span class="hljs-keyword">import</span> com.lk.service.FileUploadService;
<span class="hljs-keyword">import</span> org.springframework.web.multipart.MultipartFile;
<span class="hljs-keyword">import</span> java.io.IOException;
<span class="hljs-keyword">import</span> java.util.HashMap;
<span class="hljs-keyword">import</span> java.io.File;
<span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Service;
<span class="hljs-keyword">import</span> org.springframework.web.multipart.MultipartFile;
<span class="hljs-keyword">import</span> com.lk.utils.UUIDUtil;
<span class="hljs-keyword">import</span> com.lk.utils.DateUtil;
<span class="hljs-keyword">import</span> com.lk.utils.FileUtil;

<span class="hljs-meta">@Slf4j</span>
<span class="hljs-meta">@Service("FileUploadServiceImpl")</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FileUploadServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">FileUploadService</span> </span>&#123;
    <span class="hljs-comment">// 从配置文件读取文件路径</span>
    <span class="hljs-meta">@Value("$&#123;uploadFilePath&#125;")</span>
    <span class="hljs-keyword">private</span> String fileBaseUrl;
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> Map<String, Object> <span class="hljs-title">singleFileUpload</span><span class="hljs-params">(MultipartFile file, String path)</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.writeFile(file, path);
    &#125;
  
    <span class="hljs-function"><span class="hljs-keyword">private</span> Map<String, Object> <span class="hljs-title">writeFile</span><span class="hljs-params">(MultipartFile file, String path)</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;
        String fileType = file.getContentType();
        <span class="hljs-keyword">long</span> fileSize = file.getSize();
        log.info(<span class="hljs-string">"[文件类型] - [&#123;&#125;]"</span>, fileType);
        log.info(<span class="hljs-string">"[文件名称] - [&#123;&#125;]"</span>, file.getOriginalFilename());
        log.info(<span class="hljs-string">"[文件大小] - [&#123;&#125;]"</span>, fileSize);
        <span class="hljs-comment">// 文件名</span>
        String fileName = file.getOriginalFilename();
        <span class="hljs-keyword">assert</span> fileName != <span class="hljs-keyword">null</span>;
        <span class="hljs-comment">// 生成文件名</span>
        String finalFileName = UUIDUtil.getUUID()+fileName.substring(fileName.lastIndexOf(<span class="hljs-string">"."</span>));
        <span class="hljs-comment">// 向客户端推送文件信息</span>
        Map<String, Object> result = <span class="hljs-keyword">new</span> HashMap<>(<span class="hljs-number">16</span>);
        <span class="hljs-keyword">if</span> (path.length() != <span class="hljs-number">0</span>) &#123;
            String dayTime = DateUtil.getTimeForDay();
            String writePath = fileBaseUrl + path + <span class="hljs-string">"/"</span> + dayTime + <span class="hljs-string">"/"</span>;
            <span class="hljs-comment">// 路径不存在时，则创建</span>
            Boolean touchResult  = FileUtil.touchFolder(writePath);
            <span class="hljs-keyword">if</span> (!touchResult) &#123;
                result.put(<span class="hljs-string">"code"</span>, -<span class="hljs-number">2</span>);
                result.put(<span class="hljs-string">"msg"</span>, <span class="hljs-string">"服务器错误: 路径创建失败"</span>);
                log.error(<span class="hljs-string">"上传路径创建失败"</span> + writePath);
                <span class="hljs-keyword">return</span> result;
            &#125;
            <span class="hljs-comment">// 则写入指定路径下</span>
            file.transferTo(<span class="hljs-keyword">new</span> File(writePath + finalFileName));
            result.put(<span class="hljs-string">"path"</span>, dayTime + <span class="hljs-string">"/"</span> + finalFileName);
        &#125; <span class="hljs-keyword">else</span> &#123;
            <span class="hljs-comment">// 将文件写入默认路径下</span>
            file.transferTo(<span class="hljs-keyword">new</span> File(fileBaseUrl + finalFileName));
        &#125;
        result.put(<span class="hljs-string">"code"</span>, <span class="hljs-number">0</span>);
        result.put(<span class="hljs-string">"data"</span>, <span class="hljs-string">"上传成功"</span>);
        result.put(<span class="hljs-string">"contentType"</span>, file.getContentType());
        result.put(<span class="hljs-string">"fileName"</span>, finalFileName);
        result.put(<span class="hljs-string">"fileSize"</span>, file.getSize() + <span class="hljs-string">""</span>);
        <span class="hljs-keyword">return</span> result;
    &#125;
&#125;
<span class="copy-code-btn">复制代码</span></code></pre>
<h3 data-id="heading-10">图床客户端请求头配置</h3>
<p>上述代码中所列举的上传服务，出了<code>file</code>字段外，还需要传<code>path</code>字段，那么在图床客户端的配置就如下所示：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b26c22b640c348c1bec45b8e1cc8275f~tplv-k3u1fbpfcp-zoom-1.image" alt="image-20210717222238001" loading="lazy" referrerpolicy="no-referrer"></p>
<h2 data-id="heading-11">实现效果</h2>
<p>最后，我们来看下配置完成后的效果，如下所示：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/839fbcdbeb7f49f288dbc525d40030a4~tplv-k3u1fbpfcp-zoom-1.image" alt="1111.gif" loading="lazy" referrerpolicy="no-referrer"></p>
<h2 data-id="heading-12">写在最后</h2>
<p>至此，文章就分享完毕了。</p>
<p>我是<strong>神奇的程序员</strong>，一位前端开发工程师。</p>
<p>如果你对我感兴趣，请移步我的<a href="https://link.juejin.cn/?target=https%3A%2F%2Fwww.kaisir.cn%2F" target="_blank" rel="nofollow noopener noreferrer" title="https://www.kaisir.cn/" ref="nofollow noopener noreferrer">个人网站</a>，进一步了解。</p>
<ul>
<li>文中如有错误，欢迎在评论区指正，如果这篇文章帮到了你，欢迎点赞和关注😊</li>
<li>本文首发于掘金，未经许可禁止转载💌</li>
</ul></div>  
</div>
            