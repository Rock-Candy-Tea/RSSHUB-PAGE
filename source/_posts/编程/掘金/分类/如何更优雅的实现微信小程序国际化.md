
---
title: '如何更优雅的实现微信小程序国际化'
categories: 
 - 编程
 - 掘金
 - 分类
headimg: 'https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4cfb78099a79467db3c85e3d5e20ac98~tplv-k3u1fbpfcp-watermark.image'
author: 掘金
comments: false
date: Fri, 21 May 2021 20:15:15 GMT
thumbnail: 'https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4cfb78099a79467db3c85e3d5e20ac98~tplv-k3u1fbpfcp-watermark.image'
---

<div>   
<div class="markdown-body"><style>.markdown-body&#123;color:#383838;font-size:15px;line-height:37.5px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:120px&#125;.markdown-body ::selection&#123;color:#fff;background-color:#a862ea&#125;.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6&#123;margin:30px 0 15px;color:#a862ea&#125;.markdown-body h1&#123;line-height:2;font-size:1.4em&#125;.markdown-body h1~p:first-of-type:first-letter&#123;color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder&#125;.markdown-body h2&#123;font-size:1.2em&#125;.markdown-body h3&#123;font-size:1.1em&#125;.markdown-body ol,.markdown-body ul&#123;padding-left:2em&#125;.markdown-body ol li,.markdown-body ul li&#123;margin-bottom:0;padding-left:.2em&#125;.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item&#123;list-style:none&#125;.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul&#123;margin-top:0&#125;.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul&#123;margin-top:10px&#125;.markdown-body li::marker&#123;color:#a862ea&#125;.markdown-body li,.markdown-body p&#123;opacity:.9;vertical-align:baseline;transition:all .1s ease&#125;.markdown-body li:hover,.markdown-body p:hover&#123;opacity:1&#125;.markdown-body a&#123;display:inline-block;color:#a862ea;cursor:pointer;padding-bottom:2px;text-decoration:none;position:relative&#125;.markdown-body a:after&#123;content:"";position:absolute;width:98%;height:2px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out&#125;.markdown-body a:hover:after&#123;transform:scaleX(1);transform-origin:bottom left&#125;.markdown-body a:active,.markdown-body a:link&#123;color:#a862ea&#125;.markdown-body img&#123;max-width:100%;user-select:none;margin:1em 0;box-shadow:0 0 20px 0 #e7daff;transition:transform .2s ease 0s;background-color:#f8f5ff&#125;.markdown-body img:hover&#123;opacity:1;transform:translateY(-2px)&#125;.markdown-body blockquote&#123;padding:.5em 1em;margin:15px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:4px solid #a862ea;background-color:#f8f5ff&#125;.markdown-body blockquote>p&#123;margin:0&#125;.markdown-body code&#123;padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff&#125;.markdown-body pre&#123;margin:2em 0;box-shadow:0 0 20px #e7daff&#125;.markdown-body pre>code&#123;display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:22.5px;color:#383838;border-radius:3px;scroll-behavior:smooth&#125;.markdown-body pre>code::-webkit-scrollbar&#123;height:6px;background-color:#f8f5ff&#125;.markdown-body pre>code::-webkit-scrollbar-thumb&#123;background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px&#125;.markdown-body hr&#123;margin:2em 0;border-top:1px solid #a862ea&#125;.markdown-body table&#123;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse;border:1px solid #e7daff&#125;.markdown-body thead&#123;color:#a862ea;background:#f8f5ff&#125;.markdown-body td,.markdown-body th&#123;padding:1em .5em&#125;.markdown-body tr&#123;background-color:#fcfcfc&#125;@media (max-width:720px)&#123;.markdown-body&#123;font-size:12px&#125;&#125;</style><h1 data-id="heading-0">常见的国际化方式</h1>
<h2 data-id="heading-1">官方方案</h2>
<p><a href="https://developers.weixin.qq.com/miniprogram/dev/extended/utils/miniprogram-i18n/quickstart.html" target="_blank" rel="nofollow noopener noreferrer">官方链接</a>，其实官方的解决方案最大的问题就是麻烦,主要体现在以下几个方面</p>
<h3 data-id="heading-2">强依赖目录结构</h3>
<p>由于gulp.js里是按照此目录结构进行处理的，如果要维持自定义目录需要修改glup文件，如下图</p>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4cfb78099a79467db3c85e3d5e20ac98~tplv-k3u1fbpfcp-watermark.image" alt="image.png" loading="lazy" referrerpolicy="no-referrer"></p>
<p><em>特别好笑的一点官方示例里居然不是这个目录结构，不过依然是强依赖目录结构，因为gulp中路径是写死的</em></p>
<h3 data-id="heading-3">文档简陋</h3>
<p>通过官方文档<strong>快速入门</strong>居然无法搭建起项目，暂时只用这种方式搭建起来了 <a href="https://github.com/wechat-miniprogram/miniprogram-i18n/blob/master/examples/README.md" target="_blank" rel="nofollow noopener noreferrer">官方github demo</a>，通过对比发现好多必要代码都没有在文档中说明。</p>
<p>比如需要在app.js中开始便需要执行<code>getI18nInstance()</code>，否则全局都无法正常国际化。这么重要的信息居然在<strong>快速入门</strong>中没有说明</p>
<h3 data-id="heading-4">调试麻烦</h3>
<p>每次修改代码都要重新执行<code>npm run build</code>,注意是<strong>每次</strong>。</p>
<p>由于国际化必须通过<code>npm run build</code>来实现，而每次<code>npm run build</code>过后<strong>dist文件</strong>就会被覆盖，所以每次只能修改src，而小程序预览的却是dist文件，这也就导致必须频繁的执行build命令。下面演示一下增加一个表头的操作步骤</p>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5c0bd9d113ef4c1aa14451073edce684~tplv-k3u1fbpfcp-watermark.image" alt="2021-05-22 07-57-21.2021-05-22 08_03_21.gif" loading="lazy" referrerpolicy="no-referrer"></p>
<h3 data-id="heading-5">说下优点</h3>
<p><strong>代码简洁</strong>。解释一下，从上图可以看到，他的书写方式和其他主流框架的国际化书写方式很类似(vue,react)。view层都是类似<code>t(key,参数)</code>，对js侵入也很小，下面是上图页面对应的js部分。</p>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-keyword">import</span> &#123; I18nPage &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">'@miniprogram-i18n/core'</span>

I18nPage(&#123;
  <span class="hljs-function"><span class="hljs-title">onLoad</span>(<span class="hljs-params"></span>)</span> &#123;
    <span class="hljs-built_in">this</span>.onLocaleChange(<span class="hljs-function">(<span class="hljs-params">locale</span>) =></span> &#123;
      <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'current locale:'</span>, <span class="hljs-built_in">this</span>.getLocale(), locale)
    &#125;)

    <span class="hljs-built_in">this</span>.setLocale(<span class="hljs-string">'zh-CN'</span>)
  &#125;,

  <span class="hljs-function"><span class="hljs-title">toggleLocale</span>(<span class="hljs-params"></span>)</span> &#123;
    <span class="hljs-built_in">this</span>.setLocale(
      <span class="hljs-built_in">this</span>.getLocale() === <span class="hljs-string">'zh-CN'</span> ? <span class="hljs-string">'en-US'</span> : <span class="hljs-string">'zh-CN'</span>
    )
  &#125;,

  <span class="hljs-function"><span class="hljs-title">nativate</span>(<span class="hljs-params"></span>)</span> &#123;
    wx.navigateTo(&#123;
      <span class="hljs-attr">url</span>: <span class="hljs-string">'/pages/logs/logs'</span>
    &#125;)
  &#125;
&#125;)

<span class="copy-code-btn">复制代码</span></code></pre>
<p>可以说除了<code>I18nPage</code>以外没有别的侵入，剩下那些代码都是用于切换语言所需，如果只是最简单国际化，只需要<code>I18nPage(&#123;&#125;)</code>即可</p>
<h3 data-id="heading-6">聊一下为什每次都需build</h3>
<p>其实咱们看下<strong>dist/i18n/locales.wxs</strong>文件即可</p>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-keyword">var</span> fallbackLocale = <span class="hljs-string">"zh-CN"</span>;
<span class="hljs-keyword">var</span> translations = &#123;
  <span class="hljs-string">"en-US"</span>: &#123;
    <span class="hljs-attr">test</span>: [<span class="hljs-string">"test messages"</span>],
    <span class="hljs-attr">test2</span>: [<span class="hljs-string">"test message 2, "</span>, [<span class="hljs-string">"label"</span>], <span class="hljs-string">", "</span>, [<span class="hljs-string">"label2"</span>]],
    <span class="hljs-attr">nested</span>: [<span class="hljs-string">"nested message: "</span>, [<span class="hljs-string">"test"</span>]],
    <span class="hljs-attr">toggle</span>: [<span class="hljs-string">"Toggle locale"</span>],
    <span class="hljs-attr">navigate</span>: [<span class="hljs-string">"Navigate to Log"</span>],
    <span class="hljs-string">"window.title"</span>: [<span class="hljs-string">"I18n test"</span>],
    <span class="hljs-string">"index.test"</span>: [<span class="hljs-string">"Test fallback"</span>],
    <span class="hljs-attr">navigate2</span>: [<span class="hljs-string">"Navigation 2nd"</span>],
  &#125;,
  <span class="hljs-string">"zh-CN"</span>: &#123;
    <span class="hljs-attr">test</span>: [<span class="hljs-string">"测试消息"</span>],
    <span class="hljs-attr">test2</span>: [<span class="hljs-string">"测试消息二, "</span>, [<span class="hljs-string">"label"</span>], <span class="hljs-string">", "</span>, [<span class="hljs-string">"label2"</span>]],
    <span class="hljs-attr">nested</span>: [<span class="hljs-string">"嵌套消息: "</span>, [<span class="hljs-string">"test"</span>]],
    <span class="hljs-attr">toggle</span>: [<span class="hljs-string">"切换语言"</span>],
    <span class="hljs-attr">navigate</span>: [<span class="hljs-string">"跳转"</span>],
    <span class="hljs-string">"window.title"</span>: [<span class="hljs-string">"国际化测试"</span>],
    <span class="hljs-string">"index.test"</span>: [<span class="hljs-string">"备选"</span>],
    <span class="hljs-attr">navigate2</span>: [<span class="hljs-string">"导航2"</span>],
  &#125;,
&#125;;
<span class="hljs-keyword">var</span> Interpreter = (<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">r</span>) </span>&#123;
  <span class="hljs-keyword">var</span> i = <span class="hljs-string">""</span>;
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">f</span>(<span class="hljs-params">r, n</span>) </span>&#123;
    <span class="hljs-keyword">return</span> r
      ? <span class="hljs-string">"string"</span> == <span class="hljs-keyword">typeof</span> r
        ? r
        : r
            .reduce(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">r, t</span>) </span>&#123;
              <span class="hljs-keyword">return</span> r.concat([
                (<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">n, e</span>) </span>&#123;
                  <span class="hljs-keyword">if</span> (((e = e || &#123;&#125;), <span class="hljs-string">"string"</span> == <span class="hljs-keyword">typeof</span> n)) <span class="hljs-keyword">return</span> n;
                  <span class="hljs-keyword">if</span> (n[<span class="hljs-number">2</span>] && <span class="hljs-string">"object"</span> == <span class="hljs-keyword">typeof</span> n[<span class="hljs-number">2</span>]) &#123;
                    <span class="hljs-keyword">var</span> r = <span class="hljs-built_in">Object</span>.keys(n[<span class="hljs-number">2</span>]).reduce(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">r, t</span>) </span>&#123;
                        <span class="hljs-keyword">return</span> (r[t] = f(n[<span class="hljs-number">2</span>][t], e)), r;
                      &#125;, &#123;&#125;),
                      t = r[e[<span class="hljs-number">0</span>]],
                      u = e[n[<span class="hljs-number">0</span>]];
                    <span class="hljs-keyword">return</span> <span class="hljs-keyword">void</span> <span class="hljs-number">0</span> !== u
                      ? r[u.toString()] || r.other || i
                      : t || r.other || i;
                  &#125;
                  <span class="hljs-keyword">if</span> (<span class="hljs-string">"object"</span> == <span class="hljs-keyword">typeof</span> n && <span class="hljs-number">0</span> < n.length) &#123;
                    <span class="hljs-keyword">return</span> (<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">r</span>(<span class="hljs-params">t, n, e</span>) </span>&#123;
                      <span class="hljs-keyword">void</span> <span class="hljs-number">0</span> === e && (e = <span class="hljs-number">0</span>);
                      <span class="hljs-keyword">if</span> (!n || !t || t.length <= <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>;
                      <span class="hljs-keyword">var</span> n = n[t[e]];
                      <span class="hljs-keyword">if</span> (<span class="hljs-string">"string"</span> == <span class="hljs-keyword">typeof</span> n) <span class="hljs-keyword">return</span> n;
                      <span class="hljs-keyword">if</span> (<span class="hljs-string">"number"</span> == <span class="hljs-keyword">typeof</span> n) <span class="hljs-keyword">return</span> n.toString();
                      <span class="hljs-keyword">if</span> (!n) <span class="hljs-keyword">return</span> <span class="hljs-string">"&#123;"</span> + t.join(<span class="hljs-string">"."</span>) + <span class="hljs-string">"&#125;"</span>;
                      <span class="hljs-keyword">return</span> r(t, n, ++e);
                    &#125;)(n[<span class="hljs-number">0</span>].split(<span class="hljs-string">"."</span>), e, <span class="hljs-number">0</span>);
                  &#125;
                  <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>;
                &#125;)(t, n),
              ]);
            &#125;, [])
            .join(<span class="hljs-string">""</span>)
      : i;
  &#125;
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">c</span>(<span class="hljs-params">r, t, n</span>) </span>&#123;
    t = r[t];
    <span class="hljs-keyword">if</span> (!t) <span class="hljs-keyword">return</span> n;
    t = t[n];
    <span class="hljs-keyword">return</span> t || n;
  &#125;
  <span class="hljs-keyword">return</span> (
    (r.getMessageInterpreter = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">i, o</span>) </span>&#123;
      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">e</span>(<span class="hljs-params">r, t, n</span>) </span>&#123;
        <span class="hljs-keyword">var</span> e, u;
        <span class="hljs-keyword">return</span> f(
          ((e = r),
          (u = o),
          ((n = (r = i)[(n = n)]) && (n = n[e])) || c(r, u, e)),
          t
        );
      &#125;
      <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">r, t, n</span>) </span>&#123;
        <span class="hljs-keyword">return</span> <span class="hljs-number">2</span> === <span class="hljs-built_in">arguments</span>.length
          ? e(r, <span class="hljs-literal">null</span>, t)
          : <span class="hljs-number">3</span> !== <span class="hljs-built_in">arguments</span>.length
          ? <span class="hljs-string">""</span>
          : e(r, t, n);
      &#125;;
    &#125;),
    r
  );
&#125;)(&#123;&#125;);

<span class="hljs-built_in">module</span>.exports.t = Interpreter.getMessageInterpreter(
  translations,
  fallbackLocale
);

<span class="copy-code-btn">复制代码</span></code></pre>
<p>其实搞这么麻烦构建方式主要是为了生成这个wxs文件，我们之所以能在vue中看到<code>&#123;&#123;t('key')&#125;&#125;</code>的方式进行国际化，是因为wxml层本身支持<strong>函数调用且函数可以调用外部资源(国际化文件)</strong>，而小程序只允许通过wxs(<a href="https://developers.weixin.qq.com/miniprogram/dev/reference/wxs/01wxs-module.html" target="_blank" rel="nofollow noopener noreferrer">官方文档</a>)的方式在页面使用函数，出于性能考虑又不允许wxs引用任何外部资源(除了其他的wxs),所以这个build最核心的诉求是把 <strong>国际化文件copy一份到wxs文件中</strong>。下面是wxs无法引用外部资源的官方说明</p>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5073fe36d18d42089cd1100c6a3bb096~tplv-k3u1fbpfcp-watermark.image" alt="image.png" loading="lazy" referrerpolicy="no-referrer"></p>
<h2 data-id="heading-7">优化</h2>
<p>我们国际化的核心诉求就是解决官方国际化问题同时保留他的优点，这里我们列下此次的目标</p>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" disabled> 路径灵活，不强依赖路径减少后期添加国际化的路径改动成本</li>
<li class="task-list-item"><input type="checkbox" disabled> 调试方便，和原始开发调试方式相同</li>
<li class="task-list-item"><input type="checkbox" disabled> 书写简洁，保持和vue一样的书写方式</li>
</ul>
<p>先来看下效果</p>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2e540b900f8f461eb01d85f2a5b4ab39~tplv-k3u1fbpfcp-watermark.image" alt="2021-05-22 10-27-02.2021-05-22 10_28_39.gif" loading="lazy" referrerpolicy="no-referrer"></p>
<p>wxml代码</p>
<pre><code class="hljs language-html copyable" lang="html"><span class="hljs-tag"><<span class="hljs-name">wxs</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"../wxs/i18n.wxs"</span> <span class="hljs-attr">module</span>=<span class="hljs-string">"i18n"</span> /></span>
<span class="hljs-comment"><!-- 标题国际化 --></span>
<span class="hljs-tag"><<span class="hljs-name">page-meta</span>></span>
  <span class="hljs-tag"><<span class="hljs-name">navigation-bar</span> <span class="hljs-attr">title</span>=<span class="hljs-string">"&#123;&#123;i18n.t(locales['主页'])&#125;&#125;"</span> /></span>
<span class="hljs-tag"></<span class="hljs-name">page-meta</span>></span>
<span class="hljs-comment"><!-- 一般国际化 --></span>
<span class="hljs-tag"><<span class="hljs-name">view</span>></span>&#123;&#123;i18n.t(locales['通往爱人家里的路总不会漫长。'])&#125;&#125;<span class="hljs-tag"></<span class="hljs-name">view</span>></span>
<span class="hljs-comment"><!-- js国际化 --></span>
<span class="hljs-tag"><<span class="hljs-name">view</span>></span>&#123;&#123;jsMsg&#125;&#125;<span class="hljs-tag"></<span class="hljs-name">view</span>></span>
<span class="hljs-comment"><!-- 支持变量国际化 --></span>
<span class="hljs-tag"><<span class="hljs-name">view</span>></span>&#123;&#123;i18n.t(locales['当前页面：&#123;path&#125;'],[&#123;key:'path',value:'home-page/home-page'&#125;])&#125;&#125;<span class="hljs-tag"></<span class="hljs-name">view</span>></span>
<span class="hljs-comment"><!-- 切换中英文按钮 --></span>
<span class="hljs-tag"><<span class="hljs-name">button</span> <span class="hljs-attr">bindtap</span>=<span class="hljs-string">"zhClick"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"default"</span>></span>&#123;&#123;i18n.t(locales['切换中文'])&#125;&#125;<span class="hljs-tag"></<span class="hljs-name">button</span>></span>
<span class="hljs-tag"><<span class="hljs-name">button</span> <span class="hljs-attr">bindtap</span>=<span class="hljs-string">"enClick"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"warn"</span>></span>&#123;&#123;i18n.t(locales['切换英语'])&#125;&#125;<span class="hljs-tag"></<span class="hljs-name">button</span>></span>
<span class="copy-code-btn">复制代码</span></code></pre>
<p>js代码</p>
<pre><code class="hljs language-js copyable" lang="js">
<span class="hljs-keyword">const</span> i18n = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../behaviors/i18n'</span>);
<span class="hljs-comment">// home-page/home-page.js</span>
Component(&#123;
  <span class="hljs-attr">behaviors</span>: [i18n],
  <span class="hljs-comment">/**
   * 组件的初始数据
   */</span>
  <span class="hljs-attr">data</span>: &#123;
  &#125;,
  <span class="hljs-comment">/**
   * 组件的方法列表
   */</span>
  <span class="hljs-attr">methods</span>: &#123;
    <span class="hljs-function"><span class="hljs-title">zhClick</span>(<span class="hljs-params"></span>)</span> &#123;
      <span class="hljs-built_in">this</span>.switchLanguage(<span class="hljs-string">'zh_CN'</span>)
    &#125;,
    <span class="hljs-function"><span class="hljs-title">enClick</span>(<span class="hljs-params"></span>)</span> &#123;
      <span class="hljs-built_in">this</span>.switchLanguage(<span class="hljs-string">'en_US'</span>)
    &#125;,
  &#125;
&#125;)

<span class="copy-code-btn">复制代码</span></code></pre>
<p>基本维持和官方相同的写法，尽可能少的代码写入</p>
<p><a href="https://developers.weixin.qq.com/s/q642Bumu7Aqn" target="_blank" rel="nofollow noopener noreferrer">代码段链接</a></p>
<h3 data-id="heading-8">解决思路</h3>
<p>利用behaviors(<a href="https://developers.weixin.qq.com/miniprogram/dev/reference/api/Behavior.html" target="_blank" rel="nofollow noopener noreferrer">官方文档</a>)将国际化文案进行引入每个页面。然后将所有国际化数据和key值以参数的形式传递给wxs函数，这样就可以避开wxs外部资源限制实现和vue i18n相同的效果。</p>
<ul>
<li>behaviors负责将国际化方法和文案导入全局，以下是<strong>behaviors/i18n.js</strong>源码：</li>
</ul>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// behaviors/i18n.js</span>

<span class="hljs-keyword">const</span> &#123;
  t
&#125; = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../utils/index'</span>)
<span class="hljs-keyword">const</span> i18n = Behavior(&#123;
  <span class="hljs-attr">data</span>: &#123;
    <span class="hljs-attr">language</span>:&#123;&#125;, <span class="hljs-comment">// 当前语种</span>
    <span class="hljs-attr">locales</span>: &#123;&#125;, <span class="hljs-comment">// 当前语言的全部国际化信息</span>
  &#125;,
  <span class="hljs-attr">pageLifetimes</span>: &#123;
    <span class="hljs-comment">// 每次页面打开拉取对应语言国际化数据</span>
    <span class="hljs-function"><span class="hljs-title">show</span>(<span class="hljs-params"></span>)</span> &#123;
      <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.data.language === <span class="hljs-string">'en_US'</span>) &#123;
        <span class="hljs-built_in">this</span>.setData(&#123;
          <span class="hljs-attr">locales</span>: <span class="hljs-built_in">require</span>(<span class="hljs-string">'../i18n/en_US'</span>)
        &#125;)
      &#125; <span class="hljs-keyword">else</span> &#123;
        <span class="hljs-built_in">this</span>.setData(&#123;
          <span class="hljs-attr">locales</span>: <span class="hljs-built_in">require</span>(<span class="hljs-string">'../i18n/zh_CN'</span>)
        &#125;)
      &#125;
    &#125;
  &#125;,
  <span class="hljs-attr">methods</span>: &#123;
    <span class="hljs-comment">// 全局js国际化便捷调用</span>
    $t(key, option) &#123;
      <span class="hljs-keyword">return</span> t(key, option)
    &#125;,
    <span class="hljs-comment">// 由于tab只能通过js修改，所以每次语言切换需要重新更新tab国际化内容</span>
    <span class="hljs-function"><span class="hljs-title">refreshTab</span>(<span class="hljs-params"></span>)</span> &#123;
      wx.setTabBarItem(&#123;
        <span class="hljs-attr">index</span>: <span class="hljs-number">0</span>,
        <span class="hljs-attr">text</span>: <span class="hljs-built_in">this</span>.data.locales[<span class="hljs-string">'主页'</span>]
      &#125;)
      wx.setTabBarItem(&#123;
        <span class="hljs-attr">index</span>: <span class="hljs-number">1</span>,
        <span class="hljs-attr">text</span>: <span class="hljs-built_in">this</span>.data.locales[<span class="hljs-string">'我的'</span>]
      &#125;)
    &#125;,
    <span class="hljs-comment">// 切换语种</span>
    <span class="hljs-function"><span class="hljs-title">switchLanguage</span>(<span class="hljs-params">language</span>)</span> &#123;
      <span class="hljs-built_in">this</span>.setData(&#123;
        language
      &#125;)
      <span class="hljs-keyword">if</span> (language === <span class="hljs-string">'zh_CN'</span>) &#123;
        <span class="hljs-built_in">this</span>.setData(&#123;
          <span class="hljs-attr">locales</span>: <span class="hljs-built_in">require</span>(<span class="hljs-string">'../i18n/zh_CN'</span>)
        &#125;)
      &#125; <span class="hljs-keyword">else</span> &#123;
        <span class="hljs-built_in">this</span>.setData(&#123;
          <span class="hljs-attr">locales</span>: <span class="hljs-built_in">require</span>(<span class="hljs-string">'../i18n/en_US'</span>)
        &#125;)
      &#125;
      <span class="hljs-comment">// 切换下方tab</span>
      <span class="hljs-built_in">this</span>.refreshTab()
    &#125;,
  &#125;
&#125;)

<span class="hljs-built_in">module</span>.exports = i18n
<span class="copy-code-btn">复制代码</span></code></pre>
<ul>
<li>wxs负责为wxml层提供国际化方法，此处逻辑比较简单，先找到国际化文件中key值对应的语句，然后根据第二参数(arr)将变量进行替换，此处替换逻辑比较粗暴，使用<code>&#123;key&#125;</code>方式代表变量。如:"<code>我的年龄是&#123;age&#125;</code>",age代表变量,参数传递格式为 <code>[&#123;key:'xxx',value:'xxxx'&#125;]</code></li>
</ul>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// 国际化.js</span>
&#123;
  <span class="hljs-string">"ageText"</span>:<span class="hljs-string">"my age is &#123;age&#125;"</span>,
&#125;
<span class="hljs-comment">// wxml</span>
<view>&#123;&#123;i18n.t(locales[<span class="hljs-string">'ageText'</span>],[&#123;<span class="hljs-attr">key</span>:<span class="hljs-string">'age'</span>,<span class="hljs-attr">value</span>:<span class="hljs-string">'18'</span>&#125;])&#125;&#125;</view>

<span class="copy-code-btn">复制代码</span></code></pre>
<p>wxs源码如下：</p>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-keyword">var</span> i18n = &#123;
  <span class="hljs-attr">t</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">str, arr</span>) </span>&#123;
    <span class="hljs-keyword">var</span> result = str;
    <span class="hljs-keyword">if</span> (arr) &#123;
      arr.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">item</span>) </span>&#123;
        <span class="hljs-keyword">if</span>(result)&#123;
          result = result.replace(<span class="hljs-string">'&#123;'</span>+item.key+<span class="hljs-string">'&#125;'</span>, item.value)
        &#125;
      &#125;)
    &#125;
    <span class="hljs-keyword">return</span> result
  &#125;
&#125;
<span class="hljs-built_in">module</span>.exports = i18n
<span class="copy-code-btn">复制代码</span></code></pre>
<p>同时提供一个在js里获取国际化的util方法</p>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// 国际化</span>
<span class="hljs-keyword">const</span> t = <span class="hljs-function">(<span class="hljs-params">key, option = &#123;&#125;</span>) =></span> &#123;
  <span class="hljs-keyword">const</span> language = wx.getStorageSync(<span class="hljs-string">'language'</span>);
  <span class="hljs-keyword">let</span> locales = <span class="hljs-literal">null</span>
  <span class="hljs-keyword">if</span> (language === <span class="hljs-string">'en_US'</span>) &#123;
    locales = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../i18n/en_US'</span>)
  &#125; <span class="hljs-keyword">else</span> &#123;
    locales = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../i18n/zh_CN'</span>)
  &#125;
  <span class="hljs-keyword">let</span> result = locales[key]
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> optionKey <span class="hljs-keyword">in</span> option) &#123;
    result = result.replace(<span class="hljs-string">`&#123;<span class="hljs-subst">$&#123;optionKey&#125;</span>&#125;`</span>, option[optionKey])
  &#125;
  <span class="hljs-keyword">return</span> result
&#125;

<span class="hljs-built_in">module</span>.exports = &#123;
  t
&#125;
<span class="copy-code-btn">复制代码</span></code></pre>
<p>这样就基本实现了同时在wxml,js中进行国际化的基本需求，同时也解决了官方调试体验不足的缺点。</p>
<h3 data-id="heading-9">不足</h3>
<ul>
<li>
<p>其实调试体验还不是那么完美，由于只有在show中初始化国际化文件内容，所以当开启“<strong>热重载</strong>”时对国际化文件进行修改，国际化内容不会自动进行更新</p>
</li>
<li>
<p>每个page的js文件都需要引入behaviors/i18n.js，wxml文件引入<code><wxs src="../wxs/i18n.wxs" module="i18n" /></code>有些略显繁琐</p>
</li>
<li>
<p><code>require('../i18n/xxx')</code>整个项目引入了3遍略显繁琐，可以封装一下</p>
</li>
<li>
<p><code>i18n.t(locales['key'])</code> 其中locals每次都要写一遍比较繁琐，不过由于wxs的限制也想不到太好的方法</p>
</li>
</ul>
<h2 data-id="heading-10">使用建议</h2>
<p>由于只是写一个demo很多逻辑并没有写完整，所以如果使用的话需要根据项目进行修改</p>
<ol>
<li>
<p>如果i18n路径和命名方式不同需要同时修改<strong>behaviors/i18n.js</strong>,以及<strong>utils/index.js</strong>中的路径</p>
</li>
<li>
<p>现在每次刷新页面国际化都会被重置成中文，建议在<strong>behaviors/i18n.js</strong>的show方法中从全局获取当前的国际化语言。这样就不会每次都被重置成中文了。</p>
</li>
</ol></div>  
</div>
            