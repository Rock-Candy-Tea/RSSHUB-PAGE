
---
title: '小程序运行环境讲解(一)_ 微信开发者工具中运行环境分析'
categories: 
 - 编程
 - 掘金
 - 分类
headimg: 'https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/71b41977517a41488c3a184ab5ad504f~tplv-k3u1fbpfcp-watermark.image'
author: 掘金
comments: false
date: Fri, 27 Aug 2021 06:39:39 GMT
thumbnail: 'https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/71b41977517a41488c3a184ab5ad504f~tplv-k3u1fbpfcp-watermark.image'
---

<div>   
<div class="markdown-body html cache"><style>.markdown-body&#123;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333&#125;.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6&#123;line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px&#125;.markdown-body h1&#123;font-size:30px;margin-bottom:5px&#125;.markdown-body h2&#123;padding-bottom:12px;font-size:24px;border-bottom:1px solid #ececec&#125;.markdown-body h3&#123;font-size:18px;padding-bottom:0&#125;.markdown-body h4&#123;font-size:16px&#125;.markdown-body h5&#123;font-size:15px&#125;.markdown-body h6&#123;margin-top:5px&#125;.markdown-body p&#123;line-height:inherit;margin-top:22px;margin-bottom:22px&#125;.markdown-body img&#123;max-width:100%&#125;.markdown-body hr&#123;border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px&#125;.markdown-body code&#123;word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em&#125;.markdown-body code,.markdown-body pre&#123;font-family:Menlo,Monaco,Consolas,Courier New,monospace&#125;.markdown-body pre&#123;overflow:auto;position:relative;line-height:1.75&#125;.markdown-body pre>code&#123;font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8&#125;.markdown-body a&#123;text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff&#125;.markdown-body a:active,.markdown-body a:hover&#123;color:#275b8c&#125;.markdown-body table&#123;display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6&#125;.markdown-body thead&#123;background:#f6f6f6;color:#000;text-align:left&#125;.markdown-body tr:nth-child(2n)&#123;background-color:#fcfcfc&#125;.markdown-body td,.markdown-body th&#123;padding:12px 7px;line-height:24px&#125;.markdown-body td&#123;min-width:120px&#125;.markdown-body blockquote&#123;color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8&#125;.markdown-body blockquote:after&#123;display:block;content:""&#125;.markdown-body blockquote>p&#123;margin:10px 0&#125;.markdown-body ol,.markdown-body ul&#123;padding-left:28px&#125;.markdown-body ol li,.markdown-body ul li&#123;margin-bottom:0;list-style:inherit&#125;.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item&#123;list-style:none&#125;.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul&#123;margin-top:0&#125;.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul&#123;margin-top:3px&#125;.markdown-body ol li&#123;padding-left:6px&#125;.markdown-body .contains-task-list&#123;padding-left:0&#125;.markdown-body .task-list-item&#123;list-style:none&#125;@media (max-width:720px)&#123;.markdown-body h1&#123;font-size:24px&#125;.markdown-body h2&#123;font-size:20px&#125;.markdown-body h3&#123;font-size:18px&#125;&#125;</style><blockquote>
<p>作者：小影前端团队——古墩路吴彦祖</p>
</blockquote>
<h1 data-id="heading-0">前言：</h1>
<ol>
<li>
<p>2021发布的微信开发者工具core.wxvpkg 文件代码已加混淆，该文章中所使用的版本是1.02.1904090</p>
</li>
<li>
<p>历史版本下载方式：</p>
<ol>
<li><a href="https://link.juejin.cn/?target=https%3A%2F%2Fdevelopers.weixin.qq.com%2Fminiprogram%2Fdev%2Fdevtools%2Fstable.html" target="_blank" rel="nofollow noopener noreferrer" title="https://developers.weixin.qq.com/miniprogram/dev/devtools/stable.html" ref="nofollow noopener noreferrer">developers.weixin.qq.com/miniprogram…</a> 微信开发者工具中查看历史版本，点击更新说明即可获取</li>
</ol>
</li>
</ol>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/71b41977517a41488c3a184ab5ad504f~tplv-k3u1fbpfcp-watermark.image" alt loading="lazy" referrerpolicy="no-referrer"></p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/adf156ef93b740f7a62d3fbdaeccc364~tplv-k3u1fbpfcp-watermark.image" alt loading="lazy" referrerpolicy="no-referrer"></p>
<h1 data-id="heading-1">基础知识：</h1>
<h3 data-id="heading-2">小程序页面的构成：</h3>
<ul>
<li>.js 页面逻辑</li>
</ul>

<ul>
<li>.wxml 页面结构(可以理解为html)，框架设计的一套标签语言，结合基础组件、事件系统，可以构建出页面的结构。</li>
</ul>

<ul>
<li>.wxss 是一套样式语言(可以理解为css)，用于描述 WXML 的组件样式。</li>
</ul>

<ul>
<li>.json 页面配置按照『约定优于配置』的原则。</li>
</ul>
<h3 data-id="heading-3">小程序框架</h3>
<p>官方架构示意图如下：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/40d3c72860b840c193eb750aca8c2de7~tplv-k3u1fbpfcp-watermark.image" alt loading="lazy" referrerpolicy="no-referrer"></p>
<ul>
<li>
<p>逻辑层（App Service）</p>
<ul>
<li>逻辑层使用 <code>JavaScript</code>引擎为小程序提供开发者 <code>JavaScript</code>代码的运行环境以及微信小程序的特有功能。</li>
<li>逻辑层将数据进行处理后发送给视图层，同时接受视图层的事件反馈。</li>
</ul>
</li>
<li>
<p>视图层（View）</p>
<ul>
<li>视图层由 WXML 与 WXSS 编写，由组件来进行展示。</li>
<li>将逻辑层的数据反映成视图，同时将视图层的事件发送给逻辑层。</li>
<li><strong>总结：视图层使用WebView渲染，逻辑层使用JSCore运行， 视图层和逻辑层通过系统层的JSBridage进行通信，逻辑层把数据变化通知到视图层，触发视图层页面更新，视图层把触发的事件通知到逻辑层进行业务处理</strong></li>
</ul>
</li>
</ul>
<h2 data-id="heading-4">在微信开发者工具中验证</h2>
<blockquote>
<p>微信开发工具来展示说明，小程序逻辑层的 javascript 代码是运行在 <a href="https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Fnwjs%2Fnw.js" target="_blank" rel="nofollow noopener noreferrer" title="https://github.com/nwjs/nw.js" ref="nofollow noopener noreferrer">NW.js</a> 中，视图层是由 <a href="https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Fchromium%2Fchromium" target="_blank" rel="nofollow noopener noreferrer" title="https://github.com/chromium/chromium" ref="nofollow noopener noreferrer">Chromium</a> Webview 来渲染的</p>
</blockquote>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/8f50e9a26754491cb915e1ef7179d952~tplv-k3u1fbpfcp-watermark.image" alt loading="lazy" referrerpolicy="no-referrer"></p>
<p>以微信小程序组件demo工程为例，我们可以看到，小程序的页面就是由.js/.json/.wxml/.wxss 四部分决定的。</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9d7d8262b71445ec87c52970f84ce1a6~tplv-k3u1fbpfcp-watermark.image" alt loading="lazy" referrerpolicy="no-referrer"></p>
<p>看红框部分的内容，在小程序中渲染的结果及原始的代码，可以看到wxml的标签语言和传统的html还是不一样的，那么我们从小程序框架中的视图层了解到，视图层本质上也是在Webview中渲染的，那么在webview中渲染，肯定对应的还是标签及相关的样式，来决定页面的构成。</p>
<p>那么我们如何通过微信开发者工具进行调试呢？看下渲染的标签到底是长啥样的。</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2f0d1504cf154060b684ae0abbba075a~tplv-k3u1fbpfcp-watermark.image" alt loading="lazy" referrerpolicy="no-referrer"></p>
<p>我们在工具中选择调试 => 调试微信开发者工具</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e95a9c9444354b93b118fcae7dd1d0fc~tplv-k3u1fbpfcp-watermark.image" alt loading="lazy" referrerpolicy="no-referrer"></p>
<p>选中内容区域，我们发现这块内容是由webview的标签渲染的，并且还有一个appservice的webview，那么我们大胆猜测，其中pageframe的webview就是框架中对应的视图层，appservice的webview的对应的就是逻辑层，第一个webview还有一个route属性，说明是控制页面跳转的，具体是如何实现的呢？继续往下深入。</p>
<p>到了这里，我们已经找到了视图层和逻辑层对应的webview了，那么，我们想知道里面到底是个啥呢？我们把标签点开看下</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/8720cf6afbe347809e9f847b8097bc90~tplv-k3u1fbpfcp-watermark.image" alt loading="lazy" referrerpolicy="no-referrer"></p>
<p>啥也看不到，那我们把webview直接改成iframe呢？</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/8aad9fbef6564d19b2b36ad3a6eaf957~tplv-k3u1fbpfcp-watermark.image" alt loading="lazy" referrerpolicy="no-referrer"></p>
<p>很遗憾，直接白屏了。</p>
<p>到了这里，我们还有什么方法查看呢？</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/086b71c1a44547788345467b6283859c~tplv-k3u1fbpfcp-watermark.image" alt loading="lazy" referrerpolicy="no-referrer"></p>
<p>通过官方文档，我们看到小程序开发者工具使用NW.js开发的</p>
<p>那么我们再查看nw.js官方文档中，对于webview标签的介绍，内容如下</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/11fa8a368cc84dc0b5a5bd559fcf8f6e~tplv-k3u1fbpfcp-watermark.image" alt loading="lazy" referrerpolicy="no-referrer"></p>
<p>看到红框部分的内容，相信大家又有思路了</p>
<p>那么，我们按照文档上的api操作下，首先，查看调试工具中的所有webview标签</p>
<pre><code class="copyable">document.getElementsByTagName('webview')
<span class="copy-code-btn">复制代码</span></code></pre>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f0427a7966ad4c24aae7900945f4e770~tplv-k3u1fbpfcp-watermark.image" alt loading="lazy" referrerpolicy="no-referrer"></p>
<p>可以看到出现了4个标签名称是webview的，我们选择第一个webview 可以看到对应的就是渲染层的webview。</p>
<p>我们再执行nw.js提供的webview的api showDevTools</p>
<pre><code class="copyable">document.getElementsByTagName('webview')[0].showDevTools(true, null)
<span class="copy-code-btn">复制代码</span></code></pre>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b3810ef72b6f437c8a50e4518c7cdd8e~tplv-k3u1fbpfcp-watermark.image" alt loading="lazy" referrerpolicy="no-referrer"></p>
<p>打开了一个新的调试页面，这下里面的结构一目了然了，可以看到body下就是一堆的的标签，这个不难理解 <a href="https://link.juejin.cn/?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FWeb_Components" target="_blank" rel="nofollow noopener noreferrer" title="https://developer.mozilla.org/zh-CN/docs/Web/Web_Components" ref="nofollow noopener noreferrer">developer.mozilla.org/zh-CN/docs/…</a> 参考MDN中对web components的介绍就了解了</p>
<p>分享两个关于web components的优秀开源项目<a href="https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2FPolymer%2Fpolymer" target="_blank" rel="nofollow noopener noreferrer" title="https://github.com/Polymer/polymer" ref="nofollow noopener noreferrer">polymer</a>和<a href="https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Fionic-team%2Fstencil" target="_blank" rel="nofollow noopener noreferrer" title="https://github.com/ionic-team/stencil" ref="nofollow noopener noreferrer">stencil</a></p>
<p>以上是本次对视图层解析的全部内容，参考文献：</p>
<ul>
<li><a href="https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2FIOriens%2Fioriens.github.io%2Fissues%2F5" target="_blank" rel="nofollow noopener noreferrer" title="https://github.com/IOriens/ioriens.github.io/issues/5" ref="nofollow noopener noreferrer">wxml 转译器实现过程分析</a></li>
</ul>

<ul>
<li><a href="https://link.juejin.cn/?target=https%3A%2F%2Fwww.cnblogs.com%2Fwonyun%2Fp%2F11168698.html" target="_blank" rel="nofollow noopener noreferrer" title="https://www.cnblogs.com/wonyun/p/11168698.html" ref="nofollow noopener noreferrer">从微信小程序开发者工具源码看实现原理</a></li>
</ul>
<h1 data-id="heading-5">招贤纳士</h1>
<p>小影前端团队，是一个年轻、活动且富有创造力的团队，隶属于小影科技开发中心，Base 在风景如画的杭州。团队在日常的业务对接之外，还在互动技术、图像渲染、跨端技术、工程化平台、性能体验、数据分析及可视化等方向进行技术探索和实战，推动并落地了一系列的内部技术产品，并一直保持好奇，持续探索前端技术。
如果你想大胆自信的表达你的想法；如果你想有个机会实现自己的想法；如果你希望落地的想法有一个团队来支撑；如果你愿意跟一群积极向上的小伙伴干一些持续迭代自己，持续提升技术能力的事；如果你相信相信的力量；那就加入我们吧！快戳链接>>><a href="https://link.juejin.cn/?target=https%3A%2F%2Fquvideo.jobs.feishu.cn%2Fs%2FeV8jfyf" target="_blank" rel="nofollow noopener noreferrer" title="https://quvideo.jobs.feishu.cn/s/eV8jfyf" ref="nofollow noopener noreferrer">quvideo.jobs.feishu.cn/s/eV8jfyf</a></p></div>  
</div>
            