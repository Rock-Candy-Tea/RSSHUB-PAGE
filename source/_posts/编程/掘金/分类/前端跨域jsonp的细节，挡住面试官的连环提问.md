
---
title: 'å‰ç«¯è·¨åŸŸjsonpçš„ç»†èŠ‚ï¼ŒæŒ¡ä½é¢è¯•å®˜çš„è¿ç¯æé—®'
categories: 
 - ç¼–ç¨‹
 - æ˜é‡‘
 - åˆ†ç±»
headimg: 'https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6fb3d06c2c12425ea28364ed8a5383ea~tplv-k3u1fbpfcp-zoom-1.image'
author: æ˜é‡‘
comments: false
date: Thu, 08 Apr 2021 01:36:54 GMT
thumbnail: 'https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6fb3d06c2c12425ea28364ed8a5383ea~tplv-k3u1fbpfcp-zoom-1.image'
---

<div>   
<div class="markdown-body"><style>.markdown-body&#123;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333&#125;.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6&#123;line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px&#125;.markdown-body h1&#123;font-size:30px;margin-bottom:5px&#125;.markdown-body h2&#123;padding-bottom:12px;font-size:24px;border-bottom:1px solid #ececec&#125;.markdown-body h3&#123;font-size:18px;padding-bottom:0&#125;.markdown-body h4&#123;font-size:16px&#125;.markdown-body h5&#123;font-size:15px&#125;.markdown-body h6&#123;margin-top:5px&#125;.markdown-body p&#123;line-height:inherit;margin-top:22px;margin-bottom:22px&#125;.markdown-body img&#123;max-width:100%&#125;.markdown-body hr&#123;border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px&#125;.markdown-body code&#123;word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em&#125;.markdown-body code,.markdown-body pre&#123;font-family:Menlo,Monaco,Consolas,Courier New,monospace&#125;.markdown-body pre&#123;overflow:auto;position:relative;line-height:1.75&#125;.markdown-body pre>code&#123;font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8&#125;.markdown-body a&#123;text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff&#125;.markdown-body a:active,.markdown-body a:hover&#123;color:#275b8c&#125;.markdown-body table&#123;display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6&#125;.markdown-body thead&#123;background:#f6f6f6;color:#000;text-align:left&#125;.markdown-body tr:nth-child(2n)&#123;background-color:#fcfcfc&#125;.markdown-body td,.markdown-body th&#123;padding:12px 7px;line-height:24px&#125;.markdown-body td&#123;min-width:120px&#125;.markdown-body blockquote&#123;color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8&#125;.markdown-body blockquote:after&#123;display:block;content:""&#125;.markdown-body blockquote>p&#123;margin:10px 0&#125;.markdown-body ol,.markdown-body ul&#123;padding-left:28px&#125;.markdown-body ol li,.markdown-body ul li&#123;margin-bottom:0;list-style:inherit&#125;.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item&#123;list-style:none&#125;.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul&#123;margin-top:0&#125;.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul&#123;margin-top:3px&#125;.markdown-body ol li&#123;padding-left:6px&#125;.markdown-body .contains-task-list&#123;padding-left:0&#125;.markdown-body .task-list-item&#123;list-style:none&#125;@media (max-width:720px)&#123;.markdown-body h1&#123;font-size:24px&#125;.markdown-body h2&#123;font-size:20px&#125;.markdown-body h3&#123;font-size:18px&#125;&#125;</style><h1 data-id="heading-0">1.å‰è¨€</h1>
<blockquote>
<p>åœ¨å‰ç«¯é¢è¯•ä¸­ï¼Œæƒ³å¿…æ¯ä¸€ä¸ªäººéƒ½ä¼šè¢«é—®åˆ°è·¨åŸŸç›¸å…³çš„é—®é¢˜ï¼ŒèƒŒè¿‡å…«è‚¡æ–‡çš„å°ä¼™ä¼´è‚¯å®šå¯¹è·¨åŸŸçš„è§£å†³å¯¹ç­”å¦‚æµï¼Œå¸¸è§çš„è·¨åŸŸè§£å†³æ–¹æ¡ˆåœ¨ç½‘ä¸Šæœ‰å¾ˆå¤šæ•´ç†ï¼Œä½†æ˜¯å¦‚æœé—®åˆ°å®ç°çš„ç»†èŠ‚ï¼Œä½ æ˜¯å¦èƒ½å¤Ÿæ‰‹å†™å®ç°æˆ–è€…æ·±å…¥è§£è¯»å‘¢ï¼Ÿå…¶å®å¾ˆå¤šæƒ…å†µä¸‹ï¼Œé¢è¯•å®˜ä¸ä»…ä»…ä¼šè€ƒå¯Ÿç¬¬ä¸€å±‚çš„æ¦‚å¿µï¼Œè¿˜ä¼šè¿½é—®ç¬¬äºŒå±‚ã€ç¬¬ä¸‰å±‚å†…å®¹ï¼Œæ‰€ä»¥å¯¹äºå®ç°åŸç†çš„æŒæ¡æ˜¯å¿…è¦çš„ï¼Œä»Šå¤©ç¬”è€…å°±æ•´ç†ä¸€ä¸‹è·¨åŸŸçš„åŸºæœ¬æ–¹å¼ï¼Œé‡ç‚¹ä»‹ç»<code>jsonp</code>çš„å®ç°~</p>
</blockquote>
<h1 data-id="heading-1">2.è·¨åŸŸæ–¹æ¡ˆ</h1>
<p>å¸¸è§çš„è·¨åŸŸè§£å†³æ–¹æ¡ˆæœ‰8ç§å·¦å³ï¼Œåœ¨é¢è¯•ä¸­èƒ½ç­”å‡º4-5ç§å°±å¯ä»¥äº†~</p>
<h3 data-id="heading-2">2.1 å¦‚æœåªæ˜¯æƒ³è¦å®ç°ä¸»åŸŸåä¸‹çš„ä¸åŒå­åŸŸåçš„è·¨åŸŸæ“ä½œï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨è®¾ç½®document.domain æ¥è§£å†³</h3>
<p>å°† <code>document.domain</code> è®¾ç½®ä¸ºä¸»åŸŸåï¼Œæ¥å®ç°ç›¸åŒå­åŸŸåçš„è·¨åŸŸæ“ä½œï¼Œè¿™ä¸ªæ—¶å€™ä¸»åŸŸåä¸‹çš„ <code>cookie</code> å°±èƒ½å¤Ÿè¢«å­åŸŸåæ‰€è®¿é—®ã€‚åŒæ—¶å¦‚æœæ–‡æ¡£ä¸­å«æœ‰ä¸»åŸŸåç›¸åŒï¼Œå­åŸŸåä¸åŒçš„ <code>iframe</code> çš„è¯ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥å¯¹è¿™ä¸ª <code>iframe</code> è¿›è¡Œæ“ä½œã€‚</p>
<h3 data-id="heading-3">2.2 ä½¿ç”¨ location.hash çš„æ–¹æ³•</h3>
<p>æˆ‘ä»¬å¯ä»¥åœ¨ä¸»é¡µé¢åŠ¨æ€çš„ä¿®æ”¹ <code>iframe</code> çª—å£çš„ <code>hash</code> å€¼ï¼Œç„¶ååœ¨ <code>iframe</code> çª—å£é‡Œå®ç°ç›‘å¬å‡½æ•°æ¥å®ç°è¿™æ ·ä¸€ä¸ªå•å‘çš„é€šä¿¡ã€‚å› ä¸ºåœ¨ <code>iframe</code> æ˜¯æ²¡æœ‰åŠæ³•è®¿é—®åˆ°ä¸åŒæºçš„çˆ¶çº§çª—å£çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸èƒ½ç›´æ¥ä¿®æ”¹çˆ¶çº§çª—å£çš„ <code>hash</code> å€¼æ¥å®ç°é€šä¿¡ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ <code>iframe</code> ä¸­å†åŠ å…¥ä¸€ä¸ª <code>iframe</code> ï¼Œè¿™ä¸ª <code>iframe</code> çš„å†…å®¹æ˜¯å’Œçˆ¶çº§é¡µé¢åŒæºçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ <code>window.parent.parent</code> æ¥ä¿®æ”¹æœ€é¡¶çº§é¡µé¢çš„ <code>src</code>ï¼Œä»¥æ­¤æ¥å®ç°åŒå‘é€šä¿¡ã€‚</p>
<h3 data-id="heading-4">2.3 ä½¿ç”¨ window.name çš„æ–¹æ³•</h3>
<p>ä¸»è¦æ˜¯åŸºäºåŒä¸€ä¸ªçª—å£ä¸­è®¾ç½®äº† <code>window.name</code> åä¸åŒæºçš„é¡µé¢ä¹Ÿå¯ä»¥è®¿é—®ï¼Œæ‰€ä»¥ä¸åŒæºçš„å­é¡µé¢å¯ä»¥é¦–å…ˆåœ¨ <code>window.name</code> ä¸­å†™å…¥æ•°æ®ï¼Œç„¶åè·³è½¬åˆ°ä¸€ä¸ªå’Œçˆ¶çº§åŒæºçš„é¡µé¢ã€‚è¿™ä¸ªæ—¶å€™çˆ¶çº§é¡µé¢å°±å¯ä»¥è®¿é—®åŒæºçš„å­é¡µé¢ä¸­ <code>window.name</code> ä¸­çš„æ•°æ®äº†ï¼Œè¿™ç§æ–¹å¼çš„å¥½å¤„æ˜¯å¯ä»¥ä¼ è¾“çš„æ•°æ®é‡å¤§ã€‚</p>
<h3 data-id="heading-5">2.4 ä½¿ç”¨ postMessage æ¥è§£å†³çš„æ–¹æ³•</h3>
<p>è¿™æ˜¯ä¸€ä¸ª <code>h5</code> ä¸­æ–°å¢çš„ä¸€ä¸ª <code>api</code>ã€‚é€šè¿‡å®ƒæˆ‘ä»¬å¯ä»¥å®ç°å¤šçª—å£é—´çš„ä¿¡æ¯ä¼ é€’ï¼Œé€šè¿‡è·å–åˆ°æŒ‡å®šçª—å£çš„å¼•ç”¨ï¼Œç„¶åè°ƒç”¨ <code>postMessage</code> æ¥å‘é€ä¿¡æ¯ï¼Œåœ¨çª—å£ä¸­æˆ‘ä»¬é€šè¿‡å¯¹ <code>message</code> ä¿¡æ¯çš„ç›‘å¬æ¥æ¥æ”¶ä¿¡æ¯ï¼Œä»¥æ­¤æ¥å®ç°ä¸åŒæºé—´çš„ä¿¡æ¯äº¤æ¢ã€‚å¦‚æœæ˜¯åƒè§£å†³ <code>ajax</code> æ— æ³•æäº¤è·¨åŸŸè¯·æ±‚çš„é—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>jsonp</code>ã€<code>cors</code>ã€<code>websocket</code> åè®®ã€æœåŠ¡å™¨ä»£ç†æ¥è§£å†³é—®é¢˜ã€‚</p>
<h3 data-id="heading-6">2.5 ä½¿ç”¨ jsonp æ¥å®ç°è·¨åŸŸè¯·æ±‚</h3>
<p>å®ƒçš„ä¸»è¦åŸç†æ˜¯é€šè¿‡åŠ¨æ€æ„å»º <code>script</code> æ ‡ç­¾æ¥å®ç°è·¨åŸŸè¯·æ±‚ï¼Œå› ä¸ºæµè§ˆå™¨å¯¹ <code>script</code> æ ‡ç­¾çš„å¼•å…¥æ²¡æœ‰è·¨åŸŸçš„è®¿é—®é™åˆ¶ ã€‚é€šè¿‡åœ¨è¯·æ±‚çš„ <code>url</code> åæŒ‡å®šä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œç„¶åæœåŠ¡å™¨åœ¨è¿”å›æ•°æ®çš„æ—¶å€™ï¼Œæ„å»ºä¸€ä¸ª <code>json</code> æ•°æ®çš„åŒ…è£…ï¼Œè¿™ä¸ªåŒ…è£…å°±æ˜¯å›è°ƒå‡½æ•°ï¼Œç„¶åè¿”å›ç»™å‰ç«¯ï¼Œå‰ç«¯æ¥æ”¶åˆ°æ•°æ®åï¼Œå› ä¸ºè¯·æ±‚çš„æ˜¯è„šæœ¬æ–‡ä»¶ï¼Œæ‰€ä»¥ä¼šç›´æ¥æ‰§è¡Œï¼Œè¿™æ ·æˆ‘ä»¬å…ˆå‰å®šä¹‰å¥½çš„å›è°ƒå‡½æ•°å°±å¯ä»¥è¢«è°ƒç”¨ï¼Œä»è€Œå®ç°äº†è·¨åŸŸè¯·æ±‚çš„å¤„ç†ã€‚è¿™ç§æ–¹å¼åªèƒ½ç”¨äº <code>get</code> è¯·æ±‚ã€‚</p>
<h3 data-id="heading-7">2.6 ä½¿ç”¨ CORS çš„æ–¹å¼</h3>
<p><code>CORS</code> æ˜¯ä¸€ä¸ª <code>W3C</code> æ ‡å‡†ï¼Œå…¨ç§°æ˜¯"è·¨åŸŸèµ„æºå…±äº«"ã€‚<code>CORS</code> éœ€è¦æµè§ˆå™¨å’ŒæœåŠ¡å™¨åŒæ—¶æ”¯æŒã€‚ç›®å‰ï¼Œæ‰€æœ‰æµè§ˆå™¨éƒ½æ”¯æŒè¯¥åŠŸèƒ½ï¼Œå› æ­¤æˆ‘ä»¬åªéœ€è¦åœ¨æœåŠ¡å™¨ç«¯é…ç½®å°±è¡Œã€‚æµè§ˆå™¨å°† <code>CORS</code> è¯·æ±‚åˆ†æˆä¸¤ç±»ï¼šç®€å•è¯·æ±‚å’Œéç®€å•è¯·æ±‚ã€‚å¯¹äºç®€å•è¯·æ±‚ï¼Œæµè§ˆå™¨ç›´æ¥å‘å‡º <code>CORS</code> è¯·æ±‚ã€‚å…·ä½“æ¥è¯´ï¼Œå°±æ˜¯ä¼šåœ¨å¤´ä¿¡æ¯ä¹‹ä¸­ï¼Œå¢åŠ ä¸€ä¸ª <code>Origin</code> å­—æ®µã€‚<code>Origin</code> å­—æ®µç”¨æ¥è¯´æ˜æœ¬æ¬¡è¯·æ±‚æ¥è‡ªå“ªä¸ªæºã€‚æœåŠ¡å™¨æ ¹æ®è¿™ä¸ªå€¼ï¼Œå†³å®šæ˜¯å¦åŒæ„è¿™æ¬¡è¯·æ±‚ã€‚å¯¹äºå¦‚æœ <code>Origin</code> æŒ‡å®šçš„æºï¼Œä¸åœ¨è®¸å¯èŒƒå›´å†…ï¼ŒæœåŠ¡å™¨ä¼šè¿”å›ä¸€ä¸ªæ­£å¸¸çš„ HTTP å›åº”ã€‚æµè§ˆå™¨å‘ç°ï¼Œè¿™ä¸ªå›åº”çš„å¤´ä¿¡æ¯æ²¡æœ‰åŒ…å« <code>Access-Control-Allow-Origin</code> å­—æ®µï¼Œå°±çŸ¥é“å‡ºé”™äº†ï¼Œä»è€ŒæŠ›å‡ºä¸€ä¸ªé”™è¯¯ï¼Œ<code>ajax</code> ä¸ä¼šæ”¶åˆ°å“åº”ä¿¡æ¯ã€‚å¦‚æœæˆåŠŸçš„è¯ä¼šåŒ…å«ä¸€äº›ä»¥ <code>Access-Control-</code> å¼€å¤´çš„å­—æ®µã€‚éç®€å•è¯·æ±‚ï¼Œæµè§ˆå™¨ä¼šå…ˆå‘å‡ºä¸€æ¬¡é¢„æ£€è¯·æ±‚ï¼Œæ¥åˆ¤æ–­è¯¥åŸŸåæ˜¯å¦åœ¨æœåŠ¡å™¨çš„ç™½åå•ä¸­ï¼Œå¦‚æœæ”¶åˆ°è‚¯å®šå›å¤åæ‰ä¼šå‘èµ·è¯·æ±‚ã€‚</p>
<h3 data-id="heading-8">2.7 ä½¿ç”¨ websocket åè®®ï¼Œè¿™ä¸ªåè®®æ²¡æœ‰åŒæºé™åˆ¶</h3>
<h3 data-id="heading-9">2.6 ä½¿ç”¨æœåŠ¡å™¨æ¥ä»£ç†è·¨åŸŸçš„è®¿é—®è¯·æ±‚</h3>
<p>å°±æ˜¯æœ‰è·¨åŸŸçš„è¯·æ±‚æ“ä½œæ—¶å‘é€è¯·æ±‚ç»™åç«¯ï¼Œè®©åç«¯ä»£ä¸ºè¯·æ±‚ï¼Œç„¶åæœ€åå°†è·å–çš„ç»“æœå‘è¿”å›ã€‚</p>
<h1 data-id="heading-10">3.jsonpè¯¦è§£</h1>
<h2 data-id="heading-11">3.1 åŸºæœ¬åŸç†</h2>
<p><code>Jsonp(JSON with Padding) </code>æ˜¯ <code>json</code> çš„ä¸€ç§"ä½¿ç”¨æ¨¡å¼"ï¼Œå¯ä»¥è®©ç½‘é¡µä»åˆ«çš„åŸŸåï¼ˆç½‘ç«™ï¼‰é‚£è·å–èµ„æ–™ï¼Œå³è·¨åŸŸè¯»å–æ•°æ®ã€‚åœ¨ä¸Šæ–‡ä¸­å·²ç»è¯´æ˜ï¼Œ<code>jsonp</code> çš„åŸºæœ¬åŸç†ï¼Œä¸»è¦å°±æ˜¯åˆ©ç”¨äº† <code>script</code> æ ‡ç­¾çš„ <code>src</code> æ²¡æœ‰è·¨åŸŸé™åˆ¶æ¥å®Œæˆçš„ã€‚</p>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-keyword">let</span> a = <span class="hljs-number">123</span>;
<span class="hljs-built_in">this</span>.document.getElementById(<span class="hljs-string">'123'</span>)
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<h2 data-id="heading-12">3.2 æ‰§è¡Œè¿‡ç¨‹</h2>
<ul>
<li>å‰ç«¯å®šä¹‰ä¸€ä¸ªè§£æå‡½æ•°(å¦‚: <code>jsonpCallback = function (res) &#123;&#125;</code>)</li>
<li>é€šè¿‡<code>params</code>çš„å½¢å¼åŒ…è£…<code>script</code>æ ‡ç­¾çš„è¯·æ±‚å‚æ•°ï¼Œå¹¶ä¸”å£°æ˜æ‰§è¡Œå‡½æ•°(å¦‚<code>cb=jsonpCallback</code>)</li>
<li>åç«¯è·å–åˆ°å‰ç«¯å£°æ˜çš„æ‰§è¡Œå‡½æ•°(<code>jsonpCallback</code>)ï¼Œå¹¶ä»¥å¸¦ä¸Šå‚æ•°ä¸”è°ƒç”¨æ‰§è¡Œå‡½æ•°çš„æ–¹å¼ä¼ é€’ç»™å‰ç«¯</li>
<li>å‰ç«¯åœ¨scriptæ ‡ç­¾è¿”å›èµ„æºçš„æ—¶å€™å°±ä¼šå»æ‰§è¡Œ<code>jsonpCallback</code>å¹¶é€šè¿‡å›è°ƒå‡½æ•°çš„æ–¹å¼æ‹¿åˆ°æ•°æ®äº†ã€‚</li>
</ul>
<h2 data-id="heading-13">3.3 ä¼˜ç¼ºç‚¹</h2>
<p><strong>ç¼ºç‚¹</strong>ï¼šåªèƒ½è¿›è¡ŒGETè¯·æ±‚,è€Œä¸”éœ€è¦åç«¯é…åˆè¿›è¡Œå‡½æ•°é€»è¾‘ä¹¦å†™ã€‚</p>
<p><strong>ä¼˜ç‚¹</strong>ï¼šå…¼å®¹æ€§å¥½ï¼Œåœ¨ä¸€äº›å¤è€çš„æµè§ˆå™¨ä¸­éƒ½å¯ä»¥è¿è¡Œã€‚</p>
<h2 data-id="heading-14">3.4 æ¡ˆä¾‹åˆ†æ</h2>
<p>å…ˆæ¥çœ‹çœ‹æˆ‘ä»¬è¦å®ç°ä¸€ä¸ªä»€ä¹ˆæ•ˆæœ,åœ¨ä¸€ä¸ªå«<code>index.html</code>çš„æ–‡ä»¶ä¸­æœ‰ä»¥ä¸‹ä»£ç ï¼š</p>
<pre><code class="hljs language-html copyable" lang="html"><span class="hljs-tag"><<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">'text/javascript'</span>></span><span class="javascript">
    <span class="hljs-built_in">window</span>.jsonpCallback = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">res</span>) </span>&#123;
        <span class="hljs-built_in">console</span>.log(res)
    &#125;
</span><span class="hljs-tag"></<span class="hljs-name">script</span>></span>
<span class="hljs-tag"><<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">'http://localhost:8080/api/jsonp?id=1&cb=jsonpCallback'</span> <span class="hljs-attr">type</span>=<span class="hljs-string">'text/javascript'</span>></span><span class="hljs-tag"></<span class="hljs-name">script</span>></span>
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<p>ç„¶åæˆ‘æœ¬åœ°æœ‰ä¸€ä¸ªæ–‡ä»¶<code>server.js</code>å®ƒä¼šä½¿ç”¨<code>node</code>æä¾›ä¸€ä¸ªæœåŠ¡ï¼Œæ¥æ¨¡æ‹ŸæœåŠ¡å™¨,å¹¶ä¸”å®šä¹‰ä¸€ä¸ªæ¥å£<code>/api/jsonp</code>æ¥æŸ¥è¯¢idå¯¹åº”çš„æ•°æ®ã€‚</p>
<p>å½“æˆ‘æ‰“å¼€<code>index.html</code>çš„æ—¶å€™å°±ä¼šåŠ è½½<code>script</code>æ ‡ç­¾ï¼Œå¹¶æ‰§è¡Œäº†æ­¤æ¬¡è·¨åŸŸè¯·æ±‚ã€‚</p>
<h3 data-id="heading-15">å‰æœŸå‡†å¤‡</h3>
<ul>
<li>æˆ‘åœ¨æœ¬åœ°æ–°å»ºä¸€ä¸ªæ–‡ä»¶å¤¹<code>node-cors</code></li>
<li>å¹¶åœ¨æ­¤ç›®å½•ä¸‹<code>npm init</code>ï¼Œåˆå§‹åŒ–<code>package.json</code></li>
<li>å®‰è£…<code>koa</code>(<code>node</code>çš„ä¸€ä¸ªè½»é‡çº§æ¡†æ¶)</li>
<li>æ–°å»ºæ–‡ä»¶å¤¹<code>jsonp</code>ï¼Œå¹¶æ–°å»º<code>index.html</code>å’Œ<code>server.js</code>ï¼Œä¸€ä¸ªå†™å‰ç«¯ä»£ç ï¼Œä¸€ä¸ªå†™åç«¯</li>
</ul>
<pre><code class="hljs language-js copyable" lang="js">mkdir node-cors && cd node-cors
npm init
cnpm i --save-dev koa
mkdir jsonp && cd jsonp
touch index.html
touch server.js
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<h3 data-id="heading-16">åç«¯ä»£ç </h3>
<p>ç”±äºJSONPçš„å®ç°éœ€è¦å‰åç«¯é…åˆï¼Œå…ˆæ¥å†™ä¸€ä¸‹åç«¯çš„å®ç°
ï¼ˆçœ‹ä¸æ‡‚æ²¡å…³ç³»ï¼Œä¸‹é¢çš„å‰ç«¯ç®€å•å®ç°ä¼šåšè§£é‡Šï¼‰ï¼š</p>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-keyword">const</span> Koa = <span class="hljs-built_in">require</span>(<span class="hljs-string">'koa'</span>);
<span class="hljs-keyword">const</span> app = <span class="hljs-keyword">new</span> Koa();
<span class="hljs-keyword">const</span> items = [&#123; <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">title</span>: <span class="hljs-string">'title1'</span> &#125;, &#123; <span class="hljs-attr">id</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">title</span>: <span class="hljs-string">'title2'</span> &#125;]

app.use(<span class="hljs-keyword">async</span> (ctx, next) => &#123;
  <span class="hljs-keyword">if</span> (ctx.path === <span class="hljs-string">'/api/jsonp'</span>) &#123;
    <span class="hljs-keyword">const</span> &#123; cb, id &#125; = ctx.query;
    <span class="hljs-keyword">const</span> title = items.find(<span class="hljs-function"><span class="hljs-params">item</span> =></span> item.id == id)[<span class="hljs-string">'title'</span>]
    ctx.body = <span class="hljs-string">`<span class="hljs-subst">$&#123;cb&#125;</span>(<span class="hljs-subst">$&#123;<span class="hljs-built_in">JSON</span>.stringify(&#123;title&#125;)&#125;</span>)`</span>;
    <span class="hljs-keyword">return</span>;
  &#125;
&#125;)
<span class="hljs-built_in">console</span>.log(<span class="hljs-string">'listen 8080...'</span>)
app.listen(<span class="hljs-number">8080</span>);
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<p>å†™å®Œä¹‹åï¼Œä¿å­˜ã€‚å¹¶åœ¨jsonpè¿™ä¸ªæ–‡ä»¶å¤¹ä¸‹æ‰§è¡Œï¼š</p>
<pre><code class="hljs language-js copyable" lang="js">node server.js
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<p>æ¥å¯åŠ¨æœåŠ¡ï¼Œå¯ä»¥çœ‹åˆ°ç¼–è¾‘å™¨çš„æ§åˆ¶å°ä¸­ä¼šæ‰“å°å‡º<code>"listen 8080..."</code></p>
<p>å‰ç«¯ç®€å•å®ç°OKğŸ‘Œï¼Œåç«¯å·²ç»å®ç°äº†ï¼Œç°åœ¨è®©æˆ‘ä»¬æ¥çœ‹çœ‹å‰ç«¯æœ€ç®€å•çš„ä¸€ç§å®ç°æ–¹å¼ï¼Œä¹Ÿå°±æ˜¯å†™æ­»ä¸€ä¸ªscriptå¹¶å‘é€è¯·æ±‚ï¼š</p>
<p><code>index.html</code>ä¸­ï¼š</p>
<pre><code class="hljs language-html copyable" lang="html"><span class="hljs-tag"><<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">'text/javascript'</span>></span><span class="javascript">
    <span class="hljs-built_in">window</span>.jsonpCallback = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">res</span>) </span>&#123;
        <span class="hljs-built_in">console</span>.log(res)
    &#125;
</span><span class="hljs-tag"></<span class="hljs-name">script</span>></span>
<span class="hljs-tag"><<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">'http://localhost:8080/api/jsonp?id=1&cb=jsonpCallback'</span> <span class="hljs-attr">type</span>=<span class="hljs-string">'text/javascript'</span>></span><span class="hljs-tag"></<span class="hljs-name">script</span>></span>
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<p>è¿™ä¸¤ä¸ª<code>script</code>çš„æ„æ€æ˜¯ï¼š</p>
<ul>
<li>ç¬¬ä¸€ä¸ªï¼Œåˆ›å»ºä¸€ä¸ª<code>jsonpCallback</code>å‡½æ•°ã€‚ä½†æ˜¯å®ƒè¿˜æ²¡æœ‰è¢«è°ƒç”¨</li>
<li>ç¬¬äºŒä¸ªï¼ŒåŠ è½½<code>src</code>ä¸­çš„èµ„æºï¼Œå¹¶ç­‰å¾…è¯·æ±‚çš„å†…å®¹è¿”å›</li>
</ul>
<p>æ•´ä¸ªè¿‡ç¨‹å°±æ˜¯ï¼š</p>
<ol>
<li>
<p>å½“æ‰§è¡Œåˆ°ç¬¬äºŒä¸ª<code>script</code>çš„æ—¶å€™ï¼Œç”±äºè¯·æ±‚äº†æˆ‘ä»¬çš„<code>8080</code>ç«¯å£ï¼Œå¹¶ä¸”æŠŠ<code>id</code>å’Œ<code>cb</code>è¿™ä¸¤ä¸ªå‚æ•°æ”¾åˆ°URLé‡Œã€‚é‚£ä¹ˆåå°å°±å¯ä»¥æ‹¿åˆ°<code>UR</code>Lé‡Œçš„è¿™ä¸¤ä¸ªå‚æ•°ã€‚</p>
</li>
<li>
<p>ä¹Ÿå°±æ˜¯åœ¨åç«¯ä»£ç ä¸­çš„<code>const &#123; id, cb &#125; = ctx.query</code>è¿™é‡Œè·å–åˆ°äº†ã€‚</p>
</li>
<li>
<p>é‚£ä¹ˆåç«¯åœ¨æ‹¿åˆ°è¿™ä¸¤ä¸ªå‚æ•°ä¹‹åï¼Œå¯èƒ½å°±ä¼šæ ¹æ®idæ¥è¿›è¡Œä¸€äº›æŸ¥è¯¢ï¼Œå½“ç„¶ï¼Œæˆ‘è¿™é‡Œåªæ˜¯æ¨¡æ‹Ÿçš„æŸ¥è¯¢ï¼Œç”¨äº†ä¸€ä¸ªç®€å•çš„<code>find</code>æ¥è¿›è¡Œä¸€ä¸ªæŸ¥æ‰¾ã€‚æŸ¥æ‰¾åˆ°<code>id</code>ä¸º<code>1</code>çš„é‚£é¡¹å¹¶ä¸”å–<code>title</code>ã€‚</p>
</li>
<li>
<p>ç¬¬äºŒä¸ªå‚æ•°<code>cb</code>ï¼Œæ‹¿åˆ°çš„å°±æ˜¯<code>"jsonpCallback"</code>äº†ï¼Œè¿™é‡Œä¹Ÿå°±æ˜¯å‘Šè¯‰åç«¯ï¼Œå‰ç«¯é‚£é‡Œæ˜¯ä¼šæœ‰ä¸€ä¸ªå«åš<code>jsonpCallback</code>çš„å‡½æ•°æ¥æ¥æ”¶åç«¯æƒ³è¦è¿”å›çš„æ•°æ®ï¼Œè€Œåç«¯ä½ åªéœ€è¦åœ¨è¿”å›ä½“ä¸­å†™å…¥<code>jsonpCallback()</code>å°±å¯ä»¥äº†ã€‚</p>
</li>
<li>
<p>å‰ç«¯åœ¨å¾—åˆ°äº†åç«¯è¿”å›çš„å†…å®¹<code>jsonpCallback(&#123;"title":"title1"&#125;)</code>ï¼Œå‘ç°é‡Œé¢æ˜¯ä¸€æ®µæ‰§è¡Œå‡½æ•°çš„è¯­å¥ï¼Œå› æ­¤å°±ä¼šå»æ‰§è¡Œç¬¬ä¸€ä¸ª<code>script</code>ä¸­çš„<code>jsonpCallback</code>æ–¹æ³•äº†ï¼Œå¹¶ä¸”åˆæ˜¯å¸¦äº†å‚æ•°çš„ï¼Œæ‰€ä»¥æ­¤æ—¶æµè§ˆå™¨æ§åˆ¶å°ä¼šæ‰“å°å‡º<code>&#123; title: 'title1' &#125;</code></p>
</li>
</ol>
<p>ä»¥æ­¤æ¥è¾¾åˆ°ä¸€ä¸ªç®€å•çš„è·¨åŸŸçš„æ•ˆæœã€‚</p>
<p>å…¶å®ä½ æƒ³æƒ³ï¼Œå¦‚æœæˆ‘ä»¬æŠŠç¬¬äºŒä¸ª<code>script</code>æ ‡ç­¾æ¢æˆä»¥ä¸‹ä»£ç ï¼Œæ˜¯ä¸æ˜¯ä¹Ÿèƒ½è¾¾åˆ°åŒæ ·çš„æ•ˆæœå‘¢ï¼Ÿ</p>
<pre><code class="hljs language-html copyable" lang="html"><span class="hljs-comment"><!-- <script src='http://localhost:8080/api/jsonp?id=1&cb=jsonpCallback' type='text/javascript'></script> --></span>
<span class="hljs-tag"><<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text/javascript"</span>></span><span class="javascript">
    jsonpCallback(&#123; <span class="hljs-attr">title</span>: <span class="hljs-string">'title1'</span> &#125;)
</span><span class="hljs-tag"></<span class="hljs-name">script</span>></span>
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<h3 data-id="heading-17">jQueryä¸­çš„jsonpå®ç°</h3>
<p>ä¸Šé¢ğŸ‘†æˆ‘ä»¬ä»‹ç»äº†ç”¨<code>script</code>æ ‡ç­¾æ¥å®ç°ï¼Œåœ¨<code>jQuery</code>çš„<code>$.ajax()</code>æ–¹æ³•å…¶å®ä¹Ÿæä¾›äº†<code>jsonp</code>ã€‚</p>
<p>è®©æˆ‘ä»¬ä¸€èµ·æ¥çœ‹çœ‹ï¼š</p>
<pre><code class="hljs language-html copyable" lang="html"><span class="hljs-tag"><<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://cdn.bootcss.com/jquery/3.5.0/jquery.min.js"</span>></span><span class="hljs-tag"></<span class="hljs-name">script</span>></span>
<span class="hljs-tag"><<span class="hljs-name">script</span>></span><span class="javascript">
    $.ajax(&#123;
        <span class="hljs-attr">url</span>: <span class="hljs-string">"http://localhost:8080/api/jsonp"</span>,
        <span class="hljs-attr">dataType</span>: <span class="hljs-string">"jsonp"</span>,
        <span class="hljs-attr">type</span>: <span class="hljs-string">"get"</span>,
        <span class="hljs-attr">data</span>: &#123;
            <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>
        &#125;,
        <span class="hljs-attr">jsonp</span>: <span class="hljs-string">"cb"</span>,
        <span class="hljs-attr">success</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">data</span>) </span>&#123;
            <span class="hljs-built_in">console</span>.log(data);
        &#125;
    &#125;);
</span><span class="hljs-tag"></<span class="hljs-name">script</span>></span>
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<p>åœ¨<code>success</code>å›è°ƒä¸­åŒæ ·å¯ä»¥æ‹¿åˆ°æ•°æ®ã€‚</p>
<h2 data-id="heading-18">3.5 å®Œæ•´jsonpå°è£…å®ç°</h2>
<h3 data-id="heading-19">ç®€æ˜“ç‰ˆ</h3>
<p>å…ˆçœ‹ä¸‹æˆ‘ä»¬è¦å®ç°çš„åŠŸèƒ½</p>
<p>å®šä¹‰ä¸€ä¸ª<code>JSONP</code>æ–¹æ³•ï¼Œå®ƒæ¥æ”¶å››ä¸ªå‚æ•°ï¼š</p>
<ul>
<li>url</li>
<li>params</li>
<li>callbackKeyï¼šä¸åå°çº¦å®šçš„å›è°ƒå‡½æ•°æ˜¯ç”¨å“ªä¸ªå­—æ®µ(å¦‚<code>cb</code>)</li>
<li>callbackï¼šæ‹¿åˆ°æ•°æ®ä¹‹åæ‰§è¡Œçš„å›è°ƒå‡½æ•°</li>
</ul>
<pre><code class="hljs language-html copyable" lang="html"><span class="hljs-tag"><<span class="hljs-name">script</span>></span><span class="javascript">
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">JSONP</span>(<span class="hljs-params">&#123;
        url,
        params = &#123;&#125;,
        callbackKey = <span class="hljs-string">'cb'</span>,
        callback
    &#125;</span>) </span>&#123;
        <span class="hljs-comment">// å®šä¹‰æœ¬åœ°çš„ä¸€ä¸ªcallbackçš„åç§°</span>
        <span class="hljs-keyword">const</span> callbackName = <span class="hljs-string">'jsonpCallback'</span>;
        <span class="hljs-comment">// æŠŠè¿™ä¸ªåç§°åŠ å…¥åˆ°å‚æ•°ä¸­: 'cb=jsonpCallback'</span>
        params[callbackKey] = callbackName;
        <span class="hljs-comment">//  æŠŠè¿™ä¸ªcallbackåŠ å…¥åˆ°windowå¯¹è±¡ä¸­ï¼Œè¿™æ ·å°±èƒ½æ‰§è¡Œè¿™ä¸ªå›è°ƒäº†</span>
        <span class="hljs-built_in">window</span>[callbackName] = callback;

        <span class="hljs-comment">// å¾—åˆ°'id=1&cb=jsonpCallback'</span>
        <span class="hljs-keyword">const</span> paramString = <span class="hljs-built_in">Object</span>.keys(params).map(<span class="hljs-function"><span class="hljs-params">key</span> =></span> &#123;
            <span class="hljs-keyword">return</span> <span class="hljs-string">`<span class="hljs-subst">$&#123;key&#125;</span>=<span class="hljs-subst">$&#123;params[key]&#125;</span>`</span>
        &#125;).join(<span class="hljs-string">'&'</span>)
        <span class="hljs-comment">// åˆ›å»º script æ ‡ç­¾</span>
        <span class="hljs-keyword">const</span> script = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">'script'</span>);
        script.setAttribute(<span class="hljs-string">'src'</span>, <span class="hljs-string">`<span class="hljs-subst">$&#123;url&#125;</span>?<span class="hljs-subst">$&#123;paramString&#125;</span>`</span>);
        <span class="hljs-built_in">document</span>.body.appendChild(script);
    &#125;
    JSONP(&#123;
        <span class="hljs-attr">url</span>: <span class="hljs-string">'http://localhost:8080/api/jsonp'</span>,
        <span class="hljs-attr">params</span>: &#123; <span class="hljs-attr">id</span>: <span class="hljs-number">1</span> &#125;,
        <span class="hljs-attr">callbackKey</span>: <span class="hljs-string">'cb'</span>,
        callback (res) &#123;
            <span class="hljs-built_in">console</span>.log(res)
        &#125;
    &#125;)
</span><span class="hljs-tag"></<span class="hljs-name">script</span>></span>
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<p>è¿™æ ·å†™æ‰“å¼€é¡µé¢ä¹Ÿå¯æ˜¯å¯ä»¥çœ‹åˆ°æ•ˆæœçš„ã€‚</p>
<h3 data-id="heading-20">åŒæ—¶å¤šä¸ªè¯·æ±‚</h3>
<p>ä¸Šé¢æˆ‘ä»¬è™½ç„¶å®ç°äº†<code>JSONP</code>ï¼Œä½†æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œé‚£å°±æ˜¯å¦‚æœæˆ‘åŒæ—¶å¤šæ¬¡è°ƒç”¨<code>JSONP</code>ï¼š</p>
<pre><code class="hljs language-js copyable" lang="js">JSONP(&#123;
    <span class="hljs-attr">url</span>: <span class="hljs-string">'http://localhost:8080/api/jsonp'</span>,
    <span class="hljs-attr">params</span>: &#123; <span class="hljs-attr">id</span>: <span class="hljs-number">1</span> &#125;,
    <span class="hljs-attr">callbackKey</span>: <span class="hljs-string">'cb'</span>,
    callback (res) &#123;
        <span class="hljs-built_in">console</span>.log(res) <span class="hljs-comment">// No.1</span>
    &#125;
&#125;)
JSONP(&#123;
    <span class="hljs-attr">url</span>: <span class="hljs-string">'http://localhost:8080/api/jsonp'</span>,
    <span class="hljs-attr">params</span>: &#123; <span class="hljs-attr">id</span>: <span class="hljs-number">2</span> &#125;,
    <span class="hljs-attr">callbackKey</span>: <span class="hljs-string">'cb'</span>,
    callback (res) &#123;
        <span class="hljs-built_in">console</span>.log(res) <span class="hljs-comment">// No.2</span>
    &#125;
&#125;)
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<p>å¯ä»¥çœ‹åˆ°è¿™é‡Œæˆ‘è°ƒç”¨äº†ä¸¤æ¬¡<code>JSONP</code>ï¼Œåªæ˜¯ä¼ é€’çš„å‚æ•°ä¸åŒã€‚ä½†æ˜¯å¹¶ä¸ä¼šæŒ‰æˆ‘ä»¬é¢„æœŸçš„åœ¨<code>No.1</code>å’Œ<code>No.2</code>ä¸­åˆ†åˆ«æ‰“å°ï¼Œè€Œæ˜¯éƒ½ä¼šåœ¨No.2ä¸­æ‰“å°å‡ºç»“æœã€‚è¿™æ˜¯å› ä¸ºåé¢ä¸€ä¸ª<code>callback</code>æŠŠ<code>JSONP</code>é‡Œå°è£…çš„ç¬¬ä¸€ä¸ª<code>callback</code>ç»™è¦†ç›–äº†ï¼Œå®ƒä»¬éƒ½æ˜¯å…±ç”¨çš„åŒä¸€ä¸ª<code>callbackName</code>ï¼Œä¹Ÿå°±æ˜¯<code>jsonpCallback</code>ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<p><img alt="image.png" class="lazyload" src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6fb3d06c2c12425ea28364ed8a5383ea~tplv-k3u1fbpfcp-zoom-1.image" data-width="800" data-height="600" referrerpolicy="no-referrer"></p>
<p>ä¸¤æ¬¡ç»“æœéƒ½æ˜¯ä»76è¡Œæ‰“å°å‡ºæ¥çš„ã€‚</p>
<p>æ‰€ä»¥æˆ‘ä»¬å¾—æ”¹é€ ä¸€ä¸‹ä¸Šé¢çš„<code>JSONP</code>æ–¹æ³•ï¼š</p>
<p>è®©<code>callbackName</code>æ˜¯ä¸€ä¸ªå”¯ä¸€çš„ï¼Œå¯ä»¥ä½¿ç”¨é€’å¢
ä¸è¦æŠŠå›è°ƒå®šä¹‰åœ¨<code>window</code>ä¸­è¿™æ ·ä¼šæ±¡æŸ“å…¨å±€å˜é‡ï¼Œå¯ä»¥æŠŠå®ƒæ‰”åˆ°<code>JSON.xxx</code>ä¸­
OKğŸ‘Œï¼Œæ¥çœ‹çœ‹æ”¹é€ ä¹‹åçš„ä»£ç ï¼š</p>
<pre><code class="hljs language-html copyable" lang="html"><span class="hljs-tag"><<span class="hljs-name">script</span>></span><span class="javascript">
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">JSONP</span>(<span class="hljs-params">&#123;
        url,
        params = &#123;&#125;,
        callbackKey = <span class="hljs-string">'cb'</span>,
        callback
    &#125;</span>) </span>&#123;
        <span class="hljs-comment">// å®šä¹‰æœ¬åœ°çš„å”¯ä¸€callbackIdï¼Œè‹¥æ˜¯æ²¡æœ‰çš„è¯åˆ™åˆå§‹åŒ–ä¸º1</span>
        JSONP.callbackId = JSONP.callbackId || <span class="hljs-number">1</span>;
        <span class="hljs-keyword">let</span> callbackId = JSONP.callbackId;
        <span class="hljs-comment">// æŠŠè¦æ‰§è¡Œçš„å›è°ƒåŠ å…¥åˆ°JSONå¯¹è±¡ä¸­ï¼Œé¿å…æ±¡æŸ“window</span>
        JSONP.callbacks = JSONP.callbacks || [];
        JSONP.callbacks[callbackId] = callback;
        <span class="hljs-comment">// æŠŠè¿™ä¸ªåç§°åŠ å…¥åˆ°å‚æ•°ä¸­: 'cb=JSONP.callbacks[1]'</span>
        params[callbackKey] = <span class="hljs-string">`JSONP.callbacks[<span class="hljs-subst">$&#123;callbackId&#125;</span>]`</span>;

        <span class="hljs-comment">// å¾—åˆ°'id=1&cb=JSONP.callbacks[1]'</span>
        <span class="hljs-keyword">const</span> paramString = <span class="hljs-built_in">Object</span>.keys(params).map(<span class="hljs-function"><span class="hljs-params">key</span> =></span> &#123;
            <span class="hljs-keyword">return</span> <span class="hljs-string">`<span class="hljs-subst">$&#123;key&#125;</span>=<span class="hljs-subst">$&#123;params[key]&#125;</span>`</span>
        &#125;).join(<span class="hljs-string">'&'</span>)
        <span class="hljs-comment">// åˆ›å»º script æ ‡ç­¾</span>
        <span class="hljs-keyword">const</span> script = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">'script'</span>);
        script.setAttribute(<span class="hljs-string">'src'</span>, <span class="hljs-string">`<span class="hljs-subst">$&#123;url&#125;</span>?<span class="hljs-subst">$&#123;paramString&#125;</span>`</span>);
        <span class="hljs-built_in">document</span>.body.appendChild(script);
        <span class="hljs-comment">// idè‡ªå¢ï¼Œä¿è¯å”¯ä¸€</span>
        JSONP.callbackId++;
    &#125;
    JSONP(&#123;
        <span class="hljs-attr">url</span>: <span class="hljs-string">'http://localhost:8080/api/jsonp'</span>,
        <span class="hljs-attr">params</span>: &#123; <span class="hljs-attr">id</span>: <span class="hljs-number">1</span> &#125;,
        <span class="hljs-attr">callbackKey</span>: <span class="hljs-string">'cb'</span>,
        callback (res) &#123;
            <span class="hljs-built_in">console</span>.log(res)
        &#125;
    &#125;)
    JSONP(&#123;
        <span class="hljs-attr">url</span>: <span class="hljs-string">'http://localhost:8080/api/jsonp'</span>,
        <span class="hljs-attr">params</span>: &#123; <span class="hljs-attr">id</span>: <span class="hljs-number">2</span> &#125;,
        <span class="hljs-attr">callbackKey</span>: <span class="hljs-string">'cb'</span>,
        callback (res) &#123;
            <span class="hljs-built_in">console</span>.log(res)
        &#125;
    &#125;)
</span><span class="hljs-tag"></<span class="hljs-name">script</span>></span>
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<p>å¯ä»¥çœ‹åˆ°ç°åœ¨è°ƒç”¨äº†ä¸¤æ¬¡å›è°ƒï¼Œä½†æ˜¯ä¼šåˆ†åˆ«æ‰§è¡Œ<code>JSONP.callbacks[1]</code>å’Œ<code>JSONP.callbacks[2]</code>ï¼š</p>
<p><img alt="image.png" class="lazyload" src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/05806327d64c423ea3aba6296550b0fe~tplv-k3u1fbpfcp-zoom-1.image" data-width="800" data-height="600" referrerpolicy="no-referrer"></p>
<h3 data-id="heading-21">ç»§ç»­æ”¹è¿›</h3>
<p>å…¶å®ä¸Šé¢å·²ç»ç®—æ¯”è¾ƒå®Œç¾äº†ï¼Œä½†æ˜¯è¿˜ä¼šæœ‰ä¸€ä¸ªå°é—®é¢˜ï¼Œæ¯”å¦‚ä¸‹é¢è¿™ç§æƒ…å†µï¼š</p>
<p>æˆ‘æ”¹ä¸€ä¸‹åç«¯çš„ä»£ç </p>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-keyword">const</span> Koa = <span class="hljs-built_in">require</span>(<span class="hljs-string">'koa'</span>);
<span class="hljs-keyword">const</span> app = <span class="hljs-keyword">new</span> Koa();
<span class="hljs-keyword">const</span> items = [&#123; <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">title</span>: <span class="hljs-string">'title1'</span> &#125;, &#123; <span class="hljs-attr">id</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">title</span>: <span class="hljs-string">'title2'</span> &#125;]

app.use(<span class="hljs-keyword">async</span> (ctx, next) => &#123;
  <span class="hljs-keyword">if</span> (ctx.path === <span class="hljs-string">'/api/jsonp'</span>) &#123;
    <span class="hljs-keyword">const</span> &#123; cb, id &#125; = ctx.query;
    <span class="hljs-keyword">const</span> title = items.find(<span class="hljs-function"><span class="hljs-params">item</span> =></span> item.id == id)[<span class="hljs-string">'title'</span>]
    ctx.body = <span class="hljs-string">`<span class="hljs-subst">$&#123;cb&#125;</span>(<span class="hljs-subst">$&#123;<span class="hljs-built_in">JSON</span>.stringify(&#123;title&#125;)&#125;</span>)`</span>;
    <span class="hljs-keyword">return</span>;
  &#125;
  <span class="hljs-keyword">if</span> (ctx.path === <span class="hljs-string">'/api/jsonps'</span>) &#123;
    <span class="hljs-keyword">const</span> &#123; cb, a, b &#125; = ctx.query;
    ctx.body = <span class="hljs-string">`<span class="hljs-subst">$&#123;cb&#125;</span>(<span class="hljs-subst">$&#123;<span class="hljs-built_in">JSON</span>.stringify(&#123; a, b &#125;)&#125;</span>)`</span>;
    <span class="hljs-keyword">return</span>;
  &#125;
&#125;)
<span class="hljs-built_in">console</span>.log(<span class="hljs-string">'listen 8080...'</span>)
app.listen(<span class="hljs-number">8080</span>);
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<p>å¢åŠ äº†ä¸€ä¸ª<code>/api/jsonps</code>çš„æ¥å£ã€‚</p>
<p>ç„¶åå‰ç«¯ä»£ç å¢åŠ äº†ä¸€ä¸ªè¿™æ ·çš„è¯·æ±‚ï¼š</p>
<pre><code class="hljs language-js copyable" lang="js">JSONP(&#123;
    <span class="hljs-attr">url</span>: <span class="hljs-string">'http://localhost:8080/api/jsonps'</span>,
    <span class="hljs-attr">params</span>: &#123;
        <span class="hljs-attr">a</span>: <span class="hljs-string">'2&b=3'</span>,
        <span class="hljs-attr">b</span>: <span class="hljs-string">'4'</span>
    &#125;,
    <span class="hljs-attr">callbackKey</span>: <span class="hljs-string">'cb'</span>,
    callback (res) &#123;
        <span class="hljs-built_in">console</span>.log(res)
    &#125;
&#125;)
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<p>å¯ä»¥çœ‹åˆ°ï¼Œå‚æ•°çš„<code>a</code>ä¸­ä¹Ÿä¼šæœ‰<code>b</code>è¿™ä¸ªå­—ç¬¦ä¸²ï¼Œè¿™æ ·å°±å¯¼è‡´æˆ‘ä»¬è·å–åˆ°çš„æ•°æ®ä¸å¯¹äº†ï¼š</p>
<p>åå°å¹¶ä¸çŸ¥é“<code>a</code>çš„å‚æ•°æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå®ƒåªä¼šæŒ‰ç…§<code>&</code>æ¥æˆªå–å‚æ•°ã€‚</p>
<p>æ‰€ä»¥ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå¯ä»¥ä½¿ç”¨<code>URI</code>ç¼–ç ã€‚</p>
<p>ä¹Ÿå°±æ˜¯ä½¿ç”¨ï¼š</p>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-built_in">encodeURIComponent</span>(<span class="hljs-string">'2&b=3'</span>)

<span class="hljs-comment">// ç»“æœä¸º"2%26b%3D3"</span>
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<p>åªéœ€è¦æ”¹ä¸€ä¸‹<code>JSONP</code>æ–¹æ³•ä¸­å‚æ•°çš„ç”Ÿæˆï¼š</p>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// å¾—åˆ°'id=1&cb=JSONP.callbacks[1]'</span>
<span class="hljs-keyword">const</span> paramString = <span class="hljs-built_in">Object</span>.keys(params).map(<span class="hljs-function"><span class="hljs-params">key</span> =></span> &#123;
    <span class="hljs-keyword">return</span> <span class="hljs-string">`<span class="hljs-subst">$&#123;key&#125;</span>=<span class="hljs-subst">$&#123;<span class="hljs-built_in">encodeURIComponent</span>(params[key])&#125;</span>`</span>
&#125;).join(<span class="hljs-string">'&'</span>)
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<h3 data-id="heading-22">æœ€ç»ˆå®ç°</h3>
<p>æ¥çœ‹ä¸€ä¸‹å®Œæ•´ç‰ˆçš„JSONPæ–¹æ³•ï¼š</p>
<pre><code class="hljs language-html copyable" lang="html"><span class="hljs-tag"><<span class="hljs-name">script</span>></span><span class="javascript">
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">JSONP</span>(<span class="hljs-params">&#123;
        url,
        params = &#123;&#125;,
        callbackKey = <span class="hljs-string">'cb'</span>,
        callback
    &#125;</span>) </span>&#123;
        <span class="hljs-comment">// å®šä¹‰æœ¬åœ°çš„å”¯ä¸€callbackIdï¼Œè‹¥æ˜¯æ²¡æœ‰çš„è¯åˆ™åˆå§‹åŒ–ä¸º1</span>
        JSONP.callbackId = JSONP.callbackId || <span class="hljs-number">1</span>;
        <span class="hljs-keyword">let</span> callbackId = JSONP.callbackId;
        <span class="hljs-comment">// æŠŠè¦æ‰§è¡Œçš„å›è°ƒåŠ å…¥åˆ°JSONå¯¹è±¡ä¸­ï¼Œé¿å…æ±¡æŸ“window</span>
        JSONP.callbacks = JSONP.callbacks || [];
        JSONP.callbacks[callbackId] = callback;
        <span class="hljs-comment">// æŠŠè¿™ä¸ªåç§°åŠ å…¥åˆ°å‚æ•°ä¸­: 'cb=JSONP.callbacks[1]'</span>
        params[callbackKey] = <span class="hljs-string">`JSONP.callbacks[<span class="hljs-subst">$&#123;callbackId&#125;</span>]`</span>;
        <span class="hljs-comment">// å¾—åˆ°'id=1&cb=JSONP.callbacks[1]'</span>
        <span class="hljs-keyword">const</span> paramString = <span class="hljs-built_in">Object</span>.keys(params).map(<span class="hljs-function"><span class="hljs-params">key</span> =></span> &#123;
            <span class="hljs-keyword">return</span> <span class="hljs-string">`<span class="hljs-subst">$&#123;key&#125;</span>=<span class="hljs-subst">$&#123;<span class="hljs-built_in">encodeURIComponent</span>(params[key])&#125;</span>`</span>
        &#125;).join(<span class="hljs-string">'&'</span>)
        <span class="hljs-comment">// åˆ›å»º script æ ‡ç­¾</span>
        <span class="hljs-keyword">const</span> script = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">'script'</span>);
        script.setAttribute(<span class="hljs-string">'src'</span>, <span class="hljs-string">`<span class="hljs-subst">$&#123;url&#125;</span>?<span class="hljs-subst">$&#123;paramString&#125;</span>`</span>);
        <span class="hljs-built_in">document</span>.body.appendChild(script);
        <span class="hljs-comment">// idè‡ªå¢ï¼Œä¿è¯å”¯ä¸€</span>
        JSONP.callbackId++;

    &#125;
    JSONP(&#123;
        <span class="hljs-attr">url</span>: <span class="hljs-string">'http://localhost:8080/api/jsonps'</span>,
        <span class="hljs-attr">params</span>: &#123;
            <span class="hljs-attr">a</span>: <span class="hljs-string">'2&b=3'</span>,
            <span class="hljs-attr">b</span>: <span class="hljs-string">'4'</span>
        &#125;,
        <span class="hljs-attr">callbackKey</span>: <span class="hljs-string">'cb'</span>,
        callback (res) &#123;
            <span class="hljs-built_in">console</span>.log(res)
        &#125;
    &#125;)
    JSONP(&#123;
        <span class="hljs-attr">url</span>: <span class="hljs-string">'http://localhost:8080/api/jsonp'</span>,
        <span class="hljs-attr">params</span>: &#123;
            <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>
        &#125;,
        <span class="hljs-attr">callbackKey</span>: <span class="hljs-string">'cb'</span>,
        callback (res) &#123;
            <span class="hljs-built_in">console</span>.log(res)
        &#125;
    &#125;)
</span><span class="hljs-tag"></<span class="hljs-name">script</span>></span>
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<p>æ³¨æ„âš ï¸ï¼š</p>
<p><code>encodeURI</code>å’Œ<code>encodeURIComponent</code>çš„åŒºåˆ«ï¼š</p>
<p><code>encodeURI()</code>ä¸ä¼šå¯¹æœ¬èº«å±äºURIçš„ç‰¹æ®Šå­—ç¬¦è¿›è¡Œç¼–ç ï¼Œä¾‹å¦‚å†’å·ã€æ­£æ–œæ ã€é—®å·å’Œäº•å­—å·ï¼›
è€Œ<code>encodeURIComponent()</code>åˆ™ä¼šå¯¹å®ƒå‘ç°çš„ä»»ä½•éæ ‡å‡†å­—ç¬¦è¿›è¡Œç¼–ç 
ä¾‹å¦‚ï¼š</p>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-keyword">var</span> url = <span class="hljs-string">'https://lindaidai.wang'</span>

<span class="hljs-built_in">encodeURI</span>(url) <span class="hljs-comment">// "https://lindaidai.wang"</span>

<span class="hljs-built_in">encodeURIComponent</span>(url) <span class="hljs-comment">// "https%3A%2F%2Flindaidai.wang"</span>
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<p>å¦å¤–ï¼Œå¯ä»¥ä½¿ç”¨<code>decodeURIComponent</code>æ¥è§£ç ã€‚</p>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-built_in">decodeURIComponent</span>(<span class="hljs-string">"https%3A%2F%2Flindaidai.wang"</span>)
<span class="hljs-comment">// 'https://lindaidai.wang'</span>
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre></div> <div class="image-viewer-box" data-v-78c9b824><!----></div>  
</div>
            