
---
title: '浏览器工作原理与实践'
categories: 
 - 编程
 - 掘金
 - 分类
headimg: 'https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f6dcc93e99834908971bc0c822c4e716~tplv-k3u1fbpfcp-watermark.image'
author: 掘金
comments: false
date: Tue, 20 Jul 2021 03:52:57 GMT
thumbnail: 'https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f6dcc93e99834908971bc0c822c4e716~tplv-k3u1fbpfcp-watermark.image'
---

<div>   
<div class="markdown-body"><style>.markdown-body&#123;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333&#125;.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6&#123;line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px&#125;.markdown-body h1&#123;font-size:30px;margin-bottom:5px&#125;.markdown-body h2&#123;padding-bottom:12px;font-size:24px;border-bottom:1px solid #ececec&#125;.markdown-body h3&#123;font-size:18px;padding-bottom:0&#125;.markdown-body h4&#123;font-size:16px&#125;.markdown-body h5&#123;font-size:15px&#125;.markdown-body h6&#123;margin-top:5px&#125;.markdown-body p&#123;line-height:inherit;margin-top:22px;margin-bottom:22px&#125;.markdown-body img&#123;max-width:100%&#125;.markdown-body hr&#123;border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px&#125;.markdown-body code&#123;word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em&#125;.markdown-body code,.markdown-body pre&#123;font-family:Menlo,Monaco,Consolas,Courier New,monospace&#125;.markdown-body pre&#123;overflow:auto;position:relative;line-height:1.75&#125;.markdown-body pre>code&#123;font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8&#125;.markdown-body a&#123;text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff&#125;.markdown-body a:active,.markdown-body a:hover&#123;color:#275b8c&#125;.markdown-body table&#123;display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6&#125;.markdown-body thead&#123;background:#f6f6f6;color:#000;text-align:left&#125;.markdown-body tr:nth-child(2n)&#123;background-color:#fcfcfc&#125;.markdown-body td,.markdown-body th&#123;padding:12px 7px;line-height:24px&#125;.markdown-body td&#123;min-width:120px&#125;.markdown-body blockquote&#123;color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8&#125;.markdown-body blockquote:after&#123;display:block;content:""&#125;.markdown-body blockquote>p&#123;margin:10px 0&#125;.markdown-body ol,.markdown-body ul&#123;padding-left:28px&#125;.markdown-body ol li,.markdown-body ul li&#123;margin-bottom:0;list-style:inherit&#125;.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item&#123;list-style:none&#125;.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul&#123;margin-top:0&#125;.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul&#123;margin-top:3px&#125;.markdown-body ol li&#123;padding-left:6px&#125;.markdown-body .contains-task-list&#123;padding-left:0&#125;.markdown-body .task-list-item&#123;list-style:none&#125;@media (max-width:720px)&#123;.markdown-body h1&#123;font-size:24px&#125;.markdown-body h2&#123;font-size:20px&#125;.markdown-body h3&#123;font-size:18px&#125;&#125;</style><h2 data-id="heading-0">01 | Chrome架构：仅仅打开了1个页面，为什么有4个进程？</h2>
<h3 data-id="heading-1">进程和线程</h3>
<h4 data-id="heading-2">进程</h4>
<blockquote>
<p>一个程序启用时，操作系统会为该程序分配一块内存，用来存储该程序的<code>代码</code>，<code>数据</code>和<code>一个主线程</code>的环境。可以理解为工作的环境，<code>工厂</code></p>
</blockquote>
<h4 data-id="heading-3">线程</h4>
<blockquote>
<p>只能存在于进程中，不能单独存活。可以理解为<code>工厂流水线</code></p>
</blockquote>
<pre><code class="copyable">1. 多进程：多条流水线，分配任务。
2. 单进程：单条流水线，阻塞任务。
<span class="copy-code-btn">复制代码</span></code></pre>
<h4 data-id="heading-4">进程和线程关系</h4>
<pre><code class="copyable">1. 进程中任意一个线程运行出错，整个进程崩溃。(任意一条流水线出错，最后组装不了成品)
2. 线程之间共享进程的数据(每条流水线都可以使用工厂的资源)
3. 进程关闭后，操作系统会回收内存，即使由于线程操作不当泄露出去的内存也会被回收。(工厂倒闭了，流水线泄露出去的带logo的样品也就不能再用了)
4. 进程之间相互隔离，使用IPC可以进行通信，(工厂与工厂之间不会传递自己的商业机密，除非有商业合作)
<span class="copy-code-btn">复制代码</span></code></pre>
<h3 data-id="heading-5">单进程浏览器</h3>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f6dcc93e99834908971bc0c822c4e716~tplv-k3u1fbpfcp-watermark.image" alt="image.png" loading="lazy" referrerpolicy="no-referrer"></p>
<ol>
<li>一个线程挂了，整个浏览器就崩溃了</li>
<li>在<code>页面线程</code>中，JS的执行，页面渲染，都在一起，若JS运行一个无限循环的代码，导致线程阻塞，从而使整个浏览器未响应</li>
<li>不安全，因为多线程可以公用进程数据，一些第三方插件就可以获取到代码数据</li>
<li>页面多开，后续只关闭个别页面，其数据仍存在内存中，导致内存越来越大</li>
</ol>
<h3 data-id="heading-6">多进程浏览器</h3>
<blockquote>
<p>1个Browser Process（主进程），多个Render Process（渲染进程），多个Plugin Process(插件进程)，1个GPU Process（GPU进程），1个Network Process（网络进程）</p>
</blockquote>
<ol>
<li>多开一个页面，即增加一个渲染进程</li>
<li>进程之间互不影响</li>
<li>架构复杂，内存空间分配多。</li>
</ol>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1490f5632f944aa0bbb4fe549c5fb832~tplv-k3u1fbpfcp-watermark.image" alt="image.png" loading="lazy" referrerpolicy="no-referrer"></p>
<p><code>回答：打开一个chrome页面，会启用主进程，渲染进程，网络进程，GPU进程，如果装了插件，还会打开插件进程</code></p>
<h2 data-id="heading-7">04 | 导航流程：从输入URL到页面展示，这中间发生了什么？</h2>
<blockquote>
<p>从浏览器多进程之间的配合解释</p>
</blockquote>
<ol>
<li>用户输入URL，在<code>浏览器主进程</code>中判断是关键词还是地址，拼接成一个最终要前往的URL</li>
<li><code>浏览器主进程</code>通过IPC通信，讲URL传给<code>网络进程</code>, 网络进程开始工作:
<ul>
<li>请求本地缓存资源，如果有直接返回该资源，如果没有，进行网络请求流程</li>
<li>DNS解析
<ul>
<li>
<ol>
<li>本地host文件，查找是否配置了域名对应的ip</li>
</ol>
</li>
<li>
<ol start="2">
<li>DNS缓存</li>
</ol>
</li>
<li>
<ol start="3">
<li>DNS具体的解析规则（暂时没了解）, 获取到ip</li>
</ol>
</li>
</ul>
</li>
<li>建立TCP连接</li>
<li>发送HTTP请求
<ul>
<li>
<ol>
<li>首次请求，服务器直接返回资源， code：200</li>
</ol>
</li>
<li>
<ol start="2">
<li>根据服务器返回的缓存规则，浏览器缓存资源</li>
</ol>
</li>
<li>
<ol start="3">
<li>再次请求</li>
</ol>
<ul>
<li>
<ol>
<li>先走强缓存(Cache-Control), 若命中，不向服务器请求，直接从缓存中获取资源, code: 200</li>
</ol>
</li>
<li>
<ol start="2">
<li>没有命中强缓存，则查看协商缓存(ETag/If-None-Match, Last-modefied/If-modefied-since),若命中，服务器返回缓存资源，code: 304</li>
</ol>
</li>
<li>
<ol start="3">
<li>都没命中，则服务器重新返回资源, code: 200</li>
</ol>
</li>
</ul>
</li>
<li>
<ol start="4">
<li>重定向，返回的code为301或者302时，网络进程会重新向Location字段的url发起相同的请求</li>
</ol>
</li>
</ul>
</li>
<li>获取到资源后，讲资源通过IPC通信，传递给<code>渲染进程</code>, 具体流程见下章!</li>
</ul>
</li>
</ol>
<h2 data-id="heading-8">05 | 渲染流程：HTML、CSS和JavaScript，是如何变成页面的？</h2>
<blockquote>
<p>按照渲染的时间顺序，可分为如下几个子阶段：构建DOM树 -> 样式计算 -> 布局阶段 -> 分层 -> 绘制 -> 分块 -> 光栅化 -> 合成</p>
</blockquote>
<p>每个阶段主要关注三个内容：</p>
<ol>
<li>输入</li>
<li>过程</li>
<li>输出</li>
</ol>
<h3 data-id="heading-9">构建DOM树</h3>
<ol>
<li>输入： HTML文件</li>
<li>过程： 由HTML解析器解析</li>
<li>输出： 树状结构的DOM</li>
</ol>
<h3 data-id="heading-10">样式计算</h3>
<ol>
<li>输入：css文件， 从style，link，内嵌获取</li>
<li>过程：
<ul>
<li>
<ol>
<li>转换成浏览器能够识别的 styleSheets格式, 可通过document.styleSheets获取。</li>
</ol>
</li>
<li>
<ol start="2">
<li>转换属性值，blue -> rgb(0,0,255), bold -> 700 ... （可作为css优化的的一个知识点）</li>
</ol>
</li>
<li>
<ol start="3">
<li>属性的继承以及默认的user agent</li>
</ol>
</li>
</ul>
</li>
<li>输出：每个DOM的样式，可在<code>ComputedStyle</code>中查看</li>
</ol>
<h3 data-id="heading-11">布局阶段</h3>
<ol>
<li>输入： DOM树</li>
<li>过程：
<ul>
<li>
<ol>
<li>遍历所有可见的DOM节点， 忽略head，display:none等节点</li>
</ol>
</li>
<li>
<ol start="2">
<li>计算每个DOM的位置</li>
</ol>
</li>
</ul>
</li>
</ol>
<p><a href="https://link.juejin.cn/?target=https%3A%2F%2Ftime.geekbang.org%2Fcolumn%2Farticle%2F113513" target="_blank" rel="nofollow noopener noreferrer" title="https://time.geekbang.org/column/article/113513" ref="nofollow noopener noreferrer">极客时间：《浏览器工作原理与实践》</a></p></div>  
</div>
            