
---
title: '记一次图片中繁体文字转简体的尝试'
categories: 
 - 编程
 - 掘金
 - 分类
headimg: 'https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c51a9888692745a089c3d0813203d5bc~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp?'
author: 掘金
comments: false
date: Fri, 16 Sep 2022 01:51:43 GMT
thumbnail: 'https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c51a9888692745a089c3d0813203d5bc~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp?'
---

<div>   
<div class="markdown-body cache"><style>.markdown-body&#123;word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#333&#125;.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6&#123;line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px&#125;.markdown-body h1&#123;font-size:24px;margin-bottom:5px&#125;.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6&#123;font-size:20px&#125;.markdown-body h2&#123;padding-bottom:12px;border-bottom:1px solid #ececec&#125;.markdown-body h3&#123;font-size:18px;padding-bottom:0&#125;.markdown-body h6&#123;margin-top:5px&#125;.markdown-body p&#123;line-height:inherit;margin-top:22px;margin-bottom:22px&#125;.markdown-body img&#123;max-width:100%&#125;.markdown-body hr&#123;border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px&#125;.markdown-body code&#123;word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em&#125;.markdown-body code,.markdown-body pre&#123;font-family:Menlo,Monaco,Consolas,Courier New,monospace&#125;.markdown-body pre&#123;overflow:auto;position:relative;line-height:1.75&#125;.markdown-body pre>code&#123;font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8&#125;.markdown-body a&#123;text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff&#125;.markdown-body a:active,.markdown-body a:hover&#123;color:#275b8c&#125;.markdown-body table&#123;display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6&#125;.markdown-body thead&#123;background:#f6f6f6;color:#000;text-align:left&#125;.markdown-body tr:nth-child(2n)&#123;background-color:#fcfcfc&#125;.markdown-body td,.markdown-body th&#123;padding:12px 7px;line-height:24px&#125;.markdown-body td&#123;min-width:120px&#125;.markdown-body blockquote&#123;color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8&#125;.markdown-body blockquote:after&#123;display:block;content:""&#125;.markdown-body blockquote>p&#123;margin:10px 0&#125;.markdown-body ol,.markdown-body ul&#123;padding-left:28px&#125;.markdown-body ol li,.markdown-body ul li&#123;margin-bottom:0;list-style:inherit&#125;.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item&#123;list-style:none&#125;.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul&#123;margin-top:0&#125;.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul&#123;margin-top:3px&#125;.markdown-body ol li&#123;padding-left:6px&#125;.markdown-body .contains-task-list&#123;padding-left:0&#125;.markdown-body .task-list-item&#123;list-style:none&#125;@media (max-width:720px)&#123;.markdown-body h1&#123;font-size:24px&#125;.markdown-body h2&#123;font-size:20px&#125;.markdown-body h3&#123;font-size:18px&#125;&#125;</style><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c51a9888692745a089c3d0813203d5bc~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp?" alt="2.jpeg" loading="lazy" referrerpolicy="no-referrer"></p>
<h1 data-id="heading-0">背景</h1>
<blockquote>
<p>一个朋友有一批从他人ppt截取的图片(如上图)，其中的文字均是繁体字，看起来不太顺序，想转换成简体字，然后我就多了这么一个需求</p>
<p>第一反应当然是网上搜索类似的解决方案，找了一圈没有找到完全符合要求，无奈只能自己动手了</p>
</blockquote>
<h1 data-id="heading-1">说干就干</h1>
<p>参照之前搜集的资料，大致有些思路，但也有一些比较难搞的点，没有现成的方案可以借鉴，初步构思如下：</p>
<pre><code class="hljs language-markdown copyable" lang="markdown">实现步骤：
<span class="hljs-bullet">1.</span> 进行文字识别，获取图片内的文字及其对应坐标
<span class="hljs-bullet">2.</span> 逐个判断文字是否是繁体，如果是，则加入待替换列表
<span class="hljs-bullet">3.</span> 识别文字颜色、大小、以及背景颜色
<span class="hljs-bullet">4.</span> 根据坐标区域和背景颜色，覆盖原有文字区域，即先删除繁体字
<span class="hljs-bullet">5.</span> 将繁体转换为简体，根据坐标区域、字体大小和颜色，将简体字绘制在图片上
<span class="copy-code-btn">复制代码</span></code></pre>
<h2 data-id="heading-2">1、OCR识别</h2>
<p>这一步最简单，各大云服务厂商都有相应的OCR服务，包括有道云、腾讯云和华为云等，这几家的准确度都差不多，都能识别出图片内的繁体字并返回段落坐标，而有道云有提供单个字的坐标，所以最终选择了有道云。</p>
<h2 data-id="heading-3">2、繁体字转换</h2>
<p>直接使用现成的库(zhconv)，简单了事</p>
<h2 data-id="heading-4">3、识别字体大小和颜色、以及背景色</h2>
<p>A) 字体大小比较好办，根据字体区域的宽度和字符的个数，即可估算出字体大小</p>
<pre><code class="hljs language-python copyable" lang="python">font_size = width/<span class="hljs-built_in">len</span>(text)
<span class="copy-code-btn">复制代码</span></code></pre>
<p>B) 字体颜色和背景色计算是最难的环节，本来是想通过颜色值的比例计算出背景色和字体颜色(比例最高的为背景色、其次为字体颜色)。理想很丰满，但现实很骨感，字体所处区分的背景和文字本身肉眼看上去是纯色，但实际上并不是，读取到的RBG有些许的差异，特别是文字的描边，RGB值还相差很多，即使通过相近颜色合并，得到的结果值仍然很多，无法找到一个简单的规则确定使用哪个色值。
经过多次改进仍然无法精确判断，最后只能无奈放弃，采用简单暴力的方式实现该步骤：字体色采用固定值，背景色取色值出现比例最高的一个；如果背景色和字体颜色相同，则将字体颜色做一次转换。</p>
<pre><code class="hljs language-python copyable" lang="python"><span class="hljs-number">1.</span> 读取图片所有像素点色值，并进行相近颜色合并，得到色值及被使用次数
colors = &#123;<span class="hljs-string">'FFFFFF'</span>: <span class="hljs-number">10000</span>, <span class="hljs-string">'FE00F8'</span>: <span class="hljs-number">8456</span>, <span class="hljs-string">'000000'</span>: <span class="hljs-number">88</span>, ....&#125;
<span class="hljs-number">2.</span> 计算字体颜色和背景色
font_color = (<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>)
bg_color = <span class="hljs-string">'FFFFFF'</span> <span class="hljs-comment">#出现次数最多的色值</span>
<span class="hljs-keyword">if</span> font_color == bg_color:
    font_color = (<span class="hljs-number">255</span> - bg_color[<span class="hljs-number">0</span>], <span class="hljs-number">255</span> - bg_color[<span class="hljs-number">1</span>], <span class="hljs-number">255</span> - bg_color[<span class="hljs-number">2</span>])
<span class="copy-code-btn">复制代码</span></code></pre>
<h2 data-id="heading-5">4、清除繁体字</h2>
<p>这一步比较暴力，直接使用上一步计算的背景色进行覆盖，因为原图片背景色可能会有多种颜色，该方式会导致文字区域的背景色失真。好在实际文字背景彩色的部分较少，出错的部分占比不高，最终的结果也在接受范围之内。</p>
<h2 data-id="heading-6">5、绘制简体字</h2>
<p>剩下的事情就没有什么难度了，找一个好看的免费字体，根据前面获取的字体大小和颜色，按坐标绘制文字即可，这里直接用的第三方库(PIL)</p>
<h1 data-id="heading-7">效果对比</h1>
<p>原始图片</p>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b6b6553d8eb84c6db7686e874a66d245~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp?" alt="4.jpeg" loading="lazy" referrerpolicy="no-referrer">
转换后</p>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/79d6bb225fee40b6b4fb972737f742d7~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp?" alt="4.jpeg" loading="lazy" referrerpolicy="no-referrer"></p>
<h1 data-id="heading-8">总结</h1>
<p>图片处理之前接触的比较少，这次通过借鉴他人的文章、以及查看第三方库的文档，对图片的操作有了更深的理解。虽然转换后的图片有些失真和位置错误，大体上还是能满足要求的。这是前期设想的方案没有完全实现，实在是有些可惜，如果后续时间允许的话，再继续研究。</p>
<p>完整代码如下，欢迎大家帮忙指正~~~</p>
<p><a href="https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Fxiaohuege%2Freplace_image_text" target="_blank" rel="nofollow noopener noreferrer" title="https://github.com/xiaohuege/replace_image_text" ref="nofollow noopener noreferrer">github.com/xiaohuege/r…</a></p></div>  
</div>
            