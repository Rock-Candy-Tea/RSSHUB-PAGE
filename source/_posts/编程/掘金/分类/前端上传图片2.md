
---
title: '前端上传图片2'
categories: 
 - 编程
 - 掘金
 - 分类
headimg: '__STATIC__images/camera.png'
author: 掘金
comments: false
date: Thu, 03 Jun 2021 19:53:39 GMT
thumbnail: '__STATIC__images/camera.png'
---

<div>   
<div class="markdown-body"><style>.markdown-body&#123;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333&#125;.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6&#123;line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px&#125;.markdown-body h1&#123;font-size:30px;margin-bottom:5px&#125;.markdown-body h2&#123;padding-bottom:12px;font-size:24px;border-bottom:1px solid #ececec&#125;.markdown-body h3&#123;font-size:18px;padding-bottom:0&#125;.markdown-body h4&#123;font-size:16px&#125;.markdown-body h5&#123;font-size:15px&#125;.markdown-body h6&#123;margin-top:5px&#125;.markdown-body p&#123;line-height:inherit;margin-top:22px;margin-bottom:22px&#125;.markdown-body img&#123;max-width:100%&#125;.markdown-body hr&#123;border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px&#125;.markdown-body code&#123;word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em&#125;.markdown-body code,.markdown-body pre&#123;font-family:Menlo,Monaco,Consolas,Courier New,monospace&#125;.markdown-body pre&#123;overflow:auto;position:relative;line-height:1.75&#125;.markdown-body pre>code&#123;font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8&#125;.markdown-body a&#123;text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff&#125;.markdown-body a:active,.markdown-body a:hover&#123;color:#275b8c&#125;.markdown-body table&#123;display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6&#125;.markdown-body thead&#123;background:#f6f6f6;color:#000;text-align:left&#125;.markdown-body tr:nth-child(2n)&#123;background-color:#fcfcfc&#125;.markdown-body td,.markdown-body th&#123;padding:12px 7px;line-height:24px&#125;.markdown-body td&#123;min-width:120px&#125;.markdown-body blockquote&#123;color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8&#125;.markdown-body blockquote:after&#123;display:block;content:""&#125;.markdown-body blockquote>p&#123;margin:10px 0&#125;.markdown-body ol,.markdown-body ul&#123;padding-left:28px&#125;.markdown-body ol li,.markdown-body ul li&#123;margin-bottom:0;list-style:inherit&#125;.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item&#123;list-style:none&#125;.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul&#123;margin-top:0&#125;.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul&#123;margin-top:3px&#125;.markdown-body ol li&#123;padding-left:6px&#125;.markdown-body .contains-task-list&#123;padding-left:0&#125;.markdown-body .task-list-item&#123;list-style:none&#125;@media (max-width:720px)&#123;.markdown-body h1&#123;font-size:24px&#125;.markdown-body h2&#123;font-size:20px&#125;.markdown-body h3&#123;font-size:18px&#125;&#125;</style><p>1，前端完整代码</p>
<pre><code class="copyable"><link rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/3.3.7/css/bootstrap.min.css">
<script src="https://cdn.staticfile.org/jquery/2.1.1/jquery.min.js"></script>
<script src="https://cdn.staticfile.org/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script>
<style type="text/css">
  #new .txt&#123;display: block;border-radius: 5px;  width: 80%; height: 80px; line-height: 80px; margin: 20px; text-indent: 20px; border: 1px solid #cccccc;position: center;&#125;
  #new .txt2&#123; block;border-radius: 5px;  width:50%; height: 80px; line-height: 80px; margin: 20px; text-indent: 20px; border: 1px solid #cccccc;position: center;&#125;
  input,select,textarea&#123;font-size: 30px;&#125;
  @-webkit-keyframes spin &#123;
      to &#123;
          -webkit-transform: rotate(360deg);
          transform: rotate(360deg);
      &#125;
  &#125;

  @keyframes spin &#123;
      to &#123;
          -webkit-transform: rotate(360deg);
          transform: rotate(360deg);
      &#125;
  &#125;
  .div-waiting&#123;
      position: fixed;
      z-index: 998;
      top: 0;
      right: 0;
      bottom: 0;
      left: 0;
      opacity: 1;
      background: rgba(0,0,0,0.2);
      vertical-align: middle;
      text-align: center;
  &#125;
  .icon-waiting&#123;
      position: relative;
      top: 48%;
      width: 10rem;
      height: 10rem;
      margin: 0 auto;
      border-radius: 50%;
      border: 1rem solid rgba(21, 21, 21, 0.4);
      border-top-color: #e1e1e1;
      -webkit-animation: 1.5s spin infinite linear;
      animation: 1.5s spin infinite linear;
  &#125;
</style>
<section id="container" class="msgdetail">
 <ul id="myTab" class="nav nav-tabs"  style="font-size: 2rem;">
        <li><a href="#list" data-toggle="tab"><h2>&nbsp;&nbsp;&nbsp;申请列表&nbsp;&nbsp;&nbsp;</h2></a></li>
        <li><a href="#new" data-toggle="tab"><h2>&nbsp;&nbsp;&nbsp;新增xxx&nbsp;&nbsp;&nbsp;</h2></a></li>
        
    </ul>
    <div id="myTabContent" class="tab-content">
        
        <div class="tab-pane fade" id="list">
           
    
        </div>
           
           
        </div>
        <div class="tab-pane fade" id="new">
         <!--    <form action="" method="post" style="font-size: 2rem;"> -->
                <input type="hidden" name="user_id" id="salement" value="&#123;$personId&#125;">
                <div class="pay-rece-div">
                    <span>房源信息(搜索)</span>
                    <span>>></span>
                    <input type="text" name="house_name" id="house_name" data-toggle="modal" data-target="#myModal"  onclick="clearHouse()" readonly="readonly" placeholder="点击搜索公司在管房源,关联房源" class="txt">
                    <input type="hidden"name="house_id" id="house_id">
                </div> 
                 <div class="pay-rece-div">
                    <span>收款人</span>
                    <span>>></span>
                    <input type="text"  id="payee_name" class="txt">
                </div>
                 <div class="pay-rece-div">
                    <span>联系方式</span>
                    <span>>></span>
                    <input type="text"  id="payee_mobile" class="txt">
                </div>
                <div class="pay-rece-div">
                    <span>收款方式</span>
                    <span>>></span>
                    <select  class="txt" id="payment">
                      <option value="1">现金</option>
                      <option value="2">银行</option>
                      <option value="3">微信</option>
                      <option value="4">支付宝</option>
                    </select>
                </div>
                <div class="pay-rece-div">
                    <span>备注</span>
                    <span>>></span><br>
                    <textarea name="remark" id="remark" style="width: 90%;height: 240px;border: 1px solid #cccccc;font-size: 30px;"></textarea>
                </div>
                <div class="pay-rece-div">
                  <span>图片附件:</span>
                  <div class="addForm" id="pictureForm">
                    <table>
                      <tbody>
                      <tr class="photosDetail">
                        <td class="photos pic1" >
                          <img class="photo photo1" style="width: 80px;height: 80px;" src="__STATIC__images/camera.png" >
                        </td>
                      </tr>
                      </tbody>
                    </table>
                    <button class="btn2 btn-pay"  style="margin-top: 80px;" onclick="picture()">确认提交</button>
                </div>
              </div>
               <!--  <input type="submit" id="subbut" class="btn2" style="width: 20rem" value="确认提交">-->
                <div style="height: 3rem;"></div>
            <!-- </form> -->
        </div>
    </div>


</section>
<!-- 模态框（Modal）搜索房源 -->
<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="font-size: 2.7rem">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                <p class="modal-title" id="myModalLabel">房源搜索</p>
            </div>
            <div class="modal-body">
                <input type="text" name="keywords" id="keyword" style="padding:  1rem;width: 45rem;"><button type="text" onclick="searchHouse()">搜索</button>
                <button type="button" data-dismiss="modal">关闭</button>
                <div id="houseList">
                </div>
            </div>
            <div class="modal-footer">
                <!-- <button type="button" class="btn-default" data-dismiss="modal">关闭</button>
                <button type="button" class="btn-primary">提交更改</button> -->
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<!-- 模态框（Modal）借款详情 -->
<div class="modal fade" id="loanModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="font-size: 2.7rem">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-body">
                <h2 style="color: #00BFFF;">借款详情</h2>
                <br/>
                <div id="loanList">
                </div>
               
            </div>
            <div class="modal-footer">
                 <button type="button" class="btn-default" data-dismiss="modal">关闭</button>
                <!--<button type="button" class="btn-primary">提交更改</button> -->
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div>
<!-- /.modal -->
<script>
  function changetype()&#123;
    var type = $('#type').val();
    if(type == 1)&#123;
        $('#loan').attr("style",'display: block;');
        $('#loan').attr("style",'color: red;');
        $("#is_loan option[value='0']").attr("selected", true);
    &#125;
    if (type ==2 || type == 0) &#123;
      $('#loan').attr("style",'display: none;');
      $('#loanid').attr("style",'display: none;');
    &#125;
  &#125;

  function changeloan()&#123;
    var loan = $('#is_loan').val();
    if(loan == 1)&#123;
        $('#loanid').attr("style",'display: block;');
        $('#loanid').attr("style",'color: red;');
    &#125;
    if (loan == 3 || loan == 0) &#123;
      $('#loanid').attr("style",'display: none;');
    &#125;

  &#125;

  function changetcontractype()&#123;
    $("#contract_code").empty();
     $.ajax(&#123;
            type: "POST",
            url: "/weixin/staff/getContract",
            data: &#123;
              house_id:$('#house_id').val(),
              contract_type:$('#contract_type').val(),
            &#125;,
            success: function(rzt) &#123;
              if (rzt.err) &#123;
                alert(rzt.msg);
              &#125;else&#123;
                var codeList = rzt.data;
                console.log(rzt);
                for (var i = 0 ; i < codeList.length ; i++)&#123;
                  $("#contract_code").append("<option value='"+codeList[i].id+"'>"+codeList[i].code+"</option>");
                &#125;
              &#125;
            &#125;
        &#125;);
  &#125;


 $(function()&#123;
    $('#myTab li:eq(1) a').tab('show');
    for(var i = 1; i <= 8; i++) &#123;
      $(".addForm .photosDetail .photo").before('<input id="fileBtn_add' + i + '" type="file" onchange="upload(this,1,'+i+');" name="pictureName'+ i +'" accept="image/*" multiple class="fileBtn_add' + i + '" />');
    &#125;
   /* $(".addForm .photoThumbnail .photo").before('<input id="fileBtn_add5" type="file" onchange="upload(this,2,5);" name="pictureName5" accept="image/*" multiple class="fileBtn_add5" />');
    $(".addForm .photoBanner .photo").before('<input id="fileBtn_add6" type="file" onchange="upload(this,3,6);" name="pictureName6" accept="image/*" multiple  class="fileBtn_add6" />');*/
  
   /* $("#img img").οnclick=function()&#123;
      nowurl=this.src;
      console.log(nowurl);
      console.log(nowurl);
      wx.previewImage(&#123;
          current: nowurl,
          urls: nowurl
      &#125;);       
    &#125;*/


 &#125;);

  var aCount = 0;
  var bCount = 0;
  var cCount = 0;
  var image = new Array();
  
  //添加图片
  function upload(c,index,index2) &#123;
    "use strict";
    var $c = c;
    //console.log($c);
      var $d = document.createElement('img');
      var file = $c.files[0];
      //console.log(file);
      var reader = new FileReader();
      reader.readAsDataURL(file);
      reader.onload = function(e) &#123;
      var w = index2 -1;
      //20210413  压缩图片调用方法
      dealImage(e.target.result,&#123;width:800&#125;,function(base)&#123;
     　　　　//document.getElementById('img').setAttribute('src',base);
          image[w] = base;
      &#125;);
      //20210413
      //image[w] = e.target.result;//20210413
      console.log(image);
      $d.setAttribute("src", e.target.result);
      $($d).addClass($($c).attr('class'));
      //console.log($(".addForm .photos input").index(this) + 1);
      var div = document.createElement('div');
      div.className = 'tuPic';
      $(div).append($d);
      //var url = "__STATIC__images/del.png";
      //$(div).append("<span class='delClose' onclick='delPic(this,"+index2+")'><img src="+url+" width=100%></span>");
      $(div).append("<span class='delClose' onclick='delPic(this,"+index2+")'>x</span>");
      /*if (index==1)&#123;
        aCount++;
        if (aCount==4)&#123;
          $(".photo1").hide();
        &#125;
      &#125;else if(index==2)&#123;
        bCount++;
        $(".photo2").hide();
      &#125;else &#123;
        cCount++;
        $(".photo3").hide();
      &#125;*/
      $(".addForm .pic"+index).append(div);
      $("#fileBtn_add"+index2).hide();
    &#125;
  &#125;

  // 删除对应input框的缩略图和文件
  function delPic(e,index2) &#123;
    var y = index2 - 1;
    delete image[y];
    resetFileInput($("#fileBtn_add"+index2));
    /*switch (index2) &#123;
      case 1:
      case 2:
      case 3:
      case 4:
        aCount--;
        if (aCount==3)&#123;
          $(".photo1").show();
        &#125;
        break;
      case 5:
        bCount--;
        $(".photo2").show();
        break;
      case 6:
        $(".photo3").show();
        cCount--;
    &#125;*/
    $(e).parent().remove();
    $('#fileBtn_add'+index2).show();
  &#125;
  //清除input框内的文件内容
  function resetFileInput(file)&#123;
    file.after(file.clone().val(""));
    file.remove();
  &#125;
  //点击提交上传图片
  function picture()&#123;  
    $.ajax(&#123;
            type: "POST",
            url: "/weixin/staff/submitCommission",
            data: &#123;
              house_id:$('#house_id').val(),
              payment:$('#payment').val(),
              payee_name:$('#payee_name').val(),
              payee_mobile:$('#payee_mobile').val(),
              bank:$('#bank').val(),
              bank_account_name:$('#bank_account_name').val(),
              bank_account:$('#bank_account').val(),
              img:image,
              salement_id:$('#salement').val(),
            &#125;,
            beforeSend:function()&#123;
              showWaiting();
            &#125;,
            success: function(rzt) &#123;
              console.log(rzt);
                if (rzt.err) &#123;
                  closeWaiting();
                  alert(rzt.err);
                 &#125;else&#123;
                  closeWaiting();
                  alert('提交成功');
                  $(".btn2").attr("disabled",'none');
                  window.location.reload();
                 &#125;
            &#125;
        &#125;);
  &#125;

  function clearHouse()&#123;
        document.getElementById('keyword').value="";
        document.getElementById('houseList').innerHTML=" "; 
        /*$('#house_name').attr('value',"");
        $('#house_id').attr('value',"");*/
    &#125;
    function searchHouse()&#123;
        var keyword = document.getElementById('keyword').value;
        $.ajax(&#123;
            type: "POST",
            url: "/weixin/staff/searchHouseList",
            data: &#123;
              keyword: $("#keyword").val(),
            &#125;,
            dataType: "JSON",
            success: function(result) &#123;
                houselist = result.data;
                document.getElementById('houseList').innerHTML=houselist; 
            &#125;
        &#125;);
    &#125;
    function choseHouse(house_id,full_name)&#123;
        $('#house_name').attr('value',full_name);
        $('#house_id').attr('value',house_id);
    &#125;

    function searchLoan()&#123;
      $.ajax(&#123;
            type: "POST",
            url: "/weixin/staff/getLoan",
            data: &#123;
              house_id:$('#house_id').val(),
            &#125;,
            success: function(rzt) &#123;
              if (rzt.err) &#123;
                //$('#loanModal').modal(false);
                alert(rzt.msg);
              &#125;else&#123;
                $('#loanModal').modal(true);
                var loanList = rzt.data;
                console.log(rzt);
                document.getElementById('loanList').innerHTML=loanList; 
                /*for (var i = 0 ; i < codeList.length ; i++)&#123;
                  $("#contract_code").append("<option value='"+codeList[i].id+"'>"+codeList[i].code+"</option>");
                &#125;*/
              &#125;
            &#125;
        &#125;);
    &#125;

    function choseLoan(id,name)&#123;
      $('#loan_id').attr('value',id);
      $('#loaner').attr('value',name);
    &#125;

    function showWaiting()&#123;
        var node=document.createElement("div");  //创建一个div元素节点，作为整个背景的容器
        var nodeClass=document.createAttribute("class"); //创建class元素属性
        var nodeStyle = document.createAttribute("style"); //创建style元素属性
        var nodeName = document.createAttribute("name"); //创建name元素属性
        nodeName.value = "divWaiting"; //给元素节点命名
        nodeClass.value = "div-waiting"; //元素属性赋值
        nodeStyle.value = "height:"+window.innerHeight + "px; width:"+window.innerWidth+"px;";
        node.setAttributeNode(nodeClass); //设置元素节点的属性及值
        node.setAttributeNode(nodeStyle);
        node.setAttributeNode(nodeName);
        var iconNode = document.createElement("div");  //创建一个div元素节点，作为旋转图标的容器
        var iconClass = document.createAttribute("class");
        iconClass.value = "icon-waiting";
        iconNode.setAttributeNode(iconClass);
 
        node.appendChild(iconNode);  //将图标节点放到整个背景的元素节点
        document.body.appendChild(node); //将整个背景div插入到body中
    &#125;
 
    function closeWaiting()&#123;
        var wait = document.getElementsByName("divWaiting"); //获取name为divWaiting的元素节点
        console.log(wait);
        //遍历所有的节点，将body中的所有等待旋转效果去掉
        for(var i=0; i<wait.length; i++)&#123;
            document.body.removeChild(wait[i]);
        &#125;
    &#125;
    //20210413
    /**
     * 图片压缩，默认同比例压缩
     * @param &#123;Object&#125; path
     * pc端传入的路径可以为相对路径，但是在移动端上必须传入的路径是照相图片储存的绝对路径
     * @param &#123;Object&#125; obj
     * obj 对象 有 width， height， quality(0-1)
     * @param &#123;Object&#125; callback
     * 回调函数有一个参数，base64的字符串数据
     */
    function dealImage(path, obj, callback)&#123;
     var img = new Image();
     img.src = path;
     img.onload = function()&#123;
     var that = this;
     // 默认按比例压缩
     var w = that.width,
     h = that.height,
     scale = w / h;
     w = obj.width || w;
     h = obj.height || (w / scale);
     var quality = 1; // 默认图片质量为0.7
     //生成canvas
     var canvas = document.createElement('canvas');
     var ctx = canvas.getContext('2d');
     // 创建属性节点
     var anw = document.createAttribute("width");
     anw.nodeValue = w;
     var anh = document.createAttribute("height");
     anh.nodeValue = h;
     canvas.setAttributeNode(anw);
     canvas.setAttributeNode(anh);
     ctx.drawImage(that, 0, 0, w, h);
     // 图像质量
     if(obj.quality && obj.quality <= 1 && obj.quality > 0)&#123;
     quality = obj.quality;
     &#125;
     // quality值越小，所绘制出的图像越模糊
     var base64 = canvas.toDataURL('image/jpeg', quality );
     // 回调函数返回base64的值
     callback(base64);
     &#125;
    &#125;
</script>
<span class="copy-code-btn">复制代码</span></code></pre>
<p>2，后端PHP上传代码</p>
<pre><code class="copyable">   public function imageBase64Upload($base64_img,$fun = '')&#123;
        header("content-type:text/html;charset=utf-8");
        //$base64_img = trim($_POST['img']);
        //var_dump($base64_img);
        $path_name = 'uploads'. DS . date('Ymd') . DS . $fun . DS;
        $file_name = date('YmdHis_').rand(1,1000).'_'.$fun.'.';

        $up_dir = ROOT_PATH .'public' . DS . $path_name;
        $res = true;
        //$up_dir = './upload/';//存放在当前目录的upload文件夹下
        if(!file_exists($up_dir))&#123;
            $res = mkdir($up_dir,0777,true);
        &#125;
        if(!$res)&#123;
            $this->_error(1,'文件上传失败，原因：没有权限创建目录');
        &#125;
        if(preg_match('/^(data:\s*image\/(\w+);base64,)/', $base64_img, $result))&#123;
            $type = $result[2];
            if(in_array($type,array('pjpeg','jpeg','jpg','gif','bmp','png')))&#123;
                $file_name = $file_name.$type;
                //$new_file = $up_dir.date('YmdHis_').rand(1,100).'_loan.'.$type;
                $new_file = $up_dir.$file_name;
                if(file_put_contents($new_file, base64_decode(str_replace($result[1], '', $base64_img))))&#123;
                    //$img_path = str_replace('../../..', '', $new_file);
                    $img_path = '/'.$path_name.$file_name;
                    return $img_path;
                     //$this->_error(0,'上传成功',$img_path);
                    //echo '图片上传成功</br>![](' .$img_path. ')';
                &#125;else&#123;
                    //echo '图片上传失败</br>';
                    $this->_error(1,'文件上传失败，原因：文件写入失败');
                &#125;
            &#125;else&#123;
                //文件类型错误
                //echo '图片上传类型错误';
                $this->_error(1,'文件上传类型错误');
            &#125;
        &#125;else&#123;
            //文件错误
            //echo '文件错误';
            $this->_error(1,'文件错误');
        &#125;
    &#125;
<span class="copy-code-btn">复制代码</span></code></pre>
<p>3，分拆前端上传代码</p>
<p>1）html部分</p>
<pre><code class="copyable"> <div class="addForm" id="pictureForm">
   <table>
     <tbody>
       <tr class="photosDetail">
         <td class="photos pic1" >
           <img class="photo photo1" style="width: 80px;height: 80px;" src="__STATIC__images/camera.png" >
         </td>
       </tr>
     </tbody>
   </table>
   <button class="btn2 btn-pay"  style="margin-top: 80px;" onclick="picture()">确认提交</button>
</div>
<span class="copy-code-btn">复制代码</span></code></pre>
<p>2）就js部分</p>
<pre><code class="copyable"> $(function()&#123;
    $('#myTab li:eq(1) a').tab('show');
    for(var i = 1; i <= 8; i++) &#123;
      $(".addForm .photosDetail .photo").before('<input id="fileBtn_add' + i + '" type="file" onchange="upload(this,1,'+i+');" name="pictureName'+ i +'" accept="image/*" multiple class="fileBtn_add' + i + '" />');
    &#125;
   /* $(".addForm .photoThumbnail .photo").before('<input id="fileBtn_add5" type="file" onchange="upload(this,2,5);" name="pictureName5" accept="image/*" multiple class="fileBtn_add5" />');
    $(".addForm .photoBanner .photo").before('<input id="fileBtn_add6" type="file" onchange="upload(this,3,6);" name="pictureName6" accept="image/*" multiple  class="fileBtn_add6" />');*/
  
   /* $("#img img").οnclick=function()&#123;
      nowurl=this.src;
      console.log(nowurl);
      console.log(nowurl);
      wx.previewImage(&#123;
          current: nowurl,
          urls: nowurl
      &#125;);       
    &#125;*/
 &#125;);

  var aCount = 0;
  var bCount = 0;
  var cCount = 0;
  var image = new Array();
  
  //添加图片
  function upload(c,index,index2) &#123;
    "use strict";
    var $c = c;
    //console.log($c);
      var $d = document.createElement('img');
      var file = $c.files[0];
      //console.log(file);
      var reader = new FileReader();
      reader.readAsDataURL(file);
      reader.onload = function(e) &#123;
      var w = index2 -1;
      //20210413
      dealImage(e.target.result,&#123;width:800&#125;,function(base)&#123;
     　　　　//document.getElementById('img').setAttribute('src',base);
          image[w] = base;
      &#125;);
      //20210413
      //image[w] = e.target.result;//20210413
      console.log(image);
      $d.setAttribute("src", e.target.result);
      $($d).addClass($($c).attr('class'));
      //console.log($(".addForm .photos input").index(this) + 1);
      var div = document.createElement('div');
      div.className = 'tuPic';
      $(div).append($d);
      //var url = "__STATIC__images/del.png";
      //$(div).append("<span class='delClose' onclick='delPic(this,"+index2+")'><img src="+url+" width=100%></span>");
      $(div).append("<span class='delClose' onclick='delPic(this,"+index2+")'>x</span>");
      /*if (index==1)&#123;
        aCount++;
        if (aCount==4)&#123;
          $(".photo1").hide();
        &#125;
      &#125;else if(index==2)&#123;
        bCount++;
        $(".photo2").hide();
      &#125;else &#123;
        cCount++;
        $(".photo3").hide();
      &#125;*/
      $(".addForm .pic"+index).append(div);
      $("#fileBtn_add"+index2).hide();
    &#125;
  &#125;

  // 删除对应input框的缩略图和文件
  function delPic(e,index2) &#123;
    var y = index2 - 1;
    delete image[y];
    resetFileInput($("#fileBtn_add"+index2));
    /*switch (index2) &#123;
      case 1:
      case 2:
      case 3:
      case 4:
        aCount--;
        if (aCount==3)&#123;
          $(".photo1").show();
        &#125;
        break;
      case 5:
        bCount--;
        $(".photo2").show();
        break;
      case 6:
        $(".photo3").show();
        cCount--;
    &#125;*/
    $(e).parent().remove();
    $('#fileBtn_add'+index2).show();
  &#125;
  //清除input框内的文件内容
  function resetFileInput(file)&#123;
    file.after(file.clone().val(""));
    file.remove();
  &#125;
<span class="copy-code-btn">复制代码</span></code></pre>
<p>3，css部分</p>
<pre><code class="copyable">   .photos input[type='file'] &#123;
      opacity: 0;
      position: absolute;
      left: 0;
      top: 0;
    &#125;
    .photos img, .photos input[type='file'] &#123;
      width: 150px;
      height: 150px;
      margin-right: 30px;
      margin-top: 10px;
      transition: all .4s;
    &#125;
    td&#123;
      position: relative;
      height: 150px;
      left: 20px;
      top:20px;
      width: 550px
    &#125;
    .photos div &#123;
      display: inline-block;
      width: 150px;
      height: 150px;
      margin-right: 30px;
      position: relative;
    &#125;
    .delClose&#123;
      height: 35px;
      width: 35px;
      background-color:#757B81;
      border-radius:50%;
      position: absolute;
      right: 0;
      top: 0px;
      line-height: 35px;
      color:white;
      text-align: center;
    &#125;
<span class="copy-code-btn">复制代码</span></code></pre>
<p>4，js提交后端请求转圈等待代码</p>
<pre><code class="copyable">js部分：
function showWaiting()&#123;
        var node=document.createElement("div");  //创建一个div元素节点，作为整个背景的容器
        var nodeClass=document.createAttribute("class"); //创建class元素属性
        var nodeStyle = document.createAttribute("style"); //创建style元素属性
        var nodeName = document.createAttribute("name"); //创建name元素属性
        nodeName.value = "divWaiting"; //给元素节点命名
        nodeClass.value = "div-waiting"; //元素属性赋值
        nodeStyle.value = "height:"+window.innerHeight + "px; width:"+window.innerWidth+"px;";
        node.setAttributeNode(nodeClass); //设置元素节点的属性及值
        node.setAttributeNode(nodeStyle);
        node.setAttributeNode(nodeName);
        var iconNode = document.createElement("div");  //创建一个div元素节点，作为旋转图标的容器
        var iconClass = document.createAttribute("class");
        iconClass.value = "icon-waiting";
        iconNode.setAttributeNode(iconClass);
 
        node.appendChild(iconNode);  //将图标节点放到整个背景的元素节点
        document.body.appendChild(node); //将整个背景div插入到body中
    &#125;
 
    function closeWaiting()&#123;
        var wait = document.getElementsByName("divWaiting"); //获取name为divWaiting的元素节点
        console.log(wait);
        //遍历所有的节点，将body中的所有等待旋转效果去掉
        for(var i=0; i<wait.length; i++)&#123;
            document.body.removeChild(wait[i]);
        &#125;
    &#125;


css部分：
 @-webkit-keyframes spin &#123;
      to &#123;
          -webkit-transform: rotate(360deg);
          transform: rotate(360deg);
      &#125;
  &#125;

  @keyframes spin &#123;
      to &#123;
          -webkit-transform: rotate(360deg);
          transform: rotate(360deg);
      &#125;
  &#125;
  .div-waiting&#123;
      position: fixed;
      z-index: 998;
      top: 0;
      right: 0;
      bottom: 0;
      left: 0;
      opacity: 1;
      background: rgba(0,0,0,0.2);
      vertical-align: middle;
      text-align: center;
  &#125;
  .icon-waiting&#123;
      position: relative;
      top: 48%;
      width: 10rem;
      height: 10rem;
      margin: 0 auto;
      border-radius: 50%;
      border: 1rem solid rgba(21, 21, 21, 0.4);
      border-top-color: #e1e1e1;
      -webkit-animation: 1.5s spin infinite linear;
      animation: 1.5s spin infinite linear;
  &#125;
<span class="copy-code-btn">复制代码</span></code></pre>
<p>5，压缩图片代码：</p>
<pre><code class="copyable">   /**
     * 图片压缩，默认同比例压缩
     * @param &#123;Object&#125; path
     * pc端传入的路径可以为相对路径，但是在移动端上必须传入的路径是照相图片储存的绝对路径
     * @param &#123;Object&#125; obj
     * obj 对象 有 width， height， quality(0-1)
     * @param &#123;Object&#125; callback
     * 回调函数有一个参数，base64的字符串数据
     */
    function dealImage(path, obj, callback)&#123;
     var img = new Image();
     img.src = path;
     img.onload = function()&#123;
     var that = this;
     // 默认按比例压缩
     var w = that.width,
     h = that.height,
     scale = w / h;
     w = obj.width || w;
     h = obj.height || (w / scale);
     var quality = 1; // 默认图片质量为0.7
     //生成canvas
     var canvas = document.createElement('canvas');
     var ctx = canvas.getContext('2d');
     // 创建属性节点
     var anw = document.createAttribute("width");
     anw.nodeValue = w;
     var anh = document.createAttribute("height");
     anh.nodeValue = h;
     canvas.setAttributeNode(anw);
     canvas.setAttributeNode(anh);
     ctx.drawImage(that, 0, 0, w, h);
     // 图像质量
     if(obj.quality && obj.quality <= 1 && obj.quality > 0)&#123;
     quality = obj.quality;
     &#125;
     // quality值越小，所绘制出的图像越模糊
     var base64 = canvas.toDataURL('image/jpeg', quality );
     // 回调函数返回base64的值
     callback(base64);
     &#125;
    &#125;
<span class="copy-code-btn">复制代码</span></code></pre></div>  
</div>
            