
---
title: '【前端】重构，有品位的代码 02 ── 构筑测试体系'
categories: 
 - 编程
 - 掘金
 - 分类
headimg: 'https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d245f1cd4a6e4c299f0f060c261d26e1~tplv-k3u1fbpfcp-zoom-1.image'
author: 掘金
comments: false
date: Sun, 20 Jun 2021 05:57:45 GMT
thumbnail: 'https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d245f1cd4a6e4c299f0f060c261d26e1~tplv-k3u1fbpfcp-zoom-1.image'
---

<div>   
<div class="markdown-body"><style>.markdown-body&#123;color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%&#125;.markdown-body p&#123;color:#595959;font-size:15px;line-height:2;font-weight:400&#125;.markdown-body p+p&#123;margin-top:16px&#125;.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6&#123;padding:30px 0;margin:0;color:#135ce0&#125;.markdown-body h1&#123;position:relative;text-align:center;font-size:22px;margin:50px 0&#125;.markdown-body h1:before&#123;position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)&#125;.markdown-body h2&#123;position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0&#125;.markdown-body h3&#123;font-size:16px&#125;.markdown-body ul&#123;list-style:disc outside;margin-left:2em;margin-top:1em&#125;.markdown-body li&#123;line-height:2;color:#595959&#125;.markdown-body img.loaded&#123;margin:0 auto;display:block&#125;.markdown-body blockquote&#123;background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5&#125;.markdown-body blockquote p&#123;color:#666;line-height:2&#125;.markdown-body a&#123;color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none&#125;.markdown-body em strong,.markdown-body strong&#123;color:#036aca&#125;.markdown-body hr&#123;border-top:1px solid #135ce0&#125;.markdown-body pre&#123;overflow:auto&#125;.markdown-body code,.markdown-body pre&#123;overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace&#125;.markdown-body pre>code&#123;font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8&#125;.markdown-body code&#123;word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em&#125;.markdown-body table&#123;border-collapse:collapse;margin:1rem 0;overflow-x:auto&#125;.markdown-body table td,.markdown-body table th&#123;border:1px solid #dfe2e5;padding:.6em 1em&#125;.markdown-body table tr&#123;border-top:1px solid #dfe2e5&#125;.markdown-body table tr:nth-child(2n)&#123;background-color:#f6f8fa&#125;</style><h2 data-id="heading-0">写在前面</h2>
<p><strong>代码重构</strong>是一个产品不断的功能迭代过程中，不可避免的一项工作。所谓重构，是在不改变程序的输入输出即保证现有功能的情况下，对内部实现进行优化和调整。这是《重构，有品位的代码》系列的第二篇文章，上一篇是<a href="https://juejin.cn/post/6973911724441223198" target="_blank">《重构，有品位的代码 01 ── 走上重构之道》</a></p>
<h2 data-id="heading-1">构建测试体系</h2>
<p><strong>工欲善其事，必先利其器</strong></p>
<p>重构是很有价值很重要的工具，能够让我们增强代码的可读性和鲁棒性。但是光有重构也不行，因为我们在重构过程中会存在难以避免的纰漏，所以构建一套完善稳固的测试体系是很有必要的。</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d245f1cd4a6e4c299f0f060c261d26e1~tplv-k3u1fbpfcp-zoom-1.image" alt loading="lazy" referrerpolicy="no-referrer"></p>
<p><strong>自测代码很重要</strong></p>
<p>在进行项目开发中，进行编写代码的时间花费比较少，但是修改BUG时对其进行查找所花费的时间成本比较高，对于很多人而言是个噩梦。有些程序员在写完一大片代码后再进行测试，这寻找代码潜在的BUG还是比较难，而是要在写好一点功能后就进行测试。其实，想说服大家这样做有点难度，但是在你发现潜在问题时就会事半功倍，不要因为图省事而导致耗费更多时间。</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/18200ddb76b04c318bdb86dcb51a0b90~tplv-k3u1fbpfcp-zoom-1.image" alt loading="lazy" referrerpolicy="no-referrer"></p>
<p>当然，很多程序员可能根本没有学习过软件测试，压根不会编写测试代码，这对于程序员发展而言是很不利的。其实，撰写测试代码最好的时机是在开始动手编码前，在你需要添加新功能前就可以编写对应的测试代码，因为这样能让你把注意力集中在接口而非实现上。预先编写的测试代码能给开发工作设置标志性的结束，即一旦测试代码正常运行，意味着工作也结束了。</p>
<p>测试驱动开发：“测试->编码->重构”，所以测试对于重构而言是非常重要的。</p>
<p><strong>示例</strong></p>
<p>在示例中主要有两个类：工厂类和供应商类。工厂客类的构造函数接收一个JS对象，此时我们可以想象是一个JSON数据提供。</p>
<p>工厂类</p>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// 工厂类</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Factory</span></span>&#123;
  <span class="hljs-function"><span class="hljs-title">constructor</span>(<span class="hljs-params">doc</span>)</span>&#123;
    <span class="hljs-built_in">this</span>._name = doc.name;
    <span class="hljs-built_in">this</span>._producers = [];
    <span class="hljs-built_in">this</span>._totalProduction = <span class="hljs-number">0</span>;
    <span class="hljs-built_in">this</span>._demand = doc.demand;
    <span class="hljs-built_in">this</span>._price = doc.price;
    doc.producers.forEach(<span class="hljs-function"><span class="hljs-params">d</span> =></span> <span class="hljs-built_in">this</span>.addProducer(<span class="hljs-keyword">new</span> Producer(<span class="hljs-built_in">this</span>,d)))
  &#125;

  <span class="hljs-comment">// 添加供应商</span>
  <span class="hljs-function"><span class="hljs-title">addProducer</span>(<span class="hljs-params">arg</span>)</span>&#123;
    <span class="hljs-built_in">this</span>._producers.push(arg);
    <span class="hljs-built_in">this</span>._totalProduction += arg.production;
  &#125;

  <span class="hljs-comment">// 各类数据的取值和设置函数</span>
  <span class="hljs-keyword">get</span> <span class="hljs-title">name</span>()&#123;
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>._name;
  &#125;
  <span class="hljs-keyword">get</span> <span class="hljs-title">producers</span>()&#123;
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>._producers.slice();
  &#125;

  <span class="hljs-keyword">get</span> <span class="hljs-title">totalProduction</span>()&#123;
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>._totalProduction;
  &#125;
  <span class="hljs-keyword">set</span> <span class="hljs-title">totalProduction</span>(<span class="hljs-params">arg</span>)&#123;
    <span class="hljs-built_in">this</span>._totalProduction = arg;
  &#125;
  
  <span class="hljs-keyword">get</span> <span class="hljs-title">demand</span>()&#123;
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>._demand;
  &#125;
  <span class="hljs-keyword">set</span> <span class="hljs-title">demand</span>(<span class="hljs-params">arg</span>)&#123;
    <span class="hljs-built_in">this</span>._demand = <span class="hljs-built_in">parseInt</span>(arg);
  &#125;
  <span class="hljs-keyword">get</span> <span class="hljs-title">price</span>()&#123;
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>._price;
  &#125;
  <span class="hljs-keyword">set</span> <span class="hljs-title">price</span>(<span class="hljs-params">arg</span>)&#123;
    <span class="hljs-built_in">this</span>._price = <span class="hljs-built_in">parseInt</span>(arg);
  &#125;

  <span class="hljs-comment">// 缺额的计算</span>
  <span class="hljs-keyword">get</span> <span class="hljs-title">shortfall</span>()&#123;
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>._demand - <span class="hljs-built_in">this</span>.totalProduction;
  &#125;

  <span class="hljs-comment">// 利润的计算</span>
  <span class="hljs-keyword">get</span> <span class="hljs-title">profit</span>()&#123;
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.demandValue - <span class="hljs-built_in">this</span>.demandCost;
  &#125;
  <span class="hljs-comment">// 设置预计销售额</span>
  <span class="hljs-keyword">get</span> <span class="hljs-title">demandValue</span>()&#123;
    <span class="hljs-keyword">let</span> remainingDemand = <span class="hljs-built_in">this</span>.demand;
    <span class="hljs-keyword">let</span> result = <span class="hljs-number">0</span>;
    <span class="hljs-built_in">this</span>.producers
    .sort(<span class="hljs-function">(<span class="hljs-params">a,b</span>)=></span>a.cost - b.cost)
    .forEach(<span class="hljs-function"><span class="hljs-params">p</span> =></span> &#123;
      <span class="hljs-keyword">const</span> contribution = <span class="hljs-built_in">Math</span>.min(remainingDemand, p.production);
      remainingDemand -= contribution;
      result += contribution * p.cost;
    &#125;);
    <span class="hljs-keyword">return</span> result;
  &#125;
  <span class="hljs-comment">// 设置花费</span>
  <span class="hljs-keyword">get</span> <span class="hljs-title">demandCost</span>()&#123;
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.satisfiedDemand * <span class="hljs-built_in">this</span>.price;
  &#125;
  <span class="hljs-keyword">get</span> <span class="hljs-title">satisfiedDemand</span>()&#123;
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">Math</span>.min(<span class="hljs-built_in">this</span>._demand , <span class="hljs-built_in">this</span>.totalProduction);
  &#125;
&#125;;
<span class="copy-code-btn">复制代码</span></code></pre>
<p>供应商类</p>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// 供应商类--存放数据的容器</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Producer</span></span>&#123;
  <span class="hljs-function"><span class="hljs-title">constructor</span>(<span class="hljs-params">aFactory, data</span>)</span>&#123;
    <span class="hljs-built_in">this</span>._factory = aFactory;
    <span class="hljs-built_in">this</span>._cost = data.cost;
    <span class="hljs-built_in">this</span>._name = data.name;
    <span class="hljs-built_in">this</span>._production = data.production || <span class="hljs-number">0</span>;
  &#125;

  <span class="hljs-comment">// 各种值得取值和设值函数</span>
  <span class="hljs-keyword">get</span> <span class="hljs-title">name</span>()&#123;
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>._name;
  &#125;
  <span class="hljs-keyword">get</span> <span class="hljs-title">cost</span>()&#123;
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>._cost;
  &#125;
  <span class="hljs-keyword">set</span> <span class="hljs-title">cost</span>(<span class="hljs-params">arg</span>)&#123;
    <span class="hljs-built_in">this</span>._cost = <span class="hljs-built_in">parseInt</span>(arg);
  &#125;

  <span class="hljs-keyword">get</span> <span class="hljs-title">production</span>()&#123;
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>._production;
  &#125;
  <span class="hljs-keyword">set</span> <span class="hljs-title">production</span>(<span class="hljs-params">amountStr</span>)&#123;
    <span class="hljs-keyword">const</span> amount = <span class="hljs-built_in">parseInt</span>(amountStr);
    <span class="hljs-keyword">const</span> newProduction = <span class="hljs-built_in">Number</span>.isNaN(amount) ? <span class="hljs-number">0</span> : amount;
    <span class="hljs-built_in">this</span>._factory.totalProduction += newProduction - <span class="hljs-built_in">this</span>._production;
    <span class="hljs-built_in">this</span>._production = newProduction;
  &#125;
&#125;
<span class="copy-code-btn">复制代码</span></code></pre>
<p>在上面的两个类中，我们可以看到更新派生数据的方式有点丑陋，代码繁复，后面我们将会对其进行重构。</p>
<p>创建JSON数据的函数：</p>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">sampleFactoryData</span>(<span class="hljs-params"></span>)</span>&#123;
  <span class="hljs-keyword">return</span> &#123;
    <span class="hljs-attr">name</span>:<span class="hljs-string">"Apple"</span>,
    <span class="hljs-attr">producers</span>:[&#123;
      <span class="hljs-attr">name</span>:<span class="hljs-string">"FOXCOM"</span>,
      <span class="hljs-attr">cost</span>:<span class="hljs-number">10</span>,
      <span class="hljs-attr">production</span>:<span class="hljs-number">9</span>
    &#125;,&#123;
      <span class="hljs-attr">name</span>:<span class="hljs-string">"SAMSUNG"</span>,
      <span class="hljs-attr">cost</span>:<span class="hljs-number">12</span>,
      <span class="hljs-attr">production</span>:<span class="hljs-number">10</span>
    &#125;,&#123;
      <span class="hljs-attr">name</span>:<span class="hljs-string">"BYD"</span>,
      <span class="hljs-attr">cost</span>:<span class="hljs-number">10</span>,
      <span class="hljs-attr">production</span>:<span class="hljs-number">6</span>
    &#125;],
    <span class="hljs-attr">demand</span>:<span class="hljs-number">200</span>,
    <span class="hljs-attr">price</span>:<span class="hljs-number">16000</span>
  &#125;
&#125;;
<span class="copy-code-btn">复制代码</span></code></pre>
<p>整体代码如下：</p>
<p>computer.js</p>
<pre><code class="hljs language-js copyable" lang="js">
<span class="hljs-comment">// 工厂类</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Factory</span></span>&#123;
  <span class="hljs-function"><span class="hljs-title">constructor</span>(<span class="hljs-params">doc</span>)</span>&#123;
    <span class="hljs-built_in">this</span>._name = doc.name;
    <span class="hljs-built_in">this</span>._producers = [];
    <span class="hljs-built_in">this</span>._totalProduction = <span class="hljs-number">0</span>;
    <span class="hljs-built_in">this</span>._demand = doc.demand;
    <span class="hljs-built_in">this</span>._price = doc.price;
    doc.producers.forEach(<span class="hljs-function"><span class="hljs-params">d</span> =></span> <span class="hljs-built_in">this</span>.addProducer(<span class="hljs-keyword">new</span> Producer(<span class="hljs-built_in">this</span>,d)))
  &#125;

  <span class="hljs-comment">// 添加供应商</span>
  <span class="hljs-function"><span class="hljs-title">addProducer</span>(<span class="hljs-params">arg</span>)</span>&#123;
    <span class="hljs-built_in">this</span>._producers.push(arg);
    <span class="hljs-built_in">this</span>._totalProduction += arg.production;
  &#125;

  <span class="hljs-comment">// 各类数据的取值和设置函数</span>
  <span class="hljs-keyword">get</span> <span class="hljs-title">name</span>()&#123;
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>._name;
  &#125;
  <span class="hljs-keyword">get</span> <span class="hljs-title">producers</span>()&#123;
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>._producers.slice();
  &#125;

  <span class="hljs-keyword">get</span> <span class="hljs-title">totalProduction</span>()&#123;
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>._totalProduction;
  &#125;
  <span class="hljs-keyword">set</span> <span class="hljs-title">totalProduction</span>(<span class="hljs-params">arg</span>)&#123;
    <span class="hljs-built_in">this</span>._totalProduction = arg;
  &#125;
  
  <span class="hljs-keyword">get</span> <span class="hljs-title">demand</span>()&#123;
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>._demand;
  &#125;
  <span class="hljs-keyword">set</span> <span class="hljs-title">demand</span>(<span class="hljs-params">arg</span>)&#123;
    <span class="hljs-built_in">this</span>._demand = <span class="hljs-built_in">parseInt</span>(arg);
  &#125;
  <span class="hljs-keyword">get</span> <span class="hljs-title">price</span>()&#123;
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>._price;
  &#125;
  <span class="hljs-keyword">set</span> <span class="hljs-title">price</span>(<span class="hljs-params">arg</span>)&#123;
    <span class="hljs-built_in">this</span>._price = <span class="hljs-built_in">parseInt</span>(arg);
  &#125;

  <span class="hljs-comment">// 缺额的计算</span>
  <span class="hljs-keyword">get</span> <span class="hljs-title">shortfall</span>()&#123;
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>._demand - <span class="hljs-built_in">this</span>.totalProduction;
  &#125;

  <span class="hljs-comment">// 利润的计算</span>
  <span class="hljs-keyword">get</span> <span class="hljs-title">profit</span>()&#123;
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.demandValue - <span class="hljs-built_in">this</span>.demandCost;
  &#125;
  <span class="hljs-comment">// 设置预计销售额</span>
  <span class="hljs-keyword">get</span> <span class="hljs-title">demandValue</span>()&#123;
    <span class="hljs-keyword">let</span> remainingDemand = <span class="hljs-built_in">this</span>.demand;
    <span class="hljs-keyword">let</span> result = <span class="hljs-number">0</span>;
    <span class="hljs-built_in">this</span>.producers
    .sort(<span class="hljs-function">(<span class="hljs-params">a,b</span>)=></span>a.cost - b.cost)
    .forEach(<span class="hljs-function"><span class="hljs-params">p</span> =></span> &#123;
      <span class="hljs-keyword">const</span> contribution = <span class="hljs-built_in">Math</span>.min(remainingDemand, p.production);
      remainingDemand -= contribution;
      result += contribution * p.cost;
    &#125;);
    <span class="hljs-keyword">return</span> result;
  &#125;
  <span class="hljs-comment">// 设置花费</span>
  <span class="hljs-keyword">get</span> <span class="hljs-title">demandCost</span>()&#123;
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.satisfiedDemand * <span class="hljs-built_in">this</span>.price;
  &#125;
  <span class="hljs-keyword">get</span> <span class="hljs-title">satisfiedDemand</span>()&#123;
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">Math</span>.min(<span class="hljs-built_in">this</span>._demand , <span class="hljs-built_in">this</span>.totalProduction);
  &#125;
&#125;;

<span class="hljs-comment">// 供应商类--存放数据的容器</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Producer</span></span>&#123;
  <span class="hljs-function"><span class="hljs-title">constructor</span>(<span class="hljs-params">aFactory, data</span>)</span>&#123;
    <span class="hljs-built_in">this</span>._factory = aFactory;
    <span class="hljs-built_in">this</span>._cost = data.cost;
    <span class="hljs-built_in">this</span>._name = data.name;
    <span class="hljs-built_in">this</span>._production = data.production || <span class="hljs-number">0</span>;
  &#125;

  <span class="hljs-comment">// 各种值得取值和设值函数</span>
  <span class="hljs-keyword">get</span> <span class="hljs-title">name</span>()&#123;
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>._name;
  &#125;
  <span class="hljs-keyword">get</span> <span class="hljs-title">cost</span>()&#123;
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>._cost;
  &#125;
  <span class="hljs-keyword">set</span> <span class="hljs-title">cost</span>(<span class="hljs-params">arg</span>)&#123;
    <span class="hljs-built_in">this</span>._cost = <span class="hljs-built_in">parseInt</span>(arg);
  &#125;

  <span class="hljs-keyword">get</span> <span class="hljs-title">production</span>()&#123;
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>._production;
  &#125;
  <span class="hljs-keyword">set</span> <span class="hljs-title">production</span>(<span class="hljs-params">amountStr</span>)&#123;
    <span class="hljs-keyword">const</span> amount = <span class="hljs-built_in">parseInt</span>(amountStr);
    <span class="hljs-keyword">const</span> newProduction = <span class="hljs-built_in">Number</span>.isNaN(amount) ? <span class="hljs-number">0</span> : amount;
    <span class="hljs-built_in">this</span>._factory.totalProduction += newProduction - <span class="hljs-built_in">this</span>._production;
    <span class="hljs-built_in">this</span>._production = newProduction;
  &#125;
&#125;


<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">sampleFactoryData</span>(<span class="hljs-params"></span>)</span>&#123;
  <span class="hljs-keyword">return</span> &#123;
    <span class="hljs-attr">name</span>:<span class="hljs-string">"Apple"</span>,
    <span class="hljs-attr">producers</span>:[&#123;
      <span class="hljs-attr">name</span>:<span class="hljs-string">"FOXCOM"</span>,
      <span class="hljs-attr">cost</span>:<span class="hljs-number">10</span>,
      <span class="hljs-attr">production</span>:<span class="hljs-number">9</span>
    &#125;,&#123;
      <span class="hljs-attr">name</span>:<span class="hljs-string">"SAMSUNG"</span>,
      <span class="hljs-attr">cost</span>:<span class="hljs-number">12</span>,
      <span class="hljs-attr">production</span>:<span class="hljs-number">10</span>
    &#125;,&#123;
      <span class="hljs-attr">name</span>:<span class="hljs-string">"BYD"</span>,
      <span class="hljs-attr">cost</span>:<span class="hljs-number">10</span>,
      <span class="hljs-attr">production</span>:<span class="hljs-number">6</span>
    &#125;],
    <span class="hljs-attr">demand</span>:<span class="hljs-number">200</span>,
    <span class="hljs-attr">price</span>:<span class="hljs-number">16000</span>
  &#125;
&#125;;

<span class="hljs-built_in">module</span>.exports = &#123;
  sampleFactoryData,
  Factory,
  Producer
&#125;
<span class="copy-code-btn">复制代码</span></code></pre>
<p><strong>初次测试</strong></p>
<p>在进行测试代码前，需要使用测试框架Mocha。当然你得先进行相关包的安装：</p>
<pre><code class="hljs language-shell copyable" lang="shell">npm install mocha
<span class="copy-code-btn">复制代码</span></code></pre>
<p>安装mocha> = v3.0.0，npm的版本应该> = v2.14.2。除此，确保使用Node.js的版本> = v4来运行mocha.</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/95e2f2c841e2426aa15156a68978b9e0~tplv-k3u1fbpfcp-zoom-1.image" alt loading="lazy" referrerpolicy="no-referrer"></p>
<p>test.js</p>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-keyword">const</span> &#123;Factory, sampleFactoryData&#125; = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./computer"</span>);
<span class="hljs-keyword">var</span> assert = <span class="hljs-built_in">require</span>(<span class="hljs-string">'assert'</span>);
describe(<span class="hljs-string">"factory"</span>,<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>&#123;
  it(<span class="hljs-string">"shortfall"</span>,<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>&#123;
    <span class="hljs-keyword">const</span> doc = sampleFactoryData();
    <span class="hljs-keyword">const</span> apple = <span class="hljs-keyword">new</span> Factory(doc);
    assert.equal(apple.shortfall, <span class="hljs-number">175</span>);
  &#125;)
&#125;)
<span class="copy-code-btn">复制代码</span></code></pre>
<p>切记要在package.json中设置启动方式：</p>
<pre><code class="hljs language-json copyable" lang="json"> <span class="hljs-string">"scripts"</span>: &#123;
    <span class="hljs-attr">"test"</span>: <span class="hljs-string">"mocha"</span>
  &#125;,
<span class="copy-code-btn">复制代码</span></code></pre>
<p>在命令行中输入测试指令：</p>
<pre><code class="hljs language-shell copyable" lang="shell"><span class="hljs-meta">$</span><span class="bash"> npm <span class="hljs-built_in">test</span></span>
<span class="hljs-meta">></span><span class="bash"> <span class="hljs-built_in">test</span>@1.0.0 <span class="hljs-built_in">test</span> G:\oneu\<span class="hljs-built_in">test</span></span>
<span class="hljs-meta">></span><span class="bash"> mocha</span>

  factory
    ✔ shortfall
  1 passing (7ms)
<span class="copy-code-btn">复制代码</span></code></pre>
<p>Mocha框架组织测试的方式是对代码进行分组，每组包含一个相关的测试，测试需要写在一个it块中。在上面的例子中，测试主要包含两个步骤：</p>
<ul>
<li>设置夹具（fixture），即测试所需要的数据和对象等</li>
<li>验证测试夹具是否具备某些特征</li>
</ul>
<p>我们看到的是测试正确的，那么如果想看到测试失败时候的报错：</p>
<pre><code class="hljs language-js copyable" lang="js">assert.equal(apple.shortfall, <span class="hljs-number">5</span>);
<span class="copy-code-btn">复制代码</span></code></pre>
<p>运行结果：</p>
<pre><code class="hljs language-shell copyable" lang="shell"><span class="hljs-meta">$</span><span class="bash"> npm <span class="hljs-built_in">test</span></span>
<span class="hljs-meta">></span><span class="bash"> <span class="hljs-built_in">test</span>@1.0.0 <span class="hljs-built_in">test</span> G:\oneu\<span class="hljs-built_in">test</span></span>
<span class="hljs-meta">></span><span class="bash"> mocha</span>

  factory
    1) shortfall
  0 passing (10ms)
  1 failing

  1) factory
       shortfall:

      AssertionError [ERR_ASSERTION]: 175 == 5
      + expected - actual

      -175
      +5

      at Context.<anonymous> (test.js:7:12)
      at processImmediate (internal/timers.js:461:21)
      
npm ERR! Test failed.  See above for more details.
<span class="copy-code-btn">复制代码</span></code></pre>
<p>我们看到，Mocha框架报告了哪个测试失败，并给出测试失败的原因，方便查找，其实这里的错误就是实际计算的值与期望值不相等。</p>
<p>在实际测试系统中会有多个测试，能够帮助我们快速运行查找到BUG。好的测试能够给予我们简单清晰的错误反馈，对于自测代码而言尤为重要。在实际开发中，建议频繁运行测试代码，检验新代码的进展和重构过程是否报错。</p>
<p><strong>再次测试</strong></p>
<p>在每添加新功能时，遵循的风格是：对被测试类做的所有事情进行观察，而后对这个类的每个行为进行测试，包括各种可能使它发生异常的边界条件。测试是一种风险驱动的行为，测试的目标时希望找出现在下奶或未来可能出现的BUG。</p>
<p>切记：如果尝试撰写过多测试，可能得不到预期的结果，会导致测试不充分。事实上，即使只做一点测试，也能从中获益良多。</p>
<p>接着，我们再写一个测试计算总利润的代码，可以在测试夹具对总利润进行基本测试。</p>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-keyword">const</span> &#123;Factory, sampleFactoryData&#125; = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./computer"</span>);
<span class="hljs-keyword">var</span> assert = <span class="hljs-built_in">require</span>(<span class="hljs-string">'assert'</span>);
<span class="hljs-keyword">var</span> expect = <span class="hljs-built_in">require</span>(<span class="hljs-string">"expect"</span>);
describe(<span class="hljs-string">"factory"</span>,<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>&#123;
  <span class="hljs-keyword">const</span> apple = <span class="hljs-keyword">new</span> Factory(sampleFactoryData());
  it(<span class="hljs-string">"shortfall"</span>,<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>&#123;
    assert.equal(apple.shortfall, <span class="hljs-number">175</span>);
  &#125;)

  it(<span class="hljs-string">"profit"</span>,<span class="hljs-function">()=></span>&#123;
   
    expect(apple.profit).equal(<span class="hljs-number">230</span>);
  &#125;)
&#125;)
<span class="copy-code-btn">复制代码</span></code></pre>
<p><strong>修改测试夹具</strong></p>
<p>加载完测试夹具后，可以编写些测试代码来探查它的特性，但在实际应用中该夹具会被频繁更新，因为用户会在界面上修改数值。要知道多数更新都是通过设置函数完成的，但是不太可能出现什么BUG。</p>
<pre><code class="hljs language-js copyable" lang="js">it(<span class="hljs-string">"change production"</span>,<span class="hljs-function">()=></span>&#123;
  apple.producers[<span class="hljs-number">0</span>].production = <span class="hljs-number">20</span>;
  assert.equal(apple.shortfall,<span class="hljs-number">164</span>);
  assert.equal(apple.profit,-<span class="hljs-number">575620</span>);
&#125;)
<span class="copy-code-btn">复制代码</span></code></pre>
<p>上述代码常见的测试模式，拿到beforeEach配置好的初始标准夹具，再对其进行必要检查，最后验证它是否表现出期望的行为。总而言之就是“配置->检查->验证”、“准备->行为->断言”等。</p>
<p><strong>探测边界条件</strong></p>
<p>在前面一系列的描述中，所有的测试均是聚焦在正常的行为上，通常称为“正常路径”，指的是在一切工作正常、用户使用方式符合规范的场景，其实也就是理想条件下。将测试推演到这些条件的边界处，可以检查出操作出错时软件的表现。</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5b6f284ed8104f10a6c1e7c183b88197~tplv-k3u1fbpfcp-zoom-1.image" alt loading="lazy" referrerpolicy="no-referrer"></p>
<p>无论何时，当拿到一个集合时，可以去看看集合为空时会发生什么。</p>
<pre><code class="hljs language-js copyable" lang="js">describe(<span class="hljs-string">"no producers"</span>,<span class="hljs-function">()=></span>&#123;
  <span class="hljs-keyword">let</span> noProducers;
  beforeEach(<span class="hljs-function">()=></span>&#123;
    <span class="hljs-keyword">const</span> data = &#123;
      <span class="hljs-attr">name</span>: <span class="hljs-string">"no producers"</span>,
      <span class="hljs-attr">producers</span>:[],
      <span class="hljs-attr">demand</span>:<span class="hljs-number">30</span>,
      <span class="hljs-attr">price</span>:<span class="hljs-number">20</span>
    &#125;
    noProducers = <span class="hljs-keyword">new</span> Factory(data);
  &#125;);

  it(<span class="hljs-string">"shortfall"</span>,<span class="hljs-function">()=></span>&#123;
    assert.equal(noProducers.shortfall,<span class="hljs-number">30</span>);

  &#125;)

  it(<span class="hljs-string">"profit"</span>,<span class="hljs-function">()=></span>&#123;
    assert.equal(noProducers.profit,<span class="hljs-number">0</span>);
  &#125;)
  
&#125;)
<span class="copy-code-btn">复制代码</span></code></pre>
<p>如果拿到的是数值类型，0会是不错的边界条件：</p>
<pre><code class="hljs language-js copyable" lang="js">it(<span class="hljs-string">"zero demand"</span>,<span class="hljs-function">()=></span>&#123;
  apple.demand = <span class="hljs-number">0</span>;
  assert.equal(apple.shortfall,-<span class="hljs-number">36</span>);
  assert.equal(apple.profit,<span class="hljs-number">0</span>);
&#125;)
<span class="copy-code-btn">复制代码</span></code></pre>
<p>同样的，可以测试负值是不是边界类型：</p>
<pre><code class="hljs language-js copyable" lang="js">it(<span class="hljs-string">"negativate demand"</span>,<span class="hljs-function">()=></span>&#123;
  apple.demand = -<span class="hljs-number">1</span>;
  assert.equal(apple.shortfall,-<span class="hljs-number">37</span>);
  assert.equal(apple.profit,<span class="hljs-number">15990</span> );
&#125;)
<span class="copy-code-btn">复制代码</span></code></pre>
<p>我们知道设置函数接收的字符串是用户输入得到，虽然已经被限制了只能填写数字，但是仍然有可能是空字符串。</p>
<pre><code class="hljs language-js copyable" lang="js">it(<span class="hljs-string">"empty string demand"</span>,<span class="hljs-function">()=></span>&#123;
  apple.demand = <span class="hljs-string">""</span>;
  assert.equal(apple.shortfall,<span class="hljs-literal">NaN</span>);
  assert.equal(apple.profit,<span class="hljs-literal">NaN</span>);
&#125;)
<span class="copy-code-btn">复制代码</span></code></pre>
<p>以上都是考虑到可能出错的边界条件，把测试火力集中在那儿。重构应该保证可以观测的行为不发生改变，不要因为测试无法捕获所有的BUG就不写测试，因为测试的确可以捕获大多数BUG。任何测试都不能证明一条程序没有BUG，但是测试可以提高编程速度。</p>
<h2 data-id="heading-2">测试远不止如此</h2>
<p>在本文中介绍的测试属于单元测试，它们各自负责测试部分代码单元，运行快速便捷。单元测试是自测代码的主要方式，是测试系统中占据最多的测试类型。其他测试类型的作用是：</p>
<ul>
<li>专注于组件间的集成测试</li>
<li>检验软件跨越几个层级的运行结果</li>
<li>测试查找性能问题。</li>
</ul>
<p>在编写测试代码时，要养成良好习惯：当遇到BUG时，要先写一个测试去清楚的复现它，仅当测试通过时方可视为BUG修理完毕。</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2bdd9577e5014169a174689919dff545~tplv-k3u1fbpfcp-zoom-1.image" alt loading="lazy" referrerpolicy="no-referrer"></p>
<p>当然，要写多少测试才能保证系统的稳定性，这个没有绝对的衡量标准，个人而言是在代码中引入一个缺陷，要有多大自信能够将其从测试集合中查找出来并解决。</p>
<h2 data-id="heading-3">小结</h2>
<p>编写良好的测试程序，能够极大提高我们的编程速度，即使不进行重构也是如此。</p>
<h2 data-id="heading-4">参考文章</h2>
<p>《重构──改善既有代码的设计（第2版）》
<a href="https://juejin.cn/post/6844903503458992142" target="_blank">《前端重构感想》</a></p>
<h2 data-id="heading-5">写在最后</h2>
<p>我是前端小菜鸡，感谢大家的阅读，我将继续和大家分享更多优秀的文章，此文参考了大量书籍和文章，如果有错误和纰漏，希望能给予指正。</p>
<p>更多最新文章敬请关注笔者掘金账号<strong>一川萤火</strong>和公众号<strong>前端万有引力</strong>。</p></div>  
</div>
            