
---
title: 'DIffç®—æ³•çœ‹ä¸æ‡‚å°±ä¸€èµ·æ¥ç æˆ‘(å¸¦å›¾)'
categories: 
 - ç¼–ç¨‹
 - æ˜é‡‘
 - åˆ†ç±»
headimg: 'https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/03196dcfcce243b0bf69780250b39086~tplv-k3u1fbpfcp-watermark.image'
author: æ˜é‡‘
comments: false
date: Tue, 24 Aug 2021 23:29:49 GMT
thumbnail: 'https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/03196dcfcce243b0bf69780250b39086~tplv-k3u1fbpfcp-watermark.image'
---

<div>   
<div class="markdown-body"><style>.markdown-body&#123;color:#383838;font-size:15px;line-height:37.5px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:120px&#125;.markdown-body ::selection&#123;color:#fff;background-color:#a862ea&#125;.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6&#123;margin:30px 0 15px;color:#a862ea&#125;.markdown-body h1&#123;line-height:2;font-size:1.4em&#125;.markdown-body h1~p:first-of-type:first-letter&#123;color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder&#125;.markdown-body h2&#123;font-size:1.2em&#125;.markdown-body h3&#123;font-size:1.1em&#125;.markdown-body ol,.markdown-body ul&#123;padding-left:2em&#125;.markdown-body ol li,.markdown-body ul li&#123;margin-bottom:0;padding-left:.2em&#125;.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item&#123;list-style:none&#125;.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul&#123;margin-top:0&#125;.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul&#123;margin-top:10px&#125;.markdown-body li::marker&#123;color:#a862ea&#125;.markdown-body li,.markdown-body p&#123;opacity:.9;vertical-align:baseline;transition:all .1s ease&#125;.markdown-body li:hover,.markdown-body p:hover&#123;opacity:1&#125;.markdown-body a&#123;display:inline-block;color:#a862ea;cursor:pointer;padding-bottom:2px;text-decoration:none;position:relative&#125;.markdown-body a:after&#123;content:"";position:absolute;width:98%;height:2px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out&#125;.markdown-body a:hover:after&#123;transform:scaleX(1);transform-origin:bottom left&#125;.markdown-body a:active,.markdown-body a:link&#123;color:#a862ea&#125;.markdown-body img&#123;max-width:100%;user-select:none;margin:1em 0;box-shadow:0 0 20px 0 #e7daff;transition:transform .2s ease 0s;background-color:#f8f5ff&#125;.markdown-body img:hover&#123;opacity:1;transform:translateY(-2px)&#125;.markdown-body blockquote&#123;padding:.5em 1em;margin:15px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:4px solid #a862ea;background-color:#f8f5ff&#125;.markdown-body blockquote>p&#123;margin:0&#125;.markdown-body code&#123;padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff&#125;.markdown-body pre&#123;margin:2em 0;box-shadow:0 0 20px #e7daff&#125;.markdown-body pre>code&#123;display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:22.5px;color:#383838;border-radius:3px;scroll-behavior:smooth&#125;.markdown-body pre>code::-webkit-scrollbar&#123;height:6px;background-color:#f8f5ff&#125;.markdown-body pre>code::-webkit-scrollbar-thumb&#123;background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px&#125;.markdown-body hr&#123;margin:2em 0;border-top:1px solid #a862ea&#125;.markdown-body table&#123;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse;border:1px solid #e7daff&#125;.markdown-body thead&#123;color:#a862ea;background:#f8f5ff&#125;.markdown-body td,.markdown-body th&#123;padding:1em .5em&#125;.markdown-body tr&#123;background-color:#fcfcfc&#125;@media (max-width:720px)&#123;.markdown-body&#123;font-size:12px&#125;&#125;</style><h1 data-id="heading-0">å‰è¨€</h1>
<p>é¢è¯•å®˜:"ä½ äº†è§£<code>è™šæ‹ŸDOM(Virtual DOM)</code>è·Ÿ<code>Diffç®—æ³•</code>å—,è¯·æè¿°ä¸€ä¸‹å®ƒä»¬";</p>
<p>æˆ‘:"é¢,...é¹…,é‚£ä¸ª",å®Œäº†ğŸ˜°,çªç„¶æ™ºå•†ä¸åœ¨çº¿,æ²¡ç»„ç»‡å¥½è¯­è¨€æ²¡ç­”å¥½æˆ–è€…å‹æ ¹å°±ç­”ä¸å‡ºæ¥;</p>
<p>æ‰€ä»¥è¿™æ¬¡æˆ‘æ€»ç»“ä¸€ä¸‹ç›¸å…³çš„çŸ¥è¯†ç‚¹,è®©ä½ å¯ä»¥æœ‰ä¸€ä¸ªæ¸…æ™°çš„è®¤çŸ¥ä¹‹ä½™ä¹Ÿä¼šè®©ä½ åœ¨ä»Šåé‡åˆ°è¿™ç§æƒ…å†µå¯ä»¥<strong>å¦ç„¶è‡ªè‹¥,åº”ä»˜è‡ªå¦‚,æ¸¸åˆƒæœ‰ä½™</strong>:</p>
<hr>
<h2 data-id="heading-1">ç›¸å…³çŸ¥è¯†ç‚¹:</h2>
<ul>
<li>è™šæ‹ŸDOM(Virtual DOM):
<ul>
<li>
<p><strong>ä»€ä¹ˆæ˜¯è™šæ‹Ÿdom</strong></p>
</li>
<li>
<p><strong>ä¸ºä»€ä¹ˆè¦ä½¿ç”¨è™šæ‹Ÿdom</strong></p>
</li>
<li>
<p>è™šæ‹ŸDOMåº“</p>
</li>
</ul>
</li>
<li>DIFFç®—æ³•:
<ul>
<li>snabbDomæºç 
<ul>
<li>initå‡½æ•°</li>
<li>hå‡½æ•°</li>
<li><strong>patchå‡½æ•°</strong></li>
<li><strong>patchVnodeå‡½æ•°</strong></li>
<li><strong>updateChildrenå‡½æ•°</strong></li>
</ul>
</li>
</ul>
</li>
</ul>
<hr>
<h2 data-id="heading-2">è™šæ‹ŸDOM(Virtual DOM)</h2>
<h3 data-id="heading-3">ä»€ä¹ˆæ˜¯è™šæ‹ŸDOM</h3>
<p>ä¸€å¥è¯æ€»ç»“è™šæ‹ŸDOMå°±æ˜¯ä¸€ä¸ªç”¨æ¥æè¿°çœŸå®DOMçš„<strong>javaScriptå¯¹è±¡</strong>,è¿™æ ·è¯´å¯èƒ½ä¸å¤Ÿå½¢è±¡,é‚£æˆ‘ä»¬æ¥ä¸¾ä¸ªğŸŒ°:åˆ†åˆ«ç”¨ä»£ç æ¥æè¿°<code>çœŸå®DOM</code>ä»¥åŠ<code>è™šæ‹ŸDOM</code></p>
<p><code>çœŸå®DOM</code>:</p>
<pre><code class="hljs language-html copyable" lang="html"><span class="hljs-tag"><<span class="hljs-name">ul</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"list"</span>></span>
    <span class="hljs-tag"><<span class="hljs-name">li</span>></span>a<span class="hljs-tag"></<span class="hljs-name">li</span>></span>
    <span class="hljs-tag"><<span class="hljs-name">li</span>></span>b<span class="hljs-tag"></<span class="hljs-name">li</span>></span>
    <span class="hljs-tag"><<span class="hljs-name">li</span>></span>c<span class="hljs-tag"></<span class="hljs-name">li</span>></span>
<span class="hljs-tag"></<span class="hljs-name">ul</span>></span>
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<p><code>å¯¹åº”çš„è™šæ‹ŸDOM</code>:</p>
<pre><code class="hljs language-javascript copyable" lang="javascript">
<span class="hljs-keyword">let</span> vnode = h(<span class="hljs-string">'ul.list'</span>, [
  h(<span class="hljs-string">'li'</span>,<span class="hljs-string">'a'</span>),
  h(<span class="hljs-string">'li'</span>,<span class="hljs-string">'b'</span>),
  h(<span class="hljs-string">'li'</span>,<span class="hljs-string">'c'</span>),
])

<span class="hljs-built_in">console</span>.log(vnode)
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<h4 data-id="heading-4">æ§åˆ¶å°æ‰“å°å‡ºæ¥çš„<strong>Vnode</strong>:</h4>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/03196dcfcce243b0bf69780250b39086~tplv-k3u1fbpfcp-watermark.image" alt="image.png" loading="lazy" referrerpolicy="no-referrer"></p>
<h4 data-id="heading-5">hå‡½æ•°ç”Ÿæˆçš„è™šæ‹ŸDOMè¿™ä¸ªJSå¯¹è±¡(Vnode)çš„æºç :</h4>
<pre><code class="hljs language-typescript copyable" lang="typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> VNodeData &#123;
    props?: Props
    attrs?: Attrs
    <span class="hljs-class"><span class="hljs-keyword">class</span>?: <span class="hljs-title">Classes</span>
    <span class="hljs-title">style</span>?: <span class="hljs-title">VNodeStyle</span>
    <span class="hljs-title">dataset</span>?: <span class="hljs-title">Dataset</span>
    <span class="hljs-title">on</span>?: <span class="hljs-title">On</span>
    <span class="hljs-title">hero</span>?: <span class="hljs-title">Hero</span>
    <span class="hljs-title">attachData</span>?: <span class="hljs-title">AttachData</span>
    <span class="hljs-title">hook</span>?: <span class="hljs-title">Hooks</span>
    <span class="hljs-title">key</span>?: <span class="hljs-title">Key</span>
    <span class="hljs-title">ns</span>?: <span class="hljs-title">string</span> // <span class="hljs-title">for</span> <span class="hljs-title">SVGs</span>
    <span class="hljs-title">fn</span>?: () </span>=> VNode <span class="hljs-comment">// for thunks</span>
    args?: <span class="hljs-built_in">any</span>[] <span class="hljs-comment">// for thunks</span>
    [key: <span class="hljs-built_in">string</span>]: <span class="hljs-built_in">any</span> <span class="hljs-comment">// for any other 3rd party module</span>
&#125;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> Key = <span class="hljs-built_in">string</span> | <span class="hljs-built_in">number</span>

<span class="hljs-keyword">const</span> <span class="hljs-keyword">interface</span> VNode = &#123;
    <span class="hljs-attr">sel</span>: <span class="hljs-built_in">string</span> | <span class="hljs-literal">undefined</span>, <span class="hljs-comment">// é€‰æ‹©å™¨</span>
    <span class="hljs-attr">data</span>: VNodeData | <span class="hljs-literal">undefined</span>, <span class="hljs-comment">// VNodeDataä¸Šé¢å®šä¹‰çš„VNodeData</span>
    <span class="hljs-attr">children</span>: <span class="hljs-built_in">Array</span><VNode | <span class="hljs-built_in">string</span>> | <span class="hljs-literal">undefined</span>, <span class="hljs-comment">//å­èŠ‚ç‚¹,ä¸textäº’æ–¥</span>
    <span class="hljs-attr">text</span>: <span class="hljs-built_in">string</span> | <span class="hljs-literal">undefined</span>, <span class="hljs-comment">// æ ‡ç­¾ä¸­é—´çš„æ–‡æœ¬å†…å®¹</span>
    <span class="hljs-attr">elm</span>: Node | <span class="hljs-literal">undefined</span>, <span class="hljs-comment">// è½¬æ¢è€Œæˆçš„çœŸå®DOM</span>
    <span class="hljs-attr">key</span>: Key | <span class="hljs-literal">undefined</span> <span class="hljs-comment">// å­—ç¬¦ä¸²æˆ–è€…æ•°å­—</span>
&#125;

<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<h5 data-id="heading-6">è¡¥å……:</h5>
<p>ä¸Šé¢çš„hå‡½æ•°å¤§å®¶å¯èƒ½æœ‰ç‚¹ç†Ÿæ‚‰çš„æ„Ÿè§‰ä½†æ˜¯ä¸€æ—¶é—´ä¹Ÿæ²¡æƒ³èµ·æ¥,æ²¡å…³ç³»æˆ‘æ¥å¸®å¤§ä¼™å›å¿†;
<code>å¼€å‘ä¸­å¸¸è§çš„ç°å®åœºæ™¯,renderå‡½æ•°æ¸²æŸ“</code>:</p>
<pre><code class="hljs language-javascript copyable" lang="javascript"><span class="hljs-comment">// æ¡ˆä¾‹1 vueé¡¹ç›®ä¸­çš„main.jsçš„åˆ›å»ºvueå®ä¾‹</span>
<span class="hljs-keyword">new</span> Vue(&#123;
  router,
  store,
  <span class="hljs-attr">render</span>: <span class="hljs-function"><span class="hljs-params">h</span> =></span> h(App)
&#125;).$mount(<span class="hljs-string">"#app"</span>);

<span class="hljs-comment">//æ¡ˆä¾‹2 åˆ—è¡¨ä¸­ä½¿ç”¨renderæ¸²æŸ“</span>
columns: [
    &#123;
        <span class="hljs-attr">title</span>: <span class="hljs-string">"æ“ä½œ"</span>,
        <span class="hljs-attr">key</span>: <span class="hljs-string">"action"</span>,
        <span class="hljs-attr">width</span>: <span class="hljs-number">150</span>,
        <span class="hljs-attr">render</span>: <span class="hljs-function">(<span class="hljs-params">h, params</span>) =></span> &#123;
            <span class="hljs-keyword">return</span> h(<span class="hljs-string">'div'</span>, [
                h(<span class="hljs-string">'Button'</span>, &#123;
                    <span class="hljs-attr">props</span>: &#123;
                        <span class="hljs-attr">size</span>: <span class="hljs-string">'small'</span>
                    &#125;,
                    <span class="hljs-attr">style</span>: &#123;
                        <span class="hljs-attr">marginRight</span>: <span class="hljs-string">'5px'</span>,
                        <span class="hljs-attr">marginBottom</span>: <span class="hljs-string">'5px'</span>,
                    &#125;,
                    <span class="hljs-attr">on</span>: &#123;
                        <span class="hljs-attr">click</span>: <span class="hljs-function">() =></span> &#123;
                            <span class="hljs-built_in">this</span>.toEdit(params.row.uuid);
                        &#125;
                    &#125;
                &#125;, <span class="hljs-string">'ç¼–è¾‘'</span>)
            ]);
        &#125;
    &#125;
]
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<hr>
<h3 data-id="heading-7">ä¸ºä»€ä¹ˆè¦ä½¿ç”¨è™šæ‹ŸDOM</h3>
<ul>
<li>MVVMæ¡†æ¶è§£å†³è§†å›¾å’ŒçŠ¶æ€åŒæ­¥é—®é¢˜</li>
<li>æ¨¡æ¿å¼•æ“å¯ä»¥ç®€åŒ–è§†å›¾æ“ä½œ,æ²¡åŠæ³•è·Ÿè¸ªçŠ¶æ€</li>
<li>è™šæ‹ŸDOMè·Ÿè¸ªçŠ¶æ€å˜åŒ–</li>
<li>å‚è€ƒgithubä¸Š<a href="https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2FMatt-Esch%2Fvirtual-dom" target="_blank" rel="nofollow noopener noreferrer" title="https://github.com/Matt-Esch/virtual-dom" ref="nofollow noopener noreferrer">virtual-dom</a>çš„åŠ¨æœºæè¿°
<ul>
<li>è™šæ‹ŸDOMå¯ä»¥ç»´æŠ¤ç¨‹åºçš„çŠ¶æ€,è·Ÿè¸ªä¸Šä¸€æ¬¡çš„çŠ¶æ€</li>
<li>é€šè¿‡æ¯”è¾ƒå‰åä¸¤æ¬¡çŠ¶æ€å·®å¼‚æ›´æ–°çœŸå®DOM</li>
</ul>
</li>
<li>è·¨å¹³å°ä½¿ç”¨
<ul>
<li>æµè§ˆå™¨å¹³å°æ¸²æŸ“DOM</li>
<li>æœåŠ¡ç«¯æ¸²æŸ“SSR(Nuxt.js/Next.js),å‰ç«¯æ˜¯vueå‘,åè€…æ˜¯reactå‘</li>
<li>åŸç”Ÿåº”ç”¨(Weex/React Native)</li>
<li>å°ç¨‹åº(mpvue/uni-app)ç­‰</li>
</ul>
</li>
<li>çœŸå®DOMçš„å±æ€§å¾ˆå¤šï¼Œåˆ›å»ºDOMèŠ‚ç‚¹å¼€é”€å¾ˆå¤§</li>
<li>è™šæ‹ŸDOMåªæ˜¯æ™®é€šJavaScriptå¯¹è±¡ï¼Œæè¿°å±æ€§å¹¶ä¸éœ€è¦å¾ˆå¤šï¼Œåˆ›å»ºå¼€é”€å¾ˆå°</li>
<li><strong>å¤æ‚è§†å›¾æƒ…å†µä¸‹æå‡æ¸²æŸ“æ€§èƒ½</strong>(æ“ä½œdomæ€§èƒ½æ¶ˆè€—å¤§,å‡å°‘æ“ä½œdomçš„èŒƒå›´å¯ä»¥æå‡æ€§èƒ½)</li>
</ul>
<p><strong>çµé­‚å‘é—®</strong>:ä½¿ç”¨äº†è™šæ‹ŸDOMå°±ä¸€å®šä¼šæ¯”ç›´æ¥æ¸²æŸ“çœŸå®DOMå¿«å—?ç­”æ¡ˆå½“ç„¶æ˜¯<code>å¦å®š</code>çš„,ä¸”å¬æˆ‘è¯´:
<img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0bd4d26c0f154fc1adff6a6ed8346909~tplv-k3u1fbpfcp-watermark.image" alt="2c3559e204c5aae6a1c6bfdc8557efcd.jpeg" loading="lazy" referrerpolicy="no-referrer"></p>
<p><strong>ä¸¾ä¾‹</strong>:å½“ä¸€ä¸ªèŠ‚ç‚¹å˜æ›´æ—¶DOMA->DOMB</p>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ea61542e0dfb449e9cf506f0901aafe1~tplv-k3u1fbpfcp-watermark.image" alt="image.png" loading="lazy" referrerpolicy="no-referrer">
ä¸Šè¿°æƒ…å†µ:
<code>ç¤ºä¾‹1</code>æ˜¯åˆ›å»ºä¸€ä¸ª<code>DOMB</code>ç„¶åæ›¿æ¢æ‰<code>DOMA</code>;
<code>ç¤ºä¾‹2</code>å»<code>åˆ›å»ºè™šæ‹ŸDOM+DIFFç®—æ³•</code>æ¯”å¯¹å‘ç°<code>DOMB</code>è·Ÿ<code>DOMA</code>ä¸æ˜¯ç›¸åŒçš„èŠ‚ç‚¹,æœ€åè¿˜æ˜¯åˆ›å»ºä¸€ä¸ª<code>DOMB</code>ç„¶åæ›¿æ¢æ‰<code>DOMA</code>;
å¯ä»¥æ˜æ˜¾çœ‹å‡º1æ˜¯æ›´å¿«çš„,åŒæ ·çš„ç»“æœ,2è¿˜è¦å»åˆ›å»ºè™šæ‹ŸDOM+DIFFç®—å•Šå¯¹æ¯”
æ‰€ä»¥è¯´ä½¿ç”¨è™šæ‹ŸDOMæ¯”ç›´æ¥æ“ä½œçœŸå®DOMå°±ä¸€å®šè¦å¿«è¿™ä¸ªè¯´æ³•æ˜¯<code>é”™è¯¯çš„,ä¸ä¸¥è°¨çš„</code></p>
<p><strong>ä¸¾ä¾‹</strong>:å½“DOMæ ‘é‡Œé¢çš„æŸä¸ªå­èŠ‚ç‚¹çš„å†…å®¹å˜æ›´æ—¶:</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f7d4fdab03fc4cc583c3ca60a1f4e20e~tplv-k3u1fbpfcp-watermark.image" alt="image.png" loading="lazy" referrerpolicy="no-referrer">
å½“ä¸€äº›å¤æ‚çš„èŠ‚ç‚¹,æ¯”å¦‚è¯´ä¸€ä¸ªçˆ¶èŠ‚ç‚¹é‡Œé¢æœ‰å¤šä¸ªå­èŠ‚ç‚¹,å½“åªæ˜¯ä¸€ä¸ªå­èŠ‚ç‚¹çš„å†…å®¹å‘ç”Ÿäº†æ”¹å˜,é‚£ä¹ˆæˆ‘ä»¬æ²¡æœ‰å¿…è¦åƒ<code>ç¤ºä¾‹1</code>é‡æ–°å»æ¸²æŸ“è¿™ä¸ª<code>DOMæ ‘</code>,è¿™ä¸ªæ—¶å€™<code>è™šæ‹ŸDOM+DIFFç®—æ³•</code>å°±èƒ½å¤Ÿå¾—åˆ°å¾ˆå¥½çš„ä½“ç°,æˆ‘ä»¬é€šè¿‡<code>ç¤ºä¾‹2</code>ä½¿ç”¨<code>è™šæ‹ŸDOM+Diffç®—æ³•</code>å»æ‰¾å‡ºæ”¹å˜äº†çš„å­èŠ‚ç‚¹æ›´æ–°å®ƒçš„å†…å®¹å°±å¯ä»¥äº†</p>
<p>æ€»ç»“:<strong>å¤æ‚è§†å›¾æƒ…å†µä¸‹æå‡æ¸²æŸ“æ€§èƒ½</strong>,å› ä¸º<code>è™šæ‹ŸDOM+Diffç®—æ³•</code>å¯ä»¥ç²¾å‡†æ‰¾åˆ°DOMæ ‘å˜æ›´çš„åœ°æ–¹,å‡å°‘DOMçš„æ“ä½œ(é‡æ’é‡ç»˜)</p>
<hr>
<h3 data-id="heading-8">è™šæ‹Ÿdomåº“</h3>
<ul>
<li><a href="https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Fsnabbdom%2Fsnabbdom" target="_blank" rel="nofollow noopener noreferrer" title="https://github.com/snabbdom/snabbdom" ref="nofollow noopener noreferrer">Snabbdom</a>
<ul>
<li>Vue.js2.xå†…éƒ¨ä½¿ç”¨çš„è™šæ‹ŸDOMå°±æ˜¯æ”¹é€ çš„Snabbdom</li>
<li>å¤§çº¦200SLOC(single line of code)</li>
<li>é€šè¿‡æ¨¡å—å¯æ‰©å±•</li>
<li>æºç ä½¿ç”¨TypeScriptå¼€å‘</li>
<li>æœ€å¿«çš„Virtual DOMä¹‹ä¸€</li>
</ul>
</li>
<li><a href="https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2FMatt-Esch%2Fvirtual-dom" target="_blank" rel="nofollow noopener noreferrer" title="https://github.com/Matt-Esch/virtual-dom" ref="nofollow noopener noreferrer">virtual-dom</a></li>
</ul>
<hr>
<h2 data-id="heading-9">Diffç®—æ³•</h2>
<p>åœ¨çœ‹å®Œä¸Šè¿°çš„æ–‡ç« ä¹‹åç›¸ä¿¡å¤§å®¶å·²ç»å¯¹Diffç®—æ³•æœ‰ä¸€ä¸ªåˆæ­¥çš„æ¦‚å¿µ,æ²¡é”™,Diffç®—æ³•å…¶å®å°±æ˜¯æ‰¾å‡ºä¸¤è€…ä¹‹é—´çš„å·®å¼‚;</p>
<blockquote>
<p>diff ç®—æ³•é¦–å…ˆè¦æ˜ç¡®ä¸€ä¸ªæ¦‚å¿µå°±æ˜¯ Diff çš„å¯¹è±¡æ˜¯è™šæ‹ŸDOMï¼ˆvirtual domï¼‰ï¼Œæ›´æ–°çœŸå® DOM æ˜¯ Diff ç®—æ³•çš„ç»“æœã€‚</p>
</blockquote>
<p>ä¸‹é¢æˆ‘å°†ä¼šæ‰‹æ’•<code>snabbdom</code>æºç æ ¸å¿ƒéƒ¨åˆ†ä¸ºå¤§å®¶æ‰“å¼€<code>Diff</code>çš„å¿ƒ,ç»™ç‚¹è€å¿ƒ,åˆ«å…³ç½‘é¡µ,æˆ‘çŸ¥é“ä½ ä»¬éƒ½æ˜¯è¿™æ ·:</p>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/98b1ea6928a942afb2e9d5b056ed320e~tplv-k3u1fbpfcp-watermark.image" alt="src=http___img.wxcha.com_file_201905_17_f5a4d33d48.jpg&refer=http___img.wxcha.jpeg" loading="lazy" referrerpolicy="no-referrer"></p>
<hr>
<h2 data-id="heading-10">snabbdomçš„æ ¸å¿ƒ</h2>
<ul>
<li><code>init()</code>è®¾ç½®æ¨¡å—.åˆ›å»º<code>patch()</code>å‡½æ•°</li>
<li>ä½¿ç”¨<code>h()</code>å‡½æ•°åˆ›å»ºJavaScriptå¯¹è±¡<code>(Vnode)</code>æè¿°<code>çœŸå®DOM</code></li>
<li><code>patch()</code>æ¯”è¾ƒ<code>æ–°æ—§ä¸¤ä¸ªVnode</code></li>
<li>æŠŠå˜åŒ–çš„å†…å®¹æ›´æ–°åˆ°<code>çœŸå®DOMæ ‘</code></li>
</ul>
<h3 data-id="heading-11">initå‡½æ•°</h3>
<p>initå‡½æ•°æ—¶è®¾ç½®æ¨¡å—,ç„¶ååˆ›å»ºpatch()å‡½æ•°,æˆ‘ä»¬å…ˆé€šè¿‡åœºæ™¯æ¡ˆä¾‹æ¥æœ‰ä¸€ä¸ªç›´è§‚çš„ä½“ç°:</p>
<pre><code class="hljs language-javascript copyable" lang="javascript"><span class="hljs-keyword">import</span> &#123;init&#125; <span class="hljs-keyword">from</span> <span class="hljs-string">'snabbdom/build/package/init.js'</span>
<span class="hljs-keyword">import</span> &#123;h&#125; <span class="hljs-keyword">from</span> <span class="hljs-string">'snabbdom/build/package/h.js'</span>

<span class="hljs-comment">// 1.å¯¼å…¥æ¨¡å—</span>
<span class="hljs-keyword">import</span> &#123;styleModule&#125; <span class="hljs-keyword">from</span> <span class="hljs-string">"snabbdom/build/package/modules/style"</span>;
<span class="hljs-keyword">import</span> &#123;eventListenersModule&#125; <span class="hljs-keyword">from</span> <span class="hljs-string">"snabbdom/build/package/modules/eventListeners"</span>;

<span class="hljs-comment">// 2.æ³¨å†Œæ¨¡å—</span>
<span class="hljs-keyword">const</span> patch = init([
  styleModule,
  eventListenersModule
])

<span class="hljs-comment">// 3.ä½¿ç”¨h()å‡½æ•°çš„ç¬¬äºŒä¸ªå‚æ•°ä¼ å…¥æ¨¡å—ä¸­ä½¿ç”¨çš„æ•°æ®(å¯¹è±¡)</span>
<span class="hljs-keyword">let</span> vnode = h(<span class="hljs-string">'div'</span>, [
  h(<span class="hljs-string">'h1'</span>, &#123;<span class="hljs-attr">style</span>: &#123;<span class="hljs-attr">backgroundColor</span>: <span class="hljs-string">'red'</span>&#125;&#125;, <span class="hljs-string">'Hello world'</span>),
  h(<span class="hljs-string">'p'</span>, &#123;<span class="hljs-attr">on</span>: &#123;<span class="hljs-attr">click</span>: eventHandler&#125;&#125;, <span class="hljs-string">'Hello P'</span>)
])

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">eventHandler</span>(<span class="hljs-params"></span>) </span>&#123;
  alert(<span class="hljs-string">'ç–¼,åˆ«æ‘¸æˆ‘'</span>)
&#125;

<span class="hljs-keyword">const</span> app = <span class="hljs-built_in">document</span>.querySelector(<span class="hljs-string">'#app'</span>)

patch(app,vnode)
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<p>å½“initä½¿ç”¨äº†å¯¼å…¥çš„æ¨¡å—å°±èƒ½å¤Ÿåœ¨hå‡½æ•°ä¸­ç”¨è¿™äº›æ¨¡å—æä¾›çš„apiå»åˆ›å»º<code>è™šæ‹ŸDOM(Vnode)å¯¹è±¡</code>;åœ¨ä¸Šæ–‡ä¸­å°±ä½¿ç”¨äº†<code>æ ·å¼æ¨¡å—</code>ä»¥åŠ<code>äº‹ä»¶æ¨¡å—</code>è®©åˆ›å»ºçš„è¿™ä¸ªè™šæ‹ŸDOMå…·å¤‡æ ·å¼å±æ€§ä»¥åŠäº‹ä»¶å±æ€§,æœ€ç»ˆé€šè¿‡<code>patchå‡½æ•°</code>å¯¹æ¯”<code>ä¸¤ä¸ªè™šæ‹Ÿdom</code>(ä¼šå…ˆæŠŠappè½¬æ¢æˆè™šæ‹Ÿdom),æ›´æ–°è§†å›¾;</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5d327c27f5214fbda311f4d8ca09ad9e~tplv-k3u1fbpfcp-watermark.image" alt="image.png" loading="lazy" referrerpolicy="no-referrer"></p>
<p>æˆ‘ä»¬å†ç®€å•çœ‹çœ‹initçš„æºç éƒ¨åˆ†:</p>
<pre><code class="hljs language-javaScript copyable" lang="javaScript"><span class="hljs-comment">// src/package/init.ts</span>
<span class="hljs-comment">/* ç¬¬ä¸€å‚æ•°å°±æ˜¯å„ä¸ªæ¨¡å—
   ç¬¬äºŒå‚æ•°å°±æ˜¯DOMAPI,å¯ä»¥æŠŠDOMè½¬æ¢æˆåˆ«çš„å¹³å°çš„API,
ä¹Ÿå°±æ˜¯è¯´æ”¯æŒè·¨å¹³å°ä½¿ç”¨,å½“ä¸ä¼ çš„æ—¶å€™é»˜è®¤æ˜¯htmlDOMApi,è§ä¸‹æ–‡
   initæ˜¯ä¸€ä¸ªé«˜é˜¶å‡½æ•°,ä¸€ä¸ªå‡½æ•°è¿”å›å¦å¤–ä¸€ä¸ªå‡½æ•°,å¯ä»¥ç¼“å­˜modules,ä¸domApiä¸¤ä¸ªå‚æ•°,
é‚£ä¹ˆä»¥åç›´æ¥åªä¼ oldValueè·ŸnewValue(vnode)å°±å¯ä»¥äº†*/</span>
<span class="hljs-keyword">export</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">init</span> (<span class="hljs-params">modules: <span class="hljs-built_in">Array</span><Partial<Module>>, domApi?: DOMAPI</span>) </span>&#123;

...

<span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">patch</span> (<span class="hljs-params">oldVnode: VNode | Element, vnode: VNode</span>): <span class="hljs-title">VNode</span> </span>&#123;&#125;
&#125;
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<hr>
<h3 data-id="heading-12">hå‡½æ•°</h3>
<p>äº›åœ°æ–¹ä¹Ÿä¼šç”¨<code>createElement</code>æ¥å‘½å,å®ƒä»¬æ˜¯ä¸€æ ·çš„ä¸œè¥¿,éƒ½æ˜¯åˆ›å»º<code>è™šæ‹ŸDOM</code>çš„,åœ¨ä¸Šè¿°æ–‡ç« ä¸­ç›¸ä¿¡å¤§ä¼™å·²ç»å¯¹hå‡½æ•°æœ‰ä¸€ä¸ªåˆæ­¥çš„äº†è§£å¹¶ä¸”å·²ç»è”æƒ³äº†ä½¿ç”¨åœºæ™¯,å°±ä¸ä½œåœºæ™¯æ¡ˆä¾‹ä»‹ç»äº†,ç›´æ¥ä¸Šæºç éƒ¨åˆ†:</p>
<pre><code class="hljs language-javascript copyable" lang="javascript"><span class="hljs-comment">// hå‡½æ•°</span>
<span class="hljs-keyword">export</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">h</span> (<span class="hljs-params">sel: string</span>): <span class="hljs-title">VNode</span>
<span class="hljs-title">export</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">h</span> (<span class="hljs-params">sel: string, data: VNodeData | <span class="hljs-literal">null</span></span>): <span class="hljs-title">VNode</span>
<span class="hljs-title">export</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">h</span> (<span class="hljs-params">sel: string, children: VNodeChildren</span>): <span class="hljs-title">VNode</span>
<span class="hljs-title">export</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">h</span> (<span class="hljs-params">sel: string, data: VNodeData | <span class="hljs-literal">null</span>, children: VNodeChildren</span>): <span class="hljs-title">VNode</span>
<span class="hljs-title">export</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">h</span> (<span class="hljs-params">sel: any, b?: any, c?: any</span>): <span class="hljs-title">VNode</span> </span>&#123;
  <span class="hljs-title">var</span> <span class="hljs-title">data</span>: <span class="hljs-title">VNodeData</span> = </span>&#123;&#125;
  <span class="hljs-title">var</span> <span class="hljs-title">children</span>: <span class="hljs-title">any</span>
  <span class="hljs-title">var</span> <span class="hljs-title">text</span>: <span class="hljs-title">any</span>
  <span class="hljs-title">var</span> <span class="hljs-title">i</span>: <span class="hljs-title">number</span>
    ...
  <span class="hljs-title">return</span> <span class="hljs-title">vnode</span>(<span class="hljs-params">sel, data, children, text, <span class="hljs-literal">undefined</span></span>) //æœ€ç»ˆè¿”å›ä¸€ä¸ª<span class="hljs-title">vnode</span>å‡½æ•°
&#125;</span>;
</span></span><span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<pre><code class="hljs language-javascript copyable" lang="javascript"><span class="hljs-comment">// vnodeå‡½æ•°</span>
<span class="hljs-keyword">export</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">vnode</span> (<span class="hljs-params">sel: string | <span class="hljs-literal">undefined</span>,
  data: any | <span class="hljs-literal">undefined</span>,
  children: <span class="hljs-built_in">Array</span><VNode | string> | <span class="hljs-literal">undefined</span>,
  text: string | <span class="hljs-literal">undefined</span>,
  elm: Element | Text | <span class="hljs-literal">undefined</span></span>): <span class="hljs-title">VNode</span> </span>&#123;
  <span class="hljs-keyword">const</span> key = data === <span class="hljs-literal">undefined</span> ? <span class="hljs-literal">undefined</span> : data.key
  <span class="hljs-keyword">return</span> &#123; sel, data, children, text, elm, key &#125; <span class="hljs-comment">//æœ€ç»ˆç”ŸæˆVnodeå¯¹è±¡</span>
&#125;
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<p><strong>æ€»ç»“</strong>:<code>hå‡½æ•°</code>å…ˆç”Ÿæˆä¸€ä¸ª<code>vnode</code>å‡½æ•°,ç„¶å<code>vnode</code>å‡½æ•°å†ç”Ÿæˆä¸€ä¸ª<code>Vnode</code>å¯¹è±¡(è™šæ‹ŸDOMå¯¹è±¡)</p>
<h4 data-id="heading-13">è¡¥å……:</h4>
<p>åœ¨hå‡½æ•°æºç éƒ¨åˆ†æ¶‰åŠä¸€ä¸ª<code>å‡½æ•°é‡è½½</code>çš„æ¦‚å¿µ,ç®€å•è¯´æ˜ä¸€ä¸‹:</p>
<ul>
<li>å‚æ•°ä¸ªæ•°æˆ–å‚æ•°ç±»å‹ä¸åŒçš„å‡½æ•°()</li>
<li>JavaScriptä¸­æ²¡æœ‰é‡è½½çš„æ¦‚å¿µ</li>
<li>TypeScriptä¸­æœ‰é‡è½½,ä¸è¿‡é‡è½½çš„å®ç°è¿˜æ˜¯é€šè¿‡ä»£ç è°ƒæ•´å‚æ•°</li>
</ul>
<blockquote>
<p>é‡è½½è¿™ä¸ªæ¦‚å¿µä¸ªå‚æ•°ç›¸å…³,å’Œè¿”å›å€¼æ— å…³</p>
</blockquote>
<ul>
<li>å®ä¾‹1(å‡½æ•°é‡è½½-å‚æ•°ä¸ªæ•°)</li>
</ul>
<pre><code class="hljs language-typeScript copyable" lang="typeScript">
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">add</span>(<span class="hljs-params">a:<span class="hljs-built_in">number</span>,b:<span class="hljs-built_in">number</span></span>)</span>&#123;

<span class="hljs-built_in">console</span>.log(a+b)

&#125;

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">add</span>(<span class="hljs-params">a:<span class="hljs-built_in">number</span>,b:<span class="hljs-built_in">number</span>,c:<span class="hljs-built_in">number</span></span>)</span>&#123;

<span class="hljs-built_in">console</span>.log(a+b+c)

&#125;

add(<span class="hljs-number">1</span>,<span class="hljs-number">2</span>)

add(<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>)

<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<ul>
<li>å®ä¾‹2(å‡½æ•°é‡è½½-å‚æ•°ç±»å‹)</li>
</ul>
<pre><code class="hljs language-typeScript copyable" lang="typeScript">
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">add</span>(<span class="hljs-params">a:<span class="hljs-built_in">number</span>,b:<span class="hljs-built_in">number</span></span>)</span>&#123;

<span class="hljs-built_in">console</span>.log(a+b)

&#125;

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">add</span>(<span class="hljs-params">a:<span class="hljs-built_in">number</span>,b:<span class="hljs-built_in">string</span></span>)</span>&#123;

<span class="hljs-built_in">console</span>.log(a+b)

&#125;

add(<span class="hljs-number">1</span>,<span class="hljs-number">2</span>)

add(<span class="hljs-number">1</span>,<span class="hljs-string">'2'</span>)

<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<hr>
<h3 data-id="heading-14">patchå‡½æ•°(æ ¸å¿ƒ)</h3>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6a4b29be73d343dea8d37d902e642eec~tplv-k3u1fbpfcp-watermark.image" alt="src=http___shp.qpic.cn_qqvideo_ori_0_e3012t7v643_496_280_0&refer=http___shp.qpic.jpeg" loading="lazy" referrerpolicy="no-referrer"></p>
<p>è¦æ˜¯çœ‹å®Œå‰é¢çš„é“ºå«,çœ‹åˆ°è¿™é‡Œä½ å¯èƒ½èµ°ç¥äº†,<code>é†’é†’å•Š,è¿™æ˜¯æ ¸å¿ƒå•Š,ä¸Šé«˜åœ°äº†å…„å¼Ÿ</code>;</p>
<ul>
<li>pactch(oldVnode,newVnode)</li>
<li>æŠŠæ–°èŠ‚ç‚¹ä¸­å˜åŒ–çš„å†…å®¹æ¸²æŸ“åˆ°çœŸå®DOM,æœ€åè¿”å›æ–°èŠ‚ç‚¹ä½œä¸ºä¸‹ä¸€æ¬¡å¤„ç†çš„æ—§èŠ‚ç‚¹(æ ¸å¿ƒ)</li>
<li>å¯¹æ¯”æ–°æ—§<code>VNode</code>æ˜¯å¦ç›¸åŒèŠ‚ç‚¹(èŠ‚ç‚¹çš„keyå’Œselç›¸åŒ)</li>
<li>å¦‚æœä¸æ˜¯ç›¸åŒèŠ‚ç‚¹,åˆ é™¤ä¹‹å‰çš„å†…å®¹,é‡æ–°æ¸²æŸ“</li>
<li>å¦‚æœæ˜¯ç›¸åŒèŠ‚ç‚¹,å†åˆ¤æ–­æ–°çš„<code>VNode</code>æ˜¯å¦æœ‰<code>text</code>,å¦‚æœæœ‰å¹¶ä¸”å’Œ<code>oldVnode</code>çš„<code>text</code>ä¸åŒç›´æ¥æ›´æ–°æ–‡æœ¬å†…å®¹<code>(patchVnode)</code></li>
<li>å¦‚æœæ–°çš„VNodeæœ‰children,åˆ¤æ–­å­èŠ‚ç‚¹æ˜¯å¦æœ‰å˜åŒ–<code>(updateChildren,æœ€éº»çƒ¦,æœ€éš¾å®ç°)</code></li>
</ul>
<p>æºç :</p>
<pre><code class="hljs language-javascript copyable" lang="javascript"><span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">patch</span>(<span class="hljs-params">oldVnode: VNode | Element, vnode: VNode</span>): <span class="hljs-title">VNode</span> </span>&#123;    
    <span class="hljs-keyword">let</span> i: number, <span class="hljs-attr">elm</span>: Node, <span class="hljs-attr">parent</span>: Node
    <span class="hljs-keyword">const</span> insertedVnodeQueue: VNodeQueue = []
    <span class="hljs-comment">// cbs.preå°±æ˜¯æ‰€æœ‰æ¨¡å—çš„preé’©å­å‡½æ•°é›†åˆ</span>
    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i < cbs.pre.length; ++i) cbs.pre[i]()
    <span class="hljs-comment">// isVnodeå‡½æ•°æ—¶åˆ¤æ–­oldVnodeæ˜¯å¦æ˜¯ä¸€ä¸ªè™šæ‹ŸDOMå¯¹è±¡</span>
    <span class="hljs-keyword">if</span> (!isVnode(oldVnode)) &#123;
        <span class="hljs-comment">// è‹¥ä¸æ˜¯å³æŠŠElementè½¬æ¢æˆä¸€ä¸ªè™šæ‹ŸDOMå¯¹è±¡</span>
        oldVnode = emptyNodeAt(oldVnode)
    &#125;
    <span class="hljs-comment">// sameVnodeå‡½æ•°ç”¨äºåˆ¤æ–­ä¸¤ä¸ªè™šæ‹ŸDOMæ˜¯å¦æ˜¯ç›¸åŒçš„,æºç è§è¡¥å……1;</span>
    <span class="hljs-keyword">if</span> (sameVnode(oldVnode, vnode)) &#123;
        <span class="hljs-comment">// ç›¸åŒåˆ™è¿è¡ŒpatchVnodeå¯¹æ¯”ä¸¤ä¸ªèŠ‚ç‚¹,å…³äºpatchVnodeåé¢ä¼šé‡ç‚¹è¯´æ˜(æ ¸å¿ƒ)</span>
        patchVnode(oldVnode, vnode, insertedVnodeQueue)
    &#125; <span class="hljs-keyword">else</span> &#123;
        elm = oldVnode.elm! <span class="hljs-comment">// !æ˜¯tsçš„ä¸€ç§å†™æ³•ä»£ç oldVnode.elmè‚¯å®šæœ‰å€¼</span>
        <span class="hljs-comment">// parentNodeå°±æ˜¯è·å–çˆ¶å…ƒç´ </span>
        parent = api.parentNode(elm) <span class="hljs-keyword">as</span> Node

        <span class="hljs-comment">// createElmæ˜¯ç”¨äºåˆ›å»ºä¸€ä¸ªdomå…ƒç´ æ’å…¥åˆ°vnodeä¸­(æ–°çš„è™šæ‹ŸDOM)</span>
        createElm(vnode, insertedVnodeQueue)

        <span class="hljs-keyword">if</span> (parent !== <span class="hljs-literal">null</span>) &#123;
            <span class="hljs-comment">// æŠŠdomå…ƒç´ æ’å…¥åˆ°çˆ¶å…ƒç´ ä¸­,å¹¶ä¸”æŠŠæ—§çš„domåˆ é™¤</span>
            api.insertBefore(parent, vnode.elm!, api.nextSibling(elm))<span class="hljs-comment">// æŠŠæ–°åˆ›å»ºçš„å…ƒç´ æ”¾åœ¨æ—§çš„domåé¢</span>
            removeVnodes(parent, [oldVnode], <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)
        &#125;
    &#125;

    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i < insertedVnodeQueue.length; ++i) &#123;
        insertedVnodeQueue[i].data!.hook!.insert!(insertedVnodeQueue[i])
    &#125;
    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i < cbs.post.length; ++i) cbs.post[i]()
    <span class="hljs-keyword">return</span> vnode
&#125;
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<h4 data-id="heading-15">è¡¥å……1: sameVnodeå‡½æ•°</h4>
<pre><code class="hljs language-javascript copyable" lang="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">sameVnode</span>(<span class="hljs-params">vnode1: VNode, vnode2: VNode</span>): <span class="hljs-title">boolean</span> </span>&#123; é€šè¿‡keyå’Œselé€‰æ‹©å™¨åˆ¤æ–­æ˜¯å¦æ˜¯ç›¸åŒèŠ‚ç‚¹
    <span class="hljs-keyword">return</span> vnode1.key === vnode2.key && vnode1.sel === vnode2.sel
&#125;
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<hr>
<h3 data-id="heading-16">patchVnode</h3>
<ul>
<li>ç¬¬ä¸€é˜¶æ®µè§¦å‘<code>prepatch</code>å‡½æ•°ä»¥åŠ<code>update</code>å‡½æ•°(éƒ½ä¼šè§¦å‘prepatchå‡½æ•°,ä¸¤è€…ä¸å®Œå…¨ç›¸åŒæ‰ä¼šè§¦å‘updateå‡½æ•°)</li>
<li>ç¬¬äºŒé˜¶æ®µ,çœŸæ­£å¯¹æ¯”æ–°æ—§<code>vnode</code>å·®å¼‚çš„åœ°æ–¹</li>
<li>ç¬¬ä¸‰é˜¶æ®µ,è§¦å‘<code>postpatch</code>å‡½æ•°æ›´æ–°èŠ‚ç‚¹</li>
</ul>
<p>æºç :</p>
<pre><code class="hljs language-javascript copyable" lang="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">patchVnode</span>(<span class="hljs-params">oldVnode: VNode, vnode: VNode, insertedVnodeQueue: VNodeQueue</span>) </span>&#123;
    <span class="hljs-keyword">const</span> hook = vnode.data?.hook
    hook?.prepatch?.(oldVnode, vnode)
    <span class="hljs-keyword">const</span> elm = vnode.elm = oldVnode.elm!
    <span class="hljs-keyword">const</span> oldCh = oldVnode.children <span class="hljs-keyword">as</span> VNode[]
    <span class="hljs-keyword">const</span> ch = vnode.children <span class="hljs-keyword">as</span> VNode[]
    <span class="hljs-keyword">if</span> (oldVnode === vnode) <span class="hljs-keyword">return</span>
    <span class="hljs-keyword">if</span> (vnode.data !== <span class="hljs-literal">undefined</span>) &#123;
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i < cbs.update.length; ++i) cbs.update[i](oldVnode, vnode)
        vnode.data.hook?.update?.(oldVnode, vnode)
    &#125;
    <span class="hljs-keyword">if</span> (isUndef(vnode.text)) &#123; <span class="hljs-comment">// æ–°èŠ‚ç‚¹çš„textå±æ€§æ˜¯undefined</span>
        <span class="hljs-keyword">if</span> (isDef(oldCh) && isDef(ch)) &#123; <span class="hljs-comment">// å½“æ–°æ—§èŠ‚ç‚¹éƒ½å­˜åœ¨å­èŠ‚ç‚¹</span>
            <span class="hljs-keyword">if</span> (oldCh !== ch) updateChildren(elm, oldCh, ch, insertedVnodeQueue) <span class="hljs-comment">//å¹¶ä¸”ä»–ä»¬çš„å­èŠ‚ç‚¹ä¸ç›¸åŒæ‰§è¡ŒupdateChildrenå‡½æ•°,åç»­ä¼šé‡ç‚¹è¯´æ˜(æ ¸å¿ƒ)</span>
        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (isDef(ch)) &#123; <span class="hljs-comment">// åªæœ‰æ–°èŠ‚ç‚¹æœ‰å­èŠ‚ç‚¹</span>
            <span class="hljs-comment">// å½“æ—§èŠ‚ç‚¹æœ‰textå±æ€§å°±ä¼šæŠŠ''èµ‹äºˆç»™çœŸå®domçš„textå±æ€§</span>
            <span class="hljs-keyword">if</span> (isDef(oldVnode.text)) api.setTextContent(elm, <span class="hljs-string">''</span>) 
            <span class="hljs-comment">// å¹¶ä¸”æŠŠæ–°èŠ‚ç‚¹çš„æ‰€æœ‰å­èŠ‚ç‚¹æ’å…¥åˆ°çœŸå®domä¸­</span>
            addVnodes(elm, <span class="hljs-literal">null</span>, ch, <span class="hljs-number">0</span>, ch.length - <span class="hljs-number">1</span>, insertedVnodeQueue)
        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (isDef(oldCh)) &#123; <span class="hljs-comment">// æ¸…é™¤çœŸå®domçš„æ‰€æœ‰å­èŠ‚ç‚¹</span>
            removeVnodes(elm, oldCh, <span class="hljs-number">0</span>, oldCh.length - <span class="hljs-number">1</span>)
        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (isDef(oldVnode.text)) &#123; <span class="hljs-comment">// æŠŠ''èµ‹äºˆç»™çœŸå®domçš„textå±æ€§</span>
            api.setTextContent(elm, <span class="hljs-string">''</span>)
        &#125;
    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (oldVnode.text !== vnode.text) &#123; <span class="hljs-comment">//è‹¥æ—§èŠ‚ç‚¹çš„textä¸æ–°èŠ‚ç‚¹çš„textä¸ç›¸åŒ</span>
        <span class="hljs-keyword">if</span> (isDef(oldCh)) &#123; <span class="hljs-comment">// è‹¥æ—§èŠ‚ç‚¹æœ‰å­èŠ‚ç‚¹,å°±æŠŠæ‰€æœ‰çš„å­èŠ‚ç‚¹åˆ é™¤</span>
            removeVnodes(elm, oldCh, <span class="hljs-number">0</span>, oldCh.length - <span class="hljs-number">1</span>)
        &#125;
        api.setTextContent(elm, vnode.text!) <span class="hljs-comment">// æŠŠæ–°èŠ‚ç‚¹çš„textèµ‹äºˆç»™çœŸå®dom</span>
    &#125;
    hook?.postpatch?.(oldVnode, vnode) <span class="hljs-comment">// æ›´æ–°è§†å›¾</span>
&#125;
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<p>çœ‹å¾—å¯èƒ½æœ‰ç‚¹è’™è”½,ä¸‹é¢å†ä¸Šä¸€å‰¯æ€ç»´å¯¼å›¾:</p>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/10b1affc940944fbb104690244932283~tplv-k3u1fbpfcp-watermark.image" alt="image.png" loading="lazy" referrerpolicy="no-referrer"></p>
<hr>
<h3 data-id="heading-17">é¢˜å¤–è¯:diffç®—æ³•ç®€ä»‹</h3>
<p><strong>ä¼ ç»Ÿdiffç®—æ³•</strong></p>
<ul>
<li>è™šæ‹ŸDOMä¸­çš„Diffç®—æ³•</li>
<li><code>ä¼ ç»Ÿç®—æ³•</code>æŸ¥æ‰¾ä¸¤é¢—æ ‘æ¯ä¸€ä¸ªèŠ‚ç‚¹çš„å·®å¼‚</li>
<li>ä¼šè¿è¡Œn1(dom1çš„èŠ‚ç‚¹æ•°)*n2(dom2çš„èŠ‚ç‚¹æ•°)æ¬¡æ–¹å»å¯¹æ¯”,æ‰¾åˆ°å·®å¼‚çš„éƒ¨åˆ†å†å»æ›´æ–°</li>
</ul>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/55d7da430d3d4bdf8d5a12a146f7bf59~tplv-k3u1fbpfcp-watermark.image" alt="image.png" loading="lazy" referrerpolicy="no-referrer"></p>
<p><strong>snabbdomçš„diffç®—æ³•ä¼˜åŒ–</strong></p>
<ul>
<li>Snbbdomæ ¹æ®DOMçš„ç‰¹ç‚¹å¯¹ä¼ ç»Ÿçš„diffç®—æ³•åšäº†<code>ä¼˜åŒ–</code></li>
<li>DOMæ“ä½œæ—¶å€™å¾ˆå°‘ä¼šè·¨çº§åˆ«æ“ä½œèŠ‚ç‚¹</li>
<li>åªæ¯”è¾ƒ<code>åŒçº§åˆ«</code>çš„èŠ‚ç‚¹</li>
</ul>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d06c2b90434b444d9bb8dc4d582de342~tplv-k3u1fbpfcp-watermark.image" alt="image.png" loading="lazy" referrerpolicy="no-referrer"></p>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/929562921ff94914bbe60647ad891104~tplv-k3u1fbpfcp-watermark.image" alt="src=http___img.wxcha.com_file_202004_03_1ed2e19e4f.jpg&refer=http___img.wxcha.jpeg" loading="lazy" referrerpolicy="no-referrer"></p>
<p>ä¸‹é¢æˆ‘ä»¬å°±ä¼šä»‹ç»<code>updateChildren</code>å‡½æ•°æ€ä¹ˆå»å¯¹æ¯”å­èŠ‚ç‚¹çš„<code>å¼‚åŒ</code>,ä¹Ÿæ˜¯<code>Diffç®—æ³•</code>é‡Œé¢çš„ä¸€ä¸ªæ ¸å¿ƒä»¥åŠéš¾ç‚¹;</p>
<hr>
<h3 data-id="heading-18">updateChildren(æ ¸ä¸­æ ¸:åˆ¤æ–­å­èŠ‚ç‚¹çš„å·®å¼‚)</h3>
<ul>
<li>è¿™ä¸ªå‡½æ•°æˆ‘åˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†,<code>éƒ¨åˆ†1:å£°æ˜å˜é‡</code>,<code>éƒ¨åˆ†2:åŒçº§åˆ«èŠ‚ç‚¹æ¯”è¾ƒ</code>,<code>éƒ¨åˆ†3:å¾ªç¯ç»“æŸçš„æ”¶å°¾å·¥ä½œ</code>(è§ä¸‹å›¾);</li>
</ul>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f17a869ef82e434ba4bdeb11a7c54e55~tplv-k3u1fbpfcp-watermark.image" alt="image.png" loading="lazy" referrerpolicy="no-referrer"></p>
<ul>
<li><code>åŒçº§åˆ«èŠ‚ç‚¹æ¯”è¾ƒ</code>çš„<code>äº”ç§</code>æƒ…å†µ:
<ol>
<li><code>oldStartVnode/newStartVnode</code>(æ—§å¼€å§‹èŠ‚ç‚¹/æ–°å¼€å§‹èŠ‚ç‚¹)ç›¸åŒ</li>
<li><code>oldEndVnode/newEndVnode</code>(æ—§ç»“æŸèŠ‚ç‚¹/æ–°ç»“æŸèŠ‚ç‚¹)ç›¸åŒ</li>
<li><code>oldStartVnode/newEndVnode</code>(æ—§å¼€å§‹èŠ‚ç‚¹/æ–°ç»“æŸèŠ‚ç‚¹)ç›¸åŒ</li>
<li><code>oldEndVnode/newStartVnode</code>(æ—§ç»“æŸèŠ‚ç‚¹/æ–°å¼€å§‹èŠ‚ç‚¹)ç›¸åŒ</li>
<li><code>ç‰¹æ®Šæƒ…å†µå½“1,2,3,4çš„æƒ…å†µéƒ½ä¸ç¬¦åˆ</code>çš„æ—¶å€™å°±ä¼šæ‰§è¡Œ,åœ¨<code>oldVnodes</code>é‡Œé¢å¯»æ‰¾è·Ÿ<code>newStartVnode</code>ä¸€æ ·çš„èŠ‚ç‚¹ç„¶åä½ç§»åˆ°<code>oldStartVnode</code>,è‹¥æ²¡æœ‰æ‰¾åˆ°åœ¨å°±<code>oldStartVnode</code>åˆ›å»ºä¸€ä¸ª</li>
</ol>
</li>
<li>æ‰§è¡Œè¿‡ç¨‹æ˜¯ä¸€ä¸ªå¾ªç¯,åœ¨æ¯æ¬¡å¾ªç¯é‡Œ,åªè¦æ‰§è¡Œäº†ä¸Šè¿°çš„æƒ…å†µçš„äº”ç§ä¹‹ä¸€å°±ä¼šç»“æŸä¸€æ¬¡å¾ªç¯</li>
<li><code>å¾ªç¯ç»“æŸçš„æ”¶å°¾å·¥ä½œ</code>:ç›´åˆ°oldStartIdx>oldEndIdx || newStartIdx>newEndIdx(ä»£è¡¨æ—§èŠ‚ç‚¹æˆ–è€…æ–°èŠ‚ç‚¹å·²ç»éå†å®Œ)</li>
</ul>
<p>ä¸ºäº†æ›´åŠ ç›´è§‚çš„äº†è§£,æˆ‘ä»¬å†æ¥çœ‹çœ‹<code>åŒçº§åˆ«èŠ‚ç‚¹æ¯”è¾ƒ</code>çš„<code>äº”ç§</code>æƒ…å†µçš„å®ç°ç»†èŠ‚:</p>
<h4 data-id="heading-19">æ–°å¼€å§‹èŠ‚ç‚¹å’Œæ—§å¼€å§‹èŠ‚ç‚¹(æƒ…å†µ1)</h4>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ffcab05bd82243eca7db4c759d8e1c2f~tplv-k3u1fbpfcp-watermark.image" alt="image.png" loading="lazy" referrerpolicy="no-referrer"></p>
<ul>
<li>è‹¥<code>æƒ…å†µ1ç¬¦åˆ:(ä»æ–°æ—§èŠ‚ç‚¹çš„å¼€å§‹èŠ‚ç‚¹å¼€å§‹å¯¹æ¯”</code>,<code>oldCh[oldStartIdx]å’ŒnewCh[newStartIdx]</code>è¿›è¡Œ<code>sameVnode(keyå’Œselç›¸åŒ)</code>åˆ¤æ–­æ˜¯å¦ç›¸åŒèŠ‚ç‚¹)</li>
<li>åˆ™æ‰§è¡Œ<code>patchVnode</code>æ‰¾å‡ºä¸¤è€…ä¹‹é—´çš„å·®å¼‚,æ›´æ–°å›¾;å¦‚æ²¡æœ‰å·®å¼‚åˆ™ä»€ä¹ˆéƒ½ä¸æ“ä½œ,ç»“æŸä¸€æ¬¡å¾ªç¯</li>
<li><code>oldStartIdx++/newStartIdx++</code></li>
</ul>
<h4 data-id="heading-20">æ–°ç»“æŸèŠ‚ç‚¹å’Œæ—§ç»“æŸèŠ‚ç‚¹(æƒ…å†µ2)</h4>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/97bcd272a2bf47e9b027daa9408641dd~tplv-k3u1fbpfcp-watermark.image" alt="image.png" loading="lazy" referrerpolicy="no-referrer"></p>
<ul>
<li>è‹¥<code>æƒ…å†µ1ä¸ç¬¦åˆ</code>å°±åˆ¤æ–­<code>æƒ…å†µ2</code>,è‹¥ç¬¦åˆ:(ä»æ–°æ—§èŠ‚ç‚¹çš„ç»“æŸèŠ‚ç‚¹å¼€å§‹å¯¹æ¯”,<code>oldCh[oldEndIdx]å’ŒnewCh[newEndIdx]</code>å¯¹æ¯”,æ‰§è¡Œ<code>sameVnode(keyå’Œselç›¸åŒ)</code>åˆ¤æ–­æ˜¯å¦ç›¸åŒèŠ‚ç‚¹)</li>
<li>æ‰§è¡Œ<code>patchVnode</code>æ‰¾å‡ºä¸¤è€…ä¹‹é—´çš„å·®å¼‚,æ›´æ–°è§†å›¾,;å¦‚æ²¡æœ‰å·®å¼‚åˆ™ä»€ä¹ˆéƒ½ä¸æ“ä½œ,ç»“æŸä¸€æ¬¡å¾ªç¯</li>
<li><code>oldEndIdx--/newEndIdx--</code></li>
</ul>
<h4 data-id="heading-21">æ—§å¼€å§‹èŠ‚ç‚¹/æ–°ç»“æŸèŠ‚ç‚¹(æƒ…å†µ3)</h4>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/043575e806d04e37aca08b3bafdd006b~tplv-k3u1fbpfcp-watermark.image" alt="image.png" loading="lazy" referrerpolicy="no-referrer"></p>
<ul>
<li>è‹¥<code>æƒ…å†µ1,2</code>éƒ½ä¸ç¬¦åˆ,å°±ä¼šå°è¯•æƒ…å†µ3:(æ—§èŠ‚ç‚¹çš„å¼€å§‹èŠ‚ç‚¹ä¸æ–°èŠ‚ç‚¹çš„ç»“æŸèŠ‚ç‚¹å¼€å§‹å¯¹æ¯”,<code>oldCh[oldStartIdx]å’ŒnewCh[newEndIdx]</code>å¯¹æ¯”,æ‰§è¡Œ<code>sameVnode(keyå’Œselç›¸åŒ)</code>åˆ¤æ–­æ˜¯å¦ç›¸åŒèŠ‚ç‚¹)</li>
<li>æ‰§è¡Œ<code>patchVnode</code>æ‰¾å‡ºä¸¤è€…ä¹‹é—´çš„å·®å¼‚,æ›´æ–°è§†å›¾,å¦‚æ²¡æœ‰å·®å¼‚åˆ™ä»€ä¹ˆéƒ½ä¸æ“ä½œ,ç»“æŸä¸€æ¬¡å¾ªç¯</li>
<li><code>oldCh[oldStartIdx]å¯¹åº”çš„çœŸå®dom</code>ä½ç§»åˆ°<code>oldCh[oldEndIdx]å¯¹åº”çš„çœŸå®dom</code>å</li>
<li><code>oldStartIdx++/newEndIdx--</code>;</li>
</ul>
<h4 data-id="heading-22">æ—§ç»“æŸèŠ‚ç‚¹/æ–°å¼€å§‹èŠ‚ç‚¹(æƒ…å†µ4)</h4>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7c70a031047848baacc349c4ea36de7a~tplv-k3u1fbpfcp-watermark.image" alt="image.png" loading="lazy" referrerpolicy="no-referrer"></p>
<ul>
<li>è‹¥<code>æƒ…å†µ1,2,3</code>éƒ½ä¸ç¬¦åˆ,å°±ä¼šå°è¯•æƒ…å†µ4:(æ—§èŠ‚ç‚¹çš„ç»“æŸèŠ‚ç‚¹ä¸æ–°èŠ‚ç‚¹çš„å¼€å§‹èŠ‚ç‚¹å¼€å§‹å¯¹æ¯”,<code>oldCh[oldEndIdx]å’ŒnewCh[newStartIdx]</code>å¯¹æ¯”,æ‰§è¡Œ<code>sameVnode(keyå’Œselç›¸åŒ)</code>åˆ¤æ–­æ˜¯å¦ç›¸åŒèŠ‚ç‚¹)</li>
<li>æ‰§è¡Œ<code>patchVnode</code>æ‰¾å‡ºä¸¤è€…ä¹‹é—´çš„å·®å¼‚,æ›´æ–°è§†å›¾,å¦‚æ²¡æœ‰å·®å¼‚åˆ™ä»€ä¹ˆéƒ½ä¸æ“ä½œ,ç»“æŸä¸€æ¬¡å¾ªç¯</li>
<li><code>oldCh[oldEndIdx]å¯¹åº”çš„çœŸå®dom</code>ä½ç§»åˆ°<code>oldCh[oldStartIdx]å¯¹åº”çš„çœŸå®dom</code>å‰</li>
<li><code>oldEndIdx--/newStartIdx++</code>;</li>
</ul>
<h4 data-id="heading-23">æ–°å¼€å§‹èŠ‚ç‚¹/æ—§èŠ‚ç‚¹æ•°ç»„ä¸­å¯»æ‰¾èŠ‚ç‚¹(æƒ…å†µ5)</h4>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/23c6682b562a4a7096b5e89364cc62e7~tplv-k3u1fbpfcp-watermark.image" alt="image.png" loading="lazy" referrerpolicy="no-referrer"></p>
<ul>
<li>ä»æ—§èŠ‚ç‚¹é‡Œé¢å¯»æ‰¾,è‹¥å¯»æ‰¾åˆ°ä¸<code>newCh[newStartIdx]</code>ç›¸åŒçš„èŠ‚ç‚¹(ä¸”å«<code>å¯¹åº”èŠ‚ç‚¹[1]</code>),æ‰§è¡Œ<code>patchVnode</code>æ‰¾å‡ºä¸¤è€…ä¹‹é—´çš„å·®å¼‚,æ›´æ–°è§†å›¾,å¦‚æ²¡æœ‰å·®å¼‚åˆ™ä»€ä¹ˆéƒ½ä¸æ“ä½œ,ç»“æŸä¸€æ¬¡å¾ªç¯</li>
<li><code>å¯¹åº”èŠ‚ç‚¹[1]å¯¹åº”çš„çœŸå®dom</code>ä½ç§»åˆ°<code>oldCh[oldStartIdx]å¯¹åº”çš„çœŸå®dom</code>å‰</li>
</ul>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7c2c1e87841c4693836dd6f45e8abdd7~tplv-k3u1fbpfcp-watermark.image" alt="image.png" loading="lazy" referrerpolicy="no-referrer"></p>
<ul>
<li><code>è‹¥æ²¡æœ‰å¯»æ‰¾åˆ°ç›¸åŒçš„èŠ‚ç‚¹</code>,åˆ™åˆ›å»ºä¸€ä¸ªä¸<code>newCh[newStartIdx]</code>èŠ‚ç‚¹å¯¹åº”çš„<code>çœŸå®dom</code>æ’å…¥åˆ°<code>oldCh[oldStartIdx]å¯¹åº”çš„çœŸå®dom</code>å‰</li>
<li><code>newStartIdx++</code></li>
</ul>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/bd371150ce274b59a978f5301c57b79a~tplv-k3u1fbpfcp-watermark.image" alt="379426071b8130075b11ba142f9468e2.jpeg" loading="lazy" referrerpolicy="no-referrer"></p>
<hr>
<p>ä¸‹é¢æˆ‘ä»¬å†ä»‹ç»ä¸€ä¸‹<code>ç»“æŸå¾ªç¯</code>çš„æ”¶å°¾å·¥ä½œ<code>(oldStartIdx>oldEndIdx || newStartIdx>newEndIdx)</code>:</p>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e38af32ad3cc4e8381a6e7606056015f~tplv-k3u1fbpfcp-watermark.image" alt="image.png" loading="lazy" referrerpolicy="no-referrer"></p>
<ul>
<li><code>æ–°èŠ‚ç‚¹çš„æ‰€æœ‰å­èŠ‚ç‚¹</code>å…ˆéå†å®Œ(<code>newStartIdx>newEndIdx</code>),å¾ªç¯ç»“æŸ</li>
<li><code>æ–°èŠ‚ç‚¹çš„æ‰€æœ‰å­èŠ‚ç‚¹</code>éå†ç»“æŸå°±æ˜¯æŠŠæ²¡æœ‰å¯¹åº”ç›¸åŒèŠ‚ç‚¹çš„<code>å­èŠ‚ç‚¹</code>åˆ é™¤</li>
</ul>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/84b09cb6e4bc4d68bb7d0615c58047f8~tplv-k3u1fbpfcp-watermark.image" alt="image.png" loading="lazy" referrerpolicy="no-referrer"></p>
<ul>
<li><code>æ—§èŠ‚ç‚¹çš„æ‰€æœ‰å­èŠ‚ç‚¹</code>å…ˆéå†å®Œ(<code>oldStartIdx>oldEndIdx</code>),å¾ªç¯ç»“æŸ</li>
<li><code>æ—§èŠ‚ç‚¹çš„æ‰€æœ‰å­èŠ‚ç‚¹</code>éå†ç»“æŸå°±æ˜¯åœ¨å¤šå‡ºæ¥çš„<code>å­èŠ‚ç‚¹</code>æ’å…¥åˆ°<code>æ—§èŠ‚ç‚¹ç»“æŸèŠ‚ç‚¹</code>å‰;(æºç :<code>newCh[newEndIdx + 1].elm)</code>,å°±æ˜¯å¯¹åº”çš„<code>æ—§ç»“æŸèŠ‚ç‚¹çš„çœŸå®dom</code>,newEndIdx+1æ˜¯å› ä¸ºåœ¨åŒ¹é…åˆ°ç›¸åŒçš„èŠ‚ç‚¹éœ€è¦-1,æ‰€ä»¥éœ€è¦åŠ å›æ¥å°±æ˜¯ç»“æŸèŠ‚ç‚¹</li>
</ul>
<p>æœ€åé™„ä¸Šæºç :</p>
<pre><code class="hljs language-javascript copyable" lang="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">updateChildren</span>(<span class="hljs-params">parentElm, oldCh, newCh, insertedVnodeQueue</span>) </span>&#123;
    <span class="hljs-keyword">let</span> oldStartIdx = <span class="hljs-number">0</span>;                <span class="hljs-comment">// æ—§èŠ‚ç‚¹å¼€å§‹èŠ‚ç‚¹ç´¢å¼•</span>
    <span class="hljs-keyword">let</span> newStartIdx = <span class="hljs-number">0</span>;                <span class="hljs-comment">// æ–°èŠ‚ç‚¹å¼€å§‹èŠ‚ç‚¹ç´¢å¼•</span>
    <span class="hljs-keyword">let</span> oldEndIdx = oldCh.length - <span class="hljs-number">1</span>;   <span class="hljs-comment">// æ—§èŠ‚ç‚¹ç»“æŸèŠ‚ç‚¹ç´¢å¼•</span>
    <span class="hljs-keyword">let</span> oldStartVnode = oldCh[<span class="hljs-number">0</span>];       <span class="hljs-comment">// æ—§èŠ‚ç‚¹å¼€å§‹èŠ‚ç‚¹</span>
    <span class="hljs-keyword">let</span> oldEndVnode = oldCh[oldEndIdx]; <span class="hljs-comment">// æ—§èŠ‚ç‚¹ç»“æŸèŠ‚ç‚¹</span>
    <span class="hljs-keyword">let</span> newEndIdx = newCh.length - <span class="hljs-number">1</span>;   <span class="hljs-comment">// æ–°èŠ‚ç‚¹ç»“æŸèŠ‚ç‚¹ç´¢å¼•</span>
    <span class="hljs-keyword">let</span> newStartVnode = newCh[<span class="hljs-number">0</span>];       <span class="hljs-comment">// æ–°èŠ‚ç‚¹å¼€å§‹èŠ‚ç‚¹</span>
    <span class="hljs-keyword">let</span> newEndVnode = newCh[newEndIdx]; <span class="hljs-comment">// æ–°èŠ‚ç‚¹ç»“æŸèŠ‚ç‚¹</span>
    <span class="hljs-keyword">let</span> oldKeyToIdx;                    <span class="hljs-comment">// èŠ‚ç‚¹ç§»åŠ¨ç›¸å…³</span>
    <span class="hljs-keyword">let</span> idxInOld;                       <span class="hljs-comment">// èŠ‚ç‚¹ç§»åŠ¨ç›¸å…³</span>
    <span class="hljs-keyword">let</span> elmToMove;                      <span class="hljs-comment">// èŠ‚ç‚¹ç§»åŠ¨ç›¸å…³</span>
    <span class="hljs-keyword">let</span> before;


    <span class="hljs-comment">// åŒçº§åˆ«èŠ‚ç‚¹æ¯”è¾ƒ</span>
    <span class="hljs-keyword">while</span> (oldStartIdx <= oldEndIdx && newStartIdx <= newEndIdx) &#123;
        <span class="hljs-keyword">if</span> (oldStartVnode == <span class="hljs-literal">null</span>) &#123;
            oldStartVnode = oldCh[++oldStartIdx]; <span class="hljs-comment">// Vnode might have been moved left</span>
        &#125;
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (oldEndVnode == <span class="hljs-literal">null</span>) &#123;
            oldEndVnode = oldCh[--oldEndIdx];
        &#125;
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (newStartVnode == <span class="hljs-literal">null</span>) &#123;
            newStartVnode = newCh[++newStartIdx];
        &#125;
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (newEndVnode == <span class="hljs-literal">null</span>) &#123;
            newEndVnode = newCh[--newEndIdx];
        &#125;
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (sameVnode(oldStartVnode, newStartVnode)) &#123; <span class="hljs-comment">// åˆ¤æ–­æƒ…å†µ1</span>
            patchVnode(oldStartVnode, newStartVnode, insertedVnodeQueue);
            oldStartVnode = oldCh[++oldStartIdx];
            newStartVnode = newCh[++newStartIdx];
        &#125;
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (sameVnode(oldEndVnode, newEndVnode)) &#123;   <span class="hljs-comment">// æƒ…å†µ2</span>
            patchVnode(oldEndVnode, newEndVnode, insertedVnodeQueue);
            oldEndVnode = oldCh[--oldEndIdx];
            newEndVnode = newCh[--newEndIdx];
        &#125;
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (sameVnode(oldStartVnode, newEndVnode)) &#123; <span class="hljs-comment">// Vnode moved rightæƒ…å†µ3</span>
            patchVnode(oldStartVnode, newEndVnode, insertedVnodeQueue);
            api.insertBefore(parentElm, oldStartVnode.elm, api.nextSibling(oldEndVnode.elm));
            oldStartVnode = oldCh[++oldStartIdx];
            newEndVnode = newCh[--newEndIdx];
        &#125;
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (sameVnode(oldEndVnode, newStartVnode)) &#123; <span class="hljs-comment">// Vnode moved leftæƒ…å†µ4</span>
            patchVnode(oldEndVnode, newStartVnode, insertedVnodeQueue);
            api.insertBefore(parentElm, oldEndVnode.elm, oldStartVnode.elm);
            oldEndVnode = oldCh[--oldEndIdx];
            newStartVnode = newCh[++newStartIdx];
        &#125;
        <span class="hljs-keyword">else</span> &#123;                                             <span class="hljs-comment">// æƒ…å†µ5</span>
            <span class="hljs-keyword">if</span> (oldKeyToIdx === <span class="hljs-literal">undefined</span>) &#123;
                oldKeyToIdx = createKeyToOldIdx(oldCh, oldStartIdx, oldEndIdx);
            &#125;
            idxInOld = oldKeyToIdx[newStartVnode.key];
            <span class="hljs-keyword">if</span> (isUndef(idxInOld)) &#123; <span class="hljs-comment">// New element        // åˆ›å»ºæ–°çš„èŠ‚ç‚¹åœ¨æ—§èŠ‚ç‚¹çš„æ–°èŠ‚ç‚¹å‰</span>
                api.insertBefore(parentElm, createElm(newStartVnode, insertedVnodeQueue), oldStartVnode.elm);
            &#125;
            <span class="hljs-keyword">else</span> &#123;
                elmToMove = oldCh[idxInOld];
                <span class="hljs-keyword">if</span> (elmToMove.sel !== newStartVnode.sel) &#123; <span class="hljs-comment">// åˆ›å»ºæ–°çš„èŠ‚ç‚¹åœ¨æ—§èŠ‚ç‚¹çš„æ–°èŠ‚ç‚¹å‰</span>
                    api.insertBefore(parentElm, createElm(newStartVnode, insertedVnodeQueue), oldStartVnode.elm);
                &#125;
                <span class="hljs-keyword">else</span> &#123;
                                                           <span class="hljs-comment">// åœ¨æ—§èŠ‚ç‚¹æ•°ç»„ä¸­æ‰¾åˆ°ç›¸åŒçš„èŠ‚ç‚¹å°±å¯¹æ¯”å·®å¼‚æ›´æ–°è§†å›¾,ç„¶åç§»åŠ¨ä½ç½®</span>
                    patchVnode(elmToMove, newStartVnode, insertedVnodeQueue);
                    oldCh[idxInOld] = <span class="hljs-literal">undefined</span>;
                    api.insertBefore(parentElm, elmToMove.elm, oldStartVnode.elm);
                &#125;
            &#125;
            newStartVnode = newCh[++newStartIdx];
        &#125;
    &#125;
    <span class="hljs-comment">// å¾ªç¯ç»“æŸçš„æ”¶å°¾å·¥ä½œ</span>
    <span class="hljs-keyword">if</span> (oldStartIdx <= oldEndIdx || newStartIdx <= newEndIdx) &#123;
        <span class="hljs-keyword">if</span> (oldStartIdx > oldEndIdx) &#123;
            <span class="hljs-comment">// newCh[newEndIdx + 1].elmå°±æ˜¯æ—§èŠ‚ç‚¹æ•°ç»„ä¸­çš„ç»“æŸèŠ‚ç‚¹å¯¹åº”çš„domå…ƒç´ </span>
            <span class="hljs-comment">// newEndIdx+1æ˜¯å› ä¸ºåœ¨ä¹‹å‰æˆåŠŸåŒ¹é…äº†newEndIdxéœ€è¦-1</span>
            <span class="hljs-comment">// newCh[newEndIdx + 1].elm,å› ä¸ºå·²ç»åŒ¹é…è¿‡æœ‰ç›¸åŒçš„èŠ‚ç‚¹äº†,å®ƒå°±æ˜¯ç­‰äºæ—§èŠ‚ç‚¹æ•°ç»„ä¸­çš„ç»“æŸèŠ‚ç‚¹å¯¹åº”çš„domå…ƒç´ (oldCh[oldEndIdx + 1].elm)</span>
            before = newCh[newEndIdx + <span class="hljs-number">1</span>] == <span class="hljs-literal">null</span> ? <span class="hljs-literal">null</span> : newCh[newEndIdx + <span class="hljs-number">1</span>].elm;
            <span class="hljs-comment">// æŠŠæ–°èŠ‚ç‚¹æ•°ç»„ä¸­å¤šå‡ºæ¥çš„èŠ‚ç‚¹æ’å…¥åˆ°beforeå‰</span>
            addVnodes(parentElm, before, newCh, newStartIdx, newEndIdx, insertedVnodeQueue);
        &#125;
        <span class="hljs-keyword">else</span> &#123;
            <span class="hljs-comment">// è¿™é‡Œå°±æ˜¯æŠŠæ²¡æœ‰åŒ¹é…åˆ°ç›¸åŒèŠ‚ç‚¹çš„èŠ‚ç‚¹åˆ é™¤æ‰</span>
            removeVnodes(parentElm, oldCh, oldStartIdx, oldEndIdx);
        &#125;
    &#125;
&#125;
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<hr>
<h4 data-id="heading-24">keyçš„ä½œç”¨</h4>
<ul>
<li>Diffæ“ä½œå¯ä»¥<code>æ›´åŠ å¿«é€Ÿ</code>;</li>
<li>Diffæ“ä½œå¯ä»¥æ›´åŠ å‡†ç¡®;<code>(é¿å…æ¸²æŸ“é”™è¯¯)</code></li>
<li><code>ä¸æ¨èä½¿ç”¨ç´¢å¼•</code>ä½œä¸ºkey</li>
</ul>
<p>ä»¥ä¸‹æˆ‘ä»¬çœ‹çœ‹è¿™äº›ä½œç”¨çš„å®ä¾‹:</p>
<h5 data-id="heading-25">Diffæ“ä½œå¯ä»¥æ›´åŠ å‡†ç¡®;<code>(é¿å…æ¸²æŸ“é”™è¯¯)</code>:</h5>
<p>å®ä¾‹:a,b,cä¸‰ä¸ªdomå…ƒç´ ä¸­çš„b,cé—´æ’å…¥ä¸€ä¸ªzå…ƒç´ </p>
<p>æ²¡æœ‰è®¾ç½®key
<img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/fc841403d3874843adeb339feb901215~tplv-k3u1fbpfcp-watermark.image" alt="image.png" loading="lazy" referrerpolicy="no-referrer">
å½“è®¾ç½®äº†key:</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/cf9ebd75b8ed4d85a2e015420c20c7e1~tplv-k3u1fbpfcp-watermark.image" alt="image.png" loading="lazy" referrerpolicy="no-referrer"></p>
<h5 data-id="heading-26">Diffæ“ä½œå¯ä»¥æ›´åŠ å‡†ç¡®;<code>(é¿å…æ¸²æŸ“é”™è¯¯)</code></h5>
<p>å®ä¾‹:a,b,cä¸‰ä¸ªdomå…ƒç´ ,ä¿®æ”¹äº†aå…ƒç´ çš„æŸä¸ªå±æ€§å†å»åœ¨aå…ƒç´ å‰æ–°å¢ä¸€ä¸ªzå…ƒç´ </p>
<p>æ²¡æœ‰è®¾ç½®key:</p>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d00cd0de9dd140b184b3dd0d10200d3c~tplv-k3u1fbpfcp-watermark.image" alt="image.png" loading="lazy" referrerpolicy="no-referrer"></p>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/25a742557b014b7685dc7ecc2b5d941a~tplv-k3u1fbpfcp-watermark.image" alt="image.png" loading="lazy" referrerpolicy="no-referrer"></p>
<p>å› ä¸ºæ²¡æœ‰è®¾ç½®key,é»˜è®¤éƒ½æ˜¯undefined,æ‰€ä»¥èŠ‚ç‚¹éƒ½æ˜¯ç›¸åŒçš„,æ›´æ–°äº†textçš„å†…å®¹ä½†è¿˜æ˜¯æ²¿ç”¨äº†ä¹‹å‰çš„dom,æ‰€ä»¥å®é™…ä¸Š<code>a->z(aåŸæœ¬æ‰“å‹¾çš„çŠ¶æ€ä¿ç•™äº†,åªæ”¹å˜äº†text),b->a,c->b,d->c</code>,éå†å®Œæ¯•å‘ç°è¿˜è¦å¢åŠ ä¸€ä¸ªdom,åœ¨æœ€åæ–°å¢ä¸€ä¸ªtextä¸ºdçš„domå…ƒç´ </p>
<p>è®¾ç½®äº†key:</p>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/27c94fa1135b4d6a8aaa74ecd53f515a~tplv-k3u1fbpfcp-watermark.image" alt="image.png" loading="lazy" referrerpolicy="no-referrer"></p>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/af7ab3ff46724f6b8f836fb5c0860644~tplv-k3u1fbpfcp-watermark.image" alt="image.png" loading="lazy" referrerpolicy="no-referrer"></p>
<p>å½“è®¾ç½®äº†key,a,b,c,déƒ½æœ‰å¯¹åº”çš„key,<code>a->a,b->b,c->c,d->d</code>,å†…å®¹ç›¸åŒæ— éœ€æ›´æ–°,éå†ç»“æŸ,æ–°å¢ä¸€ä¸ªtextä¸ºzçš„domå…ƒç´ </p>
<h5 data-id="heading-27"><code>ä¸æ¨èä½¿ç”¨ç´¢å¼•</code>ä½œä¸ºkey:</h5>
<p>è®¾ç½®ç´¢å¼•ä¸ºkey:</p>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/df0109381ef04b9c90d35be0dcf9f0dc~tplv-k3u1fbpfcp-watermark.image" alt="image.png" loading="lazy" referrerpolicy="no-referrer"></p>
<p>è¿™æ˜æ˜¾æ•ˆç‡ä¸é«˜,æˆ‘ä»¬åªå¸Œæœ›æ‰¾å‡ºä¸åŒçš„èŠ‚ç‚¹æ›´æ–°,è€Œä½¿ç”¨ç´¢å¼•ä½œä¸ºkeyä¼šå¢åŠ è¿ç®—æ—¶é—´,æˆ‘ä»¬å¯ä»¥æŠŠkeyè®¾ç½®ä¸ºä¸èŠ‚ç‚¹textä¸ºä¸€è‡´å°±å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜:</p>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/803ebdd0db5b40f8b6cfb8dfc6721ebe~tplv-k3u1fbpfcp-watermark.image" alt="image.png" loading="lazy" referrerpolicy="no-referrer"></p>
<hr>
<h2 data-id="heading-28">æœ€å</h2>
<p>å¦‚æœ‰æè¿°é”™è¯¯æˆ–è€…ä¸æ˜çš„åœ°æ–¹è¯·åœ¨ä¸‹æ–¹è¯„è®ºè”ç³»æˆ‘,æˆ‘ä¼šç«‹åˆ»æ›´æ–°,å¦‚æœ‰æ”¶è·,è¯·ä¸ºæˆ‘ç‚¹ä¸ªèµğŸ‘è¿™æ˜¯å¯¹æˆ‘çš„è«å¤§çš„æ”¯æŒ,è°¢è°¢å„ä½</p></div>  
</div>
            