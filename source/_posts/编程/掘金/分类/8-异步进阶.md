
---
title: '8-异步进阶'
categories: 
 - 编程
 - 掘金
 - 分类
headimg: 'https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/61c6b1d969174899b875ffeb782d6915~tplv-k3u1fbpfcp-watermark.image'
author: 掘金
comments: false
date: Tue, 29 Jun 2021 08:08:12 GMT
thumbnail: 'https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/61c6b1d969174899b875ffeb782d6915~tplv-k3u1fbpfcp-watermark.image'
---

<div>   
<div class="markdown-body"><style>.markdown-body&#123;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333&#125;.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6&#123;line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px&#125;.markdown-body h1&#123;font-size:30px;margin-bottom:5px&#125;.markdown-body h2&#123;padding-bottom:12px;font-size:24px;border-bottom:1px solid #ececec&#125;.markdown-body h3&#123;font-size:18px;padding-bottom:0&#125;.markdown-body h4&#123;font-size:16px&#125;.markdown-body h5&#123;font-size:15px&#125;.markdown-body h6&#123;margin-top:5px&#125;.markdown-body p&#123;line-height:inherit;margin-top:22px;margin-bottom:22px&#125;.markdown-body img&#123;max-width:100%&#125;.markdown-body hr&#123;border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px&#125;.markdown-body code&#123;word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em&#125;.markdown-body code,.markdown-body pre&#123;font-family:Menlo,Monaco,Consolas,Courier New,monospace&#125;.markdown-body pre&#123;overflow:auto;position:relative;line-height:1.75&#125;.markdown-body pre>code&#123;font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8&#125;.markdown-body a&#123;text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff&#125;.markdown-body a:active,.markdown-body a:hover&#123;color:#275b8c&#125;.markdown-body table&#123;display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6&#125;.markdown-body thead&#123;background:#f6f6f6;color:#000;text-align:left&#125;.markdown-body tr:nth-child(2n)&#123;background-color:#fcfcfc&#125;.markdown-body td,.markdown-body th&#123;padding:12px 7px;line-height:24px&#125;.markdown-body td&#123;min-width:120px&#125;.markdown-body blockquote&#123;color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8&#125;.markdown-body blockquote:after&#123;display:block;content:""&#125;.markdown-body blockquote>p&#123;margin:10px 0&#125;.markdown-body ol,.markdown-body ul&#123;padding-left:28px&#125;.markdown-body ol li,.markdown-body ul li&#123;margin-bottom:0;list-style:inherit&#125;.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item&#123;list-style:none&#125;.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul&#123;margin-top:0&#125;.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul&#123;margin-top:3px&#125;.markdown-body ol li&#123;padding-left:6px&#125;.markdown-body .contains-task-list&#123;padding-left:0&#125;.markdown-body .task-list-item&#123;list-style:none&#125;@media (max-width:720px)&#123;.markdown-body h1&#123;font-size:24px&#125;.markdown-body h2&#123;font-size:20px&#125;.markdown-body h3&#123;font-size:18px&#125;&#125;</style><h3 data-id="heading-0">本文知识点：</h3>
<ul>
<li>event loop</li>
<li>promise 进阶</li>
<li>async/await</li>
<li>微任务/宏任务</li>
<li>场景题-promise then和catch的连接</li>
<li>场景题-async/await语法</li>
<li>场景题- promise和setTimeout的顺序</li>
<li>场景题-外加async/await的顺序问题</li>
</ul>
<h3 data-id="heading-1">问答题</h3>
<pre><code class="copyable">1 请描述event loop(事件循环/事件轮询)的机制，可画图
2 什么是宏任务和微任务，两者有什么区别？
3 Promise有哪三种状态？如何变化？
<span class="copy-code-btn">复制代码</span></code></pre>
<ul>
<li>请描述event loop(事件循环/事件轮询)的机制，可画图</li>
<li>什么是宏任务和微任务，两者有什么区别？</li>
<li>Promise有哪三种状态？如何变化？</li>
<li>场景题-promise then和catch的连接</li>
</ul>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">//第一题</span>
<span class="hljs-built_in">Promise</span>.resolve().then(<span class="hljs-function">()=></span>&#123;
    <span class="hljs-built_in">console</span>.log(<span class="hljs-number">1</span>);
&#125;).catch(<span class="hljs-function">()=></span>&#123;
    <span class="hljs-built_in">console</span>.log(<span class="hljs-number">2</span>);
&#125;).then(<span class="hljs-function">()=></span>&#123;
    <span class="hljs-built_in">console</span>.log(<span class="hljs-number">3</span>);
&#125;)

<span class="hljs-comment">//第二题</span>
<span class="hljs-built_in">Promise</span>.resolve().then(<span class="hljs-function">()=></span>&#123;
    <span class="hljs-built_in">console</span>.log(<span class="hljs-number">1</span>);
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'error1'</span>)
&#125;).catch(<span class="hljs-function">()=></span>&#123;
    <span class="hljs-built_in">console</span>.log(<span class="hljs-number">2</span>);
&#125;).then(<span class="hljs-function">()=></span>&#123;
    <span class="hljs-built_in">console</span>.log(<span class="hljs-number">3</span>);
&#125;)

<span class="hljs-comment">//第三题</span>
<span class="hljs-built_in">Promise</span>.resolve().then(<span class="hljs-function">()=></span>&#123;
    <span class="hljs-built_in">console</span>.log(<span class="hljs-number">1</span>);
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'error1'</span>)
&#125;).catch(<span class="hljs-function">()=></span>&#123;
    <span class="hljs-built_in">console</span>.log(<span class="hljs-number">2</span>);
&#125;).catch(<span class="hljs-function">()=></span>&#123;
    <span class="hljs-built_in">console</span>.log(<span class="hljs-number">3</span>);
&#125;)
<span class="copy-code-btn">复制代码</span></code></pre>
<ul>
<li>场景题-async/await语法</li>
</ul>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fn</span>(<span class="hljs-params"></span>)</span>&#123;
    <span class="hljs-keyword">return</span> <span class="hljs-number">100</span>;
&#125;
(<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>&#123;
    <span class="hljs-keyword">const</span> a = fn();<span class="hljs-comment">//?? 返回一个promise 值是100</span>
    <span class="hljs-keyword">const</span> b = <span class="hljs-keyword">await</span> fn(); <span class="hljs-comment">//?? 返回值100（await 相当于promise的then）</span>
&#125;)()

(<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>&#123;
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'start'</span>);
    <span class="hljs-keyword">const</span> a = <span class="hljs-keyword">await</span> <span class="hljs-number">100</span>;
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'a'</span>,a);
    <span class="hljs-keyword">const</span> b = <span class="hljs-keyword">await</span> <span class="hljs-built_in">Promise</span>.resolve(<span class="hljs-number">200</span>);
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'b'</span>,b);
    <span class="hljs-keyword">const</span> c = <span class="hljs-keyword">await</span> <span class="hljs-built_in">Promise</span>.resolve(<span class="hljs-number">300</span>);
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'c'</span>,c);
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'end'</span>);
    
&#125;)() <span class="hljs-comment">//执行完毕，打印出哪些内容？ </span>
<span class="hljs-comment">//只打印 start  a:100 b:200</span>
<span class="copy-code-btn">复制代码</span></code></pre>
<ul>
<li>场景题- promise和setTimeout的顺序</li>
</ul>
<pre><code class="copyable">console.log(100)
setTimeout(()=>&#123;
    console.log(200)
&#125;)
Promise.resolve().then(()=>&#123;
    console.log(300)
&#125;)
console.log(400)

//100 400 300 200
<span class="copy-code-btn">复制代码</span></code></pre>
<ul>
<li>场景题-外加async/await的顺序问题</li>
</ul>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">async1</span>(<span class="hljs-params"></span>)</span>&#123;
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'async1 start'</span>); <span class="hljs-comment">//2</span>
    <span class="hljs-keyword">await</span> async2();
    <span class="hljs-comment">// await后面都作为回调内容 -- 微任务</span>
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'async1 end'</span>) <span class="hljs-comment">//6   </span>
&#125;
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">async2</span>(<span class="hljs-params"></span>)</span>&#123;
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'async2'</span>) <span class="hljs-comment">//3</span>
&#125;
<span class="hljs-built_in">console</span>.log(<span class="hljs-string">'script start'</span>) <span class="hljs-comment">//1</span>

<span class="hljs-built_in">setTimeout</span>(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>&#123; <span class="hljs-comment">//宏任务 </span>
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'setTimeout'</span>) <span class="hljs-comment">//8</span>
&#125;,<span class="hljs-number">0</span>)

async1();

<span class="hljs-comment">//**** 初始化promise时，传入的回调函数会立刻被执行</span>
<span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">resolve</span>)</span>&#123;
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'promise1'</span>) <span class="hljs-comment">//4</span>
    resolve()
&#125;).then(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>&#123; <span class="hljs-comment">//微任务</span>
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'promise2'</span>) <span class="hljs-comment">//7</span>
&#125;)

<span class="hljs-built_in">console</span>.log(<span class="hljs-string">'script end'</span>)<span class="hljs-comment">//5</span>
<span class="copy-code-btn">复制代码</span></code></pre>
<h2 data-id="heading-2">event loop(事件循环/事件轮询)</h2>
<ul>
<li>
<p>JS是单线程运行的</p>
</li>
<li>
<p>异步要基于回调来实现</p>
</li>
<li>
<p>event loop就是异步回调的实现原理</p>
</li>
<li>
<p>回顾：JS如何执行？</p>
<ul>
<li>从前到后，一行一行执行</li>
<li>如果某一行执行报错，则停止下面代码的执行</li>
<li>先把同步代码执行完，再执行异步</li>
</ul>
</li>
</ul>
<p>示例</p>
<pre><code class="copyable">console.log('Hi')
setTimeout(function cb()&#123;
    console.log('cb1')
&#125;,5000)
console.log('Bye')
<span class="copy-code-btn">复制代码</span></code></pre>
<h3 data-id="heading-3">event loop过程</h3>
<ul>
<li>同步代码，一行一行放在Call Stack执行</li>
<li>遇到异步，会先“记录”下，等待时机（定时、网络请求等）</li>
<li>时机到了，就移动到Callback Queue</li>
<li>如Call Stack为空（即同步代码执行完）Event Loop开始工作</li>
<li>轮询查找Callback Queue,如有则移动到Call Stack执行</li>
<li>然后继续轮询查找（永动机一样）</li>
</ul>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/61c6b1d969174899b875ffeb782d6915~tplv-k3u1fbpfcp-watermark.image" alt="image.png" loading="lazy" referrerpolicy="no-referrer"></p>
<h3 data-id="heading-4">DOM事件和event loop</h3>
<ul>
<li>JS是单线程的</li>
<li>异步（setTimeout,ajax等）使用回调，基于event loop</li>
<li>DOM事件也使用回调，基于event loop</li>
</ul>
<pre><code class="copyable">console.log('Hi')
setTimeout(function cb()&#123;
    console.log('cb1')
&#125;,5000)
console.log('Bye')
<span class="copy-code-btn">复制代码</span></code></pre>
<pre><code class="hljs language-html copyable" lang="html"><span class="hljs-tag"><<span class="hljs-name">button</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"btn1"</span>></span>提交<span class="hljs-tag"></<span class="hljs-name">button</span>></span>
<span class="hljs-tag"><<span class="hljs-name">script</span>></span><span class="javascript">
<span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Hi'</span>)
$(<span class="hljs-string">'#btn1'</span>).click(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">e</span>)</span>&#123;
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'button clicked'</span>)
&#125;)
<span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Bye'</span>)
</span><span class="hljs-tag"></<span class="hljs-name">script</span>></span>
<span class="copy-code-btn">复制代码</span></code></pre>
<h2 data-id="heading-5">宏任务macroTask和微任务micro Task</h2>
<ul>
<li>什么是宏任务，什么是微任务</li>
<li>event loop和DOM渲染</li>
<li>微任务和宏任务的区别</li>
</ul>
<p>代码演示</p>
<pre><code class="copyable">console.log(100)
setTimeout(()=>&#123;
    console.log(200)
&#125;)
Promise.resolve().then(()=>&#123;
    console.log(300)
&#125;)
console.log(400)
//答案 100 400 300 200 
<span class="copy-code-btn">复制代码</span></code></pre>
<h3 data-id="heading-6">宏任务和微任务</h3>
<ul>
<li>宏任务：setTimeout,setInterval,Ajax,DOM事件</li>
<li>微任务：Promise async/await</li>
<li>微任务执行时机比宏任务要早</li>
</ul>
<h3 data-id="heading-7">event loop和DOM渲染</h3>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a5d38b870d9246ce9b235006b0701747~tplv-k3u1fbpfcp-watermark.image" alt="image.png" loading="lazy" referrerpolicy="no-referrer"></p>
<pre><code class="hljs language-html copyable" lang="html">const $p1 = $('<span class="hljs-tag"><<span class="hljs-name">p</span>></span>一段文字<span class="hljs-tag"></<span class="hljs-name">p</span>></span>');
const $p2 = $('<span class="hljs-tag"><<span class="hljs-name">p</span>></span>一段文字<span class="hljs-tag"></<span class="hljs-name">p</span>></span>');
const $p3 = $('<span class="hljs-tag"><<span class="hljs-name">p</span>></span>一段文字<span class="hljs-tag"></<span class="hljs-name">p</span>></span>');
$('#container')
    .append($p1)
    .append($p2)
    .append($p3)
console.log('length',$('#container').children().length) //3
alert('本次 call stack结束，DOM结构已更新，但尚未触发渲染')
//(alert会阻断js执行，也会阻断DOM渲染，便于查看效果)
<span class="copy-code-btn">复制代码</span></code></pre>
<pre><code class="hljs language-html copyable" lang="html">const $p1 = $('<span class="hljs-tag"><<span class="hljs-name">p</span>></span>一段文字<span class="hljs-tag"></<span class="hljs-name">p</span>></span>');
const $p2 = $('<span class="hljs-tag"><<span class="hljs-name">p</span>></span>一段文字<span class="hljs-tag"></<span class="hljs-name">p</span>></span>');
const $p3 = $('<span class="hljs-tag"><<span class="hljs-name">p</span>></span>一段文字<span class="hljs-tag"></<span class="hljs-name">p</span>></span>');
$('#container')
    .append($p1)
    .append($p2)
    .append($p3)
    
//微任务：DOM渲染前触发
Promise.resolve().then(()=>&#123;
    console.log('length1',
        $('#container').children().length)//3
        alert('Promise then')//DOM 渲染了吗？---//NO
&#125;)

//宏任务：DOM渲染后触发
setTimeout(()=>&#123;
    console.log('length2',
        $('#container').children().length)//3
        alert('setTimeout') //DOM渲染了吗？ ---YES
&#125;)
<span class="copy-code-btn">复制代码</span></code></pre>
<h4 data-id="heading-8">从event loop解释，为何微任务比宏任务更早，会在渲染前触发</h4>
<ul>
<li>宏任务是由浏览器规定的：setTimeout,setInterval,Ajax,DOM事件</li>
<li>微任务是ES6语法规定的：Promise async/await</li>
</ul>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7035af6333c8444dbb794ece141bc5c8~tplv-k3u1fbpfcp-watermark.image" alt="image.png" loading="lazy" referrerpolicy="no-referrer"></p>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0664c0df5d5a45ce8d415d0ba1fe4eb8~tplv-k3u1fbpfcp-watermark.image" alt="image.png" loading="lazy" referrerpolicy="no-referrer"></p>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/965751b44277471696a79c5efc02a315~tplv-k3u1fbpfcp-watermark.image" alt="image.png" loading="lazy" referrerpolicy="no-referrer"></p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f754658fea6442a7830cac6220d5f9fe~tplv-k3u1fbpfcp-watermark.image" alt="image.png" loading="lazy" referrerpolicy="no-referrer"></p>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/721d64c4a9a943a189866286d568799a~tplv-k3u1fbpfcp-watermark.image" alt="image.png" loading="lazy" referrerpolicy="no-referrer"></p></div>  
</div>
            