
---
title: 'webpackæºç è§£æ'
categories: 
 - ç¼–ç¨‹
 - æ˜é‡‘
 - åˆ†ç±»
headimg: 'https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b3acb30d4dce445c8e0386c8dfab6471~tplv-k3u1fbpfcp-zoom-1.image'
author: æ˜é‡‘
comments: false
date: Thu, 08 Apr 2021 02:16:21 GMT
thumbnail: 'https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b3acb30d4dce445c8e0386c8dfab6471~tplv-k3u1fbpfcp-zoom-1.image'
---

<div>   
<div class="markdown-body"><style>.markdown-body&#123;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333&#125;.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6&#123;line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px&#125;.markdown-body h1&#123;font-size:30px;margin-bottom:5px&#125;.markdown-body h2&#123;padding-bottom:12px;font-size:24px;border-bottom:1px solid #ececec&#125;.markdown-body h3&#123;font-size:18px;padding-bottom:0&#125;.markdown-body h4&#123;font-size:16px&#125;.markdown-body h5&#123;font-size:15px&#125;.markdown-body h6&#123;margin-top:5px&#125;.markdown-body p&#123;line-height:inherit;margin-top:22px;margin-bottom:22px&#125;.markdown-body img&#123;max-width:100%&#125;.markdown-body hr&#123;border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px&#125;.markdown-body code&#123;word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em&#125;.markdown-body code,.markdown-body pre&#123;font-family:Menlo,Monaco,Consolas,Courier New,monospace&#125;.markdown-body pre&#123;overflow:auto;position:relative;line-height:1.75&#125;.markdown-body pre>code&#123;font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8&#125;.markdown-body a&#123;text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff&#125;.markdown-body a:active,.markdown-body a:hover&#123;color:#275b8c&#125;.markdown-body table&#123;display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6&#125;.markdown-body thead&#123;background:#f6f6f6;color:#000;text-align:left&#125;.markdown-body tr:nth-child(2n)&#123;background-color:#fcfcfc&#125;.markdown-body td,.markdown-body th&#123;padding:12px 7px;line-height:24px&#125;.markdown-body td&#123;min-width:120px&#125;.markdown-body blockquote&#123;color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8&#125;.markdown-body blockquote:after&#123;display:block;content:""&#125;.markdown-body blockquote>p&#123;margin:10px 0&#125;.markdown-body ol,.markdown-body ul&#123;padding-left:28px&#125;.markdown-body ol li,.markdown-body ul li&#123;margin-bottom:0;list-style:inherit&#125;.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item&#123;list-style:none&#125;.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul&#123;margin-top:0&#125;.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul&#123;margin-top:3px&#125;.markdown-body ol li&#123;padding-left:6px&#125;.markdown-body .contains-task-list&#123;padding-left:0&#125;.markdown-body .task-list-item&#123;list-style:none&#125;@media (max-width:720px)&#123;.markdown-body h1&#123;font-size:24px&#125;.markdown-body h2&#123;font-size:20px&#125;.markdown-body h3&#123;font-size:18px&#125;&#125;</style><p><strong>å‰è¨€</strong>ï¼š
webpackä½œä¸ºä¸€ä¸ªæ‰“åŒ…å·¥å…·ï¼Œå®ƒçš„å…¥å‚æ˜¯å„ç§é™æ€æ–‡ä»¶å’Œé…ç½®å‚æ•°ï¼Œå¯ä»¥å®ç°çµæ´»çš„å¯æ‰©å±•æ€§çš„æ’ä»¶é…ç½®å’ŒloadersåŠ è½½ï¼Œæœ€åè¾“å‡ºæ‰“åŒ…åçš„bundleæ–‡ä»¶ã€‚ä¸‹å›¾æ˜¯å®˜ç½‘ä¸­çš„webpackæ‰“åŒ…ç¤ºæ„å›¾ï¼Œwebpackå¯ä»¥æ‰“åŒ…å…¨ä¸–ç•Œï¼
<img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" class="lazyload" src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b3acb30d4dce445c8e0386c8dfab6471~tplv-k3u1fbpfcp-zoom-1.image" data-width="800" data-height="600" referrerpolicy="no-referrer">
åœ¨ä½¿ç”¨webpackçš„è¿‡ç¨‹ä¸­ï¼Œä¸€ç›´æœ‰å‡ ä¸ªç–‘é—®è¦ç»•è„‘æµ·ï¼š</p>
<ul>
<li>webpackä¸­é—´çš„å¤„ç†æµç¨‹ç©¶ç«Ÿåšäº†äº›ä»€ä¹ˆï¼Ÿ</li>
<li>æˆ‘ä»¬å¹³æ—¶é…ç½®çš„loadersã€pluginséƒ½åœ¨å“ªä¸ªé˜¶æ®µèµ·ä½œç”¨ï¼Ÿ</li>
<li>webpackæ˜¯å¦‚ä½•æ”¯æŒå¦‚æ­¤å¤æ‚çš„é…ç½®è€Œåˆä¸å½±å“æ€§èƒ½çš„ï¼Ÿ</li>
</ul>
<p>åœ¨åˆ†ææºç ä¹‹å‰ï¼Œæˆ‘ä»¬å¿…é¡»è¦å…ˆäº†è§£ä¸€ä¸‹Tapableè¿™ä¸ªä¸œè¥¿ï¼ˆç¬¬3ä¸ªé—®é¢˜çš„ç­”æ¡ˆï¼‰ã€‚
Webpackæœ¬è´¨ä¸Šæ˜¯äº‹ä»¶é©±åŠ¨çš„ï¼Œä»ä¸€ä¸ªäº‹ä»¶ï¼Œèµ°å‘ä¸‹ä¸€ä¸ªäº‹ä»¶ã€‚å®ƒçš„æ•´ä¸ªç¼–è¯‘è¿‡ç¨‹ä¸­æš´éœ²å‡ºæ¥å¤§é‡çš„ Hook ä¾›å†…éƒ¨/å¤–éƒ¨æ’ä»¶ä½¿ç”¨ï¼Œè€Œå®ç°è¿™ä¸€åˆ‡çš„æ ¸å¿ƒå°±æ˜¯Tapableã€‚Tapable ç±»ä¼¼äºå‘å¸ƒè®¢é˜…æ¨¡å¼ï¼Œä½†æ˜¯å®ƒæä¾›äº†æ›´åŠ å¤æ‚çš„é’©å­ç±»å‹ï¼Œæˆ‘ä»¬å¯ä»¥ç†è§£ä¸ºwebpackæ‰“åŒ…æµç¨‹æ˜¯ç”±æ‰“åŒ…é˜¶æ®µçš„å„ä¸ªäº‹ä»¶ç»„æˆçš„ï¼Œè€Œæ’ä»¶çš„å®ç°å°±æ˜¯åœ¨è¿™äº›äº‹ä»¶é’©å­ä¸Šç»‘å®šå±äºè‡ªå·±çš„å›è°ƒå‡½æ•°ï¼Œè¿™æ ·å°±å®ç°äº†webpackçš„å¯æ‰©å±•æ€§ã€‚</p>
<p>å¯å‚è€ƒè¿™ç¯‡æ–‡ç« ï¼š
<a href="https://blog.csdn.net/weixin_38208314/article/details/115166713" target="_blank" rel="nofollow noopener noreferrer">webpack tapableå•¥ç©æ„ï¼Ÿ</a></p>
<p>æˆ‘ä»¬ä¸€èµ·æ¥çœ‹ä¸€ä¸‹å§ï¼Œé¦–å…ˆä¸¾ä¸ªğŸŒ°è¯´æ˜webpackåœ¨åšä»€ä¹ˆï¼Ÿ</p>
<h2 data-id="heading-0">ä¸€.ä¸¾ä¾‹è¯´æ˜webpackåœ¨åšä»€ä¹ˆï¼Ÿ</h2>
<pre><code class="hljs language-javascript copyable" lang="javascript"><span class="hljs-comment">// a.js (webpack config å…¥å£æ–‡ä»¶)</span>
<span class="hljs-keyword">import</span> add <span class="hljs-keyword">from</span> <span class="hljs-string">'./b.js'</span>

add(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>)

<span class="hljs-keyword">import</span>(<span class="hljs-string">'./c'</span>).then(<span class="hljs-function"><span class="hljs-params">del</span> =></span> del(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>))

-----

<span class="hljs-comment">// b.js</span>
<span class="hljs-keyword">import</span> mod <span class="hljs-keyword">from</span> <span class="hljs-string">'./d.js'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">add</span>(<span class="hljs-params">n1, n2</span>) </span>&#123;
  <span class="hljs-keyword">return</span> n1 + n2
&#125;

mod(<span class="hljs-number">100</span>, <span class="hljs-number">11</span>)

-----

<span class="hljs-comment">// c.js</span>
<span class="hljs-keyword">import</span> mod <span class="hljs-keyword">from</span> <span class="hljs-string">'./d.js'</span>

mod(<span class="hljs-number">100</span>, <span class="hljs-number">11</span>)

<span class="hljs-keyword">import</span>(<span class="hljs-string">'./b.js'</span>).then(<span class="hljs-function"><span class="hljs-params">add</span> =></span> add(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>))

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">del</span>(<span class="hljs-params">n1, n2</span>) </span>&#123;
  <span class="hljs-keyword">return</span> n1 - n2
&#125;
-----

<span class="hljs-comment">// d.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">mod</span>(<span class="hljs-params">n1, n2</span>) </span>&#123;
  <span class="hljs-keyword">return</span> n1 % n2
&#125;
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<p>å„ä¸ªæ–‡ä»¶çš„ä¾èµ–å…³ç³»å¦‚ä¸‹ï¼š
<img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" class="lazyload" src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/dc148858faeb4938a2ffdd6fc07915ea~tplv-k3u1fbpfcp-zoom-1.image" data-width="800" data-height="600" referrerpolicy="no-referrer"></p>
<pre><code class="hljs language-javascript copyable" lang="javascript"><span class="hljs-comment">// webpack.config.js</span>
<span class="hljs-built_in">module</span>.exports = &#123;
  <span class="hljs-attr">entry</span>: &#123;
    <span class="hljs-attr">app</span>: <span class="hljs-string">'a.js'</span>
  &#125;,
  <span class="hljs-attr">output</span>: &#123;
    <span class="hljs-attr">filename</span>: <span class="hljs-string">'[name].[hash:8].js'</span>,
    <span class="hljs-attr">chunkFilename</span>: <span class="hljs-string">'[name].bundle.[chunkhash:8].js'</span>,
    <span class="hljs-attr">publicPath</span>: <span class="hljs-string">'/'</span>
  &#125;,
&#125;
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<p>ä¸Šè¿°ä»£ç ç»è¿‡webpackæ‰“åŒ…ä¹‹åï¼Œæœ€ç»ˆä¼šè¾“å‡º2ä¸ªæ‰“åŒ…æ–‡ä»¶ï¼š</p>
<ul>
<li>app.js - åŒ…å«äº† a.jã€b.jsã€d.js çš„ä»£ç </li>
<li>0.bundle.js - åŒ…å«äº† c.js çš„ä»£ç </li>
</ul>
<p><img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" class="lazyload" src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f98b28e09a9c4abc8e34ca066f2e1f52~tplv-k3u1fbpfcp-zoom-1.image" data-width="800" data-height="600" referrerpolicy="no-referrer">
çœ‹åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬çœ‹åˆ°webpackå°†æˆ‘ä»¬çš„æ–‡ä»¶æŒ‰ç…§æŸç§è§„åˆ™è¿›è¡Œæ‰“åŒ…è¾“å‡ºï¼ˆå½“ç„¶ç›®å‰ä¸ºæ­¢æˆ‘ä»¬è¿˜æ²¡æœ‰ç”¨åˆ°æ’ä»¶å’Œloadersï¼‰ï¼Œå¦‚æœä¸çŸ¥é“è¿™ä¸¤ä¸ªåŒ…æ˜¯å¦‚ä½•è¾“å‡ºçš„ä¹Ÿæ²¡å…³ç³»ï¼Œåé¢ä¼šå†è§£é‡Šã€‚</p>
<p><strong>webpackåˆ°åº•æ€ä¹ˆåšåˆ°çš„</strong>ï¼Ÿæˆ‘ä»¬å¼€å§‹è¿›å…¥æ­£é¢˜å§ï¼Œæœ¬æ–‡åªè§£æéƒ¨åˆ†æ ¸å¿ƒwebpackæºç ï¼ŒæŠ›ç –å¼•ç‰ï¼Œè®©å¤§å®¶å¯¹webpackçš„è¿è¡Œæµç¨‹æœ‰ä¸€ä¸ªå¤§è‡´çš„äº†è§£ã€‚</p>
<p>åœ¨æ‰“åŒ…çš„æ—¶å€™æˆ‘ä»¬ä¼šåœ¨å‘½ä»¤è¡Œæ‰§è¡Œä»¥ä¸‹æ‰“åŒ…å‘½ä»¤ï¼š</p>
<pre><code class="hljs language-javascript copyable" lang="javascript">webpack --config webpack.config.js
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<p>è¯¥å‘½ä»¤åœ¨webpack-cliä¸­ç›¸å½“äºæ‰§è¡Œä»¥ä¸‹ä»£ç ï¼š</p>
<pre><code class="hljs language-javascript copyable" lang="javascript"><span class="hljs-comment">// ä½¿ç”¨ï¼Œè¿™é‡Œæ¨¡ä»¿webpack-cliä¸­çš„ä»£ç ï¼Œç›¸å½“äºåœ¨å‘½ä»¤è¡Œé‡Œè¾“å…¥webpackã€‚</span>
<span class="hljs-keyword">const</span> options = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./webpack.config.js"</span>);
<span class="hljs-keyword">const</span> compiler = webpack(options);

compiler.run();
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<p>ç®€å•è§£é‡Šï¼šåŠ è½½webpacké…ç½®æ–‡ä»¶ï¼Œä¼ ç»™webpackæ–‡ä»¶ï¼Œè¿”å›ä¸€ä¸ªç¼–è¯‘å™¨compilerï¼Œè¿è¡Œç¼–è¯‘å™¨ã€‚
soï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹webpackå…¥å£---webpack.jsåšäº†ä»€ä¹ˆï¼Ÿ</p>
<h2 data-id="heading-1">ä¸€ .webpack.js</h2>
<p>ä¸‹é¢è¿™æ®µä»£ç æ˜¯webpack.jsçš„ä¸»è¦éƒ¨åˆ†ï¼š</p>
<pre><code class="hljs language-javascript copyable" lang="javascript"><span class="hljs-keyword">const</span> webpack = <span class="hljs-function">(<span class="hljs-params">options, callback</span>) =></span> &#123;
...
<span class="hljs-comment">// ç”¨æˆ‘ä»¬è‡ªå®šä¹‰çš„é…ç½®è¦†ç›–webpacké»˜è®¤çš„é…ç½® è¿”å›ç»¼åˆé…ç½®</span>
    options = <span class="hljs-keyword">new</span> WebpackOptionsDefaulter().process(options);
    <span class="hljs-comment">// å°†ä»£ç å…¥å£ä¼ å…¥ç¼–è¯‘å™¨ï¼Œå®ä¾‹åŒ–ç¼–è¯‘å™¨</span>
    compiler = <span class="hljs-keyword">new</span> Compiler(options.context);
    <span class="hljs-comment">// Nodeç¯å¢ƒæ’ä»¶ æŒ‚è½½åœ¨ç¼–è¯‘å™¨çš„é’©å­ä¸Š</span>
    <span class="hljs-keyword">new</span> NodeEnvironmentPlugin(&#123;...&#125;).apply(compiler);
    <span class="hljs-comment">// è‡ªå®šä¹‰æ’ä»¶ æŒ‚è½½åœ¨ç¼–è¯‘å™¨çš„é’©å­ä¸Š</span>
    options.plugin.apply(compiler);
   ...
    <span class="hljs-comment">// å°†webpacké…ç½®çš„å…¶ä»–å±æ€§æ‰€ç”¨åˆ°çš„æ’ä»¶ï¼Œéƒ½æŒ‚è½½åœ¨compilerä¸Š</span>
    compiler.options = <span class="hljs-keyword">new</span> WebpackOptionsApply().process(options, compiler);
...
<span class="hljs-keyword">return</span> compiler;
&#125;
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<p>åœ¨è¿™é‡Œè§£é‡Šå‡ ä»¶äº‹æƒ…ï¼š</p>
<ul>
<li>webpack4.0å¯ä»¥å®ç°é›¶é…ç½®ï¼Œæ²¡æœ‰ç”¨æˆ·é…ç½®çš„æƒ…å†µä¸‹ï¼Œå®ƒä¼šé‡‡ç”¨é»˜è®¤çš„é…ç½®å°†srcæ–‡ä»¶å¤¹ä¸‹çš„index.jsæ‰“åŒ…åˆ°distæ–‡ä»¶å¤¹ä¸‹çš„main.jsä¸­ï¼ˆå…¶ä»–å¾ˆå¤šé»˜è®¤é…ç½®ä¸èµ˜è¿°ï¼‰ã€‚</li>
<li>new Compiler(options.context)è¿™å¥ä»£ç çš„æ„æ€æ˜¯å°†å½“å‰æ–‡ä»¶å¤¹çš„ç»å¯¹è·¯å¾„ä¼ ç»™ç¼–è¯‘å™¨ã€‚</li>
</ul>
<p>ä¸¾ä¾‹ï¼š</p>
<pre><code class="hljs language-javascript copyable" lang="javascript"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">NodeEnvironmentPlugin</span> </span>&#123;
<span class="hljs-function"><span class="hljs-title">apply</span>(<span class="hljs-params">compiler</span>)</span> &#123;
compiler.inputFileSystem = <span class="hljs-keyword">new</span> CachedInputFileSystem(
<span class="hljs-keyword">new</span> NodeJsInputFileSystem(),
<span class="hljs-number">60000</span>
);
<span class="hljs-comment">//....</span>
compiler.hooks.beforeRun.tap(<span class="hljs-string">"NodeEnvironmentPlugin"</span>, <span class="hljs-function"><span class="hljs-params">compiler</span> =></span> &#123;
<span class="hljs-keyword">if</span> (compiler.inputFileSystem === inputFileSystem) inputFileSystem.purge();
&#125;);
&#125;
&#125;
<span class="hljs-built_in">module</span>.exports = NodeEnvironmentPlugin;
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<p>ä¸Šå›¾ä¸­ï¼Œæ˜¯nodeç¯å¢ƒä¸‹çš„ä¸€ä¸ªæ’ä»¶çš„ä»£ç æ ¸å¿ƒã€‚æ¯”å¦‚æˆ‘ä»¬åœ¨è§£ææ–‡ä»¶(resolver)çš„æ—¶å€™ï¼Œéœ€è¦ç”¨åˆ°çš„æ–‡ä»¶ç³»ç»Ÿï¼Œè¿™ä¸ªæ’ä»¶å°±æ˜¯åœ¨compilerçš„beforeRuné’©å­ä¸ŠæŒ‚è½½äº†è‡ªå·±çš„äº‹ä»¶ï¼Œå°†æ–‡ä»¶è¯»å–ç³»ç»ŸæŒ‚è½½åœ¨compilerä¸Šï¼Œä½¿å¾—compilerä¸­çš„å…¶ä»–æ’ä»¶å¯ä»¥ä½¿ç”¨æ–‡ä»¶è¯»å–ç³»ç»Ÿã€‚</p>
<p>webpack.jsä¸»è¦åšäº†å‡ ä»¶äº‹ï¼š
1.æ•´åˆé…ç½®å‚æ•°ï¼ˆç”¨æˆ·é…ç½®å’Œé»˜è®¤é…ç½®ï¼‰
2.å°†nodeç¯å¢ƒçš„æ’ä»¶å’Œç”¨æˆ·é…ç½®çš„æ’ä»¶æŒ‚è½½åœ¨compilerå„ä¸ªé’©å­ä¸Šï¼Œä½¿å¾—å„ä¸ªæ’ä»¶å¯ä»¥åœ¨ç¼–è¯‘çš„ä¸åŒé˜¶æ®µæ‰§è¡Œè‡ªå·±çš„é€»è¾‘ã€‚
3.è¿”å›compiler</p>
<p>å¼€å§‹æ‰§è¡Œcompiler.run();æ“ä½œï¼š</p>
<h2 data-id="heading-2">äºŒ. compiler.js</h2>
<p>compiler.jsæ˜¯ç”¨æ¥æ§åˆ¶ç¼–è¯‘æµç¨‹çš„æ–‡ä»¶ã€‚runæ–¹æ³•é€»è¾‘å¦‚ä¸‹ï¼š
beforeRuné’©å­-->runé’©å­-->ç¼–è¯‘compileæ–¹æ³•-->ç¼–è¯‘ç»“æŸå›è°ƒonCompiled
runæ–¹æ³•æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>
<pre><code class="hljs language-javascript copyable" lang="javascript"><span class="hljs-function"><span class="hljs-title">run</span>(<span class="hljs-params">callback</span>)</span> &#123;
<span class="hljs-keyword">const</span> onCompiled = <span class="hljs-function">(<span class="hljs-params">err, compilation</span>) =></span> &#123;
<span class="hljs-comment">// ç¼–è¯‘ç»“æŸåçš„å›è°ƒå‡½æ•°</span>
<span class="hljs-comment">// æ–‡ä»¶è¾“å‡º</span>
&#125;
...
    <span class="hljs-comment">// è§¦å‘beforeRuné’©å­ï¼Œå¢åŠ æ–‡ä»¶å­˜å–çš„åŠŸèƒ½ </span>
    <span class="hljs-built_in">this</span>.hooks.beforeRun.callAsync(<span class="hljs-built_in">this</span>, <span class="hljs-function"><span class="hljs-params">err</span> =></span> &#123;
      <span class="hljs-comment">// è§¦å‘runé’©å­ï¼Œå¤„ç†ç¼“å­˜çš„æ¨¡å— å‡å°‘ç¼–è¯‘çš„æ¨¡å— åŠ å¿«ç¼–è¯‘é€Ÿåº¦</span>
      <span class="hljs-built_in">this</span>.hooks.run.callAsync(<span class="hljs-built_in">this</span>, <span class="hljs-function"><span class="hljs-params">err</span> =></span> &#123;
       ...
          <span class="hljs-built_in">this</span>.compile(onCompiled);
    &#125;);
  &#125;
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<p>è™½ç„¶è¿™é‡Œå„ç§é’©å­åµŒå¥—æ‰§è¡Œï¼Œå¹¶æ²¡æœ‰æ·»åŠ ä»»ä½•åŠŸèƒ½ï¼Œä½†å…¶å®æ’ä»¶å·²ç»åœ¨å„ç§é’©å­ä¸Šç»‘å®šäº†è‡ªå·±çš„äº‹ä»¶ï¼Œwebpackå®ç°äº†åŠŸèƒ½ä¸å®ç°çš„è§£è€¦ï¼Œä»£ç é€»è¾‘æ¸…æ™°ã€‚</p>
<pre><code class="hljs language-javascript copyable" lang="javascript"><span class="hljs-function"><span class="hljs-title">compile</span>(<span class="hljs-params">callback</span>)</span> &#123;
    <span class="hljs-built_in">this</span>.hooks.beforeCompile.callAsync(params, <span class="hljs-function"><span class="hljs-params">err</span> =></span> &#123;
      <span class="hljs-comment">// ç¼–è¯‘</span>
      <span class="hljs-built_in">this</span>.hooks.compile.call(params);
      <span class="hljs-comment">// newCompilationæ˜¯webpackä½¿ç”¨çš„ç¼–è¯‘å™¨</span>
      <span class="hljs-keyword">const</span> compilation = <span class="hljs-built_in">this</span>.newCompilation(params);
      <span class="hljs-comment">// æ­£å¼å¯åŠ¨ç¼–è¯‘ </span>
      <span class="hljs-built_in">this</span>.hooks.make.callAsync(compilation, <span class="hljs-function"><span class="hljs-params">err</span> =></span> &#123;
      ...
        <span class="hljs-comment">// ç¼–è¯‘ç»“æŸ</span>
        compilation.finish(<span class="hljs-function"><span class="hljs-params">err</span> =></span> &#123;
          ...
          <span class="hljs-comment">// å°è£… æ‰§è¡Œä¼˜åŒ–çš„é’©å­ chunkæ„å»ºå’Œæ‰“åŒ…ä¼˜åŒ–</span>
          compilation.seal(<span class="hljs-function"><span class="hljs-params">err</span> =></span> &#123;
            ...

            <span class="hljs-built_in">this</span>.hooks.afterCompile.callAsync(compilation, <span class="hljs-function"><span class="hljs-params">err</span> =></span> &#123;
            ...
            <span class="hljs-keyword">return</span> callback(<span class="hljs-literal">null</span>, compilation);
            &#125;);
          &#125;);
        &#125;);
      &#125;);
    &#125;);
  &#125;
&#125;
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<p>compileå‡½æ•°çš„é€»è¾‘å¦‚ä¸‹ï¼š
beforeCompileé’©å­-->compileé’©å­-->å®ä¾‹åŒ–ç¼–è¯‘å™¨compilationå¯¹è±¡-->makeé’©å­(è½¬æ¢æ¨¡å—)-->ç¼–è¯‘ç»“æŸ-->sealå°è£…-->afterCompileé’©å­-->æ‰§è¡Œcompileå›è°ƒå‡½æ•°</p>
<p>compiler.jsæ–‡ä»¶åšçš„å‡ ä»¶äº‹ï¼š</p>
<ul>
<li>å¯åŠ¨ç¼–è¯‘ã€‚é€šè¿‡å®ä¾‹åŒ–ç¼–è¯‘å¯¹è±¡å¹¶æ‰§è¡Œmakeé’©å­ï¼Œç¼–è¯‘å¼€å§‹ï¼ŒçœŸæ­£çš„æ ¸å¿ƒç¼–è¯‘å·¥ä½œæ˜¯ç”±compilationå¯¹è±¡åšçš„ã€‚</li>
<li>ç®¡ç†è¾“å‡ºã€‚ç¼–è¯‘ç»“æŸåä¼šæ‰§è¡ŒonCompiledè¿™ä¸ªå›è°ƒå‡½æ•°ï¼Œæ•´ç†è¾“å‡ºæ•°æ®ã€‚</li>
<li>é€šè¿‡é’©å­æ§åˆ¶æ•´ä¸ªç¼–è¯‘æµç¨‹ã€‚</li>
</ul>
<p>ä¸‹æ–¹è¡¨æ ¼ä¸­ï¼Œåˆ†åˆ«æ˜¯compilerçš„å‡ ä¸ªé’©å­ï¼Œæ’ä»¶å°±æ˜¯æŒ‚è½½åœ¨ç¼–è¯‘çš„ä¸åŒé˜¶æ®µï¼Œåœ¨ä¸åŒçš„é˜¶æ®µæ‰§è¡Œä¸åŒçš„æ’ä»¶ã€‚</p>







































































<table><thead><tr><th>å…³é”®é’©å­</th><th>é’©å­ç±»å‹</th><th>é’©å­å‚æ•°</th><th>ä½œç”¨</th></tr></thead><tbody><tr><td>beforeRun</td><td>AsyncSeriesHook</td><td>Compiler</td><td>è¿è¡Œå‰çš„å‡†å¤‡æ´»åŠ¨ï¼Œä¸»è¦å¯ç”¨äº†æ–‡ä»¶è¯»å–çš„åŠŸèƒ½ã€‚</td></tr><tr><td>run</td><td>AsyncSeriesHook</td><td>Compiler</td><td>â€œæœºå™¨â€å·²ç»è·‘èµ·æ¥äº†ï¼Œåœ¨ç¼–è¯‘ä¹‹å‰æœ‰ç¼“å­˜ï¼Œåˆ™å¯ç”¨ç¼“å­˜ï¼Œè¿™æ ·å¯ä»¥æé«˜æ•ˆç‡ã€‚</td></tr><tr><td>beforeCompile</td><td>AsyncSeriesHook</td><td>params</td><td>å¼€å§‹ç¼–è¯‘å‰çš„å‡†å¤‡ï¼Œåˆ›å»ºçš„ModuleFactoryï¼Œåˆ›å»ºCompilationï¼Œå¹¶ç»‘å®šModuleFactoryåˆ°Compilationä¸Šã€‚</td></tr><tr><td>compile</td><td>SyncHook</td><td>params</td><td>ç¼–è¯‘äº†</td></tr><tr><td>make</td><td>AsyncParallelHook</td><td>compilation</td><td>ä»Compilationçš„addEntryå‡½æ•°ï¼Œå¼€å§‹æ„å»ºæ¨¡å—</td></tr><tr><td>afterCompile</td><td>AsyncSeriesHook</td><td>compilation</td><td>ç¼–è¯‘ç»“æŸäº†</td></tr><tr><td>shouldEmit</td><td>SyncBailHook</td><td>compilation</td><td>è·å–compilationå‘æ¥çš„ç”µæŠ¥ï¼Œç¡®å®šç¼–è¯‘æ—¶å€™æˆåŠŸï¼Œæ˜¯å¦å¯ä»¥å¼€å§‹è¾“å‡ºäº†ã€‚</td></tr><tr><td>emit</td><td>AsyncSeriesHook</td><td>compilation</td><td>è¾“å‡ºæ–‡ä»¶äº†</td></tr><tr><td>afterEmit</td><td>AsyncSeriesHook</td><td>compilation</td><td>è¾“å‡ºå®Œæ¯•</td></tr><tr><td>done</td><td>AsyncSeriesHook</td><td>Status</td><td>æ— è®ºæˆåŠŸä¸å¦ï¼Œä¸€åˆ‡å·²å°˜åŸƒè½å®šã€‚</td></tr></tbody></table>
<p>ç¼–è¯‘å›è°ƒå‡½æ•°ï¼š</p>
<pre><code class="hljs language-javascript copyable" lang="javascript"><span class="hljs-keyword">const</span> onCompiled = <span class="hljs-function">(<span class="hljs-params">err, compilation</span>) =></span> &#123;
<span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.hooks.shouldEmit.call(compilation) === <span class="hljs-literal">false</span>) &#123;
...
<span class="hljs-built_in">this</span>.hooks.done.callAsync(stats, <span class="hljs-function"><span class="hljs-params">err</span> =></span> &#123;
...
    &#125;
    <span class="hljs-keyword">return</span>

&#125;
<span class="hljs-built_in">this</span>.emitAssets(compilation, <span class="hljs-function"><span class="hljs-params">err</span> =></span> &#123;
    ...
    <span class="hljs-keyword">if</span> (compilation.hooks.needAdditionalPass.call()) &#123;
    ...
    <span class="hljs-built_in">this</span>.hooks.done.callAsync(stats, <span class="hljs-function"><span class="hljs-params">err</span> =></span> &#123;&#125;);
    &#125;;
&#125;)
&#125;

<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<p>è¿™ä¸ªå‡½æ•°çš„ä½œç”¨å°±æ˜¯å°†ç¼–è¯‘åçš„å†…å®¹ç”Ÿæˆæ–‡ä»¶ã€‚å…ˆè°ƒç”¨shouldEmitåˆ¤æ–­æ˜¯å¦ç¼–è¯‘æˆåŠŸï¼ŒæˆåŠŸä¹‹åå°±è°ƒç”¨Compiler.emitAssetsæ–¹æ³•æ‰“åŒ…æ–‡ä»¶ã€‚æˆ‘ä»¬å¯ä»¥çœ‹åˆ°compileræ–‡ä»¶é€šè¿‡å„ç§é’©å­æ§åˆ¶äº†æ•´ä¸ªç¼–è¯‘æµç¨‹ã€‚ä½†æ˜¯çœŸæ­£çš„ç¼–è¯‘æ˜¯åœ¨compilation.jsæ–‡ä»¶ä¸­ã€‚</p>
<p>so?æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹æœ€æ ¸å¿ƒçš„ç¼–è¯‘å‡½æ•°ï¼šcompilation</p>
<h2 data-id="heading-3">ä¸‰. compilation.js</h2>
<pre><code class="hljs language-javascript copyable" lang="javascript"> <span class="hljs-comment">// æ­£å¼å¯åŠ¨ç¼–è¯‘ </span>
  <span class="hljs-built_in">this</span>.hooks.make.callAsync(compilation, <span class="hljs-function"><span class="hljs-params">err</span> =></span> &#123;
    <span class="hljs-comment">// ç¼–è¯‘ç»“æŸ</span>
    compilation.finish(<span class="hljs-function"><span class="hljs-params">err</span> =></span> &#123;
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<p>åœ¨compiler.jsä¸­ï¼Œæˆ‘ä»¬å‘ç°ï¼Œåœ¨æ‰§è¡Œäº†makeé’©å­ä¹‹åï¼Œå¹¶æ²¡æœ‰æ‰§è¡Œä»»ä½•çš„compilationå¯¹è±¡çš„æ–¹æ³•ï¼Œè€Œæ˜¯åœ¨å®ƒçš„å›è°ƒå‡½æ•°ä¸­ç›´æ¥æ‰§è¡Œäº†compilation.finishæ–¹æ³•ã€‚é‚£ç¼–è¯‘åˆ°åº•æ˜¯å¦‚ä½•åšåˆ°çš„ï¼Ÿå…¶å®ï¼Œåœ¨å…³äºå…¥å£çš„æ’ä»¶ä¸­ï¼Œåœ¨makeè¿™ä¸ªé’©å­ä¸Šç»‘å®šäº†äº‹ä»¶ï¼Œå…¶ä¸­æ‰§è¡Œäº†addEntryè¿™ä¸ªæ·»åŠ å…¥å£çš„æ“ä½œï¼Œä»è¿™é‡Œå°±å¼€å§‹äº†çœŸæ­£çš„ç¼–è¯‘è¿‡ç¨‹ã€‚</p>
<p><strong>æ’æ’­</strong>ï¼šåœ¨æ‰§è¡Œæ·»åŠ å…¥å£addEntryæ“ä½œä¹‹å‰ï¼Œå…¥å£æ’ä»¶åšäº†å“ªäº›å‡†å¤‡å·¥ä½œå‘¢ï¼Ÿ</p>
<pre><code class="hljs language-javascript copyable" lang="javascript"><span class="hljs-comment">// WebpackOptionsApply.js</span>
<span class="hljs-keyword">new</span> EntryOptionPlugin().apply(compiler);
compiler.hooks.entryOption.call(options.context, options.entry);
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<p>ä¸Šé¢ä»£ç ä¸­ï¼Œåœ¨EntryOptionsPluginä¸­æ³¨å†Œäº†compiler.hooks.entryOptioné’©å­çš„äº‹ä»¶å¤„ç†å‡½æ•°ï¼Œå®ƒä¼šæ ¹æ®å…¥å£å€¼entryçš„ç±»å‹ä¸åŒï¼ŒåŒºåˆ†å•å…¥å£/å¤šå…¥å£ï¼Œå®ä¾‹åŒ–ä¸åŒçš„æ’ä»¶ç±»å‹ã€‚ï¼ˆ<code>SingleEntryPlugin</code>ï¼Œ<code>MultiEntryPlugin</code>ç­‰ï¼‰
<strong>æ’æ’­ç»“æŸï¼</strong></p>
<pre><code class="hljs language-javascript copyable" lang="javascript"><span class="hljs-comment">//SingleEntryPlugin.js</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SingleEntryPlugin</span> </span>&#123;
...
  <span class="hljs-function"><span class="hljs-title">apply</span>(<span class="hljs-params">compiler</span>)</span> &#123;
compiler.hooks.compilation.tap(
      <span class="hljs-string">"SingleEntryPlugin"</span>,
      <span class="hljs-function">(<span class="hljs-params">compilation, &#123; normalModuleFactory &#125;</span>) =></span> &#123;
        <span class="hljs-comment">// å­˜å‚¨é”®å€¼å¯¹ å°† SingleEntryDependency å’Œ normalModuleFactoryå…³è”èµ·æ¥</span>
        compilation.dependencyFactories.set(
          SingleEntryDependency,
          normalModuleFactory
        );
      &#125;
    );
    compiler.hooks.make.tapAsync(
      <span class="hljs-string">"SingleEntryPlugin"</span>,
      <span class="hljs-function">(<span class="hljs-params">compilation, callback</span>) =></span> &#123;
        ...
        compilation.addEntry(context, dep, name, callback);
      &#125;
    );
  &#125;
  ...
&#125;
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<p>æˆ‘ä»¬ä»¥å•å…¥å£ä¸ºä¾‹ï¼Œçœ‹ä¸€ä¸‹SingleEntryPluginåšäº†äº›ä»€ä¹ˆäº‹æƒ…ï¼Ÿ</p>
<ol>
<li>æ³¨å†Œäº† compilation äº‹ä»¶å›è°ƒã€‚</li>
<li>æ³¨å†Œäº† make äº‹ä»¶å›è°ƒã€‚</li>
</ol>
<ul>
<li>compilationäº‹ä»¶æ˜¯åœ¨å®ä¾‹åŒ–ç¼–è¯‘å™¨çš„æ—¶å€™è§¦å‘çš„ï¼Œåœ¨makeåŠ¨ä½œæ‰§è¡Œä¹‹å‰ï¼Œç»‘å®šè¿™ä¸ªé’©å­çš„æ’ä»¶å¯ä»¥è·å¾—ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯ç¼–è¯‘å™¨æœ¬èº«ï¼Œä¸€ä¸ªæ˜¯æ¨¡å—å·¥å‚ã€‚è¯¥å›è°ƒå‡½æ•°çš„ä½œç”¨æ˜¯å°†SingleEntryDependencyå’ŒnormalModuleFactoryå…³è”èµ·æ¥ã€‚</li>
<li>åœ¨makeé˜¶æ®µçš„æ—¶å€™è°ƒç”¨addEntry æ–¹æ³•ï¼Œç„¶åè¿›å…¥ _addModuleChain è¿›å…¥æ­£å¼çš„ç¼–è¯‘é˜¶æ®µã€‚</li>
</ul>
<pre><code class="hljs language-javascript copyable" lang="javascript"><span class="hljs-comment">// compiler.js</span>
<span class="hljs-function"><span class="hljs-title">addEntry</span>(<span class="hljs-params">context, entry, name, callback</span>)</span> &#123;
    <span class="hljs-built_in">this</span>.hooks.addEntry.call(entry, name);
...
    <span class="hljs-built_in">this</span>._addModuleChain(
      ...
      <span class="hljs-keyword">return</span> callback(<span class="hljs-literal">null</span>, <span class="hljs-built_in">module</span>);
    );
  &#125;
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<p>addEntryæ–¹æ³•åšäº†ä¸¤ä»¶äº‹ï¼š
1.è°ƒç”¨addEntryé’©å­
2.è°ƒç”¨_addModuleChainæ–¹æ³•ï¼Œæ‰§è¡Œç»“æŸåï¼Œå°†æ‰§è¡Œmakeé’©å­æºå¸¦è¿‡æ¥çš„å›è°ƒå‡½æ•°ï¼Œå‘ŠçŸ¥compilerç¼–è¯‘ç»“æŸã€‚
_addModuleChainåšäº†å‡ ä»¶äº‹ï¼ˆé‡ç‚¹ï¼‰ï¼š</p>
<pre><code class="hljs language-javascript copyable" lang="javascript"><span class="hljs-function"><span class="hljs-title">_addModuleChain</span>(<span class="hljs-params">context, dependency, onModule, callback</span>)</span> &#123;
...
    <span class="hljs-comment">// è·å–æ¨¡å—å·¥å‚ç±»å‹</span>
    <span class="hljs-keyword">const</span> moduleFactory = <span class="hljs-built_in">this</span>.dependencyFactories.get(Dep);
   ...
    <span class="hljs-built_in">this</span>.semaphore.acquire(<span class="hljs-function">() =></span> &#123;
      <span class="hljs-comment">// åˆ›å»ºæ–°æ¨¡å— module</span>
      moduleFactory.create(
    ...
    <span class="hljs-comment">// å°†æ¨¡å—åŠ å…¥åˆ°compilation.modulesä¸­</span>
          <span class="hljs-keyword">const</span> addModuleResult = <span class="hljs-built_in">this</span>.addModule(<span class="hljs-built_in">module</span>);
          <span class="hljs-built_in">module</span> = addModuleResult.module;
          <span class="hljs-comment">// å…¥å£æ¨¡å—åŠ å…¥compilation.entries</span>
          onModule(<span class="hljs-built_in">module</span>);
          
          <span class="hljs-comment">// å¤„ç†æ¨¡å—çš„ä¾èµ– å†è½¬æ¢ä¾èµ– ç»„æˆæ¨¡å—é“¾</span>
          <span class="hljs-keyword">const</span> afterBuild = <span class="hljs-function">() =></span> &#123;
            <span class="hljs-keyword">if</span> (addModuleResult.dependencies) &#123;
              <span class="hljs-built_in">this</span>.processModuleDependencies(<span class="hljs-built_in">module</span>, <span class="hljs-function"><span class="hljs-params">err</span> =></span> &#123;
                ...
              &#125;);
            &#125; 
          &#125;;

          <span class="hljs-keyword">if</span> (addModuleResult.build) &#123;
            <span class="hljs-comment">// æ„å»º è½¬æ¢æ¨¡å—ä»£ç ï¼ˆparse loader generateï¼‰</span>
            <span class="hljs-built_in">this</span>.buildModule(<span class="hljs-built_in">module</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-function"><span class="hljs-params">err</span> =></span> &#123;
              ...
              <span class="hljs-comment">// åˆ¤æ–­ä¾èµ–</span>
              afterBuild();
            &#125;);
    &#125;);
  &#125;
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<p>_addModuleChainæµç¨‹åˆ†æï¼š</p>
<p>1ï¼‰<strong>è·å–å…¥å£å¯¹åº”çš„æ¨¡å—å·¥å‚ç±»å‹</strong></p>
<p>æ ¹æ®ä¸åŒ dependency ç±»å‹ï¼Œè·å– multiModuleFactoryï¼ˆå¤šå…¥å£æ¨¡å—çš„ç”Ÿäº§å·¥å‚ï¼‰ æˆ–è€…normalModuleFacotryï¼ˆå•å…¥å£æ¨¡å—çš„å·¥å‚ï¼‰
2)  <strong>è°ƒç”¨moduleFactory.createåˆ›å»ºå…¥å£æ¨¡å—</strong></p>
<p>å¯¹äºå•å…¥å£æ¥è¯´ï¼ŒmoduleFactory.createè°ƒç”¨çš„æ˜¯normalModuleFacotryçš„createæ–¹æ³•ã€‚è¯¥æ–¹æ³•ä¸»è¦ä½œç”¨å°±æ˜¯è·å–æ–‡ä»¶å’Œloaderså¯¹åº”çš„ç»å¯¹è·¯å¾„ï¼Œå¹¶å®ä¾‹åŒ–æ¨¡å—å·¥å‚åˆ›å»ºæ¨¡å—ã€‚
<strong>æ’æ’­</strong>ï¼šmoduleFactory.createåšäº†ä»€ä¹ˆï¼Ÿ</p>
<pre><code class="hljs language-javascript copyable" lang="javascript"><span class="hljs-function"><span class="hljs-title">create</span>(<span class="hljs-params">data, callback</span>)</span> &#123;
<span class="hljs-comment">//...çœç•¥éƒ¨åˆ†é€»è¾‘</span>
<span class="hljs-built_in">this</span>.hooks.beforeResolve.callAsync(
&#123;
contextInfo,
resolveOptions,
context,
request,
dependencies
&#125;,
<span class="hljs-function">(<span class="hljs-params">err, result</span>) =></span> &#123;
<span class="hljs-comment">//...</span>
<span class="hljs-comment">// è§¦å‘ normalModuleFactory ä¸­çš„ factory äº‹ä»¶ã€‚</span>
<span class="hljs-keyword">const</span> factory = <span class="hljs-built_in">this</span>.hooks.factory.call(<span class="hljs-literal">null</span>);
<span class="hljs-comment">// Ignored</span>
<span class="hljs-keyword">if</span> (!factory) <span class="hljs-keyword">return</span> callback();
factory(result, <span class="hljs-function">(<span class="hljs-params">err, <span class="hljs-built_in">module</span></span>) =></span> &#123;
<span class="hljs-comment">//...</span>
callback(<span class="hljs-literal">null</span>, <span class="hljs-built_in">module</span>);
&#125;);
&#125;
);
&#125;
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<ul>
<li>è§¦å‘ beforeResolve äº‹ä»¶</li>
<li>è§¦å‘ NormalModuleFactory ä¸­çš„ factory äº‹ä»¶ã€‚åœ¨ NormalModuleFactory çš„ constructor ä¸­æœ‰ä¸€æ®µæ³¨å†Œ factory äº‹ä»¶çš„é€»è¾‘ã€‚</li>
<li>æ‰§è¡Œ factory æ–¹æ³•ï¼Œä¸»è¦æµç¨‹å¦‚ä¸‹ï¼š</li>
</ul>
<p><img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" class="lazyload" src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a19741bd7b0f41ba943baeaac95170a5~tplv-k3u1fbpfcp-zoom-1.image" data-width="800" data-height="600" referrerpolicy="no-referrer">
factory æ–¹æ³•åšäº†ä¸¤ä»¶äº‹æƒ…ï¼šè·å–æ–‡ä»¶çš„ç»å¯¹è·¯å¾„åŠå…¶å¯¹åº”çš„loadersçš„ç»å¯¹è·¯å¾„ï¼Œç”ŸæˆnormalModuleå®ä¾‹ï¼Œå¹¶å°†æ–‡ä»¶è·¯å¾„å’Œloadersè·¯å¾„å­˜æ”¾åˆ°è¯¥å®ä¾‹ä¸­ã€‚</p>
<p><strong>æ’æ’­ç»“æŸ</strong></p>
<p>3ï¼‰<strong>addModule</strong>
å¾—åˆ°æ¨¡å—å®ä¾‹ä¹‹åï¼Œå°†å…¶å­˜æ”¾äºå…¨å±€çš„ Compilation.modules æ•°ç»„ä¸­å’Œ _modules å¯¹è±¡ä¸­ã€‚
è¿™ä¸ªé˜¶æ®µå¯ä»¥çœ‹æˆaddé˜¶æ®µï¼Œä»–ä¼šå°†moduleçš„æ‰€æœ‰ä¿¡æ¯éƒ½å­˜äºCompilation ä¸­ï¼Œä»¥ä¾¿äºåœ¨æœ€åæ‰“åŒ…æˆ chunk çš„æ—¶å€™ä½¿ç”¨ã€‚</p>
<p>4ï¼‰<strong>è°ƒç”¨buildModuleè§£ææ¨¡å—ï¼Œè¾“å‡ºä¾èµ–åˆ—è¡¨</strong>
è¯¥é˜¶æ®µåšäº†ä»¥ä¸‹å‡ ä»¶äº‹æƒ…ï¼š</p>
<ul>
<li>è¿è¡ŒLoader</li>
<li>Parserè§£æå‡ºAST</li>
<li>walkStatementsè§£æå‡ºä¾èµ–</li>
</ul>
<p><strong>æ’æ’­</strong>ï¼šbuildModuleåšäº†ä»€ä¹ˆäº‹æƒ…ï¼Ÿ
moduleNormalModule çš„å®ä¾‹ï¼ŒCompilation.buildModuleå®é™…ä¸Šè°ƒç”¨çš„æ˜¯NormalModule.build æ–¹æ³•ï¼šbuildæ–¹æ³•é€»è¾‘å¦‚ä¸‹ï¼š</p>
<pre><code class="hljs language-javascript copyable" lang="javascript"> <span class="hljs-comment">// NormalModule.build æ–¹æ³•</span>
<span class="hljs-function"><span class="hljs-title">build</span>(<span class="hljs-params">options, compilation, resolver, fs, callback</span>)</span> &#123;
  <span class="hljs-comment">//...</span>
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.doBuild(options, compilation, resolver, fs, <span class="hljs-function"><span class="hljs-params">err</span> =></span> &#123;
    <span class="hljs-comment">//...</span>
    <span class="hljs-keyword">try</span> &#123;
       <span class="hljs-comment">// è¿™é‡Œä¼šå°† source è½¬ä¸º ASTï¼Œåˆ†æå‡ºæ‰€æœ‰çš„ä¾èµ–</span>
<span class="hljs-keyword">const</span> result = <span class="hljs-built_in">this</span>.parser.parse(<span class="hljs-comment">/*å‚æ•°*/</span>);
<span class="hljs-keyword">if</span> (result !== <span class="hljs-literal">undefined</span>) &#123;
<span class="hljs-comment">// parse is sync</span>
handleParseResult(result);
&#125;
&#125; <span class="hljs-keyword">catch</span> (e) &#123;
handleParseError(e);
&#125;
  &#125;)
&#125;

<span class="hljs-comment">// NormalModule.doBuild æ–¹æ³•</span>
<span class="hljs-function"><span class="hljs-title">doBuild</span>(<span class="hljs-params">options, compilation, resolver, fs, callback</span>)</span> &#123;
<span class="hljs-comment">//...</span>
<span class="hljs-comment">// æ‰§è¡Œå„ç§ loader</span>
runLoaders(
&#123;
<span class="hljs-attr">resource</span>: <span class="hljs-built_in">this</span>.resource,
<span class="hljs-attr">loaders</span>: <span class="hljs-built_in">this</span>.loaders,
<span class="hljs-attr">context</span>: loaderContext,
<span class="hljs-attr">readResource</span>: fs.readFile.bind(fs)
&#125;,
<span class="hljs-function">(<span class="hljs-params">err, result</span>) =></span> &#123;
<span class="hljs-comment">//...</span>
<span class="hljs-comment">// createSource ä¼šå°† runLoader å¾—åˆ°çš„ç»“æœè½¬ä¸ºå­—ç¬¦ä¸²ä»¥ä¾¿åç»­å¤„ç†</span>
<span class="hljs-built_in">this</span>._source = <span class="hljs-built_in">this</span>.createSource(
<span class="hljs-built_in">this</span>.binary ? asBuffer(source) : asString(source),
resourceBuffer,
sourceMap
);
<span class="hljs-comment">//...</span>
&#125;
);
&#125;
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<p>åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼š</p>
<ul>
<li>doBuildå‡½æ•°ï¼šå¯¹æºæ–‡ä»¶æ‰§è¡Œloadersï¼ŒdoBuildæ–¹æ³•æ‰æ˜¯çœŸæ­£å–åˆ°äº†æ–‡ä»¶çš„å†…å®¹ï¼Œå¹¶ç”¨loaderså¯¹å…¶è¿›è¡Œå¤„ç†ã€‚</li>
<li>doBuildå‡½æ•°å›è°ƒï¼šä½¿ç”¨acornå°†ä»£ç è½¬æ¢ä¸ºastæŠ½è±¡è¯­æ³•æ ‘ï¼Œéå†astæ‰¾å‡ºè¯¥æ–‡ä»¶çš„æ‰€æœ‰ä¾èµ–ï¼Œä¸ºè¯¥moduleå¢åŠ ä¾èµ–ï¼ˆdependency å®ä¾‹ï¼‰ï¼Œæ¯ä¸€ä¸ªdependency å®ä¾‹éƒ½æœ‰ä¸€ä¸ªtemplateæ–¹æ³•ï¼Œtemplateä¸­ä¿å­˜ç€æºä»£ç ä¸­è¯¥ä¾èµ–çš„å­—ç¬¦ä½ç½®rangeï¼Œåœ¨æœ€åç”Ÿæˆæ–‡ä»¶çš„æ—¶å€™ï¼Œä¼šå°†è¯¥rangeæ›¿æ¢æˆä¾èµ–æ–‡ä»¶çš„å†…å®¹ã€‚</li>
</ul>
<p>4ï¼‰<strong>æ‰§è¡ŒbuildModuleçš„å›è°ƒå‡½æ•°afterBuild</strong></p>
<pre><code class="hljs language-javascript copyable" lang="javascript"><span class="hljs-keyword">const</span> afterBuild = <span class="hljs-function">() =></span> &#123;
...
<span class="hljs-comment">// å¦‚æœæœ‰ä¾èµ–ï¼Œåˆ™è¿›å…¥ processModuleDependencies</span>
<span class="hljs-keyword">if</span> (addModuleResult.dependencies) &#123;
<span class="hljs-built_in">this</span>.processModuleDependencies(<span class="hljs-built_in">module</span>, <span class="hljs-function"><span class="hljs-params">err</span> =></span> &#123;
<span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">return</span> callback(err);
callback(<span class="hljs-literal">null</span>, <span class="hljs-built_in">module</span>);
&#125;);
&#125; <span class="hljs-keyword">else</span> &#123;
<span class="hljs-keyword">return</span> callback(<span class="hljs-literal">null</span>, <span class="hljs-built_in">module</span>);
&#125;
&#125;;
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<ul>
<li>æ‰§è¡ŒprocessModuleDependenciesæ–¹æ³•ï¼Œå¤„ç†æ¨¡å—ä¾èµ–</li>
<li>å¤„ç†ä¾èµ–çš„æ–¹å¼ä¸ä¸»æ–‡ä»¶ç±»ä¼¼ï¼Œä¼šé‡å¤æ‰§è¡Œreate-->build-->add-->processDepæ•´ä¸ªæµç¨‹ï¼Œæ„å»ºå®Œæ•´çš„æ¨¡å—é“¾ã€‚</li>
</ul>
<p>å®Œæˆç¼–è¯‘è¿‡ç¨‹ç”Ÿæˆæ¨¡å—é“¾ä¹‹åï¼Œæ‰§è¡Œmakeäº‹ä»¶çš„å›è°ƒå‡½æ•°ï¼Œå‘ŠçŸ¥compilerç¼–è¯‘å®Œæ¯•ã€‚å¼€å§‹æ‰§è¡Œseallå°è£…æ“ä½œã€‚</p>
<h2 data-id="heading-4">å››.sealå°è£…</h2>
<pre><code class="hljs language-javascript copyable" lang="javascript"><span class="hljs-built_in">this</span>.hooks.make.callAsync(compilation, <span class="hljs-function"><span class="hljs-params">err</span> =></span> &#123;
        ...
          compilation.seal(<span class="hljs-function"><span class="hljs-params">err</span> =></span> &#123;
          ...
            <span class="hljs-built_in">this</span>.hooks.afterCompile.callAsync(compilation, err
             ...
            &#125;);
          &#125;);
        &#125;);
      &#125;);
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<p>makeç¼–è¯‘è¿‡ç¨‹ç»“æŸåï¼Œå¼€å§‹æ‰§è¡Œcompilationçš„sealé’©å­ï¼Œå¼€å§‹chunkçš„æ„å»ºå’Œä¼˜åŒ–æ‰“åŒ…è¿‡ç¨‹ã€‚
æ­¤è¿‡ç¨‹ä¼šæ ¹æ®å…¥å£æ–‡ä»¶ã€é…ç½®ä¸­å…³äºä¼˜åŒ–åˆ†åŒ…çš„å‚æ•°å»åˆå¹¶ç”Ÿæˆå¤šä¸ªchunkã€‚
å› ä¸ºè¿™éƒ¨åˆ†ä»£ç è¿‡äºå†—é•¿ï¼Œä¸”åµŒå¥—å¾ˆå¤šï¼Œè¿™é‡Œå°±ä¸ç²˜è´´ä»£ç è¿›è¡Œè§£æäº†ï¼Œæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ä»¥æ–‡ç« å¼€å¤´çš„ä»£ç ä¸ºä¾‹è¯´æ˜chunkå½¢æˆçš„è¿‡ç¨‹ï¼Œä¾¿äºç†è§£ï¼š
<img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" class="lazyload" src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ea4e41eac8c04f0f9d7aa1096e90d84f~tplv-k3u1fbpfcp-zoom-1.image" data-width="800" data-height="600" referrerpolicy="no-referrer"></p>
<p>é¦–å…ˆï¼Œwebpackä¼šä¸ºæ‰€æœ‰çš„moduleç”Ÿæˆ<strong>module graph</strong>ï¼ˆæ¨¡å—å›¾è°±ï¼Œå¦‚ä¸Šå›¾ï¼‰ã€‚æ¨¡å—å›¾è°±çš„å½¢æˆè¿‡ç¨‹å°±æ˜¯ä»å…¥å£æ–‡ä»¶å¼€å§‹ï¼Œåˆ†ææ¯ä¸€ä¸ªæ¨¡å—çš„åŒæ­¥ä¾èµ–moduleså’Œå¼‚æ­¥ä¾èµ–blocksï¼Œå¯¹äºåŒæ­¥ä¾èµ–ï¼Œå†æ‰§è¡Œä»¥ä¸Šæ­¥éª¤ã€‚å¯¹äºå¼‚æ­¥ä¾èµ–ï¼Œä¼šå•ç‹¬æ‹¿å‡ºæ¥è¿›è¡Œåˆ†æï¼Œä¾¿äºåé¢å°†å¼‚æ­¥ä¾èµ–å•ç‹¬è¿›è¡Œæ‰“åŒ…ã€‚
<img alt="å›¾2" class="lazyload" src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/181e7ab3f6d84d8e9f43c9298a9e3ba4~tplv-k3u1fbpfcp-zoom-1.image" data-width="800" data-height="600" referrerpolicy="no-referrer"></p>
<p>å…¶æ¬¡ï¼Œä¸Šå›¾æ˜¯æ ¹æ®<strong>module graph</strong> ç”Ÿæˆ<strong>basic chunk graph</strong>çš„ç»“æœï¼Œç”Ÿæˆäº†3ä¸ªchunkGroupã€‚basic chunk graphçš„ç”Ÿæˆè¿‡ç¨‹æ˜¯ï¼šå…¥å£æ–‡ä»¶å’Œå¼‚æ­¥æ–‡ä»¶ï¼Œwebpackä¼šä¸ºå®ƒä»¬å•ç‹¬ç”Ÿæˆä¸€ä¸ªchunkï¼Œä»å…¥å£æ–‡ä»¶å¼€å§‹ï¼Œéå†å®ƒçš„åŒæ­¥ä¾èµ–modulesä»¥åŠä¾èµ–modulesçš„ä¾èµ–...ï¼ŒåŒæ—¶å°†è¯¥æ¨¡å—ä¸å…¥å£æ–‡ä»¶çš„chunkç›¸å…³è”ï¼Œç›´åˆ°æ²¡æœ‰æ‰¾åˆ°åŒæ­¥ä¾èµ–ä¸ºæ­¢ï¼ˆå¾—åˆ°ä¸Šå›¾ç¬¬ä¸€ä¸ªchunkGroupï¼‰ã€‚åœ¨éå†çš„è¿‡ç¨‹ä¸­ï¼Œå¦‚æœé‡åˆ°å¼‚æ­¥ä¾èµ–ï¼Œå°±å•ç‹¬åˆ›å»ºä¸€ä¸ªchunkï¼Œå†æ‰§è¡Œä»¥ä¸Šè¿‡ç¨‹ï¼Œå…³è”moduleså’Œchunkï¼Œè¿™æ ·å°±å®Œæˆäº†æœ€åä¸¤ä¸ªchunkGroupçš„å½¢æˆã€‚</p>
<p><img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" class="lazyload" src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0c33ae07fd7241e6a90ec3f5d065a4bf~tplv-k3u1fbpfcp-zoom-1.image" data-width="800" data-height="600" referrerpolicy="no-referrer">
æœ€åä¸€æ­¥ï¼Œå¾—åˆ°<strong>ä¼˜åŒ–chunk graph</strong>ã€‚è§‚å¯Ÿbasic chunk graphçš„ç»“æœï¼šå‘ç°ä¸‰ä¸ªåŒ…ä¸­éƒ½æœ‰d.jsï¼Œè¿™æ ·æ‰“åŒ…ä¹‹åä¼šé€ æˆé‡å¤æ‰“åŒ…ã€‚åä¸¤ä¸ªå¼‚æ­¥åŠ è½½çš„åŒ…ä¸­éœ€è¦çš„d.jså·²ç»åœ¨å…¥å£åŒ…ä¸­è¿›è¡Œäº†åŒæ­¥åŠ è½½ï¼ŒåŒæ­¥åŠ è½½çš„ä¼˜å…ˆçº§å¤§äºå¼‚æ­¥åŠ è½½ï¼Œæ‰€ä»¥åä¸¤ä¸ªchunkGroupéœ€è¦çš„d.jså¯ä»¥å»æ‰ã€‚å†çœ‹ç¬¬ä¸‰ä¸ªåŒ…ä¸­éœ€è¦çš„b.jsï¼Œä¹Ÿå·²ç»åœ¨å…¥å£åŒ…ä¸­ä»¥åŒæ­¥çš„å½¢å¼åŠ è½½è¿‡äº†ï¼Œæ‰€ä»¥ä¹Ÿä¸éœ€è¦ï¼Œå°†ç¬¬ä¸‰ä¸ªåŒ…åˆ æ‰ï¼Œå°±å¾—åˆ°äº†æœ€ç»ˆçš„chunkã€‚</p>
<h2 data-id="heading-5">äº”.è¾“å‡ºæ‰“åŒ…æ–‡ä»¶</h2>
<p>æ•´åˆchunkå®Œæ¯•ä¹‹åï¼Œæœ€åè¦è¾“å‡ºæ‰“åŒ…æ–‡ä»¶ã€‚æˆ‘ä»¬å¾—åˆ°çš„moduleã€chunkæ–‡ä»¶éƒ½æ˜¯é€šè¿‡requireè¿›è¡Œèšåˆçš„ä»£ç ï¼Œä¸å¯ä»¥åœ¨æµè§ˆå™¨ä¸­è¿è¡Œï¼Œwebpackä¼šæä¾›templateæ¨¡ç‰ˆäº§ç”Ÿå¸¦æœ‰_webpack_require()æ ¼å¼çš„ä»£ç ï¼ˆå®è´¨ä¸Šæ˜¯webpackå®ç°äº†ç®€å•çš„requireå‡½æ•°ï¼‰ï¼Œè¿™æ ·æ‰“åŒ…ä¹‹åçš„ä»£ç å°±å¯ä»¥åœ¨æµè§ˆå™¨ä¸­è¿è¡Œäº†ã€‚</p>
<p><a href="https://blog.csdn.net/weixin_38208314/article/details/114978932" target="_blank" rel="nofollow noopener noreferrer">å…³äºwebpackæ¨¡å—åŒ–å¯å‚è€ƒè¿™ç¯‡æ–‡ç« </a></p>
<p>æœ€åï¼Œé€šè¿‡emitAssetså°†æœ€ç»ˆçš„jsè¾“å‡ºåˆ°outputçš„pathä¸­ã€‚</p>
<p>é™„ä¸Šä¸€å¼ webpackæ‰“åŒ…æµç¨‹å›¾ã€‚</p>
<p><img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" class="lazyload" src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1b30640cfd3b4f6dbf92a06788161833~tplv-k3u1fbpfcp-zoom-1.image" data-width="800" data-height="600" referrerpolicy="no-referrer">
å‚è€ƒåšå®¢ï¼š
<a href="https://juejin.cn/post/6844903728735059976#heading-25" target="_blank">juejin.cn/post/684490â€¦</a>
<a href="https://juejin.cn/post/6844903903675285511#heading-4" target="_blank">juejin.cn/post/684490â€¦</a>
<a href="https://juejin.cn/post/6844903864592760845" target="_blank">juejin.cn/post/684490â€¦</a></p></div> <div class="image-viewer-box" data-v-78c9b824><!----></div>  
</div>
            