
---
title: '腾讯地图定位打卡功能实现'
categories: 
 - 编程
 - 掘金
 - 分类
headimg: 'https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/54f2038f864046578d45580999e3dec3~tplv-k3u1fbpfcp-watermark.image'
author: 掘金
comments: false
date: Mon, 14 Jun 2021 19:42:19 GMT
thumbnail: 'https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/54f2038f864046578d45580999e3dec3~tplv-k3u1fbpfcp-watermark.image'
---

<div>   
<div class="markdown-body"><style>.markdown-body&#123;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333&#125;.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6&#123;line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px&#125;.markdown-body h1&#123;font-size:30px;margin-bottom:5px&#125;.markdown-body h2&#123;padding-bottom:12px;font-size:24px;border-bottom:1px solid #ececec&#125;.markdown-body h3&#123;font-size:18px;padding-bottom:0&#125;.markdown-body h4&#123;font-size:16px&#125;.markdown-body h5&#123;font-size:15px&#125;.markdown-body h6&#123;margin-top:5px&#125;.markdown-body p&#123;line-height:inherit;margin-top:22px;margin-bottom:22px&#125;.markdown-body img&#123;max-width:100%&#125;.markdown-body hr&#123;border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px&#125;.markdown-body code&#123;word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em&#125;.markdown-body code,.markdown-body pre&#123;font-family:Menlo,Monaco,Consolas,Courier New,monospace&#125;.markdown-body pre&#123;overflow:auto;position:relative;line-height:1.75&#125;.markdown-body pre>code&#123;font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8&#125;.markdown-body a&#123;text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff&#125;.markdown-body a:active,.markdown-body a:hover&#123;color:#275b8c&#125;.markdown-body table&#123;display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6&#125;.markdown-body thead&#123;background:#f6f6f6;color:#000;text-align:left&#125;.markdown-body tr:nth-child(2n)&#123;background-color:#fcfcfc&#125;.markdown-body td,.markdown-body th&#123;padding:12px 7px;line-height:24px&#125;.markdown-body td&#123;min-width:120px&#125;.markdown-body blockquote&#123;color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8&#125;.markdown-body blockquote:after&#123;display:block;content:""&#125;.markdown-body blockquote>p&#123;margin:10px 0&#125;.markdown-body ol,.markdown-body ul&#123;padding-left:28px&#125;.markdown-body ol li,.markdown-body ul li&#123;margin-bottom:0;list-style:inherit&#125;.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item&#123;list-style:none&#125;.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul&#123;margin-top:0&#125;.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul&#123;margin-top:3px&#125;.markdown-body ol li&#123;padding-left:6px&#125;.markdown-body .contains-task-list&#123;padding-left:0&#125;.markdown-body .task-list-item&#123;list-style:none&#125;@media (max-width:720px)&#123;.markdown-body h1&#123;font-size:24px&#125;.markdown-body h2&#123;font-size:20px&#125;.markdown-body h3&#123;font-size:18px&#125;&#125;</style><h2 data-id="heading-0">如何使用腾讯位置服务API</h2>
<p>1、注册成为开发者</p>
<p>2、申请密钥，在如图位置创建新密钥</p>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/54f2038f864046578d45580999e3dec3~tplv-k3u1fbpfcp-watermark.image" alt="image.png" loading="lazy" referrerpolicy="no-referrer"></p>
<p>3、进行配置</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/dbfaad5c1f7d491b9e02d72740acac9a~tplv-k3u1fbpfcp-watermark.image" alt="image.png" loading="lazy" referrerpolicy="no-referrer"></p>
<h2 data-id="heading-1">官方Api使用示例（JavaScript）</h2>
<h3 data-id="heading-2">通过搜索接口找到个人公司位置：</h3>
<p><a href="https://apis.map.qq.com/ws/place/v1/search?keyword=%E5%98%89%E8%AA%89%E5%9B%BD%E9%99%85&boundary=region(%E4%B8%8A%E6%B5%B7,0)" target="_blank" rel="nofollow noopener noreferrer">apis.map.qq.com/ws/place/v1…</a> &key=你申请的key</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0956d620861348f7b49ae1dc2f3e8421~tplv-k3u1fbpfcp-watermark.image" alt="image.png" loading="lazy" referrerpolicy="no-referrer"></p>
<p>查询到公司位置为(31.329716,121.508386)</p>
<h3 data-id="heading-3">初始化地图，中心设为公司位置</h3>
<pre><code class="copyable"><!DOCTYPE html>
<html>
<head>
    
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Hello world!</title>
    <style type="text/css">
        #container&#123;
            /*地图(容器)显示大小*/
            width:1200px;
            height:400px;
        &#125;
    </style>
    <!--引入Javascript API GL，参数说明参见下文-->
    <script src="https://map.qq.com/api/gljs?v=1.exp&key=OB4BZ-D4W3U-B7VVO-4PJWW-6TKDJ-WPB77"></script>
    <script>
        //地图初始化函数，本例取名为init，开发者可根据实际情况定义
        function initMap() &#123;
            //定义地图中心点坐标
            var center = new TMap.LatLng(31.329716, 121.508386);
            //定义map变量，调用 TMap.Map() 构造函数创建地图
            var map = new TMap.Map(document.getElementById('container'), &#123;
                center: center,//设置地图中心点坐标
                viewMode:'2D',//设置显示模式 2D 3D可以自己修改
                zoom: 17.2,   //设置地图缩放级别
                pitch: 43.5,  //设置俯仰角
                rotation: 45    //设置地图旋转角度
            &#125;);
        &#125;
    </script>
</head>
<!-- 页面载入后，调用init函数 -->
<body onload="initMap()">
<!-- 定义地图显示容器 -->
<div id="container"></div>
</body>
</html>
<span class="copy-code-btn">复制代码</span></code></pre>
<p>效果展示：</p>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f3a80f28f968449ba9146e0386614edf~tplv-k3u1fbpfcp-watermark.image" alt="image.png" loading="lazy" referrerpolicy="no-referrer"></p>
<p>标注的位置就是设置的中心啦。</p>
<h3 data-id="heading-4">为公司位置位置打上标记</h3>
<p>效果示例：</p>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7411a8e836ff4d64bbff3ad952beffde~tplv-k3u1fbpfcp-watermark.image" alt="image.png" loading="lazy" referrerpolicy="no-referrer"></p>
<p>公司的位置加上了style中写的图片，代码如下：</p>
<pre><code class="copyable"><script src="https://map.qq.com/api/gljs?v=1.exp&key=OB4BZ-D4W3U-B7VVO-4PJWW-6TKDJ-WPB77"></script>
<script>
    //地图初始化函数，本例取名为init，开发者可根据实际情况定义
    function initMap() &#123;
        //创建map对象，初始化地图
        var center = new TMap.LatLng(31.329716, 121.508386);
        var map = new TMap.Map(document.getElementById('container'), &#123;
            center: center,//设置地图中心点坐标
            zoom: 17.2,   //设置地图缩放级别
            pitch: 43.5,  //设置俯仰角
            rotation: 45    //设置地图旋转角度
        &#125;);
        //创建并初始化MultiMarker
        var markerLayer = new TMap.MultiMarker(&#123;
            map: map,  //指定地图容器
            //样式定义
            styles: &#123;
                //创建一个styleId为"myStyle"的样式（styles的子属性名即为styleId）
                "myStyle": new TMap.MarkerStyle(&#123;
                    "width": 25,  // 点标记样式宽度（像素）
                    "height": 35, // 点标记样式高度（像素）
                    "src": '微信图片_20210107230437.jpg',  //图片路径
                    //焦点在图片中的像素位置，一般大头针类似形式的图片以针尖位置做为焦点，圆形点以圆心位置为焦点
                    "anchor": &#123; x: 16, y: 32 &#125;
                &#125;)
            &#125;,
            //点标记数据数组
            geometries: [&#123;
                "id": "1",   //点标记唯一标识，后续如果有删除、修改位置等操作，都需要此id
                "styleId": 'myStyle',  //指定样式id
                "position": new TMap.LatLng(31.329716, 121.508386),  //点标记坐标位置
                "properties": &#123;//自定义属性
                    "title": "我的公司"
                &#125;
            &#125;
            ]
        &#125;);
    &#125;

</script>
<span class="copy-code-btn">复制代码</span></code></pre>
<h3 data-id="heading-5">让标记的点动起来</h3>
<p>主要通过使用moveAlong方法，定义移动的轨迹path，在moveAlong中传入移动的路线和坐标点，坐标点是geometries中的标记。</p>
<pre><code class="copyable">    <script>
    //地图初始化函数，本例取名为init，开发者可根据实际情况定义
    function initMap() &#123;
        //创建map对象，初始化地图
        var center = new TMap.LatLng(31.329716, 121.508386);
        var map = new TMap.Map(document.getElementById('container'), &#123;
            center: center,//设置地图中心点坐标
            zoom: 17.2,   //设置地图缩放级别
            pitch: 43.5,  //设置俯仰角
            rotation: 45    //设置地图旋转角度
        &#125;);
        //创建并初始化MultiMarker
        var marker = new TMap.MultiMarker(&#123;
            map: map,  //指定地图容器
            //样式定义
            styles: &#123;
                //创建一个styleId为"myStyle"的样式（styles的子属性名即为styleId）
                "myStyle": new TMap.MarkerStyle(&#123;
                    "width": 25,  // 点标记样式宽度（像素）
                    "height": 35, // 点标记样式高度（像素）
                    "src": '微信图片_20210107230437.jpg',  //图片路径
                    //焦点在图片中的像素位置，一般大头针类似形式的图片以针尖位置做为焦点，圆形点以圆心位置为焦点
                    "anchor": &#123; x: 16, y: 32 &#125;
                &#125;)
            &#125;,
            //点标记数据数组
            geometries: [&#123;
                "id": "person",   //点标记唯一标识，后续如果有删除、修改位置等操作，都需要此id
                "styleId": 'myStyle',  //指定样式id
                "position": new TMap.LatLng(31.329716, 121.508386),  //点标记坐标位置
                "properties": &#123;//自定义属性
                    "title": "我的公司"
                &#125;&#125;
            ]
        &#125;);

        //定义的移动路线
        var path = [
            new TMap.LatLng(31.329716, 121.508386),
            new TMap.LatLng(31.330720, 121.508388),
            new TMap.LatLng(31.349725, 121.508389),
            new TMap.LatLng(31.359730, 121.508389),
            new TMap.LatLng(31.369718, 121.518400)
        ];

        marker.moveAlong(&#123;
                //让坐标动起来
                "person": &#123;
                    path,
                    //速度为100
                    speed: 100
                &#125;
            &#125;, &#123;
                autoRotation:true   //车头始终向前（沿路线自动旋转）
            &#125;
        )
    &#125;

</script>
<span class="copy-code-btn">复制代码</span></code></pre>
<h2 data-id="heading-6">使用腾讯位置服务API打卡功能实现</h2>
<h3 data-id="heading-7">实现思路</h3>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/fac6b0682f1e42889cdd9742496f7d9f~tplv-k3u1fbpfcp-watermark.image" alt="111.png" loading="lazy" referrerpolicy="no-referrer"></p>
<h4 data-id="heading-8">位置搜索</h4>
<p>接口：<a href="https://apis.map.qq.com/ws/place/v1/search" target="_blank" rel="nofollow noopener noreferrer">apis.map.qq.com/ws/place/v1…</a></p>
<p>搜索上海 上海五角场地铁站的位置</p>
<p>示例：<a href="https://apis.map.qq.com/ws/place/v1/search?keyword=%E4%BA%94%E8%A7%92%E5%9C%BA%E5%9C%B0%E9%93%81%E7%AB%99&boundary=region(%E4%B8%8A%E6%B5%B7,0)&key=HLSBZ--" target="_blank" rel="nofollow noopener noreferrer">apis.map.qq.com/ws/place/v1…</a></p>
<p>搜索结果截取：</p>
<pre><code class="copyable">&#123;
    “id”: “10804093066539767491”,
    “title”: “五角场[地铁站]”,
    “address”: “地铁10号线”,
    “tel”: “”,
    “category”: “基础设施:交通设施:地铁站”,
    “type”: 2,
    “location”: &#123;
    “lat”: 31.298109,
    “lng”: 121.514651
&#125;,
“ad_info”: &#123;
    “adcode”: 310110,
    “province”: “上海市”,
    “city”: “上海市”,
    “district”: “杨浦区”
    &#125;
&#125;
<span class="copy-code-btn">复制代码</span></code></pre>
<p>现在知道五角场地铁站的经纬度了，就是Location那两个值。</p>
<p>注意key是创建好的这一串ID</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/505fa3c236d64782a4fe4be3154ccf88~tplv-k3u1fbpfcp-watermark.image" alt="image.png" loading="lazy" referrerpolicy="no-referrer"></p>
<p>通过搜索出来的是一个List，上述只拿出了List的第一位，通常第一位也是嘴和搜索关键字相符合的。通过搜索取出我们固定的经纬度的地址。</p>
<h4 data-id="heading-9">定位（Android定位）</h4>
<p>单次定位，获取当前设备位置</p>
<pre><code class="copyable">mLocationManager.requestSingleFreshLocation(null, mLocationListener, Looper.getMainLooper());
<span class="copy-code-btn">复制代码</span></code></pre>
<p>其他IOS等设备可以通过上述官网链接官方文档查看。</p>
<p>获取到位置后将该位置传到后台接口。</p>
<h4 data-id="heading-10">后台接口</h4>
<p>求距离：</p>
<pre><code class="copyable">// 写死的公司位置，实际项目中应该是数据库配置
private static final double COMPANY_LAT = 31.298109;
private static final double COMPANY_LNG = 121.514651;

@GetMapping("distance")
public Map<String,Double> queryDistance(Double lat,Double lng)&#123;
    HashMap<String, Double> result = new HashMap<>(4);
    double distance = distance(COMPANY_LAT, lat, COMPANY_LNG, lng);
    result.put("distance",distance);
    return result;
&#125;

/**
 * 求两个经纬度之间的距离
 */
public static double distance(double lat1, double lat2, double lng1, double lng2) &#123;
    final int r = 6371;
    double latDistance = Math.toRadians(lat2 - lat1);
    double lonDistance = Math.toRadians(lng2 - lng1);
    double a = Math.sin(latDistance / 2) * Math.sin(latDistance / 2)
            + Math.cos(Math.toRadians(lat1)) * Math.cos(Math.toRadians(lat2))
            * Math.sin(lonDistance / 2) * Math.sin(lonDistance / 2);
    double c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    double distance = r * c * 1000;
    distance = Math.pow(distance, 2);
    return Math.sqrt(distance);
&#125;
<span class="copy-code-btn">复制代码</span></code></pre>
<h2 data-id="heading-11">腾讯位置服务整体介绍</h2>
<p>到腾讯位置服务:官网注册后找到官方文档介绍： <a href="https://lbs.qq.com/?lbs_invite=SXPRFLS" target="_blank" rel="nofollow noopener noreferrer">官网</a></p>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5261d506054f4f0080ed900a32fd9081~tplv-k3u1fbpfcp-watermark.image" alt="image.png" loading="lazy" referrerpolicy="no-referrer"></p>
<p>腾讯位置服务已经提供了一套针对各个终端的开发接口，可以参考学习。</p>
<blockquote>
<p>作者：兴趣使然的程序猿</p>
<p>链接：<a href="https://binhao.blog.csdn.net/article/details/112736499" target="_blank" rel="nofollow noopener noreferrer">binhao.blog.csdn.net/article/det…</a></p>
<p>来源：CSDN</p>
<p>著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。</p>
</blockquote></div>  
</div>
            