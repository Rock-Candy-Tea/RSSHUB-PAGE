
---
title: 'ä»é›¶å¼€å§‹å†™ä¸€ä¸ªå¾®å‰ç«¯æ¡†æ¶-æ¸²æŸ“ç¯‡'
categories: 
 - ç¼–ç¨‹
 - æ˜é‡‘
 - åˆ†ç±»
headimg: 'https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9e356626120b420e890b13b8092243c2~tplv-k3u1fbpfcp-zoom-1.image'
author: æ˜é‡‘
comments: false
date: Mon, 02 Aug 2021 19:32:37 GMT
thumbnail: 'https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9e356626120b420e890b13b8092243c2~tplv-k3u1fbpfcp-zoom-1.image'
---

<div>   
<div class="markdown-body"><style>.markdown-body&#123;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333&#125;.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6&#123;line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px&#125;.markdown-body h1&#123;font-size:30px;margin-bottom:5px&#125;.markdown-body h2&#123;padding-bottom:12px;font-size:24px;border-bottom:1px solid #ececec&#125;.markdown-body h3&#123;font-size:18px;padding-bottom:0&#125;.markdown-body h4&#123;font-size:16px&#125;.markdown-body h5&#123;font-size:15px&#125;.markdown-body h6&#123;margin-top:5px&#125;.markdown-body p&#123;line-height:inherit;margin-top:22px;margin-bottom:22px&#125;.markdown-body img&#123;max-width:100%&#125;.markdown-body hr&#123;border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px&#125;.markdown-body code&#123;word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em&#125;.markdown-body code,.markdown-body pre&#123;font-family:Menlo,Monaco,Consolas,Courier New,monospace&#125;.markdown-body pre&#123;overflow:auto;position:relative;line-height:1.75&#125;.markdown-body pre>code&#123;font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8&#125;.markdown-body a&#123;text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff&#125;.markdown-body a:active,.markdown-body a:hover&#123;color:#275b8c&#125;.markdown-body table&#123;display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6&#125;.markdown-body thead&#123;background:#f6f6f6;color:#000;text-align:left&#125;.markdown-body tr:nth-child(2n)&#123;background-color:#fcfcfc&#125;.markdown-body td,.markdown-body th&#123;padding:12px 7px;line-height:24px&#125;.markdown-body td&#123;min-width:120px&#125;.markdown-body blockquote&#123;color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8&#125;.markdown-body blockquote:after&#123;display:block;content:""&#125;.markdown-body blockquote>p&#123;margin:10px 0&#125;.markdown-body ol,.markdown-body ul&#123;padding-left:28px&#125;.markdown-body ol li,.markdown-body ul li&#123;margin-bottom:0;list-style:inherit&#125;.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item&#123;list-style:none&#125;.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul&#123;margin-top:0&#125;.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul&#123;margin-top:3px&#125;.markdown-body ol li&#123;padding-left:6px&#125;.markdown-body .contains-task-list&#123;padding-left:0&#125;.markdown-body .task-list-item&#123;list-style:none&#125;@media (max-width:720px)&#123;.markdown-body h1&#123;font-size:24px&#125;.markdown-body h2&#123;font-size:20px&#125;.markdown-body h3&#123;font-size:18px&#125;&#125;</style><h2 data-id="heading-0">å‰è¨€</h2>
<p>è‡ªä»å¾®å‰ç«¯æ¡†æ¶<a href="https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Fmicro-zoe%2Fmicro-app" target="_blank" rel="nofollow noopener noreferrer" title="https://github.com/micro-zoe/micro-app" ref="nofollow noopener noreferrer">micro-app</a>å¼€æºåï¼Œå¾ˆå¤šå°ä¼™ä¼´éƒ½éå¸¸æ„Ÿå…´è¶£ï¼Œé—®æˆ‘æ˜¯å¦‚ä½•å®ç°çš„ï¼Œä½†è¿™å¹¶ä¸æ˜¯å‡ å¥è¯å¯ä»¥è¯´æ˜ç™½çš„ã€‚ä¸ºäº†è®²æ¸…æ¥šå…¶ä¸­çš„åŸç†ï¼Œæˆ‘ä¼šä»é›¶å¼€å§‹å®ç°ä¸€ä¸ªç®€æ˜“çš„å¾®å‰ç«¯æ¡†æ¶ï¼Œå®ƒçš„æ ¸å¿ƒåŠŸèƒ½åŒ…æ‹¬ï¼šæ¸²æŸ“ã€JSæ²™ç®±ã€æ ·å¼éš”ç¦»ã€æ•°æ®é€šä¿¡ã€‚ç”±äºå†…å®¹å¤ªå¤šï¼Œä¼šæ ¹æ®åŠŸèƒ½åˆ†æˆå››ç¯‡æ–‡ç« è¿›è¡Œè®²è§£ï¼Œè¿™æ˜¯ç³»åˆ—æ–‡ç« çš„ç¬¬ä¸€ç¯‡ï¼šæ¸²æŸ“ç¯‡ã€‚</p>
<p>é€šè¿‡è¿™äº›æ–‡ç« ï¼Œä½ å¯ä»¥äº†è§£å¾®å‰ç«¯æ¡†æ¶çš„å…·ä½“åŸç†å’Œå®ç°æ–¹å¼ï¼Œè¿™åœ¨ä½ ä»¥åä½¿ç”¨å¾®å‰ç«¯æˆ–è€…è‡ªå·±å†™ä¸€å¥—å¾®å‰ç«¯æ¡†æ¶æ—¶ä¼šæœ‰å¾ˆå¤§çš„å¸®åŠ©ã€‚å¦‚æœè¿™ç¯‡æ–‡ç« å¯¹ä½ æœ‰å¸®åŠ©ï¼Œæ¬¢è¿ç‚¹èµç•™è¨€ã€‚</p>
<h2 data-id="heading-1">ç›¸å…³æ¨è</h2>
<p>micro-appæºç åœ°å€ï¼š<a href="https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Fmicro-zoe%2Fmicro-app" target="_blank" rel="nofollow noopener noreferrer" title="https://github.com/micro-zoe/micro-app" ref="nofollow noopener noreferrer">github.com/micro-zoe/mâ€¦</a></p>
<h2 data-id="heading-2">æ•´ä½“æ¶æ„</h2>
<p>å’Œmicro-appä¸€æ ·ï¼Œæˆ‘ä»¬çš„ç®€æ˜“å¾®å‰ç«¯æ¡†æ¶è®¾è®¡æ€è·¯æ˜¯åƒä½¿ç”¨iframeä¸€æ ·ç®€å•ï¼Œè€Œåˆå¯ä»¥é¿å…iframeå­˜åœ¨çš„é—®é¢˜ï¼Œå…¶ä½¿ç”¨æ–¹å¼å¦‚ä¸‹ï¼š</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9e356626120b420e890b13b8092243c2~tplv-k3u1fbpfcp-zoom-1.image" alt loading="lazy" referrerpolicy="no-referrer"></p>
<p>æœ€ç»ˆæ•ˆæœä¹Ÿæœ‰ç‚¹ç±»ä¼¼ï¼Œæ•´ä¸ªå¾®å‰ç«¯åº”ç”¨éƒ½è¢«å°è£…åœ¨è‡ªå®šä¹‰æ ‡ç­¾micro-appä¸­ï¼Œæ¸²æŸ“åæ•ˆæœå¦‚ä¸‹å›¾ï¼š</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6f38a4dd17de425cbb8dc64b5be7fe78~tplv-k3u1fbpfcp-zoom-1.image" alt loading="lazy" referrerpolicy="no-referrer"></p>
<p>æ‰€ä»¥æˆ‘ä»¬æ•´ä½“æ¶æ„æ€è·¯ä¸ºï¼š<strong>CustomElement + HTMLEntry</strong>ã€‚</p>
<p>HTMLEntryå°±æ˜¯ä»¥htmlæ–‡ä»¶ä½œä¸ºå…¥å£åœ°å€è¿›è¡Œæ¸²æŸ“ï¼Œå…¥ä¸Šå›¾ä¸­çš„<code>http://localhost:3000/</code>å°±æ˜¯ä¸€ä¸ªhtmlåœ°å€ã€‚</p>
<p><strong>æ¦‚å¿µå›¾ï¼š</strong>
<img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a8b7969ccea14430a636aa3f04927c78~tplv-k3u1fbpfcp-zoom-1.image" alt loading="lazy" referrerpolicy="no-referrer"></p>
<h2 data-id="heading-3">å‰ç½®å·¥ä½œ</h2>
<p>åœ¨æ­£å¼å¼€å§‹ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦æ­å»ºä¸€ä¸ªå¼€å‘ç¯å¢ƒï¼Œåˆ›å»ºä¸€ä¸ªä»£ç ä»“åº“<code>simple-micro-app</code>ã€‚</p>
<p><strong>ç›®å½•ç»“æ„</strong>
<img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4f6818c7342648bfb5100cbaf359cad4~tplv-k3u1fbpfcp-zoom-1.image" alt loading="lazy" referrerpolicy="no-referrer"></p>
<p>ä»£ç ä»“åº“ä¸»è¦åˆ†ä¸ºsrcä¸»ç›®å½•å’Œexamplesæ¡ˆä¾‹ç›®å½•ï¼Œvue2ä¸ºåŸºåº§åº”ç”¨ï¼Œreact17ä¸ºå­åº”ç”¨ï¼Œä¸¤ä¸ªé¡¹ç›®éƒ½æ˜¯ä½¿ç”¨å®˜æ–¹è„šæ‰‹æ¶åˆ›å»ºçš„ï¼Œæ„å»ºå·¥å…·ä½¿ç”¨rollupã€‚</p>
<p>ä¸¤ä¸ªåº”ç”¨é¡µé¢åˆ†åˆ«å¦‚ä¸‹å›¾ï¼š</p>
<p><strong>åŸºåº§åº”ç”¨ -- vue2</strong>
<img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b8af281805564c15aa1b56f4897ce5c3~tplv-k3u1fbpfcp-zoom-1.image" alt loading="lazy" referrerpolicy="no-referrer"></p>
<p><strong>å­åº”ç”¨ -- react17</strong>
<img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0e87076e1cab43e7974621aa58127e64~tplv-k3u1fbpfcp-zoom-1.image" alt loading="lazy" referrerpolicy="no-referrer"></p>
<p>åœ¨vue2é¡¹ç›®ä¸­ï¼Œé…ç½®<code>resolve.alias</code>ï¼Œå°†simple-micro-appæŒ‡å‘srcç›®å½•çš„index.jsã€‚</p>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// vue.config.js</span>
...
<span class="hljs-attr">chainWebpack</span>: <span class="hljs-function"><span class="hljs-params">config</span> =></span> &#123;
    config.resolve.alias
      .set(<span class="hljs-string">"simple-micro-app"</span>, path.join(__dirname, <span class="hljs-string">'../../src/index.js'</span>))
  &#125;,
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<p>åœ¨react17çš„webpack-dev-serverä¸­é…ç½®é™æ€èµ„æºæ”¯æŒè·¨åŸŸè®¿é—®ã€‚</p>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// config/webpackDevServer.config.js</span>
...
<span class="hljs-attr">headers</span>: &#123;
  <span class="hljs-string">'Access-Control-Allow-Origin'</span>: <span class="hljs-string">'*'</span>,
&#125;,
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<h2 data-id="heading-4">æ­£å¼å¼€å§‹</h2>
<p>ä¸ºäº†è®²çš„æ›´åŠ æ˜ç™½ï¼Œæˆ‘ä»¬ä¸ä¼šç›´æ¥è´´å‡ºå·²ç»å®Œæˆçš„ä»£ç ï¼Œè€Œæ˜¯ä»æ— åˆ°æœ‰ï¼Œä¸€æ­¥æ­¥å®ç°æ•´ä¸ªè¿‡ç¨‹ï¼Œè¿™æ ·æ‰èƒ½æ›´åŠ æ¸…æ™°ï¼Œå®¹æ˜“ç†è§£ã€‚</p>
<h3 data-id="heading-5">åˆ›å»ºå®¹å™¨</h3>
<p>å¾®å‰ç«¯çš„æ¸²æŸ“æ˜¯å°†å­åº”ç”¨çš„jsã€cssç­‰é™æ€èµ„æºåŠ è½½åˆ°åŸºåº§åº”ç”¨ä¸­æ‰§è¡Œï¼Œæ‰€ä»¥åŸºåº§åº”ç”¨å’Œå­åº”ç”¨æœ¬è´¨æ˜¯åŒä¸€ä¸ªé¡µé¢ã€‚è¿™ä¸åŒäºiframeï¼Œiframeåˆ™æ˜¯åˆ›å»ºä¸€ä¸ªæ–°çš„çª—å£ï¼Œç”±äºæ¯æ¬¡åŠ è½½éƒ½è¦åˆå§‹åŒ–æ•´ä¸ªçª—å£ä¿¡æ¯ï¼Œæ‰€ä»¥iframeçš„æ€§èƒ½ä¸é«˜ã€‚</p>
<p>å¦‚åŒæ¯ä¸ªå‰ç«¯æ¡†æ¶åœ¨æ¸²æŸ“æ—¶éƒ½è¦æŒ‡å®šä¸€ä¸ªæ ¹å…ƒç´ ï¼Œå¾®å‰ç«¯æ¸²æŸ“æ—¶ä¹Ÿéœ€è¦æŒ‡å®šä¸€ä¸ªæ ¹å…ƒç´ ä½œä¸ºå®¹å™¨ï¼Œè¿™ä¸ªæ ¹å…ƒç´ å¯ä»¥æ˜¯ä¸€ä¸ªdivæˆ–å…¶å®ƒå…ƒç´ ã€‚</p>
<p>è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯é€šè¿‡customElementsåˆ›å»ºçš„è‡ªå®šä¹‰å…ƒç´ ï¼Œå› ä¸ºå®ƒä¸ä»…æä¾›ä¸€ä¸ªå…ƒç´ å®¹å™¨ï¼Œè¿˜è‡ªå¸¦äº†ç”Ÿå‘½å‘¨æœŸå‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨è¿™äº›é’©å­å‡½æ•°ä¸­è¿›è¡ŒåŠ è½½æ¸²æŸ“ç­‰æ“ä½œï¼Œä»è€Œç®€åŒ–æ­¥éª¤ã€‚</p>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// /src/element.js</span>

<span class="hljs-comment">// è‡ªå®šä¹‰å…ƒç´ </span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyElement</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">HTMLElement</span> </span>&#123;
  <span class="hljs-comment">// å£°æ˜éœ€è¦ç›‘å¬çš„å±æ€§åï¼Œåªæœ‰è¿™äº›å±æ€§å˜åŒ–æ—¶æ‰ä¼šè§¦å‘attributeChangedCallback</span>
  <span class="hljs-keyword">static</span> get observedAttributes () &#123;
    <span class="hljs-keyword">return</span> [<span class="hljs-string">'name'</span>, <span class="hljs-string">'url'</span>]
  &#125;

  <span class="hljs-function"><span class="hljs-title">constructor</span>(<span class="hljs-params"></span>)</span> &#123;
    <span class="hljs-built_in">super</span>();
  &#125;

  <span class="hljs-function"><span class="hljs-title">connectedCallback</span>(<span class="hljs-params"></span>)</span> &#123;
    <span class="hljs-comment">// å…ƒç´ è¢«æ’å…¥åˆ°DOMæ—¶æ‰§è¡Œï¼Œæ­¤æ—¶å»åŠ è½½å­åº”ç”¨çš„é™æ€èµ„æºå¹¶æ¸²æŸ“</span>
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'micro-app is connected'</span>)
  &#125;

  disconnectedCallback () &#123;
    <span class="hljs-comment">// å…ƒç´ ä»DOMä¸­åˆ é™¤æ—¶æ‰§è¡Œï¼Œæ­¤æ—¶è¿›è¡Œä¸€äº›å¸è½½æ“ä½œ</span>
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'micro-app has disconnected'</span>)
  &#125;

  attributeChangedCallback (attr, oldVal, newVal) &#123;
    <span class="hljs-comment">// å…ƒç´ å±æ€§å‘ç”Ÿå˜åŒ–æ—¶æ‰§è¡Œï¼Œå¯ä»¥è·å–nameã€urlç­‰å±æ€§çš„å€¼</span>
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`attribute <span class="hljs-subst">$&#123;attrName&#125;</span>: <span class="hljs-subst">$&#123;newVal&#125;</span>`</span>)
  &#125;
&#125;

<span class="hljs-comment">/**
 * æ³¨å†Œå…ƒç´ 
 * æ³¨å†Œåï¼Œå°±å¯ä»¥åƒæ™®é€šå…ƒç´ ä¸€æ ·ä½¿ç”¨micro-appï¼Œå½“micro-appå…ƒç´ è¢«æ’å…¥æˆ–åˆ é™¤DOMæ—¶å³å¯è§¦å‘ç›¸åº”çš„ç”Ÿå‘½å‘¨æœŸå‡½æ•°ã€‚
 */</span>
<span class="hljs-built_in">window</span>.customElements.define(<span class="hljs-string">'micro-app'</span>, MyElement)
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<p><code>micro-app</code>å…ƒç´ å¯èƒ½å­˜åœ¨é‡å¤å®šä¹‰çš„æƒ…å†µï¼Œæ‰€ä»¥æˆ‘ä»¬åŠ ä¸€å±‚åˆ¤æ–­ï¼Œå¹¶æ”¾å…¥å‡½æ•°ä¸­ã€‚</p>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// /src/element.js</span>

<span class="hljs-keyword">export</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">defineElement</span> (<span class="hljs-params"></span>) </span>&#123;
  <span class="hljs-comment">// å¦‚æœå·²ç»å®šä¹‰è¿‡ï¼Œåˆ™å¿½ç•¥</span>
  <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">window</span>.customElements.get(<span class="hljs-string">'micro-app'</span>)) &#123;
    <span class="hljs-built_in">window</span>.customElements.define(<span class="hljs-string">'micro-app'</span>, MyElement)
  &#125;
&#125;
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<p>åœ¨<code>/src/index.js</code>ä¸­å®šä¹‰é»˜è®¤å¯¹è±¡<code>SimpleMicroApp</code>ï¼Œå¼•å…¥å¹¶æ‰§è¡Œ<code>defineElement</code>å‡½æ•°ã€‚</p>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// /src/index.js</span>

<span class="hljs-keyword">import</span> &#123; defineElement &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">'./element'</span>

<span class="hljs-keyword">const</span> SimpleMicroApp = &#123;
  start () &#123;
    defineElement()
  &#125;
&#125;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> SimpleMicroApp
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<h3 data-id="heading-6">å¼•å…¥simple-micro-app</h3>
<p>åœ¨vue2é¡¹ç›®çš„main.jsä¸­å¼•å…¥simple-micro-appï¼Œæ‰§è¡Œstartå‡½æ•°è¿›è¡Œåˆå§‹åŒ–ã€‚</p>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// vue2/src/main.js</span>

<span class="hljs-keyword">import</span> SimpleMicroApp <span class="hljs-keyword">from</span> <span class="hljs-string">'simple-micro-app'</span>

SimpleMicroApp.start()
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<p>ç„¶åå°±å¯ä»¥åœ¨vue2é¡¹ç›®ä¸­çš„ä»»ä½•ä½ç½®ä½¿ç”¨micro-appæ ‡ç­¾ã€‚</p>
<pre><code class="hljs language-html copyable" lang="html"><span class="hljs-comment"><!-- page1.vue --></span>
<span class="hljs-tag"><<span class="hljs-name">template</span>></span>
  <span class="hljs-tag"><<span class="hljs-name">div</span>></span>
    <span class="hljs-tag"><<span class="hljs-name">micro-app</span> <span class="hljs-attr">name</span>=<span class="hljs-string">'app'</span> <span class="hljs-attr">url</span>=<span class="hljs-string">'http://localhost:3001/'</span>></span><span class="hljs-tag"></<span class="hljs-name">micro-app</span>></span>
  <span class="hljs-tag"></<span class="hljs-name">div</span>></span>
<span class="hljs-tag"></<span class="hljs-name">template</span>></span>
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<p>æ’å…¥micro-appæ ‡ç­¾åï¼Œå°±å¯ä»¥çœ‹åˆ°æ§åˆ¶å°æ‰“å°çš„é’©å­ä¿¡æ¯ã€‚
<img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2fc64425604a4c50917c23b0275c0edb~tplv-k3u1fbpfcp-zoom-1.image" alt loading="lazy" referrerpolicy="no-referrer"></p>
<p>ä»¥ä¸Šæˆ‘ä»¬å°±å®Œæˆäº†å®¹å™¨å…ƒç´ çš„åˆå§‹åŒ–ï¼Œå­åº”ç”¨çš„æ‰€æœ‰å…ƒç´ éƒ½ä¼šæ”¾å…¥åˆ°è¿™ä¸ªå®¹å™¨ä¸­ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬å°±éœ€è¦å®Œæˆå­åº”ç”¨çš„é™æ€èµ„æºåŠ è½½åŠæ¸²æŸ“ã€‚</p>
<h3 data-id="heading-7">åˆ›å»ºå¾®åº”ç”¨å®ä¾‹</h3>
<p>å¾ˆæ˜¾ç„¶ï¼Œåˆå§‹åŒ–çš„æ“ä½œè¦æ”¾åœ¨<code>connectedCallback</code> ä¸­æ‰§è¡Œã€‚æˆ‘ä»¬å£°æ˜ä¸€ä¸ªç±»ï¼Œå®ƒçš„æ¯ä¸€ä¸ªå®ä¾‹éƒ½å¯¹åº”ä¸€ä¸ªå¾®åº”ç”¨ï¼Œç”¨äºæ§åˆ¶å¾®åº”ç”¨çš„èµ„æºåŠ è½½ã€æ¸²æŸ“ã€å¸è½½ç­‰ã€‚</p>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// /src/app.js</span>

<span class="hljs-comment">// åˆ›å»ºå¾®åº”ç”¨</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CreateApp</span> </span>&#123;
  <span class="hljs-title">constructor</span> (<span class="hljs-params"></span>) &#123;&#125;

  status = <span class="hljs-string">'created'</span> <span class="hljs-comment">// ç»„ä»¶çŠ¶æ€ï¼ŒåŒ…æ‹¬ created/loading/mount/unmount</span>

  <span class="hljs-comment">// å­˜æ”¾åº”ç”¨çš„é™æ€èµ„æº</span>
  source = &#123; 
    <span class="hljs-attr">links</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Map</span>(), <span class="hljs-comment">// linkå…ƒç´ å¯¹åº”çš„é™æ€èµ„æº</span>
    <span class="hljs-attr">scripts</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Map</span>(), <span class="hljs-comment">// scriptå…ƒç´ å¯¹åº”çš„é™æ€èµ„æº</span>
  &#125;

  <span class="hljs-comment">// èµ„æºåŠ è½½å®Œæ—¶æ‰§è¡Œ</span>
  onLoad () &#123;&#125;

  <span class="hljs-comment">/**
   * èµ„æºåŠ è½½å®Œæˆåè¿›è¡Œæ¸²æŸ“
   */</span>
  mount () &#123;&#125;

  <span class="hljs-comment">/**
   * å¸è½½åº”ç”¨
   * æ‰§è¡Œå…³é—­æ²™ç®±ï¼Œæ¸…ç©ºç¼“å­˜ç­‰æ“ä½œ
   */</span>
  unmount () &#123;&#125;
&#125;
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<p>æˆ‘ä»¬åœ¨<code>connectedCallback</code>å‡½æ•°ä¸­åˆå§‹åŒ–å®ä¾‹ï¼Œå°†nameã€urlåŠå…ƒç´ è‡ªèº«ä½œä¸ºå‚æ•°ä¼ å…¥ï¼Œåœ¨<code>CreateApp</code>çš„constructorä¸­è®°å½•è¿™äº›å€¼ï¼Œå¹¶æ ¹æ®urlåœ°å€è¯·æ±‚htmlã€‚</p>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// /src/element.js</span>
<span class="hljs-keyword">import</span> CreateApp, &#123; appInstanceMap &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">'./app'</span>

...
connectedCallback () &#123;
  <span class="hljs-comment">// åˆ›å»ºå¾®åº”ç”¨å®ä¾‹</span>
  <span class="hljs-keyword">const</span> app = <span class="hljs-keyword">new</span> CreateApp(&#123;
    <span class="hljs-attr">name</span>: <span class="hljs-built_in">this</span>.name,
    <span class="hljs-attr">url</span>: <span class="hljs-built_in">this</span>.url,
    <span class="hljs-attr">container</span>: <span class="hljs-built_in">this</span>,
  &#125;)

  <span class="hljs-comment">// è®°å…¥ç¼“å­˜ï¼Œç”¨äºåç»­åŠŸèƒ½</span>
  appInstanceMap.set(<span class="hljs-built_in">this</span>.name, app)
&#125;

attributeChangedCallback (attrName, oldVal, newVal) &#123;
  <span class="hljs-comment">// åˆ†åˆ«è®°å½•nameåŠurlçš„å€¼</span>
  <span class="hljs-keyword">if</span> (attrName === <span class="hljs-string">'name'</span> && !<span class="hljs-built_in">this</span>.name && newVal) &#123;
    <span class="hljs-built_in">this</span>.name = newVal
  &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (attrName === <span class="hljs-string">'url'</span> && !<span class="hljs-built_in">this</span>.url && newVal) &#123;
    <span class="hljs-built_in">this</span>.url = newVal
  &#125;
&#125;
...
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<p>åœ¨åˆå§‹åŒ–å®ä¾‹æ—¶ï¼Œæ ¹æ®ä¼ å…¥çš„å‚æ•°è¯·æ±‚é™æ€èµ„æºã€‚</p>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// /src/app.js</span>
<span class="hljs-keyword">import</span> loadHtml <span class="hljs-keyword">from</span> <span class="hljs-string">'./source'</span>

<span class="hljs-comment">// åˆ›å»ºå¾®åº”ç”¨</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CreateApp</span> </span>&#123;
  <span class="hljs-title">constructor</span> (<span class="hljs-params">&#123; name, url, container &#125;</span>) &#123;
    <span class="hljs-built_in">this</span>.name = name <span class="hljs-comment">// åº”ç”¨åç§°</span>
    <span class="hljs-built_in">this</span>.url = url  <span class="hljs-comment">// urlåœ°å€</span>
    <span class="hljs-built_in">this</span>.container = container <span class="hljs-comment">// micro-appå…ƒç´ </span>
    <span class="hljs-built_in">this</span>.status = <span class="hljs-string">'loading'</span>
    loadHtml(<span class="hljs-built_in">this</span>)
  &#125;
  ...
&#125;
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<h3 data-id="heading-8">è¯·æ±‚html</h3>
<p>æˆ‘ä»¬ä½¿ç”¨fetchè¯·æ±‚é™æ€èµ„æºï¼Œå¥½å¤„æ˜¯æµè§ˆå™¨è‡ªå¸¦ä¸”æ”¯æŒpromiseï¼Œä½†è¿™ä¹Ÿè¦æ±‚å­åº”ç”¨çš„é™æ€èµ„æºæ”¯æŒè·¨åŸŸè®¿é—®ã€‚</p>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// src/source.js</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">loadHtml</span> (<span class="hljs-params">app</span>) </span>&#123;
  fetch(app.url).then(<span class="hljs-function">(<span class="hljs-params">res</span>) =></span> &#123;
    <span class="hljs-keyword">return</span> res.text()
  &#125;).then(<span class="hljs-function">(<span class="hljs-params">html</span>) =></span> &#123;
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'html:'</span>, html)
  &#125;).catch(<span class="hljs-function">(<span class="hljs-params">e</span>) =></span> &#123;
    <span class="hljs-built_in">console</span>.error(<span class="hljs-string">'åŠ è½½htmlå‡ºé”™'</span>, e)
  &#125;)
&#125;
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<p>å› ä¸ºè¯·æ±‚jsã€cssç­‰éƒ½éœ€è¦ä½¿ç”¨åˆ°fetchï¼Œæ‰€ä»¥æˆ‘ä»¬å°†å®ƒæå–å‡ºæ¥ä½œä¸ºå…¬å…±æ–¹æ³•ã€‚</p>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// /src/utils.js</span>

<span class="hljs-comment">/**
 * è·å–é™æ€èµ„æº
 * <span class="hljs-doctag">@param <span class="hljs-type">&#123;string&#125;</span> </span>url é™æ€èµ„æºåœ°å€
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fetchSource</span> (<span class="hljs-params">url</span>) </span>&#123;
  <span class="hljs-keyword">return</span> fetch(url).then(<span class="hljs-function">(<span class="hljs-params">res</span>) =></span> &#123;
    <span class="hljs-keyword">return</span> res.text()
  &#125;)
&#125;

<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<p>é‡æ–°ä½¿ç”¨å°è£…åçš„æ–¹æ³•ï¼Œå¹¶å¯¹è·å–åˆ°åˆ°htmlè¿›è¡Œå¤„ç†ã€‚</p>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// src/source.js</span>
<span class="hljs-keyword">import</span> &#123; fetchSource &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">'./utils'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">loadHtml</span> (<span class="hljs-params">app</span>) </span>&#123;
  fetchSource(app.url).then(<span class="hljs-function">(<span class="hljs-params">html</span>) =></span> &#123;
    html = html
      .replace(<span class="hljs-regexp">/<head[^>]*>[\s\S]*?<\/head>/i</span>, <span class="hljs-function">(<span class="hljs-params">match</span>) =></span> &#123;
        <span class="hljs-comment">// å°†headæ ‡ç­¾æ›¿æ¢ä¸ºmicro-app-headï¼Œå› ä¸ºwebé¡µé¢åªå…è®¸æœ‰ä¸€ä¸ªheadæ ‡ç­¾</span>
        <span class="hljs-keyword">return</span> match
          .replace(<span class="hljs-regexp">/<head/i</span>, <span class="hljs-string">'<micro-app-head'</span>)
          .replace(<span class="hljs-regexp">/<\/head>/i</span>, <span class="hljs-string">'</micro-app-head>'</span>)
      &#125;)
      .replace(<span class="hljs-regexp">/<body[^>]*>[\s\S]*?<\/body>/i</span>, <span class="hljs-function">(<span class="hljs-params">match</span>) =></span> &#123;
        <span class="hljs-comment">// å°†bodyæ ‡ç­¾æ›¿æ¢ä¸ºmicro-app-bodyï¼Œé˜²æ­¢ä¸åŸºåº§åº”ç”¨çš„bodyæ ‡ç­¾é‡å¤å¯¼è‡´çš„é—®é¢˜ã€‚</span>
        <span class="hljs-keyword">return</span> match
          .replace(<span class="hljs-regexp">/<body/i</span>, <span class="hljs-string">'<micro-app-body'</span>)
          .replace(<span class="hljs-regexp">/<\/body>/i</span>, <span class="hljs-string">'</micro-app-body>'</span>)
      &#125;)

    <span class="hljs-comment">// å°†htmlå­—ç¬¦ä¸²è½¬åŒ–ä¸ºDOMç»“æ„</span>
    <span class="hljs-keyword">const</span> htmlDom = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">'div'</span>)
    htmlDom.innerHTML = html
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'html:'</span>, htmlDom)

    <span class="hljs-comment">// è¿›ä¸€æ­¥æå–å’Œå¤„ç†jsã€cssç­‰é™æ€èµ„æº</span>
    extractSourceDom(htmlDom, app)
  &#125;).catch(<span class="hljs-function">(<span class="hljs-params">e</span>) =></span> &#123;
    <span class="hljs-built_in">console</span>.error(<span class="hljs-string">'åŠ è½½htmlå‡ºé”™'</span>, e)
  &#125;)
&#125;
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<p>htmlæ ¼å¼åŒ–åï¼Œæˆ‘ä»¬å°±å¯ä»¥å¾—åˆ°ä¸€ä¸ªDOMç»“æ„ã€‚ä»ä¸‹å›¾å¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸ªDOMç»“æ„åŒ…å«linkã€styleã€scriptç­‰æ ‡ç­¾ï¼Œæ¥ä¸‹æ¥å°±éœ€è¦å¯¹è¿™ä¸ªDOMåšè¿›ä¸€æ­¥å¤„ç†ã€‚
<img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3ede734abf604f319e7db760bc7187c3~tplv-k3u1fbpfcp-zoom-1.image" alt loading="lazy" referrerpolicy="no-referrer"></p>
<h3 data-id="heading-9">æå–jsã€cssç­‰é™æ€èµ„æºåœ°å€</h3>
<p>æˆ‘ä»¬åœ¨<code>extractSourceDom</code>æ–¹æ³•ä¸­å¾ªç¯é€’å½’å¤„ç†æ¯ä¸€ä¸ªDOMèŠ‚ç‚¹ï¼ŒæŸ¥è¯¢åˆ°æ‰€æœ‰linkã€styleã€scriptæ ‡ç­¾ï¼Œæå–é™æ€èµ„æºåœ°å€å¹¶æ ¼å¼åŒ–æ ‡ç­¾ã€‚</p>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// src/source.js</span>

<span class="hljs-comment">/**
 * é€’å½’å¤„ç†æ¯ä¸€ä¸ªå­å…ƒç´ 
 * <span class="hljs-doctag">@param </span>parent çˆ¶å…ƒç´ 
 * <span class="hljs-doctag">@param </span>app åº”ç”¨å®ä¾‹
 */</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">extractSourceDom</span>(<span class="hljs-params">parent, app</span>) </span>&#123;
  <span class="hljs-keyword">const</span> children = <span class="hljs-built_in">Array</span>.from(parent.children)
  
  <span class="hljs-comment">// é€’å½’æ¯ä¸€ä¸ªå­å…ƒç´ </span>
  children.length && children.forEach(<span class="hljs-function">(<span class="hljs-params">child</span>) =></span> &#123;
    extractSourceDom(child, app)
  &#125;)

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> dom <span class="hljs-keyword">of</span> children) &#123;
    <span class="hljs-keyword">if</span> (dom <span class="hljs-keyword">instanceof</span> HTMLLinkElement) &#123;
      <span class="hljs-comment">// æå–cssåœ°å€</span>
      <span class="hljs-keyword">const</span> href = dom.getAttribute(<span class="hljs-string">'href'</span>)
      <span class="hljs-keyword">if</span> (dom.getAttribute(<span class="hljs-string">'rel'</span>) === <span class="hljs-string">'stylesheet'</span> && href) &#123;
        <span class="hljs-comment">// è®¡å…¥sourceç¼“å­˜ä¸­</span>
        app.source.links.set(href, &#123;
          <span class="hljs-attr">code</span>: <span class="hljs-string">''</span>, <span class="hljs-comment">// ä»£ç å†…å®¹</span>
        &#125;)
      &#125;
      <span class="hljs-comment">// åˆ é™¤åŸæœ‰å…ƒç´ </span>
      parent.removeChild(dom)
    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (dom <span class="hljs-keyword">instanceof</span> HTMLScriptElement) &#123;
      <span class="hljs-comment">// å¹¶æå–jsåœ°å€</span>
      <span class="hljs-keyword">const</span> src = dom.getAttribute(<span class="hljs-string">'src'</span>)
      <span class="hljs-keyword">if</span> (src) &#123; <span class="hljs-comment">// è¿œç¨‹script</span>
        app.source.scripts.set(src, &#123;
          <span class="hljs-attr">code</span>: <span class="hljs-string">''</span>, <span class="hljs-comment">// ä»£ç å†…å®¹</span>
          <span class="hljs-attr">isExternal</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// æ˜¯å¦è¿œç¨‹script</span>
        &#125;)
      &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (dom.textContent) &#123; <span class="hljs-comment">// å†…è”script</span>
        <span class="hljs-keyword">const</span> nonceStr = <span class="hljs-built_in">Math</span>.random().toString(<span class="hljs-number">36</span>).substr(<span class="hljs-number">2</span>, <span class="hljs-number">15</span>)
        app.source.scripts.set(nonceStr, &#123;
          <span class="hljs-attr">code</span>: dom.textContent, <span class="hljs-comment">// ä»£ç å†…å®¹</span>
          <span class="hljs-attr">isExternal</span>: <span class="hljs-literal">false</span>, <span class="hljs-comment">// æ˜¯å¦è¿œç¨‹script</span>
        &#125;)
      &#125;

      parent.removeChild(dom)
    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (dom <span class="hljs-keyword">instanceof</span> HTMLStyleElement) &#123;
      <span class="hljs-comment">// è¿›è¡Œæ ·å¼éš”ç¦»</span>
    &#125;
  &#125;
&#125;
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<h3 data-id="heading-10">è¯·æ±‚é™æ€èµ„æº</h3>
<p>ä¸Šé¢å·²ç»æ‹¿åˆ°äº†htmlä¸­çš„cssã€jsç­‰é™æ€èµ„æºçš„åœ°å€ï¼Œæ¥ä¸‹æ¥å°±æ˜¯è¯·æ±‚è¿™äº›åœ°å€ï¼Œæ‹¿åˆ°èµ„æºçš„å†…å®¹ã€‚</p>
<p>æ¥ç€å®Œå–„<code>loadHtml</code>ï¼Œåœ¨<code>extractSourceDom</code>ä¸‹é¢æ·»åŠ è¯·æ±‚èµ„æºçš„æ–¹æ³•ã€‚</p>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// src/source.js</span>
...
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">loadHtml</span> (<span class="hljs-params">app</span>) </span>&#123;
  ...
  <span class="hljs-comment">// è¿›ä¸€æ­¥æå–å’Œå¤„ç†jsã€cssç­‰é™æ€èµ„æº</span>
  extractSourceDom(htmlDom, app)

  <span class="hljs-comment">// è·å–micro-app-headå…ƒç´ </span>
  <span class="hljs-keyword">const</span> microAppHead = htmlDom.querySelector(<span class="hljs-string">'micro-app-head'</span>)
  <span class="hljs-comment">// å¦‚æœæœ‰è¿œç¨‹cssèµ„æºï¼Œåˆ™é€šè¿‡fetchè¯·æ±‚</span>
  <span class="hljs-keyword">if</span> (app.source.links.size) &#123;
    fetchLinksFromHtml(app, microAppHead, htmlDom)
  &#125; <span class="hljs-keyword">else</span> &#123;
    app.onLoad(htmlDom)
  &#125;

  <span class="hljs-comment">// å¦‚æœæœ‰è¿œç¨‹jsèµ„æºï¼Œåˆ™é€šè¿‡fetchè¯·æ±‚</span>
  <span class="hljs-keyword">if</span> (app.source.scripts.size) &#123;
    fetchScriptsFromHtml(app, htmlDom)
  &#125; <span class="hljs-keyword">else</span> &#123;
    app.onLoad(htmlDom)
  &#125;
&#125;
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<p><code>fetchLinksFromHtml</code>å’Œ<code>fetchScriptsFromHtml</code>åˆ†åˆ«è¯·æ±‚csså’Œjsèµ„æºï¼Œè¯·æ±‚èµ„æºåçš„å¤„ç†æ–¹å¼ä¸åŒï¼Œcssèµ„æºä¼šè½¬åŒ–ä¸ºstyleæ ‡ç­¾æ’å…¥DOMä¸­ï¼Œè€Œjsä¸ä¼šç«‹å³æ‰§è¡Œï¼Œæˆ‘ä»¬ä¼šåœ¨åº”ç”¨çš„mountæ–¹æ³•ä¸­æ‰§è¡Œjsã€‚</p>
<p>ä¸¤ä¸ªæ–¹æ³•çš„å…·ä½“å®ç°æ–¹å¼å¦‚ä¸‹ï¼š</p>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// src/source.js</span>
<span class="hljs-comment">/**
 * è·å–linkè¿œç¨‹èµ„æº
 * <span class="hljs-doctag">@param </span>app åº”ç”¨å®ä¾‹
 * <span class="hljs-doctag">@param </span>microAppHead micro-app-head
 * <span class="hljs-doctag">@param </span>htmlDom html DOMç»“æ„
 */</span>
 <span class="hljs-keyword">export</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fetchLinksFromHtml</span> (<span class="hljs-params">app, microAppHead, htmlDom</span>) </span>&#123;
  <span class="hljs-keyword">const</span> linkEntries = <span class="hljs-built_in">Array</span>.from(app.source.links.entries())
  <span class="hljs-comment">// é€šè¿‡fetchè¯·æ±‚æ‰€æœ‰cssèµ„æº</span>
  <span class="hljs-keyword">const</span> fetchLinkPromise = []
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> [url] <span class="hljs-keyword">of</span> linkEntries) &#123;
    fetchLinkPromise.push(fetchSource(url))
  &#125;

  <span class="hljs-built_in">Promise</span>.all(fetchLinkPromise).then(<span class="hljs-function">(<span class="hljs-params">res</span>) =></span> &#123;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i < res.length; i++) &#123;
      <span class="hljs-keyword">const</span> code = res[i]
      <span class="hljs-comment">// æ‹¿åˆ°cssèµ„æºåæ”¾å…¥styleå…ƒç´ å¹¶æ’å…¥åˆ°micro-app-headä¸­</span>
      <span class="hljs-keyword">const</span> link2Style = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">'style'</span>)
      link2Style.textContent = code
      microAppHead.appendChild(link2Style)

      <span class="hljs-comment">// å°†ä»£ç æ”¾å…¥ç¼“å­˜ï¼Œå†æ¬¡æ¸²æŸ“æ—¶å¯ä»¥ä»ç¼“å­˜ä¸­è·å–</span>
      linkEntries[i][<span class="hljs-number">1</span>].code = code
    &#125;

    <span class="hljs-comment">// å¤„ç†å®Œæˆåæ‰§è¡ŒonLoadæ–¹æ³•</span>
    app.onLoad(htmlDom)
  &#125;).catch(<span class="hljs-function">(<span class="hljs-params">e</span>) =></span> &#123;
    <span class="hljs-built_in">console</span>.error(<span class="hljs-string">'åŠ è½½csså‡ºé”™'</span>, e)
  &#125;)
&#125;

<span class="hljs-comment">/**
 * è·å–jsè¿œç¨‹èµ„æº
 * <span class="hljs-doctag">@param </span>app åº”ç”¨å®ä¾‹
 * <span class="hljs-doctag">@param </span>htmlDom html DOMç»“æ„
 */</span>
 <span class="hljs-keyword">export</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fetchScriptsFromHtml</span> (<span class="hljs-params">app, htmlDom</span>) </span>&#123;
  <span class="hljs-keyword">const</span> scriptEntries = <span class="hljs-built_in">Array</span>.from(app.source.scripts.entries())
  <span class="hljs-comment">// é€šè¿‡fetchè¯·æ±‚æ‰€æœ‰jsèµ„æº</span>
  <span class="hljs-keyword">const</span> fetchScriptPromise = []
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> [url, info] <span class="hljs-keyword">of</span> scriptEntries) &#123;
    <span class="hljs-comment">// å¦‚æœæ˜¯å†…è”scriptï¼Œåˆ™ä¸éœ€è¦è¯·æ±‚èµ„æº</span>
    fetchScriptPromise.push(info.code ? <span class="hljs-built_in">Promise</span>.resolve(info.code) :  fetchSource(url))
  &#125;

  <span class="hljs-built_in">Promise</span>.all(fetchScriptPromise).then(<span class="hljs-function">(<span class="hljs-params">res</span>) =></span> &#123;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i < res.length; i++) &#123;
      <span class="hljs-keyword">const</span> code = res[i]
      <span class="hljs-comment">// å°†ä»£ç æ”¾å…¥ç¼“å­˜ï¼Œå†æ¬¡æ¸²æŸ“æ—¶å¯ä»¥ä»ç¼“å­˜ä¸­è·å–</span>
      scriptEntries[i][<span class="hljs-number">1</span>].code = code
    &#125;

    <span class="hljs-comment">// å¤„ç†å®Œæˆåæ‰§è¡ŒonLoadæ–¹æ³•</span>
    app.onLoad(htmlDom)
  &#125;).catch(<span class="hljs-function">(<span class="hljs-params">e</span>) =></span> &#123;
    <span class="hljs-built_in">console</span>.error(<span class="hljs-string">'åŠ è½½jså‡ºé”™'</span>, e)
  &#125;)
&#125;
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<p>ä¸Šé¢å¯ä»¥çœ‹åˆ°ï¼Œcsså’ŒjsåŠ è½½å®Œæˆåéƒ½æ‰§è¡Œäº†<code>onLoad</code>æ–¹æ³•ï¼Œæ‰€ä»¥<code>onLoad</code>æ–¹æ³•è¢«æ‰§è¡Œäº†ä¸¤æ¬¡ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±è¦å®Œå–„<code>onLoad</code>æ–¹æ³•å¹¶æ¸²æŸ“å¾®åº”ç”¨ã€‚</p>
<h3 data-id="heading-11">æ¸²æŸ“</h3>
<p>å› ä¸º<code>onLoad</code>è¢«æ‰§è¡Œäº†ä¸¤æ¬¡ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿›è¡Œæ ‡è®°ï¼Œå½“ç¬¬äºŒæ¬¡æ‰§è¡Œæ—¶è¯´æ˜æ‰€æœ‰èµ„æºéƒ½åŠ è½½å®Œæˆï¼Œç„¶åè¿›è¡Œæ¸²æŸ“æ“ä½œã€‚</p>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// /src/app.js</span>

<span class="hljs-comment">// åˆ›å»ºå¾®åº”ç”¨</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CreateApp</span> </span>&#123;
  ...
  <span class="hljs-comment">// èµ„æºåŠ è½½å®Œæ—¶æ‰§è¡Œ</span>
  onLoad (htmlDom) &#123;
    <span class="hljs-built_in">this</span>.loadCount = <span class="hljs-built_in">this</span>.loadCount ? <span class="hljs-built_in">this</span>.loadCount + <span class="hljs-number">1</span> : <span class="hljs-number">1</span>
    <span class="hljs-comment">// ç¬¬äºŒæ¬¡æ‰§è¡Œä¸”ç»„ä»¶æœªå¸è½½æ—¶æ‰§è¡Œæ¸²æŸ“</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.loadCount === <span class="hljs-number">2</span> && <span class="hljs-built_in">this</span>.status !== <span class="hljs-string">'unmount'</span>) &#123;
      <span class="hljs-comment">// è®°å½•DOMç»“æ„ç”¨äºåç»­æ“ä½œ</span>
      <span class="hljs-built_in">this</span>.source.html = htmlDom
      <span class="hljs-comment">// æ‰§è¡Œmountæ–¹æ³•</span>
      <span class="hljs-built_in">this</span>.mount()
    &#125;
  &#125;
  ...
&#125;
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<p>åœ¨<code>mount</code>æ–¹æ³•ä¸­å°†DOMç»“æ„æ’å…¥æ–‡æ¡£ä¸­ï¼Œç„¶åæ‰§è¡Œjsæ–‡ä»¶è¿›è¡Œæ¸²æŸ“æ“ä½œï¼Œæ­¤æ—¶å¾®åº”ç”¨å³å¯å®ŒæˆåŸºæœ¬çš„æ¸²æŸ“ã€‚</p>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// /src/app.js</span>

<span class="hljs-comment">// åˆ›å»ºå¾®åº”ç”¨</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CreateApp</span> </span>&#123;
  ...
  <span class="hljs-comment">/**
   * èµ„æºåŠ è½½å®Œæˆåè¿›è¡Œæ¸²æŸ“
   */</span>
  mount () &#123;
    <span class="hljs-comment">// å…‹éš†DOMèŠ‚ç‚¹</span>
    <span class="hljs-keyword">const</span> cloneHtml = <span class="hljs-built_in">this</span>.source.html.cloneNode(<span class="hljs-literal">true</span>)
    <span class="hljs-comment">// åˆ›å»ºä¸€ä¸ªfragmentèŠ‚ç‚¹ä½œä¸ºæ¨¡ç‰ˆï¼Œè¿™æ ·ä¸ä¼šäº§ç”Ÿå†—ä½™çš„å…ƒç´ </span>
    <span class="hljs-keyword">const</span> fragment = <span class="hljs-built_in">document</span>.createDocumentFragment()
    <span class="hljs-built_in">Array</span>.from(cloneHtml.childNodes).forEach(<span class="hljs-function">(<span class="hljs-params">node</span>) =></span> &#123;
      fragment.appendChild(node)
    &#125;)

    <span class="hljs-comment">// å°†æ ¼å¼åŒ–åçš„DOMç»“æ„æ’å…¥åˆ°å®¹å™¨ä¸­</span>
    <span class="hljs-built_in">this</span>.container.appendChild(fragment)

    <span class="hljs-comment">// æ‰§è¡Œjs</span>
    <span class="hljs-built_in">this</span>.source.scripts.forEach(<span class="hljs-function">(<span class="hljs-params">info</span>) =></span> &#123;
      (<span class="hljs-number">0</span>, <span class="hljs-built_in">eval</span>)(info.code)
    &#125;)

    <span class="hljs-comment">// æ ‡è®°åº”ç”¨ä¸ºå·²æ¸²æŸ“</span>
    <span class="hljs-built_in">this</span>.status = <span class="hljs-string">'mounted'</span>
  &#125;
  ...
&#125;
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<p>ä»¥ä¸Šæ­¥éª¤å®Œæˆäº†å¾®å‰ç«¯çš„åŸºæœ¬æ¸²æŸ“æ“ä½œï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹æ•ˆæœã€‚</p>
<h3 data-id="heading-12">å¼€å§‹ä½¿ç”¨</h3>
<p>æˆ‘ä»¬åœ¨åŸºåº§åº”ç”¨ä¸‹é¢åµŒå…¥å¾®å‰ç«¯ï¼š</p>
<pre><code class="hljs language-html copyable" lang="html"><span class="hljs-comment"><!-- vue2/src/pages/page1.vue --></span>
<span class="hljs-tag"><<span class="hljs-name">template</span>></span>
  <span class="hljs-tag"><<span class="hljs-name">div</span>></span>
    <span class="hljs-tag"><<span class="hljs-name">img</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">"Vue logo"</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"../assets/logo.png"</span>></span>
    <span class="hljs-tag"><<span class="hljs-name">HelloWorld</span> <span class="hljs-attr">:msg</span>=<span class="hljs-string">"'åŸºåº§åº”ç”¨vue@' + version"</span> /></span>
    <span class="hljs-comment"><!-- ğŸ‘‡åµŒå…¥å¾®å‰ç«¯ --></span>
    <span class="hljs-tag"><<span class="hljs-name">micro-app</span> <span class="hljs-attr">name</span>=<span class="hljs-string">'app'</span> <span class="hljs-attr">url</span>=<span class="hljs-string">'http://localhost:3001/'</span>></span><span class="hljs-tag"></<span class="hljs-name">micro-app</span>></span>
  <span class="hljs-tag"></<span class="hljs-name">div</span>></span>
<span class="hljs-tag"></<span class="hljs-name">template</span>></span>
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<p>æœ€ç»ˆå¾—åˆ°çš„æ•ˆæœå¦‚ä¸‹ï¼š
<img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ba1d2c245b19432cae72d1a97e6bb2a9~tplv-k3u1fbpfcp-zoom-1.image" alt loading="lazy" referrerpolicy="no-referrer"></p>
<p>å¯è§react17å·²ç»æ­£å¸¸åµŒå…¥è¿è¡Œäº†ã€‚</p>
<p>æˆ‘ä»¬ç»™å­åº”ç”¨react17æ·»åŠ ä¸€ä¸ªæ‡’åŠ è½½é¡µé¢<code>page2</code>ï¼ŒéªŒè¯ä¸€ä¸‹å¤šé¡µé¢åº”ç”¨æ˜¯å¦å¯ä»¥æ­£å¸¸è¿è¡Œã€‚</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/650791a3f8024c4fb7450d4f28f8c6c3~tplv-k3u1fbpfcp-zoom-1.image" alt loading="lazy" referrerpolicy="no-referrer"></p>
<p><code>page2</code>çš„å†…å®¹ä¹Ÿéå¸¸ç®€å•ï¼Œåªæ˜¯ä¸€æ®µæ ‡é¢˜ï¼š
<img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/041ec39af6ec443aa23729bfa4d2ab7f~tplv-k3u1fbpfcp-zoom-1.image" alt loading="lazy" referrerpolicy="no-referrer"></p>
<p>åœ¨é¡µé¢ä¸Šæ·»åŠ ä¸€ä¸ªæŒ‰é’®ï¼Œç‚¹å‡»å³å¯è·³è½¬page2ã€‚
<img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/dc90012fff19449787a099ec86628f9a~tplv-k3u1fbpfcp-zoom-1.image" alt loading="lazy" referrerpolicy="no-referrer"></p>
<p>ç‚¹å‡»æŒ‰é’®ï¼Œå¾—åˆ°çš„æ•ˆæœå¦‚ä¸‹ï¼š
<img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/119fa1000a6f4c9cadff2166b0e7c059~tplv-k3u1fbpfcp-zoom-1.image" alt loading="lazy" referrerpolicy="no-referrer"></p>
<p>æ­£å¸¸æ¸²æŸ“ï¼ğŸ‰ğŸ‰</p>
<p>ä¸€ä¸ªç®€æ˜“çš„å¾®å‰ç«¯æ¡†æ¶å°±å®Œæˆäº†ï¼Œå½“ç„¶æ­¤æ—¶å®ƒæ˜¯éå¸¸åŸºç¡€çš„ï¼Œæ²¡æœ‰JSæ²™ç®±å’Œæ ·å¼éš”ç¦»ã€‚</p>
<p>å…³äºJSæ²™ç®±å’Œæ ·å¼éš”ç¦»æˆ‘ä»¬ä¼šå•ç‹¬åšä¸€ç¯‡æ–‡ç« åˆ†äº«ï¼Œä½†æ˜¯æ­¤æ—¶æˆ‘ä»¬è¿˜æœ‰ä¸€ä»¶äº‹æƒ…éœ€è¦åš - å¸è½½åº”ç”¨ã€‚</p>
<h3 data-id="heading-13">å¸è½½</h3>
<p>å½“micro-appå…ƒç´ è¢«åˆ é™¤æ—¶ä¼šè‡ªåŠ¨æ‰§è¡Œç”Ÿå‘½å‘¨æœŸå‡½æ•°<code>disconnectedCallback</code>ï¼Œæˆ‘ä»¬åœ¨æ­¤å¤„æ‰§è¡Œå¸è½½ç›¸å…³æ“ä½œã€‚</p>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// /src/element.js</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyElement</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">HTMLElement</span> </span>&#123;
  ...
  disconnectedCallback () &#123;
    <span class="hljs-comment">// è·å–åº”ç”¨å®ä¾‹</span>
    <span class="hljs-keyword">const</span> app = appInstanceMap.get(<span class="hljs-built_in">this</span>.name)
    <span class="hljs-comment">// å¦‚æœæœ‰å±æ€§destoryï¼Œåˆ™å®Œå…¨å¸è½½åº”ç”¨åŒ…æ‹¬ç¼“å­˜çš„æ–‡ä»¶</span>
    app.unmount(<span class="hljs-built_in">this</span>.hasAttribute(<span class="hljs-string">'destory'</span>))
  &#125;
&#125;
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<p>æ¥ä¸‹æ¥å®Œå–„åº”ç”¨çš„<code>unmount</code>æ–¹æ³•ï¼š</p>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// /src/app.js</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CreateApp</span> </span>&#123;
  ...
  <span class="hljs-comment">/**
   * å¸è½½åº”ç”¨
   * <span class="hljs-doctag">@param </span>destory æ˜¯å¦å®Œå…¨é”€æ¯ï¼Œåˆ é™¤ç¼“å­˜èµ„æº
   */</span>
  unmount (destory) &#123;
    <span class="hljs-comment">// æ›´æ–°çŠ¶æ€</span>
    <span class="hljs-built_in">this</span>.status = <span class="hljs-string">'unmount'</span>
    <span class="hljs-comment">// æ¸…ç©ºå®¹å™¨</span>
    <span class="hljs-built_in">this</span>.container = <span class="hljs-literal">null</span>
    <span class="hljs-comment">// destoryä¸ºtrueï¼Œåˆ™åˆ é™¤åº”ç”¨</span>
    <span class="hljs-keyword">if</span> (destory) &#123;
      appInstanceMap.delete(<span class="hljs-built_in">this</span>.name)
    &#125;
  &#125;
&#125;
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<p>å½“destoryä¸ºtrueæ—¶ï¼Œåˆ é™¤åº”ç”¨çš„å®ä¾‹ï¼Œæ­¤æ—¶æ‰€æœ‰é™æ€èµ„æºå¤±å»äº†å¼•ç”¨ï¼Œè‡ªåŠ¨è¢«æµè§ˆå™¨å›æ”¶ã€‚</p>
<p>åœ¨åŸºåº§åº”ç”¨vue2ä¸­æ·»åŠ ä¸€ä¸ªæŒ‰é’®ï¼Œåˆ‡æ¢å­åº”ç”¨çš„æ˜¾ç¤º/éšè—çŠ¶æ€ï¼ŒéªŒè¯å¤šæ¬¡æ¸²æŸ“å’Œå¸è½½æ˜¯å¦æ­£å¸¸è¿è¡Œã€‚</p>
<p>æ•ˆæœå¦‚ä¸‹ï¼š
<img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/20384d42854b4e22b966bce09dde794e~tplv-k3u1fbpfcp-zoom-1.image" alt loading="lazy" referrerpolicy="no-referrer"></p>
<p>ä¸€ä¸”è¿è¡Œæ­£å¸¸ï¼ğŸ‰</p>
<h2 data-id="heading-14">ç»“è¯­</h2>
<p>åˆ°æ­¤å¾®å‰ç«¯æ¸²æŸ“ç¯‡çš„æ–‡ç« å°±ç»“æŸäº†ï¼Œæˆ‘ä»¬å®Œæˆäº†å¾®å‰ç«¯çš„æ¸²æŸ“å’Œå¸è½½åŠŸèƒ½ï¼Œå½“ç„¶å®ƒçš„åŠŸèƒ½æ˜¯éå¸¸ç®€å•çš„ï¼Œåªæ˜¯å™è¿°äº†å¾®å‰ç«¯çš„åŸºæœ¬å®ç°æ€è·¯ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬ä¼šå®ŒæˆJSæ²™ç®±ã€æ ·å¼éš”ç¦»ã€æ•°æ®é€šè®¯ç­‰åŠŸèƒ½ï¼Œå¦‚æœä½ èƒ½è€ä¸‹å¿ƒæ¥è¯»ä¸€éï¼Œä¼šå¯¹ä½ äº†è§£å¾®å‰ç«¯æœ‰å¾ˆå¤§å¸®åŠ©ã€‚</p>
<h2 data-id="heading-15">ä»£ç åœ°å€ï¼š</h2>
<p><a href="https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Fbailicangdu%2Fsimple-micro-app" target="_blank" rel="nofollow noopener noreferrer" title="https://github.com/bailicangdu/simple-micro-app" ref="nofollow noopener noreferrer">github.com/bailicangduâ€¦</a></p></div>  
</div>
            