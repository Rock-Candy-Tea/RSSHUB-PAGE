
---
title: '微信小程序开发与踩坑记录'
categories: 
 - 编程
 - 掘金
 - 分类
headimg: 'https://picsum.photos/400/300?random=5023'
author: 掘金
comments: false
date: Tue, 13 Jul 2021 03:23:48 GMT
thumbnail: 'https://picsum.photos/400/300?random=5023'
---

<div>   
<div class="markdown-body"><style>.markdown-body&#123;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333&#125;.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6&#123;line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px&#125;.markdown-body h1&#123;font-size:30px;margin-bottom:5px&#125;.markdown-body h2&#123;padding-bottom:12px;font-size:24px;border-bottom:1px solid #ececec&#125;.markdown-body h3&#123;font-size:18px;padding-bottom:0&#125;.markdown-body h4&#123;font-size:16px&#125;.markdown-body h5&#123;font-size:15px&#125;.markdown-body h6&#123;margin-top:5px&#125;.markdown-body p&#123;line-height:inherit;margin-top:22px;margin-bottom:22px&#125;.markdown-body img&#123;max-width:100%&#125;.markdown-body hr&#123;border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px&#125;.markdown-body code&#123;word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em&#125;.markdown-body code,.markdown-body pre&#123;font-family:Menlo,Monaco,Consolas,Courier New,monospace&#125;.markdown-body pre&#123;overflow:auto;position:relative;line-height:1.75&#125;.markdown-body pre>code&#123;font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8&#125;.markdown-body a&#123;text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff&#125;.markdown-body a:active,.markdown-body a:hover&#123;color:#275b8c&#125;.markdown-body table&#123;display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6&#125;.markdown-body thead&#123;background:#f6f6f6;color:#000;text-align:left&#125;.markdown-body tr:nth-child(2n)&#123;background-color:#fcfcfc&#125;.markdown-body td,.markdown-body th&#123;padding:12px 7px;line-height:24px&#125;.markdown-body td&#123;min-width:120px&#125;.markdown-body blockquote&#123;color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8&#125;.markdown-body blockquote:after&#123;display:block;content:""&#125;.markdown-body blockquote>p&#123;margin:10px 0&#125;.markdown-body ol,.markdown-body ul&#123;padding-left:28px&#125;.markdown-body ol li,.markdown-body ul li&#123;margin-bottom:0;list-style:inherit&#125;.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item&#123;list-style:none&#125;.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul&#123;margin-top:0&#125;.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul&#123;margin-top:3px&#125;.markdown-body ol li&#123;padding-left:6px&#125;.markdown-body .contains-task-list&#123;padding-left:0&#125;.markdown-body .task-list-item&#123;list-style:none&#125;@media (max-width:720px)&#123;.markdown-body h1&#123;font-size:24px&#125;.markdown-body h2&#123;font-size:20px&#125;.markdown-body h3&#123;font-size:18px&#125;&#125;</style><p>作者： <a href="https://juejin.cn/user/166781500008359?share_token=682e74f5-a05a-417e-81fc-4f791530a195" target="_blank" title="https://juejin.cn/user/166781500008359?share_token=682e74f5-a05a-417e-81fc-4f791530a195">qiuwww</a></p>
<ol>
<li>大家业务可能需要 h5 嵌入到小程序中，以及设置分享等，以及一些注意点；</li>
<li>个人的小程序的开发经验总结；</li>
</ol>
<h2 data-id="heading-0">🖇 开发相关</h2>
<h3 data-id="heading-1">1、使用 <code>web-view</code> 加载 h5 与设置当前页面的小程序分享</h3>
<p><a href="https://link.juejin.cn/?target=https%3A%2F%2Fdevelopers.weixin.qq.com%2Fminiprogram%2Fdev%2Fcomponent%2Fweb-view.html" target="_blank" rel="nofollow noopener noreferrer" title="https://developers.weixin.qq.com/miniprogram/dev/component/web-view.html" ref="nofollow noopener noreferrer">web-view 文档</a></p>
<h4 data-id="heading-2">小程序的 <code>web-view</code> 与一般的 iframe 异同</h4>
<p><strong>相似的地方</strong>：</p>
<ol>
<li>都用来加载在线的动态资源，如 html，pdf 之类的，<code>web-view</code> 是网页的原生载体，用于在原生环境中加载一个页面，iframe 是网页的 html 载体，用于在网页中加载一个新的动态资源。</li>
</ol>
<p><strong>差异的地方</strong></p>
<ol>
<li>小程序内的 <code>web-view</code> 限制很严格：
<ol>
<li><code>web-view</code> 加载的 url 需要在后台配置域名白名单，包括内部再次 iframe 内嵌的其他 url；
<ol>
<li>小程序限制加载的资源都是 https 请求的，所以有时候出现加载不出来的问题，很可能就是接口或者页面地址有问题；</li>
<li>另外一个问题就是，进行真机测试的时候最好不要开<strong>开发调试模式</strong>，可能就会漏掉一些问题；</li>
</ol>
</li>
</ol>
</li>
<li><code>web-view</code> 会自动铺满整个小程序页面，且默认展示到最上边一层，不能被覆盖；</li>
<li>小程序端 <code>web-view</code> 组件一定有原生导航栏，下面一定是全屏的 <code>web-view</code> 组件，<code>navigationStyle: custom</code> 对 <code>web-view</code> 组件无效。</li>
<li>小程序不能获取 <code>web-view</code> 对象，也就是内外完全隔离，不能通过获取组件引用来操作；
<ol>
<li>嵌入的 <code>web-view</code> 网页只能 <code>postMessage</code> 给小程序，且小程序只能在<strong>特定时机（小程序后退、组件销毁、分享）触发并收到消息</strong>。也就是说，消息不是实时的，会存储到一个数组中在以上时机一起被拿到，<code>web-view</code> 发送的消息会一直累加，这个数组长度一直变大；</li>
<li><code>bindload</code>，这个方法开发者工具无效，测试的时候发现，<strong>只要地址格式正确就认为是成功了，就会被触发</strong>，并不是页面加载完整才触发；</li>
<li><code>binderror</code>，这个方法开发者工具无效，<strong>地址格式出错就认为加载失败</strong>，真正没加载出来也不会触发；</li>
</ol>
</li>
</ol>
<h4 data-id="heading-3"><code>web-view</code> 加载 h5 页面</h4>
<ol>
<li>需要在 url 获取到的时候再渲染<code>web-view</code>组件，否则可能出现空白页；</li>
</ol>
<pre><code class="hljs language-html copyable" lang="html"><span class="hljs-tag"><<span class="hljs-name">template</span>></span>
  <span class="hljs-tag"><<span class="hljs-name">view</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"common-webview"</span>></span>
    <span class="hljs-tag"><<span class="hljs-name">web-view</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"url"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"web"</span> <span class="hljs-attr">:src</span>=<span class="hljs-string">"url"</span> @<span class="hljs-attr">message</span>=<span class="hljs-string">"onWebMessage"</span> /></span>
  <span class="hljs-tag"></<span class="hljs-name">view</span>></span>
<span class="hljs-tag"></<span class="hljs-name">template</span>></span>
<span class="copy-code-btn">复制代码</span></code></pre>
<ol start="2">
<li><code>@message</code>接受页面发出的消息，需要内嵌小程序引入微信的 sdk，然后使用<code>wx.miniProgram.postMessage(&#123; data: 'foo' &#125;)</code>来发消息；</li>
<li><code>web-view</code>，内嵌 h5 需要打开小程序页面可以调用小程序的跳转方法进行跳转，这里注意 tab 页面只能使用<code>wx.miniProgram.switchTab</code>，来跳转。</li>
</ol>
<pre><code class="hljs language-js copyable" lang="js">(<span class="hljs-built_in">window</span> <span class="hljs-keyword">as</span> any).wx.miniProgram.navigateTo(&#123;
  <span class="hljs-attr">url</span>: <span class="hljs-string">`/pages/common/webview?url=<span class="hljs-subst">$&#123;<span class="hljs-built_in">encodeURIComponent</span>(resolveH5Url)&#125;</span>`</span>
&#125;);
<span class="copy-code-btn">复制代码</span></code></pre>
<h4 data-id="heading-4"><code>web-view</code>页面的分享设置</h4>
<ol>
<li>最直观的方式，就是打开小程序页面的时候，同时传递分享的标题和图片，如下：
<ol>
<li>这样做主要是针对一些 <strong>h5 代码不能修改的情况</strong>，或者加载的一组 h5 页面分享的标题不改变的情况，对于需要不断切换分享内容的情况，是不能实现的；</li>
</ol>
</li>
</ol>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// 在h5中使用 wx.miniProgram.navigateTo</span>
wx.navigateTo(&#123;
  <span class="hljs-attr">url</span>: <span class="hljs-string">`/pages/common/webview?url=<span class="hljs-subst">$&#123;<span class="hljs-built_in">encodeURIComponent</span>(jumpUrl)&#125;</span>&imageUrl=<span class="hljs-subst">$&#123;imageUrl&#125;</span>&title=<span class="hljs-subst">$&#123;title&#125;</span>`</span>
&#125;);
<span class="copy-code-btn">复制代码</span></code></pre>
<ol start="2">
<li>对于自己可控的 h5 页面，可以使用<code>postMessage</code>的方式，将需要分享的参数动态的发给小程序页面，这样让小程序页面通过当前的 url 来匹配这里的 message 对象，从而拿到分享的信息，具体操作如下：</li>
</ol>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// h5操作</span>
<span class="hljs-keyword">if</span> (env.inWechatMiniProgram) &#123;
  (<span class="hljs-built_in">window</span> <span class="hljs-keyword">as</span> any).wx.miniProgram.postMessage(&#123;
    <span class="hljs-attr">data</span>: &#123;
      <span class="hljs-attr">title</span>: title || <span class="hljs-string">''</span>, <span class="hljs-comment">// 分享的title</span>
      <span class="hljs-attr">imageUrl</span>: imageUrl || <span class="hljs-string">''</span>, <span class="hljs-comment">// 分享的展示图片</span>
      <span class="hljs-attr">pageUrl</span>: <span class="hljs-built_in">window</span>.location.href, <span class="hljs-comment">// 当前页面的url，需要作为key来识别消息</span>
    &#125;
  &#125;);
&#125;

<span class="hljs-comment">// 小程序端</span>
<span class="hljs-comment">// 点击分享的时候，会调用两个函数，一个是onShareAppMessage，一个是onWebMessage（前）</span>
<span class="hljs-comment">// 接受postMsg的消息列表，进入页面或者点击操作的时候会发送消息，在小程序的分享按钮被点击的时候这里会被调用，调用在onShareAppMessage前</span>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-title">onWebMessage</span>(<span class="hljs-params">&#123; detail: message &#125;</span>)</span> &#123;
  <span class="hljs-built_in">this</span>.messageList = message.data || [];
&#125;

<span class="hljs-comment">// 点击分享按钮，当前函数会被调用</span>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-title">onShareAppMessage</span>(<span class="hljs-params">options = &#123;&#125;</span>)</span> &#123;
  <span class="hljs-keyword">const</span> &#123; webViewUrl &#125; = options;
  <span class="hljs-keyword">const</span> searchCurOptions = <span class="hljs-built_in">this</span>.messageList.reverse().find(<span class="hljs-function"><span class="hljs-params">item</span> =></span> item.pageUrl === webViewUrl) || &#123;&#125;;
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"这里就是当前分享的信息"</span>, searchCurOptions)
&#125;
<span class="copy-code-btn">复制代码</span></code></pre>
<p>需要更多的配置，也是可以添加参数来实现的。</p>
<h3 data-id="heading-5">2、页面模式及标题栏返回</h3>
<h4 data-id="heading-6">页面模式</h4>
<p><a href="https://link.juejin.cn/?target=https%3A%2F%2Fdevelopers.weixin.qq.com%2Fminiprogram%2Fdev%2Freference%2Fconfiguration%2Fpage.html%23%25E9%2585%258D%25E7%25BD%25AE%25E9%25A1%25B9" target="_blank" rel="nofollow noopener noreferrer" title="https://developers.weixin.qq.com/miniprogram/dev/reference/configuration/page.html#%E9%85%8D%E7%BD%AE%E9%A1%B9" ref="nofollow noopener noreferrer">页面开发模式</a></p>
<p>可以通过设置 pages.json 中的页面的 navigationStyle 为 custom 来自定义导航栏。</p>
<ol>
<li>default，不设置的默认模式，常规页面操作流程；</li>
<li>custom，自定义导航栏，通常用于首页展示或者自定义标题栏，但是对于<code>web-view</code>页面无效；</li>
</ol>
<h4 data-id="heading-7">标题栏的返回问题</h4>
<p>由于小程序只会在小程序页面间跳转的时候，默认标题栏出现返回按钮，所以如果在 <strong>tabbar 页面嵌入 h5</strong>，h5 内部的跳转是不能出现返回按钮的，所以需要特殊处理：</p>
<ol>
<li>如果第一个打开的是一个内嵌 h5 的页面，则当前页面的跳转，<strong>都需要调用小程序接口来进行跳转</strong>；</li>
<li>出现返回按钮之后的页面，则不需要使用了；</li>
</ol>
<pre><code class="hljs language-js copyable" lang="js">wx.miniProgram.navigateTo(&#123;
  <span class="hljs-attr">url</span>: <span class="hljs-string">`/pages/common/webview?url=<span class="hljs-subst">$&#123;<span class="hljs-built_in">encodeURIComponent</span>(jumpUrl)&#125;</span>&imageUrl=<span class="hljs-subst">$&#123;imageUrl&#125;</span>&title=<span class="hljs-subst">$&#123;title&#125;</span>`</span>
&#125;);
<span class="copy-code-btn">复制代码</span></code></pre>
<h3 data-id="heading-8">3、分包的问题</h3>
<p><a href="https://link.juejin.cn/?target=https%3A%2F%2Fdevelopers.weixin.qq.com%2Fminiprogram%2Fdev%2Fframework%2Fsubpackages%2Fbasic.html" target="_blank" rel="nofollow noopener noreferrer" title="https://developers.weixin.qq.com/miniprogram/dev/framework/subpackages/basic.html" ref="nofollow noopener noreferrer">微信小程序分包</a></p>
<h4 data-id="heading-9">为什么需要分包</h4>
<p>微信客户端在打开小程序之前，会把整个小程序的代码包下载到本地的，这种策略可以<strong>缓解页面跳转时白屏的问题</strong>。同时微信还对小程序代码包大小设置了 <strong>2M</strong> （最初只有 1M）的上限来确保小程序能有还不错的启动速度。</p>
<h4 data-id="heading-10">分包应该注意的地方</h4>
<ol>
<li>微信小程序每个分包的大小是 2M，总体积一共不能超过 20M；</li>
<li>需要尽量保持主包只加载必须的内容，主要包括一些必须公共资源/JS 脚本，tabBar 页面，最好只包括这些页面；</li>
<li><strong>分包越早越好</strong>，如果后期进行分包，不然后期进行分包，就要处理前期被内部及外部调用的地址；
<ol>
<li>对于已经对外放出的页面就更没法修改了；</li>
<li>页面不能通过路由进行重定向，也就是路由与页面位置是绝对对应的；</li>
</ol>
</li>
<li>主包不可以引用子包内容，<strong>子包只可以引用自己包内和主包内的内容</strong>，子包内不能嵌套子包；
<ol>
<li><strong>独立分包是小程序中一种特殊类型的分包，可以独立于主包和其他分包运行</strong>。从独立分包中页面进入小程序时，不需要下载主包。当用户进入普通分包或主包内页面时，主包才会被下载，这个我们通常不会用到。</li>
</ol>
</li>
<li><strong>子包预下载</strong>：开发者可以通过配置，在进入小程序某个页面时，由框架自动预下载可能需要的分包，提升进入后续分包页面时的启动速度。对于独立分包，也可以预下载主包。</li>
</ol>
<h3 data-id="heading-11">4、小程序开发配置 condition</h3>
<p><a href="https://link.juejin.cn/?target=https%3A%2F%2Funiapp.dcloud.io%2Fcollocation%2Fpages%3Fid%3Dcondition" target="_blank" rel="nofollow noopener noreferrer" title="https://uniapp.dcloud.io/collocation/pages?id=condition" ref="nofollow noopener noreferrer">uni-app 设置 condition</a></p>
<blockquote>
<p>启动模式配置，仅开发期间生效，用于模拟直达页面的场景，如：小程序转发后，用户点击所打开的页面。</p>
</blockquote>
<p>可以在不必将要开发的页面每次写到 pages.json 的 pages 下的第一个，也可以保证小程序每次刷新的时候，选择的编译模式能用。</p>
<pre><code class="hljs language-json copyable" lang="json">&#123;
  <span class="hljs-attr">"condition"</span>: &#123;
    <span class="hljs-attr">"current"</span>: <span class="hljs-number">0</span>,
    <span class="hljs-attr">"list"</span>: [
      &#123;
        <span class="hljs-attr">"name"</span>: <span class="hljs-string">"index"</span>,
        <span class="hljs-attr">"path"</span>: <span class="hljs-string">"pages/index/index"</span>,
        <span class="hljs-attr">"query"</span>: <span class="hljs-string">"isShowHelp=1"</span>
      &#125;
    ]
  &#125;
&#125;
<span class="copy-code-btn">复制代码</span></code></pre>
<h3 data-id="heading-12">5、小程序与 h5 及小程序之间的跳转的一些规则</h3>
<ol>
<li>小程序的分享，只能是小程序打开；</li>
<li>公众号的分享只能是公众号打开；</li>
<li>小程序内通过<code>web-view</code>，可以打开 h5；</li>
<li>小程序跳转小程序是没什么限制的，只要知道对方的 appid 以及跳转的目标页面就可以了，也可以设置跳转的是<strong>体验版/开发版/正式版本</strong>。
<ol>
<li>正式版本只能跳转正式版本；</li>
</ol>
</li>
<li>h5 打开小程序，h5 需要引入微信的 sdk，设置调用的功能，然后通过<a href="https://link.juejin.cn/?target=https%3A%2F%2Fdevelopers.weixin.qq.com%2Fdoc%2Foffiaccount%2FOA_Web_Apps%2FWechat_Open_Tag.html%23%25E5%25BC%2580%25E6%2594%25BE%25E6%25A0%2587%25E7%25AD%25BE" target="_blank" rel="nofollow noopener noreferrer" title="https://developers.weixin.qq.com/doc/offiaccount/OA_Web_Apps/Wechat_Open_Tag.html#%E5%BC%80%E6%94%BE%E6%A0%87%E7%AD%BE" ref="nofollow noopener noreferrer">开放标签</a>跳转；</li>
<li>小程序不能跳转公众号，但是可以使用 <code>official-account</code> 组件关注关联的公众号；</li>
<li><a href="https://link.juejin.cn/?target=https%3A%2F%2Fdevelopers.weixin.qq.com%2Fminiprogram%2Fdev%2Fframework%2Fopen-ability%2FlaunchApp.html" target="_blank" rel="nofollow noopener noreferrer" title="https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/launchApp.html" ref="nofollow noopener noreferrer">打开 App</a>，当小程序从 APP 打开的场景打开时（场景值 1069），小程序会获得<strong>返回 APP 的能力</strong>，此时用户点击按钮可以打开拉起该小程序的 APP。即小程序不能打开任意 APP，只能 跳回 APP。</li>
</ol>
<pre><code class="hljs language-html copyable" lang="html"><span class="hljs-tag"><<span class="hljs-name">script</span>></span><span class="javascript">
  <span class="hljs-comment">// 小程序跳转小程序</span>
  wx.navigateToMiniProgram(&#123;
    <span class="hljs-attr">appId</span>: appid, <span class="hljs-comment">// 对方小程序的appid</span>
    <span class="hljs-attr">path</span>: path, <span class="hljs-comment">// 目标页面的地址，需要的参数可以直接拼写到后边，path 中 ? 后面的部分会成为 query</span>
    <span class="hljs-attr">extraData</span>: &#123;
      <span class="hljs-comment">// 需要传递给目标小程序的数据</span>
      <span class="hljs-attr">foo</span>: <span class="hljs-string">'bar'</span>
    &#125;,
    <span class="hljs-attr">envVersion</span>: <span class="hljs-string">'release'</span>, <span class="hljs-comment">// 要打开的小程序版本。仅在当前小程序为开发版或体验版时此参数有效。如果当前小程序是正式版，则打开的小程序必定是正式版。</span>
    <span class="hljs-function"><span class="hljs-title">success</span>(<span class="hljs-params">res</span>)</span> &#123;
      <span class="hljs-comment">// 打开成功的后续操作，比如埋点什么的</span>
      <span class="hljs-comment">// wxTelescope(baseKey + '-skip');</span>
    &#125;
  &#125;);
</span><span class="hljs-tag"></<span class="hljs-name">script</span>></span>

<span class="hljs-comment"><!-- h5跳转小程序 --></span>
<span class="hljs-tag"><<span class="hljs-name">script</span>></span><span class="javascript">
  <span class="hljs-comment">// 需要配置</span>
  wx.config(&#123;
    <span class="hljs-attr">openTagList</span>: [<span class="hljs-string">'wx-open-launch-weapp'</span>]
  &#125;);
</span><span class="hljs-tag"></<span class="hljs-name">script</span>></span>
<span class="hljs-comment"><!-- 跳转按钮 --></span>
<span class="hljs-tag"><<span class="hljs-name">wx-open-launch-weapp</span>
  <span class="hljs-attr">class</span>=<span class="hljs-string">"launch-btn"</span>
  <span class="hljs-attr">:username</span>=<span class="hljs-string">"tagUsername"</span>
  <span class="hljs-attr">:path</span>=<span class="hljs-string">"tagPath"</span>
  @<span class="hljs-attr">error</span>=<span class="hljs-string">"handleErrorFn"</span>
  @<span class="hljs-attr">launch</span>=<span class="hljs-string">"handleLaunchFn"</span>
></span>
  <span class="hljs-tag"><<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text/wxtag-template"</span>></span><span class="handlebars"><span class="xml">
    <span class="hljs-tag"><<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"padding: 10000px"</span>></span>
      跳转按钮
    <span class="hljs-tag"></<span class="hljs-name">div</span>></span>
  </span></span><span class="hljs-tag"></<span class="hljs-name">script</span>></span>
<span class="hljs-tag"></<span class="hljs-name">wx-open-launch-weapp</span>></span>
<span class="copy-code-btn">复制代码</span></code></pre>
<h2 data-id="heading-13">🖇 踩坑</h2>
<h3 data-id="heading-14">1、渠道参数处理</h3>
<h4 data-id="heading-15">小程序生命周期-热启动/冷启动及其相关参数获取</h4>
<p><a href="https://link.juejin.cn/?target=https%3A%2F%2Fdevelopers.weixin.qq.com%2Fminiprogram%2Fdev%2Fframework%2Fruntime%2Foperating-mechanism.html" target="_blank" rel="nofollow noopener noreferrer" title="https://developers.weixin.qq.com/miniprogram/dev/framework/runtime/operating-mechanism.html" ref="nofollow noopener noreferrer">小程序的运行机制</a></p>
<ul>
<li>冷启动：如果用户首次打开，或小程序销毁后被用户再次打开，此时小程序需要重新加载启动，即冷启动。</li>
<li>热启动：如果用户已经打开过某小程序，然后在一定时间内再次打开该小程序，此时小程序并未被销毁，只是从后台状态进入前台状态，这个过程就是热启动。
<ul>
<li>常见如，启动后，扫码重新打开某个页面，或者点击配置的公众号导航等；</li>
</ul>
</li>
</ul>
<h4 data-id="heading-16">参数获取方式的区别</h4>
<ol>
<li><a href="https://link.juejin.cn/?target=https%3A%2F%2Fdevelopers.weixin.qq.com%2Fminiprogram%2Fdev%2Fapi%2Fbase%2Fapp%2Flife-cycle%2Fwx.getLaunchOptionsSync.html" target="_blank" rel="nofollow noopener noreferrer" title="https://developers.weixin.qq.com/miniprogram/dev/api/base/app/life-cycle/wx.getLaunchOptionsSync.html" ref="nofollow noopener noreferrer">wx.getLaunchOptionsSync</a>
<ol>
<li>获取小程序启动时的参数。与 <code>App.onLaunch</code> 的回调参数一致。</li>
<li><strong>拿到的参数是冷启动的时候拿到的</strong>。无论从哪里进来，在没有杀死进程的时候，该方法拿到的数据就是一样的。</li>
</ol>
</li>
<li><a href="https://link.juejin.cn/?target=https%3A%2F%2Fdevelopers.weixin.qq.com%2Fminiprogram%2Fdev%2Fapi%2Fbase%2Fapp%2Flife-cycle%2Fwx.getEnterOptionsSync.html" target="_blank" rel="nofollow noopener noreferrer" title="https://developers.weixin.qq.com/miniprogram/dev/api/base/app/life-cycle/wx.getEnterOptionsSync.html" ref="nofollow noopener noreferrer">wx.getEnterOptionsSync</a>，<strong>获取本次小程序启动时的参数。</strong>
<ol>
<li>如果当前是冷启动，则返回值与 <code>App.onLaunch</code> 的回调参数一致，也就是与 wx.getLaunchOptionsSync 一致；</li>
<li><strong>如果当前是热启动，则返回值与 App.onShow 一致</strong>；</li>
<li>所以这里可以保持每次获取的参数与当前的启动参数是保持一致的，热启动的参数可以覆盖同名参数。</li>
</ol>
</li>
<li>当小程序被销毁的时候，两个参数都是获取不到想要的值的，所以对于进入后台的小程序，如果没必要就要主动关闭，避免放置一段时间后，再次打开造成参数错误；
<ol>
<li>当小程序进入后台，可以维持一小段时间的运行状态，如果这段时间内都未进入前台，小程序会被销毁。</li>
<li>当小程序占用系统资源过高，可能会被系统销毁或被微信客户端主动回收。</li>
</ol>
</li>
</ol>
<h4 data-id="heading-17">渠道设置与获取</h4>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// 设置channel，与一般的参数类似，可以通过修改小程序后台体验码来控制打开的参数，模拟渠道投放</span>

<span class="hljs-comment">// pages/index/index?channel=3UAKHCEV</span>

<span class="hljs-comment">// 获取当前的channel，可以针对不同的参数，做一些屏蔽或者替换操作</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> getChannel = <span class="hljs-function">() =></span> &#123;
  <span class="hljs-keyword">const</span> &#123; query &#125; = wx.getEnterOptionsSync();
  <span class="hljs-keyword">const</span> &#123; channel &#125; = query;
  <span class="hljs-keyword">return</span> channel;
&#125;;
<span class="copy-code-btn">复制代码</span></code></pre>
<h3 data-id="heading-18">2、微信生成小程序二维码 scene 参数过长的方法</h3>
<p>小程序二维码 scene 参数限定长度为 32 位字符，但是实际开发中可能有很多的参数需要传递,比如<code>pages/common/webview?url=https%3A%2F%2Fstatic.qa.91jkys.com%2Ff2e%2Fcustomer-h5-im%2F%23%2Fquick-ask%3FcurChannelInDisableList%3D0%26channel%3D27</code>，这个时候就需要通过特殊处理之后才能使用，常见方式如下：</p>
<ol>
<li>中间页 + 短参数；
<ol>
<li>会多出来一次跳转；</li>
</ol>
</li>
<li>短参数（当前选择的方案）；
<ol>
<li>目前在<strong>进入页面时先判断是否有 scene 的值，如果有再请求接口获取完整的参数(json 格式)</strong>，然后再使用这个参数去调真正的业务接口；</li>
<li>这种方式要确认好，会被打开的页面；</li>
</ol>
</li>
</ol>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// 调用</span>
<span class="hljs-keyword">let</span> options = wx.getEnterOptionsSync();
options = <span class="hljs-keyword">await</span> queryLaunchParams(options);

<span class="hljs-comment">// 方法定义：这里处理扫面二维码的时候，通过二维码的短参数获取存在数据库中的全部参数的操作</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> queryLaunchParams = <span class="hljs-keyword">async</span> (options = &#123;&#125;) => &#123;
  <span class="hljs-keyword">if</span> (options.scene) &#123;
    <span class="hljs-keyword">const</span> &#123; qrScene &#125; = <span class="hljs-keyword">await</span> store.dispatch(<span class="hljs-string">'global/getParams'</span>, &#123; <span class="hljs-attr">destScene</span>: options.scene &#125;);
    <span class="hljs-keyword">return</span> &#123; ...options, ...queryString.parse(qrScene) &#125;;
  &#125; <span class="hljs-keyword">else</span> &#123;
    <span class="hljs-keyword">return</span> options;
  &#125;
&#125;;
<span class="copy-code-btn">复制代码</span></code></pre>
<h3 data-id="heading-19">3、<code>web-view</code> 打开 pdf 文件</h3>
<h4 data-id="heading-20">不能直接打开线上的 pdf，具体的步骤如下</h4>
<ol>
<li>线上文件下载到本地，uni.downloadFile；</li>
<li>本地打开所下载的 pdf，<a href="https://link.juejin.cn/?target=https%3A%2F%2Fdevelopers.weixin.qq.com%2Fminiprogram%2Fdev%2Fapi%2Ffile%2Fwx.openDocument.html" target="_blank" rel="nofollow noopener noreferrer" title="https://developers.weixin.qq.com/miniprogram/dev/api/file/wx.openDocument.html" ref="nofollow noopener noreferrer">uni.openDocument</a></li>
</ol>
<p>具体代码：</p>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// 1. 这里要通过线上的地址去下载pdf，然后获取本地地址，之后再使用web-view打开</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> getDocumentLocalPath = <span class="hljs-function">(<span class="hljs-params">url = <span class="hljs-string">''</span></span>) =></span> &#123;
  <span class="hljs-keyword">const</span> types = [<span class="hljs-string">'.pdf'</span>];
  <span class="hljs-keyword">const</span> filterArr = types.filter(<span class="hljs-function"><span class="hljs-params">item</span> =></span> &#123;
    <span class="hljs-keyword">return</span> url.includes(item);
  &#125;);

  <span class="hljs-keyword">if</span> (filterArr.length < <span class="hljs-number">1</span>) &#123;
    <span class="hljs-keyword">return</span>;
  &#125;
  <span class="hljs-keyword">const</span> fileType = filterArr[<span class="hljs-number">0</span>];

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =></span> &#123;
    wx.downloadFile(&#123;
      url,
      <span class="hljs-attr">success</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">res</span>) </span>&#123;
        <span class="hljs-keyword">const</span> filePath = res.tempFilePath;
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'getDocumentLocalPath'</span>, url, filePath);
        wx.openDocument(&#123;
          <span class="hljs-attr">filePath</span>: filePath,
          <span class="hljs-attr">fileType</span>: fileType.slice(<span class="hljs-number">1</span>),
          <span class="hljs-attr">success</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">res</span>) </span>&#123;
            <span class="hljs-comment">// 使用pdf本地地址作为webview的地址，需要回退一下，不然就会有一个白页</span>
            uni.navigateBack(&#123;
              <span class="hljs-attr">delta</span>: <span class="hljs-number">1</span>
            &#125;);
            resolve(filePath);
          &#125;
        &#125;);
      &#125;,
      <span class="hljs-attr">fail</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">e</span>) </span>&#123;
        reject(e);
      &#125;
    &#125;);
  &#125;);
&#125;;

<span class="hljs-comment">// 2. 使用</span>
<span class="hljs-keyword">const</span> url = <span class="hljs-keyword">await</span> getDocumentLocalPath(url);
<span class="hljs-comment">// webview是可以打开本地生成的地址的</span>
<span class="hljs-built_in">this</span>.url = url;
<span class="copy-code-btn">复制代码</span></code></pre></div>  
</div>
            