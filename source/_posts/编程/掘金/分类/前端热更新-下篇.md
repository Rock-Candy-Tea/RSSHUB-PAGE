
---
title: '前端热更新-下篇'
categories: 
 - 编程
 - 掘金
 - 分类
headimg: 'https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c670615f007940bf877e36261b945f7f~tplv-k3u1fbpfcp-watermark.image'
author: 掘金
comments: false
date: Tue, 20 Jul 2021 19:09:16 GMT
thumbnail: 'https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c670615f007940bf877e36261b945f7f~tplv-k3u1fbpfcp-watermark.image'
---

<div>   
<div class="markdown-body"><style>.markdown-body&#123;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333&#125;.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6&#123;line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px&#125;.markdown-body h1&#123;font-size:30px;margin-bottom:5px&#125;.markdown-body h2&#123;padding-bottom:12px;font-size:24px;border-bottom:1px solid #ececec&#125;.markdown-body h3&#123;font-size:18px;padding-bottom:0&#125;.markdown-body h4&#123;font-size:16px&#125;.markdown-body h5&#123;font-size:15px&#125;.markdown-body h6&#123;margin-top:5px&#125;.markdown-body p&#123;line-height:inherit;margin-top:22px;margin-bottom:22px&#125;.markdown-body img&#123;max-width:100%&#125;.markdown-body hr&#123;border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px&#125;.markdown-body code&#123;word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em&#125;.markdown-body code,.markdown-body pre&#123;font-family:Menlo,Monaco,Consolas,Courier New,monospace&#125;.markdown-body pre&#123;overflow:auto;position:relative;line-height:1.75&#125;.markdown-body pre>code&#123;font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8&#125;.markdown-body a&#123;text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff&#125;.markdown-body a:active,.markdown-body a:hover&#123;color:#275b8c&#125;.markdown-body table&#123;display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6&#125;.markdown-body thead&#123;background:#f6f6f6;color:#000;text-align:left&#125;.markdown-body tr:nth-child(2n)&#123;background-color:#fcfcfc&#125;.markdown-body td,.markdown-body th&#123;padding:12px 7px;line-height:24px&#125;.markdown-body td&#123;min-width:120px&#125;.markdown-body blockquote&#123;color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8&#125;.markdown-body blockquote:after&#123;display:block;content:""&#125;.markdown-body blockquote>p&#123;margin:10px 0&#125;.markdown-body ol,.markdown-body ul&#123;padding-left:28px&#125;.markdown-body ol li,.markdown-body ul li&#123;margin-bottom:0;list-style:inherit&#125;.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item&#123;list-style:none&#125;.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul&#123;margin-top:0&#125;.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul&#123;margin-top:3px&#125;.markdown-body ol li&#123;padding-left:6px&#125;.markdown-body .contains-task-list&#123;padding-left:0&#125;.markdown-body .task-list-item&#123;list-style:none&#125;@media (max-width:720px)&#123;.markdown-body h1&#123;font-size:24px&#125;.markdown-body h2&#123;font-size:20px&#125;.markdown-body h3&#123;font-size:18px&#125;&#125;</style><p>在 <a href="https://juejin.cn/post/6985081488920281119" target="_blank" title="https://juejin.cn/post/6985081488920281119">上一篇分享</a> 中讲到热更新服务端都做了什么，总结如下</p>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c670615f007940bf877e36261b945f7f~tplv-k3u1fbpfcp-watermark.image" alt loading="lazy" referrerpolicy="no-referrer"></p>
<p>那热更新过程中浏览器都做了哪些，从上一篇分享中可以知道</p>
<ul>
<li>
<p><code>xxx/node_modules/webpack-dev-server/client/index.js</code> <code>xxx/node_modules/webpack/hot/dev-server.js</code> 被打包到前端代码中</p>
</li>
<li>
<p>代码改变之后，webpack会通知浏览器有代码改变，然后浏览器拉取最新的代码</p>
</li>
</ul>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/073e3e6007744b669cf78b1037bc79b2~tplv-k3u1fbpfcp-watermark.image" alt loading="lazy" referrerpolicy="no-referrer"></p>
<h2 data-id="heading-0">监听代码变更 onSocketMessage</h2>
<p><code>webpack-dev-server/client/index.js</code></p>
<pre><code class="hljs language-javascript copyable" lang="javascript"><span class="hljs-keyword">var</span> socket = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./socket'</span>);
<span class="hljs-keyword">var</span> sendMessage = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./utils/sendMessage'</span>);
<span class="hljs-keyword">var</span> reloadApp = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./utils/reloadApp'</span>);

![image.png](https:<span class="hljs-comment">//p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3390035f94f041f29d538c8bc1522f53~tplv-k3u1fbpfcp-watermark.image)</span>
<span class="hljs-keyword">var</span> onSocketMessage = &#123;
  <span class="hljs-attr">invalid</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">invalid</span>(<span class="hljs-params"></span>) </span>&#123;
    sendMessage(<span class="hljs-string">'Invalid'</span>);
  &#125;,
  <span class="hljs-attr">hash</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">hash</span>(<span class="hljs-params">_hash</span>) </span>&#123;
    status.currentHash = _hash;
  &#125;,
  <span class="hljs-attr">ok</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ok</span>(<span class="hljs-params"></span>) </span>&#123;
    reloadApp(options, status);
  &#125;,
&#125;;

<span class="hljs-comment">// 启动socket服务， 注册hash，ok等消息类型的回调函数</span>
socket(socketUrl, onSocketMessage);
<span class="copy-code-btn">复制代码</span></code></pre>
<h2 data-id="heading-1">是否触发热更新 reloadApp</h2>
<p>作用：开启热更新配置，走热更新，如果没有开启，那么走浏览器重新刷新，如果项目嵌入在iframe中，那么重新刷新浏览器
<code>webpack-dev-server/client/utils/reloadApp.js</code></p>
<pre><code class="hljs language-javascript copyable" lang="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">reloadApp</span>(<span class="hljs-params">_ref, _ref2</span>) </span>&#123;
  <span class="hljs-keyword">var</span> hotReload = _ref.hotReload,
      hot = _ref.hot,
      liveReload = _ref.liveReload;
  <span class="hljs-keyword">var</span> isUnloading = _ref2.isUnloading,
      currentHash = _ref2.currentHash;

  <span class="hljs-keyword">if</span> (isUnloading || !hotReload) &#123;
    <span class="hljs-keyword">return</span>;
  &#125;
  
  <span class="hljs-comment">// 开启热更新</span>
  <span class="hljs-keyword">if</span> (hot) &#123;
    [log.info](http:<span class="hljs-comment">//log.info/)('[WDS] App hot update...');</span>
    <span class="hljs-keyword">var</span> hotEmitter = <span class="hljs-built_in">require</span>(<span class="hljs-string">'webpack/hot/emitter'</span>);
    <span class="hljs-comment">// 触发webpackHotUpdate事件</span>
    hotEmitter.emit(<span class="hljs-string">'webpackHotUpdate'</span>, currentHash);

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> self !== <span class="hljs-string">'undefined'</span> && self.window) &#123;
      <span class="hljs-comment">// broadcast update to window</span>
      self.postMessage(<span class="hljs-string">"webpackHotUpdate"</span>.concat(currentHash), <span class="hljs-string">'*'</span>);
    &#125;
  &#125; <span class="hljs-comment">// allow refreshing the page only if liveReload isn't disabled</span>
  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (liveReload) &#123;
  <span class="hljs-comment">// 热加载，刷新浏览器</span>
      <span class="hljs-keyword">var</span> rootWindow = self; <span class="hljs-comment">// use parent window for reload (in case we're in an iframe with no valid src)</span>

      <span class="hljs-keyword">var</span> intervalId = self.setInterval(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;
        <span class="hljs-keyword">if</span> (rootWindow.location.protocol !== <span class="hljs-string">'about:'</span>) &#123;
          <span class="hljs-comment">// reload immediately if protocol is valid</span>
          applyReload(rootWindow, intervalId);
        &#125; <span class="hljs-keyword">else</span> &#123;
          rootWindow = rootWindow.parent;
          <span class="hljs-comment">// 触发顶层刷新，如果项目是在iframe中</span>
          <span class="hljs-keyword">if</span> (rootWindow.parent === rootWindow) &#123;
            <span class="hljs-comment">// if parent equals current window we've reached the root which would continue forever, so trigger a reload anyways</span>
            applyReload(rootWindow, intervalId);
          &#125;
        &#125;
      &#125;);
    &#125;
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">applyReload</span>(<span class="hljs-params">rootWindow, intervalId</span>) </span>&#123;
    <span class="hljs-built_in">clearInterval</span>(intervalId);
    [log.info](http:<span class="hljs-comment">//log.info/)('[WDS] App updated. Reloading...');</span>
    rootWindow.location.reload();
  &#125;
&#125;
<span class="copy-code-btn">复制代码</span></code></pre>
<p>监听 <code>webpackHotUpdate</code> 事件，然后调用 <code>module.hot.check</code> 和 <code>module.hot.apply</code> 方法, 如果没有开始hmr的话，没有module.hot 属性，开启hmr后HotModuleReplacementPlugin这个插件在module上加上了hot属性</p>
<pre><code class="hljs language-javascript copyable" lang="javascript">
<span class="hljs-keyword">if</span> (<span class="hljs-built_in">module</span>.hot) &#123;
        <span class="hljs-keyword">var</span> lastHash;
        <span class="hljs-keyword">var</span> upToDate = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">upToDate</span>(<span class="hljs-params"></span>) </span>&#123;
                <span class="hljs-keyword">return</span> lastHash.indexOf(__webpack_hash__) >= <span class="hljs-number">0</span>;
        &#125;;
        <span class="hljs-keyword">var</span> log = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./log"</span>);
        <span class="hljs-keyword">var</span> check = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">check</span>(<span class="hljs-params"></span>) </span>&#123;
                <span class="hljs-built_in">module</span>.hot
                        .check()
                        .then(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">updatedModules</span>) </span>&#123;
                              <span class="hljs-keyword">return</span> <span class="hljs-built_in">module</span>.hot.apply(&#123;&#125;)            
                        &#125;)
                        .catch(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err</span>) </span>&#123;
                        &#125;);
        &#125;;
        <span class="hljs-keyword">var</span> hotEmitter = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./emitter"</span>);
        hotEmitter.on(<span class="hljs-string">"webpackHotUpdate"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">currentHash</span>) </span>&#123;
                lastHash = currentHash;
                <span class="hljs-comment">// 与上一次的hash不同</span>
                <span class="hljs-keyword">if</span> (!upToDate()) &#123;
                        check()
                &#125;
        &#125;);
&#125; <span class="hljs-keyword">else</span> &#123;
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"[HMR] Hot Module Replacement is disabled."</span>);
&#125;
<span class="copy-code-btn">复制代码</span></code></pre>
<h2 data-id="heading-2">module.hot.check</h2>
<p>作用:
1 下载hot-update.json文件
2 下载hot-update.js文件
3 执行下载的hot-update.js文件
<code>webpack/bootstrap</code></p>
<pre><code class="hljs language-javascript copyable" lang="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">hotCheck</span>(<span class="hljs-params">apply</span>) </span>&#123;
                 hotApplyOnUpdate = apply;
                 hotSetStatus(<span class="hljs-string">"check"</span>);
                 <span class="hljs-comment">// 下载json文件</span>
                 <span class="hljs-keyword">return</span> hotDownloadManifest(hotRequestTimeout).then(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">update</span>) </span>&#123;
                         hotSetStatus(<span class="hljs-string">"prepare"</span>);
                         <span class="hljs-keyword">var</span> promise = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">resolve, reject</span>) </span>&#123;
                                 hotDeferred = &#123;
                                         <span class="hljs-attr">resolve</span>: resolve,
                                         <span class="hljs-attr">reject</span>: reject
                                 &#125;;
                         &#125;);
                         hotUpdate = &#123;&#125;;
                         <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> chunkId <span class="hljs-keyword">in</span> installedChunks)
                         <span class="hljs-comment">// eslint-disable-next-line no-lone-blocks</span>
                         &#123;
                                 <span class="hljs-comment">// 下载改变后的js文件</span>
                                 hotEnsureUpdateChunk(chunkId);
                         &#125;

                 &#125;);
         &#125;
<span class="copy-code-btn">复制代码</span></code></pre>
<p><code>hotEnsureUpdateChunk</code></p>
<pre><code class="hljs language-javascript copyable" lang="javascript"> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">hotEnsureUpdateChunk</span>(<span class="hljs-params">chunkId</span>) </span>&#123;
       <span class="hljs-comment">// 下载js</span>
       hotDownloadUpdateChunk(chunkId);      
 &#125;
 
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">hotDownloadUpdateChunk</span>(<span class="hljs-params">chunkId</span>) </span>&#123;
     <span class="hljs-comment">// 通过script 标签加载更新后的js</span>
     <span class="hljs-keyword">var</span> script = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">"script"</span>);
     script.charset = <span class="hljs-string">"utf-8"</span>;
     script.src = __webpack_require__.p + <span class="hljs-string">""</span> + chunkId + <span class="hljs-string">"."</span> + hotCurrentHash + <span class="hljs-string">".hot-update.js"</span>;
     <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span>) script.crossOrigin = <span class="hljs-literal">null</span>;
     <span class="hljs-built_in">document</span>.head.appendChild(script);
&#125;
<span class="copy-code-btn">复制代码</span></code></pre>
<p>执行下载后的hot-update.js 文件，调用 <code>webpackHotUpdate</code> 方法</p>
<pre><code class="hljs language-javascript copyable" lang="javascript">webpackHotUpdate(<span class="hljs-string">"main"</span>,&#123;
<span class="hljs-string">"./src/App.js"</span>: (<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"><span class="hljs-built_in">module</span>, __webpack_exports__, __webpack_require__</span>) </span>&#123;
    <span class="hljs-comment">// 改变后的代码</span>
&#125;
&#125;)
<span class="copy-code-btn">复制代码</span></code></pre>
<p><code>webpackHotUpdate</code></p>
<pre><code class="hljs language-javascript copyable" lang="javascript"> <span class="hljs-built_in">this</span>[<span class="hljs-string">"webpackHotUpdate"</span>] = <span class="hljs-comment">// eslint-disable-next-line no-unused-vars</span>
 <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">webpackHotUpdateCallback</span>(<span class="hljs-params">chunkId, moreModules</span>) </span>&#123;
         hotAddUpdateChunk(chunkId, moreModules);
         <span class="hljs-keyword">if</span> (parentHotUpdateCallback) parentHotUpdateCallback(chunkId, moreModules);
 &#125;;
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">hotAddUpdateChunk</span>(<span class="hljs-params">chunkId, moreModules</span>) </span>&#123;
     <span class="hljs-keyword">if</span> (!hotAvailableFilesMap[chunkId] || !hotRequestedFilesMap[chunkId])
             <span class="hljs-keyword">return</span>;
     hotRequestedFilesMap[chunkId] = <span class="hljs-literal">false</span>;
     <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> moduleId <span class="hljs-keyword">in</span> moreModules) &#123;
             <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Object</span>.prototype.hasOwnProperty.call(moreModules, moduleId)) &#123;
                     <span class="hljs-comment">// 将要更新的moduleId 移到 hotUpdate</span>
                     hotUpdate[moduleId] = moreModules[moduleId];
             &#125;
     &#125;
     <span class="hljs-keyword">if</span> (--hotWaitingFiles === <span class="hljs-number">0</span> && hotChunksLoading === <span class="hljs-number">0</span>) &#123;
             hotUpdateDownloaded();
     &#125;
&#125;
<span class="copy-code-btn">复制代码</span></code></pre>
<p><code>hotUpdateDownloaded</code></p>
<pre><code class="hljs language-javascript copyable" lang="javascript"> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">hotUpdateDownloaded</span>(<span class="hljs-params"></span>) </span>&#123;
         hotSetStatus(<span class="hljs-string">"ready"</span>);
         <span class="hljs-comment">// 这个deffered是在hotCheck中定义的</span>
         <span class="hljs-keyword">var</span> deferred = hotDeferred;
         hotDeferred = <span class="hljs-literal">null</span>;
         <span class="hljs-keyword">if</span> (!deferred) <span class="hljs-keyword">return</span>;
                 <span class="hljs-keyword">var</span> outdatedModules = [];
                 <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> id <span class="hljs-keyword">in</span> hotUpdate) &#123;
                         <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Object</span>.prototype.hasOwnProperty.call(hotUpdate, id)) &#123;
                                 outdatedModules.push(toModuleId(id));
                         &#125;
                 &#125;
                 <span class="hljs-comment">// 跳出module.hot.check</span>
                 deferred.resolve(outdatedModules);
         &#125;
 &#125;
 
 <span class="hljs-keyword">var</span> check = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">check</span>(<span class="hljs-params"></span>) </span>&#123;
        <span class="hljs-built_in">module</span>.hot
                .check()
                .then(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">updatedModules</span>) </span>&#123;
                      <span class="hljs-keyword">return</span> <span class="hljs-built_in">module</span>.hot.apply(&#123;&#125;)            
                &#125;)
                .catch(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err</span>) </span>&#123;
                &#125;);
&#125;;
<span class="copy-code-btn">复制代码</span></code></pre>
<h2 data-id="heading-3">module.hot.apply</h2>
<p>作用</p>
<ul>
<li>找出过期模块 <code>outdatedModules</code> 和过期依赖 <code>outdatedDependencies</code> ；</li>
</ul>
<pre><code class="hljs language-javascript copyable" lang="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">hotApply</span>(<span class="hljs-params"></span>) </span>&#123; 
  <span class="hljs-comment">// ...</span>
  <span class="hljs-keyword">var</span> outdatedDependencies = &#123;&#125;;
  <span class="hljs-keyword">var</span> outdatedModules = [];
  <span class="hljs-comment">// 这个方法会手机过期模块以及哪些模块依赖过期模块</span>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getAffectedStuff</span>(<span class="hljs-params">updateModuleId</span>) </span>&#123;
    <span class="hljs-keyword">var</span> outdatedModules = [updateModuleId];
    <span class="hljs-keyword">var</span> outdatedDependencies = &#123;&#125;;
    <span class="hljs-comment">// ...</span>
    <span class="hljs-keyword">return</span> &#123;
        <span class="hljs-attr">type</span>: <span class="hljs-string">"accepted"</span>,
        <span class="hljs-attr">moduleId</span>: updateModuleId,
        <span class="hljs-attr">outdatedModules</span>: outdatedModules,
        <span class="hljs-attr">outdatedDependencies</span>: outdatedDependencies
    &#125;;
 &#125;;
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">addAllToSet</span>(<span class="hljs-params">a, b</span>) </span>&#123;
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i < b.length; i++) &#123;
          <span class="hljs-keyword">var</span> item = b[i];
          <span class="hljs-keyword">if</span> (a.indexOf(item) < <span class="hljs-number">0</span>)
              a.push(item);
      &#125;
  &#125;
  <span class="hljs-comment">// 这个hotUpdate：在 hotAddUpdateChunk 中给hotUpdate 赋值了</span>
  <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> id <span class="hljs-keyword">in</span> hotUpdate) &#123;
      <span class="hljs-keyword">if</span>(<span class="hljs-built_in">Object</span>.prototype.hasOwnProperty.call(hotUpdate, id)) &#123;
          <span class="hljs-comment">// ... 省略多余代码</span>
          <span class="hljs-keyword">if</span>(hotUpdate[id]) &#123;
              result = getAffectedStuff(moduleId);
          &#125;
          <span class="hljs-keyword">if</span>(doApply) &#123;
              <span class="hljs-keyword">for</span>(moduleId <span class="hljs-keyword">in</span> result.outdatedDependencies) &#123;
                 <span class="hljs-comment">// 添加到 outdatedDependencies</span>
                  addAllToSet(outdatedDependencies[moduleId], result.outdatedDependencies[moduleId]);
              &#125;
          &#125;
          <span class="hljs-keyword">if</span>(doDispose) &#123;
              <span class="hljs-comment">// 添加到 outdatedModules</span>
              addAllToSet(outdatedModules, [result.moduleId]);
              appliedUpdate[moduleId] = warnUnexpectedRequire;
          &#125;
      &#125;
  &#125;
&#125;
<span class="copy-code-btn">复制代码</span></code></pre>
<ul>
<li>从缓存中删除过期模块、依赖和所有子元素的引用；</li>
</ul>
<pre><code class="hljs language-javascript copyable" lang="javascript">
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">hotApply</span>(<span class="hljs-params"></span>) </span>&#123;
   <span class="hljs-comment">// ...</span>
    <span class="hljs-keyword">var</span> idx;
    <span class="hljs-keyword">var</span> queue = outdatedModules.slice();
    <span class="hljs-keyword">while</span>(queue.length > <span class="hljs-number">0</span>) &#123;
        moduleId = queue.pop();
        <span class="hljs-built_in">module</span> = installedModules[moduleId];
        <span class="hljs-comment">// ...</span>
        <span class="hljs-comment">// 移除缓存中的模块，这样就可以通过weback_require 重新执行代码了</span>
        <span class="hljs-keyword">delete</span> installedModules[moduleId];
        <span class="hljs-comment">// 移除过期依赖中不需要使用的处理方法</span>
        <span class="hljs-keyword">delete</span> outdatedDependencies[moduleId];
        <span class="hljs-comment">// 移除所有子元素的引用</span>
        <span class="hljs-keyword">for</span>(j = <span class="hljs-number">0</span>; j < <span class="hljs-built_in">module</span>.children.length; j++) &#123;
            <span class="hljs-keyword">var</span> child = installedModules[<span class="hljs-built_in">module</span>.children[j]];
            <span class="hljs-keyword">if</span>(!child) <span class="hljs-keyword">continue</span>;
            idx = child.parents.indexOf(moduleId);
            <span class="hljs-keyword">if</span>(idx >= <span class="hljs-number">0</span>) &#123;
                child.parents.splice(idx, <span class="hljs-number">1</span>);
            &#125;
        &#125;
    &#125; 
  <span class="hljs-comment">// 从模块子组件中删除过时的依赖项</span>
  <span class="hljs-keyword">var</span> dependency;
  <span class="hljs-keyword">var</span> moduleOutdatedDependencies;
  <span class="hljs-keyword">for</span>(moduleId <span class="hljs-keyword">in</span> outdatedDependencies) &#123;
   <span class="hljs-keyword">if</span>(<span class="hljs-built_in">Object</span>.prototype.hasOwnProperty.call(outdatedDependencies, moduleId)) &#123;
    <span class="hljs-built_in">module</span> = installedModules[moduleId];
    <span class="hljs-keyword">if</span>(<span class="hljs-built_in">module</span>) &#123;
     moduleOutdatedDependencies = outdatedDependencies[moduleId];
     <span class="hljs-keyword">for</span>(j = <span class="hljs-number">0</span>; j < moduleOutdatedDependencies.length; j++) &#123;
      dependency = moduleOutdatedDependencies[j];
      idx = <span class="hljs-built_in">module</span>.children.indexOf(dependency);
      <span class="hljs-keyword">if</span>(idx >= <span class="hljs-number">0</span>) <span class="hljs-built_in">module</span>.children.splice(idx, <span class="hljs-number">1</span>);
     &#125;
    &#125;
   &#125;
  &#125;
<span class="copy-code-btn">复制代码</span></code></pre>
<ul>
<li>将新模块代码添加到 modules 中，当下次调用 <code>__webpack_require__</code> (webpack 重写的 <code>require</code> 方法)方法的时候，就是获取到了新的模块代码了</li>
</ul>
<pre><code class="hljs language-javascript copyable" lang="javascript">
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">hotApply</span>(<span class="hljs-params"></span>) </span>&#123;
   <span class="hljs-comment">// ...</span>
    <span class="hljs-keyword">for</span>(moduleId <span class="hljs-keyword">in</span> appliedUpdate) &#123;
        <span class="hljs-keyword">if</span>(<span class="hljs-built_in">Object</span>.prototype.hasOwnProperty.call(appliedUpdate, moduleId)) &#123;
            modules[moduleId] = appliedUpdate[moduleId];
        &#125;
    &#125;
&#125;

<span class="copy-code-btn">复制代码</span></code></pre>
<h2 data-id="heading-4">参考文档</h2>
<p><a href="https://link.juejin.cn/?target=https%3A%2F%2Fblog.csdn.net%2Fqq_36380426%2Farticle%2Fdetails%2F106821511" target="_blank" rel="nofollow noopener noreferrer" title="https://blog.csdn.net/qq_36380426/article/details/106821511" ref="nofollow noopener noreferrer">【Webpack】627- 了不起的 Webpack HMR 学习指南(含源码分析)_pingan8787-CSDN博客</a></p></div>  
</div>
            