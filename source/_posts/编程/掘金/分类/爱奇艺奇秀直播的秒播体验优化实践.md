
---
title: '爱奇艺奇秀直播的秒播体验优化实践'
categories: 
 - 编程
 - 掘金
 - 分类
headimg: 'https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ccadfe82d3864989be807c6a0b9e0eeb~tplv-k3u1fbpfcp-zoom-1.image'
author: 掘金
comments: false
date: Fri, 09 Jul 2021 00:20:41 GMT
thumbnail: 'https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ccadfe82d3864989be807c6a0b9e0eeb~tplv-k3u1fbpfcp-zoom-1.image'
---

<div>   
<div class="markdown-body"><style>.markdown-body&#123;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333&#125;.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6&#123;line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px&#125;.markdown-body h1&#123;font-size:30px;margin-bottom:5px&#125;.markdown-body h2&#123;padding-bottom:12px;font-size:24px;border-bottom:1px solid #ececec&#125;.markdown-body h3&#123;font-size:18px;padding-bottom:0&#125;.markdown-body h4&#123;font-size:16px&#125;.markdown-body h5&#123;font-size:15px&#125;.markdown-body h6&#123;margin-top:5px&#125;.markdown-body p&#123;line-height:inherit;margin-top:22px;margin-bottom:22px&#125;.markdown-body img&#123;max-width:100%&#125;.markdown-body hr&#123;border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px&#125;.markdown-body code&#123;word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em&#125;.markdown-body code,.markdown-body pre&#123;font-family:Menlo,Monaco,Consolas,Courier New,monospace&#125;.markdown-body pre&#123;overflow:auto;position:relative;line-height:1.75&#125;.markdown-body pre>code&#123;font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8&#125;.markdown-body a&#123;text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff&#125;.markdown-body a:active,.markdown-body a:hover&#123;color:#275b8c&#125;.markdown-body table&#123;display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6&#125;.markdown-body thead&#123;background:#f6f6f6;color:#000;text-align:left&#125;.markdown-body tr:nth-child(2n)&#123;background-color:#fcfcfc&#125;.markdown-body td,.markdown-body th&#123;padding:12px 7px;line-height:24px&#125;.markdown-body td&#123;min-width:120px&#125;.markdown-body blockquote&#123;color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8&#125;.markdown-body blockquote:after&#123;display:block;content:""&#125;.markdown-body blockquote>p&#123;margin:10px 0&#125;.markdown-body ol,.markdown-body ul&#123;padding-left:28px&#125;.markdown-body ol li,.markdown-body ul li&#123;margin-bottom:0;list-style:inherit&#125;.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item&#123;list-style:none&#125;.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul&#123;margin-top:0&#125;.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul&#123;margin-top:3px&#125;.markdown-body ol li&#123;padding-left:6px&#125;.markdown-body .contains-task-list&#123;padding-left:0&#125;.markdown-body .task-list-item&#123;list-style:none&#125;@media (max-width:720px)&#123;.markdown-body h1&#123;font-size:24px&#125;.markdown-body h2&#123;font-size:20px&#125;.markdown-body h3&#123;font-size:18px&#125;&#125;</style><p>在视频直播中，<strong>首帧渲染速度</strong>会直接影响用户体验。想象一下，你兴致勃勃进入了一个爱豆的直播间，进入直播间后迟迟不见直播画面，而是长时间停留在直播间背景图上，这是大多数用户都无法接受的体验。</p>
<p>为了提高用户在<strong>爱奇艺直播和小视频平台奇秀app iOS端</strong>的观看体验，爱奇艺去年中旬对<strong>奇秀秒播</strong>进行了整体的优化，主要涉及<strong>业务逻辑以及视觉上</strong>的优化。</p>
<h2 data-id="heading-0">01 问题出在哪儿？</h2>
<p>从进入直播间到第一帧画面渲染。<strong>播放流程一般涉及如下几个方面：</strong></p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ccadfe82d3864989be807c6a0b9e0eeb~tplv-k3u1fbpfcp-zoom-1.image" alt loading="lazy" referrerpolicy="no-referrer"></p>
<p>分析耗时操作，首先要找到耗时较多的逻辑。这里尝试了两种方法：</p>
<p>**（1）打印日志。**在进入方法前、方法执行结束后，打印日志，输出方法的耗时。</p>
<p>**（2）利用埋点投递。**在秒播路径中设置若干关键节点，每个节点触发时，将耗时数据投递到神策。</p>
<p>对于打印日志，在实际操作的过程中，发现有比较明显的弊端，比如：</p>
<p>（1）测试次数一般不会很多，所以<strong>不具有代表性。</strong></p>
<p>（2）进入<strong>不同的直播间、在不同的网络状况下</strong>，都可能会影响到<strong>测试数据。</strong></p>
<p>为了保证分析数据的准确，最终采用<strong>埋点投递配合TimeProfile的方式。</strong></p>
<p>首先将秒播的过程分成<strong>几个重要的阶段</strong>：进入直播间、房间数据请求返回、准备播放、第一帧渲染成功。</p>
<p>通过埋点，统计出不同阶段的耗时情况。这里以优化前的5.5.0版本举例，如图所示：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/cab4403fafec46108a04064711f3b137~tplv-k3u1fbpfcp-zoom-1.image" alt loading="lazy" referrerpolicy="no-referrer"></p>
<p>从图中可以看到，<strong>房间数据请求解析阶段以及播放阶段耗时较长。</strong></p>
<p>缩小了问题的范围，我们使用<strong>XCode自带的调试工具Time Profile进行具体的耗时分析。</strong></p>
<p>TimeProfile的原理是通过按照固定的时间间隔来跟踪每一个线程的堆栈信息，通过统计比较不同时间间隔之间的堆栈状态，来推算某个方法执行了多久，并获得一个近似值。如图：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6c6e6650f65f482d89fed6daa3e55b9a~tplv-k3u1fbpfcp-zoom-1.image" alt loading="lazy" referrerpolicy="no-referrer"></p>
<p>对多次测试数据进行对比发现，<strong>具体的耗时逻辑主要有两处：</strong></p>
<p>（1）播放器SetFrame操作会卡主主线程较长时间。</p>
<p>（2）处理房间接口返回的数据消耗的较多的时间。</p>
<h2 data-id="heading-1">02 如何解决？</h2>
<p>首先，最亟待解决的问题是<strong>SetFrame导致卡顿的问题</strong>，通过与播放内核同学的沟通，猜测<strong>可能与苹果系统的转场动画有关(疑似资源争抢，播放器短时间内获取不到上下文)</strong>，导致播放器在系统进行动画的过程中去争抢相关资源，最终导致第一帧渲染失败。所以这里引入状态机来解决这个问题：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/98303ac00975444092fd15a5c86bf9b2~tplv-k3u1fbpfcp-zoom-1.image" alt loading="lazy" referrerpolicy="no-referrer"></p>
<p>所有的播放操作都等到系统告知我们UI布局结束后再去操作，这样调整后，<strong>秒播回到正常的区间（大概56%左右），且未再复现卡顿问题。</strong></p>
<p>其次，对于处理接口返回的数据，进行的一系列初始化操作耗时较多的问题。<strong>具体分为2点：</strong></p>
<p>（1）初始化各个功能模块会导致耗时较多，比如聊天区历史消息功能。</p>
<p>（2）由于iOS要求UI相关的操作需要在主线程进行，所以接口请求返回后，存在多次异步到主线程的逻辑，非常消耗时间。</p>
<p>针对功能模块初始化耗时问题，我们在直播间抽象了一个**功能管理模块，一方面是控制模块的加载时机，另一方面可以将功能模块与直播间解耦。**如图：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/bbf907bd73014c1fabd160992c78b61d~tplv-k3u1fbpfcp-zoom-1.image" alt loading="lazy" referrerpolicy="no-referrer"></p>
<p>针对<strong>重复异步到主线程</strong>的问题，我们在底层对<strong>所有的网络请求</strong>都进行一次异步到主线程的操作，这样就不用在业务层由开发同学再进行异步主线程的操作了。</p>
<p><strong>这个问题改动之后，秒播提升较为明显，大概稳定在78%左右。</strong></p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/124c9eb4e8194904a68cbb4465402808~tplv-k3u1fbpfcp-zoom-1.image" alt loading="lazy" referrerpolicy="no-referrer"></p>
<h2 data-id="heading-2">03 一些非技术相关的调整</h2>
<p>上面主要讨论的是<strong>从外部进入直播间的秒播优化</strong>，我们还有一种比较重要的切换直播间的方式——上下滑切换。</p>
<p>对于上下滑技术上的相关优化，我们放在下一个章节说明。我们讨论一种通过<strong>一些视觉上的处理</strong>，让上下滑操作中的秒播<strong>看起来"更快"一些。</strong></p>
<p>相较于之前先加载直播间UI的方式，新的方式延迟直播间相关UI的创建（拿到房间数据后再创建），由于观众首先看到的是直播画面，所以会给人一种播放的"更快"的错觉。</p>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/afdb2045361d459289d5902f887a9ff3~tplv-k3u1fbpfcp-watermark.image" alt loading="lazy" referrerpolicy="no-referrer"></p>
<h2 data-id="heading-3">04 继续改进的方向</h2>
<p>再看看技术方面。</p>
<p>目前针对上下滑也做了一些优化，主要是在滑动操作中，<strong>当手指离开屏幕时判断出动画结束时是否会滑入到下一个直播间，从而提前加载播放数据。</strong></p>
<p>相对于之前等待完全滑入到下一个直播间后，再加载播放数据，有了一定的提升。但实际上还存在着<strong>一些缺点</strong>，比如：</p>
<p>（1）已经判断出要滑动到下一个直播间，但在滑动动画结束之前，用户突然触摸屏幕导致滑动中止。这时如果用户放弃滑入到下个直播间，而是返回刚刚的直播间，那么就要重新加载播放数据，体验不是很好。</p>
<p>（2）在用户开始滑动到手指离开屏幕，这段时间其实什么都做不了，浪费掉了。</p>
<p>对于滑动切换直播间这个操作，目前更好的实现方式是使用<strong>双播放器，<strong>这样在开始滑动时，就可以直接加载下个直播间的数据，从而避免了对于一些特殊情况的复杂逻辑处理并且</strong>最大限度地提前了加载的时间。</strong></p>
<p>但由于我们的<strong>播放内核较大，目前采用双播放器会导致直播间架构复杂度上升，边际成本较高</strong>，所以没有再进一步尝试双播放器的方式。</p>
<h2 data-id="heading-4">05 结语</h2>
<p><strong>通过对逻辑、视觉效果的优化，最终将秒播率提升至78%左右。</strong></p>
<p>除了通过一些新的机制（<strong>比如上面提到的延迟加载、模块管理</strong>）来保证后续版本迭代时不会对秒播率造成影响，还会尝试双播放器来进一步提升秒播率，<strong>为用户带来更好的播放体验。</strong></p></div>  
</div>
            