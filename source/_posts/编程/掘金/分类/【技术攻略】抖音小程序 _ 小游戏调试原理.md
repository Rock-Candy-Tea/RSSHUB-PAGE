
---
title: '【技术攻略】抖音小程序 _ 小游戏调试原理'
categories: 
 - 编程
 - 掘金
 - 分类
headimg: 'https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/90106126129844a092f57bf49c56e8fc~tplv-k3u1fbpfcp-watermark.image'
author: 掘金
comments: false
date: Tue, 06 Apr 2021 01:46:48 GMT
thumbnail: 'https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/90106126129844a092f57bf49c56e8fc~tplv-k3u1fbpfcp-watermark.image'
---

<div>   
<div class="markdown-body"><style>.markdown-body&#123;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333&#125;.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6&#123;line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px&#125;.markdown-body h1&#123;font-size:30px;margin-bottom:5px&#125;.markdown-body h2&#123;padding-bottom:12px;font-size:24px;border-bottom:1px solid #ececec&#125;.markdown-body h3&#123;font-size:18px;padding-bottom:0&#125;.markdown-body h4&#123;font-size:16px&#125;.markdown-body h5&#123;font-size:15px&#125;.markdown-body h6&#123;margin-top:5px&#125;.markdown-body p&#123;line-height:inherit;margin-top:22px;margin-bottom:22px&#125;.markdown-body img&#123;max-width:100%&#125;.markdown-body hr&#123;border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px&#125;.markdown-body code&#123;word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em&#125;.markdown-body code,.markdown-body pre&#123;font-family:Menlo,Monaco,Consolas,Courier New,monospace&#125;.markdown-body pre&#123;overflow:auto;position:relative;line-height:1.75&#125;.markdown-body pre>code&#123;font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8&#125;.markdown-body a&#123;text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff&#125;.markdown-body a:active,.markdown-body a:hover&#123;color:#275b8c&#125;.markdown-body table&#123;display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6&#125;.markdown-body thead&#123;background:#f6f6f6;color:#000;text-align:left&#125;.markdown-body tr:nth-child(2n)&#123;background-color:#fcfcfc&#125;.markdown-body td,.markdown-body th&#123;padding:12px 7px;line-height:24px&#125;.markdown-body td&#123;min-width:120px&#125;.markdown-body blockquote&#123;color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8&#125;.markdown-body blockquote:after&#123;display:block;content:""&#125;.markdown-body blockquote>p&#123;margin:10px 0&#125;.markdown-body ol,.markdown-body ul&#123;padding-left:28px&#125;.markdown-body ol li,.markdown-body ul li&#123;margin-bottom:0;list-style:inherit&#125;.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item&#123;list-style:none&#125;.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul&#123;margin-top:0&#125;.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul&#123;margin-top:3px&#125;.markdown-body ol li&#123;padding-left:6px&#125;.markdown-body .contains-task-list&#123;padding-left:0&#125;.markdown-body .task-list-item&#123;list-style:none&#125;@media (max-width:720px)&#123;.markdown-body h1&#123;font-size:24px&#125;.markdown-body h2&#123;font-size:20px&#125;.markdown-body h3&#123;font-size:18px&#125;&#125;</style><p>作者：黄俊铭，抖音小程序前端开发工程师</p>
<blockquote>
<p>本文阐述目前抖音小程序 / 小游戏所使用的本地以及远程调试相关技术，阐述整体运作流程，包含本地调试、远程调试、小程序 webview 调试以及V8调试相关的核心类与实现。</p>
</blockquote>
<h2 data-id="heading-0">基础概念</h2>
<p>首先需要提到的是，chrome 与 V8 本身实现了一套调试协议：<a href="https://chromedevtools.github.io/devtools-protocol/" target="_blank" rel="nofollow noopener noreferrer">chromedevtools.github.io/devtools-pr…</a></p>
<p>比如我们在 chrome devtool 打了一个断点，devtool 会自动产生协议消息，V8 获得协议消息之后也能对该协议消息进行解析产生相应的反馈，产生协议消息再给 chrome devtool, chrome devtool 再展示相应的变量信息等。</p>
<p>如下图，拦截了 ws 消息，可以看到协议中产生的消息自动产生了 id 序列号码以及方法（绿色的是 chrome devtool 发出的消息，红色是从 V8 发来，chrome devtool 接收到的消息）。
<img alt="image.png" class="lazyload" src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/90106126129844a092f57bf49c56e8fc~tplv-k3u1fbpfcp-watermark.image" data-width="800" data-height="600" referrerpolicy="no-referrer"></p>
<h2 data-id="heading-1">本地调试</h2>
<p><img alt="image.png" class="lazyload" src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/cedaaec7fe7e4b2592e4da90ed2449f1~tplv-k3u1fbpfcp-watermark.image" data-width="800" data-height="600" referrerpolicy="no-referrer">
小程序/小游戏在内部包支持本地直接连接 USB 进行本地调试，在没有配置远程调试链接模式下，默认在初始化V8引擎后，内部会在本地开启一个websocket server，端口为9229。</p>
<p>同时这个websocket server需要支持/json（更多可以参考：<a href="https://chromedevtools.github.io/devtools-protocol/" target="_blank" rel="nofollow noopener noreferrer">chromedevtools.github.io/devtools-pr…</a> ），这样chrome就能在 chrome://inspect 界面找到该调试。</p>
<p>具体操作就是，手机设备先连接USB线，然后执行 adb forward tcp:9229 tcp:9229 转发端口到电脑设备，这时我们可以访问 localhost:9229，可以看到如下数据，描述了调试调试链接等信息。</p>
<pre><code class="copyable">[
  &#123;
    "description": "helium v8 inspect",
    "devtoolsFrontendUrl": "chrome-devtools://devtools/bundled/js_app.html?experiments=true&v8only=true&ws=127.0.0.1:9229/helium",
    "title": "helium",
    "id": "helium",
    "type": "node",
    "url": "file://",
    "webSocketDebuggerUrl": "ws://127.0.0.1:9229/helium"
  &#125;
]
<span class="copy-code-btn">复制代码</span></code></pre>
<p>打开 chrome://inspect，可以配置寻找的相应端口号
<img alt="image.png" class="lazyload" src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/06c2b47df1aa49e2a838e409c7d5d0f6~tplv-k3u1fbpfcp-watermark.image" data-width="800" data-height="600" referrerpolicy="no-referrer"></p>
<p>最后从 chrome://inspect 可以看到
<img alt="image.png" class="lazyload" src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/23243e46a73b43bdac7c67966f2a959a~tplv-k3u1fbpfcp-watermark.image" data-width="800" data-height="600" referrerpolicy="no-referrer"></p>
<p>点击 inspect 则打开 json 结构中的 devtoolsFrontendUrl</p>
<pre><code class="copyable">chrome-devtools://devtools/bundled/js_app.html?experiments=true&v8only=true&ws=127.0.0.1:9229/helium
<span class="copy-code-btn">复制代码</span></code></pre>
<p>可以观察发现ws=127.0.0.1:9229/helium 其实就是告诉chrome devtool去连接该链接的websocket server，这样的话就 websocket server 就能收到 devtool 传来的调试协议消息，然后传给 v8，v8 产生协议消息后再给websocket server向devtool发送消息，这样就产生了整个调试通路。</p>
<h2 data-id="heading-2">远程调试</h2>
<p><img alt="image.png" class="lazyload" src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/62ed298bfa9c470491af8193a3d56447~tplv-k3u1fbpfcp-watermark.image" data-width="800" data-height="600" referrerpolicy="no-referrer">
本地调试是我们的内部调试方式，并且使用 USB 调试比较麻烦，为了解决开发者的调试，我们加了一个远程调试逻辑，其实原理也很简单，我们通过一个远程的中转 websocket 服务器，客户端不再作为 server，而是作为 client，然后 client 连接远程服务端，devtool 也连接远程服务端，devtool 发送断点调试信息给远程服务端，远程服务端将该信息透传给手机中的 v8，这样就形成了通路。</p>
<p>其实对于抖音小程序小游戏场景，其中还有一个角色是开发者工具IDE（electron)，IDE包含了chrome devtool，整体的运行流程如下：</p>
<ul>
<li>开发者开发完成，点击开发者工具的真机调试</li>
<li>开发者工具连接远程服务端，获取调试房间id，将房间id带入了二维码信息中，产生了二维码</li>
<li>带有小程序的手机扫码，获取调试房间id后连接到远程服务器的同一个房间中</li>
<li>这时候设备中的V8就可以与chrome devtool通过远程服务器的房间进行转发通信消息，也就形成了整个调试通路</li>
</ul>
<h2 data-id="heading-3">小程序 webview 调试</h2>
<p><img alt="image.png" class="lazyload" src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/55fdf39d94354e6881da4054faf033ea~tplv-k3u1fbpfcp-watermark.image" data-width="800" data-height="600" referrerpolicy="no-referrer"></p>
<p>对于小程序场景还有一个 webview 的调试，那我们也要一起支持远程调试，怎么做呢？
其实从 chrome://inspect 本身我们可以看到开了debug设置的webview本身就是可以调试的，其实我们就可以猜想到 webview 本身在手机就起了服务，因此我们只要同样连上这个服务，就可以往里面收发消息完成远程调试了。
<img alt="image.png" class="lazyload" src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e0af768e4e2442babc18270e4bf8a5f7~tplv-k3u1fbpfcp-watermark.image" data-width="800" data-height="600" referrerpolicy="no-referrer"></p>
<p>如下，chrome for android其实开启了unix domain socket。
<img alt="image.png" class="lazyload" src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9a0f24cf10f94ef9a20a564c3b6026a0~tplv-k3u1fbpfcp-watermark.image" data-width="800" data-height="600" referrerpolicy="no-referrer"></p>
<p>所以只要连接上它们就行了，然后再新增一个websocket client，将我们从原本的远程Websocket client收到的 DOM 调试信息转发给该unix domain socket，client从该unix domain socket 收到消息转发给远程服务器，最后devtool就可以收到 webview DOM的调试信息。</p>
<p>可以看到上面的示意图，相比前一节新增了一个 WebSocket client（webview）以及 Webview Unix Socket 的模块，通过它们的转发通信，我们就实现了远程调试小程序的页面元素。</p>
<h2 data-id="heading-4">V8 调试模块</h2>
<p>下述讲解 V8 调试模块接入的一些核心类，包含 v8_inspector::V8InspectorClient、v8_inspector::V8Inspector、v8_inspector::V8InspectorSession、v8_inspector::V8Inspector::Channel等，有兴趣接入 V8 调试模块业务可以作为参考，整体工作流程如下所示：
<img alt="image.png" class="lazyload" src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f0cfbaa03a254291ae3b28cc1414a515~tplv-k3u1fbpfcp-watermark.image" data-width="800" data-height="600" referrerpolicy="no-referrer">
<strong>代码示例：</strong></p>
<pre><code class="copyable">// 创建 Channel
// 需要自己实现 Channel
// class ChannelImpl final: public v8_inspector::V8Inspector::Channel
v8_inspector::V8Inspector::Channel channel_ = new ChannelImpl();
v8_inspector::StringView view( ... )

// 创建 session
// 连接 inspector 和 channel
v8_inspector::V8InspectorSession session_ = 
    inspector_.connect( 
        1, 
        channel, 
        view);

// 需要调用 contextCreated 
// 将上下文信息传入 inspector
// ctx_name 为上下文名字
v8_inspector::StringView ctx_name( /*ctx_name*/ )
inspector_->contextCreated(、
    v8_inspector::V8ContextInfo(
        context, 
        1, 
        ctx_name);
<span class="copy-code-btn">复制代码</span></code></pre>
<h3 data-id="heading-5">v8_inspector::V8InspectorClient</h3>
<pre><code class="copyable">class V8_EXPORT V8InspectorClient &#123;
 public:
  virtual ~V8InspectorClient() = default;

  virtual void runMessageLoopOnPause(int contextGroupId) &#123;&#125;
  virtual void quitMessageLoopOnPause() &#123;&#125;
&#125;;
<span class="copy-code-btn">复制代码</span></code></pre>
<p>这个类我们主要需要实现两个函数，一个是runMessageLoopOnPause，一个是quitMessageLoopOnPause</p>
<ul>
<li>runMessageLoopOnPause</li>
</ul>
<p>在断点的时候，v8 会触发 runMessageLoopOnPause，这时候需要接入方同步的消费所有来源于 devtool 消息（消费即传入 v8 驱动运行），我们需要开启自己的messageLoop去消费消息，否则会导致丢失所有 devtool 发来的消息的作用，现象就是拿不到上下文信息，console 控制台将无效没有反应</p>
<ul>
<li>quitMessageLoopOnPause</li>
</ul>
<p>将结束断点的时候，就会自动触发 quitMessageLoopOnPause，这时候我们可以停止 MessageLoop，不需要再继续进行同步地消费消息了</p>
<h3 data-id="heading-6">v8_inspector::V8Inspector</h3>
<p>这个类构造时需要传入两个参数，一个是isolate，一个是上述我们所讲的V8InspectorClient实例，首先需要说的是，一个v8Inspector对应一个isolate，一个isolate下有多个context，因此其实一个inspector可以调试多个context。</p>
<pre><code class="copyable">v8_inspector::V8Inspector::Channel
// Connection.
  class V8_EXPORT Channel &#123;
   public:
    virtual ~Channel() = default;
    virtual void sendResponse(int callId,
                              std::unique_ptr<StringBuffer> message) = 0;
    virtual void sendNotification(std::unique_ptr<StringBuffer> message) = 0;
    virtual void flushProtocolNotifications() = 0;
 &#125;;
<span class="copy-code-btn">复制代码</span></code></pre>
<p>channel是跟v8inspector的通道，可以获取到v8内部产生的协议消息，需要做的事情就将它转发给 devtool，主要需要实现sendResponse和sendNotification，其实很简单直接将消息转发给devtool就行了</p>
<pre><code class="copyable">void sendResponse(int callId, std::unique_ptr<v8_inspector::StringBuffer> message) override &#123;
    sendToDevtool(message->string());
&#125;
void sendNotification(std::unique_ptr<v8_inspector::StringBuffer> message) override &#123;
    sendToDevtool(message->string());
&#125;
<span class="copy-code-btn">复制代码</span></code></pre>
<h3 data-id="heading-7">v8_inspector::V8InspectorSession</h3>
<p>通过连接channel和inspect产生调试session，这个session主要用来接收devtool传来的消息，然后将消息通过方法dispatchProtocolMessage 可以将协议消息传给v8，从而驱动v8断点等行为，然后v8会调用channel方法再将内部协议消息传达出来，整个链路就走通了。</p>
<pre><code class="copyable">std::unique_ptr<StringBuffer> &str = messages.front();
session->dispatchProtocolMessage(str->string());
<span class="copy-code-btn">复制代码</span></code></pre>
<h2 data-id="heading-8">参考资料</h2>
<ul>
<li><a href="https://v8.dev/docs/inspector" target="_blank" rel="nofollow noopener noreferrer">v8.dev/docs/inspec…</a></li>
<li><a href="https://chromedevtools.github.io/devtools-protocol/" target="_blank" rel="nofollow noopener noreferrer">chromedevtools.github.io/devtools-pr…</a></li>
<li><a href="https://medium.com/@hyperandroid/v8-inspector-from-an-embedder-standpoint-7f9c0472e2b7" target="_blank" rel="nofollow noopener noreferrer">medium.com/@hyperandro…</a></li>
</ul></div> <div class="image-viewer-box" data-v-78c9b824><!----></div>  
</div>
            