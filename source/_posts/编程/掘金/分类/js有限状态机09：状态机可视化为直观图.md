
---
title: 'js有限状态机09：状态机可视化为直观图'
categories: 
 - 编程
 - 掘金
 - 分类
headimg: 'https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/12eeb71a98b54a2790524d858efa9b5f~tplv-k3u1fbpfcp-watermark.image'
author: 掘金
comments: false
date: Tue, 08 Jun 2021 18:17:17 GMT
thumbnail: 'https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/12eeb71a98b54a2790524d858efa9b5f~tplv-k3u1fbpfcp-watermark.image'
---

<div>   
<div class="markdown-body"><style>.markdown-body&#123;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333&#125;.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6&#123;line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px&#125;.markdown-body h1&#123;font-size:30px;margin-bottom:5px&#125;.markdown-body h2&#123;padding-bottom:12px;font-size:24px;border-bottom:1px solid #ececec&#125;.markdown-body h3&#123;font-size:18px;padding-bottom:0&#125;.markdown-body h4&#123;font-size:16px&#125;.markdown-body h5&#123;font-size:15px&#125;.markdown-body h6&#123;margin-top:5px&#125;.markdown-body p&#123;line-height:inherit;margin-top:22px;margin-bottom:22px&#125;.markdown-body img&#123;max-width:100%&#125;.markdown-body hr&#123;border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px&#125;.markdown-body code&#123;word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em&#125;.markdown-body code,.markdown-body pre&#123;font-family:Menlo,Monaco,Consolas,Courier New,monospace&#125;.markdown-body pre&#123;overflow:auto;position:relative;line-height:1.75&#125;.markdown-body pre>code&#123;font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8&#125;.markdown-body a&#123;text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff&#125;.markdown-body a:active,.markdown-body a:hover&#123;color:#275b8c&#125;.markdown-body table&#123;display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6&#125;.markdown-body thead&#123;background:#f6f6f6;color:#000;text-align:left&#125;.markdown-body tr:nth-child(2n)&#123;background-color:#fcfcfc&#125;.markdown-body td,.markdown-body th&#123;padding:12px 7px;line-height:24px&#125;.markdown-body td&#123;min-width:120px&#125;.markdown-body blockquote&#123;color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8&#125;.markdown-body blockquote:after&#123;display:block;content:""&#125;.markdown-body blockquote>p&#123;margin:10px 0&#125;.markdown-body ol,.markdown-body ul&#123;padding-left:28px&#125;.markdown-body ol li,.markdown-body ul li&#123;margin-bottom:0;list-style:inherit&#125;.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item&#123;list-style:none&#125;.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul&#123;margin-top:0&#125;.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul&#123;margin-top:3px&#125;.markdown-body ol li&#123;padding-left:6px&#125;.markdown-body .contains-task-list&#123;padding-left:0&#125;.markdown-body .task-list-item&#123;list-style:none&#125;@media (max-width:720px)&#123;.markdown-body h1&#123;font-size:24px&#125;.markdown-body h2&#123;font-size:20px&#125;.markdown-body h3&#123;font-size:18px&#125;&#125;</style><p>将状态机可视化为直观图是非常有用的。可以通过开源库<a href="http://www.graphviz.org/" target="_blank" rel="nofollow noopener noreferrer">GraphViz</a>来实现，我们使用<code>visualize</code>方法将状态机配置转换为GraphViz使用的<code>.dot</code>语言：</p>
<pre><code class="hljs language-javascript copyable" lang="javascript">  <span class="hljs-keyword">var</span> visualize = <span class="hljs-built_in">require</span>(<span class="hljs-string">'javascript-state-machine/lib/visualize'</span>);

  <span class="hljs-keyword">var</span> fsm = <span class="hljs-keyword">new</span> StateMachine(&#123;
    <span class="hljs-attr">init</span>: <span class="hljs-string">'open'</span>,
    <span class="hljs-attr">transitions</span>: [
      &#123; <span class="hljs-attr">name</span>: <span class="hljs-string">'close'</span>, <span class="hljs-attr">from</span>: <span class="hljs-string">'open'</span>,   <span class="hljs-attr">to</span>: <span class="hljs-string">'closed'</span> &#125;,
      &#123; <span class="hljs-attr">name</span>: <span class="hljs-string">'open'</span>,  <span class="hljs-attr">from</span>: <span class="hljs-string">'closed'</span>, <span class="hljs-attr">to</span>: <span class="hljs-string">'open'</span>   &#125;
    ]
  &#125;);

  visualize(fsm)
<span class="copy-code-btn">复制代码</span></code></pre>
<p>生成以下.dot语法：</p>
<pre><code class="hljs language-dot copyable" lang="dot">  digraph "fsm" &#123;
    "closed";
    "open";
    "closed" -> "open" [ label=" open " ];
    "open" -> "closed" [ label=" close " ];
  &#125;
<span class="copy-code-btn">复制代码</span></code></pre>
<p>GraphViz显示为：</p>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/12eeb71a98b54a2790524d858efa9b5f~tplv-k3u1fbpfcp-watermark.image" alt="image.png" loading="lazy" referrerpolicy="no-referrer"></p>
<h2 data-id="heading-0">增强可视化</h2>
<p>你可以在转换动作中添加<code>dot</code>属性，并声明一个 <code>orientation</code>(可选)，自定义生成的<code>.dot</code>输出来实现图形可视化：</p>
<pre><code class="hljs language-javascript copyable" lang="javascript">  <span class="hljs-keyword">var</span> fsm = <span class="hljs-keyword">new</span> StateMachine(&#123;
    <span class="hljs-attr">init</span>: <span class="hljs-string">'closed'</span>,
    <span class="hljs-attr">transitions</span>: [
      &#123; <span class="hljs-attr">name</span>: <span class="hljs-string">'open'</span>,  <span class="hljs-attr">from</span>: <span class="hljs-string">'closed'</span>, <span class="hljs-attr">to</span>: <span class="hljs-string">'open'</span>,   <span class="hljs-attr">dot</span>: &#123; <span class="hljs-attr">color</span>: <span class="hljs-string">'blue'</span>, <span class="hljs-attr">headport</span>: <span class="hljs-string">'n'</span>, <span class="hljs-attr">tailport</span>: <span class="hljs-string">'n'</span> &#125; &#125;,
      &#123; <span class="hljs-attr">name</span>: <span class="hljs-string">'close'</span>, <span class="hljs-attr">from</span>: <span class="hljs-string">'open'</span>,   <span class="hljs-attr">to</span>: <span class="hljs-string">'closed'</span>, <span class="hljs-attr">dot</span>: &#123; <span class="hljs-attr">color</span>: <span class="hljs-string">'red'</span>,  <span class="hljs-attr">headport</span>: <span class="hljs-string">'s'</span>, <span class="hljs-attr">tailport</span>: <span class="hljs-string">'s'</span> &#125; &#125;
    ]
  &#125;);
  visualize(fsm, &#123; <span class="hljs-attr">name</span>: <span class="hljs-string">'door'</span>, <span class="hljs-attr">orientation</span>: <span class="hljs-string">'horizontal'</span> &#125;);
<span class="copy-code-btn">复制代码</span></code></pre>
<p>生成以下(增强后的)<code>.dot</code>语法:</p>
<pre><code class="hljs language-dot copyable" lang="dot">  digraph "door" &#123;
    rankdir=LR;
    "closed";
    "open";
    "closed" -> "open" [ color="blue" ; headport="n" ; label=" open " ; tailport="n" ];
    "open" -> "closed" [ color="red" ; headport="s" ; label=" close " ; tailport="s" ];
  &#125;
<span class="copy-code-btn">复制代码</span></code></pre>
<p>GraphViz视图为:</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9baf54b6e46e45c68e1c9b87e652c823~tplv-k3u1fbpfcp-watermark.image" alt="image.png" loading="lazy" referrerpolicy="no-referrer"></p>
<h2 data-id="heading-1">状态机工厂的可视化</h2>
<p>你可以使用相同的<code>visualize</code>方法来为状态机工厂生成<code>.dot</code>:</p>
<pre><code class="hljs language-javascript copyable" lang="javascript">  <span class="hljs-keyword">var</span> Matter = StateMachine.factory(&#123;
    <span class="hljs-attr">init</span>: <span class="hljs-string">'solid'</span>,
    <span class="hljs-attr">transitions</span>: [
      &#123; <span class="hljs-attr">name</span>: <span class="hljs-string">'melt'</span>,     <span class="hljs-attr">from</span>: <span class="hljs-string">'solid'</span>,  <span class="hljs-attr">to</span>: <span class="hljs-string">'liquid'</span>, <span class="hljs-attr">dot</span>: &#123; <span class="hljs-attr">headport</span>: <span class="hljs-string">'nw'</span> &#125; &#125;,
      &#123; <span class="hljs-attr">name</span>: <span class="hljs-string">'freeze'</span>,   <span class="hljs-attr">from</span>: <span class="hljs-string">'liquid'</span>, <span class="hljs-attr">to</span>: <span class="hljs-string">'solid'</span>,  <span class="hljs-attr">dot</span>: &#123; <span class="hljs-attr">headport</span>: <span class="hljs-string">'se'</span> &#125; &#125;,
      &#123; <span class="hljs-attr">name</span>: <span class="hljs-string">'vaporize'</span>, <span class="hljs-attr">from</span>: <span class="hljs-string">'liquid'</span>, <span class="hljs-attr">to</span>: <span class="hljs-string">'gas'</span>,    <span class="hljs-attr">dot</span>: &#123; <span class="hljs-attr">headport</span>: <span class="hljs-string">'nw'</span> &#125; &#125;,
      &#123; <span class="hljs-attr">name</span>: <span class="hljs-string">'condense'</span>, <span class="hljs-attr">from</span>: <span class="hljs-string">'gas'</span>,    <span class="hljs-attr">to</span>: <span class="hljs-string">'liquid'</span>, <span class="hljs-attr">dot</span>: &#123; <span class="hljs-attr">headport</span>: <span class="hljs-string">'se'</span> &#125; &#125;
    ]
  &#125;);

  visualize(Matter, &#123; <span class="hljs-attr">name</span>: <span class="hljs-string">'matter'</span>, <span class="hljs-attr">orientation</span>: <span class="hljs-string">'horizontal'</span> &#125;)
<span class="copy-code-btn">复制代码</span></code></pre>
<p>生成如下.dot语法:</p>
<pre><code class="hljs language-dot copyable" lang="dot">  digraph "matter" &#123;
    rankdir=LR;
    "solid";
    "liquid";
    "gas";
    "solid" -> "liquid" [ headport="nw" ; label=" melt " ];
    "liquid" -> "solid" [ headport="se" ; label=" freeze " ];
    "liquid" -> "gas" [ headport="nw" ; label=" vaporize " ];
    "gas" -> "liquid" [ headport="se" ; label=" condense " ];
  &#125;
<span class="copy-code-btn">复制代码</span></code></pre>
<p>GraphViz视图为:</p>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9d22b3ed3e5841b5b2ae0bf971b2d702~tplv-k3u1fbpfcp-watermark.image" alt="image.png" loading="lazy" referrerpolicy="no-referrer"></p>
<h2 data-id="heading-2">其它示例</h2>
<pre><code class="hljs language-javascript copyable" lang="javascript">  <span class="hljs-keyword">var</span> Wizard = StateMachine.factory(&#123;
    <span class="hljs-attr">init</span>: <span class="hljs-string">'A'</span>,
    <span class="hljs-attr">transitions</span>: [
      &#123; <span class="hljs-attr">name</span>: <span class="hljs-string">'step'</span>,  <span class="hljs-attr">from</span>: <span class="hljs-string">'A'</span>,               <span class="hljs-attr">to</span>: <span class="hljs-string">'B'</span>, <span class="hljs-attr">dot</span>: &#123; <span class="hljs-attr">headport</span>: <span class="hljs-string">'w'</span>,  <span class="hljs-attr">tailport</span>: <span class="hljs-string">'ne'</span> &#125; &#125;,
      &#123; <span class="hljs-attr">name</span>: <span class="hljs-string">'step'</span>,  <span class="hljs-attr">from</span>: <span class="hljs-string">'B'</span>,               <span class="hljs-attr">to</span>: <span class="hljs-string">'C'</span>, <span class="hljs-attr">dot</span>: &#123; <span class="hljs-attr">headport</span>: <span class="hljs-string">'w'</span>,  <span class="hljs-attr">tailport</span>: <span class="hljs-string">'e'</span> &#125; &#125;,
      &#123; <span class="hljs-attr">name</span>: <span class="hljs-string">'step'</span>,  <span class="hljs-attr">from</span>: <span class="hljs-string">'C'</span>,               <span class="hljs-attr">to</span>: <span class="hljs-string">'D'</span>, <span class="hljs-attr">dot</span>: &#123; <span class="hljs-attr">headport</span>: <span class="hljs-string">'w'</span>,  <span class="hljs-attr">tailport</span>: <span class="hljs-string">'e'</span> &#125; &#125;,
      &#123; <span class="hljs-attr">name</span>: <span class="hljs-string">'reset'</span>, <span class="hljs-attr">from</span>: [ <span class="hljs-string">'B'</span>, <span class="hljs-string">'C'</span>, <span class="hljs-string">'D'</span> ], <span class="hljs-attr">to</span>: <span class="hljs-string">'A'</span>, <span class="hljs-attr">dot</span>: &#123; <span class="hljs-attr">headport</span>: <span class="hljs-string">'se'</span>, <span class="hljs-attr">tailport</span>: <span class="hljs-string">'s'</span> &#125; &#125;
    ]
  &#125;);

  visualize(Wizard, &#123; <span class="hljs-attr">orientation</span>: <span class="hljs-string">'horizontal'</span> &#125;)
<span class="copy-code-btn">复制代码</span></code></pre>
<p>生成:</p>
<pre><code class="hljs language-dot copyable" lang="dot">  digraph "wizard" &#123;
    rankdir=LR;
    "A";
    "B";
    "C";
    "D";
    "A" -> "B" [ headport="w" ; label=" step " ; tailport="ne" ];
    "B" -> "C" [ headport="w" ; label=" step " ; tailport="e" ];
    "C" -> "D" [ headport="w" ; label=" step " ; tailport="e" ];
    "B" -> "A" [ headport="se" ; label=" reset " ; tailport="s" ];
    "C" -> "A" [ headport="se" ; label=" reset " ; tailport="s" ];
    "D" -> "A" [ headport="se" ; label=" reset " ; tailport="s" ];
  &#125;
<span class="copy-code-btn">复制代码</span></code></pre>
<p>视图:</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2b18007dae5b4105afaad0fd35b83e11~tplv-k3u1fbpfcp-watermark.image" alt="image.png" loading="lazy" referrerpolicy="no-referrer"></p>
<pre><code class="hljs language-javascript copyable" lang="javascript">  <span class="hljs-keyword">var</span> ATM = StateMachine.factory(&#123;
    <span class="hljs-attr">init</span>: <span class="hljs-string">'ready'</span>,
    <span class="hljs-attr">transitions</span>: [
      &#123; <span class="hljs-attr">name</span>: <span class="hljs-string">'insert-card'</span>, <span class="hljs-attr">from</span>: <span class="hljs-string">'ready'</span>,              <span class="hljs-attr">to</span>: <span class="hljs-string">'pin'</span>                &#125;,
      &#123; <span class="hljs-attr">name</span>: <span class="hljs-string">'confirm'</span>,     <span class="hljs-attr">from</span>: <span class="hljs-string">'pin'</span>,                <span class="hljs-attr">to</span>: <span class="hljs-string">'action'</span>             &#125;,
      &#123; <span class="hljs-attr">name</span>: <span class="hljs-string">'reject'</span>,      <span class="hljs-attr">from</span>: <span class="hljs-string">'pin'</span>,                <span class="hljs-attr">to</span>: <span class="hljs-string">'return-card'</span>        &#125;,
      &#123; <span class="hljs-attr">name</span>: <span class="hljs-string">'withdraw'</span>,    <span class="hljs-attr">from</span>: <span class="hljs-string">'return-card'</span>,        <span class="hljs-attr">to</span>: <span class="hljs-string">'ready'</span>              &#125;,

      &#123; <span class="hljs-attr">name</span>: <span class="hljs-string">'deposit'</span>,     <span class="hljs-attr">from</span>: <span class="hljs-string">'action'</span>,             <span class="hljs-attr">to</span>: <span class="hljs-string">'deposit-account'</span>    &#125;,
      &#123; <span class="hljs-attr">name</span>: <span class="hljs-string">'provide'</span>,     <span class="hljs-attr">from</span>: <span class="hljs-string">'deposit-account'</span>,    <span class="hljs-attr">to</span>: <span class="hljs-string">'deposit-amount'</span>     &#125;,
      &#123; <span class="hljs-attr">name</span>: <span class="hljs-string">'provide'</span>,     <span class="hljs-attr">from</span>: <span class="hljs-string">'deposit-amount'</span>,     <span class="hljs-attr">to</span>: <span class="hljs-string">'confirm-deposit'</span>    &#125;,
      &#123; <span class="hljs-attr">name</span>: <span class="hljs-string">'confirm'</span>,     <span class="hljs-attr">from</span>: <span class="hljs-string">'confirm-deposit'</span>,    <span class="hljs-attr">to</span>: <span class="hljs-string">'collect-envelope'</span>   &#125;,
      &#123; <span class="hljs-attr">name</span>: <span class="hljs-string">'provide'</span>,     <span class="hljs-attr">from</span>: <span class="hljs-string">'collect-envelope'</span>,   <span class="hljs-attr">to</span>: <span class="hljs-string">'continue'</span>           &#125;,

      &#123; <span class="hljs-attr">name</span>: <span class="hljs-string">'withdraw'</span>,    <span class="hljs-attr">from</span>: <span class="hljs-string">'action'</span>,             <span class="hljs-attr">to</span>: <span class="hljs-string">'withdrawal-account'</span> &#125;,
      &#123; <span class="hljs-attr">name</span>: <span class="hljs-string">'provide'</span>,     <span class="hljs-attr">from</span>: <span class="hljs-string">'withdrawal-account'</span>, <span class="hljs-attr">to</span>: <span class="hljs-string">'withdrawal-amount'</span>  &#125;,
      &#123; <span class="hljs-attr">name</span>: <span class="hljs-string">'provide'</span>,     <span class="hljs-attr">from</span>: <span class="hljs-string">'withdrawal-amount'</span>,  <span class="hljs-attr">to</span>: <span class="hljs-string">'confirm-withdrawal'</span> &#125;,
      &#123; <span class="hljs-attr">name</span>: <span class="hljs-string">'confirm'</span>,     <span class="hljs-attr">from</span>: <span class="hljs-string">'confirm-withdrawal'</span>, <span class="hljs-attr">to</span>: <span class="hljs-string">'dispense-cash'</span>      &#125;,
      &#123; <span class="hljs-attr">name</span>: <span class="hljs-string">'withdraw'</span>,    <span class="hljs-attr">from</span>: <span class="hljs-string">'dispense-cash'</span>,      <span class="hljs-attr">to</span>: <span class="hljs-string">'continue'</span>           &#125;,

      &#123; <span class="hljs-attr">name</span>: <span class="hljs-string">'continue'</span>,    <span class="hljs-attr">from</span>: <span class="hljs-string">'continue'</span>,           <span class="hljs-attr">to</span>: <span class="hljs-string">'action'</span>             &#125;,
      &#123; <span class="hljs-attr">name</span>: <span class="hljs-string">'finish'</span>,      <span class="hljs-attr">from</span>: <span class="hljs-string">'continue'</span>,           <span class="hljs-attr">to</span>: <span class="hljs-string">'return-card'</span>        &#125;
    ]
  &#125;)

  visualize(ATM)
<span class="copy-code-btn">复制代码</span></code></pre>
<p>生成:</p>
<pre><code class="hljs language-dot copyable" lang="dot">  digraph "ATM" &#123;
    "ready";
    "pin";
    "action";
    "return-card";
    "deposit-account";
    "deposit-amount";
    "confirm-deposit";
    "collect-envelope";
    "continue";
    "withdrawal-account";
    "withdrawal-amount";
    "confirm-withdrawal";
    "dispense-cash";
    "ready" -> "pin" [ label=" insert-card " ];
    "pin" -> "action" [ label=" confirm " ];
    "pin" -> "return-card" [ label=" reject " ];
    "return-card" -> "ready" [ label=" withdraw " ];
    "action" -> "deposit-account" [ label=" deposit " ];
    "deposit-account" -> "deposit-amount" [ label=" provide " ];
    "deposit-amount" -> "confirm-deposit" [ label=" provide " ];
    "confirm-deposit" -> "collect-envelope" [ label=" confirm " ];
    "collect-envelope" -> "continue" [ label=" provide " ];
    "action" -> "withdrawal-account" [ label=" withdraw " ];
    "withdrawal-account" -> "withdrawal-amount" [ label=" provide " ];
    "withdrawal-amount" -> "confirm-withdrawal" [ label=" provide " ];
    "confirm-withdrawal" -> "dispense-cash" [ label=" confirm " ];
    "dispense-cash" -> "continue" [ label=" withdraw " ];
    "continue" -> "action" [ label=" continue " ];
    "continue" -> "return-card" [ label=" finish " ];
  &#125;
<span class="copy-code-btn">复制代码</span></code></pre>
<p>视图:</p>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a85d57debef74b22ae7e8db51f82659c~tplv-k3u1fbpfcp-watermark.image" alt="image.png" loading="lazy" referrerpolicy="no-referrer"></p></div>  
</div>
            