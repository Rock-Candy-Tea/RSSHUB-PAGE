
---
title: 'è®°ä¸€æ¬¡å¼‚æ­¥åŠ è½½çš„å®ç°-å‘å¸ƒè®¢é˜…æ¨¡å¼çš„å®é™…è¿ç”¨'
categories: 
 - ç¼–ç¨‹
 - æ˜é‡‘
 - åˆ†ç±»
headimg: 'https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e2d9a29a2869401d8f0fdd54fc6c2feb~tplv-k3u1fbpfcp-watermark.image'
author: æ˜é‡‘
comments: false
date: Thu, 01 Jul 2021 05:26:25 GMT
thumbnail: 'https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e2d9a29a2869401d8f0fdd54fc6c2feb~tplv-k3u1fbpfcp-watermark.image'
---

<div>   
<div class="markdown-body"><style>.markdown-body&#123;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333&#125;.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6&#123;line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px&#125;.markdown-body h1&#123;font-size:30px;margin-bottom:5px&#125;.markdown-body h2&#123;padding-bottom:12px;font-size:24px;border-bottom:1px solid #ececec&#125;.markdown-body h3&#123;font-size:18px;padding-bottom:0&#125;.markdown-body h4&#123;font-size:16px&#125;.markdown-body h5&#123;font-size:15px&#125;.markdown-body h6&#123;margin-top:5px&#125;.markdown-body p&#123;line-height:inherit;margin-top:22px;margin-bottom:22px&#125;.markdown-body img&#123;max-width:100%&#125;.markdown-body hr&#123;border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px&#125;.markdown-body code&#123;word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em&#125;.markdown-body code,.markdown-body pre&#123;font-family:Menlo,Monaco,Consolas,Courier New,monospace&#125;.markdown-body pre&#123;overflow:auto;position:relative;line-height:1.75&#125;.markdown-body pre>code&#123;font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8&#125;.markdown-body a&#123;text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff&#125;.markdown-body a:active,.markdown-body a:hover&#123;color:#275b8c&#125;.markdown-body table&#123;display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6&#125;.markdown-body thead&#123;background:#f6f6f6;color:#000;text-align:left&#125;.markdown-body tr:nth-child(2n)&#123;background-color:#fcfcfc&#125;.markdown-body td,.markdown-body th&#123;padding:12px 7px;line-height:24px&#125;.markdown-body td&#123;min-width:120px&#125;.markdown-body blockquote&#123;color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8&#125;.markdown-body blockquote:after&#123;display:block;content:""&#125;.markdown-body blockquote>p&#123;margin:10px 0&#125;.markdown-body ol,.markdown-body ul&#123;padding-left:28px&#125;.markdown-body ol li,.markdown-body ul li&#123;margin-bottom:0;list-style:inherit&#125;.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item&#123;list-style:none&#125;.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul&#123;margin-top:0&#125;.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul&#123;margin-top:3px&#125;.markdown-body ol li&#123;padding-left:6px&#125;.markdown-body .contains-task-list&#123;padding-left:0&#125;.markdown-body .task-list-item&#123;list-style:none&#125;@media (max-width:720px)&#123;.markdown-body h1&#123;font-size:24px&#125;.markdown-body h2&#123;font-size:20px&#125;.markdown-body h3&#123;font-size:18px&#125;&#125;</style><h1 data-id="heading-0">1ã€é—®é¢˜èµ·å› </h1>
<p>ç”±äºå›¢é˜Ÿä½¿ç”¨çš„Ajaxè¯·æ±‚åº“æ˜¯è‡ªå·±åœ¨HTML5æä¾›çš„fetch APIçš„ä¸€å±‚å°è£…ï¼ˆåæ–‡ç®€ç§°sdkï¼‰ï¼Œå…¶ä¸­åŒ…è£¹äº†è®¸å¤šä¸šåŠ¡å‚æ•°ï¼Œç›´æ¥è°ƒç”¨è¿™ä¸ªsdkå¯ä»¥çœæ—¶çœåŠ›é¿å…å› å…¶ä»–å› ç´ è€Œäº§ç”Ÿä¸ç¡®å®šçš„bugã€‚ä½†æ˜¯sdkæœ‰ä¸ªå¾ˆä¸æ–¹ä¾¿çš„ç‰¹ç‚¹å°±æ˜¯åªèƒ½å½“å®ƒè°ƒç”¨äº†ä¸šåŠ¡åˆå§‹åŒ–æ¥å£è·å¾—å“åº”å†…å®¹ç»“æœä¹‹åæ‰èƒ½æ­£å¸¸å·¥ä½œã€‚å‡è®¾æˆ‘ä»¬åœ¨é¡µé¢ä¸­æœ‰ä¸ªæ¥å£å¿…é¡»è¦ç­‰åˆ°sdkåˆå§‹åŒ–æ‰§è¡Œï¼Œå¦‚æœè¿™ä¸ªåˆå§‹åŒ–æ¥å£æ‰§è¡Œå¤±è´¥ï¼Œæ•´ä¸ªé¡µé¢å°†æ— æ³•å‘ˆç°ï¼Œå°±æ²¡æœ‰åè¯äº†ã€‚å› æ­¤ï¼Œæˆ‘ä»¬æ˜¯å¯ä»¥è®¤å®šï¼Œsdkåˆå§‹åŒ–æ¥å£ä¸€å®šå¯ä»¥è¯·æ±‚æˆåŠŸï¼Œè¿™æ˜¯æˆ‘ä»¬å¯¹sdkè¿›è¡Œæ”¹é€ çš„å‰æã€‚</p>
<p>ç”±äºå­˜åœ¨è¿™æ ·çš„ä¸€ä¸ªé™åˆ¶ï¼Œå‡è®¾æœ‰ä¸ªæ•°æ®è¯·æ±‚æ¥å£å¿…é¡»è¦åœ¨é¡µé¢åˆå§‹åŒ–ä¹‹åå°±ç«‹å³åŠ è½½ï¼Œæ­¤æ—¶å°±ä¼šå­˜åœ¨é—®é¢˜ï¼Œæ— æ³•ç¡®å®šsdkæ˜¯å¦åˆå§‹åŒ–ã€‚ä¹‹å‰åŒäº‹çš„è§£å†³åŠæ³•æ˜¯å°†æ¥å£å…¨éƒ¨å†™åœ¨è·Ÿåˆå§‹åŒ–å¹³çº§çš„ç•Œé¢é‡Œï¼Œç„¶ååœ¨è¿™ä¸ªç•Œé¢é‡Œé¢æ¥æ”¶æ¥è‡ªç»„ä»¶çš„å„ç§æŒ‡ä»¤ï¼Œè·å–æ•°æ®ä¼ å…¥åˆ°ç»„ä»¶ä¸­ï¼Œä½†æ˜¯ä½¿ç”¨è¿‡ç¨‹ä¸­æ„Ÿè§‰ç‰¹åˆ«éº»çƒ¦ã€‚<strong>æ¯æ¬¡æ–°å¢ä¸šåŠ¡é€»è¾‘å¯èƒ½éƒ½éœ€è¦æ”¹é¡µé¢çº§å†…å®¹ï¼Œæ ¹æ®ç»„ä»¶æ‹†åˆ†çš„åŸåˆ™ï¼Œæœ¬æ¥é¡µé¢çº§ä¹Ÿä¸åº”è¯¥è´Ÿè´£è¿™äº›ç»„ä»¶æ•°æ®çš„è¯·æ±‚ï¼Œè¿èƒŒäº†å•ä¸€èŒè´£çš„åŸåˆ™</strong>ã€‚<strong>æ›´ä»¤äººå¤´ç–¼çš„äº‹ï¼Œå‡è®¾æœ‰é¢†åˆ¸è¿™ç±»ç­‰æ“ä½œå½“ç”¨æˆ·å‘èµ·ç‚¹å‡»æ“ä½œéœ€è¦ç¦ç”¨é¢†åˆ¸æŒ‰é’®ï¼Œç­‰è¯·æ±‚æ‰§è¡Œå®Œæˆä¹‹åå†è§£å†»çš„éœ€æ±‚ï¼Œè¿™ç§åœºæ™¯æ„Ÿè§‰å®Œå…¨æ— èƒ½ä¸ºåŠ›äº†</strong>ã€‚å› æ­¤æˆ‘æ€è€ƒç€å¦‚ä½•æ‰©å±•è¿™ä¸ªsdkèƒ½åŠ›æå‡å¼€å‘ä½“éªŒä¸”æ”¹è¿›ä»£ç è´¨é‡ã€‚</p>
<h1 data-id="heading-1">2ã€å¼€å§‹</h1>
<p>ç”±äºsdkæºç ä¸ä¾¿äºè´´å‡ºï¼Œæˆ‘ä»¬ä½¿ç”¨ä»¥ä¸‹ä»£ç æ¨¡æ‹Ÿè¿™ä¸ªåœºæ™¯ï¼š</p>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-keyword">import</span> axios, &#123; AxiosInstance &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">'axios'</span>;
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Request</span> </span>&#123;
    <span class="hljs-comment">/** <span class="hljs-doctag">@type <span class="hljs-type">&#123; AxiosInstance &#125;</span> </span>*/</span>
    request = <span class="hljs-literal">null</span>
    <span class="hljs-function"><span class="hljs-title">constructor</span>(<span class="hljs-params"></span>)</span> &#123;
        <span class="hljs-built_in">this</span>.timeout = <span class="hljs-number">3000</span>;
    &#125;
    <span class="hljs-function"><span class="hljs-title">initialize</span>(<span class="hljs-params"></span>)</span> &#123;
        <span class="hljs-built_in">this</span>.request = axios.create(&#123;
            <span class="hljs-attr">baseURL</span>: <span class="hljs-string">'/'</span>,
            <span class="hljs-attr">timeout</span>: <span class="hljs-built_in">this</span>.timeout
        &#125;)
    &#125;
    <span class="hljs-function"><span class="hljs-title">post</span>(<span class="hljs-params"></span>)</span> &#123;
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.request.post.apply(<span class="hljs-built_in">this</span>, <span class="hljs-built_in">arguments</span>)
    &#125;

&#125;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">new</span> Request()
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<p>å¯ä»¥çœ‹å‡ºï¼Œåœ¨è°ƒç”¨initializeæ–¹æ³•ä¹‹å‰è°ƒç”¨postæ–¹æ³•ï¼Œrequestå˜é‡è¿˜ä¸å­˜åœ¨ä½¿ç”¨ä¼šæŠ¥é”™ã€‚</p>
<h2 data-id="heading-2">2.1ã€ æœ€åˆçš„æ¢¦æƒ³</h2>
<p>æˆ‘ä»¬çš„æ€è€ƒæ–¹å‘æ˜¯ï¼Œsdkå†…éƒ¨å­˜åœ¨ä¸€ä¸ªè¯·æ±‚é˜Ÿåˆ—ï¼Œå½“æ‰§è¡Œpostæ–¹æ³•çš„æ—¶å€™ï¼Œrequestå®ä¾‹å¦‚æœæ²¡æœ‰åˆå§‹åŒ–ï¼Œæˆ‘ä»¬å…ˆå°†å…¶åŠ å…¥åˆ°è¯·æ±‚é˜Ÿåˆ—é‡Œï¼Œå½“requeståˆå§‹åŒ–ä»¥åï¼Œæˆ‘ä»¬å†å°†è¿™ä¸ªé˜Ÿåˆ—è¿‡ä¸€éå³å¯ã€‚
å¥½ï¼Œå¼€å§‹æ”¹é€ Requestç±»:</p>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Request</span> </span>&#123;
    <span class="hljs-comment">/** <span class="hljs-doctag">@type <span class="hljs-type">&#123; AxiosInstance &#125;</span> </span>*/</span>
    request = <span class="hljs-literal">null</span>

    <span class="hljs-function"><span class="hljs-title">constructor</span>(<span class="hljs-params"></span>)</span> &#123;
        <span class="hljs-built_in">this</span>.timeout = <span class="hljs-number">3000</span>;
        <span class="hljs-comment">// å¢åŠ ç¼“å­˜æ‰§è¡Œé˜Ÿåˆ—</span>
        <span class="hljs-built_in">this</span>.requestQueues = [];
    &#125;
    <span class="hljs-function"><span class="hljs-title">initialize</span>(<span class="hljs-params"></span>)</span> &#123;
        <span class="hljs-built_in">this</span>.request = axios.create(&#123;
            <span class="hljs-attr">baseURL</span>: <span class="hljs-string">'/'</span>,
            <span class="hljs-attr">timeout</span>: <span class="hljs-built_in">this</span>.timeout
        &#125;)
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"this request lib has been initialized!"</span>)
        <span class="hljs-comment">// å¦‚æœå½“å‰æœ‰ç¼“å­˜é˜Ÿåˆ—ï¼Œæ¸…æ¥šç¼“å­˜é˜Ÿåˆ—</span>
        <span class="hljs-keyword">while</span> (<span class="hljs-built_in">this</span>.requestQueues.length > <span class="hljs-number">0</span>) &#123;
            <span class="hljs-keyword">let</span> execute = <span class="hljs-built_in">this</span>.requestQueues.pop()
            <span class="hljs-keyword">typeof</span> execute === <span class="hljs-string">'function'</span> && execute();
        &#125;
    &#125;
    <span class="hljs-function"><span class="hljs-title">post</span>(<span class="hljs-params"></span>)</span> &#123;
        <span class="hljs-keyword">var</span> args = <span class="hljs-built_in">arguments</span>;
        <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">this</span>.request) &#123;

            <span class="hljs-keyword">const</span> callback = <span class="hljs-function">() =></span> &#123;
                <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.request.post.apply(<span class="hljs-built_in">this</span>, args);
            &#125;
            <span class="hljs-comment">// å°†æ‰§è¡Œå‡½æ•°åŠ å…¥é˜Ÿåˆ—</span>
            <span class="hljs-built_in">this</span>.requestQueues.push(callback)
            <span class="hljs-keyword">return</span>
        &#125;
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.request.post.apply(<span class="hljs-built_in">this</span>, <span class="hljs-built_in">arguments</span>)
    &#125;
&#125;
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<h2 data-id="heading-3">2.2ã€ å½“å¤–ç•Œéœ€è¦å‡½æ•°çš„è¿”å›ç»“æœæ€ä¹ˆåŠï¼Ÿ</h2>
<p>åœ¨2.1ä¸­ï¼Œæˆ‘ä»¬åªæ˜¯ç®€å•çš„å°†æ‰§è¡Œç¼“å­˜åŠ å…¥åˆ°äº†æ‰§è¡Œé˜Ÿåˆ—é‡Œé¢ï¼Œå½“ç”¨æˆ·åœ¨åˆå§‹åŒ–ä¹‹å‰æ‰§è¡Œpostæ–¹æ³•çš„æ—¶å€™ï¼Œè™½ç„¶å¯ä»¥æ‰§è¡Œï¼Œä½†æ˜¯ç”¨æˆ·æ— æ³•æ‹¿åˆ°å‡½æ•°çš„æ‰§è¡Œç»“æœï¼Œå› æ­¤ï¼Œæˆ‘ä»¬è¦ç€æ‰‹æ€è€ƒåœ¨ä¸æ”¹å˜APIçš„è®¾è®¡çš„å‰æä¸‹ï¼Œæ”¯æŒå‡½æ•°å¸¦ç»“æœè¿”å›ã€‚</p>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Request</span> </span>&#123;
    <span class="hljs-comment">/** <span class="hljs-doctag">@type <span class="hljs-type">&#123; AxiosInstance &#125;</span> </span>*/</span>
    request = <span class="hljs-literal">null</span>
    <span class="hljs-function"><span class="hljs-title">constructor</span>(<span class="hljs-params"></span>)</span> &#123;
        <span class="hljs-built_in">this</span>.timeout = <span class="hljs-number">3000</span>;
        <span class="hljs-built_in">this</span>.requestQueues = [];
    &#125;
    <span class="hljs-function"><span class="hljs-title">initialize</span>(<span class="hljs-params"></span>)</span> &#123;
        <span class="hljs-built_in">this</span>.request = axios.create(&#123;
            <span class="hljs-attr">baseURL</span>: <span class="hljs-string">'/'</span>,
            <span class="hljs-attr">timeout</span>: <span class="hljs-built_in">this</span>.timeout
        &#125;)
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"this request lib has been initialized!"</span>)
        <span class="hljs-keyword">while</span> (<span class="hljs-built_in">this</span>.requestQueues.length > <span class="hljs-number">0</span>) &#123;
            <span class="hljs-keyword">let</span> execute = <span class="hljs-built_in">this</span>.requestQueues.pop()
            <span class="hljs-keyword">let</span> call = execute.dowork;
            <span class="hljs-keyword">try</span> &#123;
                <span class="hljs-comment">// åˆ¤æ–­è¿”å›ç»“æœæ˜¯å¦æ˜¯Promise</span>
                <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">typeof</span> call === <span class="hljs-string">'function'</span> && call();
                <span class="hljs-keyword">if</span> (result && <span class="hljs-keyword">typeof</span> result.then === <span class="hljs-string">'function'</span>) &#123;
                    result.then(<span class="hljs-function"><span class="hljs-params">response</span> =></span> &#123;
                        <span class="hljs-comment">// åœ¨å¼‚æ­¥ç»“æœä¸­æŠ¥å‘Š</span>
                        execute.trigger(<span class="hljs-string">"success"</span>, response);
                    &#125;).catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =></span> &#123;
                        <span class="hljs-comment">// æ•è·é”™è¯¯</span>
                        execute.trigger(<span class="hljs-string">"error"</span>, err);
                    &#125;);
                &#125; <span class="hljs-keyword">else</span> &#123;
                    <span class="hljs-comment">// ä¸æ˜¯Promiseç›´æ¥æŠ¥å‘Šç»“æœ</span>
                    execute.trigger(<span class="hljs-string">"success"</span>, result);
                &#125;
            &#125; <span class="hljs-keyword">catch</span> (exp) &#123;
                execute.trigger(<span class="hljs-string">"error"</span>, exp);
            &#125;
        &#125;
    &#125;
    <span class="hljs-function"><span class="hljs-title">post</span>(<span class="hljs-params"></span>)</span> &#123;
        <span class="hljs-keyword">var</span> args = <span class="hljs-built_in">arguments</span>;
        <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">this</span>.request) &#123;
            <span class="hljs-keyword">const</span> callback = &#123;
                <span class="hljs-attr">dowork</span>: <span class="hljs-function">() =></span> &#123;
                    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.request.post.apply(<span class="hljs-built_in">this</span>, args);
                &#125;,
            &#125;
            <span class="hljs-comment">//æ­¤å¤„æˆ‘ä»¬åœ¨è¿™å„¿éœ€è¦ç”¨åˆ°å‘å¸ƒè®¢é˜…æ¨¡å¼</span>
            callback.channels = &#123;&#125;;
            <span class="hljs-comment">//è®¢é˜…ç‰¹å¾é¢‘é“äº‹ä»¶</span>
            callback.on = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">channel, func, once = <span class="hljs-literal">false</span></span>) </span>&#123;
                callback.channels[channel] = &#123; func, once &#125;;
            &#125;
            <span class="hljs-comment">//å–æ¶ˆè®¢é˜…ç‰¹å¾é¢‘é“äº‹ä»¶</span>
            callback.off = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">channel</span>) </span>&#123;
                <span class="hljs-keyword">delete</span> callback.channels[channel];
            &#125;
            <span class="hljs-comment">// è®¢é˜…ä¸€æ¬¡é¢‘é“äº‹ä»¶</span>
            callback.once = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">channel, callback</span>) </span>&#123;
                callback.on(channel, callback, <span class="hljs-literal">true</span>);
            &#125;
            <span class="hljs-comment">//è§¦å‘è®¢é˜…</span>
            callback.trigger = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">channel, args</span>) </span>&#123;
                <span class="hljs-keyword">var</span> action = callback.channels[channel]
                <span class="hljs-comment">//å¦‚æœäº‹ä»¶å·²ç»è¢«å–æ¶ˆè®¢é˜…äº†ï¼Œå°†ä¸å†éœ€è¦è§¦å‘</span>
                <span class="hljs-keyword">if</span> (!action) &#123;
                    <span class="hljs-built_in">console</span>.warn(<span class="hljs-string">"this channel has been off"</span>)
                    <span class="hljs-keyword">return</span>;
                &#125;
                <span class="hljs-keyword">const</span> &#123; func, once &#125; = action;
                <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> func === <span class="hljs-string">'function'</span>) &#123;
                    func(args);
                    <span class="hljs-comment">// å•æ¬¡è®¢é˜…ï¼Œç”¨å®Œä¹‹åç«‹åˆ»é”€æ¯</span>
                    once && <span class="hljs-keyword">delete</span> callback.channels[channel]
                &#125;
            &#125;
            <span class="hljs-built_in">this</span>.requestQueues.push(callback)
            <span class="hljs-comment">// å¯¹å¤–è¿”å›ä¸€ä¸ªPromiseï¼Œå¯ä»¥ä½¿å¾—å¤–ç•Œæ”¯æŒå¼‚æ­¥ï¼Œèƒ½ä½¿å¾—æ“ä½œå¯ä»¥åœåœ¨é‚£å„¿ï¼ˆä¸ªäººæ„Ÿè§‰å°±åƒæ˜¯é’©å­å‡½æ•°çš„æ„Ÿè§‰ï¼Œå“ˆå“ˆå“ˆï¼‰</span>
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =></span> &#123;
                callback.on(<span class="hljs-string">"success"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">response</span>) </span>&#123;
                    resolve(response)
                &#125;);
                callback.on(<span class="hljs-string">"error"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">response</span>) </span>&#123;
                    reject(response);
                &#125;)
            &#125;);
        &#125;
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.request.post.apply(<span class="hljs-built_in">this</span>, <span class="hljs-built_in">arguments</span>)
    &#125;
&#125;
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<h2 data-id="heading-4">2.3 SDK å¿˜è®°åˆå§‹åŒ–äº†æ€ä¹ˆåŠï¼Ÿ</h2>
<p>å‡è®¾åˆå§‹åŒ–æ“ä½œå¿˜è®°è°ƒç”¨äº†æ€ä¹ˆåŠï¼Œéš¾ä¸æˆä¸€ç›´åœ¨è¿™å„¿å‚»ç­‰å—ï¼Ÿï¼ˆå°±åƒæˆ‘ä»¬ä¹‹å‰æåˆ°çš„é¢†åˆ¸æ“ä½œï¼Œå½“ä¸€å®šçš„æ—¶é—´ä¹‹åç©æ³•å®Œæˆåº”è¯¥æç¤ºè¶…æ—¶å¹¶å¯ä»¥è®©ç”¨æˆ·é‡æ–°æ“ä½œï¼Œå¦åˆ™ç”¨æˆ·å¯èƒ½è®¤ä¸ºä½ çš„ç³»ç»Ÿäº§ç”Ÿbugäº†å‘¢ğŸ˜‚ï¼‰å½“ç„¶ä¸å¯èƒ½ï¼Œæˆ‘ä»¬è¿˜éœ€è¦å¯¹å…¶å¢åŠ è¶…æ—¶çš„åé¦ˆã€‚
ç»§ç»­æ”¹é€ ä»£ç ï¼š</p>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Request</span> </span>&#123;
    <span class="hljs-comment">/** <span class="hljs-doctag">@type <span class="hljs-type">&#123; AxiosInstance &#125;</span> </span>*/</span>
    request = <span class="hljs-literal">null</span>
    <span class="hljs-function"><span class="hljs-title">constructor</span>(<span class="hljs-params"></span>)</span> &#123;
        <span class="hljs-built_in">this</span>.timeout = <span class="hljs-number">3000</span>;
        <span class="hljs-built_in">this</span>.requestQueues = [];
    &#125;
    <span class="hljs-function"><span class="hljs-title">initialize</span>(<span class="hljs-params"></span>)</span> &#123;
        <span class="hljs-built_in">this</span>.request = axios.create(&#123;
            <span class="hljs-attr">baseURL</span>: <span class="hljs-string">'/'</span>,
            <span class="hljs-attr">timeout</span>: <span class="hljs-built_in">this</span>.timeout
        &#125;)
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"this request lib has been initialized!"</span>)
        <span class="hljs-comment">// timeout error</span>
        <span class="hljs-keyword">while</span> (<span class="hljs-built_in">this</span>.requestQueues.length > <span class="hljs-number">0</span>) &#123;
            <span class="hljs-keyword">let</span> execute = <span class="hljs-built_in">this</span>.requestQueues.pop()
            <span class="hljs-keyword">let</span> call = execute.dowork;
            <span class="hljs-comment">// å¦‚æœæ‰§è¡Œåˆ°å½“å‰æ—¶åˆ»çš„æ—¶å€™ï¼Œå·²ç»è¶…æ—¶ï¼Œå°†ä¸åœ¨æ‰§è¡Œäº†ã€‚</span>
            <span class="hljs-keyword">if</span> (execute.timeout) &#123;
                <span class="hljs-keyword">return</span>
            &#125;
            <span class="hljs-keyword">try</span> &#123;
                <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">typeof</span> call === <span class="hljs-string">'function'</span> && call();
                <span class="hljs-keyword">if</span> (result && <span class="hljs-keyword">typeof</span> result.then === <span class="hljs-string">'function'</span>) &#123;
                    result.then(<span class="hljs-function"><span class="hljs-params">response</span> =></span> &#123;
                        execute.trigger(<span class="hljs-string">"success"</span>, response);
                    &#125;).catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =></span> &#123;
                        execute.trigger(<span class="hljs-string">"error"</span>, err);
                    &#125;);
                &#125; <span class="hljs-keyword">else</span> &#123;
                    execute.trigger(<span class="hljs-string">"success"</span>, result);
                &#125;
            &#125; <span class="hljs-keyword">catch</span> (exp) &#123;
                execute.trigger(<span class="hljs-string">"error"</span>, exp);
            &#125;
        &#125;
    &#125;
    <span class="hljs-function"><span class="hljs-title">post</span>(<span class="hljs-params"></span>)</span> &#123;

        <span class="hljs-keyword">var</span> args = <span class="hljs-built_in">arguments</span>;

        <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">this</span>.request) &#123;

            <span class="hljs-keyword">const</span> callback = &#123;
                <span class="hljs-attr">dowork</span>: <span class="hljs-function">() =></span> &#123;
                    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.request.post.apply(<span class="hljs-built_in">this</span>, args);
                &#125;,
                <span class="hljs-attr">timeout</span>: <span class="hljs-literal">false</span>
            &#125;

            callback.channels = &#123;&#125;;

            callback.on = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">channel, func, once = <span class="hljs-literal">false</span></span>) </span>&#123;
                callback.channels[channel] = &#123; func, once &#125;;
            &#125;

            callback.off = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">channel</span>) </span>&#123;
                <span class="hljs-keyword">delete</span> callback.channels[channel];
            &#125;

            callback.once = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">channel, callback</span>) </span>&#123;
                callback.on(channel, callback, <span class="hljs-literal">true</span>);
            &#125;

            callback.trigger = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">channel, args</span>) </span>&#123;
                <span class="hljs-keyword">var</span> action = callback.channels[channel]
                <span class="hljs-keyword">if</span> (!action) &#123;
                    <span class="hljs-built_in">console</span>.warn(<span class="hljs-string">"this channel has been off"</span>)
                    <span class="hljs-keyword">return</span>;
                &#125;
                <span class="hljs-keyword">const</span> &#123; func, once &#125; = action;
                <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> func === <span class="hljs-string">'function'</span>) &#123;
                    func(args);
                    once && <span class="hljs-keyword">delete</span> callback.channels[channel]
                &#125;
            &#125;
            <span class="hljs-comment">// è·å–å½“å‰æ—¶é—´</span>
            <span class="hljs-keyword">var</span> now = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().getTime();
            <span class="hljs-keyword">var</span> timer = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =></span> &#123;
                <span class="hljs-keyword">var</span> tick = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().getTime();
                <span class="hljs-keyword">if</span> (tick - now >= <span class="hljs-built_in">this</span>.timeout) &#123;
                    <span class="hljs-comment">//å¦‚æœè¯·æ±‚è¶…æ—¶ï¼Œå°†ç»ˆæ­¢ä¹‹å‰æ³¨å†Œçš„äº‹ä»¶,å¹¶æŠ¥å‘Šè¶…æ—¶ç»“æœ</span>
                    callback.off(<span class="hljs-string">"success"</span>);
                    callback.off(<span class="hljs-string">"error"</span>);
                    callback.timeout = <span class="hljs-literal">true</span>;
                    callback.trigger(<span class="hljs-string">"timeout"</span>);
                    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'the request lib initialization timeout'</span>)
                    <span class="hljs-built_in">clearInterval</span>(timer);
                &#125;
            &#125;, <span class="hljs-number">100</span>);
            <span class="hljs-comment">/* åœ¨æ­¤ï¼Œæˆ‘æ²¡æœ‰æƒ³åˆ°æ›´å¥½çš„è¶…æ—¶å¤„ç†çš„æ–¹æ³•ï¼Œè‹¥æœ‰æ›´å¥½çš„æ–¹æ³•è¯·å„ä½è¯»è€…æŒ‡æ•™ï¼Œè°¢è°¢ */</span>

            <span class="hljs-built_in">this</span>.requestQueues.push(callback)

            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =></span> &#123;

                callback.on(<span class="hljs-string">"timeout"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;
                    resolve(&#123; <span class="hljs-attr">errno</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">errmsg</span>: <span class="hljs-string">"æ¥å£è¯·æ±‚è¶…æ—¶"</span> &#125;);
                &#125;)

                callback.on(<span class="hljs-string">"success"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">response</span>) </span>&#123;
                    <span class="hljs-built_in">clearInterval</span>(timer)
                    resolve(response)
                &#125;);

                callback.on(<span class="hljs-string">"error"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">response</span>) </span>&#123;
                    <span class="hljs-built_in">clearInterval</span>(timer)
                    reject(response);
                &#125;)
            &#125;);
        &#125;
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.request.post.apply(<span class="hljs-built_in">this</span>, <span class="hljs-built_in">arguments</span>)
    &#125;
&#125;
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<h1 data-id="heading-5">3ã€ ç»“æœ</h1>
<pre><code class="hljs language-vue copyable" lang="vue"><script>
import request from "@/request/index";
export default &#123;
  name: "App",
  mounted() &#123;
    var start = new Date().getTime();
    console.log(0);
    // æ¨¡æ‹Ÿåˆå§‹åŒ–çš„è€—æ—¶æ“ä½œ
    setTimeout(() => &#123;
      request.initialize();
      var end = new Date().getTime();
      console.log(end - start);
    &#125;, 100);
    request.post("/demo").then(res => &#123;
      console.log(res)
    &#125;).catch(err => &#123;
      console.log(err)
    &#125;);
  &#125;,
&#125;;
</script>
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<p>æ‰§è¡Œç»“æœï¼š</p>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e2d9a29a2869401d8f0fdd54fc6c2feb~tplv-k3u1fbpfcp-watermark.image" alt="WX20210701-210557@2x.png" loading="lazy" referrerpolicy="no-referrer"></p>
<p>æˆ‘ä»¬å°†å®šæ—¶å™¨æ”¹ä¸º4Såæ‰§è¡Œï¼Œ
å¯ä»¥çœ‹åˆ°ï¼Œé¡ºåˆ©çš„æ‰§è¡Œäº†è¶…æ—¶æ“ä½œï¼Œå¹¶ä¸”åŸæ¥çš„è¯·æ±‚æ²¡æœ‰ç»§ç»­æ‰§è¡Œ</p>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/115ecb39df3b4a5dbf9502fdb727d208~tplv-k3u1fbpfcp-watermark.image" alt="WX20210701-210945@2x.png" loading="lazy" referrerpolicy="no-referrer"></p>
<h1 data-id="heading-6">4ã€æ€»ç»“ï¼š</h1>
<p>å…¶å®è¿™ä¸ªå¼‚æ­¥åŠ è½½åœºæ™¯æ˜¯æˆ‘åœ¨é¢è¯•æ»´æ»´çš„äºŒé¢ä¸­è¢«é—®åˆ°çš„ä¸€ä¸ªé—®é¢˜ï¼Œç”±äºå½“æ—¶æˆ‘å¤„åœ¨ä¸€ä¸ªä¸å¤ªå®‰é™çš„ç¯å¢ƒé¢è¯•ï¼Œæ²¡æœ‰å‡†ç¡®çš„è®¾è®¡å¼‚æ­¥çš„å¤„ç†æ€è·¯ï¼Œæ²¡æœ‰å›ç­”ä¸Šæ¥ã€‚åæ¥æˆ‘åˆåœ¨é¢è¯•ç¾å›¢çš„è¿‡ç¨‹ä¸­è¢«è¦æ±‚è®¾è®¡ä¸€ä¸ªå‘å¸ƒè®¢é˜…æ¨¡å¼ï¼Œç”±æ­¤å¯¹å‘å¸ƒè®¢é˜…æ¨¡å¼æœ‰äº†ä¸€ä¸ªè¾ƒä¸ºæ·±åˆ»çš„å°è±¡ï¼Œå› æ­¤åœ¨é‡åˆ°è¿™ä¸ªä¸šåŠ¡åœºæ™¯çš„æ—¶å€™ï¼Œä¸‹æ„è¯†çš„å°±æƒ³åˆ°äº†è¿™ä¸ªè§£æ³•ã€‚</p>
<p>ç”±äºç¬”è€…æ°´å¹³æœ‰é™ï¼Œå†™ä½œè¿‡ç¨‹ä¸­éš¾å…å‡ºç°é”™è¯¯ï¼Œè‹¥æœ‰çº°æ¼ï¼Œè¯·å„ä½è¯»è€…æŒ‡æ­£ï¼Œè¯·è”ç³»ä½œè€…æœ¬äººï¼Œé‚®ç®±<a href="mailto:404189928@qq.com">404189928@qq.com</a>ï¼Œä½ ä»¬çš„æ„è§å°†ä¼šå¸®åŠ©æˆ‘æ›´å¥½çš„è¿›æ­¥ã€‚æœ¬æ–‡ä¹ƒä½œè€…åŸåˆ›ï¼Œè‹¥è½¬è½½è¯·è”ç³»ä½œè€…æœ¬äººã€‚</p></div>  
</div>
            