
---
title: '假期让你的博客集成微信小程序扫码登录'
categories: 
 - 编程
 - 掘金
 - 分类
headimg: 'https://picsum.photos/400/300?random=4757'
author: 掘金
comments: false
date: Fri, 30 Apr 2021 18:08:18 GMT
thumbnail: 'https://picsum.photos/400/300?random=4757'
---

<div>   
<div class="markdown-body"><style>.markdown-body&#123;color:#383838;font-size:15px;line-height:37.5px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:120px&#125;.markdown-body ::selection&#123;color:#fff;background-color:#a862ea&#125;.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6&#123;margin:30px 0 15px;color:#a862ea&#125;.markdown-body h1&#123;line-height:2;font-size:1.4em&#125;.markdown-body h1~p:first-of-type:first-letter&#123;color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder&#125;.markdown-body h2&#123;font-size:1.2em&#125;.markdown-body h3&#123;font-size:1.1em&#125;.markdown-body ol,.markdown-body ul&#123;padding-left:2em&#125;.markdown-body ol li,.markdown-body ul li&#123;margin-bottom:0;padding-left:.2em&#125;.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item&#123;list-style:none&#125;.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul&#123;margin-top:0&#125;.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul&#123;margin-top:10px&#125;.markdown-body li::marker&#123;color:#a862ea&#125;.markdown-body li,.markdown-body p&#123;opacity:.9;vertical-align:baseline;transition:all .1s ease&#125;.markdown-body li:hover,.markdown-body p:hover&#123;opacity:1&#125;.markdown-body a&#123;display:inline-block;color:#a862ea;cursor:pointer;padding-bottom:2px;text-decoration:none;position:relative&#125;.markdown-body a:after&#123;content:"";position:absolute;width:98%;height:2px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out&#125;.markdown-body a:hover:after&#123;transform:scaleX(1);transform-origin:bottom left&#125;.markdown-body a:active,.markdown-body a:link&#123;color:#a862ea&#125;.markdown-body img&#123;max-width:100%;user-select:none;margin:1em 0;box-shadow:0 0 20px 0 #e7daff;transition:transform .2s ease 0s;background-color:#f8f5ff&#125;.markdown-body img:hover&#123;opacity:1;transform:translateY(-2px)&#125;.markdown-body blockquote&#123;padding:.5em 1em;margin:15px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:4px solid #a862ea;background-color:#f8f5ff&#125;.markdown-body blockquote>p&#123;margin:0&#125;.markdown-body code&#123;padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff&#125;.markdown-body pre&#123;margin:2em 0;box-shadow:0 0 20px #e7daff&#125;.markdown-body pre>code&#123;display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:22.5px;color:#383838;border-radius:3px;scroll-behavior:smooth&#125;.markdown-body pre>code::-webkit-scrollbar&#123;height:6px;background-color:#f8f5ff&#125;.markdown-body pre>code::-webkit-scrollbar-thumb&#123;background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px&#125;.markdown-body hr&#123;margin:2em 0;border-top:1px solid #a862ea&#125;.markdown-body table&#123;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse;border:1px solid #e7daff&#125;.markdown-body thead&#123;color:#a862ea;background:#f8f5ff&#125;.markdown-body td,.markdown-body th&#123;padding:1em .5em&#125;.markdown-body tr&#123;background-color:#fcfcfc&#125;@media (max-width:720px)&#123;.markdown-body&#123;font-size:12px&#125;&#125;</style><p>常见的微信扫码登录逻辑有两种</p>
<p>1、<a href="https://developers.weixin.qq.com/doc/oplatform/Website_App/WeChat_Login/Wechat_Login.html" target="_blank" rel="nofollow noopener noreferrer">微信开放平台</a></p>
<p>2、<a href="https://mp.weixin.qq.com/debug/cgi-bin/sandbox?t=sandbox/login" target="_blank" rel="nofollow noopener noreferrer">微信服务号</a></p>
<p>这两种都需要企业资料认证，对个人开发者是没有权限的，无意间看到<a href="https://docs.qq.com/desktop/?fromsrc=homepage" target="_blank" rel="nofollow noopener noreferrer">腾讯文档</a>扫码登录的时候打开的是小程序，开始还以为只有腾讯有权限（滑稽的笑了😄 ），然后就一顿搜索，发现这个逻辑其实就是我们日常开发小程序中的<a href="https://developers.weixin.qq.com/miniprogram/dev/api-backend/open-api/qr-code/wxacode.getUnlimited.html" target="_blank" rel="nofollow noopener noreferrer">小程序码</a>功能，外加一个websocket功能就可以搞定</p>
<p>文章首发于我的<a href="https://youxiubiji.com/" target="_blank" rel="nofollow noopener noreferrer">博客</a>，欢迎大家前来围观🚀️ 🚀️ 🚀️</p>
<h2 data-id="heading-0">实现原理</h2>
<ul>
<li>博客点击微信登录弹窗，建立websocket连接，连接建立成功之后，发送消息从服务端获取带有时间戳的随机id，接受到id之后携带id请求小程序码（id用于网页端和小程序的通信绑定），</li>
<li>用户通过微信扫码点击登录之后，把用户信息、code、和id提交到服务端，</li>
<li>服务端根据code获取openid，然后根据openid判断是创建还是更新用户信息，然后生成token通过websocket广播给唯一id的前端网页</li>
<li>前端接受到token，存储token，页面重新加载获取用户信息，断开websocket连接</li>
</ul>
<h2 data-id="heading-1">前端代码实现</h2>
<blockquote>
<p>前端我使用的vue</p>
</blockquote>
<pre><code class="hljs language-javascript copyable" lang="javascript"><span class="hljs-comment">//初始化weosocket</span>
        <span class="hljs-function"><span class="hljs-title">initWebSocket</span>(<span class="hljs-params"></span>)</span> &#123;
            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.websock) &#123;
                <span class="hljs-built_in">this</span>.websock.close();
            &#125;
            <span class="hljs-comment">// websocket 消息处理</span>
            <span class="hljs-keyword">const</span> messageHandler = &#123;
                <span class="hljs-comment">// 获得 codeId 接下来我们要生成二维码</span>
                <span class="hljs-attr">CODE_ID</span>: <span class="hljs-keyword">async</span> (res) => &#123;
                    <span class="hljs-keyword">let</span> $res = <span class="hljs-keyword">await</span> wxcodeUrl(&#123; <span class="hljs-attr">scene</span>: res.data.uuid &#125;);
                    <span class="hljs-built_in">this</span>.wxCodeSrc = <span class="hljs-string">"http://localhost:3000/"</span> + $res.data.url;
                    <span class="hljs-built_in">this</span>.codeLoading = <span class="hljs-literal">false</span>;
                    <span class="hljs-built_in">this</span>.isFailure = <span class="hljs-literal">false</span>;
                    <span class="hljs-built_in">this</span>.desccontent = <span class="hljs-string">"请使用微信扫一扫"</span>;
                &#125;,
                <span class="hljs-comment">// 二维码被扫描，等待客户端确认</span>
                <span class="hljs-attr">SCANNED</span>: <span class="hljs-function">() =></span> &#123;
                    <span class="hljs-built_in">this</span>.isLoadingScan = <span class="hljs-literal">true</span>;
                    <span class="hljs-built_in">this</span>.desccontent = <span class="hljs-string">"请在微信中点击确认登录"</span>;
                &#125;,
                <span class="hljs-comment">// 登录成功，保存获得的 token</span>
                <span class="hljs-attr">SUCCESS</span>: <span class="hljs-function">(<span class="hljs-params">res</span>) =></span> &#123;
                    <span class="hljs-built_in">this</span>.$store.commit(<span class="hljs-string">"user/SET_TOKEN"</span>, res.data.token);
                    setToken(res.data.token);
                    location.reload();
                    <span class="hljs-built_in">this</span>.$notify(&#123;
                        <span class="hljs-attr">title</span>: <span class="hljs-string">"成功"</span>,
                        <span class="hljs-attr">message</span>: <span class="hljs-string">"登录成功~"</span>,
                        <span class="hljs-attr">type</span>: <span class="hljs-string">"success"</span>,
                    &#125;);
                    <span class="hljs-built_in">this</span>.codeLoading = <span class="hljs-literal">false</span>;
                    <span class="hljs-built_in">this</span>.websock.close();
                &#125;,
            &#125;;
            <span class="hljs-comment">//初始化weosocket</span>
            <span class="hljs-built_in">this</span>.websock = <span class="hljs-keyword">new</span> WebSocket(<span class="hljs-string">"ws://localhost:3000/webSocket"</span>);
            <span class="hljs-built_in">this</span>.websock.onmessage = <span class="hljs-function">(<span class="hljs-params">e</span>) =></span> &#123;
                <span class="hljs-keyword">const</span> res = <span class="hljs-built_in">JSON</span>.parse(e.data);
                <span class="hljs-keyword">const</span> handlerFn = messageHandler[res.data.type];
                <span class="hljs-comment">// 匹配到相应的函数，执行之</span>
                <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> handlerFn === <span class="hljs-string">"function"</span>) &#123;
                    handlerFn(res);
                &#125;
            &#125;;
            <span class="hljs-comment">// 连接建立成功</span>
            <span class="hljs-built_in">this</span>.websock.onopen = <span class="hljs-function">() =></span> &#123;
                <span class="hljs-comment">// 发送消息，请求随机 id</span>
                <span class="hljs-built_in">this</span>.websock.send(<span class="hljs-string">"GET_CODE"</span>);
            &#125;;
            <span class="hljs-built_in">this</span>.websock.onerror = <span class="hljs-built_in">this</span>.websocketonerror;
            <span class="hljs-built_in">this</span>.websock.onclose = <span class="hljs-built_in">this</span>.websocketclose;
        &#125;,
        <span class="hljs-comment">//连接建立失败重连</span>
        <span class="hljs-function"><span class="hljs-title">websocketonerror</span>(<span class="hljs-params"></span>)</span> &#123;
            <span class="hljs-built_in">this</span>.initWebSocket();
        &#125;,
        <span class="hljs-comment">//关闭连接</span>
        <span class="hljs-function"><span class="hljs-title">websocketclose</span>(<span class="hljs-params"></span>)</span> &#123;
            <span class="hljs-built_in">this</span>.isFailure = <span class="hljs-literal">true</span>;
            <span class="hljs-built_in">this</span>.isLoadingScan = <span class="hljs-literal">false</span>;
            <span class="hljs-built_in">this</span>.desccontent = <span class="hljs-string">""</span>;
        &#125;,
<span class="copy-code-btn">复制代码</span></code></pre>
<h2 data-id="heading-2">服务端代码</h2>
<blockquote>
<p>服务端我使用的是koa，webSocket连接使用的是ws插件，只贴一部分代码，像那些生成小程序码都是接口调用
由于我koa和webSocket使用的是同一个端口号，所以在koa启动的时候就初始化webSocket</p>
</blockquote>
<pre><code class="copyable">app.listen(3000);
app.on('error', onError);
app.on('listening', onListening);

// websocket 初始化
const wss = createWss(server);
initWebsocket(wss);
<span class="copy-code-btn">复制代码</span></code></pre>
<ul>
<li><code>WebSocket Server 对象</code></li>
</ul>
<pre><code class="hljs language-javascript copyable" lang="javascript"><span class="hljs-keyword">const</span> WebSocket = <span class="hljs-built_in">require</span>(<span class="hljs-string">'ws'</span>);

<span class="hljs-comment">// WebSocket Server 对象</span>
<span class="hljs-keyword">let</span> wss = <span class="hljs-literal">null</span>;

<span class="hljs-comment">// 创建 wss 对象，我们可以把 Koa 的 Server 的对象传入，来共享端口，</span>
<span class="hljs-comment">// 第一次创建时，我们会结果赋值给将上面的 wss，</span>
<span class="hljs-comment">// 这样的好处是方便在接口层中获取 wss 对象，匹配正确的客户端</span>
<span class="hljs-keyword">const</span> createWss = <span class="hljs-function">(<span class="hljs-params">server</span>) =></span> &#123;
    <span class="hljs-keyword">if</span> (!wss) &#123;
        wss = <span class="hljs-keyword">new</span> WebSocket.Server(&#123;
            <span class="hljs-attr">server</span>: server
        &#125;)
        <span class="hljs-keyword">return</span> wss;
    &#125; <span class="hljs-keyword">else</span> &#123;
        <span class="hljs-keyword">return</span> wss;
    &#125;
&#125;

<span class="hljs-comment">// 获取 wss 对象</span>
<span class="hljs-keyword">const</span> getWss = <span class="hljs-function">() =></span> &#123;
    <span class="hljs-keyword">return</span> wss;
&#125;


<span class="hljs-built_in">module</span>.exports = &#123;
    <span class="hljs-attr">createWss</span>: createWss,
    <span class="hljs-attr">getWss</span>: getWss
&#125;
<span class="copy-code-btn">复制代码</span></code></pre>
<ul>
<li><code>初始化后的事件</code></li>
</ul>
<pre><code class="hljs language-JavaScript copyable" lang="JavaScript"><span class="hljs-comment">// 发送消息</span>
<span class="hljs-keyword">const</span> sendData = <span class="hljs-function">(<span class="hljs-params">client, status, data</span>) =></span> &#123;
    <span class="hljs-keyword">if</span> (client && client.send) &#123;
        client.send(<span class="hljs-built_in">JSON</span>.stringify(&#123;
            <span class="hljs-attr">status</span>: status,
            <span class="hljs-attr">data</span>: data
        &#125;));
    &#125;
&#125;

<span class="hljs-comment">// 服务初始化</span>
<span class="hljs-keyword">const</span> initWebsocket = <span class="hljs-function">(<span class="hljs-params">wss</span>) =></span> &#123;
    wss.on(<span class="hljs-string">"connection"</span>, <span class="hljs-function">(<span class="hljs-params">ws</span>) =></span> &#123;
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`[SERVER] connection`</span>);
        <span class="hljs-comment">// 接收到数据</span>
        ws.on(<span class="hljs-string">'message'</span>, <span class="hljs-function">(<span class="hljs-params">msg</span>) =></span> &#123;
            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`[SERVER] Received: <span class="hljs-subst">$&#123;msg&#125;</span>`</span>);
            <span class="hljs-comment">// 发送数据</span>
            <span class="hljs-keyword">const</span> fn = loginMessageHandler[msg];
            <span class="hljs-keyword">if</span> (fn) &#123;
                fn(ws);
            &#125; <span class="hljs-keyword">else</span> &#123;
                ws.send(<span class="hljs-string">"bad command!"</span>);
            &#125;
        &#125;);
    &#125;);
&#125;

<span class="hljs-comment">// 处理登录消息，根据客户端发来的消息匹配相应的业务逻辑操作函数</span>
<span class="hljs-keyword">const</span> loginMessageHandler = &#123;
    <span class="hljs-string">"GET_CODE"</span>: <span class="hljs-function">(<span class="hljs-params">ws</span>) =></span> &#123;
        <span class="hljs-keyword">const</span> uid = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().getTime();
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"获取二维码----"</span> + uid);
        ws.loginCondition = &#123;
            <span class="hljs-attr">uuid</span>: uid,
            <span class="hljs-attr">status</span>: <span class="hljs-number">0</span>
        &#125;
        sendData(ws, <span class="hljs-string">"ok"</span>, &#123;
            <span class="hljs-attr">uuid</span>: uid,
            <span class="hljs-attr">type</span>: <span class="hljs-string">"CODE_ID"</span>
        &#125;);
    &#125;
&#125;

<span class="hljs-built_in">module</span>.exports = &#123;
    <span class="hljs-attr">initWebsocket</span>: initWebsocket,
    <span class="hljs-attr">sendData</span>: sendData
&#125;
<span class="copy-code-btn">复制代码</span></code></pre>
<h2 data-id="heading-3">微信扫码登录</h2>
<pre><code class="hljs language-JavaScript copyable" lang="JavaScript"><span class="hljs-comment">/**
     * 微信扫码登录
     * <span class="hljs-doctag">@param <span class="hljs-type">&#123;*&#125;</span> </span>ctx 
     */</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-title">wxscanLogin</span>(<span class="hljs-params">ctx</span>)</span> &#123;
        <span class="hljs-keyword">const</span> &#123; <span class="hljs-attr">scene</span>: uuid &#125; = ctx.request.body;
        <span class="hljs-keyword">let</span> payload = ctx.state.user;
        <span class="hljs-keyword">try</span> &#123;
            <span class="hljs-keyword">const</span> token = tools.generatorToken(&#123; <span class="hljs-attr">id</span>: payload.id &#125;);
            <span class="hljs-keyword">const</span> wss = getWss();
            <span class="hljs-keyword">if</span> (wss && wss.clients && token) &#123;
                <span class="hljs-comment">// 可以在 wss.clients 中找到相应的客户端</span>
                <span class="hljs-keyword">const</span> clients = wss.clients;
                <span class="hljs-comment">// 找到对应的 ws 客户端</span>
                <span class="hljs-keyword">let</span> targetClient = [...clients].find(<span class="hljs-function">(<span class="hljs-params">client</span>) =></span> client.loginCondition.uuid == uuid);
                <span class="hljs-keyword">if</span> (targetClient) &#123;
                    <span class="hljs-keyword">if</span> (targetClient.loginCondition.status == <span class="hljs-number">0</span>) &#123;
                        sendData(targetClient, <span class="hljs-string">"ok"</span>, &#123;
                            <span class="hljs-attr">uuid</span>: uuid,
                            <span class="hljs-attr">type</span>: <span class="hljs-string">"SUCCESS"</span>,
                            <span class="hljs-attr">token</span>: token
                        &#125;);
                    &#125;
                &#125;
                ctx.success();
            &#125;
        &#125; <span class="hljs-keyword">catch</span> (err) &#123;
            ctx.fail();
        &#125;
    &#125;
<span class="copy-code-btn">复制代码</span></code></pre>
<p>演示地址 : <a href="https://youxiubiji.com/" target="_blank" rel="nofollow noopener noreferrer">youxiubiji.com</a></p></div>  
</div>
            