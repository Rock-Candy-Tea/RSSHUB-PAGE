
---
title: '官方揭秘！你的颜色是这样算出来的……'
categories: 
 - 编程
 - 掘金
 - 分类
headimg: 'https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a78c02e252b24427b87dd0ca6a4a569c~tplv-k3u1fbpfcp-zoom-1.image'
author: 掘金
comments: false
date: Sun, 30 May 2021 22:55:56 GMT
thumbnail: 'https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a78c02e252b24427b87dd0ca6a4a569c~tplv-k3u1fbpfcp-zoom-1.image'
---

<div>   
<div class="markdown-body"><style>.markdown-body&#123;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333&#125;.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6&#123;line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px&#125;.markdown-body h1&#123;font-size:30px;margin-bottom:5px&#125;.markdown-body h2&#123;padding-bottom:12px;font-size:24px;border-bottom:1px solid #ececec&#125;.markdown-body h3&#123;font-size:18px;padding-bottom:0&#125;.markdown-body h4&#123;font-size:16px&#125;.markdown-body h5&#123;font-size:15px&#125;.markdown-body h6&#123;margin-top:5px&#125;.markdown-body p&#123;line-height:inherit;margin-top:22px;margin-bottom:22px&#125;.markdown-body img&#123;max-width:100%&#125;.markdown-body hr&#123;border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px&#125;.markdown-body code&#123;word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em&#125;.markdown-body code,.markdown-body pre&#123;font-family:Menlo,Monaco,Consolas,Courier New,monospace&#125;.markdown-body pre&#123;overflow:auto;position:relative;line-height:1.75&#125;.markdown-body pre>code&#123;font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8&#125;.markdown-body a&#123;text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff&#125;.markdown-body a:active,.markdown-body a:hover&#123;color:#275b8c&#125;.markdown-body table&#123;display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6&#125;.markdown-body thead&#123;background:#f6f6f6;color:#000;text-align:left&#125;.markdown-body tr:nth-child(2n)&#123;background-color:#fcfcfc&#125;.markdown-body td,.markdown-body th&#123;padding:12px 7px;line-height:24px&#125;.markdown-body td&#123;min-width:120px&#125;.markdown-body blockquote&#123;color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8&#125;.markdown-body blockquote:after&#123;display:block;content:""&#125;.markdown-body blockquote>p&#123;margin:10px 0&#125;.markdown-body ol,.markdown-body ul&#123;padding-left:28px&#125;.markdown-body ol li,.markdown-body ul li&#123;margin-bottom:0;list-style:inherit&#125;.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item&#123;list-style:none&#125;.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul&#123;margin-top:0&#125;.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul&#123;margin-top:3px&#125;.markdown-body ol li&#123;padding-left:6px&#125;.markdown-body .contains-task-list&#123;padding-left:0&#125;.markdown-body .task-list-item&#123;list-style:none&#125;@media (max-width:720px)&#123;.markdown-body h1&#123;font-size:24px&#125;.markdown-body h2&#123;font-size:20px&#125;.markdown-body h3&#123;font-size:18px&#125;&#125;</style><blockquote>
<p>作者：<a href="https://github.com/imyzf" target="_blank" rel="nofollow noopener noreferrer">imyzf</a></p>
</blockquote>
<p>上周三，你的朋友圈是不是这样子的？</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a78c02e252b24427b87dd0ca6a4a569c~tplv-k3u1fbpfcp-zoom-1.image" alt loading="lazy" referrerpolicy="no-referrer"></p>
<p>与此同时，有网友开始分析起了本次活动的计算逻辑，甚至反编译出了所有可能的颜色结果。作为本次活动的核心开发人员，接下来将为大家介绍颜色测试活动的技术细节。</p>
<blockquote>
<p>小剧透：本文将在最后重点介绍大家最想了解的结果计算逻辑</p>
</blockquote>
<h2 data-id="heading-0">整体结构</h2>
<p>本次活动的 H5 其实是一个单页应用（SPA），通过 react-router 进行路由控制，内部包含了 13 个页面，包括首页、问题页、结果页等部分，其中每个问题都是一个页面。页面之间采用了 <a href="https://reactcommunity.org/react-transition-group/" target="_blank" rel="nofollow noopener noreferrer">react-transition-group</a> 实现淡入淡出的切换效果，问题页之间用 canvas 实现了类似幕布拉动的切换动画。</p>
<p>答题类页面与一般的 H5 页面的不同之处在于，用户的操作路径是确定的，即每个页面的下一页路由是固定的，所以在 router 层面做了优化，提前预加载了下一个页面，这样做的目的有两点：</p>
<ul>
<li>优化体验，点击立即出现下一页，无加载过程</li>
<li>很多页面内有视频，需要提前加载 DOM 节点，才能通过 <code>click</code> 事件触发 <code>video</code> 标签的播放，同时也实现了视频的预加载</li>
</ul>
<img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f81b24879c894825b5ddcba8653e4345~tplv-k3u1fbpfcp-zoom-1.image" width="300" loading="lazy" referrerpolicy="no-referrer">
<p>如图所示，下一页会提前加载，隐藏在当前页面底下。</p>
<h2 data-id="heading-1">动画效果</h2>
<p>本次活动页面运用了大量动效来提升用户体验。使用的方式主要分为以下两类：</p>
<ul>
<li>预渲染：对于复杂的、没有交互逻辑的动画，采用动效师预先渲染好的视频，以取得最佳的性能和兼容性，例如大部分问题的背景动画。唯一的缺点就是需要加载更大的资源，这一点通过最大程度压缩视频体积和上面提到的预加载得以解决。</li>
<li>实时渲染：对于有交互要求的动效，采用 canvas、WebGL、物理引擎等方式实时渲染，提供更高的可玩性。</li>
</ul>
<p>接下来将介绍一下几个比较酷炫的动效。</p>
<h3 data-id="heading-2">翻页动效</h3>
<p>每个问题页面之间的切换会有带弹性的幕布拉动效果，采用了 canvas 进行实现，基于贝赛尔曲线进行绘制。</p>
<img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f893d4e10c014628adfa731342e38237~tplv-k3u1fbpfcp-zoom-1.image" width="300" loading="lazy" referrerpolicy="no-referrer">
<p>如图所示，用户触发跳转下一页的点击操作后，我们使用 P1-P5 五个点构成的灰色遮罩闭合区域遮挡当前页面。其中 P4 和 P5 是固定的点，用于确定右边界。通过不断向左移动 P1、P2 和 P3 的 x 轴坐标，并且修改贝塞尔曲线控制点值，实现拉动效果。这里用到的最核心的 canvas API 是 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/CanvasRenderingContext2D/bezierCurveTo" target="_blank" rel="nofollow noopener noreferrer">bezierCurveTo</a>方法。</p>
<h3 data-id="heading-3">云层动效</h3>
<p>第 5 个问题中，背景中出现了云层动效，这一部分基于 <a href="https://threejs.org/" target="_blank" rel="nofollow noopener noreferrer">three.js</a> 实现，采用了 WebGL 进行渲染。这里的云朵采用了着色器材质（ShaderMaterial）载入顶点着色器和片元着色器，贴图进行渲染，然后移动相机位置，模拟穿梭效果。这里每朵云出现的位置都是随机的，不同人看到的都不一样。</p>
<h3 data-id="heading-4">掉落动效</h3>
<p>第 7 个问题中，进入页面会有按键和物品掉落的效果，这里采用了物理引擎 <a href="https://brm.io/matter-js/" target="_blank" rel="nofollow noopener noreferrer">Matter.js</a> 模拟了自由落体运动和碰撞效果。这里掉落后的位置也是随机的，千人千面，更加真实。</p>
<h2 data-id="heading-5">结果计算</h2>
<p>接下来将为大家揭秘测试结果是如何计算出来的。</p>
<p>1、每个选项都有对应的数个颜色，例如第一题：</p>
<ul>
<li>选项 A：金、绿</li>
<li>选项 B：紫、银、橙</li>
<li>选项 C：粉、蓝</li>
</ul>
<p>2、我们会记录每个题目的选择，在最后计算的时候，将对应的颜色进行累加计数。例如第一题选了 A，则会将<code>金</code>和<code>绿</code>各加 1。</p>
<p>3、至于单色还是双色，是根据第 8 题的选择来判断的，如果选了“悲伤”，结果就是单色，选了“浪漫”，结果就是双色。</p>
<p>4、如果是单色，就取单色计数最高的颜色作为结果。</p>
<p>5、如果是双色，就取组合两色之和最高的颜色作为结果，例如，假设<code>橙+金</code>计数之和是最高的，结果就是<code>橙+金</code>。当然，这里的组合是有限制的，只有 9 种预设的组合，所以计算的时候将结果限定在了这 9 种之内。</p>
<p>6、如果在排序时遇到了求和结果相同的颜色或组合，会按照策划同学给出的优先级取结果。例如单色情况下，假设<code>橙</code>和<code>金</code>的计数都是 5，会按照<code>橙>金</code>的优先级，取<code>橙</code>为结果。</p>
<p>总体流程如下图所示：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a7951782b1d04ef690b27b287bd3531a~tplv-k3u1fbpfcp-zoom-1.image" alt="流程图" loading="lazy" referrerpolicy="no-referrer"></p>
<p>举个例子，某位小伙伴的选择是：</p>

<pre><code class="hljs language-js copyable" lang="js">[B, C, A, C, C, C, C, A]
<span class="copy-code-btn">复制代码</span></code></pre>
<p>那么他的颜色计数是</p>
<pre><code class="hljs language-js copyable" lang="js">&#123; <span class="hljs-string">'紫'</span>: <span class="hljs-number">3</span>, <span class="hljs-string">'银'</span>: <span class="hljs-number">6</span>, <span class="hljs-string">'橙'</span>: <span class="hljs-number">3</span>, <span class="hljs-string">'金'</span>: <span class="hljs-number">3</span>, <span class="hljs-string">'绿'</span>: <span class="hljs-number">2</span>, <span class="hljs-string">'粉'</span>: <span class="hljs-number">2</span>, <span class="hljs-string">'蓝'</span>: <span class="hljs-number">3</span> &#125;
<span class="copy-code-btn">复制代码</span></code></pre>
<p>由于最后一题选择了“浪漫”，所以结果是双色，按优先级求和，<code>金+橙</code>最大（排除不存在的结果组合），所以结果是<code>金+橙</code>。</p>
<img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3913161b61044a3e8e3f329685355e86~tplv-k3u1fbpfcp-zoom-1.image" width="300" loading="lazy" referrerpolicy="no-referrer">
<p>本次测试总共有 <code>3^7*2=4374</code> 种选择路径，有 7 种单色结果和 9 种双色结果，总共 16 种结果。</p>
<p>单色结果：</p>
<pre><code class="hljs language-js copyable" lang="js">[<span class="hljs-string">'绿'</span>, <span class="hljs-string">'橙'</span>, <span class="hljs-string">'银'</span>, <span class="hljs-string">'紫'</span>, <span class="hljs-string">'蓝'</span>, <span class="hljs-string">'金'</span>, <span class="hljs-string">'粉'</span>]
<span class="copy-code-btn">复制代码</span></code></pre>
<p>双色结果：</p>
<pre><code class="hljs language-js copyable" lang="js">[<span class="hljs-string">'粉金'</span>, <span class="hljs-string">'金橙'</span>, <span class="hljs-string">'粉紫'</span>, <span class="hljs-string">'金蓝'</span>, <span class="hljs-string">'金紫'</span>, <span class="hljs-string">'橙粉'</span>, <span class="hljs-string">'蓝粉'</span>, <span class="hljs-string">'金绿'</span>, <span class="hljs-string">'橙绿'</span>]
<span class="copy-code-btn">复制代码</span></code></pre>
<p>由于结果总数相对可控，并且不需要结合其他后台数据（例如用户个人数据）作计算，所以计算逻辑都在前端完成，并且读取内置的配置展示文案，本次活动并没有后端同学参与开发。</p>
<blockquote>
<p>以上结果计算逻辑根据著名性格色彩培训师 Tom Maddron 的著作《最准确的性格色彩测量工具》得出</p>
</blockquote>
<h3 data-id="heading-6">小插曲</h3>
<p>另外值得一提的是，本次的结果计算逻辑中，并没有将颜色和对应的英文进行映射，而是全程使用了中文。例如结果配置文件中，直接使用了中文 key：</p>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> &#123;
    蓝: &#123;
        <span class="hljs-attr">attracted</span>: [<span class="hljs-string">'橙粉'</span>, <span class="hljs-string">'粉金'</span>],
        <span class="hljs-attr">keepAway</span>: [<span class="hljs-string">'金'</span>, <span class="hljs-string">'银'</span>],
        ......
    &#125;
&#125;
<span class="copy-code-btn">复制代码</span></code></pre>
<p>目前 JS 对 Unicode 的支持已经足够好，甚至支持 <a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Guide/Grammar_and_types#%E5%8F%98%E9%87%8F" target="_blank" rel="nofollow noopener noreferrer">Unicode 变量名</a>，在开发完成后，我们进行了最低版本为安卓 5.0 的兼容性测试，并没有发现任何问题，实际上线后也没有遇到这方面的问题。</p>
<p>甚至在 less 代码中使用了中文类名：</p>
<pre><code class="hljs language-less copyable" lang="less">.金 &#123;
    <span class="hljs-attribute">background</span>: rgb(<span class="hljs-number">228</span>, <span class="hljs-number">198</span>, <span class="hljs-number">114</span>);
&#125;
<span class="copy-code-btn">复制代码</span></code></pre>
<p>据<a href="https://stackoverflow.com/questions/19123336/can-i-safely-use-unicode-characters-e-g-accents-in-css-class-names-or-ids" target="_blank" rel="nofollow noopener noreferrer">相关资料</a>显示，从 HTML 4.01 开始，就支持了 Unicode 字符作为 class 属性名。当然由于该工程启用了 CSS Module，这里的中文类名会被转换为纯英文的 hash 字符串，不用考虑兼容性问题。</p>
<p>虽然我们不推荐在编程过程中大范围使用中文，但是在该场景下，结果的颜色枚举数量较多，使用中文作为每个颜色的唯一标识，更加直观，可以增加代码可读性，减少将颜色翻译成英文并进行映射的工作量，也是非常值得的做法。</p>
<h2 data-id="heading-7">结语</h2>
<p>本次活动开发的技术细节就介绍到这里，希望能给大家带来一些收获。可能有小伙伴还会问，为什么相同的回答路径会产生不同的结果？这里就不细说了，保留一点神秘感，等着大家去挖掘吧！</p>
<blockquote>
<p>本文发布自 <a href="https://github.com/x-orpheus" target="_blank" rel="nofollow noopener noreferrer">网易云音乐大前端团队</a>，文章未经授权禁止任何形式的转载。我们常年招收前端、iOS、Android，如果你准备换工作，又恰好喜欢云音乐，那就加入我们 grp.music-fe(at)corp.netease.com！</p>
</blockquote></div>  
</div>
            