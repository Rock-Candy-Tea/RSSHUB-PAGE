
---
title: '微信小程序爬过的坑.0.0'
categories: 
 - 编程
 - 掘金
 - 分类
headimg: 'https://picsum.photos/400/300?random=190'
author: 掘金
comments: false
date: Thu, 08 Jul 2021 18:45:38 GMT
thumbnail: 'https://picsum.photos/400/300?random=190'
---

<div>   
<div class="markdown-body"><style>.markdown-body&#123;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333&#125;.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6&#123;line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px&#125;.markdown-body h1&#123;font-size:30px;margin-bottom:5px&#125;.markdown-body h2&#123;padding-bottom:12px;font-size:24px;border-bottom:1px solid #ececec&#125;.markdown-body h3&#123;font-size:18px;padding-bottom:0&#125;.markdown-body h4&#123;font-size:16px&#125;.markdown-body h5&#123;font-size:15px&#125;.markdown-body h6&#123;margin-top:5px&#125;.markdown-body p&#123;line-height:inherit;margin-top:22px;margin-bottom:22px&#125;.markdown-body img&#123;max-width:100%&#125;.markdown-body hr&#123;border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px&#125;.markdown-body code&#123;word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em&#125;.markdown-body code,.markdown-body pre&#123;font-family:Menlo,Monaco,Consolas,Courier New,monospace&#125;.markdown-body pre&#123;overflow:auto;position:relative;line-height:1.75&#125;.markdown-body pre>code&#123;font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8&#125;.markdown-body a&#123;text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff&#125;.markdown-body a:active,.markdown-body a:hover&#123;color:#275b8c&#125;.markdown-body table&#123;display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6&#125;.markdown-body thead&#123;background:#f6f6f6;color:#000;text-align:left&#125;.markdown-body tr:nth-child(2n)&#123;background-color:#fcfcfc&#125;.markdown-body td,.markdown-body th&#123;padding:12px 7px;line-height:24px&#125;.markdown-body td&#123;min-width:120px&#125;.markdown-body blockquote&#123;color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8&#125;.markdown-body blockquote:after&#123;display:block;content:""&#125;.markdown-body blockquote>p&#123;margin:10px 0&#125;.markdown-body ol,.markdown-body ul&#123;padding-left:28px&#125;.markdown-body ol li,.markdown-body ul li&#123;margin-bottom:0;list-style:inherit&#125;.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item&#123;list-style:none&#125;.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul&#123;margin-top:0&#125;.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul&#123;margin-top:3px&#125;.markdown-body ol li&#123;padding-left:6px&#125;.markdown-body .contains-task-list&#123;padding-left:0&#125;.markdown-body .task-list-item&#123;list-style:none&#125;@media (max-width:720px)&#123;.markdown-body h1&#123;font-size:24px&#125;.markdown-body h2&#123;font-size:20px&#125;.markdown-body h3&#123;font-size:18px&#125;&#125;</style><h3 data-id="heading-0"><strong>1.  预览文件（pdf为例）</strong></h3>
<p>本来按照大多数写法，先下载，再打开即可实现需求，but发了体验版神奇的发现，分享或者发送给朋友之后文件的后缀就没了，然后导致手机打不开，so这是微信小程序的bug还是自己的问题呢，emmmm，肯定是自己的bug啦，你看其他小程序都可以分享的.....</p>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// 小程序图片预览 </span>
<span class="hljs-comment">/**
 * 
 * <span class="hljs-doctag">@param </span>url 图片地址
 * <span class="hljs-doctag">@param </span>urlList 图片数组
 * <span class="hljs-doctag">@returns </span>
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">conmmonPreview</span>(<span class="hljs-params">url: string, urlList: any = []</span>) </span>&#123;
  <span class="hljs-keyword">if</span> (!urlList) &#123; urlList.push(url) &#125;
  <span class="hljs-keyword">return</span> Taro.previewImage(&#123; <span class="hljs-attr">current</span>: url, <span class="hljs-attr">urls</span>: urlList &#125;)
&#125;

<span class="hljs-comment">// 小程序图片下载并预览 </span>
<span class="hljs-comment">/**
 * 
 * <span class="hljs-doctag">@param </span>url 图片地址
 * <span class="hljs-doctag">@returns </span>
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">conmmonPreviewIOS</span>(<span class="hljs-params">url: string</span>) </span>&#123;
  <span class="hljs-keyword">const</span> FileSystemManager = wx.getFileSystemManager()
  <span class="hljs-keyword">return</span> (
    Taro.downloadFile(&#123;   <span class="hljs-comment">// 先下载 </span>
      <span class="hljs-attr">url</span>: url,
      <span class="hljs-attr">header</span>: &#123;
        <span class="hljs-string">'content-type'</span>: <span class="hljs-string">'application/json'</span>,
      &#125;,
      <span class="hljs-attr">success</span>: <span class="hljs-function">(<span class="hljs-params">res</span>) =></span> &#123;
        <span class="hljs-keyword">const</span> Path = res.tempFilePath  <span class="hljs-comment">// 拿到临时文件路径</span>
        <span class="hljs-keyword">let</span> suffixIndex = Path.lastIndexOf(<span class="hljs-string">'.'</span>);
        <span class="hljs-keyword">let</span> suffix = Path.slice(suffixIndex,);
        FileSystemManager.saveFile(&#123; <span class="hljs-comment">// 用系统方法保存临时文件</span>
          <span class="hljs-attr">tempFilePath</span>: Path,
          <span class="hljs-attr">filePath</span>: <span class="hljs-string">`<span class="hljs-subst">$&#123;wx.env.USER_DATA_PATH&#125;</span>/<span class="hljs-subst">$&#123;<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().getTime()&#125;</span><span class="hljs-subst">$&#123;suffix&#125;</span>`</span>,  <span class="hljs-comment">// 文件名用时间戳</span>
          <span class="hljs-attr">success</span>: <span class="hljs-function">(<span class="hljs-params">res</span>) =></span> &#123;
            <span class="hljs-keyword">let</span> savedFilePath = res.savedFilePath;  <span class="hljs-comment">// 拿到保存成功后的地址</span>
            wx.openDocument(&#123;   <span class="hljs-comment">// 打开文档 * （再分享的时候就会把保存在本地的文件 分享出去 即上一步操作的 文件 文件名以时间戳的形式展示）</span>
              <span class="hljs-attr">filePath</span>: savedFilePath,
              <span class="hljs-attr">showMenu</span>: <span class="hljs-literal">true</span>,
              <span class="hljs-attr">fileType</span>: <span class="hljs-string">'pdf'</span>,
              <span class="hljs-attr">success</span>: <span class="hljs-function">() =></span> &#123;
                <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'打开文档成功'</span>)
              &#125;
            &#125;)
          &#125;
        &#125;)
      &#125;,
      <span class="hljs-attr">fail</span>: <span class="hljs-function">(<span class="hljs-params">res</span>) =></span> &#123;
        <span class="hljs-built_in">console</span>.log(res, wx.env.USER_DATA_PATH, <span class="hljs-string">'0'</span>)
        wx.showToast(&#123;
          <span class="hljs-attr">title</span>: <span class="hljs-string">'下载失败'</span>,
          <span class="hljs-attr">duration</span>: <span class="hljs-number">1000</span>
        &#125;)
      &#125;
    &#125;)
  )
&#125;
<span class="copy-code-btn">复制代码</span></code></pre>
<h3 data-id="heading-1"><strong>2.  打开外部链接 （腾讯会议为例）</strong></h3>
<p>一想到打开外链，就想到要借助webView了叭，就直接上方法了，也没啥好说的，也就纯粹记录下，下次直接来copy代码，以免自己忘记....</p>
<h5 data-id="heading-2">点击跳外链的事件</h5>
<pre><code class="hljs language-js copyable" lang="js"> <span class="hljs-keyword">const</span> serviceClick = <span class="hljs-function"><span class="hljs-params">url</span> =></span> &#123;
    Taro.setStorageSync(<span class="hljs-string">'webWiewUrl'</span>, url)  <span class="hljs-comment">// 把要跳的链接 存储在storage里</span>
    commonNav(&#123;
      <span class="hljs-attr">url</span>: <span class="hljs-string">'/pages/home/courseDetail/components/webView/index'</span>, <span class="hljs-comment">// webView页面的路由</span>
      <span class="hljs-attr">type</span>: <span class="hljs-string">'navigateTo'</span> <span class="hljs-comment">// 使用这个可以有个返回按钮在左上角 可以返回到我们自己的页面来</span>
    &#125;)
  &#125;
<span class="copy-code-btn">复制代码</span></code></pre>
<h5 data-id="heading-3">webView页面的代码</h5>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-keyword">import</span> React, &#123; Fragment &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>
<span class="hljs-keyword">import</span> &#123; WebView &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">'@tarojs/components'</span>
<span class="hljs-keyword">import</span> Taro, &#123; useRouter &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">'@tarojs/taro'</span>

<span class="hljs-keyword">const</span> WebViewPages = <span class="hljs-function">() =></span> &#123;
  <span class="hljs-keyword">const</span> paramsUrl = useRouter().params.url
  <span class="hljs-keyword">let</span> url = paramsUrl || Taro.getStorageSync(<span class="hljs-string">'webWiewUrl'</span>) || <span class="hljs-string">''</span>
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag"><<span class="hljs-name">Fragment</span>></span>&#123;url && <span class="hljs-tag"><<span class="hljs-name">WebView</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&#123;url&#125;</span> /></span>&#125;<span class="hljs-tag"></<span class="hljs-name">Fragment</span>></span></span>
&#125;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> React.memo(WebViewPages)
<span class="copy-code-btn">复制代码</span></code></pre></div>  
</div>
            