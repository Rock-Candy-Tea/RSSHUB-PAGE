
---
title: 'ä¸€æ–‡ææ‡‚è„šæ‰‹æ¶'
categories: 
 - ç¼–ç¨‹
 - æ˜é‡‘
 - åˆ†ç±»
headimg: 'https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9c6c0dcb8d1b486ea44f9e74c32146a5~tplv-k3u1fbpfcp-watermark.image'
author: æ˜é‡‘
comments: false
date: Mon, 19 Jul 2021 01:20:03 GMT
thumbnail: 'https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9c6c0dcb8d1b486ea44f9e74c32146a5~tplv-k3u1fbpfcp-watermark.image'
---

<div>   
<div class="markdown-body"><style>.markdown-body&#123;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333&#125;.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6&#123;line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px&#125;.markdown-body h1&#123;font-size:30px;margin-bottom:5px&#125;.markdown-body h2&#123;padding-bottom:12px;font-size:24px;border-bottom:1px solid #ececec&#125;.markdown-body h3&#123;font-size:18px;padding-bottom:0&#125;.markdown-body h4&#123;font-size:16px&#125;.markdown-body h5&#123;font-size:15px&#125;.markdown-body h6&#123;margin-top:5px&#125;.markdown-body p&#123;line-height:inherit;margin-top:22px;margin-bottom:22px&#125;.markdown-body img&#123;max-width:100%&#125;.markdown-body hr&#123;border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px&#125;.markdown-body code&#123;word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em&#125;.markdown-body code,.markdown-body pre&#123;font-family:Menlo,Monaco,Consolas,Courier New,monospace&#125;.markdown-body pre&#123;overflow:auto;position:relative;line-height:1.75&#125;.markdown-body pre>code&#123;font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8&#125;.markdown-body a&#123;text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff&#125;.markdown-body a:active,.markdown-body a:hover&#123;color:#275b8c&#125;.markdown-body table&#123;display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6&#125;.markdown-body thead&#123;background:#f6f6f6;color:#000;text-align:left&#125;.markdown-body tr:nth-child(2n)&#123;background-color:#fcfcfc&#125;.markdown-body td,.markdown-body th&#123;padding:12px 7px;line-height:24px&#125;.markdown-body td&#123;min-width:120px&#125;.markdown-body blockquote&#123;color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8&#125;.markdown-body blockquote:after&#123;display:block;content:""&#125;.markdown-body blockquote>p&#123;margin:10px 0&#125;.markdown-body ol,.markdown-body ul&#123;padding-left:28px&#125;.markdown-body ol li,.markdown-body ul li&#123;margin-bottom:0;list-style:inherit&#125;.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item&#123;list-style:none&#125;.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul&#123;margin-top:0&#125;.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul&#123;margin-top:3px&#125;.markdown-body ol li&#123;padding-left:6px&#125;.markdown-body .contains-task-list&#123;padding-left:0&#125;.markdown-body .task-list-item&#123;list-style:none&#125;@media (max-width:720px)&#123;.markdown-body h1&#123;font-size:24px&#125;.markdown-body h2&#123;font-size:20px&#125;.markdown-body h3&#123;font-size:18px&#125;&#125;</style><h2 data-id="heading-0">1. è„šæ‰‹æ¶å¯¹æ¯”</h2>

























<table><thead><tr><th>è„šæ‰‹æ¶</th><th>å‘½ä»¤</th></tr></thead><tbody><tr><td>vue-cli2</td><td>vue init webpack hello</td></tr><tr><td>vue-cli4(5)</td><td>vue create hello-world</td></tr><tr><td>cra</td><td>npx create-react-app my-app</td></tr><tr><td>vite</td><td>yarn create vite</td></tr></tbody></table>
<h2 data-id="heading-1">2. vue-cli2</h2>
<h3 data-id="heading-2">2.1 åˆå§‹åŒ–é¡¹ç›®</h3>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// å› ä¸ºæ˜¯è€ç‰ˆæœ¬äº†æŒ‡å®šç‰ˆæœ¬ å¯ä»¥ä½¿ç”¨npxæ¥æ‰§è¡Œ</span>
npm install -g vue-cli@<span class="hljs-number">2</span> --force
vue init webpack hello-vue-cli2
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9c6c0dcb8d1b486ea44f9e74c32146a5~tplv-k3u1fbpfcp-watermark.image" alt="downloading.png" loading="lazy" referrerpolicy="no-referrer"></p>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/24c18a50b5c14184be8494bcea0cd16d~tplv-k3u1fbpfcp-watermark.image" alt="vue-cli2.png" loading="lazy" referrerpolicy="no-referrer"></p>
<h3 data-id="heading-3">2.2 åŸºæœ¬æµç¨‹</h3>
<pre><code class="hljs language-js copyable" lang="js">downloading template...
<span class="hljs-comment">// 1. é€‰æ‹©ä¸€äº›é€‰é¡¹</span>
? Project name
vue-cli Â· Generated <span class="hljs-string">"hello-vue-cli2"</span>.
<span class="hljs-comment">// 2. å®‰è£…ä¾èµ–</span>
Installing project dependencies ...
<span class="hljs-comment">// 3. Project initialization finished!</span>
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/452ddb31db3d42f0bdf0925cab5f0a9d~tplv-k3u1fbpfcp-watermark.image" alt="flow.png" loading="lazy" referrerpolicy="no-referrer"></p>
<h3 data-id="heading-4">2.3 åŸºæœ¬æ€è·¯</h3>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// 1. æ³¨å†Œå‘½ä»¤ vue init</span>
<span class="hljs-comment">// 2. ä¸‹è½½æ¨¡æ¿åˆ°ç¼“å­˜ç›®å½•</span>
<span class="hljs-comment">// 3. è·å–ç”¨æˆ·äº¤äº’æ•°æ® ç”Ÿæˆé¡¹ç›® </span>
<span class="hljs-comment">// 4.å®‰è£…ä¾èµ–</span>
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<h3 data-id="heading-5">2.4 ç®€å•å®ç°</h3>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// https://github.com/vuejs/vue-cli/tree/v2</span>
mkdir <span class="hljs-number">1.</span>vue-cli2 && cd <span class="hljs-number">1.</span>vue-cli2
npm init -y
<span class="hljs-comment">// å®‰è£…ä¸€äº›ä¾èµ–</span>
npm install commander chalk ora inquirer download-git-repo metalsmith handlebars consolidate <span class="hljs-keyword">async</span> minimatch

<span class="hljs-comment">// https://www.npmjs.com/package/download-git-repo ä¸‹è½½gitä¸Šä»“åº“ä»£ç </span>
<span class="hljs-keyword">const</span> download = <span class="hljs-built_in">require</span>(<span class="hljs-string">'download-git-repo'</span>) 
<span class="hljs-comment">// https://www.npmjs.com/package/commander å‘½ä»¤è¡Œ</span>
<span class="hljs-keyword">const</span> program = <span class="hljs-built_in">require</span>(<span class="hljs-string">'commander'</span>)
<span class="hljs-comment">// https://www.npmjs.com/package/ora æ˜¾ç¤ºloadingæ•ˆæœ</span>
<span class="hljs-keyword">const</span> ora = <span class="hljs-built_in">require</span>(<span class="hljs-string">'ora'</span>)
<span class="hljs-comment">// https://www.npmjs.com/package/inquirer ç”¨æˆ·äº¤äº’</span>
<span class="hljs-keyword">const</span> inquirer = <span class="hljs-built_in">require</span>(<span class="hljs-string">'inquirer'</span>)
<span class="hljs-comment">// https://www.npmjs.com/package/chalk è¾“å‡ºå½©è‰²æ–‡å­—</span>
<span class="hljs-keyword">const</span> chalk = <span class="hljs-built_in">require</span>(<span class="hljs-string">'chalk'</span>)
<span class="hljs-comment">// https://www.npmjs.com/package/metalsmith å¯æ’æ‹”çš„é™æ€ç«™ç‚¹ç”Ÿæˆå™¨</span>
<span class="hljs-keyword">const</span> Metalsmith = <span class="hljs-built_in">require</span>(<span class="hljs-string">'metalsmith'</span>)
<span class="hljs-comment">// https://www.npmjs.com/package/handlebars æ¨¡æ¿å¼•æ“</span>
<span class="hljs-keyword">const</span> Handlebars = <span class="hljs-built_in">require</span>(<span class="hljs-string">'handlebars'</span>)
<span class="hljs-comment">// https://www.npmjs.com/package/consolidate æ¨¡æ¿å¼•æ“çš„ç»“åˆä½“ã€‚åŒ…æ‹¬äº†å¸¸ç”¨çš„jadeå’Œejs</span>
<span class="hljs-keyword">const</span> render = <span class="hljs-built_in">require</span>(<span class="hljs-string">'consolidate'</span>).handlebars.render
<span class="hljs-comment">// https://www.npmjs.com/package/async for use with Node-style callbacks</span>
<span class="hljs-keyword">const</span> <span class="hljs-keyword">async</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">'async'</span>)
<span class="hljs-comment">// https://www.npmjs.com/package/minimatch åŒ¹é…æ–‡ä»¶</span>
<span class="hljs-keyword">const</span> match = <span class="hljs-built_in">require</span>(<span class="hljs-string">'minimatch'</span>)
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<ol>
<li>æ³¨å†Œå‘½ä»¤</li>
</ol>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// åœ¨package.jsonæ–‡ä»¶ä¸­å¢åŠ bin </span>
<span class="hljs-string">"bin"</span>: &#123;
  <span class="hljs-string">"vue-init"</span>: <span class="hljs-string">"bin/vue-init"</span>,
&#125;
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<ol start="2">
<li>vue-init.js</li>
</ol>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// æ ¹æ®ç”¨æˆ·é€‰é¡¹ä¸‹è½½æŒ‡å®šæ¨¡æ¿</span>
<span class="hljs-comment">// 1. è§£æå‘½ä»¤è¡Œå‚æ•°</span>
program
  .usage(<span class="hljs-string">'<template-name> [project-name]'</span>)
program.parse(process.argv)
<span class="hljs-comment">// template-name(webpack) vue init webpack hello</span>
<span class="hljs-keyword">const</span> template = program.args[<span class="hljs-number">0</span>]
<span class="hljs-comment">// é¡¹ç›®å hello</span>
<span class="hljs-keyword">const</span> rawName = program.args[<span class="hljs-number">1</span>]
<span class="hljs-comment">// /Users/liu/.vue-templates/webpack ä¼šåœ¨.vue-templatesç›®å½•ä¸‹çœ‹æ˜¯å¦æœ‰ç¼“å­˜</span>
<span class="hljs-keyword">const</span> tmp = path.join(home, <span class="hljs-string">'.vue-templates'</span>, template.replace(<span class="hljs-regexp">/[\/:]/g</span>, <span class="hljs-string">'-'</span>))
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// 2. æ‹‰å–templateä»£ç  è¿™é‡Œåªæ˜¯å°†templateæ¨¡æ¿æ‹‰å–ä¸‹æ¥äº† è¿˜æ²¡æœ‰ç”Ÿæˆæˆ‘ä»¬çš„é¡¹ç›®</span>
<span class="hljs-keyword">const</span> spinner = ora(<span class="hljs-string">'downloading template'</span>)
spinner.start()
<span class="hljs-keyword">const</span> officialTemplate = <span class="hljs-string">'vuejs-templates/'</span> + template
<span class="hljs-comment">// https://github.com/vuejs-templates/webpack</span>
<span class="hljs-comment">// ä¸‹è½½æ¨¡æ¿ webpack å°†webpack git clone åˆ° .vue-templates/webpackä¸­</span>
download(officialTemplate, tmp, &#123; clone &#125;, <span class="hljs-function"><span class="hljs-params">err</span> =></span> &#123;
  spinner.stop()
  generate(rawName, tmp, to, <span class="hljs-function"><span class="hljs-params">err</span> =></span> &#123;
    logger.success(<span class="hljs-string">'Generated "%s".'</span>, name)
  &#125;)
&#125;)
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/286944c9aa9142f697e083e82f8186ee~tplv-k3u1fbpfcp-watermark.image" alt="template.png" loading="lazy" referrerpolicy="no-referrer"></p>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// 3. ç”Ÿæˆé¡¹ç›® generate ç”¨æˆ·äº¤äº’ å¤„ç†templateç›®å½•ä¸­çš„å†…å®¹</span>
<span class="hljs-comment">// æœ€ç®€å•çš„å°±æ˜¯ä¸å¤„ç†ç”¨æˆ·çš„é€‰é¡¹ ç›´æ¥å°†æ•´ä¸ªé¡¹ç›®copyåˆ°æˆ‘ä»¬çš„ç›®å½•ä¸­</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">generate</span>(<span class="hljs-params">name, src, dest, done</span>) </span>&#123;
  <span class="hljs-comment">// 1. è·å–é€‰é¡¹ </span>
  <span class="hljs-keyword">const</span> js = path.join(src, <span class="hljs-string">"meta.js"</span>); <span class="hljs-comment">// æ‰¾åˆ° vuejs-templates/webpackä¸‹çš„meta.jsæ–‡ä»¶</span>
  <span class="hljs-keyword">const</span> req = <span class="hljs-built_in">require</span>(path.resolve(js));
  <span class="hljs-comment">// &#123;metalsmith:&#123; before: addTestAnswers&#125;, prompts, filters&#125;</span>
  <span class="hljs-keyword">const</span> opts = req;

  <span class="hljs-comment">// 2. metalsmith</span>
  <span class="hljs-keyword">const</span> metalsmith = Metalsmith(path.join(src, <span class="hljs-string">"template"</span>));
  <span class="hljs-keyword">const</span> data = <span class="hljs-built_in">Object</span>.assign(metalsmith.metadata(), &#123;
    <span class="hljs-attr">destDirName</span>: name,
    <span class="hljs-attr">inPlace</span>: dest === process.cwd(),
    <span class="hljs-attr">noEscape</span>: <span class="hljs-literal">true</span>,
  &#125;);

  <span class="hljs-comment">// 3. å¤„ç†ç”¨æˆ·äº¤äº’</span>
  metalsmith.use(askQuestions(opts.prompts))
  <span class="hljs-comment">// 4. æ ¹æ®ç”¨æˆ·çš„é€‰é¡¹è¿‡æ»¤ä¸€äº›æ–‡ä»¶</span>
  <span class="hljs-comment">// vue-cliæ˜¯filteræ–‡ä»¶ vue-cli4æä¾›çš„æ’ä»¶ä¸€èˆ¬æ˜¯æä¾›æœ€åŸºç¡€çš„templateæ–°å¢ä¸€äº›æ–‡ä»¶</span>
  .use(filterFiles(opts.filters))
  <span class="hljs-comment">// 5. buildæˆæœ€ç»ˆçš„æ–‡ä»¶</span>
  metalsmith
    .clean(<span class="hljs-literal">false</span>)
    .source(<span class="hljs-string">"."</span>) <span class="hljs-comment">// start from template root instead of `./src` which is Metalsmith's default for `source`</span>
    .destination(dest)
    .build(<span class="hljs-function">(<span class="hljs-params">err, files</span>) =></span> &#123;
      <span class="hljs-comment">// console.log(err, files)</span>
      done(err);
      <span class="hljs-comment">// installDependencies</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> opts.complete === <span class="hljs-string">'function'</span>) &#123;
        opts.complete(data, &#123;chalk&#125;)
      &#125;
    &#125;);
  <span class="hljs-keyword">return</span> data;
&#125; 
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9c1dbe4fdd1d4cc19ab5cc30e8e7d21d~tplv-k3u1fbpfcp-watermark.image" alt="meta.png" loading="lazy" referrerpolicy="no-referrer"></p>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// 3. å¤„ç†ç”¨æˆ·äº¤äº’</span>
metalsmith
  <span class="hljs-comment">// .use(askQuestions(opts.prompts))</span>
  <span class="hljs-comment">// è·å–ç”¨æˆ·çš„é€‰é¡¹</span>
  .use(<span class="hljs-function">(<span class="hljs-params">files, metalsmith, done</span>) =></span> &#123;
    <span class="hljs-comment">// ask(opts.prompts, metalsmith.metadata(), done)</span>
    <span class="hljs-keyword">async</span>.eachSeries(
      <span class="hljs-built_in">Object</span>.keys(opts.prompts),
      <span class="hljs-function">(<span class="hljs-params">key, next</span>) =></span> &#123;
        <span class="hljs-comment">// ä¼šåœ¨metadataä¸­æ·»åŠ å±æ€§</span>
        prompt(metalsmith.metadata(), key, opts.prompts[key], next);
      &#125;,
      done
    );
  &#125;)
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9c1dbe4fdd1d4cc19ab5cc30e8e7d21d~tplv-k3u1fbpfcp-watermark.image" alt="prompts.png" loading="lazy" referrerpolicy="no-referrer"></p>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// 4. æ ¹æ®ç”¨æˆ·çš„é€‰é¡¹è¿‡æ»¤ä¸€äº›æ–‡ä»¶</span>
<span class="hljs-comment">// vue-cliæ˜¯filteræ–‡ä»¶ vue-cli4æä¾›çš„æ’ä»¶ä¸€èˆ¬æ˜¯æä¾›æœ€åŸºç¡€çš„templateæ–°å¢ä¸€äº›æ–‡ä»¶</span>
metalsmith.use(<span class="hljs-function">(<span class="hljs-params">files, metalsmith, done</span>) =></span> &#123;
  <span class="hljs-comment">// filter(files, opts.filters, metalsmith.metadata(), done)</span>
  <span class="hljs-keyword">const</span> fileNames = <span class="hljs-built_in">Object</span>.keys(files);
  <span class="hljs-built_in">Object</span>.keys(opts.filters).forEach(<span class="hljs-function">(<span class="hljs-params">glob</span>) =></span> &#123;
    fileNames.forEach(<span class="hljs-function">(<span class="hljs-params">file</span>) =></span> &#123;
      <span class="hljs-keyword">if</span> (match(file, glob, &#123; <span class="hljs-attr">dot</span>: <span class="hljs-literal">true</span> &#125;)) &#123;
        <span class="hljs-keyword">const</span> condition = opts.filters[glob];
        <span class="hljs-keyword">const</span> fn = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Function</span>(
          <span class="hljs-string">"data"</span>,
          <span class="hljs-string">"with (data) &#123; return "</span> + condition + <span class="hljs-string">"&#125;"</span>
        );
        <span class="hljs-keyword">if</span> (!fn(metalsmith.metadata())) &#123;
          <span class="hljs-keyword">delete</span> files[file];
        &#125;
      &#125;
    &#125;);
  &#125;);
  done();
&#125;)
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c17330617546476896a35867a86e9c91~tplv-k3u1fbpfcp-watermark.image" alt="metadata.png" loading="lazy" referrerpolicy="no-referrer"></p>
<ol start="3">
<li>meta.js</li>
</ol>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// æˆ‘ä»¬æœ‰å¾ˆå¤šçš„é€»è¾‘æ˜¯è¦meta.jsä¸­å¤„ç†çš„</span>
<span class="hljs-comment">// https://github.com/vuejs-templates/webpack/blob/develop/meta.js</span>
<span class="hljs-built_in">module</span>.exports = &#123;
  <span class="hljs-attr">metalsmith</span>: &#123;
    <span class="hljs-comment">// When running tests for the template, this adds answers for the selected scenario</span>
    <span class="hljs-attr">before</span>: addTestAnswers
  &#125;,
  <span class="hljs-attr">prompts</span>: &#123;&#125;,
  <span class="hljs-attr">filters</span>: &#123;&#125;
  <span class="hljs-comment">// å®Œæˆä¹‹åå®‰è£…ä¾èµ–</span>
  <span class="hljs-attr">complete</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">data, &#123; chalk &#125;</span>) </span>&#123;
    <span class="hljs-keyword">const</span> green = chalk.green
    sortDependencies(data, green)
    <span class="hljs-keyword">const</span> cwd = path.join(process.cwd(), data.destDirName)
    <span class="hljs-comment">// runCommand(executable, ['install'], &#123;cwd&#125;)</span>
    <span class="hljs-comment">// ä½¿ç”¨nodeçš„spawn const spawn = require('child_process').spawn</span>
    <span class="hljs-comment">// spawn()</span>
    installDependencies(cwd, data.autoInstall, green)
      .then(<span class="hljs-function">() =></span> &#123;
        <span class="hljs-keyword">return</span> runLintFix(cwd, data, green)
      &#125;)
      .then(<span class="hljs-function">() =></span> &#123;
        printMessage(data, green)
      &#125;)
      .catch(<span class="hljs-function"><span class="hljs-params">e</span> =></span> &#123;
        <span class="hljs-built_in">console</span>.log(chalk.red(<span class="hljs-string">'Error:'</span>), e)
      &#125;)
  &#125;,
&#125;
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<ol start="4">
<li>å¤„ç†ç¼“å­˜</li>
</ol>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// æˆ‘ä»¬é€šè¿‡templateçš„å‘½ä»¤å»æ‹‰å–æ¨¡æ¿æ–‡ä»¶ ä½†æ˜¯å½“æˆ‘ä»¬æœ¬åœ°å­˜åœ¨çš„æ—¶å€™å¯ä»¥ç›´æ¥ä½¿ç”¨ .vue-templateä¸­çš„èµ„æº</span>
<span class="hljs-keyword">if</span> (exists(templatePath)) &#123;
  <span class="hljs-comment">// å½“å­˜åœ¨çš„æ—¶å€™å°±ç›´æ¥ generateè€Œä¸ä¼šå»download</span>
  generate()
&#125;

<span class="hljs-number">5.</span> gitee
<span class="hljs-string">``</span><span class="hljs-string">`js
// å¦‚æœæˆ‘ä»¬éœ€è¦è‡ªå·±ä¸‹è½½gitä»“åº“çš„æ¨¡æ¿ giteeçš„apiæ–‡æ¡£
const gitUrl = `</span>https:<span class="hljs-comment">//gitee.com/api/v5/orgs/$&#123;org&#125;/repos`;</span>
<span class="hljs-comment">// giteeå¯ä»¥ä½¿ç”¨ ä¸ªäººè§‰å¾—å®ç°ä¸å¤Ÿå‹å¥½ æ˜¯å¯¹download-git-repoçš„æ‰©å±•</span>
<span class="hljs-comment">// æœŸå¾…gitee ç‹åœ£æ¾ å¤§ä½¬æä¾›æ›´å¥½çš„npmåŒ…</span>
npm install zdex-downloadgitrepo
<span class="hljs-comment">// ç®€å•å®ç°</span>
<span class="hljs-comment">// https://gitee.com/vue-next/vue3-cli/tree/v2.0</span>
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<h3 data-id="heading-6">2.5 npmåŒ…å‘å¸ƒ</h3>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// 1. è°ƒè¯•</span>
npm link
ibox-vue-init webpack hello
<span class="hljs-comment">// 2. å‘å¸ƒnpmåŒ…</span>
npm login (npm whoami)
npm publish
<span class="hljs-comment">// You must sign up for private packages</span>
npm publish --access public
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<h2 data-id="heading-7">3. vite</h2>
<h3 data-id="heading-8">3.1 åˆå§‹åŒ–é¡¹ç›®</h3>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// https://cn.vitejs.dev/</span>
<span class="hljs-comment">// viteä¸åœ¨æœ¬æ–‡è€ƒè™‘èŒƒå›´å†… æˆ‘ä»¬åªæ˜¯åˆ†æ viteä¸­ create-viteåŒ…çš„å®ç°</span>
<span class="hljs-comment">// viteé‡‡ç”¨äº†monorepoçš„ç®¡ç†æ–¹å¼ viteçš„å®ç°åœ¨æ„å»ºç¯‡åˆ†æ è¿™é‡Œä¸åˆ†æå…·ä½“çš„å®ç°</span>
<span class="hljs-comment">// æŒ‡ä»¤ä¼šå…ˆå®‰è£…create-vite æ‰§è¡Œ</span>
yarn create vite
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/495eb2bbaafb4928a945d666de3dc864~tplv-k3u1fbpfcp-watermark.image" alt="vitejs.png" loading="lazy" referrerpolicy="no-referrer"></p>
<h3 data-id="heading-9">3.2 åŸºæœ¬æµç¨‹</h3>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// 1. è¾“å‡ºé¡¹ç›®åç§°</span>
<span class="hljs-comment">// 2. é€‰æ‹©æ¡†æ¶</span>
<span class="hljs-comment">// 3. é€‰æ‹©variant æ˜¯å¦éœ€è¦ts</span>
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<h3 data-id="heading-10">3.3 åŸºæœ¬æ€è·¯</h3>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// https://github.com/vitejs/vite/tree/main/packages/create-vite</span>
<span class="hljs-comment">// create-viteçš„å®ç°æ¯”è¾ƒç®€å• å°±æ˜¯æ ¹æ®é€‰é¡¹ç›´æ¥ä»é¡¹ç›®ä¸­æ‹‰å–æ–‡ä»¶</span>
template-vue-ts
template-vue
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/22cca2f843a04cdfa40233bff12020ca~tplv-k3u1fbpfcp-watermark.image" alt="template.png" loading="lazy" referrerpolicy="no-referrer"></p>
<h3 data-id="heading-11">3.4 ç®€å•å®ç°</h3>
<ol>
<li>åˆå§‹åŒ–é¡¹ç›®</li>
</ol>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// æˆ‘ä»¬åªæ˜¯ç®€å•å®ç° crete-viteå°±ä¸ä½¿ç”¨ lernaåˆå§‹åŒ–é¡¹ç›®äº†</span>
npm init -y
<span class="hljs-comment">// å¢åŠ binå­—æ®µ</span>
<span class="hljs-string">"bin"</span>: &#123;
  <span class="hljs-string">"create-box-vite"</span>: <span class="hljs-string">"index.js"</span>,
  <span class="hljs-string">"ibox-cva"</span>: <span class="hljs-string">"index.js"</span>
&#125;,
<span class="hljs-comment">// æ³¨æ„ âš ï¸ æˆ‘ä»¬è¦åŠ ä¸Šfileså­—æ®µ</span>
<span class="hljs-comment">// å®‰è£…ä¾èµ–</span>
npm install minimist prompts kolorist
<span class="hljs-comment">// https://www.npmjs.com/package/minimist è½»é‡çº§çš„å‘½ä»¤è¡Œå‚æ•°è§£æ commander</span>
<span class="hljs-keyword">const</span> argv = <span class="hljs-built_in">require</span>(<span class="hljs-string">"minimist"</span>)(process.argv.slice(<span class="hljs-number">2</span>));
<span class="hljs-comment">// https://www.npmjs.com/package/prompts ç”¨æˆ·äº¤äº’ inquirer.prompt</span>
<span class="hljs-keyword">const</span> prompts = <span class="hljs-built_in">require</span>(<span class="hljs-string">"prompts"</span>);
<span class="hljs-comment">// https://www.npmjs.com/package/kolorist è½»é‡å‘½ä»¤è¡Œè¾“å‡ºå·¥å…·  chalk</span>
<span class="hljs-keyword">const</span> &#123; blue &#125; = <span class="hljs-built_in">require</span>(<span class="hljs-string">"kolorist"</span>);
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<ol start="2">
<li>index.js</li>
</ol>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// 1. å®šä¹‰æˆ‘ä»¬æ”¯æŒçš„æ¡†æ¶åˆ—è¡¨ ç®€åŒ–ä¸ºåªæ”¯æŒvueå’Œreact</span>
<span class="hljs-keyword">const</span> FRAMEWORKS = [
  &#123;
    <span class="hljs-attr">name</span>: <span class="hljs-string">'vue'</span>,
    <span class="hljs-attr">color</span>: green,
    <span class="hljs-attr">variants</span>: [
      &#123;
        <span class="hljs-attr">name</span>: <span class="hljs-string">'vue'</span>,
        <span class="hljs-attr">display</span>: <span class="hljs-string">'JavaScript'</span>,
        <span class="hljs-attr">color</span>: yellow
      &#125;,
      &#123;
        <span class="hljs-attr">name</span>: <span class="hljs-string">'vue-ts'</span>,
        <span class="hljs-attr">display</span>: <span class="hljs-string">'TypeScript'</span>,
        <span class="hljs-attr">color</span>: blue
      &#125;
    ]
  &#125;,
  &#123;
    <span class="hljs-attr">name</span>: <span class="hljs-string">'react'</span>,
    <span class="hljs-attr">color</span>: cyan,
    <span class="hljs-attr">variants</span>: [
      &#123;
        <span class="hljs-attr">name</span>: <span class="hljs-string">'react'</span>,
        <span class="hljs-attr">display</span>: <span class="hljs-string">'JavaScript'</span>,
        <span class="hljs-attr">color</span>: yellow
      &#125;,
      &#123;
        <span class="hljs-attr">name</span>: <span class="hljs-string">'react-ts'</span>,
        <span class="hljs-attr">display</span>: <span class="hljs-string">'TypeScript'</span>,
        <span class="hljs-attr">color</span>: blue
      &#125;
    ]
  &#125;
]
<span class="hljs-comment">// [ 'vue', 'vue-ts', 'react', 'react-ts' ] </span>
<span class="hljs-keyword">const</span> TEMPLATES = FRAMEWORKS.map(
  <span class="hljs-function">(<span class="hljs-params">f</span>) =></span> (f.variants && f.variants.map(<span class="hljs-function">(<span class="hljs-params">v</span>) =></span> v.name)) || [f.name]
).reduce(<span class="hljs-function">(<span class="hljs-params">a, b</span>) =></span> a.concat(b), [])


<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">init</span>(<span class="hljs-params"></span>) </span>&#123;
  <span class="hljs-comment">// 2. ç­‰å¾…ç”¨æˆ·é€‰æ‹©ç»“æœ projectName framework variant</span>
  <span class="hljs-keyword">let</span> result = <span class="hljs-keyword">await</span> prompts([])
  <span class="hljs-keyword">const</span> &#123; framework, packageName, variant &#125; = result
  template = variant || framework || template
  <span class="hljs-comment">// 3.æ ¹æ®ç”¨æˆ·çš„é€‰é¡¹æ‰¾åˆ° å¯¹åº”çš„ template æ¨¡æ¿æ–‡ä»¶</span>
  <span class="hljs-keyword">const</span> templateDir = path.join(__dirname, <span class="hljs-string">`template-<span class="hljs-subst">$&#123;template&#125;</span>`</span>)
  <span class="hljs-comment">// 4.å°†æ–‡ä»¶éå†copyåˆ°æˆ‘ä»¬çš„ç›®å½•ä¸­</span>
  <span class="hljs-keyword">const</span> files = fs.readdirSync(templateDir)
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> file <span class="hljs-keyword">of</span> files.filter(<span class="hljs-function">(<span class="hljs-params">f</span>) =></span> f !== <span class="hljs-string">'package.json'</span>)) &#123;
    write(file)
  &#125;
  <span class="hljs-comment">// å•ç‹¬å¤„ç†package.jsonæ–‡ä»¶ è¦æ·»åŠ nameå±æ€§</span>
  <span class="hljs-comment">// .gitignore æ–‡ä»¶éœ€è¦ renameFiles .å¼€å¤´çš„æ–‡ä»¶ä¼šå‡ºé—®é¢˜</span>
&#125;
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<ol start="3">
<li>templateæ–‡ä»¶</li>
</ol>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// æˆ‘ä»¬å¯ä»¥ç”¨è‡ªå·±çš„æœ€ä½³å®è·µ ç›´æ¥æ‹·è´viteçš„å†…å®¹</span>
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<h3 data-id="heading-12">3.5 npmåŒ…å‘å¸ƒ</h3>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// i-box/create-vite@0.0.1</span>
<span class="hljs-comment">// åŒ…åæ˜¯ @i-box/create-box-vite ä¸éœ€è¦create yarn addåšäº†ä»€ä¹ˆ?</span>
<span class="hljs-comment">// æ‰§è¡Œ yarn create @i-box/box-vite</span>
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a8449388f870479f85e89a2ea7ae4f48~tplv-k3u1fbpfcp-watermark.image" alt="result.png" loading="lazy" referrerpolicy="no-referrer"></p>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e15c2f133b054bb7bb3edcc808f71a5d~tplv-k3u1fbpfcp-watermark.image" alt="yarn.png" loading="lazy" referrerpolicy="no-referrer"></p>
<h2 data-id="heading-13">4. cra</h2>
<h3 data-id="heading-14">4.1 åˆå§‹åŒ–é¡¹ç›®</h3>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// https://github.com/facebook/create-react-app</span>
npx create-react-app react-demo
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/8aa0c9c6535f4127a120c32893c555be~tplv-k3u1fbpfcp-watermark.image" alt="cra.png" loading="lazy" referrerpolicy="no-referrer"></p>
<h3 data-id="heading-15">4.2 åŸºæœ¬æµç¨‹</h3>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// 1. åˆ›å»ºé¡¹ç›® mkdir my-app</span>
Creating a <span class="hljs-keyword">new</span> React app <span class="hljs-keyword">in</span> /Users/liu/my-app.
<span class="hljs-comment">// 2.åˆå§‹åŒ–npmæŒ‰ç…§ä¾èµ– </span>
<span class="hljs-comment">// cd my-app npm init -y</span>
<span class="hljs-comment">// yarn add react react-dom react-scripts cra-template</span>
Installing packages. This might take a couple <span class="hljs-keyword">of</span> minutes.
Installing react, react-dom, and react-scripts <span class="hljs-keyword">with</span> cra-template...

yarn add v1<span class="hljs-number">.22</span><span class="hljs-number">.10</span>
[<span class="hljs-number">1</span>/<span class="hljs-number">4</span>] ğŸ”  Resolving packages...
[<span class="hljs-number">2</span>/<span class="hljs-number">4</span>] ğŸšš  Fetching packages...
[<span class="hljs-number">3</span>/<span class="hljs-number">4</span>] ğŸ”—  Linking dependencies...
[<span class="hljs-number">4</span>/<span class="hljs-number">4</span>] ğŸ”¨  Building fresh packages...
success Saved lockfile.
â”œâ”€ cra-template@<span class="hljs-number">1.1</span><span class="hljs-number">.2</span>
â”œâ”€ react-dom@<span class="hljs-number">17.0</span><span class="hljs-number">.2</span>
â”œâ”€ react-scripts@<span class="hljs-number">4.0</span><span class="hljs-number">.3</span>
â””â”€ react@<span class="hljs-number">17.0</span><span class="hljs-number">.2</span>
info All dependencies
â”œâ”€ cra-template@<span class="hljs-number">1.1</span><span class="hljs-number">.2</span>
â”œâ”€ immer@<span class="hljs-number">8.0</span><span class="hljs-number">.1</span>
â”œâ”€ react-dev-utils@<span class="hljs-number">11.0</span><span class="hljs-number">.4</span>
â”œâ”€ react-dom@<span class="hljs-number">17.0</span><span class="hljs-number">.2</span>
â”œâ”€ react-scripts@<span class="hljs-number">4.0</span><span class="hljs-number">.3</span>
â”œâ”€ react@<span class="hljs-number">17.0</span><span class="hljs-number">.2</span>
â””â”€ scheduler@<span class="hljs-number">0.20</span><span class="hljs-number">.2</span>
âœ¨  Done <span class="hljs-keyword">in</span> <span class="hljs-number">20.</span>65s.

<span class="hljs-comment">// 3.åˆå§‹åŒ–gitä»“åº“ git init</span>
Initialized a git repository.
<span class="hljs-comment">// 4.ä½¿ç”¨yarnå®‰è£…æ¨¡æ¿ cra-template</span>
Installing template dependencies using yarnpkg...
yarn add v1<span class="hljs-number">.22</span><span class="hljs-number">.10</span>
[<span class="hljs-number">1</span>/<span class="hljs-number">4</span>] ğŸ”  Resolving packages...
[<span class="hljs-number">2</span>/<span class="hljs-number">4</span>] ğŸšš  Fetching packages...
[<span class="hljs-number">3</span>/<span class="hljs-number">4</span>] ğŸ”—  Linking dependencies...
[<span class="hljs-number">4</span>/<span class="hljs-number">4</span>] ğŸ”¨  Building fresh packages...
success Saved lockfile.
success Saved <span class="hljs-number">17</span> <span class="hljs-keyword">new</span> dependencies.
<span class="hljs-comment">// 5.å®‰è£…æ¨¡ç‰ˆä¹‹åå°†cra-template removeæ‰</span>
Removing template package using yarnpkg...
yarn remove v1<span class="hljs-number">.22</span><span class="hljs-number">.10</span>
[<span class="hljs-number">1</span>/<span class="hljs-number">2</span>] ğŸ—‘  Removing <span class="hljs-built_in">module</span> cra-template...
[<span class="hljs-number">2</span>/<span class="hljs-number">2</span>] ğŸ”¨  Regenerating lockfile and installing missing dependencies...
success Uninstalled packages.
âœ¨  Done <span class="hljs-keyword">in</span> <span class="hljs-number">7.</span>42s.
<span class="hljs-comment">// 6.åˆ›å»ºgitçš„commit</span>
Created git commit.
<span class="hljs-comment">// æˆåŠŸ</span>
Success! Created my-app at /Users/liu/my-app
Inside that directory, you can run several commands:
<span class="hljs-comment">// 7. å¯ä»¥è¿è¡Œçš„å‘½ä»¤ build start</span>
  yarn start
    Starts the development server.

  yarn build
    Bundles the app into <span class="hljs-keyword">static</span> files <span class="hljs-keyword">for</span> production.

We suggest that you begin by typing:

  cd my-app
  yarn start

Happy hacking!
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<h3 data-id="heading-16">4.3 å®ç°åŸºæœ¬æ€è·¯</h3>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// 1. å®‰è£… react react-dom react-scripts cra-template</span>
<span class="hljs-comment">// 2. å®‰è£… cra-template  æ¨¡æ¿æ–‡ä»¶</span>
<span class="hljs-comment">// 3. å¸è½½ cra-template</span>
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<h3 data-id="heading-17">4.4 ç®€å•å®ç°</h3>
<ol>
<li>é¡¹ç›®åˆå§‹åŒ–</li>
</ol>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// ä½¿ç”¨lernaåˆå§‹åŒ–</span>
lerna init
<span class="hljs-comment">// åˆ›å»ºå­é¡¹ç›®</span>
<span class="hljs-comment">// åˆ›å»ºé¡¹ç›® ä¸»è¦åˆ†æè¿™ä¸ªåŒ…</span>
lerna create @i-box/create-ibox-react-app
<span class="hljs-comment">// æ¨¡æ¿æ–‡ä»¶</span>
lerna create @i-box/ibox-cra-template
<span class="hljs-comment">// è„šæœ¬ æˆ‘ä»¬æ‰§è¡Œ "start": "react-scripts start", webpackæœ€ä½³å®è·µ æš‚ä¸åˆ†ææ”¹éƒ¨åˆ†</span>
lerna create @i-box/ibox-react-scripts

<span class="hljs-comment">// åœ¨package.jsonä¸­æ·»åŠ </span>
<span class="hljs-string">"workspaces"</span>: [
  <span class="hljs-string">"packages/*"</span>
],
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<ol start="2">
<li>craæºç è°ƒè¯•</li>
</ol>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// 1. ä¸‹è½½æºç   https://github.com/facebook/create-react-app</span>
<span class="hljs-comment">// 2. æ‰§è¡Œyarn æŒ‰ç…§ä¾èµ– åˆ›å»ºé“¾æ¥</span>
<span class="hljs-comment">// 3. .vscode\launch.jsonä¸­é…ç½®</span>
&#123;
  <span class="hljs-string">"version"</span>: <span class="hljs-string">"0.2.0"</span>,
  <span class="hljs-string">"configurations"</span>: [
    &#123;
      <span class="hljs-string">"name"</span>: <span class="hljs-string">"Launch via NPM"</span>,
      <span class="hljs-string">"request"</span>: <span class="hljs-string">"launch"</span>,
      <span class="hljs-string">"runtimeArgs"</span>: [<span class="hljs-string">"run-script"</span>, <span class="hljs-string">"create"</span>],
      <span class="hljs-string">"runtimeExecutable"</span>: <span class="hljs-string">"npm"</span>,
      <span class="hljs-string">"skipFiles"</span>: [<span class="hljs-string">"<node_internals>/**"</span>],
      <span class="hljs-string">"type"</span>: <span class="hljs-string">"pwa-node"</span>
    &#125;
  ]
&#125;
<span class="hljs-comment">// 4. åœ¨package.jsonä¸­æ–°å¢è„šæœ¬</span>
<span class="hljs-string">"create"</span>: <span class="hljs-string">"node ./packages/create-react-app/index.js hello-world"</span>,
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<ol start="3">
<li>create-ibox-react-app</li>
</ol>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// ä¸»è¦å®ç°è¿™ä¸ªåŒ…</span>
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<ol start="4">
<li>cra-template</li>
</ol>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// è¿™æ˜¯ä¸€ä¸ªæ¨¡æ¿æ–‡ä»¶ æˆ‘ä»¬å¯ä»¥ç›´æ¥æ‹·è´ craä»“åº“ä¸­çš„ä»£ç </span>
templateç›®å½•å’Œtemplate.jsonæ–‡ä»¶
<span class="hljs-comment">// æˆ‘ä»¬éœ€è¦åœ¨package.jsonä¸­æŒ‡å®šfiles</span>
<span class="hljs-string">"files"</span>: [
  <span class="hljs-string">"template"</span>,
  <span class="hljs-string">"template.json"</span>
],
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<ol start="5">
<li>react-script</li>
</ol>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// è¿™æ˜¯ä¸€ä¸ªæ¯”è¾ƒæ ¸å¿ƒçš„åŒ… å’Œvueä¸­çš„vue-cli-serviceç±»ä¼¼</span>
<span class="hljs-comment">// webpackæœ€ä½³å®è·µ ä½†æ˜¯å¥½åƒä¸æ”¯æŒæ’ä»¶ç³»ç»Ÿ</span>
<span class="hljs-comment">// react-app-rewiredæ˜¯å¦‚ä½•ä¿®æ”¹webpacké…ç½®çš„</span>
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<h3 data-id="heading-18">4.5  create-ibox-react-app</h3>
<ol>
<li>é¡¹ç›®åˆå§‹åŒ–</li>
</ol>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// 1. åœ¨package.jsonä¸­æ–°å¢binç›®å½•</span>
<span class="hljs-string">"bin"</span>: &#123; 
  <span class="hljs-string">"ibox-react-app"</span>: <span class="hljs-string">"./index.js"</span>,
  <span class="hljs-string">"ibox-cra"</span>: <span class="hljs-string">"./index.js"</span> 
&#125;
<span class="hljs-comment">// 2. å®‰è£…ä¾èµ–</span>
yarn workspace @i-box/create-ibox-react-app add  chalk  commander fs-extra cross-spawn
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<ol start="2">
<li>index.js</li>
</ol>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-meta">#!/usr/bin/env node</span>

<span class="hljs-keyword">const</span> &#123; init &#125; = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./createReactApp"</span>);
init();
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<ol start="3">
<li>createReactApp</li>
</ol>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">init</span>(<span class="hljs-params"></span>) </span>&#123;
  <span class="hljs-comment">// 1. è§£æå‚æ•°</span>
  <span class="hljs-keyword">const</span> program = <span class="hljs-keyword">new</span> commander.Command(packageJson.name)
    .version(packageJson.version)
    .arguments(<span class="hljs-string">"<project-directory>"</span>)
    .usage(<span class="hljs-string">`<span class="hljs-subst">$&#123;chalk.green(<span class="hljs-string">"<project-directory>"</span>)&#125;</span> [options]`</span>)
    .action(<span class="hljs-function">(<span class="hljs-params">name</span>) =></span> &#123;
      projectName = name;
    &#125;)
    .parse(process.argv);
  createApp(
    projectName,
    program.verbose,
    program.scriptsVersion,
    program.template,
    program.useNpm,
    program.usePnp
  );
&#125;
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<ol start="4">
<li>createApp</li>
</ol>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">createApp</span>(<span class="hljs-params">name, verbose, version, template, useNpm, usePnp</span>) </span>&#123;
  <span class="hljs-keyword">const</span> root = path.resolve(name);
  <span class="hljs-keyword">const</span> appName = path.basename(root);
  fs.ensureDirSync(name); <span class="hljs-comment">// // mkdir my-app</span>

  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`Creating a new React app in <span class="hljs-subst">$&#123;chalk.green(root)&#125;</span>.`</span>);
  <span class="hljs-keyword">const</span> packageJson = &#123;
    <span class="hljs-attr">name</span>: appName,
    <span class="hljs-attr">version</span>: <span class="hljs-string">'0.1.0'</span>,
    <span class="hljs-attr">private</span>: <span class="hljs-literal">true</span>,
  &#125;;
  <span class="hljs-comment">// å†™å…¥package.jsonæ–‡ä»¶</span>
  fs.writeFileSync(
    path.join(root, <span class="hljs-string">'package.json'</span>),
    <span class="hljs-built_in">JSON</span>.stringify(packageJson, <span class="hljs-literal">null</span>, <span class="hljs-number">2</span>) + os.EOL
  );
  <span class="hljs-keyword">const</span> originalDirectory = process.cwd();
  <span class="hljs-comment">// åˆ‡æ¢ç›®å½•</span>
  process.chdir(root);
  <span class="hljs-comment">// æ‰§è¡Œrunæ–¹æ³• ä¸»è¦å°±æ˜¯å®‰è£…å››ä¸ªåŒ…</span>
  <span class="hljs-keyword">await</span> run(root, appName, originalDirectory);
&#125; 
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<ol start="5">
<li>run</li>
</ol>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">run</span>(<span class="hljs-params">root, appName, originalDirectory</span>) </span>&#123;
  <span class="hljs-comment">// æˆ‘ä»¬å…ˆä½¿ç”¨å®˜æ–¹çš„åŒ…</span>
  <span class="hljs-keyword">const</span> scriptName = <span class="hljs-string">"react-scripts"</span>;
  <span class="hljs-keyword">const</span> templateName = <span class="hljs-string">"cra-template"</span>; <span class="hljs-comment">// æ¨¡ç‰ˆå…¶å®æ˜¯å¯ä»¥é…ç½®çš„</span>
  <span class="hljs-keyword">const</span> allDependencies = [<span class="hljs-string">"react"</span>, <span class="hljs-string">"react-dom"</span>, scriptName, templateName];
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Installing packages. This might take a couple of minutes."</span>);
  <span class="hljs-built_in">console</span>.log(
    <span class="hljs-string">`Installing <span class="hljs-subst">$&#123;chalk.cyan(<span class="hljs-string">"react"</span>)&#125;</span>, <span class="hljs-subst">$&#123;chalk.cyan(
      <span class="hljs-string">"react-dom"</span>
    )&#125;</span>, and <span class="hljs-subst">$&#123;chalk.cyan(scriptName)&#125;</span> with <span class="hljs-subst">$&#123;chalk.cyan(templateName)&#125;</span>`</span>
  );
  <span class="hljs-keyword">await</span> install(root, allDependencies);
  <span class="hljs-comment">// å®‰è£…å®Œä¹‹å create-react-appåŒ…çš„åŠŸèƒ½åŸºæœ¬å°±å®Œæˆäº†</span>
  <span class="hljs-comment">// æ¥ä¸‹æ¥è¦å»react-scriptsåŒ…å»æ‰§è¡Œç›¸å…³é€»è¾‘</span>
  <span class="hljs-keyword">let</span> data = [root, appName, <span class="hljs-literal">true</span>, originalDirectory, templateName];
  <span class="hljs-keyword">let</span> source = <span class="hljs-string">`
    var init = require('react-scripts/scripts/init.js');
    init.apply(null, JSON.parse(process.argv[1]));
  `</span>;
  <span class="hljs-comment">// æ‰§è¡Œnodeå‘½ä»¤  react-scriptåŒ…ä¸­scriptsç›®å½•ä¸‹çš„init.js</span>
  <span class="hljs-keyword">await</span> executeNodeScript(&#123; <span class="hljs-attr">cwd</span>: process.cwd() &#125;, data, source);
  process.exit(<span class="hljs-number">0</span>);
&#125;

<span class="hljs-comment">// æ‰§è¡Œ react-scriptsä¸­çš„è„šæœ¬æ–‡ä»¶ åé¢çš„æ­¥éª¤ä¹Ÿæ˜¯åœ¨è¿™é‡Œé¢å¤„ç†çš„</span>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">executeNodeScript</span>(<span class="hljs-params">&#123; cwd &#125;, data, source</span>) </span>&#123;
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =></span> &#123;
    <span class="hljs-keyword">const</span> child = spawn(
      process.execPath,
      [<span class="hljs-string">"-e"</span>, source, <span class="hljs-string">"--"</span>, <span class="hljs-built_in">JSON</span>.stringify(data)],
      &#123; cwd, <span class="hljs-attr">stdio</span>: <span class="hljs-string">"inherit"</span> &#125;
    );
    child.on(<span class="hljs-string">"close"</span>, resolve);
  &#125;);
&#125;
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<ol start="6">
<li>install</li>
</ol>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">install</span>(<span class="hljs-params">root, allDependencies</span>) </span>&#123;
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =></span> &#123;
    <span class="hljs-keyword">const</span> command = <span class="hljs-string">"yarnpkg"</span>;
    <span class="hljs-comment">// æ‹¼æ¥å‚æ•°</span>
    <span class="hljs-keyword">const</span> args = [<span class="hljs-string">"add"</span>, <span class="hljs-string">"--exact"</span>, ...allDependencies, <span class="hljs-string">"--cwd"</span>, root];
    <span class="hljs-comment">// æ‰§è¡Œyarn add spawnè·¨å¹³å°çš„å¼€å¯å­è¿›ç¨‹çš„åŒ…</span>
    <span class="hljs-keyword">const</span> child = spawn(command, args, &#123; <span class="hljs-attr">stdio</span>: <span class="hljs-string">"inherit"</span> &#125;);
    child.on(<span class="hljs-string">"close"</span>, resolve);
  &#125;);
&#125;
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<h3 data-id="heading-19">4.6  react-scripts</h3>
<ol>
<li>åˆå§‹åŒ–é¡¹ç›®</li>
</ol>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// react-scriptåˆ†ä¸ºä¸¤éƒ¨åˆ†æ¥å®ç°</span>
<span class="hljs-comment">// 1.ç»§ç»­create-react-app runæ–¹æ³•ä¸­installä¹‹åçš„é€»è¾‘ æ‰§è¡Œ scriptsä¸­çš„init.js</span>
<span class="hljs-comment">// 2.ä½œä¸ºå‘½ä»¤æ¥ä½¿ç”¨ react-scripts start (yarn start) æš‚ä¸åˆ†æ</span>


<span class="hljs-comment">// å®‰è£…ä¾èµ–</span>
yarn workspace @i-box/ibox-react-scripts add  react react-dom
yarn workspace @i-box/ibox-react-scripts add  cross-spawn fs-extra chalk webpack webpack-dev-server babel-loader babel-preset-react-app html-webpack-plugin  open

<span class="hljs-comment">// åœ¨package.jsonæ–‡ä»¶ä¸­é…ç½®binå’Œscriptsè„šæœ¬</span>
<span class="hljs-string">"bin"</span>: &#123;
  <span class="hljs-string">"rs"</span>: <span class="hljs-string">"./bin/react-scripts.js"</span>
&#125;,
<span class="hljs-string">"files"</span>: [
  <span class="hljs-string">"bin"</span>,
  <span class="hljs-string">"scripts"</span>
],
<span class="hljs-string">"scripts"</span>: &#123;
  <span class="hljs-string">"build"</span>: <span class="hljs-string">"node ./bin/react-scripts build"</span>,
  <span class="hljs-string">"start"</span>: <span class="hljs-string">"node ./bin/react-scripts start"</span>
&#125;,
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<ol start="2">
<li>scriptsä¸­çš„init.jsæ–¹æ³•</li>
</ol>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// æˆ‘ä»¬éœ€è¦å®Œæˆäº‹</span>
<span class="hljs-comment">// ä¿®æ”¹package.jsonå†…å®¹(å¢åŠ è„šæœ¬å‘½ä»¤)</span>
<span class="hljs-comment">// æ‹·è´cra-templateå†…å®¹ </span>
<span class="hljs-comment">// åˆå§‹åŒ–ä»“åº“</span>
<span class="hljs-comment">// å®‰è£…cra-templateä¸­ä¾èµ– template.jsonæ–‡ä»¶</span>
<span class="hljs-comment">// å¸è½½cra-template</span>
<span class="hljs-built_in">module</span>.exports = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">
  appPath, <span class="hljs-comment">// path.resolve(appName)</span>
  appName, <span class="hljs-comment">// my-app</span>
  verbose,
  originalDirectory, <span class="hljs-comment">// process.cwd()</span>
  templateName <span class="hljs-comment">// cra-template</span>
</span>) </span>&#123;
  <span class="hljs-comment">// æ‹¿åˆ°é¡¹ç›®ä¸­çš„package.jsonæ–‡ä»¶</span>
  <span class="hljs-keyword">const</span> appPackage = <span class="hljs-built_in">require</span>(path.join(appPath, <span class="hljs-string">"package.json"</span>));
  <span class="hljs-comment">// å…ˆæ‹¿åˆ°æ¨¡æ¿ä¸­çš„package.jsonæ–‡ä»¶ å°†package.jsonçš„å†…å®¹åšä¸€ä¸ªåˆå¹¶ merge</span>
  <span class="hljs-keyword">const</span> templatePath = path.dirname(
    <span class="hljs-built_in">require</span>.resolve(<span class="hljs-string">`<span class="hljs-subst">$&#123;templateName&#125;</span>/package.json`</span>, &#123; <span class="hljs-attr">paths</span>: [appPath] &#125;)
  );
  <span class="hljs-comment">// åœ¨package.jsonæ–‡ä»¶ä¸­æ–°å¢å‡ ä¸ªå‘½ä»¤ start build test eject</span>
  appPackage.scripts = <span class="hljs-built_in">Object</span>.assign(&#123;
    <span class="hljs-attr">start</span>: <span class="hljs-string">"react-scripts start"</span>,
    <span class="hljs-attr">build</span>: <span class="hljs-string">"react-scripts build"</span>,
  &#125;);
  <span class="hljs-comment">// å…¶ä»–ä¸€ç³»åˆ—çš„è®¾ç½® eslint config browsers list appPackage.xxx = xx</span>
  <span class="hljs-comment">// å†™å…¥package.jsonæ–‡ä»¶å†…å®¹</span>
  fs.writeFileSync(
    path.join(appPath, <span class="hljs-string">"package.json"</span>),
    <span class="hljs-built_in">JSON</span>.stringify(appPackage, <span class="hljs-literal">null</span>, <span class="hljs-number">2</span>) + os.EOL
  );
  <span class="hljs-comment">// æ‹·è´æ–‡ä»¶ æ‹¿åˆ°cra-templateä¸‹çš„templateä¸­çš„å†…å®¹</span>
  <span class="hljs-keyword">const</span> templateDir = path.join(templatePath, <span class="hljs-string">"template"</span>);
  fs.copySync(templateDir, appPath); <span class="hljs-comment">// å°†templateä¸­çš„å†…å®¹æ‹·è´è¿‡æ¥</span>
  <span class="hljs-comment">// templateä¸­çš„gitignoreæ–‡ä»¶ å†™å…¥åˆ°.gitignoreä¸­</span>
  <span class="hljs-keyword">const</span> data = fs.readFileSync(path.join(appPath, <span class="hljs-string">"gitignore"</span>));
  fs.appendFileSync(path.join(appPath, <span class="hljs-string">".gitignore"</span>), data);
  fs.unlinkSync(path.join(appPath, <span class="hljs-string">"gitignore"</span>));
  <span class="hljs-comment">// åˆå§‹åŒ–ä»“åº“ require("child_process").execSync</span>
  execSync(<span class="hljs-string">"git init"</span>, &#123; <span class="hljs-attr">stdio</span>: <span class="hljs-string">"ignore"</span> &#125;);
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Initialized a git repository."</span>);
  <span class="hljs-comment">// å®‰è£…cra-templateä¸­çš„ä¾èµ– template.json</span>

  <span class="hljs-keyword">let</span> command = <span class="hljs-string">"yarnpkg"</span>,
    remove = <span class="hljs-string">"remove"</span>,
    args = [<span class="hljs-string">"add"</span>];
  <span class="hljs-comment">// args = args.concat(["react", "react-dom"]); // old CRA cli</span>
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`Installing template dependencies using <span class="hljs-subst">$&#123;command&#125;</span>...`</span>);
  <span class="hljs-comment">// æ‰§è¡Œå®‰è£…å‘½ä»¤ ä¸»è¦æ˜¯å¤„ç†template.jsonä¸­çš„æ–‡ä»¶</span>
  <span class="hljs-keyword">const</span> proc = spawn.sync(command, args, &#123; <span class="hljs-attr">stdio</span>: <span class="hljs-string">"inherit"</span> &#125;);
  <span class="hljs-comment">// ç§»é™¤cra-template</span>
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`Removing template package using <span class="hljs-subst">$&#123;command&#125;</span>...`</span>);
  <span class="hljs-keyword">const</span> proc1 = spawn.sync(command, [remove, templateName], &#123;
    <span class="hljs-attr">stdio</span>: <span class="hljs-string">"inherit"</span>,
  &#125;);
  <span class="hljs-comment">// æäº¤git commit</span>
  execSync(<span class="hljs-string">"git add -A"</span>, &#123; <span class="hljs-attr">stdio</span>: <span class="hljs-string">"ignore"</span> &#125;);
  execSync(<span class="hljs-string">'git commit -m "Initialize project using Create React App"'</span>, &#123;
    <span class="hljs-attr">stdio</span>: <span class="hljs-string">"ignore"</span>,
  &#125;);
  <span class="hljs-comment">// å®Œæˆ</span>
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`Success! Created <span class="hljs-subst">$&#123;appName&#125;</span> at <span class="hljs-subst">$&#123;appPath&#125;</span>`</span>);
&#125;;

<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<h3 data-id="heading-20">4.7 å‘å¸ƒ</h3>
<pre><code class="hljs language-js copyable" lang="js">lerna publish 
<span class="hljs-comment">// éœ€è¦å…ˆæäº¤git</span>
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<h2 data-id="heading-21">5. vue-cli4</h2>
<h3 data-id="heading-22">1. åˆå§‹åŒ–é¡¹ç›®</h3>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// https://github.com/vuejs/vue-cli/tree/dev/packages/%40vue</span>
<span class="hljs-comment">// ç°åœ¨å·²ç»æ˜¯ vue-cli5çš„betaç‰ˆæœ¬äº† ä¸»è¦ç”¨äº†webpack5</span>
vue create hello-world
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/fb3d8dcb06c249569cae28074fced8af~tplv-k3u1fbpfcp-watermark.image" alt="vue-cli4.png" loading="lazy" referrerpolicy="no-referrer"></p>
<h3 data-id="heading-23">2. åŸºæœ¬æµç¨‹</h3>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// 1. é€‰æ‹©é¢„è®¾</span>
? Please pick a preset: Manually select features
<span class="hljs-comment">// é€‰æ‹©æ‰‹åŠ¨æ¨¡å¼ä¹‹åé€‰æ‹©ç‰¹æ€§</span>
? Check the features needed <span class="hljs-keyword">for</span> your project: 
  Choose Vue version, Babel, Router, Vuex, Linter
<span class="hljs-comment">// é€‰æ‹©äº†æ¨¡å¼ä¹‹åä¼šå¤šä¸€äº›é€‰é¡¹</span>
? Choose a version <span class="hljs-keyword">of</span> Vue.js that you want to start the project <span class="hljs-keyword">with</span> <span class="hljs-number">3.</span>x

<span class="hljs-comment">// 2.åˆ›å»ºé¡¹ç›®  mkdir hello-world</span>
âœ¨  Creating project <span class="hljs-keyword">in</span> /Users/xueshuai.liu/hello-world.

<span class="hljs-comment">// 3.åˆå§‹åŒ–gitä»“åº“</span>
ğŸ—ƒ  Initializing git repository...

<span class="hljs-comment">// 4.å®‰è£…plugins</span>
 âš™ï¸  Installing CLI plugins. This might take a <span class="hljs-keyword">while</span>...
 
<span class="hljs-comment">// 5. è°ƒç”¨ç”Ÿæˆå™¨ è¿™é‡Œæ˜¯æ ¸å¿ƒ æ’ä»¶</span>
ğŸš€  Invoking generators...

<span class="hljs-comment">// 6.æŒ‰ç…§é¢å¤–çš„ä¾èµ–</span>
 ğŸ“¦  Installing additional dependencies...

<span class="hljs-comment">// 7. è¿è¡Œç¼–è¾‘çš„é’©å­hooks</span>
 âš“  Running completion hooks...
 
<span class="hljs-comment">// 8.ç”ŸæˆREADME.mdæ–‡ä»¶</span>
 ğŸš€  Generating README.md...
 
<span class="hljs-comment">// 9. get start</span>
ğŸ‰  Successfully created project hello-world. 
   
ğŸ‘‰  Get started <span class="hljs-keyword">with</span> the following commands:

<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/fdc500aa2e35486ea95b34b3c77670f5~tplv-k3u1fbpfcp-watermark.image" alt="flow.png" loading="lazy" referrerpolicy="no-referrer"></p>
<h3 data-id="heading-24">3. ç®€å•å®ç°</h3>
<ol>
<li>åˆå§‹åŒ–é¡¹ç›®</li>
</ol>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// vue-cli4ç°åœ¨æ˜¯åŸºäºæ’ä»¶ç³»ç»Ÿçš„</span>
lerna init
<span class="hljs-comment">// æ‰§è¡Œyarnå®‰è£…ä¾èµ–</span>
yarn
<span class="hljs-comment">// ä¿®æ”¹package.jsonæ–‡ä»¶</span>
<span class="hljs-string">"workspaces"</span>: [<span class="hljs-string">"packages/*"</span>]
<span class="hljs-comment">// åœ¨lerna.jsonä¸­æ–°å¢</span>
<span class="hljs-string">"useWorkspaces"</span>: <span class="hljs-literal">true</span>,

<span class="hljs-comment">// åˆå§‹åŒ–å­é¡¹ç›® </span>
lerna create @i-box/cli
lerna create @i-box/cli-service
lerna create @i-box/cli-shared-utils
<span class="hljs-comment">// æ’ä»¶å…¨éƒ¨ä½¿ç”¨å®˜æ–¹æä¾›çš„</span>
lerna create @i-box/cli-plugin-vuex

<span class="hljs-comment">// yarn vs lerna</span>
yarn ç”¨æ¥å¤„ç†ä¾èµ–
lernaç”¨æ¥åˆå§‹åŒ–å’Œå‘å¸ƒ
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<h3 data-id="heading-25">3.1 cli</h3>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// æˆ‘ä»¬ä¸»è¦å®ç° cliåŒ…çš„é€»è¾‘</span>
cd packages/cli
<span class="hljs-comment">// å¢åŠ binå‘½ä»¤</span>
<span class="hljs-string">"bin"</span>: &#123;
  <span class="hljs-string">"ibox-vue"</span>: <span class="hljs-string">"bin/vue.js"</span>
&#125;
<span class="hljs-comment">// å®‰è£…ä¾èµ–</span>
yarn workspace @i-box/cli add minimist commander fs-extra inquirer isbinaryfile ejs vue-codemod
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<h4 data-id="heading-26">1. vue.js</h4>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// æ³¨å†Œå‘½ä»¤</span>
program.command(<span class="hljs-string">"create <app-name>"</span>).action(<span class="hljs-function">(<span class="hljs-params">name, options</span>) =></span> &#123;
  <span class="hljs-built_in">require</span>(<span class="hljs-string">"../lib/create.js"</span>)(name, options);
&#125;);
program.parse(process.argv);
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<h4 data-id="heading-27">2. create.js</h4>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">create</span>(<span class="hljs-params">projectName, options</span>) </span>&#123;
  <span class="hljs-keyword">const</span> cwd = options.cwd || process.cwd()
  <span class="hljs-keyword">const</span> inCurrent = projectName === <span class="hljs-string">'.'</span>
  <span class="hljs-keyword">const</span> name = inCurrent ? path.relative(<span class="hljs-string">'../'</span>, cwd) : projectName
  <span class="hljs-keyword">const</span> targetDir = path.resolve(cwd, projectName || <span class="hljs-string">'.'</span>)
  <span class="hljs-comment">// è·å–å¼¹å‡ºé€‰é¡¹çš„ç»“æœ æ‰‹åŠ¨æ¨¡å¼ä¸‹é€‰æ‹©çš„é€‰é¡¹ vueVersion babel router vuexç­‰</span>
  <span class="hljs-keyword">let</span> promptModules = getPromptModules();
  <span class="hljs-comment">// åˆå§‹åŒ– Creator</span>
  <span class="hljs-keyword">const</span> creator = <span class="hljs-keyword">new</span> Creator(name, targetDir, promptModules)
  <span class="hljs-comment">// è°ƒç”¨createæ–¹æ³•</span>
  <span class="hljs-keyword">await</span> creator.create(options)
&#125;
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<h4 data-id="heading-28">2.1 getPromptModules</h4>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// æˆ‘ä»¬æ‰‹åŠ¨æ¨¡å¼ä¸‹é€‰æ‹©çš„ç‰¹æ€§</span>
<span class="hljs-keyword">const</span> getPromptModules = <span class="hljs-function">() =></span> &#123;
  <span class="hljs-keyword">return</span> [
    <span class="hljs-string">'vueVersion'</span>,
    <span class="hljs-string">'babel'</span>,
    <span class="hljs-string">'typescript'</span>,
    <span class="hljs-string">'pwa'</span>,
    <span class="hljs-string">'router'</span>,
    <span class="hljs-string">'vuex'</span>,
    <span class="hljs-string">'cssPreprocessors'</span>,
    <span class="hljs-string">'linter'</span>,
    <span class="hljs-string">'unit'</span>,
    <span class="hljs-string">'e2e'</span>
  ].map(<span class="hljs-function"><span class="hljs-params">file</span> =></span> <span class="hljs-built_in">require</span>(<span class="hljs-string">`../promptModules/<span class="hljs-subst">$&#123;file&#125;</span>`</span>))
&#125;
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<h4 data-id="heading-29">3. Creator</h4>
<ol>
<li>åˆå§‹åŒ– new Creator</li>
</ol>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// æ‰‹åŠ¨æ¨¡å¼</span>
<span class="hljs-keyword">const</span> isManualMode = <span class="hljs-function"><span class="hljs-params">answers</span> =></span> answers.preset === <span class="hljs-string">'__manual__'</span>
<span class="hljs-built_in">module</span>.exports = <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Creator</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">EventEmitter</span> </span>&#123;
  <span class="hljs-comment">// åˆå§‹åŒ–</span>
  <span class="hljs-function"><span class="hljs-title">constructor</span>(<span class="hljs-params">name, context, prompModules</span>)</span> &#123;
    <span class="hljs-built_in">super</span>()
    <span class="hljs-built_in">this</span>.name = name
    <span class="hljs-built_in">this</span>.context = process.env.VUE_CLI_CONTEXT = context
    <span class="hljs-comment">// è·å–åˆ°é€‰æ‹©çš„é¢„è®¾å’Œç‰¹æ€§ å¦‚æœæ˜¯defaultä¼šæœ‰é»˜è®¤å€¼</span>
    <span class="hljs-keyword">const</span> &#123; presetPrompt, featurePrompt &#125; = <span class="hljs-built_in">this</span>.resolveIntroPrompts()
    <span class="hljs-comment">// æ‰‹åŠ¨æ¨¡å¼ æœ€åä¸€æ­¥ä¿å­˜é…ç½®çš„ä½ç½®å’Œæ˜¯å¦ä¿å­˜åœ¨æ–‡ä»¶ä¸­ ä¼šä¿å­˜åœ¨ .vuerc ä¸­</span>
    <span class="hljs-built_in">this</span>.outroPrompts = <span class="hljs-built_in">this</span>.resolveOutroPrompts()
    <span class="hljs-comment">// é¢„è®¾é€‰é¡¹</span>
    <span class="hljs-built_in">this</span>.presetPrompt = presetPrompt
    <span class="hljs-comment">// ç‰¹æ€§çš„é€‰é¡¹ ä¾‹å¦‚æˆ‘ä»¬é€‰æ‹©äº† eslintä¼šè®©æˆ‘ä»¬é€‰é¡¹å“ªç§è§„èŒƒ</span>
    <span class="hljs-built_in">this</span>.featurePrompt = featurePrompt
    <span class="hljs-comment">// é€‰é¡¹çš„ç‰¹å¾ä¹‹ååŠ å…¥çš„é€‰é¡¹</span>
    <span class="hljs-built_in">this</span>.injectedPrompts = []
    <span class="hljs-comment">// å®Œæˆçš„å›è°ƒ</span>
    <span class="hljs-built_in">this</span>.promptCompleteCbs = []
    <span class="hljs-comment">// å½“æˆ‘ä»¬é€‰é¡¹äº†ä¸åŒçš„ç‰¹æ€§ ä¼šé€šè¿‡apiç»™æˆ‘ä»¬å¢åŠ å¯¹åº”çš„é€‰é¡¹</span>
    <span class="hljs-keyword">const</span> promptAPI = <span class="hljs-keyword">new</span> PromptModuleAPI(<span class="hljs-built_in">this</span>)
    <span class="hljs-comment">// éå†ç‰¹æ€§ promptAPIæä¾›ä¸€ä¸ªæ³¨å…¥é€‰æ‹©ç‰¹æ€§ ä¸€ä¸ªé€‰æ‹©ä¹‹åçš„å›è°ƒ(æ³¨å…¥ä¸€äº›æ’ä»¶)</span>
    promptModules.forEach(<span class="hljs-function">(<span class="hljs-params">m</span>) =></span> m(promptAPI));
  &#125;
  <span class="hljs-comment">// æ‰§è¡Œcreateæ–¹æ³•</span>
  <span class="hljs-keyword">async</span> create (cliOptions = &#123;&#125;, preset = <span class="hljs-literal">null</span>) &#123;&#125;
&#125;
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<ol start="2">
<li>resolveIntroPrompts è·å–é¢„è®¾å’Œç‰¹æ€§</li>
</ol>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">resolveIntroPrompts</span>(<span class="hljs-params"></span>) </span>&#123;
  <span class="hljs-comment">// æˆ‘ä»¬ä¿å­˜çš„é€‰é¡¹ä¼šå­˜åœ¨ .vuerc ä¸­</span>
  <span class="hljs-comment">// const savedOptions = loadOptions()</span>
  <span class="hljs-comment">// const preset = Object.assign(&#123;&#125;, savedOptions.presets, defaults.presets)</span>
  <span class="hljs-comment">// é»˜è®¤çš„é¢„è®¾</span>
  <span class="hljs-keyword">const</span> defaultPreset = &#123;
    <span class="hljs-attr">useConfigFiles</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-attr">cssPreprocessor</span>: <span class="hljs-literal">undefined</span>,
    <span class="hljs-attr">plugins</span>: &#123;
      <span class="hljs-string">'@vue/cli-plugin-babel'</span>: &#123;&#125;,
      <span class="hljs-string">'@vue/cli-plugin-eslint'</span>: &#123;
        <span class="hljs-attr">config</span>: <span class="hljs-string">'base'</span>,
        <span class="hljs-attr">lintOn</span>: [<span class="hljs-string">'save'</span>]
      &#125;
    &#125;
  &#125;
  <span class="hljs-keyword">const</span> presets = &#123;
    <span class="hljs-string">'default'</span>: <span class="hljs-built_in">Object</span>.assign(&#123; <span class="hljs-attr">vueVersion</span>: <span class="hljs-string">'2'</span> &#125;, defaultPreset),
    <span class="hljs-string">'__default_vue_3__'</span>: <span class="hljs-built_in">Object</span>.assign(&#123; <span class="hljs-attr">vueVersion</span>: <span class="hljs-string">'3'</span> &#125;, defaultPreset)
  &#125;
  <span class="hljs-comment">// é¢„è®¾çš„é€‰é¡¹ æ˜¾ç¤ºä½¿ç”¨çš„</span>
  <span class="hljs-keyword">const</span> presetChoices = <span class="hljs-built_in">Object</span>.entries(presets).map(<span class="hljs-function">(<span class="hljs-params">[name, preset]</span>) =></span> &#123;
    <span class="hljs-keyword">let</span> displayName = name
    <span class="hljs-keyword">if</span> (name === <span class="hljs-string">'default'</span>) &#123;
      displayName = <span class="hljs-string">'Default'</span>
    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (name === <span class="hljs-string">'__default_vue_3__'</span>) &#123;
      displayName = <span class="hljs-string">'Default (Vue 3)'</span>
    &#125;

    <span class="hljs-keyword">return</span> &#123;
      <span class="hljs-comment">// Default ([Vue 2] babel, eslint)</span>
      <span class="hljs-comment">// Default (Vue 3) ([Vue 3] babel, eslint) </span>
      <span class="hljs-comment">// name: `$&#123;displayName&#125; ($&#123;formatFeatures(preset)&#125;)`,</span>
      <span class="hljs-attr">name</span>: <span class="hljs-string">`<span class="hljs-subst">$&#123;displayName&#125;</span>`</span>,
      <span class="hljs-attr">value</span>: name
    &#125;
  &#125;)

  <span class="hljs-keyword">const</span> presetPrompt  = &#123;
    <span class="hljs-attr">name</span>: <span class="hljs-string">'preset'</span>,
    <span class="hljs-attr">type</span>: <span class="hljs-string">'list'</span>,
    <span class="hljs-attr">message</span>: <span class="hljs-string">`Please pick a preset:`</span>,
    <span class="hljs-attr">choices</span>: [
      ...presetChoices,
      <span class="hljs-comment">// åŠ ä¸Šä¸€ä¸ªæ‰‹åŠ¨é€‰æ‹©çš„æ¨¡å¼</span>
      &#123;
        <span class="hljs-attr">name</span>: <span class="hljs-string">'Manually select features'</span>,
        <span class="hljs-attr">value</span>: <span class="hljs-string">'__manual__'</span>
      &#125;
    ]
  &#125;
  <span class="hljs-comment">// ç‰¹æ€§</span>
  <span class="hljs-keyword">const</span> featurePrompt = &#123;
    <span class="hljs-attr">name</span>: <span class="hljs-string">'features'</span>,
    <span class="hljs-attr">when</span>: isManualMode, <span class="hljs-comment">// æ‰‹åŠ¨æ¨¡å¼ä¸‹æ‰ä¼šæœ‰</span>
    <span class="hljs-attr">type</span>: <span class="hljs-string">'checkbox'</span>,
    <span class="hljs-attr">message</span>: <span class="hljs-string">'Check the features needed for your project:'</span>,
    <span class="hljs-attr">choices</span>: [], <span class="hljs-comment">// ä¿å­˜æˆ‘ä»¬çš„é€‰é¡¹</span>
    <span class="hljs-attr">pageSize</span>: <span class="hljs-number">10</span>
  &#125;
  <span class="hljs-keyword">return</span> &#123;
    presetPrompt,
    featurePrompt
  &#125;
&#125;
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/55cbd257cfe243d691ded52a235763a5~tplv-k3u1fbpfcp-watermark.image" alt="preset.png" loading="lazy" referrerpolicy="no-referrer"></p>
<ol start="3">
<li>resolveOutroPrompts</li>
</ol>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// æ˜¯å¦ä¿å­˜æœ¬æ¬¡çš„é€‰æ‹©ç»“æœ ä¼šåœ¨ .vuerc ä¸­ä¿å­˜ ä»€ä¹ˆæ—¶å€™ä¿å­˜çš„? åœ¨createè¿‡ç¨‹ä¸­ promptAndResolvePreset </span>
<span class="hljs-function"><span class="hljs-keyword">function</span>  <span class="hljs-title">resolveOutroPrompts</span>(<span class="hljs-params"></span>) </span>&#123;
  <span class="hljs-keyword">return</span> [
    &#123;
      <span class="hljs-attr">name</span>: <span class="hljs-string">'useConfigFiles'</span>,
      <span class="hljs-attr">when</span>: isManualMode,
      <span class="hljs-attr">type</span>: <span class="hljs-string">'list'</span>,
      <span class="hljs-attr">message</span>: <span class="hljs-string">'Where do you prefer placing config for Babel, ESLint, etc.?'</span>,
      <span class="hljs-comment">// æ˜¯åœ¨å•ç‹¬çš„æ–‡ä»¶ä¸­è¿˜æ˜¯ä¿å­˜åœ¨package.jsonæ–‡ä»¶ä¸­</span>
      <span class="hljs-attr">choices</span>: [
        &#123;
          <span class="hljs-attr">name</span>: <span class="hljs-string">'In dedicated config files'</span>,
          <span class="hljs-attr">value</span>: <span class="hljs-string">'files'</span>
        &#125;,
        &#123;
          <span class="hljs-attr">name</span>: <span class="hljs-string">'In package.json'</span>,
          <span class="hljs-attr">value</span>: <span class="hljs-string">'pkg'</span>
        &#125;
      ]
    &#125;,
    &#123;
      <span class="hljs-attr">name</span>: <span class="hljs-string">'save'</span>,
      <span class="hljs-attr">when</span>: isManualMode,
      <span class="hljs-comment">// æ˜¯å¦ä¿å­˜</span>
      <span class="hljs-attr">type</span>: <span class="hljs-string">'confirm'</span>,
      <span class="hljs-attr">message</span>: <span class="hljs-string">'Save this as a preset for future projects?'</span>,
      <span class="hljs-attr">default</span>: <span class="hljs-literal">false</span>
    &#125;,
    &#123;
      <span class="hljs-attr">name</span>: <span class="hljs-string">'saveName'</span>,
      <span class="hljs-comment">// å¦‚æœä¿å­˜è¾“å…¥ä¿å­˜çš„name</span>
      <span class="hljs-attr">when</span>: <span class="hljs-function"><span class="hljs-params">answers</span> =></span> answers.save,
      <span class="hljs-attr">type</span>: <span class="hljs-string">'input'</span>,
      <span class="hljs-attr">message</span>: <span class="hljs-string">'Save preset as:'</span>
    &#125;
  ]
&#125;
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/51f031ee0a3e45f396a996d0653f5dc6~tplv-k3u1fbpfcp-watermark.image" alt="outro.png" loading="lazy" referrerpolicy="no-referrer"></p>
<ol start="4">
<li>PromptModuleAPI</li>
</ol>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// ç»™ç‰¹æ€§æ³¨å†Œä¸€äº›api æ–¹ä¾¿é€‰æ‹©ä¹‹ååšä¸€äº›å¤„ç†</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PromptModuleAPI</span> </span>&#123;
  <span class="hljs-function"><span class="hljs-title">constructor</span>(<span class="hljs-params">creator</span>)</span> &#123;
    <span class="hljs-built_in">this</span>.creator = creator
  &#125;
  <span class="hljs-comment">// æä¾›ä¸€äº›apiæ¥ä¿®æ”¹é€‰é¡¹ è¿˜æœ‰å®Œæˆé€‰æ‹©ä¹‹åçš„å›è°ƒ</span>
  <span class="hljs-comment">// 1. æ’å…¥ä¸€äº›æ–°çš„ç‰¹æ€§ ä¾‹å¦‚vuex vueçš„ç‰ˆæœ¬</span>
  injectFeature (feature) &#123;
    <span class="hljs-built_in">this</span>.creator.featurePrompt.choices.push(feature)
  &#125;
  <span class="hljs-comment">// 2. åŠ å…¥æ–°çš„é€‰æ‹© vueVersioné€‰æ‹©äº†ä¹‹åä¼šè¦é€‰æ‹©vue2è¿˜æ˜¯vue3</span>
  injectPrompt (prompt) &#123;
    <span class="hljs-built_in">this</span>.creator.injectedPrompts.push(prompt)
  &#125;
  <span class="hljs-comment">// 3. åŠ å…¥ä¸€äº›é€‰é¡¹ æˆ‘ä»¬å¯ä»¥è‡ªå®šä¹‰ä¸€äº›æ’ä»¶æ¥æä¾›é€‰é¡¹</span>
  injectOptionForPrompt (name, option) &#123;
    <span class="hljs-built_in">this</span>.creator.injectedPrompts.find(<span class="hljs-function"><span class="hljs-params">f</span> =></span> &#123;
      <span class="hljs-keyword">return</span> f.name === name
    &#125;).choices.push(option)
  &#125;
  <span class="hljs-comment">// 4. é€‰é¡¹å®Œæˆä¹‹åçš„å›è°ƒ</span>
  onPromptComplete (cb) &#123;
    <span class="hljs-built_in">this</span>.creator.promptCompleteCbs.push(cb)
  &#125;
&#125;
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<h4 data-id="heading-30">4. create</h4>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// è°ƒç”¨createæ–¹æ³• creator.create</span>
  <span class="hljs-comment">// æ‰§è¡Œcreateæ–¹æ³•</span>
  <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-title">create</span>(<span class="hljs-params">cliOptions = &#123;&#125;, preset = <span class="hljs-literal">null</span></span>)</span> &#123;
    <span class="hljs-comment">// 1. è·å–ç”¨æˆ·çš„é€‰é¡¹</span>
    <span class="hljs-keyword">let</span> preset = <span class="hljs-keyword">await</span> <span class="hljs-built_in">this</span>.promptAndResolvePreset();
    <span class="hljs-comment">// 2. æ³¨å…¥æ ¸å¿ƒçš„æœåŠ¡ @vue/cli-service æ˜¯ä¸€ä¸ªæ ¸å¿ƒçš„ç‰¹æ®Šçš„æ’ä»¶</span>
    preset.plugins[<span class="hljs-string">"@vue/cli-service"</span>] = <span class="hljs-built_in">Object</span>.assign(
      &#123;
        <span class="hljs-attr">projectName</span>: name,
      &#125;,
      preset
    );
    <span class="hljs-comment">// 3.å¼€å§‹åˆ›å»ºé¡¹ç›®</span>
    log(<span class="hljs-string">`âœ¨  Creating project in <span class="hljs-subst">$&#123;chalk.yellow(context)&#125;</span>.`</span>);
    <span class="hljs-comment">// 4. æ ¹æ®æ’ä»¶çš„ä¾èµ–ç”Ÿæˆpackage.jsonå†™å…¥ ä¼šå¤„ç†ç‰ˆæœ¬çš„é—®é¢˜</span>
    <span class="hljs-keyword">const</span> pkg = &#123;
      name,
      <span class="hljs-attr">version</span>: <span class="hljs-string">"0.1.0"</span>,
      <span class="hljs-attr">private</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">devDependencies</span>: &#123;&#125;,
      <span class="hljs-comment">// ...resolvePkg(this.context)</span>
    &#125;;
    <span class="hljs-comment">// åœ¨é€‰é¡¹å®Œæˆçš„å›è°ƒä¸­æˆ‘ä»¬ä¼šå¢åŠ  pluginsçš„å±æ€§ options.plugins['@vue/cli-plugin-vuex'] = &#123;&#125;</span>
    <span class="hljs-keyword">const</span> deps = <span class="hljs-built_in">Object</span>.keys(preset.plugins);
    deps.forEach(<span class="hljs-function">(<span class="hljs-params">dep</span>) =></span> &#123;
      pkg.devDependencies[dep] = <span class="hljs-string">"latest"</span>;
    &#125;);
    <span class="hljs-keyword">await</span> writeFileTree(context, &#123;
      <span class="hljs-string">"package.json"</span>: <span class="hljs-built_in">JSON</span>.stringify(pkg, <span class="hljs-literal">null</span>, <span class="hljs-number">2</span>),
    &#125;);
    <span class="hljs-comment">// 5. åˆå§‹åŒ–ä»“åº“</span>
    log(<span class="hljs-string">`ğŸ—ƒ  Initializing git repository...`</span>);
    <span class="hljs-comment">// execa æ‰§è¡Œå‘½ä»¤</span>
    <span class="hljs-keyword">await</span> <span class="hljs-built_in">this</span>.run(<span class="hljs-string">"git init"</span>);
    <span class="hljs-comment">// 6.å®‰è£…ä¾èµ–</span>
    log(<span class="hljs-string">`âš™\u&#123;fe0f&#125;  Installing CLI plugins. This might take a while...`</span>);
    <span class="hljs-keyword">await</span> run(<span class="hljs-string">"npm install"</span>);
    <span class="hljs-comment">// 7. æ ¸å¿ƒ ç”Ÿæˆå™¨æ’ä»¶</span>
    log(<span class="hljs-string">`ğŸš€  Invoking generators...`</span>);
    <span class="hljs-keyword">const</span> plugins = <span class="hljs-keyword">await</span> <span class="hljs-built_in">this</span>.resolvePlugins(preset.plugins, pkg);
    <span class="hljs-keyword">const</span> generator = <span class="hljs-keyword">new</span> Generator(context, &#123;
      pkg,
      plugins,
      afterInvokeCbs,
      afterAnyInvokeCbs,
    &#125;);
    <span class="hljs-keyword">await</span> generator.generate(&#123;
      <span class="hljs-attr">extractConfigFiles</span>: preset.useConfigFiles,
    &#125;);
    <span class="hljs-comment">// 8.å®‰è£…é¢å¤–çš„ä¾èµ– åˆå§‹åŒ–readmeæ–‡ä»¶ å®Œæˆ</span>
    <span class="hljs-keyword">await</span> writeFileTree(context, &#123; <span class="hljs-string">"README.md"</span>: <span class="hljs-string">"README.md"</span> &#125;);
    <span class="hljs-keyword">await</span> run(<span class="hljs-string">"git add -A"</span>);
    log(<span class="hljs-string">`ğŸ‰  Successfully created project <span class="hljs-subst">$&#123;chalk.yellow(name)&#125;</span>.`</span>);
  &#125;
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<ol>
<li>promptAndResolvePreset</li>
</ol>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// è·å–ç”¨æˆ·çš„é€‰é¡¹ è§£æé¢„è®¾</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">promptAndResolvePreset</span>(<span class="hljs-params">answers = <span class="hljs-literal">null</span></span>) </span>&#123;
  <span class="hljs-keyword">if</span> (!answers) &#123;
    <span class="hljs-comment">// await clearConsole(true)</span>
    <span class="hljs-built_in">this</span>.injectedPrompts.forEach(<span class="hljs-function"><span class="hljs-params">prompt</span> =></span> &#123;
      <span class="hljs-keyword">const</span> originalWhen = prompt.when || (<span class="hljs-function">() =></span> <span class="hljs-literal">true</span>)
      prompt.when = <span class="hljs-function"><span class="hljs-params">answers</span> =></span> &#123;
        <span class="hljs-keyword">return</span> isManualMode(answers) && originalWhen(answers)
      &#125;
    &#125;)
    <span class="hljs-keyword">let</span> prompts = [
      <span class="hljs-built_in">this</span>.presetPrompt,
      <span class="hljs-built_in">this</span>.featurePrompt,
      ...this.injectedPrompts,
      ...this.outroPrompts
    ]
    <span class="hljs-comment">// è·å–ç”¨æˆ·é€‰é¡¹</span>
    <span class="hljs-comment">// answers = await inquirer.prompt(this.resolveFinalPrompts())</span>
    answers = <span class="hljs-keyword">await</span> inquirer.prompt(prompts)
  &#125;
  <span class="hljs-comment">// æ˜¯å¦ä¿å­˜åˆ°package.jsonæ–‡ä»¶ä¸­</span>
  <span class="hljs-comment">// if (answers.packageManager) &#123;</span>
  <span class="hljs-comment">//   // fs.writeFile()</span>
  <span class="hljs-comment">//   saveOptions(&#123;</span>
  <span class="hljs-comment">//     packageManager: answers.packageManager</span>
  <span class="hljs-comment">//   &#125;)</span>
  <span class="hljs-comment">// &#125;</span>
  <span class="hljs-keyword">let</span> preset
  <span class="hljs-keyword">if</span> (answers.preset && answers.preset !== <span class="hljs-string">'__manual__'</span>) &#123;
    <span class="hljs-comment">// ä¸æ˜¯æ‰‹åŠ¨æ¨¡å¼ä¸‹çš„ å¯èƒ½æ˜¯é»˜è®¤çš„default ä¹Ÿå¯èƒ½æ˜¯ä¸Šæ¬¡ä¿å­˜çš„</span>
    <span class="hljs-comment">// preset = await this.resolvePreset(answers.preset)</span>
    preset = defaults.presets
  &#125; <span class="hljs-keyword">else</span> &#123;
    <span class="hljs-comment">// æ‰‹åŠ¨æ¨¡å¼</span>
    preset = &#123;
      <span class="hljs-attr">useConfigFiles</span>: answers.useConfigFiles === <span class="hljs-string">'files'</span>,
      <span class="hljs-attr">plugins</span>: &#123;&#125;
    &#125;
    answers.features = answers.features || []
    <span class="hljs-comment">// è¿è¡Œæ¨¡å—æ³¨å†Œçš„å›è°ƒæ¥å®Œæˆé¢„è®¾ options.vueVersion = answers.vueVersion</span>
    <span class="hljs-built_in">this</span>.promptCompleteCbs.forEach(<span class="hljs-function"><span class="hljs-params">cb</span> =></span> cb(answers, preset))
  &#125;
  <span class="hljs-comment">// ä¿å­˜é…ç½®ä¿¡æ¯åˆ°.vuercæ–‡ä»¶</span>
  <span class="hljs-comment">// if(answers.save) &#123;&#125;</span>
  <span class="hljs-keyword">return</span> preset
&#125;
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<ol start="2">
<li>resolvePlugins</li>
</ol>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// è§£ææ’ä»¶ æ’ä»¶ç³»ç»Ÿçš„å®ç° åŠ è½½ generator æ¨¡å— å¢åŠ applyæ–¹æ³•</span>
<span class="hljs-comment">//  &#123; id: options &#125; => [&#123; id, apply, options &#125;] å¢åŠ applyæ–¹æ³•</span>
<span class="hljs-keyword">async</span>  <span class="hljs-function"><span class="hljs-title">resolvePlugins</span>(<span class="hljs-params">rawPlugins, pkg</span>)</span> &#123;
  <span class="hljs-comment">// ä¿è¯ @vue/cli-service æ˜¯ç¬¬ä¸€ä¸ªæ’ä»¶ è¿™ä¸ªå¾ˆé‡è¦</span>
  <span class="hljs-comment">// å› ä¸ºå…¶ä»–çš„æ’ä»¶æ˜¯åŸºäºé‡Œé¢çš„templateæ¥åšä¿®æ”¹çš„</span>
  rawPlugins = sortObject(rawPlugins, [<span class="hljs-string">'@vue/cli-service'</span>], <span class="hljs-literal">true</span>)
  <span class="hljs-keyword">const</span> plugins = []
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> id <span class="hljs-keyword">of</span> <span class="hljs-built_in">Object</span>.keys(rawPlugins)) &#123;
    <span class="hljs-comment">// åŠ è½½æ’ä»¶ä¸‹çš„ generator æ¨¡å—</span>
    <span class="hljs-comment">// æ’ä»¶ä¸€èˆ¬æ˜¯æœ‰ä¸€ä¸ª generatorç›®å½•çš„</span>
    <span class="hljs-comment">// require() Module.createRequire</span>
    <span class="hljs-keyword">const</span> apply = loadModule(<span class="hljs-string">`<span class="hljs-subst">$&#123;id&#125;</span>/generator`</span>, <span class="hljs-built_in">this</span>.context) || (<span class="hljs-function">() =></span> &#123;&#125;)
    <span class="hljs-keyword">let</span> options = rawPlugins[id] || &#123;&#125;

    <span class="hljs-keyword">if</span> (options.prompts) &#123;
      <span class="hljs-keyword">let</span> pluginPrompts = loadModule(<span class="hljs-string">`<span class="hljs-subst">$&#123;id&#125;</span>/prompts`</span>, <span class="hljs-built_in">this</span>.context)

      <span class="hljs-keyword">if</span> (pluginPrompts) &#123;
        <span class="hljs-keyword">const</span> prompt = inquirer.createPromptModule()

        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> pluginPrompts === <span class="hljs-string">'function'</span>) &#123;
          pluginPrompts = pluginPrompts(pkg, prompt)
        &#125;
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> pluginPrompts.getPrompts === <span class="hljs-string">'function'</span>) &#123;
          pluginPrompts = pluginPrompts.getPrompts(pkg, prompt)
        &#125;

        log()
        log(<span class="hljs-string">`<span class="hljs-subst">$&#123;chalk.cyan(options._isPreset ? <span class="hljs-string">`Preset options:`</span> : id)&#125;</span>`</span>)
        options = <span class="hljs-keyword">await</span> prompt(pluginPrompts)
      &#125;
    &#125;
    <span class="hljs-comment">// å¢åŠ ä¸€ä¸ªapplyæ–¹æ³• ä»€ä¹ˆæ—¶å€™æ‰§è¡Œçš„?</span>
    plugins.push(&#123; id, apply, options &#125;)
  &#125;
  <span class="hljs-keyword">return</span> plugins
&#125;
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/565599e8aca74f528ceed2c20cab058c~tplv-k3u1fbpfcp-watermark.image" alt="plugin.png" loading="lazy" referrerpolicy="no-referrer"></p>
<h4 data-id="heading-31">5. Generator</h4>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// ç”Ÿæˆå™¨</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Generator</span> </span>&#123;
  <span class="hljs-function"><span class="hljs-title">constructor</span>(<span class="hljs-params">context, &#123; pkg = &#123;&#125;, plugins = [], files = &#123;&#125; &#125; = &#123;&#125;</span>)</span> &#123;
    <span class="hljs-built_in">this</span>.pkg = pkg
    <span class="hljs-built_in">this</span>.files = &#123;&#125;
    <span class="hljs-built_in">this</span>.fileMiddlewares = []; <span class="hljs-comment">// æ’ä»¶æ•°ç»„</span>
    <span class="hljs-comment">// load all the other plugins</span>
    <span class="hljs-built_in">this</span>.allPlugins = <span class="hljs-built_in">this</span>.resolveAllPlugins()
    <span class="hljs-comment">// @vue/cli-service æ’ä»¶éå¸¸ç‰¹æ®Š å•ç‹¬å¤„ç†</span>
    <span class="hljs-keyword">const</span> cliService = plugins.find(<span class="hljs-function">(<span class="hljs-params">p</span>) =></span> p.id === <span class="hljs-string">"@vue/cli-service"</span>);
    <span class="hljs-built_in">this</span>.rootOptions = rootOptions; <span class="hljs-comment">// æ ¹é€‰é¡¹</span>
  &#125;
&#125;
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<ol>
<li>resolveAllPlugins</li>
</ol>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">resolveAllPlugins</span>(<span class="hljs-params"></span>) </span>&#123;
  <span class="hljs-keyword">const</span> allPlugins = [];
  <span class="hljs-built_in">Object</span>.keys(<span class="hljs-built_in">this</span>.pkg.dependencies || &#123;&#125;)
    .concat(<span class="hljs-built_in">Object</span>.keys(<span class="hljs-built_in">this</span>.pkg.devDependencies || &#123;&#125;))
    .forEach(<span class="hljs-function">(<span class="hljs-params">id</span>) =></span> &#123;
      <span class="hljs-keyword">if</span> (!isPlugin(id)) <span class="hljs-keyword">return</span>;
      <span class="hljs-keyword">const</span> pluginGenerator = loadModule(<span class="hljs-string">`<span class="hljs-subst">$&#123;id&#125;</span>/generator`</span>, <span class="hljs-built_in">this</span>.context);
      <span class="hljs-keyword">if</span> (!pluginGenerator) <span class="hljs-keyword">return</span>;
      allPlugins.push(&#123; id, <span class="hljs-attr">apply</span>: pluginGenerator &#125;);
    &#125;);
  <span class="hljs-keyword">return</span> sortPlugins(allPlugins);
&#125;
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<ol start="2">
<li>generateæ–¹æ³•</li>
</ol>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-keyword">async</span> generate (&#123; extractConfigFiles = <span class="hljs-literal">false</span>, checkExisting = <span class="hljs-literal">false</span>&#125; = &#123;&#125;) &#123;
  <span class="hljs-comment">// 1. åˆå§‹åŒ–æ’ä»¶ éå†æ‰§è¡Œapplyæ–¹æ³•</span>
  <span class="hljs-keyword">await</span> <span class="hljs-built_in">this</span>.initPlugins()
  <span class="hljs-keyword">const</span> initialFiles = <span class="hljs-built_in">Object</span>.assign(&#123;&#125;, <span class="hljs-built_in">this</span>.files)
  <span class="hljs-comment">// å•ç‹¬çš„é…ç½®æ–‡ä»¶</span>
  <span class="hljs-comment">// this.extractConfigFiles(extractConfigFiles, checkExisting)</span>
  <span class="hljs-comment">// è§£æfile æ‰§è¡Œæ’ä»¶çš„æ–¹æ³• ä¿®æ”¹files</span>
  <span class="hljs-keyword">await</span> <span class="hljs-built_in">this</span>.resolveFiles()
  <span class="hljs-comment">// æ’åº</span>
  <span class="hljs-comment">// this.sortPkg()</span>
  <span class="hljs-comment">// é‡æ–°ç”Ÿæˆpackage.json æ’ä»¶å¯èƒ½ä¿®æ”¹äº†å†…å®¹</span>
  <span class="hljs-built_in">this</span>.files[<span class="hljs-string">'package.json'</span>] = <span class="hljs-built_in">JSON</span>.stringify(<span class="hljs-built_in">this</span>.pkg, <span class="hljs-literal">null</span>, <span class="hljs-number">2</span>) + <span class="hljs-string">'\n'</span>
  <span class="hljs-comment">// å†™å…¥æ–‡ä»¶ä¹¦</span>
  <span class="hljs-keyword">await</span> writeFileTree(<span class="hljs-built_in">this</span>.context, <span class="hljs-built_in">this</span>.files, initialFiles, <span class="hljs-built_in">this</span>.filesModifyRecord)
&#125;
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<ol start="3">
<li>initPlugins</li>
</ol>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// åˆå§‹åŒ–æ’ä»¶</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">initPlugins</span>(<span class="hljs-params"></span>) </span>&#123;
  <span class="hljs-keyword">const</span> &#123; rootOptions &#125; = <span class="hljs-built_in">this</span>
  <span class="hljs-keyword">const</span> pluginIds = <span class="hljs-built_in">this</span>.plugins.map(<span class="hljs-function"><span class="hljs-params">p</span> =></span> p.id)
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> plugin <span class="hljs-keyword">of</span> <span class="hljs-built_in">this</span>.plugins) &#123;
    <span class="hljs-keyword">const</span> &#123; id, apply &#125; = plugin;
    <span class="hljs-comment">// ç»™æ’ä»¶æä¾›çš„ä¸€äº›apiæ–¹æ³•</span>
    <span class="hljs-keyword">const</span> api = <span class="hljs-keyword">new</span> GeneratorAPI(id, <span class="hljs-built_in">this</span>, &#123;&#125;, rootOptions);
    <span class="hljs-comment">// æ‰§è¡Œapplyæ–¹æ³• </span>
    <span class="hljs-keyword">await</span> apply(api, options, rootOptions, invoking)
  &#125;
&#125;
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<ol start="4">
<li>GeneratorAPI</li>
</ol>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// æä¾›ä¸€äº›apiç»™æ’ä»¶ä½¿ç”¨</span>
<span class="hljs-comment">// renderæ¸²æŸ“å†…å®¹  extendPackageæ‰©å±•ä¾èµ– </span>
<span class="hljs-comment">// injectImportså¢åŠ importè¯­å¥</span>
<span class="hljs-comment">// injectRootOptions æ³¨å…¥æ ¹optionç­‰</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">GeneratorAPI</span> </span>&#123;
  <span class="hljs-function"><span class="hljs-title">constructor</span>(<span class="hljs-params">id, generator, options, rootOptions</span>)</span> &#123;
    <span class="hljs-built_in">this</span>.id = id;
    <span class="hljs-built_in">this</span>.generator = generator;
    <span class="hljs-built_in">this</span>.options = options;
    <span class="hljs-built_in">this</span>.rootOptions = rootOptions; <span class="hljs-comment">// æ ¹é€‰é¡¹</span>
    <span class="hljs-built_in">this</span>.pluginsData = generator.plugins
      .filter(<span class="hljs-function">(<span class="hljs-params">&#123; id &#125;</span>) =></span> id !== <span class="hljs-string">`@vue/cli-service`</span>)
      .map(<span class="hljs-function">(<span class="hljs-params">&#123; id &#125;</span>) =></span> (&#123;
        <span class="hljs-comment">// eslint babel</span>
        <span class="hljs-attr">name</span>: toShortPluginId(id),
      &#125;));
    <span class="hljs-comment">// æ’ä»¶éœ€è¦å¾€entryFileä¸­æ·»åŠ å†…å®¹</span>
    <span class="hljs-built_in">this</span>._entryFile = <span class="hljs-literal">undefined</span>;
  &#125;

  <span class="hljs-comment">// readeOnly</span>
  <span class="hljs-keyword">get</span> <span class="hljs-title">entryFile</span>() &#123;
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>._entryFile) <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>._entryFile;
    <span class="hljs-comment">// è¿™é‡Œå°±æŒ‡æ˜äº† æˆ‘ä»¬çš„å…¥å£æ˜¯main</span>
    <span class="hljs-keyword">const</span> file = fs.existsSync(<span class="hljs-built_in">this</span>.resolve(<span class="hljs-string">"src/main.ts"</span>))
      ? <span class="hljs-string">"src/main.ts"</span>
      : <span class="hljs-string">"src/main.js"</span>;
    <span class="hljs-keyword">return</span> (<span class="hljs-built_in">this</span>._entryFile = file);
  &#125;

  <span class="hljs-comment">// api.extendPackage(&#123;</span>
  <span class="hljs-comment">//   dependencies: &#123;</span>
  <span class="hljs-comment">//     'vue': '^3.0.4'</span>
  <span class="hljs-comment">//   &#125;,</span>
  <span class="hljs-comment">//   devDependencies: &#123;</span>
  <span class="hljs-comment">//     '@vue/compiler-sfc': '^3.0.4'</span>
  <span class="hljs-comment">//   &#125;</span>
  <span class="hljs-comment">// &#125;)</span>
  <span class="hljs-comment">// æ’ä»¶çš„åŠŸèƒ½  ä¿®æ”¹é…ç½®  renderæ¸²æŸ“å†…å®¹</span>
  <span class="hljs-function"><span class="hljs-title">extendPackage</span>(<span class="hljs-params">fields</span>)</span> &#123;
    <span class="hljs-comment">// åšä¸€ä¸ªé…ç½®çš„åˆå¹¶ ä¿®æ”¹package.jsonæ–‡ä»¶ä¸­çš„ä¾èµ–</span>
    <span class="hljs-keyword">const</span> pkg = <span class="hljs-built_in">this</span>.generator.pkg;
    <span class="hljs-keyword">const</span> toMerge = isFunction(fields) ? fields(pkg) : fields;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> key <span class="hljs-keyword">in</span> toMerge) &#123;
      <span class="hljs-keyword">const</span> value = toMerge[key];
      <span class="hljs-keyword">const</span> existing = pkg[key];
      <span class="hljs-keyword">if</span> (
        isObject(value) &&
        (key === <span class="hljs-string">"dependencies"</span> || key === <span class="hljs-string">"devDependencies"</span>)
      ) &#123;
        pkg[key] = mergeDeps(existing || &#123;&#125;, value);
      &#125; <span class="hljs-keyword">else</span> &#123;
        pkg[key] = value;
      &#125;
    &#125;
  &#125;

  <span class="hljs-comment">// vue-cli-serviceä¸­çš„ä½¿ç”¨</span>
  <span class="hljs-comment">// api.render('./template', &#123;</span>
  <span class="hljs-comment">//   doesCompile: api.hasPlugin('babel') || api.hasPlugin('typescript'),</span>
  <span class="hljs-comment">//   useBabel: api.hasPlugin('babel')</span>
  <span class="hljs-comment">// &#125;)</span>
  <span class="hljs-comment">// è¿™ä¸€æ­¥æ˜¯æ²¡æœ‰å¾€filesä¸­æ·»åŠ çš„</span>
  <span class="hljs-function"><span class="hljs-title">render</span>(<span class="hljs-params">source, additionalData = &#123;&#125;</span>)</span> &#123;
    <span class="hljs-keyword">const</span> baseDir = extractCallDir(); <span class="hljs-comment">// æå–ç›®å½•</span>
    <span class="hljs-keyword">if</span> (isString(source)) &#123;
      source = path.resolve(baseDir, source);
      <span class="hljs-comment">// æ·»åŠ åˆ°fileMiddlewaresä¸­</span>
      <span class="hljs-built_in">this</span>._injectFileMiddleware(<span class="hljs-keyword">async</span> (files) => &#123;
        <span class="hljs-comment">// è§£æé¢å¤–çš„æ•°æ®</span>
        <span class="hljs-keyword">const</span> data = <span class="hljs-built_in">this</span>._resolveData(additionalData);
        <span class="hljs-keyword">const</span> globby = <span class="hljs-built_in">require</span>(<span class="hljs-string">"globby"</span>); <span class="hljs-comment">// åŒ¹é…æ–‡ä»¶</span>
        <span class="hljs-keyword">const</span> _files = <span class="hljs-keyword">await</span> globby([<span class="hljs-string">"**/*"</span>], &#123; <span class="hljs-attr">cwd</span>: source, <span class="hljs-attr">dot</span>: <span class="hljs-literal">true</span> &#125;);
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> rawPath <span class="hljs-keyword">of</span> _files) &#123;
          <span class="hljs-keyword">const</span> targetPath = rawPath
            .split(<span class="hljs-string">"/"</span>)
            .map(<span class="hljs-function">(<span class="hljs-params">filename</span>) =></span> &#123;
              <span class="hljs-keyword">if</span> (filename.charAt(<span class="hljs-number">0</span>) === <span class="hljs-string">"_"</span> && filename.charAt(<span class="hljs-number">1</span>) !== <span class="hljs-string">"_"</span>) &#123;
                <span class="hljs-keyword">return</span> <span class="hljs-string">`.<span class="hljs-subst">$&#123;filename.slice(<span class="hljs-number">1</span>)&#125;</span>`</span>;
              &#125;
              <span class="hljs-keyword">return</span> filename;
            &#125;)
            .join(<span class="hljs-string">"/"</span>);
          <span class="hljs-keyword">const</span> sourcePath = path.resolve(source, rawPath);
          <span class="hljs-comment">// ä½¿ç”¨ejsæ¨¡ç‰ˆæ¸²æŸ“</span>
          <span class="hljs-keyword">const</span> content = renderFile(sourcePath, data);
          <span class="hljs-comment">// å¦‚æœæ˜¯buffer</span>
          <span class="hljs-keyword">if</span> (Buffer.isBuffer(content) || <span class="hljs-regexp">/[^\s]/</span>.test(content)) &#123;
            files[targetPath] = content;
          &#125;
        &#125;
      &#125;);
    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (isObject(source)) &#123;
    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (isFunction(source)) &#123;
      <span class="hljs-built_in">this</span>._injectFileMiddleware(source);
    &#125;
  &#125;

  <span class="hljs-comment">// å¾€fileMiddlewaresä¸­æ·»åŠ middle è¿™ä¸ªæ—¶å€™åªæ˜¯æ·»åŠ äº† è¿˜æ²¡æœ‰æ‰§è¡Œçš„</span>
  <span class="hljs-comment">// ä¿®æ”¹çš„æ˜¯fileMiddlewareså’Œpkg filesè¿˜æ²¡æœ‰ä¿®æ”¹</span>
  <span class="hljs-comment">// æ‰§è¡ŒresolveFilesçš„æ—¶å€™æ‰ä¼šçœŸæ­£æ‰§è¡Œè¿™äº›middleware</span>
  <span class="hljs-function"><span class="hljs-title">_injectFileMiddleware</span>(<span class="hljs-params">middleware</span>)</span> &#123;
    <span class="hljs-built_in">this</span>.generator.fileMiddlewares.push(middleware);
  &#125;

  <span class="hljs-comment">// vue-server-cliä¼šä½¿ç”¨</span>
  <span class="hljs-function"><span class="hljs-title">hasPlugin</span>(<span class="hljs-params">id</span>)</span> &#123;
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.generator.hasPlugin(id);
  &#125;

  <span class="hljs-function"><span class="hljs-title">_resolveData</span>(<span class="hljs-params">additionalData</span>)</span> &#123;
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">Object</span>.assign(
      &#123;
        <span class="hljs-attr">options</span>: <span class="hljs-built_in">this</span>.options,
        <span class="hljs-attr">rootOptions</span>: <span class="hljs-built_in">this</span>.rootOptions,
        <span class="hljs-attr">plugins</span>: <span class="hljs-built_in">this</span>.pluginsData,
      &#125;,
      additionalData
    );
  &#125;

  <span class="hljs-comment">// Add import statements to a file. vuex vue-router</span>
  <span class="hljs-function"><span class="hljs-title">injectImports</span>(<span class="hljs-params">file, imports</span>)</span> &#123;
    <span class="hljs-keyword">const</span> _imports =
      <span class="hljs-built_in">this</span>.generator.imports[file] ||
      (<span class="hljs-built_in">this</span>.generator.imports[file] = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Set</span>());
    (<span class="hljs-built_in">Array</span>.isArray(imports) ? imports : [imports]).forEach(<span class="hljs-function">(<span class="hljs-params">imp</span>) =></span> &#123;
      _imports.add(imp);
    &#125;);
  &#125;
  <span class="hljs-function"><span class="hljs-title">transformScript</span>(<span class="hljs-params">file, codemod, options</span>)</span> &#123;
    <span class="hljs-comment">// debugger;</span>
    <span class="hljs-keyword">const</span> normalizedPath = <span class="hljs-built_in">this</span>._normalizePath(file);

    <span class="hljs-built_in">this</span>._injectFileMiddleware(<span class="hljs-function">(<span class="hljs-params">files</span>) =></span> &#123;
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> files[normalizedPath] === <span class="hljs-string">"undefined"</span>) &#123;
        error(<span class="hljs-string">`Cannot find file <span class="hljs-subst">$&#123;normalizedPath&#125;</span>`</span>);
        <span class="hljs-keyword">return</span>;
      &#125;
      <span class="hljs-comment">// files[] =</span>
      files[normalizedPath] = runTransformation(
        &#123;
          <span class="hljs-attr">path</span>: <span class="hljs-built_in">this</span>.resolve(normalizedPath),
          <span class="hljs-attr">source</span>: files[normalizedPath],
        &#125;,
        codemod,
        options
      );
    &#125;);
  &#125;
  <span class="hljs-comment">// vue2ä½¿ç”¨çš„ æ³¨å…¥æ ¹é€‰é¡¹</span>
  <span class="hljs-function"><span class="hljs-title">injectRootOptions</span>(<span class="hljs-params"></span>)</span> &#123;
    <span class="hljs-keyword">const</span> _options =
      <span class="hljs-built_in">this</span>.generator.rootOptions[file] ||
      (<span class="hljs-built_in">this</span>.generator.rootOptions[file] = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Set</span>());
    (<span class="hljs-built_in">Array</span>.isArray(options) ? options : [options]).forEach(<span class="hljs-function">(<span class="hljs-params">opt</span>) =></span> &#123;
      _options.add(opt);
    &#125;);
  &#125;

  <span class="hljs-comment">// å¤„ç†æ–‡ä»¶</span>
  <span class="hljs-function"><span class="hljs-title">postProcessFiles</span>(<span class="hljs-params">cb</span>)</span> &#123;
    <span class="hljs-built_in">this</span>.generator.postProcessFilesCbs.push(cb);
  &#125;

  <span class="hljs-function"><span class="hljs-title">_normalizePath</span>(<span class="hljs-params">p</span>)</span> &#123;
    <span class="hljs-keyword">if</span> (path.isAbsolute(p)) &#123;
      p = path.relative(<span class="hljs-built_in">this</span>.generator.context, p);
    &#125;
    <span class="hljs-keyword">return</span> p.replace(<span class="hljs-regexp">/\\/g</span>, <span class="hljs-string">"/"</span>);
  &#125;
  <span class="hljs-function"><span class="hljs-title">resolve</span>(<span class="hljs-params">..._paths</span>)</span> &#123;
    <span class="hljs-keyword">return</span> path.resolve(<span class="hljs-built_in">this</span>.generator.context, ..._paths);
  &#125;
&#125;
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<ol start="5">
<li>resolveFiles</li>
</ol>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// æ‰§è¡Œrenderæ–¹æ³• å¢åŠ importè¯­å¥</span>
<span class="hljs-keyword">async</span> resolveFiles () &#123;
  <span class="hljs-keyword">const</span> files = <span class="hljs-built_in">this</span>.files
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> middleware <span class="hljs-keyword">of</span> <span class="hljs-built_in">this</span>.fileMiddlewares) &#123;
    <span class="hljs-comment">// æ‰§è¡Œæ’ä»¶çš„renderæ–¹æ³• ä½¿ç”¨ejsæ¨¡ç‰ˆæ¸²æŸ“</span>
    <span class="hljs-keyword">await</span> middleware(files, ejs.render)
  &#125;
  <span class="hljs-comment">// æ ¼å¼åŒ–/å’Œ\</span>
  <span class="hljs-comment">// normalizeFilePaths(files)</span>

  <span class="hljs-comment">// handle imports and root option injections</span>
  <span class="hljs-built_in">Object</span>.keys(files).forEach(<span class="hljs-function"><span class="hljs-params">file</span> =></span> &#123;
    <span class="hljs-keyword">let</span> imports = <span class="hljs-built_in">this</span>.imports[file]
    imports = imports <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Set</span> ? <span class="hljs-built_in">Array</span>.from(imports) : imports
    <span class="hljs-keyword">if</span> (imports && imports.length > <span class="hljs-number">0</span>) &#123;
      files[file] = runTransformation(
        &#123; <span class="hljs-attr">path</span>: file, <span class="hljs-attr">source</span>: files[file] &#125;,
        <span class="hljs-built_in">require</span>(<span class="hljs-string">'./util/codemods/injectImports'</span>),
        &#123; imports &#125;
      )
    &#125;

    <span class="hljs-keyword">let</span> injections = <span class="hljs-built_in">this</span>.rootOptions[file]
    injections = injections <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Set</span> ? <span class="hljs-built_in">Array</span>.from(injections) : injections
    <span class="hljs-keyword">if</span> (injections && injections.length > <span class="hljs-number">0</span>) &#123;
      files[file] = runTransformation(
        &#123; <span class="hljs-attr">path</span>: file, <span class="hljs-attr">source</span>: files[file] &#125;,
        <span class="hljs-built_in">require</span>(<span class="hljs-string">'./util/codemods/injectOptions'</span>),
        &#123; injections &#125;
      )
    &#125;
  &#125;)
&#125;
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<ol start="6">
<li>injectImports</li>
</ol>
<pre><code class="hljs language-js copyable" lang="js">
<span class="hljs-comment">// æ’ä»¶vuexéœ€è¦æ’å…¥ import store from './store'</span>
<span class="hljs-comment">// api.injectImports(api.entryFile, `import store from './store'`)</span>

<span class="hljs-comment">// vue-cli-serveæœºè½¦çš„templateå¦‚ä¸‹ æˆ‘ä»¬éœ€è¦æ’å…¥ importè¯­å¥ æ“ä½œast</span>
<span class="hljs-comment">// import &#123; createApp &#125; from 'vue'</span>
<span class="hljs-comment">// import App from './App.vue'</span>
<span class="hljs-comment">// createApp(App).mount('#app')</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">injectImports</span> (<span class="hljs-params">fileInfo, api, &#123; imports &#125;</span>) </span>&#123;
  <span class="hljs-keyword">const</span> j = api.jscodeshift
  <span class="hljs-keyword">const</span> root = j(fileInfo.source)

  <span class="hljs-keyword">const</span> toImportAST = <span class="hljs-function"><span class="hljs-params">i</span> =></span> j(<span class="hljs-string">`<span class="hljs-subst">$&#123;i&#125;</span>\n`</span>).nodes()[<span class="hljs-number">0</span>].program.body[<span class="hljs-number">0</span>]
  <span class="hljs-keyword">const</span> toImportHash = <span class="hljs-function"><span class="hljs-params">node</span> =></span> <span class="hljs-built_in">JSON</span>.stringify(&#123;
    <span class="hljs-attr">specifiers</span>: node.specifiers.map(<span class="hljs-function"><span class="hljs-params">s</span> =></span> s.local.name),
    <span class="hljs-attr">source</span>: node.source.raw
  &#125;)

  <span class="hljs-keyword">const</span> declarations = root.find(j.ImportDeclaration)
  <span class="hljs-keyword">const</span> importSet = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Set</span>(declarations.nodes().map(toImportHash))
  <span class="hljs-keyword">const</span> nonDuplicates = <span class="hljs-function"><span class="hljs-params">node</span> =></span> !importSet.has(toImportHash(node))

  <span class="hljs-keyword">const</span> importASTNodes = imports.map(toImportAST).filter(nonDuplicates)

  <span class="hljs-keyword">if</span> (declarations.length) &#123;
    declarations
      .at(-<span class="hljs-number">1</span>)
      <span class="hljs-comment">// a tricky way to avoid blank line after the previous import</span>
      .forEach(<span class="hljs-function">(<span class="hljs-params">&#123; node &#125;</span>) =></span> <span class="hljs-keyword">delete</span> node.loc)
      .insertAfter(importASTNodes)
  &#125; <span class="hljs-keyword">else</span> &#123;
    <span class="hljs-comment">// no pre-existing import declarations</span>
    root.get().node.program.body.unshift(...importASTNodes)
  &#125;

  <span class="hljs-keyword">return</span> root.toSource()
&#125;
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<h3 data-id="heading-32">3.4 cli-shared-utils</h3>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// æä¾›ä¸€äº›å…¬å…±çš„æ–¹æ³•</span>
yarn workspace @i-box/cli-shared-utils add chalk execa semver chalk strip-ansi readline events ora <span class="hljs-built_in">module</span>
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<h3 data-id="heading-33">3.3 vue-cli-service</h3>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/87e76e1c9ce847e99419d4b798cc934d~tplv-k3u1fbpfcp-watermark.image" alt="service.png" loading="lazy" referrerpolicy="no-referrer"></p>
<h4 data-id="heading-34">1. ä½œä¸ºæ ¸å¿ƒæ’ä»¶ä½¿ç”¨</h4>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// æ ¹æ®ä¸Šé¢çš„æ’ä»¶æˆ‘ä»¬å¯ä»¥çŸ¥é“ æ’ä»¶ä¸­éœ€è¦ä¸€ä¸ªgeneratorç›®å½•</span>
<span class="hljs-comment">// åšä¸¤ä»¶äº‹ ä¸€ä¸ªæ˜¯renderä¸€ä¸ªæ˜¯extendPackage</span>
<span class="hljs-built_in">module</span>.exports = <span class="hljs-function">(<span class="hljs-params">api.options</span>) =></span> &#123;
  <span class="hljs-comment">// æ¸²æŸ“æ¨¡ç‰ˆ</span>
  api.render(<span class="hljs-string">'./template'</span>, &#123;&#125;)
  <span class="hljs-comment">// æ‰©å±•</span>
  api.extendPackage(&#123;
    <span class="hljs-comment">// å¢åŠ è„šæœ¬æ–‡ä»¶</span>
    <span class="hljs-attr">scripts</span>: &#123;
      <span class="hljs-string">'serve'</span>: <span class="hljs-string">'vue-cli-service serve'</span>,
      <span class="hljs-string">'build'</span>: <span class="hljs-string">'vue-cli-service build'</span>
    &#125;,
    <span class="hljs-comment">// å¢åŠ ä¾èµ–</span>
    <span class="hljs-attr">dependencies</span>: &#123;
      <span class="hljs-attr">vue</span>: <span class="hljs-string">"^3.0.4"</span>,
    &#125;,
    <span class="hljs-attr">devDependencies</span>: &#123;
      <span class="hljs-string">"@vue/compiler-sfc"</span>: <span class="hljs-string">"^3.0.4"</span>,
    &#125;,
  &#125;)
&#125;
<span class="hljs-comment">// æ¸²æŸ“äº† template æ‰€ä»¥æˆ‘ä»¬è¿˜éœ€è¦ä¸€ä¸ªtemplateç›®å½•åœ¨å­˜æ”¾æ–‡ä»¶ç”¨æ¥æ¸²æŸ“</span>
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<h4 data-id="heading-35">2. ä½œä¸ºå‘½ä»¤ä½¿ç”¨</h4>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// å¢åŠ å‘½ä»¤ æš‚ä¸åˆ†æ</span>
<span class="hljs-string">"bin"</span>: &#123;
  <span class="hljs-string">"vue-cli-service"</span>: <span class="hljs-string">"bin/vue-cli-service.js"</span>
&#125;,
<span class="hljs-comment">// vue-cli-service serve webpackå¯åŠ¨æœåŠ¡</span>
<span class="hljs-comment">// vue-cli-service build æ‰“åŒ…</span>
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<ol>
<li>Service</li>
</ol>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Service</span> </span>&#123;
  <span class="hljs-function"><span class="hljs-title">constructor</span>(<span class="hljs-params">context, &#123; plugins, pkg, inlineOptions, useBuiltIn &#125; = &#123;&#125;</span>)</span> &#123;
    <span class="hljs-comment">// 5.0æ–°å¢çš„ beatå·²ç»ç”¨äº†webpack</span>
    checkWebpack(context)
    <span class="hljs-comment">// è·å–package.jsonå†…å®¹</span>
    <span class="hljs-built_in">this</span>.pkg = <span class="hljs-built_in">this</span>.resolvePkg(pkg);
    <span class="hljs-comment">// æ’ä»¶ ä¼šå°†serviceçš„æ’ä»¶æ”¾åœ¨é‡Œé¢ å‘½ä»¤ç›¸å…³çš„serve build webpackç›¸å…³çš„config</span>
    <span class="hljs-built_in">this</span>.plugins = <span class="hljs-built_in">this</span>.resolvePlugins(plugins, useBuiltIn)
    <span class="hljs-comment">// vue.config.jsä¸­é…ç½®chainWebpack ä¹Ÿå¯ä»¥è°ƒç”¨apiæ¥ä¿®æ”¹</span>
    <span class="hljs-built_in">this</span>.webpackChainFns = [];
    <span class="hljs-comment">// configureWebpack</span>
    <span class="hljs-built_in">this</span>.webpackRawConfigFns = [];
    <span class="hljs-comment">// æ³¨å†Œçš„å‘½ä»¤ æˆ‘ä»¬ç¼–å†™çš„æ’ä»¶å°±æ˜¯æ³¨å†Œå‘½ä»¤</span>
    <span class="hljs-built_in">this</span>.commands = &#123;&#125;;
  &#125;
  <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-title">run</span>(<span class="hljs-params"></span>)</span> &#123;&#125;
  <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-title">init</span>(<span class="hljs-params"></span>)</span>&#123;&#125;
  <span class="hljs-function"><span class="hljs-title">resolveWebpackConfig</span>(<span class="hljs-params"></span>)</span>&#123;&#125;
&#125;

<span class="hljs-comment">// ä¸»è¦æ˜¯è·å–package.jsonå’Œè§£ææ’ä»¶</span>
<span class="hljs-comment">// æ‰¾åˆ°package.jsonæ–‡ä»¶</span>
<span class="hljs-function"><span class="hljs-title">resolvePkg</span>(<span class="hljs-params">inlinePkg, context = <span class="hljs-built_in">this</span>.context</span>)</span> &#123;
  <span class="hljs-comment">// å’Œä¹‹å‰ä¸€æ ·ä¹Ÿæ˜¯ç”¨require æ‰¾contextçš„package.jsonæ–‡ä»¶</span>
  Module.createRequire(path.resolve(context, <span class="hljs-string">"package.json"</span>)).resolve(context)
&#125;

<span class="hljs-comment">// è§£ææ’ä»¶</span>
<span class="hljs-function"><span class="hljs-title">resolvePlugins</span>(<span class="hljs-params">inlinePlugins</span>)</span> &#123;
  <span class="hljs-comment">// å’Œcliä¸­çš„æ’ä»¶ä¿æŒä¸€æ · å¢åŠ applyæ–¹æ³•</span>
  <span class="hljs-keyword">const</span> idToPlugin = <span class="hljs-function">(<span class="hljs-params">id, absolutePath</span>) =></span> (&#123;
    <span class="hljs-attr">id</span>: id.replace(<span class="hljs-regexp">/^.\//</span>, <span class="hljs-string">"built-in:"</span>),
    <span class="hljs-attr">apply</span>: <span class="hljs-built_in">require</span>(absolutePath || id),
  &#125;);
  <span class="hljs-keyword">let</span> plugins
  <span class="hljs-keyword">const</span> builtInPlugins = [
    <span class="hljs-comment">// å‘½ä»¤</span>
    <span class="hljs-string">"./commands/serve"</span>, <span class="hljs-string">"./commands/build"</span>, <span class="hljs-string">"./commands/inspect"</span>,
    <span class="hljs-comment">// webpacké…ç½®ç›¸å…³çš„</span>
    <span class="hljs-string">"./config/base"</span>,<span class="hljs-string">"./config/assets"</span>, <span class="hljs-string">"./config/css"</span>,<span class="hljs-string">"./config/prod"</span>,
  ].map(<span class="hljs-function">(<span class="hljs-params">id</span>) =></span> idToPlugin(id))
  <span class="hljs-comment">// æ‰¾åˆ°package.jsonæ–‡ä»¶ä¸­çš„plugin</span>
  <span class="hljs-keyword">const</span> projectPlugins = <span class="hljs-built_in">Object</span>.keys(<span class="hljs-built_in">this</span>.pkg.devDependencies || &#123;&#125;)
      .concat(<span class="hljs-built_in">Object</span>.keys(<span class="hljs-built_in">this</span>.pkg.dependencies || &#123;&#125;))
      .filter(isPlugin)
      .map(<span class="hljs-function">(<span class="hljs-params">id</span>) =></span> idToPlugin(id, resolveModule(id, <span class="hljs-built_in">this</span>.pkgContext)));
  <span class="hljs-keyword">return</span> builtInPlugins.concat(projectPlugins)
&#125;
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<ol start="2">
<li>run</li>
</ol>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-title">run</span>(<span class="hljs-params"></span>)</span> &#123;
  <span class="hljs-comment">// åˆå§‹åŒ– åŠ è½½env loadç”¨æˆ·é…ç½®(vue.config.js) åº”ç”¨æ’ä»¶</span>
  <span class="hljs-keyword">await</span> <span class="hljs-built_in">this</span>.init(mode);
  <span class="hljs-comment">// æ‰§è¡Œå¯¹åº”çš„å‘½ä»¤ serverä¸­æ³¨å†Œå‘½ä»¤</span>
  <span class="hljs-keyword">let</span> command = <span class="hljs-built_in">this</span>.commands[name];
  <span class="hljs-keyword">const</span> &#123; fn &#125; = command;
  <span class="hljs-keyword">return</span> fn(args, rawArgv)
&#125;
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<ol start="3">
<li>init</li>
</ol>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// initæ–¹æ³•ä¸»è¦ä¸‰ä¸ª åŠ è½½.envæ–‡ä»¶ åŠ è½½ç”¨æˆ·vue.config.jsé…ç½®æ–‡ä»¶ åº”ç”¨æ’ä»¶(applyæ–¹æ³•æä¾›ä¸€ä¸ªapiæ–¹æ³•)</span>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-title">init</span>(<span class="hljs-params"></span>)</span> &#123;
  <span class="hljs-comment">// åŠ è½½.env </span>
  <span class="hljs-comment">// ç”¨æˆ·é…ç½®çš„å‚æ•°å¿…é¡»æ˜¯ VUE_APP_å¼€å¤´çš„ webpackä¸­ä¼šé€šè¿‡æ­£åˆ™åŒ¹é… webpack.DefinePluginå®šä¹‰æˆå…¨å±€çš„å˜é‡</span>
  <span class="hljs-built_in">this</span>.loadEnv();
  <span class="hljs-comment">// ç”¨æˆ·é…ç½® vue.config.js</span>
  <span class="hljs-keyword">const</span> userOptions = <span class="hljs-built_in">this</span>.loadUserOptions()
  <span class="hljs-comment">// åº”ç”¨æ’ä»¶ æ‰§è¡Œapplyæ–¹æ³•  configæ˜¯webpackç›¸å…³çš„ æ··å…¥ä¸€äº›é…ç½®</span>
  <span class="hljs-comment">// commandsæ˜¯æ³¨å†Œä¸€äº›å‘½ä»¤ åŠ å…¥åˆ°this.commandsä¸­ runçš„æ—¶å€™æ‰§è¡Œå¯¹åº”çš„å‘½ä»¤</span>
  <span class="hljs-keyword">const</span> loadedCallback = <span class="hljs-function">(<span class="hljs-params">loadedUserOptions</span>) =></span> &#123;
    <span class="hljs-built_in">this</span>.plugins.forEach(<span class="hljs-function">(<span class="hljs-params">&#123; id, apply &#125;</span>) =></span> &#123;
      <span class="hljs-comment">// æ‰§è¡Œapplyæ–¹æ³• ä¼ å…¥ä¸€äº›apiæ–¹æ³•ç»™æ’ä»¶æ¥ä½¿ç”¨</span>
      apply(<span class="hljs-keyword">new</span> PluginAPI(id, <span class="hljs-built_in">this</span>), <span class="hljs-built_in">this</span>.projectOptions);
    &#125;); 
    <span class="hljs-comment">// webpackç›¸å…³ vue.config.jsä¸­é…ç½®</span>
    <span class="hljs-built_in">this</span>.webpackChainFns.push(<span class="hljs-built_in">this</span>.projectOptions.chainWebpack)
    <span class="hljs-built_in">this</span>.webpackRawConfigFns.push(<span class="hljs-built_in">this</span>.projectOptions.configureWebpack)
  &#125;
  <span class="hljs-keyword">return</span> loadedCallback(userOptions)
  resolveWebpackConfig()
&#125;
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<ol start="4">
<li>PluginAPI</li>
</ol>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// è¿™äº›apiæˆ‘ä»¬åœ¨å¼€å‘æ’ä»¶çš„æ—¶å€™å¯ä»¥ä½¿ç”¨åˆ°</span>
<span class="hljs-comment">// æ’ä»¶apiä¸€ä¸ªæ˜¯æ³¨å†Œå‘½ä»¤ ä¸€ä¸ªæ˜¯ä¿®æ”¹é…ç½®</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PluginAPI</span> </span>&#123;
  <span class="hljs-comment">// æ³¨å†Œå‘½ä»¤ serve buildéƒ½æ˜¯è¿™æ ·æ³¨å†Œçš„</span>
  <span class="hljs-function"><span class="hljs-title">registerCommand</span>(<span class="hljs-params">name, opts, fn</span>)</span> &#123;
    <span class="hljs-built_in">this</span>.service.commands[name] = &#123; fn, <span class="hljs-attr">opts</span>: opts || &#123;&#125; &#125;;
  &#125;
  <span class="hljs-comment">// ä¿®æ”¹webpacké…ç½®</span>
  <span class="hljs-function"><span class="hljs-title">chainWebpack</span>(<span class="hljs-params"></span>)</span> &#123;
    <span class="hljs-built_in">this</span>.service.webpackChainFns.push(fn);
  &#125;
  <span class="hljs-function"><span class="hljs-title">configureWebpack</span>(<span class="hljs-params"></span>)</span> &#123; &#125;
  <span class="hljs-function"><span class="hljs-title">configureDevServer</span>(<span class="hljs-params">fn</span>)</span> &#123;&#125;
  <span class="hljs-function"><span class="hljs-title">resolveWebpackConfig</span>(<span class="hljs-params"></span>)</span> &#123;&#125;
  <span class="hljs-function"><span class="hljs-title">resolveChainableWebpackConfig</span>(<span class="hljs-params"></span>)</span>&#123;&#125;
&#125;
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<h3 data-id="heading-36">4. æ’ä»¶</h3>
<ol>
<li>æ³¨å†Œå‘½ä»¤</li>
</ol>
<pre><code class="hljs language-js copyable" lang="js">program.command(<span class="hljs-string">"add <plugin> [pluginOptions]"</span>).action(<span class="hljs-function">(<span class="hljs-params">plugin</span>) =></span> &#123;
  <span class="hljs-built_in">require</span>(<span class="hljs-string">"../lib/add"</span>)(plugin, minimist(process.argv.slice(<span class="hljs-number">3</span>)));
&#125;);
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<ol start="2">
<li>add</li>
</ol>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// vue add native-ui</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">add</span> (<span class="hljs-params">pluginToAdd, options = &#123;&#125;, context = process.cwd()</span>) </span>&#123;
  <span class="hljs-comment">// å¦‚æœæœ‰æœªæäº¤çš„ä»£ç ç›´æ¥return</span>
  <span class="hljs-keyword">if</span> (!(<span class="hljs-keyword">await</span> confirmIfGitDirty(context))) &#123;  <span class="hljs-keyword">return</span> &#125;
  <span class="hljs-keyword">const</span> packageName = resolvePluginId(pluginName)
  <span class="hljs-comment">// yarn add xxx</span>
  <span class="hljs-keyword">await</span> pm.add(<span class="hljs-string">`<span class="hljs-subst">$&#123;packageName&#125;</span>@<span class="hljs-subst">$&#123;pluginVersion&#125;</span>`</span>)
  <span class="hljs-keyword">const</span> generatorPath = resolveModule(<span class="hljs-string">`<span class="hljs-subst">$&#123;packageName&#125;</span>/generator`</span>, context)
  <span class="hljs-comment">// const generator = new Generator(</span>
  <span class="hljs-comment">// await generator.generate()</span>
  invoke(pluginName, options, context)
&#125;
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<ol start="3">
<li>api</li>
</ol>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// GeneratorAPI ç»™æˆ‘ä»¬æä¾›ä¸€äº›api</span>
<span class="hljs-comment">// https://github.com/vuejs/vue-cli/blob/dev/packages/%40vue/cli/lib/GeneratorAPI.js</span>
<span class="hljs-comment">// æ’ä»¶ä¸€èˆ¬æ˜¯ç”¨ ä¿®æ”¹package.jsonæ–‡ä»¶ å¢åŠ å‘½ä»¤(ä¿®æ”¹scripts å¢åŠ ä¾èµ–é¡¹) åŠ¨æ€æ³¨å…¥import renderæ¸²æŸ“ æ¨¡ç‰ˆæ–‡ä»¶ç­‰</span>
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<ol start="4">
<li>å®ç°ä¸€ä¸ªç®€å•çš„æ’ä»¶</li>
</ol>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// å°†å®˜æ–¹æä¾›çš„vuexåšç®€å•çš„ä¿®æ”¹å³å¯</span>
<span class="hljs-built_in">module</span>.exports = <span class="hljs-function">(<span class="hljs-params">api, options = &#123;&#125;, rootOptions = &#123;&#125;</span>) =></span> &#123;
  api.injectImports(api.entryFile, <span class="hljs-string">`import native from './plugins/native-ui';`</span>);
  api.transformScript(api.entryFile, <span class="hljs-built_in">require</span>(<span class="hljs-string">"./injectUseNativeUi"</span>));
  <span class="hljs-comment">// åŠ ä¸€ä¸ªä¾èµ–</span>
  api.extendPackage(&#123;
    <span class="hljs-attr">dependencies</span>: &#123;
      <span class="hljs-string">"naive-ui"</span>: <span class="hljs-string">"^2.11.4"</span>,
    &#125;,
  &#125;);
  <span class="hljs-comment">// æ¸²æŸ“templateä¸‹çš„æ–‡ä»¶</span>
  api.render(<span class="hljs-string">"./template"</span>, &#123;&#125;);
  <span class="hljs-comment">// æä¾›é€‰é¡¹ç»™ç”¨æˆ· éƒ¨åˆ†å¯¼å…¥è¿˜æ˜¯å…¨éƒ¨å¯¼å…¥</span>
  <span class="hljs-comment">// if (options.import === "partial") &#123;</span>
  <span class="hljs-comment">// &#125;</span>
&#125;;
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre></div>  
</div>
            