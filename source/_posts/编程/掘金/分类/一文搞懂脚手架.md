
---
title: '一文搞懂脚手架'
categories: 
 - 编程
 - 掘金
 - 分类
headimg: 'https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9c6c0dcb8d1b486ea44f9e74c32146a5~tplv-k3u1fbpfcp-watermark.image'
author: 掘金
comments: false
date: Mon, 19 Jul 2021 01:20:03 GMT
thumbnail: 'https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9c6c0dcb8d1b486ea44f9e74c32146a5~tplv-k3u1fbpfcp-watermark.image'
---

<div>   
<div class="markdown-body"><style>.markdown-body&#123;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333&#125;.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6&#123;line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px&#125;.markdown-body h1&#123;font-size:30px;margin-bottom:5px&#125;.markdown-body h2&#123;padding-bottom:12px;font-size:24px;border-bottom:1px solid #ececec&#125;.markdown-body h3&#123;font-size:18px;padding-bottom:0&#125;.markdown-body h4&#123;font-size:16px&#125;.markdown-body h5&#123;font-size:15px&#125;.markdown-body h6&#123;margin-top:5px&#125;.markdown-body p&#123;line-height:inherit;margin-top:22px;margin-bottom:22px&#125;.markdown-body img&#123;max-width:100%&#125;.markdown-body hr&#123;border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px&#125;.markdown-body code&#123;word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em&#125;.markdown-body code,.markdown-body pre&#123;font-family:Menlo,Monaco,Consolas,Courier New,monospace&#125;.markdown-body pre&#123;overflow:auto;position:relative;line-height:1.75&#125;.markdown-body pre>code&#123;font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8&#125;.markdown-body a&#123;text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff&#125;.markdown-body a:active,.markdown-body a:hover&#123;color:#275b8c&#125;.markdown-body table&#123;display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6&#125;.markdown-body thead&#123;background:#f6f6f6;color:#000;text-align:left&#125;.markdown-body tr:nth-child(2n)&#123;background-color:#fcfcfc&#125;.markdown-body td,.markdown-body th&#123;padding:12px 7px;line-height:24px&#125;.markdown-body td&#123;min-width:120px&#125;.markdown-body blockquote&#123;color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8&#125;.markdown-body blockquote:after&#123;display:block;content:""&#125;.markdown-body blockquote>p&#123;margin:10px 0&#125;.markdown-body ol,.markdown-body ul&#123;padding-left:28px&#125;.markdown-body ol li,.markdown-body ul li&#123;margin-bottom:0;list-style:inherit&#125;.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item&#123;list-style:none&#125;.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul&#123;margin-top:0&#125;.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul&#123;margin-top:3px&#125;.markdown-body ol li&#123;padding-left:6px&#125;.markdown-body .contains-task-list&#123;padding-left:0&#125;.markdown-body .task-list-item&#123;list-style:none&#125;@media (max-width:720px)&#123;.markdown-body h1&#123;font-size:24px&#125;.markdown-body h2&#123;font-size:20px&#125;.markdown-body h3&#123;font-size:18px&#125;&#125;</style><h2 data-id="heading-0">1. 脚手架对比</h2>

























<table><thead><tr><th>脚手架</th><th>命令</th></tr></thead><tbody><tr><td>vue-cli2</td><td>vue init webpack hello</td></tr><tr><td>vue-cli4(5)</td><td>vue create hello-world</td></tr><tr><td>cra</td><td>npx create-react-app my-app</td></tr><tr><td>vite</td><td>yarn create vite</td></tr></tbody></table>
<h2 data-id="heading-1">2. vue-cli2</h2>
<h3 data-id="heading-2">2.1 初始化项目</h3>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// 因为是老版本了指定版本 可以使用npx来执行</span>
npm install -g vue-cli@<span class="hljs-number">2</span> --force
vue init webpack hello-vue-cli2
<span class="copy-code-btn">复制代码</span></code></pre>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9c6c0dcb8d1b486ea44f9e74c32146a5~tplv-k3u1fbpfcp-watermark.image" alt="downloading.png" loading="lazy" referrerpolicy="no-referrer"></p>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/24c18a50b5c14184be8494bcea0cd16d~tplv-k3u1fbpfcp-watermark.image" alt="vue-cli2.png" loading="lazy" referrerpolicy="no-referrer"></p>
<h3 data-id="heading-3">2.2 基本流程</h3>
<pre><code class="hljs language-js copyable" lang="js">downloading template...
<span class="hljs-comment">// 1. 选择一些选项</span>
? Project name
vue-cli · Generated <span class="hljs-string">"hello-vue-cli2"</span>.
<span class="hljs-comment">// 2. 安装依赖</span>
Installing project dependencies ...
<span class="hljs-comment">// 3. Project initialization finished!</span>
<span class="copy-code-btn">复制代码</span></code></pre>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/452ddb31db3d42f0bdf0925cab5f0a9d~tplv-k3u1fbpfcp-watermark.image" alt="flow.png" loading="lazy" referrerpolicy="no-referrer"></p>
<h3 data-id="heading-4">2.3 基本思路</h3>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// 1. 注册命令 vue init</span>
<span class="hljs-comment">// 2. 下载模板到缓存目录</span>
<span class="hljs-comment">// 3. 获取用户交互数据 生成项目 </span>
<span class="hljs-comment">// 4.安装依赖</span>
<span class="copy-code-btn">复制代码</span></code></pre>
<h3 data-id="heading-5">2.4 简单实现</h3>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// https://github.com/vuejs/vue-cli/tree/v2</span>
mkdir <span class="hljs-number">1.</span>vue-cli2 && cd <span class="hljs-number">1.</span>vue-cli2
npm init -y
<span class="hljs-comment">// 安装一些依赖</span>
npm install commander chalk ora inquirer download-git-repo metalsmith handlebars consolidate <span class="hljs-keyword">async</span> minimatch

<span class="hljs-comment">// https://www.npmjs.com/package/download-git-repo 下载git上仓库代码</span>
<span class="hljs-keyword">const</span> download = <span class="hljs-built_in">require</span>(<span class="hljs-string">'download-git-repo'</span>) 
<span class="hljs-comment">// https://www.npmjs.com/package/commander 命令行</span>
<span class="hljs-keyword">const</span> program = <span class="hljs-built_in">require</span>(<span class="hljs-string">'commander'</span>)
<span class="hljs-comment">// https://www.npmjs.com/package/ora 显示loading效果</span>
<span class="hljs-keyword">const</span> ora = <span class="hljs-built_in">require</span>(<span class="hljs-string">'ora'</span>)
<span class="hljs-comment">// https://www.npmjs.com/package/inquirer 用户交互</span>
<span class="hljs-keyword">const</span> inquirer = <span class="hljs-built_in">require</span>(<span class="hljs-string">'inquirer'</span>)
<span class="hljs-comment">// https://www.npmjs.com/package/chalk 输出彩色文字</span>
<span class="hljs-keyword">const</span> chalk = <span class="hljs-built_in">require</span>(<span class="hljs-string">'chalk'</span>)
<span class="hljs-comment">// https://www.npmjs.com/package/metalsmith 可插拔的静态站点生成器</span>
<span class="hljs-keyword">const</span> Metalsmith = <span class="hljs-built_in">require</span>(<span class="hljs-string">'metalsmith'</span>)
<span class="hljs-comment">// https://www.npmjs.com/package/handlebars 模板引擎</span>
<span class="hljs-keyword">const</span> Handlebars = <span class="hljs-built_in">require</span>(<span class="hljs-string">'handlebars'</span>)
<span class="hljs-comment">// https://www.npmjs.com/package/consolidate 模板引擎的结合体。包括了常用的jade和ejs</span>
<span class="hljs-keyword">const</span> render = <span class="hljs-built_in">require</span>(<span class="hljs-string">'consolidate'</span>).handlebars.render
<span class="hljs-comment">// https://www.npmjs.com/package/async for use with Node-style callbacks</span>
<span class="hljs-keyword">const</span> <span class="hljs-keyword">async</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">'async'</span>)
<span class="hljs-comment">// https://www.npmjs.com/package/minimatch 匹配文件</span>
<span class="hljs-keyword">const</span> match = <span class="hljs-built_in">require</span>(<span class="hljs-string">'minimatch'</span>)
<span class="copy-code-btn">复制代码</span></code></pre>
<ol>
<li>注册命令</li>
</ol>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// 在package.json文件中增加bin </span>
<span class="hljs-string">"bin"</span>: &#123;
  <span class="hljs-string">"vue-init"</span>: <span class="hljs-string">"bin/vue-init"</span>,
&#125;
<span class="copy-code-btn">复制代码</span></code></pre>
<ol start="2">
<li>vue-init.js</li>
</ol>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// 根据用户选项下载指定模板</span>
<span class="hljs-comment">// 1. 解析命令行参数</span>
program
  .usage(<span class="hljs-string">'<template-name> [project-name]'</span>)
program.parse(process.argv)
<span class="hljs-comment">// template-name(webpack) vue init webpack hello</span>
<span class="hljs-keyword">const</span> template = program.args[<span class="hljs-number">0</span>]
<span class="hljs-comment">// 项目名 hello</span>
<span class="hljs-keyword">const</span> rawName = program.args[<span class="hljs-number">1</span>]
<span class="hljs-comment">// /Users/liu/.vue-templates/webpack 会在.vue-templates目录下看是否有缓存</span>
<span class="hljs-keyword">const</span> tmp = path.join(home, <span class="hljs-string">'.vue-templates'</span>, template.replace(<span class="hljs-regexp">/[\/:]/g</span>, <span class="hljs-string">'-'</span>))
<span class="copy-code-btn">复制代码</span></code></pre>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// 2. 拉取template代码 这里只是将template模板拉取下来了 还没有生成我们的项目</span>
<span class="hljs-keyword">const</span> spinner = ora(<span class="hljs-string">'downloading template'</span>)
spinner.start()
<span class="hljs-keyword">const</span> officialTemplate = <span class="hljs-string">'vuejs-templates/'</span> + template
<span class="hljs-comment">// https://github.com/vuejs-templates/webpack</span>
<span class="hljs-comment">// 下载模板 webpack 将webpack git clone 到 .vue-templates/webpack中</span>
download(officialTemplate, tmp, &#123; clone &#125;, <span class="hljs-function"><span class="hljs-params">err</span> =></span> &#123;
  spinner.stop()
  generate(rawName, tmp, to, <span class="hljs-function"><span class="hljs-params">err</span> =></span> &#123;
    logger.success(<span class="hljs-string">'Generated "%s".'</span>, name)
  &#125;)
&#125;)
<span class="copy-code-btn">复制代码</span></code></pre>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/286944c9aa9142f697e083e82f8186ee~tplv-k3u1fbpfcp-watermark.image" alt="template.png" loading="lazy" referrerpolicy="no-referrer"></p>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// 3. 生成项目 generate 用户交互 处理template目录中的内容</span>
<span class="hljs-comment">// 最简单的就是不处理用户的选项 直接将整个项目copy到我们的目录中</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">generate</span>(<span class="hljs-params">name, src, dest, done</span>) </span>&#123;
  <span class="hljs-comment">// 1. 获取选项 </span>
  <span class="hljs-keyword">const</span> js = path.join(src, <span class="hljs-string">"meta.js"</span>); <span class="hljs-comment">// 找到 vuejs-templates/webpack下的meta.js文件</span>
  <span class="hljs-keyword">const</span> req = <span class="hljs-built_in">require</span>(path.resolve(js));
  <span class="hljs-comment">// &#123;metalsmith:&#123; before: addTestAnswers&#125;, prompts, filters&#125;</span>
  <span class="hljs-keyword">const</span> opts = req;

  <span class="hljs-comment">// 2. metalsmith</span>
  <span class="hljs-keyword">const</span> metalsmith = Metalsmith(path.join(src, <span class="hljs-string">"template"</span>));
  <span class="hljs-keyword">const</span> data = <span class="hljs-built_in">Object</span>.assign(metalsmith.metadata(), &#123;
    <span class="hljs-attr">destDirName</span>: name,
    <span class="hljs-attr">inPlace</span>: dest === process.cwd(),
    <span class="hljs-attr">noEscape</span>: <span class="hljs-literal">true</span>,
  &#125;);

  <span class="hljs-comment">// 3. 处理用户交互</span>
  metalsmith.use(askQuestions(opts.prompts))
  <span class="hljs-comment">// 4. 根据用户的选项过滤一些文件</span>
  <span class="hljs-comment">// vue-cli是filter文件 vue-cli4提供的插件一般是提供最基础的template新增一些文件</span>
  .use(filterFiles(opts.filters))
  <span class="hljs-comment">// 5. build成最终的文件</span>
  metalsmith
    .clean(<span class="hljs-literal">false</span>)
    .source(<span class="hljs-string">"."</span>) <span class="hljs-comment">// start from template root instead of `./src` which is Metalsmith's default for `source`</span>
    .destination(dest)
    .build(<span class="hljs-function">(<span class="hljs-params">err, files</span>) =></span> &#123;
      <span class="hljs-comment">// console.log(err, files)</span>
      done(err);
      <span class="hljs-comment">// installDependencies</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> opts.complete === <span class="hljs-string">'function'</span>) &#123;
        opts.complete(data, &#123;chalk&#125;)
      &#125;
    &#125;);
  <span class="hljs-keyword">return</span> data;
&#125; 
<span class="copy-code-btn">复制代码</span></code></pre>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9c1dbe4fdd1d4cc19ab5cc30e8e7d21d~tplv-k3u1fbpfcp-watermark.image" alt="meta.png" loading="lazy" referrerpolicy="no-referrer"></p>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// 3. 处理用户交互</span>
metalsmith
  <span class="hljs-comment">// .use(askQuestions(opts.prompts))</span>
  <span class="hljs-comment">// 获取用户的选项</span>
  .use(<span class="hljs-function">(<span class="hljs-params">files, metalsmith, done</span>) =></span> &#123;
    <span class="hljs-comment">// ask(opts.prompts, metalsmith.metadata(), done)</span>
    <span class="hljs-keyword">async</span>.eachSeries(
      <span class="hljs-built_in">Object</span>.keys(opts.prompts),
      <span class="hljs-function">(<span class="hljs-params">key, next</span>) =></span> &#123;
        <span class="hljs-comment">// 会在metadata中添加属性</span>
        prompt(metalsmith.metadata(), key, opts.prompts[key], next);
      &#125;,
      done
    );
  &#125;)
<span class="copy-code-btn">复制代码</span></code></pre>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9c1dbe4fdd1d4cc19ab5cc30e8e7d21d~tplv-k3u1fbpfcp-watermark.image" alt="prompts.png" loading="lazy" referrerpolicy="no-referrer"></p>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// 4. 根据用户的选项过滤一些文件</span>
<span class="hljs-comment">// vue-cli是filter文件 vue-cli4提供的插件一般是提供最基础的template新增一些文件</span>
metalsmith.use(<span class="hljs-function">(<span class="hljs-params">files, metalsmith, done</span>) =></span> &#123;
  <span class="hljs-comment">// filter(files, opts.filters, metalsmith.metadata(), done)</span>
  <span class="hljs-keyword">const</span> fileNames = <span class="hljs-built_in">Object</span>.keys(files);
  <span class="hljs-built_in">Object</span>.keys(opts.filters).forEach(<span class="hljs-function">(<span class="hljs-params">glob</span>) =></span> &#123;
    fileNames.forEach(<span class="hljs-function">(<span class="hljs-params">file</span>) =></span> &#123;
      <span class="hljs-keyword">if</span> (match(file, glob, &#123; <span class="hljs-attr">dot</span>: <span class="hljs-literal">true</span> &#125;)) &#123;
        <span class="hljs-keyword">const</span> condition = opts.filters[glob];
        <span class="hljs-keyword">const</span> fn = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Function</span>(
          <span class="hljs-string">"data"</span>,
          <span class="hljs-string">"with (data) &#123; return "</span> + condition + <span class="hljs-string">"&#125;"</span>
        );
        <span class="hljs-keyword">if</span> (!fn(metalsmith.metadata())) &#123;
          <span class="hljs-keyword">delete</span> files[file];
        &#125;
      &#125;
    &#125;);
  &#125;);
  done();
&#125;)
<span class="copy-code-btn">复制代码</span></code></pre>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c17330617546476896a35867a86e9c91~tplv-k3u1fbpfcp-watermark.image" alt="metadata.png" loading="lazy" referrerpolicy="no-referrer"></p>
<ol start="3">
<li>meta.js</li>
</ol>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// 我们有很多的逻辑是要meta.js中处理的</span>
<span class="hljs-comment">// https://github.com/vuejs-templates/webpack/blob/develop/meta.js</span>
<span class="hljs-built_in">module</span>.exports = &#123;
  <span class="hljs-attr">metalsmith</span>: &#123;
    <span class="hljs-comment">// When running tests for the template, this adds answers for the selected scenario</span>
    <span class="hljs-attr">before</span>: addTestAnswers
  &#125;,
  <span class="hljs-attr">prompts</span>: &#123;&#125;,
  <span class="hljs-attr">filters</span>: &#123;&#125;
  <span class="hljs-comment">// 完成之后安装依赖</span>
  <span class="hljs-attr">complete</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">data, &#123; chalk &#125;</span>) </span>&#123;
    <span class="hljs-keyword">const</span> green = chalk.green
    sortDependencies(data, green)
    <span class="hljs-keyword">const</span> cwd = path.join(process.cwd(), data.destDirName)
    <span class="hljs-comment">// runCommand(executable, ['install'], &#123;cwd&#125;)</span>
    <span class="hljs-comment">// 使用node的spawn const spawn = require('child_process').spawn</span>
    <span class="hljs-comment">// spawn()</span>
    installDependencies(cwd, data.autoInstall, green)
      .then(<span class="hljs-function">() =></span> &#123;
        <span class="hljs-keyword">return</span> runLintFix(cwd, data, green)
      &#125;)
      .then(<span class="hljs-function">() =></span> &#123;
        printMessage(data, green)
      &#125;)
      .catch(<span class="hljs-function"><span class="hljs-params">e</span> =></span> &#123;
        <span class="hljs-built_in">console</span>.log(chalk.red(<span class="hljs-string">'Error:'</span>), e)
      &#125;)
  &#125;,
&#125;
<span class="copy-code-btn">复制代码</span></code></pre>
<ol start="4">
<li>处理缓存</li>
</ol>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// 我们通过template的命令去拉取模板文件 但是当我们本地存在的时候可以直接使用 .vue-template中的资源</span>
<span class="hljs-keyword">if</span> (exists(templatePath)) &#123;
  <span class="hljs-comment">// 当存在的时候就直接 generate而不会去download</span>
  generate()
&#125;

<span class="hljs-number">5.</span> gitee
<span class="hljs-string">``</span><span class="hljs-string">`js
// 如果我们需要自己下载git仓库的模板 gitee的api文档
const gitUrl = `</span>https:<span class="hljs-comment">//gitee.com/api/v5/orgs/$&#123;org&#125;/repos`;</span>
<span class="hljs-comment">// gitee可以使用 个人觉得实现不够友好 是对download-git-repo的扩展</span>
<span class="hljs-comment">// 期待gitee 王圣松 大佬提供更好的npm包</span>
npm install zdex-downloadgitrepo
<span class="hljs-comment">// 简单实现</span>
<span class="hljs-comment">// https://gitee.com/vue-next/vue3-cli/tree/v2.0</span>
<span class="copy-code-btn">复制代码</span></code></pre>
<h3 data-id="heading-6">2.5 npm包发布</h3>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// 1. 调试</span>
npm link
ibox-vue-init webpack hello
<span class="hljs-comment">// 2. 发布npm包</span>
npm login (npm whoami)
npm publish
<span class="hljs-comment">// You must sign up for private packages</span>
npm publish --access public
<span class="copy-code-btn">复制代码</span></code></pre>
<h2 data-id="heading-7">3. vite</h2>
<h3 data-id="heading-8">3.1 初始化项目</h3>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// https://cn.vitejs.dev/</span>
<span class="hljs-comment">// vite不在本文考虑范围内 我们只是分析 vite中 create-vite包的实现</span>
<span class="hljs-comment">// vite采用了monorepo的管理方式 vite的实现在构建篇分析 这里不分析具体的实现</span>
<span class="hljs-comment">// 指令会先安装create-vite 执行</span>
yarn create vite
<span class="copy-code-btn">复制代码</span></code></pre>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/495eb2bbaafb4928a945d666de3dc864~tplv-k3u1fbpfcp-watermark.image" alt="vitejs.png" loading="lazy" referrerpolicy="no-referrer"></p>
<h3 data-id="heading-9">3.2 基本流程</h3>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// 1. 输出项目名称</span>
<span class="hljs-comment">// 2. 选择框架</span>
<span class="hljs-comment">// 3. 选择variant 是否需要ts</span>
<span class="copy-code-btn">复制代码</span></code></pre>
<h3 data-id="heading-10">3.3 基本思路</h3>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// https://github.com/vitejs/vite/tree/main/packages/create-vite</span>
<span class="hljs-comment">// create-vite的实现比较简单 就是根据选项直接从项目中拉取文件</span>
template-vue-ts
template-vue
<span class="copy-code-btn">复制代码</span></code></pre>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/22cca2f843a04cdfa40233bff12020ca~tplv-k3u1fbpfcp-watermark.image" alt="template.png" loading="lazy" referrerpolicy="no-referrer"></p>
<h3 data-id="heading-11">3.4 简单实现</h3>
<ol>
<li>初始化项目</li>
</ol>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// 我们只是简单实现 crete-vite就不使用 lerna初始化项目了</span>
npm init -y
<span class="hljs-comment">// 增加bin字段</span>
<span class="hljs-string">"bin"</span>: &#123;
  <span class="hljs-string">"create-box-vite"</span>: <span class="hljs-string">"index.js"</span>,
  <span class="hljs-string">"ibox-cva"</span>: <span class="hljs-string">"index.js"</span>
&#125;,
<span class="hljs-comment">// 注意 ⚠️ 我们要加上files字段</span>
<span class="hljs-comment">// 安装依赖</span>
npm install minimist prompts kolorist
<span class="hljs-comment">// https://www.npmjs.com/package/minimist 轻量级的命令行参数解析 commander</span>
<span class="hljs-keyword">const</span> argv = <span class="hljs-built_in">require</span>(<span class="hljs-string">"minimist"</span>)(process.argv.slice(<span class="hljs-number">2</span>));
<span class="hljs-comment">// https://www.npmjs.com/package/prompts 用户交互 inquirer.prompt</span>
<span class="hljs-keyword">const</span> prompts = <span class="hljs-built_in">require</span>(<span class="hljs-string">"prompts"</span>);
<span class="hljs-comment">// https://www.npmjs.com/package/kolorist 轻量命令行输出工具  chalk</span>
<span class="hljs-keyword">const</span> &#123; blue &#125; = <span class="hljs-built_in">require</span>(<span class="hljs-string">"kolorist"</span>);
<span class="copy-code-btn">复制代码</span></code></pre>
<ol start="2">
<li>index.js</li>
</ol>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// 1. 定义我们支持的框架列表 简化为只支持vue和react</span>
<span class="hljs-keyword">const</span> FRAMEWORKS = [
  &#123;
    <span class="hljs-attr">name</span>: <span class="hljs-string">'vue'</span>,
    <span class="hljs-attr">color</span>: green,
    <span class="hljs-attr">variants</span>: [
      &#123;
        <span class="hljs-attr">name</span>: <span class="hljs-string">'vue'</span>,
        <span class="hljs-attr">display</span>: <span class="hljs-string">'JavaScript'</span>,
        <span class="hljs-attr">color</span>: yellow
      &#125;,
      &#123;
        <span class="hljs-attr">name</span>: <span class="hljs-string">'vue-ts'</span>,
        <span class="hljs-attr">display</span>: <span class="hljs-string">'TypeScript'</span>,
        <span class="hljs-attr">color</span>: blue
      &#125;
    ]
  &#125;,
  &#123;
    <span class="hljs-attr">name</span>: <span class="hljs-string">'react'</span>,
    <span class="hljs-attr">color</span>: cyan,
    <span class="hljs-attr">variants</span>: [
      &#123;
        <span class="hljs-attr">name</span>: <span class="hljs-string">'react'</span>,
        <span class="hljs-attr">display</span>: <span class="hljs-string">'JavaScript'</span>,
        <span class="hljs-attr">color</span>: yellow
      &#125;,
      &#123;
        <span class="hljs-attr">name</span>: <span class="hljs-string">'react-ts'</span>,
        <span class="hljs-attr">display</span>: <span class="hljs-string">'TypeScript'</span>,
        <span class="hljs-attr">color</span>: blue
      &#125;
    ]
  &#125;
]
<span class="hljs-comment">// [ 'vue', 'vue-ts', 'react', 'react-ts' ] </span>
<span class="hljs-keyword">const</span> TEMPLATES = FRAMEWORKS.map(
  <span class="hljs-function">(<span class="hljs-params">f</span>) =></span> (f.variants && f.variants.map(<span class="hljs-function">(<span class="hljs-params">v</span>) =></span> v.name)) || [f.name]
).reduce(<span class="hljs-function">(<span class="hljs-params">a, b</span>) =></span> a.concat(b), [])


<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">init</span>(<span class="hljs-params"></span>) </span>&#123;
  <span class="hljs-comment">// 2. 等待用户选择结果 projectName framework variant</span>
  <span class="hljs-keyword">let</span> result = <span class="hljs-keyword">await</span> prompts([])
  <span class="hljs-keyword">const</span> &#123; framework, packageName, variant &#125; = result
  template = variant || framework || template
  <span class="hljs-comment">// 3.根据用户的选项找到 对应的 template 模板文件</span>
  <span class="hljs-keyword">const</span> templateDir = path.join(__dirname, <span class="hljs-string">`template-<span class="hljs-subst">$&#123;template&#125;</span>`</span>)
  <span class="hljs-comment">// 4.将文件遍历copy到我们的目录中</span>
  <span class="hljs-keyword">const</span> files = fs.readdirSync(templateDir)
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> file <span class="hljs-keyword">of</span> files.filter(<span class="hljs-function">(<span class="hljs-params">f</span>) =></span> f !== <span class="hljs-string">'package.json'</span>)) &#123;
    write(file)
  &#125;
  <span class="hljs-comment">// 单独处理package.json文件 要添加name属性</span>
  <span class="hljs-comment">// .gitignore 文件需要 renameFiles .开头的文件会出问题</span>
&#125;
<span class="copy-code-btn">复制代码</span></code></pre>
<ol start="3">
<li>template文件</li>
</ol>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// 我们可以用自己的最佳实践 直接拷贝vite的内容</span>
<span class="copy-code-btn">复制代码</span></code></pre>
<h3 data-id="heading-12">3.5 npm包发布</h3>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// i-box/create-vite@0.0.1</span>
<span class="hljs-comment">// 包名是 @i-box/create-box-vite 不需要create yarn add做了什么?</span>
<span class="hljs-comment">// 执行 yarn create @i-box/box-vite</span>
<span class="copy-code-btn">复制代码</span></code></pre>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a8449388f870479f85e89a2ea7ae4f48~tplv-k3u1fbpfcp-watermark.image" alt="result.png" loading="lazy" referrerpolicy="no-referrer"></p>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e15c2f133b054bb7bb3edcc808f71a5d~tplv-k3u1fbpfcp-watermark.image" alt="yarn.png" loading="lazy" referrerpolicy="no-referrer"></p>
<h2 data-id="heading-13">4. cra</h2>
<h3 data-id="heading-14">4.1 初始化项目</h3>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// https://github.com/facebook/create-react-app</span>
npx create-react-app react-demo
<span class="copy-code-btn">复制代码</span></code></pre>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/8aa0c9c6535f4127a120c32893c555be~tplv-k3u1fbpfcp-watermark.image" alt="cra.png" loading="lazy" referrerpolicy="no-referrer"></p>
<h3 data-id="heading-15">4.2 基本流程</h3>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// 1. 创建项目 mkdir my-app</span>
Creating a <span class="hljs-keyword">new</span> React app <span class="hljs-keyword">in</span> /Users/liu/my-app.
<span class="hljs-comment">// 2.初始化npm按照依赖 </span>
<span class="hljs-comment">// cd my-app npm init -y</span>
<span class="hljs-comment">// yarn add react react-dom react-scripts cra-template</span>
Installing packages. This might take a couple <span class="hljs-keyword">of</span> minutes.
Installing react, react-dom, and react-scripts <span class="hljs-keyword">with</span> cra-template...

yarn add v1<span class="hljs-number">.22</span><span class="hljs-number">.10</span>
[<span class="hljs-number">1</span>/<span class="hljs-number">4</span>] 🔍  Resolving packages...
[<span class="hljs-number">2</span>/<span class="hljs-number">4</span>] 🚚  Fetching packages...
[<span class="hljs-number">3</span>/<span class="hljs-number">4</span>] 🔗  Linking dependencies...
[<span class="hljs-number">4</span>/<span class="hljs-number">4</span>] 🔨  Building fresh packages...
success Saved lockfile.
├─ cra-template@<span class="hljs-number">1.1</span><span class="hljs-number">.2</span>
├─ react-dom@<span class="hljs-number">17.0</span><span class="hljs-number">.2</span>
├─ react-scripts@<span class="hljs-number">4.0</span><span class="hljs-number">.3</span>
└─ react@<span class="hljs-number">17.0</span><span class="hljs-number">.2</span>
info All dependencies
├─ cra-template@<span class="hljs-number">1.1</span><span class="hljs-number">.2</span>
├─ immer@<span class="hljs-number">8.0</span><span class="hljs-number">.1</span>
├─ react-dev-utils@<span class="hljs-number">11.0</span><span class="hljs-number">.4</span>
├─ react-dom@<span class="hljs-number">17.0</span><span class="hljs-number">.2</span>
├─ react-scripts@<span class="hljs-number">4.0</span><span class="hljs-number">.3</span>
├─ react@<span class="hljs-number">17.0</span><span class="hljs-number">.2</span>
└─ scheduler@<span class="hljs-number">0.20</span><span class="hljs-number">.2</span>
✨  Done <span class="hljs-keyword">in</span> <span class="hljs-number">20.</span>65s.

<span class="hljs-comment">// 3.初始化git仓库 git init</span>
Initialized a git repository.
<span class="hljs-comment">// 4.使用yarn安装模板 cra-template</span>
Installing template dependencies using yarnpkg...
yarn add v1<span class="hljs-number">.22</span><span class="hljs-number">.10</span>
[<span class="hljs-number">1</span>/<span class="hljs-number">4</span>] 🔍  Resolving packages...
[<span class="hljs-number">2</span>/<span class="hljs-number">4</span>] 🚚  Fetching packages...
[<span class="hljs-number">3</span>/<span class="hljs-number">4</span>] 🔗  Linking dependencies...
[<span class="hljs-number">4</span>/<span class="hljs-number">4</span>] 🔨  Building fresh packages...
success Saved lockfile.
success Saved <span class="hljs-number">17</span> <span class="hljs-keyword">new</span> dependencies.
<span class="hljs-comment">// 5.安装模版之后将cra-template remove掉</span>
Removing template package using yarnpkg...
yarn remove v1<span class="hljs-number">.22</span><span class="hljs-number">.10</span>
[<span class="hljs-number">1</span>/<span class="hljs-number">2</span>] 🗑  Removing <span class="hljs-built_in">module</span> cra-template...
[<span class="hljs-number">2</span>/<span class="hljs-number">2</span>] 🔨  Regenerating lockfile and installing missing dependencies...
success Uninstalled packages.
✨  Done <span class="hljs-keyword">in</span> <span class="hljs-number">7.</span>42s.
<span class="hljs-comment">// 6.创建git的commit</span>
Created git commit.
<span class="hljs-comment">// 成功</span>
Success! Created my-app at /Users/liu/my-app
Inside that directory, you can run several commands:
<span class="hljs-comment">// 7. 可以运行的命令 build start</span>
  yarn start
    Starts the development server.

  yarn build
    Bundles the app into <span class="hljs-keyword">static</span> files <span class="hljs-keyword">for</span> production.

We suggest that you begin by typing:

  cd my-app
  yarn start

Happy hacking!
<span class="copy-code-btn">复制代码</span></code></pre>
<h3 data-id="heading-16">4.3 实现基本思路</h3>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// 1. 安装 react react-dom react-scripts cra-template</span>
<span class="hljs-comment">// 2. 安装 cra-template  模板文件</span>
<span class="hljs-comment">// 3. 卸载 cra-template</span>
<span class="copy-code-btn">复制代码</span></code></pre>
<h3 data-id="heading-17">4.4 简单实现</h3>
<ol>
<li>项目初始化</li>
</ol>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// 使用lerna初始化</span>
lerna init
<span class="hljs-comment">// 创建子项目</span>
<span class="hljs-comment">// 创建项目 主要分析这个包</span>
lerna create @i-box/create-ibox-react-app
<span class="hljs-comment">// 模板文件</span>
lerna create @i-box/ibox-cra-template
<span class="hljs-comment">// 脚本 我们执行 "start": "react-scripts start", webpack最佳实践 暂不分析改部分</span>
lerna create @i-box/ibox-react-scripts

<span class="hljs-comment">// 在package.json中添加</span>
<span class="hljs-string">"workspaces"</span>: [
  <span class="hljs-string">"packages/*"</span>
],
<span class="copy-code-btn">复制代码</span></code></pre>
<ol start="2">
<li>cra源码调试</li>
</ol>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// 1. 下载源码  https://github.com/facebook/create-react-app</span>
<span class="hljs-comment">// 2. 执行yarn 按照依赖 创建链接</span>
<span class="hljs-comment">// 3. .vscode\launch.json中配置</span>
&#123;
  <span class="hljs-string">"version"</span>: <span class="hljs-string">"0.2.0"</span>,
  <span class="hljs-string">"configurations"</span>: [
    &#123;
      <span class="hljs-string">"name"</span>: <span class="hljs-string">"Launch via NPM"</span>,
      <span class="hljs-string">"request"</span>: <span class="hljs-string">"launch"</span>,
      <span class="hljs-string">"runtimeArgs"</span>: [<span class="hljs-string">"run-script"</span>, <span class="hljs-string">"create"</span>],
      <span class="hljs-string">"runtimeExecutable"</span>: <span class="hljs-string">"npm"</span>,
      <span class="hljs-string">"skipFiles"</span>: [<span class="hljs-string">"<node_internals>/**"</span>],
      <span class="hljs-string">"type"</span>: <span class="hljs-string">"pwa-node"</span>
    &#125;
  ]
&#125;
<span class="hljs-comment">// 4. 在package.json中新增脚本</span>
<span class="hljs-string">"create"</span>: <span class="hljs-string">"node ./packages/create-react-app/index.js hello-world"</span>,
<span class="copy-code-btn">复制代码</span></code></pre>
<ol start="3">
<li>create-ibox-react-app</li>
</ol>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// 主要实现这个包</span>
<span class="copy-code-btn">复制代码</span></code></pre>
<ol start="4">
<li>cra-template</li>
</ol>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// 这是一个模板文件 我们可以直接拷贝 cra仓库中的代码</span>
template目录和template.json文件
<span class="hljs-comment">// 我们需要在package.json中指定files</span>
<span class="hljs-string">"files"</span>: [
  <span class="hljs-string">"template"</span>,
  <span class="hljs-string">"template.json"</span>
],
<span class="copy-code-btn">复制代码</span></code></pre>
<ol start="5">
<li>react-script</li>
</ol>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// 这是一个比较核心的包 和vue中的vue-cli-service类似</span>
<span class="hljs-comment">// webpack最佳实践 但是好像不支持插件系统</span>
<span class="hljs-comment">// react-app-rewired是如何修改webpack配置的</span>
<span class="copy-code-btn">复制代码</span></code></pre>
<h3 data-id="heading-18">4.5  create-ibox-react-app</h3>
<ol>
<li>项目初始化</li>
</ol>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// 1. 在package.json中新增bin目录</span>
<span class="hljs-string">"bin"</span>: &#123; 
  <span class="hljs-string">"ibox-react-app"</span>: <span class="hljs-string">"./index.js"</span>,
  <span class="hljs-string">"ibox-cra"</span>: <span class="hljs-string">"./index.js"</span> 
&#125;
<span class="hljs-comment">// 2. 安装依赖</span>
yarn workspace @i-box/create-ibox-react-app add  chalk  commander fs-extra cross-spawn
<span class="copy-code-btn">复制代码</span></code></pre>
<ol start="2">
<li>index.js</li>
</ol>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-meta">#!/usr/bin/env node</span>

<span class="hljs-keyword">const</span> &#123; init &#125; = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./createReactApp"</span>);
init();
<span class="copy-code-btn">复制代码</span></code></pre>
<ol start="3">
<li>createReactApp</li>
</ol>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">init</span>(<span class="hljs-params"></span>) </span>&#123;
  <span class="hljs-comment">// 1. 解析参数</span>
  <span class="hljs-keyword">const</span> program = <span class="hljs-keyword">new</span> commander.Command(packageJson.name)
    .version(packageJson.version)
    .arguments(<span class="hljs-string">"<project-directory>"</span>)
    .usage(<span class="hljs-string">`<span class="hljs-subst">$&#123;chalk.green(<span class="hljs-string">"<project-directory>"</span>)&#125;</span> [options]`</span>)
    .action(<span class="hljs-function">(<span class="hljs-params">name</span>) =></span> &#123;
      projectName = name;
    &#125;)
    .parse(process.argv);
  createApp(
    projectName,
    program.verbose,
    program.scriptsVersion,
    program.template,
    program.useNpm,
    program.usePnp
  );
&#125;
<span class="copy-code-btn">复制代码</span></code></pre>
<ol start="4">
<li>createApp</li>
</ol>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">createApp</span>(<span class="hljs-params">name, verbose, version, template, useNpm, usePnp</span>) </span>&#123;
  <span class="hljs-keyword">const</span> root = path.resolve(name);
  <span class="hljs-keyword">const</span> appName = path.basename(root);
  fs.ensureDirSync(name); <span class="hljs-comment">// // mkdir my-app</span>

  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`Creating a new React app in <span class="hljs-subst">$&#123;chalk.green(root)&#125;</span>.`</span>);
  <span class="hljs-keyword">const</span> packageJson = &#123;
    <span class="hljs-attr">name</span>: appName,
    <span class="hljs-attr">version</span>: <span class="hljs-string">'0.1.0'</span>,
    <span class="hljs-attr">private</span>: <span class="hljs-literal">true</span>,
  &#125;;
  <span class="hljs-comment">// 写入package.json文件</span>
  fs.writeFileSync(
    path.join(root, <span class="hljs-string">'package.json'</span>),
    <span class="hljs-built_in">JSON</span>.stringify(packageJson, <span class="hljs-literal">null</span>, <span class="hljs-number">2</span>) + os.EOL
  );
  <span class="hljs-keyword">const</span> originalDirectory = process.cwd();
  <span class="hljs-comment">// 切换目录</span>
  process.chdir(root);
  <span class="hljs-comment">// 执行run方法 主要就是安装四个包</span>
  <span class="hljs-keyword">await</span> run(root, appName, originalDirectory);
&#125; 
<span class="copy-code-btn">复制代码</span></code></pre>
<ol start="5">
<li>run</li>
</ol>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">run</span>(<span class="hljs-params">root, appName, originalDirectory</span>) </span>&#123;
  <span class="hljs-comment">// 我们先使用官方的包</span>
  <span class="hljs-keyword">const</span> scriptName = <span class="hljs-string">"react-scripts"</span>;
  <span class="hljs-keyword">const</span> templateName = <span class="hljs-string">"cra-template"</span>; <span class="hljs-comment">// 模版其实是可以配置的</span>
  <span class="hljs-keyword">const</span> allDependencies = [<span class="hljs-string">"react"</span>, <span class="hljs-string">"react-dom"</span>, scriptName, templateName];
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Installing packages. This might take a couple of minutes."</span>);
  <span class="hljs-built_in">console</span>.log(
    <span class="hljs-string">`Installing <span class="hljs-subst">$&#123;chalk.cyan(<span class="hljs-string">"react"</span>)&#125;</span>, <span class="hljs-subst">$&#123;chalk.cyan(
      <span class="hljs-string">"react-dom"</span>
    )&#125;</span>, and <span class="hljs-subst">$&#123;chalk.cyan(scriptName)&#125;</span> with <span class="hljs-subst">$&#123;chalk.cyan(templateName)&#125;</span>`</span>
  );
  <span class="hljs-keyword">await</span> install(root, allDependencies);
  <span class="hljs-comment">// 安装完之后 create-react-app包的功能基本就完成了</span>
  <span class="hljs-comment">// 接下来要去react-scripts包去执行相关逻辑</span>
  <span class="hljs-keyword">let</span> data = [root, appName, <span class="hljs-literal">true</span>, originalDirectory, templateName];
  <span class="hljs-keyword">let</span> source = <span class="hljs-string">`
    var init = require('react-scripts/scripts/init.js');
    init.apply(null, JSON.parse(process.argv[1]));
  `</span>;
  <span class="hljs-comment">// 执行node命令  react-script包中scripts目录下的init.js</span>
  <span class="hljs-keyword">await</span> executeNodeScript(&#123; <span class="hljs-attr">cwd</span>: process.cwd() &#125;, data, source);
  process.exit(<span class="hljs-number">0</span>);
&#125;

<span class="hljs-comment">// 执行 react-scripts中的脚本文件 后面的步骤也是在这里面处理的</span>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">executeNodeScript</span>(<span class="hljs-params">&#123; cwd &#125;, data, source</span>) </span>&#123;
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =></span> &#123;
    <span class="hljs-keyword">const</span> child = spawn(
      process.execPath,
      [<span class="hljs-string">"-e"</span>, source, <span class="hljs-string">"--"</span>, <span class="hljs-built_in">JSON</span>.stringify(data)],
      &#123; cwd, <span class="hljs-attr">stdio</span>: <span class="hljs-string">"inherit"</span> &#125;
    );
    child.on(<span class="hljs-string">"close"</span>, resolve);
  &#125;);
&#125;
<span class="copy-code-btn">复制代码</span></code></pre>
<ol start="6">
<li>install</li>
</ol>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">install</span>(<span class="hljs-params">root, allDependencies</span>) </span>&#123;
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =></span> &#123;
    <span class="hljs-keyword">const</span> command = <span class="hljs-string">"yarnpkg"</span>;
    <span class="hljs-comment">// 拼接参数</span>
    <span class="hljs-keyword">const</span> args = [<span class="hljs-string">"add"</span>, <span class="hljs-string">"--exact"</span>, ...allDependencies, <span class="hljs-string">"--cwd"</span>, root];
    <span class="hljs-comment">// 执行yarn add spawn跨平台的开启子进程的包</span>
    <span class="hljs-keyword">const</span> child = spawn(command, args, &#123; <span class="hljs-attr">stdio</span>: <span class="hljs-string">"inherit"</span> &#125;);
    child.on(<span class="hljs-string">"close"</span>, resolve);
  &#125;);
&#125;
<span class="copy-code-btn">复制代码</span></code></pre>
<h3 data-id="heading-19">4.6  react-scripts</h3>
<ol>
<li>初始化项目</li>
</ol>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// react-script分为两部分来实现</span>
<span class="hljs-comment">// 1.继续create-react-app run方法中install之后的逻辑 执行 scripts中的init.js</span>
<span class="hljs-comment">// 2.作为命令来使用 react-scripts start (yarn start) 暂不分析</span>


<span class="hljs-comment">// 安装依赖</span>
yarn workspace @i-box/ibox-react-scripts add  react react-dom
yarn workspace @i-box/ibox-react-scripts add  cross-spawn fs-extra chalk webpack webpack-dev-server babel-loader babel-preset-react-app html-webpack-plugin  open

<span class="hljs-comment">// 在package.json文件中配置bin和scripts脚本</span>
<span class="hljs-string">"bin"</span>: &#123;
  <span class="hljs-string">"rs"</span>: <span class="hljs-string">"./bin/react-scripts.js"</span>
&#125;,
<span class="hljs-string">"files"</span>: [
  <span class="hljs-string">"bin"</span>,
  <span class="hljs-string">"scripts"</span>
],
<span class="hljs-string">"scripts"</span>: &#123;
  <span class="hljs-string">"build"</span>: <span class="hljs-string">"node ./bin/react-scripts build"</span>,
  <span class="hljs-string">"start"</span>: <span class="hljs-string">"node ./bin/react-scripts start"</span>
&#125;,
<span class="copy-code-btn">复制代码</span></code></pre>
<ol start="2">
<li>scripts中的init.js方法</li>
</ol>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// 我们需要完成事</span>
<span class="hljs-comment">// 修改package.json内容(增加脚本命令)</span>
<span class="hljs-comment">// 拷贝cra-template内容 </span>
<span class="hljs-comment">// 初始化仓库</span>
<span class="hljs-comment">// 安装cra-template中依赖 template.json文件</span>
<span class="hljs-comment">// 卸载cra-template</span>
<span class="hljs-built_in">module</span>.exports = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">
  appPath, <span class="hljs-comment">// path.resolve(appName)</span>
  appName, <span class="hljs-comment">// my-app</span>
  verbose,
  originalDirectory, <span class="hljs-comment">// process.cwd()</span>
  templateName <span class="hljs-comment">// cra-template</span>
</span>) </span>&#123;
  <span class="hljs-comment">// 拿到项目中的package.json文件</span>
  <span class="hljs-keyword">const</span> appPackage = <span class="hljs-built_in">require</span>(path.join(appPath, <span class="hljs-string">"package.json"</span>));
  <span class="hljs-comment">// 先拿到模板中的package.json文件 将package.json的内容做一个合并 merge</span>
  <span class="hljs-keyword">const</span> templatePath = path.dirname(
    <span class="hljs-built_in">require</span>.resolve(<span class="hljs-string">`<span class="hljs-subst">$&#123;templateName&#125;</span>/package.json`</span>, &#123; <span class="hljs-attr">paths</span>: [appPath] &#125;)
  );
  <span class="hljs-comment">// 在package.json文件中新增几个命令 start build test eject</span>
  appPackage.scripts = <span class="hljs-built_in">Object</span>.assign(&#123;
    <span class="hljs-attr">start</span>: <span class="hljs-string">"react-scripts start"</span>,
    <span class="hljs-attr">build</span>: <span class="hljs-string">"react-scripts build"</span>,
  &#125;);
  <span class="hljs-comment">// 其他一系列的设置 eslint config browsers list appPackage.xxx = xx</span>
  <span class="hljs-comment">// 写入package.json文件内容</span>
  fs.writeFileSync(
    path.join(appPath, <span class="hljs-string">"package.json"</span>),
    <span class="hljs-built_in">JSON</span>.stringify(appPackage, <span class="hljs-literal">null</span>, <span class="hljs-number">2</span>) + os.EOL
  );
  <span class="hljs-comment">// 拷贝文件 拿到cra-template下的template中的内容</span>
  <span class="hljs-keyword">const</span> templateDir = path.join(templatePath, <span class="hljs-string">"template"</span>);
  fs.copySync(templateDir, appPath); <span class="hljs-comment">// 将template中的内容拷贝过来</span>
  <span class="hljs-comment">// template中的gitignore文件 写入到.gitignore中</span>
  <span class="hljs-keyword">const</span> data = fs.readFileSync(path.join(appPath, <span class="hljs-string">"gitignore"</span>));
  fs.appendFileSync(path.join(appPath, <span class="hljs-string">".gitignore"</span>), data);
  fs.unlinkSync(path.join(appPath, <span class="hljs-string">"gitignore"</span>));
  <span class="hljs-comment">// 初始化仓库 require("child_process").execSync</span>
  execSync(<span class="hljs-string">"git init"</span>, &#123; <span class="hljs-attr">stdio</span>: <span class="hljs-string">"ignore"</span> &#125;);
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Initialized a git repository."</span>);
  <span class="hljs-comment">// 安装cra-template中的依赖 template.json</span>

  <span class="hljs-keyword">let</span> command = <span class="hljs-string">"yarnpkg"</span>,
    remove = <span class="hljs-string">"remove"</span>,
    args = [<span class="hljs-string">"add"</span>];
  <span class="hljs-comment">// args = args.concat(["react", "react-dom"]); // old CRA cli</span>
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`Installing template dependencies using <span class="hljs-subst">$&#123;command&#125;</span>...`</span>);
  <span class="hljs-comment">// 执行安装命令 主要是处理template.json中的文件</span>
  <span class="hljs-keyword">const</span> proc = spawn.sync(command, args, &#123; <span class="hljs-attr">stdio</span>: <span class="hljs-string">"inherit"</span> &#125;);
  <span class="hljs-comment">// 移除cra-template</span>
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`Removing template package using <span class="hljs-subst">$&#123;command&#125;</span>...`</span>);
  <span class="hljs-keyword">const</span> proc1 = spawn.sync(command, [remove, templateName], &#123;
    <span class="hljs-attr">stdio</span>: <span class="hljs-string">"inherit"</span>,
  &#125;);
  <span class="hljs-comment">// 提交git commit</span>
  execSync(<span class="hljs-string">"git add -A"</span>, &#123; <span class="hljs-attr">stdio</span>: <span class="hljs-string">"ignore"</span> &#125;);
  execSync(<span class="hljs-string">'git commit -m "Initialize project using Create React App"'</span>, &#123;
    <span class="hljs-attr">stdio</span>: <span class="hljs-string">"ignore"</span>,
  &#125;);
  <span class="hljs-comment">// 完成</span>
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`Success! Created <span class="hljs-subst">$&#123;appName&#125;</span> at <span class="hljs-subst">$&#123;appPath&#125;</span>`</span>);
&#125;;

<span class="copy-code-btn">复制代码</span></code></pre>
<h3 data-id="heading-20">4.7 发布</h3>
<pre><code class="hljs language-js copyable" lang="js">lerna publish 
<span class="hljs-comment">// 需要先提交git</span>
<span class="copy-code-btn">复制代码</span></code></pre>
<h2 data-id="heading-21">5. vue-cli4</h2>
<h3 data-id="heading-22">1. 初始化项目</h3>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// https://github.com/vuejs/vue-cli/tree/dev/packages/%40vue</span>
<span class="hljs-comment">// 现在已经是 vue-cli5的beta版本了 主要用了webpack5</span>
vue create hello-world
<span class="copy-code-btn">复制代码</span></code></pre>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/fb3d8dcb06c249569cae28074fced8af~tplv-k3u1fbpfcp-watermark.image" alt="vue-cli4.png" loading="lazy" referrerpolicy="no-referrer"></p>
<h3 data-id="heading-23">2. 基本流程</h3>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// 1. 选择预设</span>
? Please pick a preset: Manually select features
<span class="hljs-comment">// 选择手动模式之后选择特性</span>
? Check the features needed <span class="hljs-keyword">for</span> your project: 
  Choose Vue version, Babel, Router, Vuex, Linter
<span class="hljs-comment">// 选择了模式之后会多一些选项</span>
? Choose a version <span class="hljs-keyword">of</span> Vue.js that you want to start the project <span class="hljs-keyword">with</span> <span class="hljs-number">3.</span>x

<span class="hljs-comment">// 2.创建项目  mkdir hello-world</span>
✨  Creating project <span class="hljs-keyword">in</span> /Users/xueshuai.liu/hello-world.

<span class="hljs-comment">// 3.初始化git仓库</span>
🗃  Initializing git repository...

<span class="hljs-comment">// 4.安装plugins</span>
 ⚙️  Installing CLI plugins. This might take a <span class="hljs-keyword">while</span>...
 
<span class="hljs-comment">// 5. 调用生成器 这里是核心 插件</span>
🚀  Invoking generators...

<span class="hljs-comment">// 6.按照额外的依赖</span>
 📦  Installing additional dependencies...

<span class="hljs-comment">// 7. 运行编辑的钩子hooks</span>
 ⚓  Running completion hooks...
 
<span class="hljs-comment">// 8.生成README.md文件</span>
 🚀  Generating README.md...
 
<span class="hljs-comment">// 9. get start</span>
🎉  Successfully created project hello-world. 
   
👉  Get started <span class="hljs-keyword">with</span> the following commands:

<span class="copy-code-btn">复制代码</span></code></pre>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/fdc500aa2e35486ea95b34b3c77670f5~tplv-k3u1fbpfcp-watermark.image" alt="flow.png" loading="lazy" referrerpolicy="no-referrer"></p>
<h3 data-id="heading-24">3. 简单实现</h3>
<ol>
<li>初始化项目</li>
</ol>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// vue-cli4现在是基于插件系统的</span>
lerna init
<span class="hljs-comment">// 执行yarn安装依赖</span>
yarn
<span class="hljs-comment">// 修改package.json文件</span>
<span class="hljs-string">"workspaces"</span>: [<span class="hljs-string">"packages/*"</span>]
<span class="hljs-comment">// 在lerna.json中新增</span>
<span class="hljs-string">"useWorkspaces"</span>: <span class="hljs-literal">true</span>,

<span class="hljs-comment">// 初始化子项目 </span>
lerna create @i-box/cli
lerna create @i-box/cli-service
lerna create @i-box/cli-shared-utils
<span class="hljs-comment">// 插件全部使用官方提供的</span>
lerna create @i-box/cli-plugin-vuex

<span class="hljs-comment">// yarn vs lerna</span>
yarn 用来处理依赖
lerna用来初始化和发布
<span class="copy-code-btn">复制代码</span></code></pre>
<h3 data-id="heading-25">3.1 cli</h3>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// 我们主要实现 cli包的逻辑</span>
cd packages/cli
<span class="hljs-comment">// 增加bin命令</span>
<span class="hljs-string">"bin"</span>: &#123;
  <span class="hljs-string">"ibox-vue"</span>: <span class="hljs-string">"bin/vue.js"</span>
&#125;
<span class="hljs-comment">// 安装依赖</span>
yarn workspace @i-box/cli add minimist commander fs-extra inquirer isbinaryfile ejs vue-codemod
<span class="copy-code-btn">复制代码</span></code></pre>
<h4 data-id="heading-26">1. vue.js</h4>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// 注册命令</span>
program.command(<span class="hljs-string">"create <app-name>"</span>).action(<span class="hljs-function">(<span class="hljs-params">name, options</span>) =></span> &#123;
  <span class="hljs-built_in">require</span>(<span class="hljs-string">"../lib/create.js"</span>)(name, options);
&#125;);
program.parse(process.argv);
<span class="copy-code-btn">复制代码</span></code></pre>
<h4 data-id="heading-27">2. create.js</h4>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">create</span>(<span class="hljs-params">projectName, options</span>) </span>&#123;
  <span class="hljs-keyword">const</span> cwd = options.cwd || process.cwd()
  <span class="hljs-keyword">const</span> inCurrent = projectName === <span class="hljs-string">'.'</span>
  <span class="hljs-keyword">const</span> name = inCurrent ? path.relative(<span class="hljs-string">'../'</span>, cwd) : projectName
  <span class="hljs-keyword">const</span> targetDir = path.resolve(cwd, projectName || <span class="hljs-string">'.'</span>)
  <span class="hljs-comment">// 获取弹出选项的结果 手动模式下选择的选项 vueVersion babel router vuex等</span>
  <span class="hljs-keyword">let</span> promptModules = getPromptModules();
  <span class="hljs-comment">// 初始化 Creator</span>
  <span class="hljs-keyword">const</span> creator = <span class="hljs-keyword">new</span> Creator(name, targetDir, promptModules)
  <span class="hljs-comment">// 调用create方法</span>
  <span class="hljs-keyword">await</span> creator.create(options)
&#125;
<span class="copy-code-btn">复制代码</span></code></pre>
<h4 data-id="heading-28">2.1 getPromptModules</h4>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// 我们手动模式下选择的特性</span>
<span class="hljs-keyword">const</span> getPromptModules = <span class="hljs-function">() =></span> &#123;
  <span class="hljs-keyword">return</span> [
    <span class="hljs-string">'vueVersion'</span>,
    <span class="hljs-string">'babel'</span>,
    <span class="hljs-string">'typescript'</span>,
    <span class="hljs-string">'pwa'</span>,
    <span class="hljs-string">'router'</span>,
    <span class="hljs-string">'vuex'</span>,
    <span class="hljs-string">'cssPreprocessors'</span>,
    <span class="hljs-string">'linter'</span>,
    <span class="hljs-string">'unit'</span>,
    <span class="hljs-string">'e2e'</span>
  ].map(<span class="hljs-function"><span class="hljs-params">file</span> =></span> <span class="hljs-built_in">require</span>(<span class="hljs-string">`../promptModules/<span class="hljs-subst">$&#123;file&#125;</span>`</span>))
&#125;
<span class="copy-code-btn">复制代码</span></code></pre>
<h4 data-id="heading-29">3. Creator</h4>
<ol>
<li>初始化 new Creator</li>
</ol>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// 手动模式</span>
<span class="hljs-keyword">const</span> isManualMode = <span class="hljs-function"><span class="hljs-params">answers</span> =></span> answers.preset === <span class="hljs-string">'__manual__'</span>
<span class="hljs-built_in">module</span>.exports = <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Creator</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">EventEmitter</span> </span>&#123;
  <span class="hljs-comment">// 初始化</span>
  <span class="hljs-function"><span class="hljs-title">constructor</span>(<span class="hljs-params">name, context, prompModules</span>)</span> &#123;
    <span class="hljs-built_in">super</span>()
    <span class="hljs-built_in">this</span>.name = name
    <span class="hljs-built_in">this</span>.context = process.env.VUE_CLI_CONTEXT = context
    <span class="hljs-comment">// 获取到选择的预设和特性 如果是default会有默认值</span>
    <span class="hljs-keyword">const</span> &#123; presetPrompt, featurePrompt &#125; = <span class="hljs-built_in">this</span>.resolveIntroPrompts()
    <span class="hljs-comment">// 手动模式 最后一步保存配置的位置和是否保存在文件中 会保存在 .vuerc 中</span>
    <span class="hljs-built_in">this</span>.outroPrompts = <span class="hljs-built_in">this</span>.resolveOutroPrompts()
    <span class="hljs-comment">// 预设选项</span>
    <span class="hljs-built_in">this</span>.presetPrompt = presetPrompt
    <span class="hljs-comment">// 特性的选项 例如我们选择了 eslint会让我们选项哪种规范</span>
    <span class="hljs-built_in">this</span>.featurePrompt = featurePrompt
    <span class="hljs-comment">// 选项的特征之后加入的选项</span>
    <span class="hljs-built_in">this</span>.injectedPrompts = []
    <span class="hljs-comment">// 完成的回调</span>
    <span class="hljs-built_in">this</span>.promptCompleteCbs = []
    <span class="hljs-comment">// 当我们选项了不同的特性 会通过api给我们增加对应的选项</span>
    <span class="hljs-keyword">const</span> promptAPI = <span class="hljs-keyword">new</span> PromptModuleAPI(<span class="hljs-built_in">this</span>)
    <span class="hljs-comment">// 遍历特性 promptAPI提供一个注入选择特性 一个选择之后的回调(注入一些插件)</span>
    promptModules.forEach(<span class="hljs-function">(<span class="hljs-params">m</span>) =></span> m(promptAPI));
  &#125;
  <span class="hljs-comment">// 执行create方法</span>
  <span class="hljs-keyword">async</span> create (cliOptions = &#123;&#125;, preset = <span class="hljs-literal">null</span>) &#123;&#125;
&#125;
<span class="copy-code-btn">复制代码</span></code></pre>
<ol start="2">
<li>resolveIntroPrompts 获取预设和特性</li>
</ol>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">resolveIntroPrompts</span>(<span class="hljs-params"></span>) </span>&#123;
  <span class="hljs-comment">// 我们保存的选项会存在 .vuerc 中</span>
  <span class="hljs-comment">// const savedOptions = loadOptions()</span>
  <span class="hljs-comment">// const preset = Object.assign(&#123;&#125;, savedOptions.presets, defaults.presets)</span>
  <span class="hljs-comment">// 默认的预设</span>
  <span class="hljs-keyword">const</span> defaultPreset = &#123;
    <span class="hljs-attr">useConfigFiles</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-attr">cssPreprocessor</span>: <span class="hljs-literal">undefined</span>,
    <span class="hljs-attr">plugins</span>: &#123;
      <span class="hljs-string">'@vue/cli-plugin-babel'</span>: &#123;&#125;,
      <span class="hljs-string">'@vue/cli-plugin-eslint'</span>: &#123;
        <span class="hljs-attr">config</span>: <span class="hljs-string">'base'</span>,
        <span class="hljs-attr">lintOn</span>: [<span class="hljs-string">'save'</span>]
      &#125;
    &#125;
  &#125;
  <span class="hljs-keyword">const</span> presets = &#123;
    <span class="hljs-string">'default'</span>: <span class="hljs-built_in">Object</span>.assign(&#123; <span class="hljs-attr">vueVersion</span>: <span class="hljs-string">'2'</span> &#125;, defaultPreset),
    <span class="hljs-string">'__default_vue_3__'</span>: <span class="hljs-built_in">Object</span>.assign(&#123; <span class="hljs-attr">vueVersion</span>: <span class="hljs-string">'3'</span> &#125;, defaultPreset)
  &#125;
  <span class="hljs-comment">// 预设的选项 显示使用的</span>
  <span class="hljs-keyword">const</span> presetChoices = <span class="hljs-built_in">Object</span>.entries(presets).map(<span class="hljs-function">(<span class="hljs-params">[name, preset]</span>) =></span> &#123;
    <span class="hljs-keyword">let</span> displayName = name
    <span class="hljs-keyword">if</span> (name === <span class="hljs-string">'default'</span>) &#123;
      displayName = <span class="hljs-string">'Default'</span>
    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (name === <span class="hljs-string">'__default_vue_3__'</span>) &#123;
      displayName = <span class="hljs-string">'Default (Vue 3)'</span>
    &#125;

    <span class="hljs-keyword">return</span> &#123;
      <span class="hljs-comment">// Default ([Vue 2] babel, eslint)</span>
      <span class="hljs-comment">// Default (Vue 3) ([Vue 3] babel, eslint) </span>
      <span class="hljs-comment">// name: `$&#123;displayName&#125; ($&#123;formatFeatures(preset)&#125;)`,</span>
      <span class="hljs-attr">name</span>: <span class="hljs-string">`<span class="hljs-subst">$&#123;displayName&#125;</span>`</span>,
      <span class="hljs-attr">value</span>: name
    &#125;
  &#125;)

  <span class="hljs-keyword">const</span> presetPrompt  = &#123;
    <span class="hljs-attr">name</span>: <span class="hljs-string">'preset'</span>,
    <span class="hljs-attr">type</span>: <span class="hljs-string">'list'</span>,
    <span class="hljs-attr">message</span>: <span class="hljs-string">`Please pick a preset:`</span>,
    <span class="hljs-attr">choices</span>: [
      ...presetChoices,
      <span class="hljs-comment">// 加上一个手动选择的模式</span>
      &#123;
        <span class="hljs-attr">name</span>: <span class="hljs-string">'Manually select features'</span>,
        <span class="hljs-attr">value</span>: <span class="hljs-string">'__manual__'</span>
      &#125;
    ]
  &#125;
  <span class="hljs-comment">// 特性</span>
  <span class="hljs-keyword">const</span> featurePrompt = &#123;
    <span class="hljs-attr">name</span>: <span class="hljs-string">'features'</span>,
    <span class="hljs-attr">when</span>: isManualMode, <span class="hljs-comment">// 手动模式下才会有</span>
    <span class="hljs-attr">type</span>: <span class="hljs-string">'checkbox'</span>,
    <span class="hljs-attr">message</span>: <span class="hljs-string">'Check the features needed for your project:'</span>,
    <span class="hljs-attr">choices</span>: [], <span class="hljs-comment">// 保存我们的选项</span>
    <span class="hljs-attr">pageSize</span>: <span class="hljs-number">10</span>
  &#125;
  <span class="hljs-keyword">return</span> &#123;
    presetPrompt,
    featurePrompt
  &#125;
&#125;
<span class="copy-code-btn">复制代码</span></code></pre>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/55cbd257cfe243d691ded52a235763a5~tplv-k3u1fbpfcp-watermark.image" alt="preset.png" loading="lazy" referrerpolicy="no-referrer"></p>
<ol start="3">
<li>resolveOutroPrompts</li>
</ol>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// 是否保存本次的选择结果 会在 .vuerc 中保存 什么时候保存的? 在create过程中 promptAndResolvePreset </span>
<span class="hljs-function"><span class="hljs-keyword">function</span>  <span class="hljs-title">resolveOutroPrompts</span>(<span class="hljs-params"></span>) </span>&#123;
  <span class="hljs-keyword">return</span> [
    &#123;
      <span class="hljs-attr">name</span>: <span class="hljs-string">'useConfigFiles'</span>,
      <span class="hljs-attr">when</span>: isManualMode,
      <span class="hljs-attr">type</span>: <span class="hljs-string">'list'</span>,
      <span class="hljs-attr">message</span>: <span class="hljs-string">'Where do you prefer placing config for Babel, ESLint, etc.?'</span>,
      <span class="hljs-comment">// 是在单独的文件中还是保存在package.json文件中</span>
      <span class="hljs-attr">choices</span>: [
        &#123;
          <span class="hljs-attr">name</span>: <span class="hljs-string">'In dedicated config files'</span>,
          <span class="hljs-attr">value</span>: <span class="hljs-string">'files'</span>
        &#125;,
        &#123;
          <span class="hljs-attr">name</span>: <span class="hljs-string">'In package.json'</span>,
          <span class="hljs-attr">value</span>: <span class="hljs-string">'pkg'</span>
        &#125;
      ]
    &#125;,
    &#123;
      <span class="hljs-attr">name</span>: <span class="hljs-string">'save'</span>,
      <span class="hljs-attr">when</span>: isManualMode,
      <span class="hljs-comment">// 是否保存</span>
      <span class="hljs-attr">type</span>: <span class="hljs-string">'confirm'</span>,
      <span class="hljs-attr">message</span>: <span class="hljs-string">'Save this as a preset for future projects?'</span>,
      <span class="hljs-attr">default</span>: <span class="hljs-literal">false</span>
    &#125;,
    &#123;
      <span class="hljs-attr">name</span>: <span class="hljs-string">'saveName'</span>,
      <span class="hljs-comment">// 如果保存输入保存的name</span>
      <span class="hljs-attr">when</span>: <span class="hljs-function"><span class="hljs-params">answers</span> =></span> answers.save,
      <span class="hljs-attr">type</span>: <span class="hljs-string">'input'</span>,
      <span class="hljs-attr">message</span>: <span class="hljs-string">'Save preset as:'</span>
    &#125;
  ]
&#125;
<span class="copy-code-btn">复制代码</span></code></pre>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/51f031ee0a3e45f396a996d0653f5dc6~tplv-k3u1fbpfcp-watermark.image" alt="outro.png" loading="lazy" referrerpolicy="no-referrer"></p>
<ol start="4">
<li>PromptModuleAPI</li>
</ol>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// 给特性注册一些api 方便选择之后做一些处理</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PromptModuleAPI</span> </span>&#123;
  <span class="hljs-function"><span class="hljs-title">constructor</span>(<span class="hljs-params">creator</span>)</span> &#123;
    <span class="hljs-built_in">this</span>.creator = creator
  &#125;
  <span class="hljs-comment">// 提供一些api来修改选项 还有完成选择之后的回调</span>
  <span class="hljs-comment">// 1. 插入一些新的特性 例如vuex vue的版本</span>
  injectFeature (feature) &#123;
    <span class="hljs-built_in">this</span>.creator.featurePrompt.choices.push(feature)
  &#125;
  <span class="hljs-comment">// 2. 加入新的选择 vueVersion选择了之后会要选择vue2还是vue3</span>
  injectPrompt (prompt) &#123;
    <span class="hljs-built_in">this</span>.creator.injectedPrompts.push(prompt)
  &#125;
  <span class="hljs-comment">// 3. 加入一些选项 我们可以自定义一些插件来提供选项</span>
  injectOptionForPrompt (name, option) &#123;
    <span class="hljs-built_in">this</span>.creator.injectedPrompts.find(<span class="hljs-function"><span class="hljs-params">f</span> =></span> &#123;
      <span class="hljs-keyword">return</span> f.name === name
    &#125;).choices.push(option)
  &#125;
  <span class="hljs-comment">// 4. 选项完成之后的回调</span>
  onPromptComplete (cb) &#123;
    <span class="hljs-built_in">this</span>.creator.promptCompleteCbs.push(cb)
  &#125;
&#125;
<span class="copy-code-btn">复制代码</span></code></pre>
<h4 data-id="heading-30">4. create</h4>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// 调用create方法 creator.create</span>
  <span class="hljs-comment">// 执行create方法</span>
  <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-title">create</span>(<span class="hljs-params">cliOptions = &#123;&#125;, preset = <span class="hljs-literal">null</span></span>)</span> &#123;
    <span class="hljs-comment">// 1. 获取用户的选项</span>
    <span class="hljs-keyword">let</span> preset = <span class="hljs-keyword">await</span> <span class="hljs-built_in">this</span>.promptAndResolvePreset();
    <span class="hljs-comment">// 2. 注入核心的服务 @vue/cli-service 是一个核心的特殊的插件</span>
    preset.plugins[<span class="hljs-string">"@vue/cli-service"</span>] = <span class="hljs-built_in">Object</span>.assign(
      &#123;
        <span class="hljs-attr">projectName</span>: name,
      &#125;,
      preset
    );
    <span class="hljs-comment">// 3.开始创建项目</span>
    log(<span class="hljs-string">`✨  Creating project in <span class="hljs-subst">$&#123;chalk.yellow(context)&#125;</span>.`</span>);
    <span class="hljs-comment">// 4. 根据插件的依赖生成package.json写入 会处理版本的问题</span>
    <span class="hljs-keyword">const</span> pkg = &#123;
      name,
      <span class="hljs-attr">version</span>: <span class="hljs-string">"0.1.0"</span>,
      <span class="hljs-attr">private</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">devDependencies</span>: &#123;&#125;,
      <span class="hljs-comment">// ...resolvePkg(this.context)</span>
    &#125;;
    <span class="hljs-comment">// 在选项完成的回调中我们会增加 plugins的属性 options.plugins['@vue/cli-plugin-vuex'] = &#123;&#125;</span>
    <span class="hljs-keyword">const</span> deps = <span class="hljs-built_in">Object</span>.keys(preset.plugins);
    deps.forEach(<span class="hljs-function">(<span class="hljs-params">dep</span>) =></span> &#123;
      pkg.devDependencies[dep] = <span class="hljs-string">"latest"</span>;
    &#125;);
    <span class="hljs-keyword">await</span> writeFileTree(context, &#123;
      <span class="hljs-string">"package.json"</span>: <span class="hljs-built_in">JSON</span>.stringify(pkg, <span class="hljs-literal">null</span>, <span class="hljs-number">2</span>),
    &#125;);
    <span class="hljs-comment">// 5. 初始化仓库</span>
    log(<span class="hljs-string">`🗃  Initializing git repository...`</span>);
    <span class="hljs-comment">// execa 执行命令</span>
    <span class="hljs-keyword">await</span> <span class="hljs-built_in">this</span>.run(<span class="hljs-string">"git init"</span>);
    <span class="hljs-comment">// 6.安装依赖</span>
    log(<span class="hljs-string">`⚙\u&#123;fe0f&#125;  Installing CLI plugins. This might take a while...`</span>);
    <span class="hljs-keyword">await</span> run(<span class="hljs-string">"npm install"</span>);
    <span class="hljs-comment">// 7. 核心 生成器插件</span>
    log(<span class="hljs-string">`🚀  Invoking generators...`</span>);
    <span class="hljs-keyword">const</span> plugins = <span class="hljs-keyword">await</span> <span class="hljs-built_in">this</span>.resolvePlugins(preset.plugins, pkg);
    <span class="hljs-keyword">const</span> generator = <span class="hljs-keyword">new</span> Generator(context, &#123;
      pkg,
      plugins,
      afterInvokeCbs,
      afterAnyInvokeCbs,
    &#125;);
    <span class="hljs-keyword">await</span> generator.generate(&#123;
      <span class="hljs-attr">extractConfigFiles</span>: preset.useConfigFiles,
    &#125;);
    <span class="hljs-comment">// 8.安装额外的依赖 初始化readme文件 完成</span>
    <span class="hljs-keyword">await</span> writeFileTree(context, &#123; <span class="hljs-string">"README.md"</span>: <span class="hljs-string">"README.md"</span> &#125;);
    <span class="hljs-keyword">await</span> run(<span class="hljs-string">"git add -A"</span>);
    log(<span class="hljs-string">`🎉  Successfully created project <span class="hljs-subst">$&#123;chalk.yellow(name)&#125;</span>.`</span>);
  &#125;
<span class="copy-code-btn">复制代码</span></code></pre>
<ol>
<li>promptAndResolvePreset</li>
</ol>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// 获取用户的选项 解析预设</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">promptAndResolvePreset</span>(<span class="hljs-params">answers = <span class="hljs-literal">null</span></span>) </span>&#123;
  <span class="hljs-keyword">if</span> (!answers) &#123;
    <span class="hljs-comment">// await clearConsole(true)</span>
    <span class="hljs-built_in">this</span>.injectedPrompts.forEach(<span class="hljs-function"><span class="hljs-params">prompt</span> =></span> &#123;
      <span class="hljs-keyword">const</span> originalWhen = prompt.when || (<span class="hljs-function">() =></span> <span class="hljs-literal">true</span>)
      prompt.when = <span class="hljs-function"><span class="hljs-params">answers</span> =></span> &#123;
        <span class="hljs-keyword">return</span> isManualMode(answers) && originalWhen(answers)
      &#125;
    &#125;)
    <span class="hljs-keyword">let</span> prompts = [
      <span class="hljs-built_in">this</span>.presetPrompt,
      <span class="hljs-built_in">this</span>.featurePrompt,
      ...this.injectedPrompts,
      ...this.outroPrompts
    ]
    <span class="hljs-comment">// 获取用户选项</span>
    <span class="hljs-comment">// answers = await inquirer.prompt(this.resolveFinalPrompts())</span>
    answers = <span class="hljs-keyword">await</span> inquirer.prompt(prompts)
  &#125;
  <span class="hljs-comment">// 是否保存到package.json文件中</span>
  <span class="hljs-comment">// if (answers.packageManager) &#123;</span>
  <span class="hljs-comment">//   // fs.writeFile()</span>
  <span class="hljs-comment">//   saveOptions(&#123;</span>
  <span class="hljs-comment">//     packageManager: answers.packageManager</span>
  <span class="hljs-comment">//   &#125;)</span>
  <span class="hljs-comment">// &#125;</span>
  <span class="hljs-keyword">let</span> preset
  <span class="hljs-keyword">if</span> (answers.preset && answers.preset !== <span class="hljs-string">'__manual__'</span>) &#123;
    <span class="hljs-comment">// 不是手动模式下的 可能是默认的default 也可能是上次保存的</span>
    <span class="hljs-comment">// preset = await this.resolvePreset(answers.preset)</span>
    preset = defaults.presets
  &#125; <span class="hljs-keyword">else</span> &#123;
    <span class="hljs-comment">// 手动模式</span>
    preset = &#123;
      <span class="hljs-attr">useConfigFiles</span>: answers.useConfigFiles === <span class="hljs-string">'files'</span>,
      <span class="hljs-attr">plugins</span>: &#123;&#125;
    &#125;
    answers.features = answers.features || []
    <span class="hljs-comment">// 运行模块注册的回调来完成预设 options.vueVersion = answers.vueVersion</span>
    <span class="hljs-built_in">this</span>.promptCompleteCbs.forEach(<span class="hljs-function"><span class="hljs-params">cb</span> =></span> cb(answers, preset))
  &#125;
  <span class="hljs-comment">// 保存配置信息到.vuerc文件</span>
  <span class="hljs-comment">// if(answers.save) &#123;&#125;</span>
  <span class="hljs-keyword">return</span> preset
&#125;
<span class="copy-code-btn">复制代码</span></code></pre>
<ol start="2">
<li>resolvePlugins</li>
</ol>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// 解析插件 插件系统的实现 加载 generator 模块 增加apply方法</span>
<span class="hljs-comment">//  &#123; id: options &#125; => [&#123; id, apply, options &#125;] 增加apply方法</span>
<span class="hljs-keyword">async</span>  <span class="hljs-function"><span class="hljs-title">resolvePlugins</span>(<span class="hljs-params">rawPlugins, pkg</span>)</span> &#123;
  <span class="hljs-comment">// 保证 @vue/cli-service 是第一个插件 这个很重要</span>
  <span class="hljs-comment">// 因为其他的插件是基于里面的template来做修改的</span>
  rawPlugins = sortObject(rawPlugins, [<span class="hljs-string">'@vue/cli-service'</span>], <span class="hljs-literal">true</span>)
  <span class="hljs-keyword">const</span> plugins = []
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> id <span class="hljs-keyword">of</span> <span class="hljs-built_in">Object</span>.keys(rawPlugins)) &#123;
    <span class="hljs-comment">// 加载插件下的 generator 模块</span>
    <span class="hljs-comment">// 插件一般是有一个 generator目录的</span>
    <span class="hljs-comment">// require() Module.createRequire</span>
    <span class="hljs-keyword">const</span> apply = loadModule(<span class="hljs-string">`<span class="hljs-subst">$&#123;id&#125;</span>/generator`</span>, <span class="hljs-built_in">this</span>.context) || (<span class="hljs-function">() =></span> &#123;&#125;)
    <span class="hljs-keyword">let</span> options = rawPlugins[id] || &#123;&#125;

    <span class="hljs-keyword">if</span> (options.prompts) &#123;
      <span class="hljs-keyword">let</span> pluginPrompts = loadModule(<span class="hljs-string">`<span class="hljs-subst">$&#123;id&#125;</span>/prompts`</span>, <span class="hljs-built_in">this</span>.context)

      <span class="hljs-keyword">if</span> (pluginPrompts) &#123;
        <span class="hljs-keyword">const</span> prompt = inquirer.createPromptModule()

        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> pluginPrompts === <span class="hljs-string">'function'</span>) &#123;
          pluginPrompts = pluginPrompts(pkg, prompt)
        &#125;
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> pluginPrompts.getPrompts === <span class="hljs-string">'function'</span>) &#123;
          pluginPrompts = pluginPrompts.getPrompts(pkg, prompt)
        &#125;

        log()
        log(<span class="hljs-string">`<span class="hljs-subst">$&#123;chalk.cyan(options._isPreset ? <span class="hljs-string">`Preset options:`</span> : id)&#125;</span>`</span>)
        options = <span class="hljs-keyword">await</span> prompt(pluginPrompts)
      &#125;
    &#125;
    <span class="hljs-comment">// 增加一个apply方法 什么时候执行的?</span>
    plugins.push(&#123; id, apply, options &#125;)
  &#125;
  <span class="hljs-keyword">return</span> plugins
&#125;
<span class="copy-code-btn">复制代码</span></code></pre>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/565599e8aca74f528ceed2c20cab058c~tplv-k3u1fbpfcp-watermark.image" alt="plugin.png" loading="lazy" referrerpolicy="no-referrer"></p>
<h4 data-id="heading-31">5. Generator</h4>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// 生成器</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Generator</span> </span>&#123;
  <span class="hljs-function"><span class="hljs-title">constructor</span>(<span class="hljs-params">context, &#123; pkg = &#123;&#125;, plugins = [], files = &#123;&#125; &#125; = &#123;&#125;</span>)</span> &#123;
    <span class="hljs-built_in">this</span>.pkg = pkg
    <span class="hljs-built_in">this</span>.files = &#123;&#125;
    <span class="hljs-built_in">this</span>.fileMiddlewares = []; <span class="hljs-comment">// 插件数组</span>
    <span class="hljs-comment">// load all the other plugins</span>
    <span class="hljs-built_in">this</span>.allPlugins = <span class="hljs-built_in">this</span>.resolveAllPlugins()
    <span class="hljs-comment">// @vue/cli-service 插件非常特殊 单独处理</span>
    <span class="hljs-keyword">const</span> cliService = plugins.find(<span class="hljs-function">(<span class="hljs-params">p</span>) =></span> p.id === <span class="hljs-string">"@vue/cli-service"</span>);
    <span class="hljs-built_in">this</span>.rootOptions = rootOptions; <span class="hljs-comment">// 根选项</span>
  &#125;
&#125;
<span class="copy-code-btn">复制代码</span></code></pre>
<ol>
<li>resolveAllPlugins</li>
</ol>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">resolveAllPlugins</span>(<span class="hljs-params"></span>) </span>&#123;
  <span class="hljs-keyword">const</span> allPlugins = [];
  <span class="hljs-built_in">Object</span>.keys(<span class="hljs-built_in">this</span>.pkg.dependencies || &#123;&#125;)
    .concat(<span class="hljs-built_in">Object</span>.keys(<span class="hljs-built_in">this</span>.pkg.devDependencies || &#123;&#125;))
    .forEach(<span class="hljs-function">(<span class="hljs-params">id</span>) =></span> &#123;
      <span class="hljs-keyword">if</span> (!isPlugin(id)) <span class="hljs-keyword">return</span>;
      <span class="hljs-keyword">const</span> pluginGenerator = loadModule(<span class="hljs-string">`<span class="hljs-subst">$&#123;id&#125;</span>/generator`</span>, <span class="hljs-built_in">this</span>.context);
      <span class="hljs-keyword">if</span> (!pluginGenerator) <span class="hljs-keyword">return</span>;
      allPlugins.push(&#123; id, <span class="hljs-attr">apply</span>: pluginGenerator &#125;);
    &#125;);
  <span class="hljs-keyword">return</span> sortPlugins(allPlugins);
&#125;
<span class="copy-code-btn">复制代码</span></code></pre>
<ol start="2">
<li>generate方法</li>
</ol>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-keyword">async</span> generate (&#123; extractConfigFiles = <span class="hljs-literal">false</span>, checkExisting = <span class="hljs-literal">false</span>&#125; = &#123;&#125;) &#123;
  <span class="hljs-comment">// 1. 初始化插件 遍历执行apply方法</span>
  <span class="hljs-keyword">await</span> <span class="hljs-built_in">this</span>.initPlugins()
  <span class="hljs-keyword">const</span> initialFiles = <span class="hljs-built_in">Object</span>.assign(&#123;&#125;, <span class="hljs-built_in">this</span>.files)
  <span class="hljs-comment">// 单独的配置文件</span>
  <span class="hljs-comment">// this.extractConfigFiles(extractConfigFiles, checkExisting)</span>
  <span class="hljs-comment">// 解析file 执行插件的方法 修改files</span>
  <span class="hljs-keyword">await</span> <span class="hljs-built_in">this</span>.resolveFiles()
  <span class="hljs-comment">// 排序</span>
  <span class="hljs-comment">// this.sortPkg()</span>
  <span class="hljs-comment">// 重新生成package.json 插件可能修改了内容</span>
  <span class="hljs-built_in">this</span>.files[<span class="hljs-string">'package.json'</span>] = <span class="hljs-built_in">JSON</span>.stringify(<span class="hljs-built_in">this</span>.pkg, <span class="hljs-literal">null</span>, <span class="hljs-number">2</span>) + <span class="hljs-string">'\n'</span>
  <span class="hljs-comment">// 写入文件书</span>
  <span class="hljs-keyword">await</span> writeFileTree(<span class="hljs-built_in">this</span>.context, <span class="hljs-built_in">this</span>.files, initialFiles, <span class="hljs-built_in">this</span>.filesModifyRecord)
&#125;
<span class="copy-code-btn">复制代码</span></code></pre>
<ol start="3">
<li>initPlugins</li>
</ol>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// 初始化插件</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">initPlugins</span>(<span class="hljs-params"></span>) </span>&#123;
  <span class="hljs-keyword">const</span> &#123; rootOptions &#125; = <span class="hljs-built_in">this</span>
  <span class="hljs-keyword">const</span> pluginIds = <span class="hljs-built_in">this</span>.plugins.map(<span class="hljs-function"><span class="hljs-params">p</span> =></span> p.id)
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> plugin <span class="hljs-keyword">of</span> <span class="hljs-built_in">this</span>.plugins) &#123;
    <span class="hljs-keyword">const</span> &#123; id, apply &#125; = plugin;
    <span class="hljs-comment">// 给插件提供的一些api方法</span>
    <span class="hljs-keyword">const</span> api = <span class="hljs-keyword">new</span> GeneratorAPI(id, <span class="hljs-built_in">this</span>, &#123;&#125;, rootOptions);
    <span class="hljs-comment">// 执行apply方法 </span>
    <span class="hljs-keyword">await</span> apply(api, options, rootOptions, invoking)
  &#125;
&#125;
<span class="copy-code-btn">复制代码</span></code></pre>
<ol start="4">
<li>GeneratorAPI</li>
</ol>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// 提供一些api给插件使用</span>
<span class="hljs-comment">// render渲染内容  extendPackage扩展依赖 </span>
<span class="hljs-comment">// injectImports增加import语句</span>
<span class="hljs-comment">// injectRootOptions 注入根option等</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">GeneratorAPI</span> </span>&#123;
  <span class="hljs-function"><span class="hljs-title">constructor</span>(<span class="hljs-params">id, generator, options, rootOptions</span>)</span> &#123;
    <span class="hljs-built_in">this</span>.id = id;
    <span class="hljs-built_in">this</span>.generator = generator;
    <span class="hljs-built_in">this</span>.options = options;
    <span class="hljs-built_in">this</span>.rootOptions = rootOptions; <span class="hljs-comment">// 根选项</span>
    <span class="hljs-built_in">this</span>.pluginsData = generator.plugins
      .filter(<span class="hljs-function">(<span class="hljs-params">&#123; id &#125;</span>) =></span> id !== <span class="hljs-string">`@vue/cli-service`</span>)
      .map(<span class="hljs-function">(<span class="hljs-params">&#123; id &#125;</span>) =></span> (&#123;
        <span class="hljs-comment">// eslint babel</span>
        <span class="hljs-attr">name</span>: toShortPluginId(id),
      &#125;));
    <span class="hljs-comment">// 插件需要往entryFile中添加内容</span>
    <span class="hljs-built_in">this</span>._entryFile = <span class="hljs-literal">undefined</span>;
  &#125;

  <span class="hljs-comment">// readeOnly</span>
  <span class="hljs-keyword">get</span> <span class="hljs-title">entryFile</span>() &#123;
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>._entryFile) <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>._entryFile;
    <span class="hljs-comment">// 这里就指明了 我们的入口是main</span>
    <span class="hljs-keyword">const</span> file = fs.existsSync(<span class="hljs-built_in">this</span>.resolve(<span class="hljs-string">"src/main.ts"</span>))
      ? <span class="hljs-string">"src/main.ts"</span>
      : <span class="hljs-string">"src/main.js"</span>;
    <span class="hljs-keyword">return</span> (<span class="hljs-built_in">this</span>._entryFile = file);
  &#125;

  <span class="hljs-comment">// api.extendPackage(&#123;</span>
  <span class="hljs-comment">//   dependencies: &#123;</span>
  <span class="hljs-comment">//     'vue': '^3.0.4'</span>
  <span class="hljs-comment">//   &#125;,</span>
  <span class="hljs-comment">//   devDependencies: &#123;</span>
  <span class="hljs-comment">//     '@vue/compiler-sfc': '^3.0.4'</span>
  <span class="hljs-comment">//   &#125;</span>
  <span class="hljs-comment">// &#125;)</span>
  <span class="hljs-comment">// 插件的功能  修改配置  render渲染内容</span>
  <span class="hljs-function"><span class="hljs-title">extendPackage</span>(<span class="hljs-params">fields</span>)</span> &#123;
    <span class="hljs-comment">// 做一个配置的合并 修改package.json文件中的依赖</span>
    <span class="hljs-keyword">const</span> pkg = <span class="hljs-built_in">this</span>.generator.pkg;
    <span class="hljs-keyword">const</span> toMerge = isFunction(fields) ? fields(pkg) : fields;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> key <span class="hljs-keyword">in</span> toMerge) &#123;
      <span class="hljs-keyword">const</span> value = toMerge[key];
      <span class="hljs-keyword">const</span> existing = pkg[key];
      <span class="hljs-keyword">if</span> (
        isObject(value) &&
        (key === <span class="hljs-string">"dependencies"</span> || key === <span class="hljs-string">"devDependencies"</span>)
      ) &#123;
        pkg[key] = mergeDeps(existing || &#123;&#125;, value);
      &#125; <span class="hljs-keyword">else</span> &#123;
        pkg[key] = value;
      &#125;
    &#125;
  &#125;

  <span class="hljs-comment">// vue-cli-service中的使用</span>
  <span class="hljs-comment">// api.render('./template', &#123;</span>
  <span class="hljs-comment">//   doesCompile: api.hasPlugin('babel') || api.hasPlugin('typescript'),</span>
  <span class="hljs-comment">//   useBabel: api.hasPlugin('babel')</span>
  <span class="hljs-comment">// &#125;)</span>
  <span class="hljs-comment">// 这一步是没有往files中添加的</span>
  <span class="hljs-function"><span class="hljs-title">render</span>(<span class="hljs-params">source, additionalData = &#123;&#125;</span>)</span> &#123;
    <span class="hljs-keyword">const</span> baseDir = extractCallDir(); <span class="hljs-comment">// 提取目录</span>
    <span class="hljs-keyword">if</span> (isString(source)) &#123;
      source = path.resolve(baseDir, source);
      <span class="hljs-comment">// 添加到fileMiddlewares中</span>
      <span class="hljs-built_in">this</span>._injectFileMiddleware(<span class="hljs-keyword">async</span> (files) => &#123;
        <span class="hljs-comment">// 解析额外的数据</span>
        <span class="hljs-keyword">const</span> data = <span class="hljs-built_in">this</span>._resolveData(additionalData);
        <span class="hljs-keyword">const</span> globby = <span class="hljs-built_in">require</span>(<span class="hljs-string">"globby"</span>); <span class="hljs-comment">// 匹配文件</span>
        <span class="hljs-keyword">const</span> _files = <span class="hljs-keyword">await</span> globby([<span class="hljs-string">"**/*"</span>], &#123; <span class="hljs-attr">cwd</span>: source, <span class="hljs-attr">dot</span>: <span class="hljs-literal">true</span> &#125;);
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> rawPath <span class="hljs-keyword">of</span> _files) &#123;
          <span class="hljs-keyword">const</span> targetPath = rawPath
            .split(<span class="hljs-string">"/"</span>)
            .map(<span class="hljs-function">(<span class="hljs-params">filename</span>) =></span> &#123;
              <span class="hljs-keyword">if</span> (filename.charAt(<span class="hljs-number">0</span>) === <span class="hljs-string">"_"</span> && filename.charAt(<span class="hljs-number">1</span>) !== <span class="hljs-string">"_"</span>) &#123;
                <span class="hljs-keyword">return</span> <span class="hljs-string">`.<span class="hljs-subst">$&#123;filename.slice(<span class="hljs-number">1</span>)&#125;</span>`</span>;
              &#125;
              <span class="hljs-keyword">return</span> filename;
            &#125;)
            .join(<span class="hljs-string">"/"</span>);
          <span class="hljs-keyword">const</span> sourcePath = path.resolve(source, rawPath);
          <span class="hljs-comment">// 使用ejs模版渲染</span>
          <span class="hljs-keyword">const</span> content = renderFile(sourcePath, data);
          <span class="hljs-comment">// 如果是buffer</span>
          <span class="hljs-keyword">if</span> (Buffer.isBuffer(content) || <span class="hljs-regexp">/[^\s]/</span>.test(content)) &#123;
            files[targetPath] = content;
          &#125;
        &#125;
      &#125;);
    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (isObject(source)) &#123;
    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (isFunction(source)) &#123;
      <span class="hljs-built_in">this</span>._injectFileMiddleware(source);
    &#125;
  &#125;

  <span class="hljs-comment">// 往fileMiddlewares中添加middle 这个时候只是添加了 还没有执行的</span>
  <span class="hljs-comment">// 修改的是fileMiddlewares和pkg files还没有修改</span>
  <span class="hljs-comment">// 执行resolveFiles的时候才会真正执行这些middleware</span>
  <span class="hljs-function"><span class="hljs-title">_injectFileMiddleware</span>(<span class="hljs-params">middleware</span>)</span> &#123;
    <span class="hljs-built_in">this</span>.generator.fileMiddlewares.push(middleware);
  &#125;

  <span class="hljs-comment">// vue-server-cli会使用</span>
  <span class="hljs-function"><span class="hljs-title">hasPlugin</span>(<span class="hljs-params">id</span>)</span> &#123;
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.generator.hasPlugin(id);
  &#125;

  <span class="hljs-function"><span class="hljs-title">_resolveData</span>(<span class="hljs-params">additionalData</span>)</span> &#123;
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">Object</span>.assign(
      &#123;
        <span class="hljs-attr">options</span>: <span class="hljs-built_in">this</span>.options,
        <span class="hljs-attr">rootOptions</span>: <span class="hljs-built_in">this</span>.rootOptions,
        <span class="hljs-attr">plugins</span>: <span class="hljs-built_in">this</span>.pluginsData,
      &#125;,
      additionalData
    );
  &#125;

  <span class="hljs-comment">// Add import statements to a file. vuex vue-router</span>
  <span class="hljs-function"><span class="hljs-title">injectImports</span>(<span class="hljs-params">file, imports</span>)</span> &#123;
    <span class="hljs-keyword">const</span> _imports =
      <span class="hljs-built_in">this</span>.generator.imports[file] ||
      (<span class="hljs-built_in">this</span>.generator.imports[file] = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Set</span>());
    (<span class="hljs-built_in">Array</span>.isArray(imports) ? imports : [imports]).forEach(<span class="hljs-function">(<span class="hljs-params">imp</span>) =></span> &#123;
      _imports.add(imp);
    &#125;);
  &#125;
  <span class="hljs-function"><span class="hljs-title">transformScript</span>(<span class="hljs-params">file, codemod, options</span>)</span> &#123;
    <span class="hljs-comment">// debugger;</span>
    <span class="hljs-keyword">const</span> normalizedPath = <span class="hljs-built_in">this</span>._normalizePath(file);

    <span class="hljs-built_in">this</span>._injectFileMiddleware(<span class="hljs-function">(<span class="hljs-params">files</span>) =></span> &#123;
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> files[normalizedPath] === <span class="hljs-string">"undefined"</span>) &#123;
        error(<span class="hljs-string">`Cannot find file <span class="hljs-subst">$&#123;normalizedPath&#125;</span>`</span>);
        <span class="hljs-keyword">return</span>;
      &#125;
      <span class="hljs-comment">// files[] =</span>
      files[normalizedPath] = runTransformation(
        &#123;
          <span class="hljs-attr">path</span>: <span class="hljs-built_in">this</span>.resolve(normalizedPath),
          <span class="hljs-attr">source</span>: files[normalizedPath],
        &#125;,
        codemod,
        options
      );
    &#125;);
  &#125;
  <span class="hljs-comment">// vue2使用的 注入根选项</span>
  <span class="hljs-function"><span class="hljs-title">injectRootOptions</span>(<span class="hljs-params"></span>)</span> &#123;
    <span class="hljs-keyword">const</span> _options =
      <span class="hljs-built_in">this</span>.generator.rootOptions[file] ||
      (<span class="hljs-built_in">this</span>.generator.rootOptions[file] = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Set</span>());
    (<span class="hljs-built_in">Array</span>.isArray(options) ? options : [options]).forEach(<span class="hljs-function">(<span class="hljs-params">opt</span>) =></span> &#123;
      _options.add(opt);
    &#125;);
  &#125;

  <span class="hljs-comment">// 处理文件</span>
  <span class="hljs-function"><span class="hljs-title">postProcessFiles</span>(<span class="hljs-params">cb</span>)</span> &#123;
    <span class="hljs-built_in">this</span>.generator.postProcessFilesCbs.push(cb);
  &#125;

  <span class="hljs-function"><span class="hljs-title">_normalizePath</span>(<span class="hljs-params">p</span>)</span> &#123;
    <span class="hljs-keyword">if</span> (path.isAbsolute(p)) &#123;
      p = path.relative(<span class="hljs-built_in">this</span>.generator.context, p);
    &#125;
    <span class="hljs-keyword">return</span> p.replace(<span class="hljs-regexp">/\\/g</span>, <span class="hljs-string">"/"</span>);
  &#125;
  <span class="hljs-function"><span class="hljs-title">resolve</span>(<span class="hljs-params">..._paths</span>)</span> &#123;
    <span class="hljs-keyword">return</span> path.resolve(<span class="hljs-built_in">this</span>.generator.context, ..._paths);
  &#125;
&#125;
<span class="copy-code-btn">复制代码</span></code></pre>
<ol start="5">
<li>resolveFiles</li>
</ol>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// 执行render方法 增加import语句</span>
<span class="hljs-keyword">async</span> resolveFiles () &#123;
  <span class="hljs-keyword">const</span> files = <span class="hljs-built_in">this</span>.files
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> middleware <span class="hljs-keyword">of</span> <span class="hljs-built_in">this</span>.fileMiddlewares) &#123;
    <span class="hljs-comment">// 执行插件的render方法 使用ejs模版渲染</span>
    <span class="hljs-keyword">await</span> middleware(files, ejs.render)
  &#125;
  <span class="hljs-comment">// 格式化/和\</span>
  <span class="hljs-comment">// normalizeFilePaths(files)</span>

  <span class="hljs-comment">// handle imports and root option injections</span>
  <span class="hljs-built_in">Object</span>.keys(files).forEach(<span class="hljs-function"><span class="hljs-params">file</span> =></span> &#123;
    <span class="hljs-keyword">let</span> imports = <span class="hljs-built_in">this</span>.imports[file]
    imports = imports <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Set</span> ? <span class="hljs-built_in">Array</span>.from(imports) : imports
    <span class="hljs-keyword">if</span> (imports && imports.length > <span class="hljs-number">0</span>) &#123;
      files[file] = runTransformation(
        &#123; <span class="hljs-attr">path</span>: file, <span class="hljs-attr">source</span>: files[file] &#125;,
        <span class="hljs-built_in">require</span>(<span class="hljs-string">'./util/codemods/injectImports'</span>),
        &#123; imports &#125;
      )
    &#125;

    <span class="hljs-keyword">let</span> injections = <span class="hljs-built_in">this</span>.rootOptions[file]
    injections = injections <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Set</span> ? <span class="hljs-built_in">Array</span>.from(injections) : injections
    <span class="hljs-keyword">if</span> (injections && injections.length > <span class="hljs-number">0</span>) &#123;
      files[file] = runTransformation(
        &#123; <span class="hljs-attr">path</span>: file, <span class="hljs-attr">source</span>: files[file] &#125;,
        <span class="hljs-built_in">require</span>(<span class="hljs-string">'./util/codemods/injectOptions'</span>),
        &#123; injections &#125;
      )
    &#125;
  &#125;)
&#125;
<span class="copy-code-btn">复制代码</span></code></pre>
<ol start="6">
<li>injectImports</li>
</ol>
<pre><code class="hljs language-js copyable" lang="js">
<span class="hljs-comment">// 插件vuex需要插入 import store from './store'</span>
<span class="hljs-comment">// api.injectImports(api.entryFile, `import store from './store'`)</span>

<span class="hljs-comment">// vue-cli-serve机车的template如下 我们需要插入 import语句 操作ast</span>
<span class="hljs-comment">// import &#123; createApp &#125; from 'vue'</span>
<span class="hljs-comment">// import App from './App.vue'</span>
<span class="hljs-comment">// createApp(App).mount('#app')</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">injectImports</span> (<span class="hljs-params">fileInfo, api, &#123; imports &#125;</span>) </span>&#123;
  <span class="hljs-keyword">const</span> j = api.jscodeshift
  <span class="hljs-keyword">const</span> root = j(fileInfo.source)

  <span class="hljs-keyword">const</span> toImportAST = <span class="hljs-function"><span class="hljs-params">i</span> =></span> j(<span class="hljs-string">`<span class="hljs-subst">$&#123;i&#125;</span>\n`</span>).nodes()[<span class="hljs-number">0</span>].program.body[<span class="hljs-number">0</span>]
  <span class="hljs-keyword">const</span> toImportHash = <span class="hljs-function"><span class="hljs-params">node</span> =></span> <span class="hljs-built_in">JSON</span>.stringify(&#123;
    <span class="hljs-attr">specifiers</span>: node.specifiers.map(<span class="hljs-function"><span class="hljs-params">s</span> =></span> s.local.name),
    <span class="hljs-attr">source</span>: node.source.raw
  &#125;)

  <span class="hljs-keyword">const</span> declarations = root.find(j.ImportDeclaration)
  <span class="hljs-keyword">const</span> importSet = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Set</span>(declarations.nodes().map(toImportHash))
  <span class="hljs-keyword">const</span> nonDuplicates = <span class="hljs-function"><span class="hljs-params">node</span> =></span> !importSet.has(toImportHash(node))

  <span class="hljs-keyword">const</span> importASTNodes = imports.map(toImportAST).filter(nonDuplicates)

  <span class="hljs-keyword">if</span> (declarations.length) &#123;
    declarations
      .at(-<span class="hljs-number">1</span>)
      <span class="hljs-comment">// a tricky way to avoid blank line after the previous import</span>
      .forEach(<span class="hljs-function">(<span class="hljs-params">&#123; node &#125;</span>) =></span> <span class="hljs-keyword">delete</span> node.loc)
      .insertAfter(importASTNodes)
  &#125; <span class="hljs-keyword">else</span> &#123;
    <span class="hljs-comment">// no pre-existing import declarations</span>
    root.get().node.program.body.unshift(...importASTNodes)
  &#125;

  <span class="hljs-keyword">return</span> root.toSource()
&#125;
<span class="copy-code-btn">复制代码</span></code></pre>
<h3 data-id="heading-32">3.4 cli-shared-utils</h3>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// 提供一些公共的方法</span>
yarn workspace @i-box/cli-shared-utils add chalk execa semver chalk strip-ansi readline events ora <span class="hljs-built_in">module</span>
<span class="copy-code-btn">复制代码</span></code></pre>
<h3 data-id="heading-33">3.3 vue-cli-service</h3>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/87e76e1c9ce847e99419d4b798cc934d~tplv-k3u1fbpfcp-watermark.image" alt="service.png" loading="lazy" referrerpolicy="no-referrer"></p>
<h4 data-id="heading-34">1. 作为核心插件使用</h4>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// 根据上面的插件我们可以知道 插件中需要一个generator目录</span>
<span class="hljs-comment">// 做两件事 一个是render一个是extendPackage</span>
<span class="hljs-built_in">module</span>.exports = <span class="hljs-function">(<span class="hljs-params">api.options</span>) =></span> &#123;
  <span class="hljs-comment">// 渲染模版</span>
  api.render(<span class="hljs-string">'./template'</span>, &#123;&#125;)
  <span class="hljs-comment">// 扩展</span>
  api.extendPackage(&#123;
    <span class="hljs-comment">// 增加脚本文件</span>
    <span class="hljs-attr">scripts</span>: &#123;
      <span class="hljs-string">'serve'</span>: <span class="hljs-string">'vue-cli-service serve'</span>,
      <span class="hljs-string">'build'</span>: <span class="hljs-string">'vue-cli-service build'</span>
    &#125;,
    <span class="hljs-comment">// 增加依赖</span>
    <span class="hljs-attr">dependencies</span>: &#123;
      <span class="hljs-attr">vue</span>: <span class="hljs-string">"^3.0.4"</span>,
    &#125;,
    <span class="hljs-attr">devDependencies</span>: &#123;
      <span class="hljs-string">"@vue/compiler-sfc"</span>: <span class="hljs-string">"^3.0.4"</span>,
    &#125;,
  &#125;)
&#125;
<span class="hljs-comment">// 渲染了 template 所以我们还需要一个template目录在存放文件用来渲染</span>
<span class="copy-code-btn">复制代码</span></code></pre>
<h4 data-id="heading-35">2. 作为命令使用</h4>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// 增加命令 暂不分析</span>
<span class="hljs-string">"bin"</span>: &#123;
  <span class="hljs-string">"vue-cli-service"</span>: <span class="hljs-string">"bin/vue-cli-service.js"</span>
&#125;,
<span class="hljs-comment">// vue-cli-service serve webpack启动服务</span>
<span class="hljs-comment">// vue-cli-service build 打包</span>
<span class="copy-code-btn">复制代码</span></code></pre>
<ol>
<li>Service</li>
</ol>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Service</span> </span>&#123;
  <span class="hljs-function"><span class="hljs-title">constructor</span>(<span class="hljs-params">context, &#123; plugins, pkg, inlineOptions, useBuiltIn &#125; = &#123;&#125;</span>)</span> &#123;
    <span class="hljs-comment">// 5.0新增的 beat已经用了webpack</span>
    checkWebpack(context)
    <span class="hljs-comment">// 获取package.json内容</span>
    <span class="hljs-built_in">this</span>.pkg = <span class="hljs-built_in">this</span>.resolvePkg(pkg);
    <span class="hljs-comment">// 插件 会将service的插件放在里面 命令相关的serve build webpack相关的config</span>
    <span class="hljs-built_in">this</span>.plugins = <span class="hljs-built_in">this</span>.resolvePlugins(plugins, useBuiltIn)
    <span class="hljs-comment">// vue.config.js中配置chainWebpack 也可以调用api来修改</span>
    <span class="hljs-built_in">this</span>.webpackChainFns = [];
    <span class="hljs-comment">// configureWebpack</span>
    <span class="hljs-built_in">this</span>.webpackRawConfigFns = [];
    <span class="hljs-comment">// 注册的命令 我们编写的插件就是注册命令</span>
    <span class="hljs-built_in">this</span>.commands = &#123;&#125;;
  &#125;
  <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-title">run</span>(<span class="hljs-params"></span>)</span> &#123;&#125;
  <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-title">init</span>(<span class="hljs-params"></span>)</span>&#123;&#125;
  <span class="hljs-function"><span class="hljs-title">resolveWebpackConfig</span>(<span class="hljs-params"></span>)</span>&#123;&#125;
&#125;

<span class="hljs-comment">// 主要是获取package.json和解析插件</span>
<span class="hljs-comment">// 找到package.json文件</span>
<span class="hljs-function"><span class="hljs-title">resolvePkg</span>(<span class="hljs-params">inlinePkg, context = <span class="hljs-built_in">this</span>.context</span>)</span> &#123;
  <span class="hljs-comment">// 和之前一样也是用require 找context的package.json文件</span>
  Module.createRequire(path.resolve(context, <span class="hljs-string">"package.json"</span>)).resolve(context)
&#125;

<span class="hljs-comment">// 解析插件</span>
<span class="hljs-function"><span class="hljs-title">resolvePlugins</span>(<span class="hljs-params">inlinePlugins</span>)</span> &#123;
  <span class="hljs-comment">// 和cli中的插件保持一样 增加apply方法</span>
  <span class="hljs-keyword">const</span> idToPlugin = <span class="hljs-function">(<span class="hljs-params">id, absolutePath</span>) =></span> (&#123;
    <span class="hljs-attr">id</span>: id.replace(<span class="hljs-regexp">/^.\//</span>, <span class="hljs-string">"built-in:"</span>),
    <span class="hljs-attr">apply</span>: <span class="hljs-built_in">require</span>(absolutePath || id),
  &#125;);
  <span class="hljs-keyword">let</span> plugins
  <span class="hljs-keyword">const</span> builtInPlugins = [
    <span class="hljs-comment">// 命令</span>
    <span class="hljs-string">"./commands/serve"</span>, <span class="hljs-string">"./commands/build"</span>, <span class="hljs-string">"./commands/inspect"</span>,
    <span class="hljs-comment">// webpack配置相关的</span>
    <span class="hljs-string">"./config/base"</span>,<span class="hljs-string">"./config/assets"</span>, <span class="hljs-string">"./config/css"</span>,<span class="hljs-string">"./config/prod"</span>,
  ].map(<span class="hljs-function">(<span class="hljs-params">id</span>) =></span> idToPlugin(id))
  <span class="hljs-comment">// 找到package.json文件中的plugin</span>
  <span class="hljs-keyword">const</span> projectPlugins = <span class="hljs-built_in">Object</span>.keys(<span class="hljs-built_in">this</span>.pkg.devDependencies || &#123;&#125;)
      .concat(<span class="hljs-built_in">Object</span>.keys(<span class="hljs-built_in">this</span>.pkg.dependencies || &#123;&#125;))
      .filter(isPlugin)
      .map(<span class="hljs-function">(<span class="hljs-params">id</span>) =></span> idToPlugin(id, resolveModule(id, <span class="hljs-built_in">this</span>.pkgContext)));
  <span class="hljs-keyword">return</span> builtInPlugins.concat(projectPlugins)
&#125;
<span class="copy-code-btn">复制代码</span></code></pre>
<ol start="2">
<li>run</li>
</ol>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-title">run</span>(<span class="hljs-params"></span>)</span> &#123;
  <span class="hljs-comment">// 初始化 加载env load用户配置(vue.config.js) 应用插件</span>
  <span class="hljs-keyword">await</span> <span class="hljs-built_in">this</span>.init(mode);
  <span class="hljs-comment">// 执行对应的命令 server中注册命令</span>
  <span class="hljs-keyword">let</span> command = <span class="hljs-built_in">this</span>.commands[name];
  <span class="hljs-keyword">const</span> &#123; fn &#125; = command;
  <span class="hljs-keyword">return</span> fn(args, rawArgv)
&#125;
<span class="copy-code-btn">复制代码</span></code></pre>
<ol start="3">
<li>init</li>
</ol>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// init方法主要三个 加载.env文件 加载用户vue.config.js配置文件 应用插件(apply方法提供一个api方法)</span>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-title">init</span>(<span class="hljs-params"></span>)</span> &#123;
  <span class="hljs-comment">// 加载.env </span>
  <span class="hljs-comment">// 用户配置的参数必须是 VUE_APP_开头的 webpack中会通过正则匹配 webpack.DefinePlugin定义成全局的变量</span>
  <span class="hljs-built_in">this</span>.loadEnv();
  <span class="hljs-comment">// 用户配置 vue.config.js</span>
  <span class="hljs-keyword">const</span> userOptions = <span class="hljs-built_in">this</span>.loadUserOptions()
  <span class="hljs-comment">// 应用插件 执行apply方法  config是webpack相关的 混入一些配置</span>
  <span class="hljs-comment">// commands是注册一些命令 加入到this.commands中 run的时候执行对应的命令</span>
  <span class="hljs-keyword">const</span> loadedCallback = <span class="hljs-function">(<span class="hljs-params">loadedUserOptions</span>) =></span> &#123;
    <span class="hljs-built_in">this</span>.plugins.forEach(<span class="hljs-function">(<span class="hljs-params">&#123; id, apply &#125;</span>) =></span> &#123;
      <span class="hljs-comment">// 执行apply方法 传入一些api方法给插件来使用</span>
      apply(<span class="hljs-keyword">new</span> PluginAPI(id, <span class="hljs-built_in">this</span>), <span class="hljs-built_in">this</span>.projectOptions);
    &#125;); 
    <span class="hljs-comment">// webpack相关 vue.config.js中配置</span>
    <span class="hljs-built_in">this</span>.webpackChainFns.push(<span class="hljs-built_in">this</span>.projectOptions.chainWebpack)
    <span class="hljs-built_in">this</span>.webpackRawConfigFns.push(<span class="hljs-built_in">this</span>.projectOptions.configureWebpack)
  &#125;
  <span class="hljs-keyword">return</span> loadedCallback(userOptions)
  resolveWebpackConfig()
&#125;
<span class="copy-code-btn">复制代码</span></code></pre>
<ol start="4">
<li>PluginAPI</li>
</ol>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// 这些api我们在开发插件的时候可以使用到</span>
<span class="hljs-comment">// 插件api一个是注册命令 一个是修改配置</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PluginAPI</span> </span>&#123;
  <span class="hljs-comment">// 注册命令 serve build都是这样注册的</span>
  <span class="hljs-function"><span class="hljs-title">registerCommand</span>(<span class="hljs-params">name, opts, fn</span>)</span> &#123;
    <span class="hljs-built_in">this</span>.service.commands[name] = &#123; fn, <span class="hljs-attr">opts</span>: opts || &#123;&#125; &#125;;
  &#125;
  <span class="hljs-comment">// 修改webpack配置</span>
  <span class="hljs-function"><span class="hljs-title">chainWebpack</span>(<span class="hljs-params"></span>)</span> &#123;
    <span class="hljs-built_in">this</span>.service.webpackChainFns.push(fn);
  &#125;
  <span class="hljs-function"><span class="hljs-title">configureWebpack</span>(<span class="hljs-params"></span>)</span> &#123; &#125;
  <span class="hljs-function"><span class="hljs-title">configureDevServer</span>(<span class="hljs-params">fn</span>)</span> &#123;&#125;
  <span class="hljs-function"><span class="hljs-title">resolveWebpackConfig</span>(<span class="hljs-params"></span>)</span> &#123;&#125;
  <span class="hljs-function"><span class="hljs-title">resolveChainableWebpackConfig</span>(<span class="hljs-params"></span>)</span>&#123;&#125;
&#125;
<span class="copy-code-btn">复制代码</span></code></pre>
<h3 data-id="heading-36">4. 插件</h3>
<ol>
<li>注册命令</li>
</ol>
<pre><code class="hljs language-js copyable" lang="js">program.command(<span class="hljs-string">"add <plugin> [pluginOptions]"</span>).action(<span class="hljs-function">(<span class="hljs-params">plugin</span>) =></span> &#123;
  <span class="hljs-built_in">require</span>(<span class="hljs-string">"../lib/add"</span>)(plugin, minimist(process.argv.slice(<span class="hljs-number">3</span>)));
&#125;);
<span class="copy-code-btn">复制代码</span></code></pre>
<ol start="2">
<li>add</li>
</ol>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// vue add native-ui</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">add</span> (<span class="hljs-params">pluginToAdd, options = &#123;&#125;, context = process.cwd()</span>) </span>&#123;
  <span class="hljs-comment">// 如果有未提交的代码直接return</span>
  <span class="hljs-keyword">if</span> (!(<span class="hljs-keyword">await</span> confirmIfGitDirty(context))) &#123;  <span class="hljs-keyword">return</span> &#125;
  <span class="hljs-keyword">const</span> packageName = resolvePluginId(pluginName)
  <span class="hljs-comment">// yarn add xxx</span>
  <span class="hljs-keyword">await</span> pm.add(<span class="hljs-string">`<span class="hljs-subst">$&#123;packageName&#125;</span>@<span class="hljs-subst">$&#123;pluginVersion&#125;</span>`</span>)
  <span class="hljs-keyword">const</span> generatorPath = resolveModule(<span class="hljs-string">`<span class="hljs-subst">$&#123;packageName&#125;</span>/generator`</span>, context)
  <span class="hljs-comment">// const generator = new Generator(</span>
  <span class="hljs-comment">// await generator.generate()</span>
  invoke(pluginName, options, context)
&#125;
<span class="copy-code-btn">复制代码</span></code></pre>
<ol start="3">
<li>api</li>
</ol>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// GeneratorAPI 给我们提供一些api</span>
<span class="hljs-comment">// https://github.com/vuejs/vue-cli/blob/dev/packages/%40vue/cli/lib/GeneratorAPI.js</span>
<span class="hljs-comment">// 插件一般是用 修改package.json文件 增加命令(修改scripts 增加依赖项) 动态注入import render渲染 模版文件等</span>
<span class="copy-code-btn">复制代码</span></code></pre>
<ol start="4">
<li>实现一个简单的插件</li>
</ol>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// 将官方提供的vuex做简单的修改即可</span>
<span class="hljs-built_in">module</span>.exports = <span class="hljs-function">(<span class="hljs-params">api, options = &#123;&#125;, rootOptions = &#123;&#125;</span>) =></span> &#123;
  api.injectImports(api.entryFile, <span class="hljs-string">`import native from './plugins/native-ui';`</span>);
  api.transformScript(api.entryFile, <span class="hljs-built_in">require</span>(<span class="hljs-string">"./injectUseNativeUi"</span>));
  <span class="hljs-comment">// 加一个依赖</span>
  api.extendPackage(&#123;
    <span class="hljs-attr">dependencies</span>: &#123;
      <span class="hljs-string">"naive-ui"</span>: <span class="hljs-string">"^2.11.4"</span>,
    &#125;,
  &#125;);
  <span class="hljs-comment">// 渲染template下的文件</span>
  api.render(<span class="hljs-string">"./template"</span>, &#123;&#125;);
  <span class="hljs-comment">// 提供选项给用户 部分导入还是全部导入</span>
  <span class="hljs-comment">// if (options.import === "partial") &#123;</span>
  <span class="hljs-comment">// &#125;</span>
&#125;;
<span class="copy-code-btn">复制代码</span></code></pre></div>  
</div>
            