
---
title: '深入理解事件循环'
categories: 
 - 编程
 - 掘金
 - 分类
headimg: 'https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/91ee90b360ea44668184fac4d2866000~tplv-k3u1fbpfcp-watermark.image'
author: 掘金
comments: false
date: Sat, 24 Jul 2021 23:55:10 GMT
thumbnail: 'https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/91ee90b360ea44668184fac4d2866000~tplv-k3u1fbpfcp-watermark.image'
---

<div>   
<div class="markdown-body"><style>.markdown-body&#123;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333&#125;.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6&#123;line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px&#125;.markdown-body h1&#123;font-size:30px;margin-bottom:5px&#125;.markdown-body h2&#123;padding-bottom:12px;font-size:24px;border-bottom:1px solid #ececec&#125;.markdown-body h3&#123;font-size:18px;padding-bottom:0&#125;.markdown-body h4&#123;font-size:16px&#125;.markdown-body h5&#123;font-size:15px&#125;.markdown-body h6&#123;margin-top:5px&#125;.markdown-body p&#123;line-height:inherit;margin-top:22px;margin-bottom:22px&#125;.markdown-body img&#123;max-width:100%&#125;.markdown-body hr&#123;border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px&#125;.markdown-body code&#123;word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em&#125;.markdown-body code,.markdown-body pre&#123;font-family:Menlo,Monaco,Consolas,Courier New,monospace&#125;.markdown-body pre&#123;overflow:auto;position:relative;line-height:1.75&#125;.markdown-body pre>code&#123;font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8&#125;.markdown-body a&#123;text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff&#125;.markdown-body a:active,.markdown-body a:hover&#123;color:#275b8c&#125;.markdown-body table&#123;display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6&#125;.markdown-body thead&#123;background:#f6f6f6;color:#000;text-align:left&#125;.markdown-body tr:nth-child(2n)&#123;background-color:#fcfcfc&#125;.markdown-body td,.markdown-body th&#123;padding:12px 7px;line-height:24px&#125;.markdown-body td&#123;min-width:120px&#125;.markdown-body blockquote&#123;color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8&#125;.markdown-body blockquote:after&#123;display:block;content:""&#125;.markdown-body blockquote>p&#123;margin:10px 0&#125;.markdown-body ol,.markdown-body ul&#123;padding-left:28px&#125;.markdown-body ol li,.markdown-body ul li&#123;margin-bottom:0;list-style:inherit&#125;.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item&#123;list-style:none&#125;.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul&#123;margin-top:0&#125;.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul&#123;margin-top:3px&#125;.markdown-body ol li&#123;padding-left:6px&#125;.markdown-body .contains-task-list&#123;padding-left:0&#125;.markdown-body .task-list-item&#123;list-style:none&#125;@media (max-width:720px)&#123;.markdown-body h1&#123;font-size:24px&#125;.markdown-body h2&#123;font-size:20px&#125;.markdown-body h3&#123;font-size:18px&#125;&#125;</style><p>本文已参与好文召集令活动，点击查看：<a href="https://juejin.cn/post/6978685539985653767" target="_blank" title="https://juejin.cn/post/6978685539985653767">后端、大前端双赛道投稿，2万元奖池等你挑战！</a></p>
<h1 data-id="heading-0">JS 引擎并不提供事件循环</h1>
<p>在谈事件循环的时候，经常会说请说一说JS的事件循环机制。这常常会让人产生一种误解，事件循环好像是JS语言的特性。</p>
<p>实际上并不是，要弄清楚这个问题，我们先要明晰这些概念。</p>
<h2 data-id="heading-1">宿主环境、JS引擎、渲染引擎</h2>
<p>宿主环境由JS引擎和渲染引擎。最常见的宿主环境就是浏览器提供的环境。</p>
<ul>
<li>JS引擎：运行JavaScript代码。最出名的是Chrome的V8引擎。</li>
<li>渲染引擎：对网页进行排版和显示。最出名的是Webkit引擎。</li>
</ul>
<p>注意，JS引擎运行在JS线程，渲染引擎运行在渲染线程。浏览器让他们互斥，当一个线程运行的时候，另一个线程就得挂起。</p>
<blockquote>
<p>除了浏览器，Node.js也是一个主要的宿主环境，这个环节就不包含渲染引擎了。它也提供了同浏览器稍有不同的时间循环机制。</p>
</blockquote>
<h1 data-id="heading-2">宿主环境提供事件循环</h1>
<p>因为JS引擎并不提供事件循环，且关键的一点，JS是单线程语言，所以浏览器需要有一种机制，让JS能处理异步任务，于是有了时间循环机制。</p>
<p>我们来列举一些浏览器有那些异步任务：</p>
<ul>
<li>DOM事件。如鼠标点击产生的回调。</li>
<li>http请求产生的回调。</li>
<li>setInterval和setTimeout。定时器产生的回调。</li>
</ul>
<p>这些产生的回调，就会进入事件队列。等JS引擎空闲了，依次的执行它们（但是定时器肯定得等它们到时间了，才执行它们）。</p>
<h2 data-id="heading-3">宏任务 和 微任务</h2>
<p>上面说的那些，都是宏任务。是宿主让JS拥有了处理异步的能力。但宏任务还是有不足之处的，毕竟是宿主提供的API，涉及跟JS引擎交互，性能上肯定有点问题。同时，JS本身也意识到了自己的不足，区区一个单线程语言，本身没有处理异步的能力。</p>
<p>随着时间的推进，JS语言自身支持异步编程，也就是Promise来了（也就是微任务）！对于JS语言来说，弥补了自己异步能力的缺陷，也为前端开发人员，提供了多一种选择，来处理异步。</p>
<p>这也就是宏任务和微任务的本质：</p>
<ul>
<li>由宿主提供的，为宏任务。</li>
<li>由JS语言自身提供的，为微任务。</li>
</ul>
<p>那么，它们的执行时机，解释起来就非常的合理了。在JS代码执行的过程中，产生了一些宏任务和微任务。当前的任务执行结束后，把所有准备好的微任务都执行了，因为它们是JS引擎内部的，先统统执行完，再考虑跟外边交互。等微任务执行完了，好了，去宿主那看看，有没有需要交给我处理的宏任务。</p>
<p>如下图：微任务队列在JS引擎内，宏任务队列在JS引擎外。将准备好的微任务都执行完毕后，再去外边找一个宏任务来执行。</p>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/91ee90b360ea44668184fac4d2866000~tplv-k3u1fbpfcp-watermark.image" alt="事件循环.png" loading="lazy" referrerpolicy="no-referrer"></p>
<h1 data-id="heading-4">一次事件循环还做了什么</h1>
<p>除了针对JS引擎的部分，事件循环还有针对渲染引擎的部分。</p>
<p>如下图所示，每次事件循环，会检查一下是否需要渲染，如果需要，就把JS引擎挂起，让渲染引擎开始工作，渲染网页，这样整个流程就完整了。</p>
<img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6d6be3e54bfe4470ae0c780f743735e2~tplv-k3u1fbpfcp-watermark.image" loading="lazy" referrerpolicy="no-referrer">
<h1 data-id="heading-5">vue的nextTick是宏任务还是微任务</h1>
<p>可以是宏任务也可以是微任务。但是默认优先使用微任务。只有在宿主环境不支持微任务的时候，才会回退到使用宏任务。</p>
<p>显然，微任务是更好的选择，拥有更高的执行效率。但也让我产生了疑问，this.$nextTick的回调可以拿到更新后的DOM。更新后的DOM？是渲染后的DOM吗？那岂不是得等一次事件循环结束，浏览器渲染完成页面，才能拿到最新的DOM。那不得用宏任务才行，微任务的执行，并没有完成一次事件循环，新的DOM元素也没有渲染啊。</p>
<p>这里我理解有误，正确的理解应该是这样的，更新DOM是指更新内存中的DOM，并不是指渲染到显示器上。所以，我们用this.$nextTick注册的回调，会同更新DOM的方法，一同顺序的在下一个微任务中执行。是可以拿到更新后的DOM的。</p>
<h1 data-id="heading-6">结语</h1>
<p>以上理解是看了多篇文章，加之自己的一点理解总结，感觉逻辑上是合理的，如有问题，欢迎指出。</p></div>  
</div>
            