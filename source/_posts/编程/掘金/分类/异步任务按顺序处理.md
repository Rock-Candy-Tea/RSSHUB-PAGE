
---
title: '异步任务按顺序处理'
categories: 
 - 编程
 - 掘金
 - 分类
headimg: 'https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9aa67ecf96a84bf394b7f2677e74e23a~tplv-k3u1fbpfcp-watermark.image'
author: 掘金
comments: false
date: Fri, 21 May 2021 03:28:19 GMT
thumbnail: 'https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9aa67ecf96a84bf394b7f2677e74e23a~tplv-k3u1fbpfcp-watermark.image'
---

<div>   
<div class="markdown-body"><style>.markdown-body&#123;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333&#125;.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6&#123;line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px&#125;.markdown-body h1&#123;font-size:30px;margin-bottom:5px&#125;.markdown-body h2&#123;padding-bottom:12px;font-size:24px;border-bottom:1px solid #ececec&#125;.markdown-body h3&#123;font-size:18px;padding-bottom:0&#125;.markdown-body h4&#123;font-size:16px&#125;.markdown-body h5&#123;font-size:15px&#125;.markdown-body h6&#123;margin-top:5px&#125;.markdown-body p&#123;line-height:inherit;margin-top:22px;margin-bottom:22px&#125;.markdown-body img&#123;max-width:100%&#125;.markdown-body hr&#123;border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px&#125;.markdown-body code&#123;word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em&#125;.markdown-body code,.markdown-body pre&#123;font-family:Menlo,Monaco,Consolas,Courier New,monospace&#125;.markdown-body pre&#123;overflow:auto;position:relative;line-height:1.75&#125;.markdown-body pre>code&#123;font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8&#125;.markdown-body a&#123;text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff&#125;.markdown-body a:active,.markdown-body a:hover&#123;color:#275b8c&#125;.markdown-body table&#123;display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6&#125;.markdown-body thead&#123;background:#f6f6f6;color:#000;text-align:left&#125;.markdown-body tr:nth-child(2n)&#123;background-color:#fcfcfc&#125;.markdown-body td,.markdown-body th&#123;padding:12px 7px;line-height:24px&#125;.markdown-body td&#123;min-width:120px&#125;.markdown-body blockquote&#123;color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8&#125;.markdown-body blockquote:after&#123;display:block;content:""&#125;.markdown-body blockquote>p&#123;margin:10px 0&#125;.markdown-body ol,.markdown-body ul&#123;padding-left:28px&#125;.markdown-body ol li,.markdown-body ul li&#123;margin-bottom:0;list-style:inherit&#125;.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item&#123;list-style:none&#125;.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul&#123;margin-top:0&#125;.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul&#123;margin-top:3px&#125;.markdown-body ol li&#123;padding-left:6px&#125;.markdown-body .contains-task-list&#123;padding-left:0&#125;.markdown-body .task-list-item&#123;list-style:none&#125;@media (max-width:720px)&#123;.markdown-body h1&#123;font-size:24px&#125;.markdown-body h2&#123;font-size:20px&#125;.markdown-body h3&#123;font-size:18px&#125;&#125;</style><h3 data-id="heading-0">1.实现每隔1s输出一个元素</h3>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">/**
 * 实现每隔1s输出一个元素
 */</span>
<span class="hljs-keyword">const</span> arr = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>];

<span class="hljs-comment">/**
 * 1. async/await实现
 */</span>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">foo</span>(<span class="hljs-params">arr</span>) </span>&#123;
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> el <span class="hljs-keyword">of</span> arr) &#123;
    <span class="hljs-built_in">console</span>.log(el);
    <span class="hljs-comment">// await会一直阻塞，直到后面的Promise执行resolve</span>
    <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =></span> <span class="hljs-built_in">setTimeout</span>(resolve, <span class="hljs-number">1000</span>));
  &#125;
&#125;
foo(arr);

<span class="hljs-comment">/**
 * 2. Promise实现
 */</span>
<span class="hljs-comment">// 手动链式调用</span>
<span class="hljs-built_in">Promise</span>.resolve(<span class="hljs-number">1</span>).then(<span class="hljs-function"><span class="hljs-params">data</span> =></span> &#123;
  <span class="hljs-built_in">console</span>.log(data);
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span>=></span> <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">()=></span>resolve(<span class="hljs-number">2</span>),<span class="hljs-number">1000</span>));
&#125;).then(<span class="hljs-function"><span class="hljs-params">data</span> =></span> &#123;
  <span class="hljs-built_in">console</span>.log(data);
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span>=></span> <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">()=></span>resolve(<span class="hljs-number">3</span>),<span class="hljs-number">1000</span>));
&#125;).then(<span class="hljs-function"><span class="hljs-params">data</span> =></span> &#123;
  <span class="hljs-built_in">console</span>.log(data);
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span>=></span> <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">()=></span>resolve(<span class="hljs-number">4</span>),<span class="hljs-number">1000</span>));
&#125;).then(<span class="hljs-function"><span class="hljs-params">data</span> =></span> &#123;
  <span class="hljs-built_in">console</span>.log(data);
&#125;)
<span class="hljs-comment">// 用reduce重写如下，本质上与上面一样</span>
arr.reduce(<span class="hljs-function">(<span class="hljs-params">prev,cur</span>)=></span> &#123;
  <span class="hljs-keyword">return</span> prev.then(<span class="hljs-function">()=></span> &#123;
    <span class="hljs-built_in">console</span>.log(cur);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span>=></span> &#123;
      <span class="hljs-built_in">setTimeout</span>(resolve,<span class="hljs-number">1000</span>);
    &#125;);
  &#125;);
&#125;, <span class="hljs-built_in">Promise</span>.resolve());

<span class="hljs-comment">/**
 * 3. Generator实现
 */</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> *<span class="hljs-title">gen</span>(<span class="hljs-params">arr</span>) </span>&#123;
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> el <span class="hljs-keyword">of</span> arr) &#123;
    <span class="hljs-keyword">yield</span> delay(el);
  &#125;
&#125;
<span class="hljs-keyword">const</span> g = gen(arr);
g.next();
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">delay</span>(<span class="hljs-params">el</span>) </span>&#123;
  <span class="hljs-built_in">console</span>.log(el);
  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">()=></span> &#123;
    g.next();
  &#125;,<span class="hljs-number">1000</span>);
&#125;
<span class="copy-code-btn">复制代码</span></code></pre>
<h3 data-id="heading-1">2.实现限制并发数的图片下载</h3>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-keyword">const</span> urls = [
  <span class="hljs-string">"https://hexo-blog-1256114407.cos.ap-shenzhen-fsi.myqcloud.com/AboutMe-painting1.png"</span>,
  <span class="hljs-string">"https://hexo-blog-1256114407.cos.ap-shenzhen-fsi.myqcloud.com/AboutMe-painting2.png"</span>,
  <span class="hljs-string">"https://hexo-blog-1256114407.cos.ap-shenzhen-fsi.myqcloud.com/AboutMe-painting3.png"</span>,
  <span class="hljs-string">"https://hexo-blog-1256114407.cos.ap-shenzhen-fsi.myqcloud.com/AboutMe-painting4.png"</span>,
  <span class="hljs-string">"https://hexo-blog-1256114407.cos.ap-shenzhen-fsi.myqcloud.com/AboutMe-painting5.png"</span>,
  <span class="hljs-string">"https://hexo-blog-1256114407.cos.ap-shenzhen-fsi.myqcloud.com/bpmn6.png"</span>,
  <span class="hljs-string">"https://hexo-blog-1256114407.cos.ap-shenzhen-fsi.myqcloud.com/bpmn7.png"</span>,
  <span class="hljs-string">"https://hexo-blog-1256114407.cos.ap-shenzhen-fsi.myqcloud.com/bpmn8.png"</span>,
];
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">loadImg</span>(<span class="hljs-params">url</span>) </span>&#123;
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =></span> &#123;
    <span class="hljs-keyword">const</span> img = <span class="hljs-keyword">new</span> Image();
    img.onload = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>&#123;
      <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`图片<span class="hljs-subst">$&#123;url&#125;</span>加载完成`</span>);
      resolve();
    &#125;;
    img.onerror = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>&#123;
      reject(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Could not load image at'</span> + url));
    &#125;;
    img.src = url;
  &#125;);
&#125;;

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">limitLoad</span>(<span class="hljs-params">urls, handler, limit</span>) </span>&#123;
  <span class="hljs-comment">// ...实现代码</span>
  <span class="hljs-keyword">const</span> sequence = urls.slice();
  <span class="hljs-keyword">const</span> poll = sequence.splice(<span class="hljs-number">0</span>,limit).map(<span class="hljs-function">(<span class="hljs-params">url,idx</span>)=></span> &#123;
    <span class="hljs-keyword">return</span> handler(url).then(<span class="hljs-function">()=></span>idx);
  &#125;);
  sequence.reduce(<span class="hljs-function">(<span class="hljs-params">prev,url</span>)=></span> &#123;
    <span class="hljs-keyword">return</span> prev.then(<span class="hljs-function">()=></span> &#123;
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span>=></span> &#123;
        <span class="hljs-built_in">Promise</span>.race(poll).then(<span class="hljs-function"><span class="hljs-params">fastestIdx</span>=></span> &#123;
          poll[fastestIdx] = handler(url).then(<span class="hljs-function">()=></span>fastestIdx);
          resolve();
        &#125;)
      &#125;)
    &#125;);
  &#125;,<span class="hljs-built_in">Promise</span>.resolve());
&#125;
limitLoad(urls,loadImg,<span class="hljs-number">3</span>);
<span class="copy-code-btn">复制代码</span></code></pre>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9aa67ecf96a84bf394b7f2677e74e23a~tplv-k3u1fbpfcp-watermark.image" alt="image.png" loading="lazy" referrerpolicy="no-referrer">
(绿色部分为等待时间，蓝色部分为下载时间)</p>
<p>从这张图可以看出在任何时刻，至多有3张图片在下载。</p>
<h3 data-id="heading-2">说明</h3>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-built_in">Promise</span>.resolve().then(<span class="hljs-function">()=></span> &#123;
  <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
&#125;).then(<span class="hljs-function"><span class="hljs-params">value</span>=></span> &#123;
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'value '</span>, value);
  <span class="hljs-keyword">throw</span> <span class="hljs-string">'error'</span>;
&#125;).catch(<span class="hljs-function"><span class="hljs-params">reason</span>=></span> &#123;
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'reason '</span>, reason);
  <span class="hljs-keyword">return</span> <span class="hljs-number">2</span>;
&#125;).then(<span class="hljs-function"><span class="hljs-params">value</span>=></span> &#123;
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'value '</span>,value);
&#125;)
<span class="hljs-comment">// 相当于</span>
<span class="hljs-built_in">Promise</span>.resolve().then(<span class="hljs-function">()=></span> &#123;
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span>=></span> resolve(<span class="hljs-number">1</span>))
&#125;).then(<span class="hljs-function"><span class="hljs-params">value</span>=></span> &#123;
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'value '</span>,value);
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve,reject</span>)=></span> &#123;
    reject(<span class="hljs-string">'error'</span>);
  &#125;);
&#125;).catch(<span class="hljs-function"><span class="hljs-params">reason</span>=></span> &#123;
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'reason '</span>,reason);
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span>=></span> resolve(<span class="hljs-number">2</span>));
&#125;).then(<span class="hljs-function"><span class="hljs-params">value</span>=></span> &#123;
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'value '</span>,value);
&#125;)
<span class="copy-code-btn">复制代码</span></code></pre>
<p>即每个then会默认返回一个新的Promsie对象供下一个then使用。如果then中直接return一个值，会默认将这个值封装进一个Promise对象中，然后在该对象中resolve这个值。也就是说对于then的链式调用，下一个then的执行必须要等到上一个then中return的Promise对象先resolve了。我们上面两个程序的Promise解决方案都是基于这一点完成的。catch同理。</p>
<p>所谓的reduce，其实就是Promise.resolve().then().then().....then()，然后我们在每个then中return一个new出来的Promise对象。</p>
<p>对于第一个程序，要求每隔1秒再输出下一个数。那么我们在每个then中new一个Promise对象，然后在该对象中使用setTimeout令1秒过后再resolve，从而过了1秒才会进入下一个then。</p>
<p>对于第二个程序，加了限制条件，要求最多同时有3个Promise对象在执行，且当其中某一个完成了后面的马上跟上。同样的，我们搞一个长度为3的poll，里面先把前三个url放进去下载。然后使用then链式调用，对于每个then，我们返回的Promise对象中，使用Promise.race获取第一个下载完成的图片在poll中的index，然后把那个位置用新的Promise对象替换，说明有一个完成了开始下载新的图片了，再resolve进入下一个then，重复前面的操作。由于Promise.race会阻塞着直到里面有一个Promise对象resolve了才会进入Promise.race([xxx]).then()，然后在这个then中我们resolve进入下一个大的then。也就是说，后面所有操作都会等待Promise.race([xxx])中的xxx里resolve一个。</p></div>  
</div>
            