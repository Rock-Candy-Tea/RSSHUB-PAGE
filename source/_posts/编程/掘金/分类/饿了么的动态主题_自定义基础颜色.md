
---
title: '饿了么的动态主题_自定义基础颜色'
categories: 
 - 编程
 - 掘金
 - 分类
headimg: 'https://picsum.photos/400/300?random=5985'
author: 掘金
comments: false
date: Sun, 18 Jul 2021 02:25:51 GMT
thumbnail: 'https://picsum.photos/400/300?random=5985'
---

<div>   
<div class="markdown-body"><style>.markdown-body&#123;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333&#125;.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6&#123;line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px&#125;.markdown-body h1&#123;font-size:30px;margin-bottom:5px&#125;.markdown-body h2&#123;padding-bottom:12px;font-size:24px;border-bottom:1px solid #ececec&#125;.markdown-body h3&#123;font-size:18px;padding-bottom:0&#125;.markdown-body h4&#123;font-size:16px&#125;.markdown-body h5&#123;font-size:15px&#125;.markdown-body h6&#123;margin-top:5px&#125;.markdown-body p&#123;line-height:inherit;margin-top:22px;margin-bottom:22px&#125;.markdown-body img&#123;max-width:100%&#125;.markdown-body hr&#123;border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px&#125;.markdown-body code&#123;word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em&#125;.markdown-body code,.markdown-body pre&#123;font-family:Menlo,Monaco,Consolas,Courier New,monospace&#125;.markdown-body pre&#123;overflow:auto;position:relative;line-height:1.75&#125;.markdown-body pre>code&#123;font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8&#125;.markdown-body a&#123;text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff&#125;.markdown-body a:active,.markdown-body a:hover&#123;color:#275b8c&#125;.markdown-body table&#123;display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6&#125;.markdown-body thead&#123;background:#f6f6f6;color:#000;text-align:left&#125;.markdown-body tr:nth-child(2n)&#123;background-color:#fcfcfc&#125;.markdown-body td,.markdown-body th&#123;padding:12px 7px;line-height:24px&#125;.markdown-body td&#123;min-width:120px&#125;.markdown-body blockquote&#123;color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8&#125;.markdown-body blockquote:after&#123;display:block;content:""&#125;.markdown-body blockquote>p&#123;margin:10px 0&#125;.markdown-body ol,.markdown-body ul&#123;padding-left:28px&#125;.markdown-body ol li,.markdown-body ul li&#123;margin-bottom:0;list-style:inherit&#125;.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item&#123;list-style:none&#125;.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul&#123;margin-top:0&#125;.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul&#123;margin-top:3px&#125;.markdown-body ol li&#123;padding-left:6px&#125;.markdown-body .contains-task-list&#123;padding-left:0&#125;.markdown-body .task-list-item&#123;list-style:none&#125;@media (max-width:720px)&#123;.markdown-body h1&#123;font-size:24px&#125;.markdown-body h2&#123;font-size:20px&#125;.markdown-body h3&#123;font-size:18px&#125;&#125;</style><p>动态主题的设置</p>
<blockquote>
<p>我们想要实现在页面中实时的切换颜色，此时页面的主题可以跟着设置的颜色进行变化</p>
</blockquote>
<p><strong>简单说明一下它的原理：</strong> element-ui 2.0 版本之后所有的样式都是基于 SCSS 编写的，所有的颜色都是基于几个基础颜色<a href="https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2FPanJiaChen%2Fcustom-element-theme%2Fblob%2Fmaster%2Felement-variables.scss" target="_blank" rel="nofollow noopener noreferrer" title="https://github.com/PanJiaChen/custom-element-theme/blob/master/element-variables.scss" ref="nofollow noopener noreferrer">变量</a>来设置的，所以就不难实现动态换肤了，只要找到那几个颜色变量修改它就可以了。 首先我们需要拿到通过 <code>package.json</code> 拿到 element-ui 的版本号，根据该版本号去请求相应的样式。拿到样式之后将样色，通过正则匹配和替换，将颜色变量替换成你需要的，之后动态添加 <code>style</code> 标签来覆盖原有的 css 样式。</p>
<p>第一步， 封装颜色选择组件 <strong><code>ThemePicker</code></strong> (<a href="https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2FPanJiaChen%2Fvue-element-admin%2Fblob%2Fmaster%2Fsrc%2Fcomponents%2FThemePicker%2Findex.vue)%25E3%2580%2582" target="_blank" rel="nofollow noopener noreferrer" title="https://github.com/PanJiaChen/vue-element-admin/blob/master/src/components/ThemePicker/index.vue)%E3%80%82" ref="nofollow noopener noreferrer">github.com/PanJiaChen/…</a></p>
<h1 data-id="heading-0">1.复制粘贴</h1>
<blockquote>
<p>代码所在路径：[@/components/ThemePicker]</p>
</blockquote>
<h1 data-id="heading-1">2.index进行全局注册为组件</h1>
<blockquote>
<p>全局注册路径 [@/components/index]</p>
</blockquote>
<pre><code class="copyable">
// 该文件负责所有的公共的组件的全局注册   Vue.use
import ThemePicker from './ThemePicker'

export default &#123;
  install(Vue) &#123;
    //  注册全局的通用栏组件对象
    Vue.component('ThemePicker', ThemePicker)
  &#125;
&#125;

<span class="copy-code-btn">复制代码</span></code></pre>
<h1 data-id="heading-2">4.使用__放在你喜欢的结构里面</h1>
<pre><code class="copyable">  <!-- 放置插件 -->
    <theme-picker class="right-menu-item" />
<span class="copy-code-btn">复制代码</span></code></pre>
<h1 data-id="heading-3">5.详细代码</h1>
<h4 data-id="heading-4">[@/components/ThemePicker]</h4>
<pre><code class="copyable"><template>
  <el-color-picker
    v-model="theme"
    :predefine="['#409EFF', '#1890ff', '#304156','#212121','#11a983', '#13c2c2', '#6959CD', '#f5222d', ]"
    class="theme-picker"
    popper-class="theme-picker-dropdown"
  />

</template>

<script>
const version = require('element-ui/package.json').version // element-ui version from node_modules
const ORIGINAL_THEME = '#409EFF' // default color
export default &#123;
  data() &#123;
    return &#123;
      chalk: '', // content of theme-chalk css
      theme: ''
    &#125;
  &#125;,
  computed: &#123;
    defaultTheme() &#123;
      return this.$store.state.settings.theme
    &#125;
  &#125;,
  watch: &#123;
    defaultTheme: &#123;
      handler: function(val, oldVal) &#123;
        this.theme = val
      &#125;,
      immediate: true
    &#125;,
    async theme(val) &#123;
      const oldVal = this.chalk ? this.theme : ORIGINAL_THEME
      if (typeof val !== 'string') return
      const themeCluster = this.getThemeCluster(val.replace('#', ''))
      const originalCluster = this.getThemeCluster(oldVal.replace('#', ''))
      console.log(themeCluster, originalCluster)
      const $message = this.$message(&#123;
        message: '  Compiling the theme',
        customClass: 'theme-message',
        type: 'success',
        duration: 0,
        iconClass: 'el-icon-loading'
      &#125;)
      const getHandler = (variable, id) => &#123;
        return () => &#123;
          const originalCluster = this.getThemeCluster(ORIGINAL_THEME.replace('#', ''))
          const newStyle = this.updateStyle(this[variable], originalCluster, themeCluster)
          let styleTag = document.getElementById(id)
          if (!styleTag) &#123;
            styleTag = document.createElement('style')
            styleTag.setAttribute('id', id)
            document.head.appendChild(styleTag)
          &#125;
          styleTag.innerText = newStyle
        &#125;
      &#125;
      if (!this.chalk) &#123;
        const url = `https://unpkg.com/element-ui@$&#123;version&#125;/lib/theme-chalk/index.css`
        await this.getCSSString(url, 'chalk')
      &#125;
      const chalkHandler = getHandler('chalk', 'chalk-style')
      chalkHandler()
      const styles = [].slice.call(document.querySelectorAll('style'))
        .filter(style => &#123;
          const text = style.innerText
          return new RegExp(oldVal, 'i').test(text) && !/Chalk Variables/.test(text)
        &#125;)
      styles.forEach(style => &#123;
        const &#123; innerText &#125; = style
        if (typeof innerText !== 'string') return
        style.innerText = this.updateStyle(innerText, originalCluster, themeCluster)
      &#125;)
      this.$emit('change', val)
      $message.close()
    &#125;
  &#125;,
  methods: &#123;
    updateStyle(style, oldCluster, newCluster) &#123;
      let newStyle = style
      oldCluster.forEach((color, index) => &#123;
        newStyle = newStyle.replace(new RegExp(color, 'ig'), newCluster[index])
      &#125;)
      return newStyle
    &#125;,
    getCSSString(url, variable) &#123;
      return new Promise(resolve => &#123;
        const xhr = new XMLHttpRequest()
        xhr.onreadystatechange = () => &#123;
          if (xhr.readyState === 4 && xhr.status === 200) &#123;
            this[variable] = xhr.responseText.replace(/@font-face&#123;[^&#125;]+&#125;/, '')
            resolve()
          &#125;
        &#125;
        xhr.open('GET', url)
        xhr.send()
      &#125;)
    &#125;,
    getThemeCluster(theme) &#123;
      const tintColor = (color, tint) => &#123;
        let red = parseInt(color.slice(0, 2), 16)
        let green = parseInt(color.slice(2, 4), 16)
        let blue = parseInt(color.slice(4, 6), 16)
        if (tint === 0) &#123; // when primary color is in its rgb space
          return [red, green, blue].join(',')
        &#125; else &#123;
          red += Math.round(tint * (255 - red))
          green += Math.round(tint * (255 - green))
          blue += Math.round(tint * (255 - blue))
          red = red.toString(16)
          green = green.toString(16)
          blue = blue.toString(16)
          return `#$&#123;red&#125;$&#123;green&#125;$&#123;blue&#125;`
        &#125;
      &#125;
      const shadeColor = (color, shade) => &#123;
        let red = parseInt(color.slice(0, 2), 16)
        let green = parseInt(color.slice(2, 4), 16)
        let blue = parseInt(color.slice(4, 6), 16)
        red = Math.round((1 - shade) * red)
        green = Math.round((1 - shade) * green)
        blue = Math.round((1 - shade) * blue)
        red = red.toString(16)
        green = green.toString(16)
        blue = blue.toString(16)
        return `#$&#123;red&#125;$&#123;green&#125;$&#123;blue&#125;`
      &#125;
      const clusters = [theme]
      for (let i = 0; i <= 9; i++) &#123;
        clusters.push(tintColor(theme, Number((i / 10).toFixed(2))))
      &#125;
      clusters.push(shadeColor(theme, 0.1))
      return clusters
    &#125;
  &#125;
&#125;
</script>

<style>
.theme-message,
.theme-picker-dropdown &#123;
  z-index: 99999 !important;
&#125;
.theme-picker .el-color-picker__trigger &#123;
  height: 26px !important;
  width: 26px !important;
  padding: 2px;
&#125;
.theme-picker-dropdown .el-color-dropdown__link-btn &#123;
  display: none;
&#125;
.el-color-picker &#123;
  height: auto !important;
&#125;
</style>

<span class="copy-code-btn">复制代码</span></code></pre></div>  
</div>
            