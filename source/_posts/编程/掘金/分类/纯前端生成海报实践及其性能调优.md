
---
title: '纯前端生成海报实践及其性能调优'
categories: 
 - 编程
 - 掘金
 - 分类
headimg: 'https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6ee2bad377cf40cca30adc3069bd2fa8~tplv-k3u1fbpfcp-watermark.image'
author: 掘金
comments: false
date: Fri, 28 May 2021 17:38:29 GMT
thumbnail: 'https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6ee2bad377cf40cca30adc3069bd2fa8~tplv-k3u1fbpfcp-watermark.image'
---

<div>   
<div class="markdown-body"><style>.markdown-body&#123;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333&#125;.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6&#123;line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px&#125;.markdown-body h1&#123;font-size:30px;margin-bottom:5px&#125;.markdown-body h2&#123;padding-bottom:12px;font-size:24px;border-bottom:1px solid #ececec&#125;.markdown-body h3&#123;font-size:18px;padding-bottom:0&#125;.markdown-body h4&#123;font-size:16px&#125;.markdown-body h5&#123;font-size:15px&#125;.markdown-body h6&#123;margin-top:5px&#125;.markdown-body p&#123;line-height:inherit;margin-top:22px;margin-bottom:22px&#125;.markdown-body img&#123;max-width:100%&#125;.markdown-body hr&#123;border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px&#125;.markdown-body code&#123;word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em&#125;.markdown-body code,.markdown-body pre&#123;font-family:Menlo,Monaco,Consolas,Courier New,monospace&#125;.markdown-body pre&#123;overflow:auto;position:relative;line-height:1.75&#125;.markdown-body pre>code&#123;font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8&#125;.markdown-body a&#123;text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff&#125;.markdown-body a:active,.markdown-body a:hover&#123;color:#275b8c&#125;.markdown-body table&#123;display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6&#125;.markdown-body thead&#123;background:#f6f6f6;color:#000;text-align:left&#125;.markdown-body tr:nth-child(2n)&#123;background-color:#fcfcfc&#125;.markdown-body td,.markdown-body th&#123;padding:12px 7px;line-height:24px&#125;.markdown-body td&#123;min-width:120px&#125;.markdown-body blockquote&#123;color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8&#125;.markdown-body blockquote:after&#123;display:block;content:""&#125;.markdown-body blockquote>p&#123;margin:10px 0&#125;.markdown-body ol,.markdown-body ul&#123;padding-left:28px&#125;.markdown-body ol li,.markdown-body ul li&#123;margin-bottom:0;list-style:inherit&#125;.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item&#123;list-style:none&#125;.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul&#123;margin-top:0&#125;.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul&#123;margin-top:3px&#125;.markdown-body ol li&#123;padding-left:6px&#125;.markdown-body .contains-task-list&#123;padding-left:0&#125;.markdown-body .task-list-item&#123;list-style:none&#125;@media (max-width:720px)&#123;.markdown-body h1&#123;font-size:24px&#125;.markdown-body h2&#123;font-size:20px&#125;.markdown-body h3&#123;font-size:18px&#125;&#125;</style><h2 data-id="heading-0">1 需求背景</h2>
<p>接到了一个紧急需求，需要根据 Excel 表格中学生的信息以及考试成绩生成相应的海报。</p>
<p>Excel 数据和需要生成的海报的样式如下：</p>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6ee2bad377cf40cca30adc3069bd2fa8~tplv-k3u1fbpfcp-watermark.image" alt="表格数据" loading="lazy" referrerpolicy="no-referrer"></p>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/67346b33f5e74e669681e432373f084f~tplv-k3u1fbpfcp-watermark.image" alt="海报样式" loading="lazy" referrerpolicy="no-referrer"></p>
<p>由于需求紧急，没有时间拉上后端同学，所以 Excel 表格的数据解析和海报生成功能都需要由前端开发。</p>
<p>以下几个技术点需要关注：</p>
<ol>
<li>Excel 可以通过 <a href="https://github.com/SheetJS/sheetjs" target="_blank" rel="nofollow noopener noreferrer">sheetjs</a> 来处理，通过在 <code>XLSX.utils.sheet_to_json</code> 将 Excel 中的数据转化为 JSON 格式数据。</li>
<li>海报图片的生成可以先通过 <a href="https://html2canvas.hertzen.com/" target="_blank" rel="nofollow noopener noreferrer">html2canvas</a> 将 HTML 转化成 canvas ，然后通过 <code>canvas.toBlob</code> 获得。</li>
<li>最终通过 <a href="https://stuk.github.io/jszip/" target="_blank" rel="nofollow noopener noreferrer">JSZip</a> 将图片打包进压缩包中。</li>
<li>这里表单可配置项会比较多，因此我们需要一个配置导入导出功能，这里我们可以使用 FileReader 来实现表单配置导入，<code>FileReader.readAsTextapi</code> 能够读取文本的内容，更多用法可以参考 MDN FileReader。</li>
</ol>
<p>在此基础上，确定此需求的总体开发思路：</p>
<ol>
<li>首先我们需要一个表单，获得海报可变文案的配置信息，例如不同题目考试成绩所对应的评语。</li>
<li>遍历 Excel 中的每一条数据，根据每一条数据和表单的配置信息生成对应海报的 HTML 模板。</li>
<li>根据 HTML 模板生成图片，并将图片数据保存进压缩包的对象中。</li>
<li>Excel 中的数据处理完后，下载压缩包，结束流程。</li>
</ol>
<p>按照这个流程将功能开发完毕后，我在自己的机器上使用100条数据量的 Excel 表格进行测试，可以成功生成对应的压缩包，压缩包中的图片也没有问题，给运营同学演示后，她也表示很满意。</p>
<h2 data-id="heading-1">2 测试问题</h2>
<p>但是当天晚上运营同学在自己的电脑测试这个工具时，悲剧发生了……</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/94fa3e9eee924f10aa0414a02cfedbc5~tplv-k3u1fbpfcp-watermark.image" alt="网页崩溃" loading="lazy" referrerpolicy="no-referrer"></p>
<p>在运营同学的电脑上，使用 15 条 Excel 表格数据生成海报时表现正常，当增加到 20 条 Excel 表格数据时，出现了网页崩溃的情况，提示 Out Of Memory。</p>
<h2 data-id="heading-2">3 分析问题</h2>
<h3 data-id="heading-3">3.1 js内存问题</h3>
<p>现在让我们来一起分析一下，是在哪里出现了问题？</p>
<p>第一波分析发现，最有可能出现问题地方就是步骤 3——最终通过 JSZip 将图片打包进压缩包中。</p>
<p>这里压缩包对象所占用的内存在 Excel 表格数据处理完成并下载之前是不会被释放的，会一直增长。</p>
<p>所以我们有了一个简单的方案——分包。每处理 10 条数据就下载一次压缩包，将 JSZip （压缩包对象）所占用的内存释放。</p>
<p>但是事情真的有这么简单吗？20 张图片的数据以每张 1MB 的大小计算也才 20MB，怎么可能会导致网页崩溃呢？</p>
<p>凭空猜测没什么作用，首先我们<strong>使用浏览器的 Performance 工具进行分析</strong>。</p>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/acd6063e55644e2da9c1b1204e7bb11c~tplv-k3u1fbpfcp-watermark.image" alt="内存增长情况 1.png" loading="lazy" referrerpolicy="no-referrer"></p>
<p>可以看到 JS Heap 在每处理一条 Excel 表格数据后都会增长，没有得到释放，但是这里没有得到释放的内存占用真的是 JSZip 导致的吗？</p>
<p>继续<strong>使用浏览器的 Memory 工具进行分析</strong>。</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3df65b1aa32b4b3c867e3193124b537c~tplv-k3u1fbpfcp-watermark.image" alt="网页内存快照" loading="lazy" referrerpolicy="no-referrer"></p>
<p>可以看到，内存占用确实是一直在涨，没有得到释放，放大其中的一项。</p>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7fa9bbd7132f45ccbe4686141ba257e3~tplv-k3u1fbpfcp-watermark.image" alt="快照详情" loading="lazy" referrerpolicy="no-referrer"></p>
<p>什么？竟然是 <code>system.context</code> ？作为一个前端开发，相信你看到这个词脑子里第一个冒出的念头应该就是上下文。检查代码，发现<strong>代码中使用了递归，所以造成了大量内存的使用</strong>，这里就不展示问题代码了。</p>
<p>将代码修改为循环语句后，再进行测试。</p>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/043d5170e99242c99cc11db016cf0fd7~tplv-k3u1fbpfcp-watermark.image" alt="网页内存增长情况 2" loading="lazy" referrerpolicy="no-referrer"></p>
<p>可以看到内存的增长已经正常。可以让运营同学再次进行测试。</p>
<h3 data-id="heading-4">3.2 DOM 问题</h3>
<p>问题就这样被解决了吗？</p>
<p>信心满满的找到运营同学进行测试，结果出乎意料，运营同学的电脑依然处理不了 40 条以上的 Excel 表格数据，而且在测试中还出现了一个问题，数据处理到某个阶段时，会卡住很久！</p>
<p>事情变得奇怪起来，我们继续进行分析。</p>
<p>造成内存溢出的原因一般有两点，JS 和 DOM。既然 JS 的问题我们已经解决，那我们就看看 DOM。</p>
<p>我们的整体流程中，对 DOM 进行操作的地方有两点:</p>
<ol>
<li>根据 Excel 表格数据生成对应海报的 HTML 模板。</li>
<li>根据 HTML 模板生成图片。</li>
</ol>
<p>第一点应该不存在内存溢出问题，因为我们既没有在 HTML 模版上添加事件，在处理下一条数据时也是直接覆盖上一次生成的HTML 模板，不会导致 DOM 节点不停增加。</p>
<p>继续分析第二点，我使用了第三方库 html2canvas ，由对应的节点生成 canvas 对象，之后由 canvas 对象生成图片的二进制数据。</p>
<p>根据 html2canvas 文档的指引，我设置 <code>removeContainer</code> 属性保留其生成 canvas 对象时所克隆的 DOM 元素并查看</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0c81e7c5c7ef418991dcdd0fa80b6e20~tplv-k3u1fbpfcp-watermark.image" alt="DOM 结构" loading="lazy" referrerpolicy="no-referrer"></p>
<p>结果出乎意料，html2canvas 完整的克隆了我们的 DOM 结构，除目标节点外还克隆了 React 的根结点，script 标签，link 标签。</p>
<p>此时，数据处理慢以及在处理某条数据时卡住的问题就清楚了，由于 html2canvas 完整的克隆了我们的 DOM 结构，不仅复制了很多没用的节点，同时由于克隆了 script 标签，link 标签，还会发起网络请求下载相关的资源。</p>
<p>我们需要把进行操作的节点插入在 body 标签下，根据文档指引，可以使用 html2canvas 提供的<code>ignoreElements</code>属性解决以上问题：</p>
<pre><code class="hljs language-JavaScript copyable" lang="JavaScript"><span class="hljs-keyword">const</span> canvas = <span class="hljs-keyword">await</span> html2canvas(root, &#123;
  <span class="hljs-attr">imageTimeout</span>: <span class="hljs-number">10000</span>,
  <span class="hljs-attr">ignoreElements</span>: <span class="hljs-function">(<span class="hljs-params">ele</span>) =></span> ele.id === <span class="hljs-string">'root'</span> || ele.tagName.toUpperCase() === <span class="hljs-string">'IFRAME'</span> || ele.tagName.toUpperCase() === <span class="hljs-string">'SCRIPT'</span> || ele.tagName.toUpperCase() === <span class="hljs-string">'LINK'</span>,
&#125;);
<span class="copy-code-btn">复制代码</span></code></pre>
<p>通过以上代码，我们将无用的节点和会造成网络请求的标签进行了过滤。</p>
<p>优化过后，再让运营同学进行测试，这时处理一千条数据的 Excel 表格数据也不会再出现网页崩溃的问题了，同时处理速度也大大提升，1000 条数据在 4 分钟内可以处理完毕。</p>
<h2 data-id="heading-5">4 小结</h2>
<p>回到最开始，JSZip 占用的问题依然存在，我们依然需要进行分包，不过分包的大小可以提升到1000条数据。</p>
<p>但是我们可以看到，如果不能找到问题的根本所在，一开始就进行分包也无济于事。</p>
<p>网页显示“喔唷，崩溃啦！”怎么办？请别着急，仔细分析才能解决问题。</p>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b731552c313c40f29653488c63bcfcb8~tplv-k3u1fbpfcp-watermark.image" alt="公众号链接" loading="lazy" referrerpolicy="no-referrer"></p></div>  
</div>
            