
---
title: '_浙里办_项目单点登录、埋点、二次回退的问题'
categories: 
 - 编程
 - 掘金
 - 分类
headimg: 'https://picsum.photos/400/300?random=306'
author: 掘金
comments: false
date: Tue, 27 Jul 2021 00:48:14 GMT
thumbnail: 'https://picsum.photos/400/300?random=306'
---

<div>   
<div class="markdown-body"><style>.markdown-body&#123;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333&#125;.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6&#123;line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px&#125;.markdown-body h1&#123;font-size:30px;margin-bottom:5px&#125;.markdown-body h2&#123;padding-bottom:12px;font-size:24px;border-bottom:1px solid #ececec&#125;.markdown-body h3&#123;font-size:18px;padding-bottom:0&#125;.markdown-body h4&#123;font-size:16px&#125;.markdown-body h5&#123;font-size:15px&#125;.markdown-body h6&#123;margin-top:5px&#125;.markdown-body p&#123;line-height:inherit;margin-top:22px;margin-bottom:22px&#125;.markdown-body img&#123;max-width:100%&#125;.markdown-body hr&#123;border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px&#125;.markdown-body code&#123;word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em&#125;.markdown-body code,.markdown-body pre&#123;font-family:Menlo,Monaco,Consolas,Courier New,monospace&#125;.markdown-body pre&#123;overflow:auto;position:relative;line-height:1.75&#125;.markdown-body pre>code&#123;font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8&#125;.markdown-body a&#123;text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff&#125;.markdown-body a:active,.markdown-body a:hover&#123;color:#275b8c&#125;.markdown-body table&#123;display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6&#125;.markdown-body thead&#123;background:#f6f6f6;color:#000;text-align:left&#125;.markdown-body tr:nth-child(2n)&#123;background-color:#fcfcfc&#125;.markdown-body td,.markdown-body th&#123;padding:12px 7px;line-height:24px&#125;.markdown-body td&#123;min-width:120px&#125;.markdown-body blockquote&#123;color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8&#125;.markdown-body blockquote:after&#123;display:block;content:""&#125;.markdown-body blockquote>p&#123;margin:10px 0&#125;.markdown-body ol,.markdown-body ul&#123;padding-left:28px&#125;.markdown-body ol li,.markdown-body ul li&#123;margin-bottom:0;list-style:inherit&#125;.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item&#123;list-style:none&#125;.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul&#123;margin-top:0&#125;.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul&#123;margin-top:3px&#125;.markdown-body ol li&#123;padding-left:6px&#125;.markdown-body .contains-task-list&#123;padding-left:0&#125;.markdown-body .task-list-item&#123;list-style:none&#125;@media (max-width:720px)&#123;.markdown-body h1&#123;font-size:24px&#125;.markdown-body h2&#123;font-size:20px&#125;.markdown-body h3&#123;font-size:18px&#125;&#125;</style><blockquote>
<p>刚接到这个项目的开始，我还觉得自己一定能很出色的完成这个任务。刚过了几天我就发现事情并不是我想象的那么简单，我要做的事情比我想象的要多好几倍。对于一个没有经验的负责人来说，这无疑是一个坑，当然也是一个挑战。这个项目的难点并不在于它的代码有多难，也不在于业务逻辑有多复杂，而是他的规范太多，审核太严格。
这是一个什么样的项目呢？</p>
</blockquote>
<p>大家可以看一看语雀<a href="https://link.juejin.cn/?target=https%3A%2F%2Fwww.yuque.com%2Fdocs%2Fshare%2F525e3e8a-ad52-421b-90da-2d76808e3050%3F%238WnI6" target="_blank" rel="nofollow noopener noreferrer" title="https://www.yuque.com/docs/share/525e3e8a-ad52-421b-90da-2d76808e3050?#8WnI6" ref="nofollow noopener noreferrer">《“浙里办”h5微应用接入流程》</a>这篇文档。</p>
<p>接下来我将针对大多数人以及我个人遇到的一些问题做本篇文章的核心讲解：</p>
<p>1.单点登录，首先分为个人用户的单点登录和法人用户的单点登录：
个人单点登录分为app登录和支付宝小程序登录：
首先我们要判断当前环境是app环境还是支付宝小程序环境，然后跳转到不同的路径，个人用户登录我们采用的是直接跳转到前端页面，登录成功后会携带ticket等参数跳转到我们提供的路径，</p>
<pre><code class="hljs language-typescript copyable" lang="typescript"> <span class="hljs-keyword">const</span> sUserAgent = <span class="hljs-built_in">window</span>.navigator.userAgent.toLowerCase();
      <span class="hljs-keyword">const</span> bIsDtDreamApp = sUserAgent.indexOf(<span class="hljs-string">"dtdreamweb"</span>) > -<span class="hljs-number">1</span>; <span class="hljs-comment">// 浙里办APP</span>
      <span class="hljs-keyword">const</span> bIsAlipayMini =
        sUserAgent.indexOf(<span class="hljs-string">"miniprogram"</span>) > -<span class="hljs-number">1</span> &&
        sUserAgent.indexOf(<span class="hljs-string">"alipay"</span>) > -<span class="hljs-number">1</span>;
      <span class="hljs-keyword">if</span> (bIsAlipayMini) &#123;
        <span class="hljs-built_in">window</span>.location.href =
          <span class="hljs-string">"https://puser.zjzwfw.gov.cn/sso/alipay.do?action=ssoLogin&scope=1&servicecode="</span>接入码<span class="hljs-string">"&go=https://mapi.zjzwfw.gov.cn/web/***/index.html?debug=true"</span>;
      &#125; <span class="hljs-keyword">else</span> &#123;
        <span class="hljs-built_in">window</span>.location.href =
          <span class="hljs-string">"https://puser.zjzwfw.gov.cn/sso/mobile.do?action=oauth&scope=1&servicecode="</span>接入码<span class="hljs-string">"&go=https://mapi.zjzwfw.gov.cn/web/***/index.html?debug=true"</span>;
      &#125;
<span class="copy-code-btn">复制代码</span></code></pre>
<p>法人的单点登录（app和小程序是一样的）：
由于法人登录跳转到页面时，用的是post请求访问，但是web页面只能通过get访问，所以法人登录我们采用的方法是将提供的跳转路径为后台服务地址，后台服务将登录成功后通过get方式重定向到前端页面并携带前端需要的参数，</p>
<pre><code class="hljs language-typescript copyable" lang="typescript"><span class="hljs-built_in">window</span>.location.href =<span class="hljs-string">"http://essotest.zjzwfw.gov.cn/opensso/spsaehandler/metaAlias/sp?spappurl=http://192.168.8.37:8081/login?goto=https://mapi.zjzwfw.gov.cn/web/mgop/***/index.html?debug=true"</span>;
<span class="copy-code-btn">复制代码</span></code></pre>
<p>2.二次回退的问题：
我发现大多数人都遇到了二次回退的问题，有很多人解决了二次回退的问题后又出现了其它各种奇奇怪怪的问题，以下是我们解决这个问题的办法：
<code>window.performance.navigation.type</code>包含三个值：
<code>0 : TYPE_NAVIGATE</code> (用户通过常规导航方式访问页面，比如点一个链接，或者一般的get方式)
<code>1 : TYPE_RELOAD</code> (用户通过刷新，包括JS调用刷新接口等方式访问页面)
<code>2 : TYPE_BACK_FORWARD</code> (用户通过后退按钮访问本页面)
首先还是判断是浙里办app还是支付宝小程序,根据不同的环境处理二次回退</p>
<pre><code class="hljs language-typescript copyable" lang="typescript"> <span class="hljs-keyword">const</span> sUserAgent = <span class="hljs-built_in">window</span>.navigator.userAgent.toLowerCase();
    <span class="hljs-keyword">const</span> bIsDtDreamApp = sUserAgent.indexOf(<span class="hljs-string">"dtdreamweb"</span>) > -<span class="hljs-number">1</span>; <span class="hljs-comment">// 浙里办APP</span>
    <span class="hljs-keyword">const</span> bIsAlipayMini =
      sUserAgent.indexOf(<span class="hljs-string">"miniprogram"</span>) > -<span class="hljs-number">1</span> &&
      sUserAgent.indexOf(<span class="hljs-string">"alipay"</span>) > -<span class="hljs-number">1</span>;
    <span class="hljs-keyword">if</span> (bIsDtDreamApp) &#123;
      that.watchApp();
    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (bIsAlipayMini) &#123;
      that.watchApply();
    &#125;
<span class="copy-code-btn">复制代码</span></code></pre>
<p>解决app的二次回退问题，这个地方的逻辑是监听页面的跳转,判断当前页面是通过刷新或直接访问进入，还是通过返回进入。从而来判断是否是直接跳回app</p>
<pre><code class="hljs language-typescript copyable" lang="typescript">   <span class="hljs-function"><span class="hljs-title">watchApp</span>(<span class="hljs-params"></span>)</span> &#123;
      <span class="hljs-keyword">var</span> that = <span class="hljs-built_in">this</span>;
      <span class="hljs-built_in">window</span>.addEventListener(
        <span class="hljs-string">"pageshow"</span>,
        <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">event</span>) </span>&#123;
          <span class="hljs-keyword">if</span> (
            event.persisted ||
            (<span class="hljs-built_in">window</span>.performance && <span class="hljs-built_in">window</span>.performance.navigation.type == <span class="hljs-number">2</span>)
          ) &#123;
            ZWJSBridge.close()<span class="hljs-comment">//这个是浙里办内部的api，调用close()接口关闭通过openLink打开的页面</span>
              .then(<span class="hljs-function">(<span class="hljs-params">result</span>) =></span> &#123;
                <span class="hljs-built_in">console</span>.log(result);
              &#125;)
              .catch(<span class="hljs-function">(<span class="hljs-params">error</span>) =></span> &#123;
                <span class="hljs-built_in">console</span>.log(error);
              &#125;);
          &#125;
          that.isLoad();
        &#125;,
        <span class="hljs-literal">false</span>
      );
    &#125;,
<span class="copy-code-btn">复制代码</span></code></pre>
<p>解决支付宝小程序的二次回退问题，这个地方的逻辑是监听页面的跳转,判断当前页面是通过刷新或直接访问进入，还是通过返回进入。从而来判断是否是直接跳回浙里办小程序页面。</p>
<pre><code class="hljs language-typescript copyable" lang="typescript"> <span class="hljs-function"><span class="hljs-title">watchApply</span>(<span class="hljs-params"></span>)</span> &#123;
      <span class="hljs-keyword">var</span> that = <span class="hljs-built_in">this</span>;
      <span class="hljs-built_in">window</span>.addEventListener(
        <span class="hljs-string">"pageshow"</span>,
        <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">event</span>) </span>&#123;
          <span class="hljs-keyword">if</span> (
            event.persisted ||
            (<span class="hljs-built_in">window</span>.performance &&
              (<span class="hljs-built_in">window</span>.performance.navigation.type == <span class="hljs-number">1</span> ||
                <span class="hljs-built_in">window</span>.performance.navigation.type == <span class="hljs-number">0</span>))
          ) &#123;
            that.isLoad();
          &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (
            event.persisted ||
            (<span class="hljs-built_in">window</span>.performance && <span class="hljs-built_in">window</span>.performance.navigation.type == <span class="hljs-number">2</span>)
          ) &#123;
            my.navigateBack();
          &#125; <span class="hljs-keyword">else</span> &#123;
            my.navigateBack();<span class="hljs-comment">//支付宝小程序的api，需在index.html引入，通过此api直接跳回浙里办小程序页面</span>
          &#125;
        &#125;,
        <span class="hljs-literal">false</span>
      );
    &#125;,
<span class="copy-code-btn">复制代码</span></code></pre>
<p>3.埋点，由于有些埋点是通过JSBridge API 获取的，而JSBridge API 的方法都是异步的，所以可能会存在埋点不成功的问题。：
埋点主要是采集应用app的信息,日志，用户信息和地理位置等信息
web 端通用采集 SDK：<code>https://d.alicdn.com/alilog/mlog/aplus.js?id=202951085</code>
使用vue开发的，这一段要写在埋点页面的script里面，尽量不要放在vue实例中，也不要放在index.html中，否则可能会存在埋点不成功的问题</p>
<pre><code class="hljs language-typescript copyable" lang="typescript">  <script> (<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">w, d, s, q, i</span>) </span>&#123; w[q] = w[q] || [];
 <span class="hljs-keyword">var</span> f = d.getElementsByTagName(s)[<span class="hljs-number">0</span>],j = d.createElement(s);
 j.async = <span class="hljs-literal">true</span>;
 j.id = <span class="hljs-string">'beacon-aplus'</span>;
 j.src = <span class="hljs-string">'https://d.alicdn.com/alilog/mlog/aplus.js?id=202951085'</span>; 
f.parentNode.insertBefore(j, f); &#125;)(<span class="hljs-built_in">window</span>, <span class="hljs-built_in">document</span>, <span class="hljs-string">'script'</span>, <span class="hljs-string">'aplus_queue'</span>); 

aplus_queue.push(&#123; <span class="hljs-attr">action</span>: <span class="hljs-string">'aplus.setMetaInfo'</span>, <span class="hljs-attr">arguments</span>: [<span class="hljs-string">'aplus-rhost-v'</span>, <span class="hljs-string">'alog.zjzwfw.gov.cn'</span>] &#125;); 
aplus_queue.push(&#123; <span class="hljs-attr">action</span>: <span class="hljs-string">'aplus.setMetaInfo'</span>, <span class="hljs-attr">arguments</span>: [<span class="hljs-string">'aplus-rhost-g'</span>, <span class="hljs-string">'alog.zjzwfw.gov.cn'</span>] &#125;); 

aplus_queue.push(&#123; <span class="hljs-attr">action</span>: <span class="hljs-string">'aplus.setMetaInfo'</span>,
<span class="hljs-attr">arguments</span>: [<span class="hljs-string">'appId'</span>, <span class="hljs-string">'60506758'</span>] &#125;); </script>
<span class="copy-code-btn">复制代码</span></code></pre></div>  
</div>
            