
---
title: '小程序基础-自定义日历组件'
categories: 
 - 编程
 - 掘金
 - 分类
headimg: 'https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2f307bb80a5d43208b0f73de925b4b03~tplv-k3u1fbpfcp-watermark.image'
author: 掘金
comments: false
date: Mon, 16 Aug 2021 19:16:48 GMT
thumbnail: 'https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2f307bb80a5d43208b0f73de925b4b03~tplv-k3u1fbpfcp-watermark.image'
---

<div>   
<div class="markdown-body"><style>.markdown-body&#123;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333&#125;.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6&#123;line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px&#125;.markdown-body h1&#123;font-size:30px;margin-bottom:5px&#125;.markdown-body h2&#123;padding-bottom:12px;font-size:24px;border-bottom:1px solid #ececec&#125;.markdown-body h3&#123;font-size:18px;padding-bottom:0&#125;.markdown-body h4&#123;font-size:16px&#125;.markdown-body h5&#123;font-size:15px&#125;.markdown-body h6&#123;margin-top:5px&#125;.markdown-body p&#123;line-height:inherit;margin-top:22px;margin-bottom:22px&#125;.markdown-body img&#123;max-width:100%&#125;.markdown-body hr&#123;border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px&#125;.markdown-body code&#123;word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em&#125;.markdown-body code,.markdown-body pre&#123;font-family:Menlo,Monaco,Consolas,Courier New,monospace&#125;.markdown-body pre&#123;overflow:auto;position:relative;line-height:1.75&#125;.markdown-body pre>code&#123;font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8&#125;.markdown-body a&#123;text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff&#125;.markdown-body a:active,.markdown-body a:hover&#123;color:#275b8c&#125;.markdown-body table&#123;display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6&#125;.markdown-body thead&#123;background:#f6f6f6;color:#000;text-align:left&#125;.markdown-body tr:nth-child(2n)&#123;background-color:#fcfcfc&#125;.markdown-body td,.markdown-body th&#123;padding:12px 7px;line-height:24px&#125;.markdown-body td&#123;min-width:120px&#125;.markdown-body blockquote&#123;color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8&#125;.markdown-body blockquote:after&#123;display:block;content:""&#125;.markdown-body blockquote>p&#123;margin:10px 0&#125;.markdown-body ol,.markdown-body ul&#123;padding-left:28px&#125;.markdown-body ol li,.markdown-body ul li&#123;margin-bottom:0;list-style:inherit&#125;.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item&#123;list-style:none&#125;.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul&#123;margin-top:0&#125;.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul&#123;margin-top:3px&#125;.markdown-body ol li&#123;padding-left:6px&#125;.markdown-body .contains-task-list&#123;padding-left:0&#125;.markdown-body .task-list-item&#123;list-style:none&#125;@media (max-width:720px)&#123;.markdown-body h1&#123;font-size:24px&#125;.markdown-body h2&#123;font-size:20px&#125;.markdown-body h3&#123;font-size:18px&#125;&#125;</style><p>这是我参与8月更文挑战的第2天，活动详情查看：<a href="https://juejin.cn/post/6987962113788493831" title="https://juejin.cn/post/6987962113788493831" target="_blank">8月更文挑战</a></p>
<blockquote>
<p>如下图要实现如下的日历，可以切换月份，默认显示当前月，有事件的日期下面有一个小点，今天之前的日期不可选，小点是灰色的，今天之后的日期可以选择。</p>
</blockquote>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2f307bb80a5d43208b0f73de925b4b03~tplv-k3u1fbpfcp-watermark.image" alt="1.png" loading="lazy" referrerpolicy="no-referrer"></p>
<blockquote>
<p>原本想直接用vant的van-calendar的，但是完全不符合需要，无奈只能自己动手了，代码比较冗余，自己记录一下，温故而知新！</p>
</blockquote>
<h3 data-id="heading-0">1.月份日历渲染</h3>
<ul>
<li>父组件的wxml</li>
</ul>
<pre><code class="copyable"><van-popup show="&#123;&#123; show &#125;&#125;" round position="bottom" custom-style="height: 55%" bind:close="onClose" closeable>
    <the-calendar bindonCalendarClose="onCalendarClose"></the-calendar>
</van-popup>
<span class="copy-code-btn">复制代码</span></code></pre>
<ul>
<li>日历组件的wxml</li>
</ul>
<pre><code class="copyable"><view class="calendar-container">
    <view class="top-title">
        <text class="fs16 black">测试时间</text>
    </view>
    <view class="choose-month">
        <view class="month-left">
            <view class="left-par">
                <text class="iconfont iconxiangyou" bindtap="chooseMonth" data-state="-1"></text>
            </view>
            <text class="title">&#123;&#123;year&#125;&#125;年&#123;&#123;month&#125;&#125;月</text>
            <view class="right-par">
                <text class="iconfont icongengduo" bindtap="chooseMonth" data-state="1"></text>
            </view>
        </view>
    </view>
    <view class="days-area">
        <view class="day week black-65 fs12" wx:for="&#123;&#123;weeks&#125;&#125;" wx:key="index">&#123;&#123;item&#125;&#125;</view>
        <view wx:for="&#123;&#123;days&#125;&#125;" wx:key="index" wx:for-item="day"
            class="day day-time fs12 &#123;&#123;day.chooseDay?'choose-day' : ''&#125;&#125; &#123;&#123;day.className&#125;&#125; &#123;&#123;day.event?'day-event':''&#125;&#125;"
            bindtap="chooseThisDay" data-year="&#123;&#123;day.year&#125;&#125;" data-month="&#123;&#123;day.month&#125;&#125;"
            data-gregorian="&#123;&#123;day.gregorian&#125;&#125;" data-className="&#123;&#123;day.className&#125;&#125;">&#123;&#123;day.title&#125;&#125;</view>
    </view>
</view>
<span class="copy-code-btn">复制代码</span></code></pre>
<h3 data-id="heading-1">2.日历事件渲染</h3>
<pre><code class="copyable">// 获取当前月份所有日期
getDays() &#123;
    this.data.days = [];
    const day = new Date();
    day.setFullYear(this.data.year, this.data.month - 1, 1); // 获取当月第一天(月份减1)
    const month = new Date();
    month.setFullYear(this.data.year, this.data.month, 0); // 获取当月最后一天
    const prevMonth = new Date();
    prevMonth.setFullYear(this.data.year, this.data.month - 1, 0); // 获取上月
    let prevDay = prevMonth.getDate(); // 上月的日期
    let nextMonth = new Date();
    nextMonth = new Date(this.data.year, this.data.month, 0); // 下月的日期
    let nextDay = nextMonth.getDay(); // 最后一天星期几
    for (let i = day.getDay() + 1; i > 1; i--) &#123; // 当月第一天距离所在周周一（+1周日）的空白占位
        let prevM = this.data.month - 1,
            prevYear = this.data.year;
        if (prevM < 1) &#123;
            prevM = 12;
            prevYear = prevYear - 1
        &#125;
        this.data.days.unshift(&#123;
            year: prevYear,
            month: prevM,
            title: prevDay,
            gregorian: prevDay,
            className: 'grey'
        &#125;)
        prevDay--;
    &#125;
    for (let i = 1; i <= month.getDate(); i++) &#123; // 获取当月天数填充日历
        let title = i;
        if (this.data.year === this.data.yearNow && this.data.month === this.data.monthNow && this.data.todayNow === i) &#123;
            title = '今';
        &#125; ;
        this.data.days.push(&#123;
            year: this.data.year,
            month: this.data.month,
            title: title,
            gregorian: i,
            className: 'grey'
        &#125;)
    &#125;
    let j = 0,
        nextM = this.data.month + 1,
        nextY = this.data.year;
    if (nextM > 12) &#123;
        nextM = 1;
        nextY = nextY + 1;
    &#125;
    for (let i = nextDay + 1; i < 7; i++) &#123; // 当月最后一天距离所在周周六的空白占位
        j++;
        this.data.days.push(&#123;
            year: nextY,
            month: nextM,
            title: j,
            gregorian: j,
            className: 'grey'
        &#125;)
        nextDay++;
    &#125;
    // 日期的选中效果
    this.data.days.forEach((itemD) => &#123;
        if (this.data.chooseDate.year === itemD.year && this.data.chooseDate.month === itemD.month && this.data.chooseDate.gregorian === itemD.gregorian) &#123;
            itemD.chooseDay = true;
        &#125;
    &#125;)
    this.setData(&#123;
        days: this.data.days
    &#125;)
&#125;,
// 改变年份
chooseYears(state) &#123;
    this.setData(&#123;
        year: this.data.year += state
    &#125;)
    this.getDays();
    this.getEventsList('change-month'); // 获取事件
&#125;,
// 改变月份
chooseMonth(event) &#123;
    let state = event.currentTarget.dataset.state;
    this.setData(&#123;
        month: this.data.month += Number(state)
    &#125;)
    // 月份 年份变化
    if (this.data.month < 1) &#123;
        this.setData(&#123;
            month: 12
        &#125;)
        this.chooseYears(-1)
    &#125; else if (this.data.month > 12) &#123;
        this.setData(&#123;
            month: 1
        &#125;)
        this.chooseYears(1);
    &#125; else &#123;
        this.getDays();
    &#125;
    this.getEventsList('change-month'); //月事件
&#125;,
<span class="copy-code-btn">复制代码</span></code></pre>
<h3 data-id="heading-2">3.以今天为分界，渲染事件</h3>
<pre><code class="copyable">// 获取月事件
getEventsList(flag) &#123;
    let obj = &#123;
        starDate: this.data.starDate,
        endDate: this.data.endDate,
        resId: this.data.resId,
    &#125;
    $post(getCalendarBoardByResId, obj).then(res => &#123;
        this.getEventData(res);
    &#125;)
&#125;,
// 处理事件数据结构
getEventData(newData) &#123;
    let nowDate = new Date().getTime() - 8.64e7;
    if (newData.length > 0) &#123;
        newData.forEach((itemN) => &#123;
            this.data.days.forEach((itemD) => &#123;
                if (itemN.year === itemD.year &&
                    itemN.month === itemD.month &&
                    itemN.day === itemD.gregorian
                ) &#123;
                    itemD.event = true;
                    let thisDate = new Date(itemD.year + '-' + this.addZero(itemD.month) + '-' + this.addZero(itemD.gregorian)).getTime();
                    if (thisDate >= nowDate) &#123; // 今天以后的日期可点击
                        itemD.className = '';
                    &#125;
                &#125;
            &#125;)
        &#125;)
    &#125; else &#123;
        this.data.days.forEach((itemD) => &#123;
            itemD.event = false;
        &#125;)
    &#125;
    this.setData(&#123;
        days: this.data.days
    &#125;)
&#125;,
<span class="copy-code-btn">复制代码</span></code></pre>
<h3 data-id="heading-3">4.日期的点击事件</h3>
<pre><code class="copyable">// 选择某天 
chooseThisDay(e) &#123;
    // 点击今天之前的日期 不可点击
    if (e.currentTarget && e.currentTarget.dataset && e.currentTarget.dataset.classname == 'grey') &#123;
        return;
    &#125;
    let day = e.currentTarget.dataset;
    let flag = 0;
    this.data.days.forEach((itemD) => &#123;
        itemD.chooseDay = false;
        if (day.year === itemD.year && day.month === itemD.month && day.gregorian === itemD.gregorian) &#123;
            if (itemD.className === 'grey') &#123;
                flag++;
            &#125; else &#123;
                itemD.chooseDay = true; // 选中
            &#125;
        &#125;
        if (this.data.yearNow === itemD.year && this.data.monthNow === itemD.month && this.data.todayNow === itemD.gregorian) &#123;
            itemD.isToday = true; // 今天
        &#125;
    &#125;)
    if (flag > 0) &#123;
        return false;
    &#125;
 
    this.setData(&#123;
        today: day.gregorian,
        chooseDate: &#123;
            year: day.year,
            month: day.month,
            gregorian: day.gregorian
        &#125;,
        days: this.data.days
    &#125;)
    // 父级回调
    this.triggerEvent('onCalendarClose', &#123;
        year: day.year,
        month: day.month,
        gregorian: day.gregorian
    &#125;);
&#125;,
<span class="copy-code-btn">复制代码</span></code></pre>
<blockquote>
<p>好了，以上就是日历组件的全部代码啦。感谢观看！</p>
</blockquote></div>  
</div>
            