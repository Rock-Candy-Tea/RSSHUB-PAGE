
---
title: 'h5下拉刷新实现'
categories: 
 - 编程
 - 掘金
 - 分类
headimg: 'https://picsum.photos/400/300?random=5755'
author: 掘金
comments: false
date: Mon, 30 Aug 2021 04:17:16 GMT
thumbnail: 'https://picsum.photos/400/300?random=5755'
---

<div>   
<div class="markdown-body html cache"><style>.markdown-body&#123;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333&#125;.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6&#123;line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px&#125;.markdown-body h1&#123;font-size:30px;margin-bottom:5px&#125;.markdown-body h2&#123;padding-bottom:12px;font-size:24px;border-bottom:1px solid #ececec&#125;.markdown-body h3&#123;font-size:18px;padding-bottom:0&#125;.markdown-body h4&#123;font-size:16px&#125;.markdown-body h5&#123;font-size:15px&#125;.markdown-body h6&#123;margin-top:5px&#125;.markdown-body p&#123;line-height:inherit;margin-top:22px;margin-bottom:22px&#125;.markdown-body img&#123;max-width:100%&#125;.markdown-body hr&#123;border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px&#125;.markdown-body code&#123;word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em&#125;.markdown-body code,.markdown-body pre&#123;font-family:Menlo,Monaco,Consolas,Courier New,monospace&#125;.markdown-body pre&#123;overflow:auto;position:relative;line-height:1.75&#125;.markdown-body pre>code&#123;font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8&#125;.markdown-body a&#123;text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff&#125;.markdown-body a:active,.markdown-body a:hover&#123;color:#275b8c&#125;.markdown-body table&#123;display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6&#125;.markdown-body thead&#123;background:#f6f6f6;color:#000;text-align:left&#125;.markdown-body tr:nth-child(2n)&#123;background-color:#fcfcfc&#125;.markdown-body td,.markdown-body th&#123;padding:12px 7px;line-height:24px&#125;.markdown-body td&#123;min-width:120px&#125;.markdown-body blockquote&#123;color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8&#125;.markdown-body blockquote:after&#123;display:block;content:""&#125;.markdown-body blockquote>p&#123;margin:10px 0&#125;.markdown-body ol,.markdown-body ul&#123;padding-left:28px&#125;.markdown-body ol li,.markdown-body ul li&#123;margin-bottom:0;list-style:inherit&#125;.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item&#123;list-style:none&#125;.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul&#123;margin-top:0&#125;.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul&#123;margin-top:3px&#125;.markdown-body ol li&#123;padding-left:6px&#125;.markdown-body .contains-task-list&#123;padding-left:0&#125;.markdown-body .task-list-item&#123;list-style:none&#125;@media (max-width:720px)&#123;.markdown-body h1&#123;font-size:24px&#125;.markdown-body h2&#123;font-size:20px&#125;.markdown-body h3&#123;font-size:18px&#125;&#125;</style><h4 data-id="heading-0">前言</h4>
<hr>
<p>混合开发是我们经常使用的开发模式，快节奏的时代，app的发版流程缓慢为h5带来了更多的可能，带在体验上来说，h5还是有很长的路要走。那么今天我们就来看一个场景，下拉刷新操作，在app里面可以说是很常见的功能，但在h5中经常被忽略，那么今天就手写一个h5下拉刷新，让h5体验距离app更近一步。<br>
<a href="https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Fxiaowei-bo%2FpullRefresh" target="_blank" rel="nofollow noopener noreferrer" title="https://github.com/xiaowei-bo/pullRefresh" ref="nofollow noopener noreferrer">git仓库</a></p>
<h4 data-id="heading-1">操作</h4>
<hr>
<p>用户下拉 |---->> 无效下拉 ---->> 自动回弹<br>
用户下拉 |---->> 有效下拉 ---->> 触发回调方法（刷接口/刷页面）---->> 自动回弹</p>
<h4 data-id="heading-2">实现</h4>
<hr>
<p>主要通过监听touch事件获取手指滑动轨迹，并实时改变 translate 达到页面滑动效果，增加阻尼概念让下拉操作更加真实，结束时判断是否有效下拉来执行对应方法</p>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">/**
 * <span class="hljs-doctag">@param <span class="hljs-type">&#123;Function&#125;</span><span class="hljs-variable">pullCallback</span></span>
 * 下拉回调，不传默认为 reload();
 * 有效下拉：指页面被下拉至文档顶部离开视口顶部
 * 暂不支持 微信等 q系浏览器
 * @使用方法
 *     const pullObj = pullRefresh(() => &#123;
 *         // 刷数据接口
 *         // 刷新完成之后调用 pullObj.finish(); 顶部刷新区归位
 *     &#125;);
 *     pullObj.init(); 初始化
 */</span>

<span class="hljs-keyword">export</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">pullRefresh</span>(<span class="hljs-params">pullCallback</span>) </span>&#123;
    <span class="hljs-keyword">const</span> body = <span class="hljs-built_in">document</span>.body;
    <span class="hljs-keyword">const</span> app = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">'app'</span>);
    <span class="hljs-keyword">const</span> app_style_cache = app.style;
    <span class="hljs-keyword">const</span> pullTextEl = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">'p'</span>);

    pullTextEl.style = <span class="hljs-string">"width: 100%; text-align: center; position: fixed; z-index: -1; left: 0; top: 0; font-size: 12px; line-height: 40px; color: #999; display: none;"</span>;
    <span class="hljs-keyword">const</span> loadText = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">'span'</span>);
    <span class="hljs-comment">// 是否执行有效下拉回调标志位</span>
    <span class="hljs-keyword">let</span> refreshStatus = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">const</span> isQBrowser = <span class="hljs-function">() =></span> &#123; <span class="hljs-comment">// qq系浏览器</span>
        <span class="hljs-keyword">const</span> ua = navigator.userAgent.toLowerCase();
        <span class="hljs-keyword">return</span> !!ua.match(<span class="hljs-regexp">/mqqbrowser|qzone|qqbrowser/i</span>);
    &#125;;
    <span class="hljs-keyword">const</span> finish = <span class="hljs-function">() =></span> &#123;
        <span class="hljs-keyword">if</span>(isQBrowser()) <span class="hljs-keyword">return</span>;
        loadText.innerText = <span class="hljs-string">'刷新成功'</span>;
        <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =></span> &#123;
            app.style[<span class="hljs-string">'transition'</span>] = <span class="hljs-string">'transform 0.2s'</span>;
            app.style[<span class="hljs-string">'transform'</span>] = <span class="hljs-string">'translate(0, 0)'</span>;
            <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =></span> &#123;
                pullTextEl.style[<span class="hljs-string">'display'</span>] = <span class="hljs-string">'none'</span>;
                app.style = app_style_cache;
            &#125;, <span class="hljs-number">400</span>);
        &#125;, <span class="hljs-number">500</span>);
    &#125;;
    <span class="hljs-keyword">const</span> init = <span class="hljs-function">() =></span> &#123;
        <span class="hljs-keyword">if</span>(isQBrowser()) <span class="hljs-keyword">return</span>;
        body.appendChild(pullTextEl);
        pullTextEl.appendChild(loadText);
        <span class="hljs-keyword">let</span> startP, moveLen;
        <span class="hljs-comment">// 默认有效下拉回调</span>
        <span class="hljs-keyword">const</span> _pullCallback = <span class="hljs-function">() =></span> &#123;
            <span class="hljs-built_in">window</span>.location.reload();
        &#125;;
        <span class="hljs-comment">// 下拉处理</span>
        <span class="hljs-keyword">const</span> _pullHandler = <span class="hljs-function">(<span class="hljs-params">moveLen</span>) =></span> &#123;
            <span class="hljs-comment">// 下拉元素距离视口顶部距离</span>
            <span class="hljs-keyword">const</span> top_distance = app.getBoundingClientRect().top;
            <span class="hljs-comment">// 有效下拉才做处理</span>
            <span class="hljs-keyword">if</span>(top_distance >= <span class="hljs-number">0</span>) &#123;
                <span class="hljs-keyword">if</span>(pullTextEl.style[<span class="hljs-string">'display'</span>] === <span class="hljs-string">'none'</span>) &#123;
                    <span class="hljs-comment">// 有效下拉时才展示提示文案</span>
                    pullTextEl.style[<span class="hljs-string">'display'</span>] = <span class="hljs-string">'block'</span>;
                &#125;
                <span class="hljs-comment">// 下拉效果</span>
                <span class="hljs-keyword">if</span>(moveLen > <span class="hljs-number">0</span> && moveLen < <span class="hljs-number">50</span>)&#123;
                    app.style[<span class="hljs-string">'transform'</span>] = <span class="hljs-string">'translate(0, '</span> + moveLen + <span class="hljs-string">'px)'</span>;
                &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(moveLen >= <span class="hljs-number">50</span> && moveLen < <span class="hljs-number">100</span>) &#123; <span class="hljs-comment">// 到刷新标志，下拉阻尼增大</span>
                    <span class="hljs-keyword">const</span> _moveLen = <span class="hljs-number">50</span> + (moveLen - <span class="hljs-number">50</span>) * <span class="hljs-number">0.6</span>;
                    app.style[<span class="hljs-string">'transform'</span>] = <span class="hljs-string">'translate(0, '</span> + _moveLen + <span class="hljs-string">'px)'</span>;
                &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(moveLen >= <span class="hljs-number">100</span>) &#123; <span class="hljs-comment">// 下拉超过 100，下拉阻尼再次增大</span>
                    <span class="hljs-keyword">const</span> _moveLen = <span class="hljs-number">80</span> + (moveLen - <span class="hljs-number">100</span>) * <span class="hljs-number">0.2</span>;
                    app.style[<span class="hljs-string">'transform'</span>] = <span class="hljs-string">'translate(0, '</span> + _moveLen + <span class="hljs-string">'px)'</span>;
                &#125;
                <span class="hljs-comment">// 下拉触发</span>
                <span class="hljs-keyword">if</span>(top_distance < <span class="hljs-number">50</span>) &#123;
                    loadText.innerText = <span class="hljs-string">'下拉即可刷新...'</span>;
                    refreshStatus = <span class="hljs-literal">false</span>;
                &#125; <span class="hljs-keyword">else</span> &#123;
                    loadText.innerText = <span class="hljs-string">'松开立即刷新...'</span>;
                    refreshStatus = <span class="hljs-literal">true</span>;
                &#125;
            &#125;
        &#125;;
        app.addEventListener(<span class="hljs-string">'touchstart'</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =></span> &#123;
            startP = e.touches[<span class="hljs-number">0</span>].pageY;
            app.style[<span class="hljs-string">'transition'</span>] = <span class="hljs-string">'transform 0s'</span>;
        &#125;);
        app.addEventListener(<span class="hljs-string">'touchmove'</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =></span> &#123;
            moveLen = e.touches[<span class="hljs-number">0</span>].pageY - startP;
            _pullHandler(moveLen);
        &#125;);
        app.addEventListener(<span class="hljs-string">'touchend'</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =></span> &#123;
            <span class="hljs-comment">// 下拉元素距离视口顶部距离</span>
            <span class="hljs-keyword">const</span> top_distance = app.getBoundingClientRect().top;
            <span class="hljs-keyword">if</span>(top_distance > <span class="hljs-number">0</span>) &#123; <span class="hljs-comment">// 当有效下拉发生后动画归位，重置样式</span>
                <span class="hljs-keyword">if</span>(refreshStatus) &#123;
                    loadText.innerText = <span class="hljs-string">'数据加载中...'</span>;
                    pullCallback ? pullCallback() : _pullCallback();
                    app.style[<span class="hljs-string">'transition'</span>] = <span class="hljs-string">'transform 0.4s'</span>;
                    app.style[<span class="hljs-string">'transform'</span>] = <span class="hljs-string">'translate(0, 40px)'</span>;
                &#125; <span class="hljs-keyword">else</span> &#123;
                    app.style[<span class="hljs-string">'transition'</span>] = <span class="hljs-string">'transform 0.4s'</span>;
                    app.style[<span class="hljs-string">'transform'</span>] = <span class="hljs-string">'translate(0, 0)'</span>;
                    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =></span> &#123;
                        pullTextEl.style[<span class="hljs-string">'display'</span>] = <span class="hljs-string">'none'</span>;
                        app.style = app_style_cache;
                    &#125;, <span class="hljs-number">400</span>);
                &#125;
            &#125; <span class="hljs-keyword">else</span> &#123; <span class="hljs-comment">// 未发生有效下拉的直接重置样式</span>
                pullTextEl.style[<span class="hljs-string">'display'</span>] = <span class="hljs-string">'none'</span>;
                app.style = app_style_cache;
            &#125;
        &#125;)
    &#125;;
    <span class="hljs-keyword">return</span> &#123;
        init,
        finish
    &#125;
&#125;

<span class="copy-code-btn">复制代码</span></code></pre>
<h4 data-id="heading-3">如何使用</h4>
<hr>
<p>es6 下直接 import 引用 pullRefresh_es6.js 文件即可<br>
其他情况可引用 pullRefresh.js 或 pullRefresh.min.js 文件，直接使用 window 全局变量 pullRefresh，或通过 require 方式引用上述文件</p>
<pre><code class="hljs language-js copyable" lang="js">具体使用：  
配置  
<span class="hljs-keyword">var</span> pullObj = pullRefresh(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>&#123;  
    <span class="hljs-comment">// 下拉回调处理 your code  </span>
    handler();  
    <span class="hljs-comment">// 结束  </span>
    pullObj.finish();  
&#125;);  
初始化  
pullObj.init();  
<span class="copy-code-btn">复制代码</span></code></pre>
<h4 data-id="heading-4">结语</h4>
<hr>
<p>用户体验是每一位前端人都应该注意的，我们是距离用户最近的一层，每一个细节，每一次交互，都会影响着用户对我们自己产品的态度，想要得到用户，就得给有’看似扭捏，实则拿捏‘的实力和态度<br>
致敬每一位前端coder；Respect；</p></div>  
</div>
            