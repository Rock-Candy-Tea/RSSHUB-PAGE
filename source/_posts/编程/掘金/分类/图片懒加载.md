
---
title: '图片懒加载'
categories: 
 - 编程
 - 掘金
 - 分类
headimg: 'https://juejin.cn/post/undefined'
author: 掘金
comments: false
date: Thu, 15 Apr 2021 02:05:03 GMT
thumbnail: 'https://juejin.cn/post/undefined'
---

<div>   
<div class="markdown-body"><style>.markdown-body&#123;color:#383838;font-size:15px;line-height:37.5px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:120px&#125;.markdown-body ::selection&#123;color:#fff;background-color:#a862ea&#125;.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6&#123;margin:30px 0 15px;color:#a862ea&#125;.markdown-body h1&#123;line-height:2;font-size:1.4em&#125;.markdown-body h1~p:first-of-type:first-letter&#123;color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder&#125;.markdown-body h2&#123;font-size:1.2em&#125;.markdown-body h3&#123;font-size:1.1em&#125;.markdown-body ol,.markdown-body ul&#123;padding-left:2em&#125;.markdown-body ol li,.markdown-body ul li&#123;margin-bottom:0;padding-left:.2em&#125;.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item&#123;list-style:none&#125;.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul&#123;margin-top:0&#125;.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul&#123;margin-top:10px&#125;.markdown-body li::marker&#123;color:#a862ea&#125;.markdown-body li,.markdown-body p&#123;opacity:.9;vertical-align:baseline;transition:all .1s ease&#125;.markdown-body li:hover,.markdown-body p:hover&#123;opacity:1&#125;.markdown-body a&#123;display:inline-block;color:#a862ea;cursor:pointer;padding-bottom:2px;text-decoration:none;position:relative&#125;.markdown-body a:after&#123;content:"";position:absolute;width:98%;height:2px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out&#125;.markdown-body a:hover:after&#123;transform:scaleX(1);transform-origin:bottom left&#125;.markdown-body a:active,.markdown-body a:link&#123;color:#a862ea&#125;.markdown-body img&#123;max-width:100%;user-select:none;margin:1em 0;box-shadow:0 0 20px 0 #e7daff;transition:transform .2s ease 0s;background-color:#f8f5ff&#125;.markdown-body img:hover&#123;opacity:1;transform:translateY(-2px)&#125;.markdown-body blockquote&#123;padding:.5em 1em;margin:15px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:4px solid #a862ea;background-color:#f8f5ff&#125;.markdown-body blockquote>p&#123;margin:0&#125;.markdown-body code&#123;padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff&#125;.markdown-body pre&#123;margin:2em 0;box-shadow:0 0 20px #e7daff&#125;.markdown-body pre>code&#123;display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:22.5px;color:#383838;border-radius:3px;scroll-behavior:smooth&#125;.markdown-body pre>code::-webkit-scrollbar&#123;height:6px;background-color:#f8f5ff&#125;.markdown-body pre>code::-webkit-scrollbar-thumb&#123;background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px&#125;.markdown-body hr&#123;margin:2em 0;border-top:1px solid #a862ea&#125;.markdown-body table&#123;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse;border:1px solid #e7daff&#125;.markdown-body thead&#123;color:#a862ea;background:#f8f5ff&#125;.markdown-body td,.markdown-body th&#123;padding:1em .5em&#125;.markdown-body tr&#123;background-color:#fcfcfc&#125;@media (max-width:720px)&#123;.markdown-body&#123;font-size:12px&#125;&#125;</style><h1 data-id="heading-0">前言</h1>
<p>图片的懒加载一直都是大厂热门的考题，可为什么他能成为大厂们纷纷趋之若鹜的香馍馍呢，这就要提到它的好处了——性能优化，对就是性能优化，要知道，所有的产品最终是要服务于客户的，而谁能使客户的体验感更好，谁就能笑到最后，而性能就是其中最重要的一环。</p>
<h2 data-id="heading-1">什么是图片懒加载？</h2>
<p>懒加载突出一个“懒”字，懒就是拖延迟的意思，所以“懒加载”说白了就是延迟加载，比如我们加载一个页面，这个页面很长很长，长到我们的浏览器可视区域装不下，那么懒加载就是优先加载可视区域的内容，其他部分等进入了可视区域在加载。</p>
<h2 data-id="heading-2">为什么要图片懒加载？</h2>
<p>懒加载是一种网页性能优化的方式，它能极大的提升用户体验。就比如说图片，图片一直是影响网页性能的主要元凶，现在一张图片超过几兆已经是很经常的事了。如果每次进入页面就请求所有的图片资源，那么可能等图片加载出来用户也早就走了。所以，我们需要懒加载，进入页面的时候，只请求可视区域的图片资源。</p>
<h2 data-id="heading-3">原理</h2>
<p>图片懒加载，那我们要实现懒加载，当然是要对图片下手啦！</p>
<p>大家都知道，一张图片就是一个<img src="https://juejin.cn/post/undefined" referrerpolicy="no-referrer">标签，而图片的来源主要是src属性。浏览器是否发起亲求就是根据是否有src属性决定的。</p>
<p>既然这样，那么我们就要对<img src="https://juejin.cn/post/undefined" referrerpolicy="no-referrer">标签的src属性下手了，在没进入可视区域的时候，我们先不给这个<img src="https://juejin.cn/post/undefined" referrerpolicy="no-referrer">标签赋src属性，这样岂不是浏览器就不会发送请求了。</p>
<h2 data-id="heading-4">实现</h2>
<p><strong>1.先介绍几个和懒加载相关的API</strong></p>
<ul>
<li>浏览器窗口的视口（viewport）高度（以像素为单位）；如果有水平滚动条，也包括滚动条高度。</li>
</ul>
<blockquote>
<p>var intViewportHeight = window.innerHeight;</p>
</blockquote>
<ul>
<li>Element.clientHeight没有CSS或内联布局框的元素的只读属性为零；否则，它是元素的内部高度（以像素为单位）。它包括填充，但不包括边框，边距和水平滚动条（如果存在）。</li>
</ul>
<blockquote>
<p>document.documentElement.clientHeight//获取屏幕可视区域的高度</p>
</blockquote>
<p>好啦好啦，讲道理千遍万遍，不如过一遍代码，我们上代码！</p>
<p>与普通的图片懒加载不同，如下这个多做了 2 个精心处理：</p>
<ul>
<li>图片全部加载完成后移除事件监听；</li>
<li>加载完的图片，从 imgList 移除；</li>
</ul>
<pre><code class="copyable">let imgList = [...document.querySelectorAll('img')]
let length = imgList.length
// 把图片查询分配到一个数组
const imgLazyLoad = function() &#123;
    let count = 0
   return (function() &#123;
        let deleteIndexList = []
        imgList.forEach((img, index) => &#123;
            let rect = img.getBoundingClientRect()
            if (rect.top < window.innerHeight) &#123;
                img.src = img.dataset.src
                deleteIndexList.push(index)
                count++
                if (count === length) &#123;
                    document.removeEventListener('scroll', imgLazyLoad)
                &#125;
            &#125;
        &#125;)
        imgList = imgList.filter((img, index) => !deleteIndexList.includes(index))
   &#125;)()
&#125;

// 这里最好加上防抖处理
document.addEventListener('scroll', imgLazyLoad)

<span class="copy-code-btn">复制代码</span></code></pre>
<p>其实吧，这个代码对于你们这些大佬来说，挺简单的，但是对于我这种小菜鸡来说，还是有点困难的，所以我还是简单讲一下几个点呗，夯实一下我自己的学习，所以大佬们多多担待，多谢多谢！</p>
<ol>
<li>return (function() &#123;&#125;）  这其实就是一个自执行函数的实现。</li>
</ol>
<p>而什么是自执行函数呢？</p>
<p>自行调用的函数: 就是指,函数在页面载入后或者之前就自行调用,无需借助其他函数或方法来启动;</p>
<ol start="2">
<li>img.getBoundingClientRect() 咳咳，我想你们都把这个这么长的东东都在脑海里读了一遍吧！嘿嘿，我就没有。</li>
</ol>
<p>那言归正传，这个东西到底是啥呢?我们看到前面加了一个img.那我我们肯定知道它和图片有关，那么我们来解释一下呗：</p>
<p>img.getBoundingClientRect()就是图片到视窗viewport的上或者左边的距离，它有四个属性</p>
<ul>
<li>top 图片上边距离视窗上边的距离</li>
<li>bottom 图片下边距离视窗上边的距离</li>
<li>left 图片左边距离视窗左边的距离</li>
<li>right 图片右边距离视窗左边的距离</li>
</ul>
<p>这样说，是不是有点模糊呢？ 所以说，我是个好人，精心为你们“偷”了张图片过来，看了下面那张图，你就全懂了。</p>
<p><img alt="element-box-diagram.png" class="lazyload" src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/bebb276a5190427a8911f38f8b19ed58~tplv-k3u1fbpfcp-watermark.image" data-width="800" data-height="600" referrerpolicy="no-referrer"></p>
<ol start="3">
<li>document.removeEventListener('scroll', imgLazyLoad) 这里呢，就是图片全部加载完成后移除事件监听，那它这样干的理由是什么呢？</li>
</ol>
<p>没错，就是防抖处理</p>
<p>简而言之就是，通过移除监听事件来实现防抖处理。</p>
<p>而，关于防抖，我就简单说一下，不做过多解释，我的下篇文章会讲。什么？你问下篇文章在哪？额。。。，我只能告诉你，等几天！</p>
<p>防抖：防止抖动，以免把一次事件误执行多次，影响性能，比如敲键盘就是一个每天都会接触到的防抖操作。
4. !deleteIndexList.includes(index)</p>
<ul>
<li>
<p>includes() 方法用于判断字符串是否包含指定的子字符串。</p>
<p>如果找到匹配的字符串则返回 true，否则返回 false。</p>
</li>
</ul>
<p><strong>注意</strong>： includes() 方法区分大小写。</p>
<ul>
<li>我想很多同学都对这个!deleteIndexListincludes(index)有点莫名其妙吧，那我们来解析一下呗！</li>
</ul>
<ol>
<li>首先，deleteIndexList.includes(index)是一个方法，没错吧！它就是查询deleteIndexList数组里是否含有指定的index如果有，我们就返回ture否则就返回false.</li>
<li>那前面再加上！是啥意思呢，我们都知道！有取反的意思，所以在方法前面加上！就是对于方法的返回值取反。</li>
</ol>
<p><strong>总结：</strong>
所以这句代码的作用就是删除imgLIst里面加载完的图片。</p>
<h1 data-id="heading-5">总结</h1>
<p>好了好了，介绍也介绍的差不多了，剩下的相信以小伙伴们的实例，解决它就是洒洒水的事情，所以我们到这里就结束咯，小伙伴们加油加油！拜拜</p></div> <div class="image-viewer-box" data-v-78c9b824><!----></div>  
</div>
            