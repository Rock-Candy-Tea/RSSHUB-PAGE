
---
title: 'ä»Šå¤©è¦è®²çš„å‡ ä¸ªæ¨¡å—åŒ–è§„èŒƒCMJã€AMDã€CMDã€ESMï¼Œä»¥åŠç®€å•å®ç°AMDã€CMD'
categories: 
 - ç¼–ç¨‹
 - æ˜é‡‘
 - åˆ†ç±»
headimg: 'https://picsum.photos/400/300?random=4419'
author: æ˜é‡‘
comments: false
date: Mon, 31 May 2021 22:23:36 GMT
thumbnail: 'https://picsum.photos/400/300?random=4419'
---

<div>   
<div class="markdown-body"><style>.markdown-body&#123;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333&#125;.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6&#123;line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px&#125;.markdown-body h1&#123;font-size:30px;margin-bottom:5px&#125;.markdown-body h2&#123;padding-bottom:12px;font-size:24px;border-bottom:1px solid #ececec&#125;.markdown-body h3&#123;font-size:18px;padding-bottom:0&#125;.markdown-body h4&#123;font-size:16px&#125;.markdown-body h5&#123;font-size:15px&#125;.markdown-body h6&#123;margin-top:5px&#125;.markdown-body p&#123;line-height:inherit;margin-top:22px;margin-bottom:22px&#125;.markdown-body img&#123;max-width:100%&#125;.markdown-body hr&#123;border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px&#125;.markdown-body code&#123;word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em&#125;.markdown-body code,.markdown-body pre&#123;font-family:Menlo,Monaco,Consolas,Courier New,monospace&#125;.markdown-body pre&#123;overflow:auto;position:relative;line-height:1.75&#125;.markdown-body pre>code&#123;font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8&#125;.markdown-body a&#123;text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff&#125;.markdown-body a:active,.markdown-body a:hover&#123;color:#275b8c&#125;.markdown-body table&#123;display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6&#125;.markdown-body thead&#123;background:#f6f6f6;color:#000;text-align:left&#125;.markdown-body tr:nth-child(2n)&#123;background-color:#fcfcfc&#125;.markdown-body td,.markdown-body th&#123;padding:12px 7px;line-height:24px&#125;.markdown-body td&#123;min-width:120px&#125;.markdown-body blockquote&#123;color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8&#125;.markdown-body blockquote:after&#123;display:block;content:""&#125;.markdown-body blockquote>p&#123;margin:10px 0&#125;.markdown-body ol,.markdown-body ul&#123;padding-left:28px&#125;.markdown-body ol li,.markdown-body ul li&#123;margin-bottom:0;list-style:inherit&#125;.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item&#123;list-style:none&#125;.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul&#123;margin-top:0&#125;.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul&#123;margin-top:3px&#125;.markdown-body ol li&#123;padding-left:6px&#125;.markdown-body .contains-task-list&#123;padding-left:0&#125;.markdown-body .task-list-item&#123;list-style:none&#125;@media (max-width:720px)&#123;.markdown-body h1&#123;font-size:24px&#125;.markdown-body h2&#123;font-size:20px&#125;.markdown-body h3&#123;font-size:18px&#125;&#125;</style><h2 data-id="heading-0">CMJï¼ˆCommonJSè§„èŒƒï¼‰</h2>
<p>è°ˆåˆ°CMJæˆ‘ä»¬å¾ˆå®¹æ˜“æƒ³åˆ°node.jså› ä¸ºnodeæ‰€ä½¿ç”¨çš„æ¨¡å—åŒ–è§„èŒƒæ­£æ˜¯CMJ,ä¾§é¢è¯´æ˜äº†CMJæ˜¯ä¸€ä¸ªé€‚ç”¨ä¸æœåŠ¡å™¨çš„æ¨¡å—åŒ–è§„èŒƒã€‚
CMJæœ‰å‡ ä¸ªä¸»è¦æ–¹æ³•åˆ†åˆ«ä¸ºï¼šmoduleã€exportsã€requireã€globalã€‚ åœ¨å¼€å‘ä¸­æˆ‘ä»¬ç”¨module.exports æ¥å¯¼å‡ºæ¨¡å—ï¼Œç”¨ requireæ¥åŠ è½½æ¨¡å—ã€‚
æˆ‘ä»¬æ¥çœ‹ä¸ªç®€å•çš„ç”¨ä¾‹ï¼š
math.js</p>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">//åœ¨math.jsä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªå˜é‡å’Œä¸€ä¸ªå‡½æ•°å¹¶æŠŠå®ƒæš´éœ²å‡ºæ¥</span>
<span class="hljs-keyword">let</span> num = <span class="hljs-number">0</span>;
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">add</span>(<span class="hljs-params">a, b</span>) </span>&#123;
  <span class="hljs-keyword">return</span> a + b;
&#125;
<span class="hljs-built_in">module</span>.exports = &#123; <span class="hljs-comment">//åœ¨è¿™å‘å¤–æš´éœ²å‡ºå‡½æ•°ä¸å˜é‡</span>
  <span class="hljs-attr">add</span>: add,
  <span class="hljs-attr">num</span>: num
&#125;
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<p>index.js</p>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">//æˆ‘ä»¬åœ¨è¿™é‡Œä½¿ç”¨requireæ–¹æ³•å¼•ç”¨math.js</span>
<span class="hljs-keyword">let</span> math = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./math'</span>);
<span class="hljs-comment">//è¿™æ—¶æˆ‘ä»¬å¯ä»¥è°ƒç”¨åˆ°mathä¸­çš„addæ–¹æ³•ã€‚</span>
math.add(<span class="hljs-number">4</span>, <span class="hljs-number">9</span>);
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<p>è¿™é‡Œè¦æ³¨æ„çš„æ˜¯å¼•ç”¨è‡ªå®šä¹‰çš„æ¨¡å—æ—¶ï¼Œå‚æ•°åŒ…å«è·¯å¾„ï¼Œå¯çœç•¥.js,è€Œå¼•ç”¨æ ¸å¿ƒæ¨¡å—æ—¶ï¼Œä¸éœ€è¦å¸¦è·¯å¾„ã€‚
å› ä¸ºCommonJSç”¨åŒæ­¥çš„æ–¹å¼åŠ è½½æ¨¡å—ã€‚åœ¨æµè§ˆå™¨ä¸­æˆ‘ä»¬ç”¨åŒæ­¥æ–¹å¼åŠ è½½æ¨¡å—æ—¶ç”¨æˆ·å°†æ— æ³•ç»§ç»­æ“ä½œç½‘é¡µï¼Œæ‰€ä»¥å‰ç«¯éœ€è¦ä¸€ä¸ªèƒ½å¼‚æ­¥åŠ è½½æ¨¡å—çš„æ¨¡å—åŒ–è§„èŒƒã€‚</p>
<p>æ–‡ä»¶æ˜¯ä¸€ä¸ªæ¨¡å—ï¼Œç§æœ‰ã€‚å†…ç½®ä¸¤ä¸ªå˜é‡ module require (exports = module.exports)</p>
<p>ä¸€ä¸ªå¼•å…¥ä¸€ä¸ªå¯¼å‡ºï¼Œå°±æ„æˆäº†é€šä¿¡çš„åŸºæœ¬ç»“æ„</p>
<h3 data-id="heading-1">éœ€è¦æ³¨æ„çš„ä¸¤ä¸ªé—®é¢˜</h3>
<ol>
<li>ç¼“å­˜ï¼Œrequire ä¼šç¼“å­˜ä¸€ä¸‹ï¼Œæ‰€ä»¥</li>
</ol>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// a.js</span>
<span class="hljs-keyword">var</span> name = <span class="hljs-string">'morrain'</span>
<span class="hljs-keyword">var</span> age = <span class="hljs-number">18</span>
<span class="hljs-built_in">exports</span>.name = name
<span class="hljs-built_in">exports</span>.getAge = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>&#123;
    <span class="hljs-keyword">return</span> age
&#125;
<span class="hljs-comment">// b.js</span>
<span class="hljs-keyword">var</span> a = <span class="hljs-built_in">require</span>(<span class="hljs-string">'a.js'</span>)
<span class="hljs-built_in">console</span>.log(a.name) <span class="hljs-comment">// 'morrain'</span>
a.name = <span class="hljs-string">'rename'</span>
<span class="hljs-keyword">var</span> b = <span class="hljs-built_in">require</span>(<span class="hljs-string">'a.js'</span>)
<span class="hljs-built_in">console</span>.log(b.name) <span class="hljs-comment">// 'rename'</span>
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<ol start="2">
<li>å¼•ç”¨æ‹·è´è¿˜æ˜¯å€¼æ‹·è´çš„é—®é¢˜(CMJ æ˜¯å€¼æ‹·è´)</li>
</ol>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">// a.js</span>
<span class="hljs-keyword">var</span> name = <span class="hljs-string">'morrain'</span>
<span class="hljs-keyword">var</span> age = <span class="hljs-number">18</span>
<span class="hljs-built_in">exports</span>.name = name
<span class="hljs-built_in">exports</span>.age = age
<span class="hljs-built_in">exports</span>.setAge = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">a</span>)</span>&#123;
    age = a
&#125;
<span class="hljs-comment">// b.js</span>
<span class="hljs-keyword">var</span> a = <span class="hljs-built_in">require</span>(<span class="hljs-string">'a.js'</span>)
<span class="hljs-built_in">console</span>.log(a.age) <span class="hljs-comment">// 18</span>
a.setAge(<span class="hljs-number">19</span>)
<span class="hljs-built_in">console</span>.log(a.age) <span class="hljs-comment">// 18</span>
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<ol start="3">
<li>è¿è¡Œæ—¶åŠ è½½ / ç¼–è¯‘æ—¶åŠ è½½ï¼ˆå¤šé˜¶æ®µï¼Œå¼‚æ­¥ï¼‰ESM</li>
</ol>
<h2 data-id="heading-2">AMD</h2>
<p>AMDå°±æ˜¯ä¸€ä¸ªå¼‚æ­¥åŠ è½½æ¨¡å—çš„æ¨¡å—åŒ–è§„èŒƒã€‚AMDçš„å®ç°å°±æ˜¯require.js
AMDè§„èŒƒå®šä¹‰äº†ä¸€ä¸ªå‡½æ•°defineï¼Œé€šè¿‡defineæ–¹æ³•å®šä¹‰æ¨¡å—</p>
<pre><code class="hljs language-js copyable" lang="js">define(id?, dependencies?, factory);
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<ul>
<li>idï¼šå¯é€‰å‚æ•°ï¼Œç”¨æ¥å®šä¹‰æ¨¡å—çš„æ ‡è¯†ï¼Œå¦‚æœæ²¡æœ‰æä¾›è¯¥å‚æ•°ï¼Œæ¨¡å—æ ‡è¯†å°±å–è„šæœ¬æ–‡ä»¶åï¼ˆå»æ‰æ‰©å±•åï¼‰ã€‚</li>
<li>dependenciesï¼šå¯é€‰å‚æ•°ï¼Œç”¨æ¥ä¼ å…¥å½“å‰æ¨¡å—ä¾èµ–çš„æ¨¡å—åç§°æ•°ç»„ã€‚</li>
<li>factoryï¼šå·¥å‚æ–¹æ³•ï¼Œæ¨¡å—åˆå§‹åŒ–è¦æ‰§è¡Œçš„å‡½æ•°æˆ–å¯¹è±¡ï¼Œå¦‚æœæ˜¯å‡½æ•°ï¼Œå®ƒåªè¢«æ‰§è¡Œä¸€æ¬¡ã€‚å¦‚æœæ˜¯å¯¹è±¡ï¼Œæ­¤å¯¹è±¡åº”è¯¥ä¸ºæ¨¡å—çš„è¾“å‡ºå€¼ã€‚å®šä¹‰æ¨¡å—ä¾‹å­ï¼š</li>
</ul>
<pre><code class="hljs language-js copyable" lang="js">define(<span class="hljs-string">'a'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'a load'</span>)
  <span class="hljs-keyword">return</span> &#123;
    <span class="hljs-attr">run</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123; <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'a run'</span>) &#125;
  &#125;
&#125;)
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<p>åœ¨require.js ä¸­è¿˜æœ‰require.configå’Œrequireï¼Œæˆ‘ä»¬ä»¥åŠ è½½ä¸€ä¸ªjqueryåº“ä¸ºä¾‹ï¼š</p>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-built_in">require</span>.config(&#123;
    <span class="hljs-attr">paths</span> : &#123;
        <span class="hljs-string">"jquery"</span> : [<span class="hljs-string">"http://libs.baidu.com/jquery/2.0.3/jquery"</span>]   
    &#125;
&#125;)
<span class="hljs-comment">//è¿™æ—¶åšå®Œä¸Šé¢çš„æ“ä½œåæˆ‘ä»¬å°±å¯ä»¥ç›´æ¥ç”¨jqueryæ¥å¼•å…¥æ¨¡å—ï¼Œä¸ç”¨åé¢é‚£ä¸€å¤§ä¸²CDNåœ°å€äº†</span>
<span class="hljs-built_in">require</span>([<span class="hljs-string">"jquery"</span>],<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">$</span>)</span>&#123;
    $(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>&#123;
        alert(<span class="hljs-string">"load finished"</span>);  
    &#125;)
&#125;)
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<p><strong>ä¾èµ–å‰ç½®</strong>ï¼Œæ¢å¥è¯è¯´ï¼Œåœ¨è§£æå’Œæ‰§è¡Œå½“å‰æ¨¡å—ä¹‹å‰ï¼Œæ¨¡å—ä½œè€…å¿…é¡»æŒ‡æ˜å½“å‰æ¨¡å—æ‰€ä¾èµ–çš„æ¨¡å—ã€‚</p>
<p>ä»£ç åœ¨ä¸€æ—¦è¿è¡Œåˆ°æ­¤å¤„ï¼Œèƒ½ç«‹å³çŸ¥æ™“ä¾èµ–ã€‚è€Œæ— éœ€éå†æ•´ä¸ªå‡½æ•°ä½“æ‰¾åˆ°å®ƒçš„ä¾èµ–ï¼Œå› æ­¤æ€§èƒ½æœ‰æ‰€æå‡ï¼Œç¼ºç‚¹å°±æ˜¯å¼€å‘è€…å¿…é¡»æ˜¾å¼å¾—æŒ‡æ˜ä¾èµ–â€”â€”è¿™ä¼šä½¿å¾—å¼€å‘å·¥ä½œé‡å˜å¤§ï¼Œæ¯”å¦‚ï¼šå½“ä½ å†™åˆ°å‡½æ•°ä½“å†…éƒ¨å‡ ç™¾ä¸Šåƒè¡Œçš„æ—¶å€™ï¼Œå¿½ç„¶å‘ç°éœ€è¦å¢åŠ ä¸€ä¸ªä¾èµ–ï¼Œä½ ä¸å¾—ä¸å›åˆ°å‡½æ•°é¡¶ç«¯æ¥å°†è¿™ä¸ªä¾èµ–æ·»åŠ è¿›æ•°ç»„ã€‚</p>
<pre><code class="hljs language-js copyable" lang="js">define(<span class="hljs-string">'a'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'a load'</span>)
  <span class="hljs-keyword">return</span> &#123;
    <span class="hljs-attr">run</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123; <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'a run'</span>) &#125;
  &#125;
&#125;)

define(<span class="hljs-string">'b'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'b load'</span>)
  <span class="hljs-keyword">return</span> &#123;
    <span class="hljs-attr">run</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123; <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'b run'</span>) &#125;
  &#125;
&#125;)

<span class="hljs-built_in">require</span>([<span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>], <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">a, b</span>) </span>&#123;
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'main run'</span>) 
  a.run()
  b.run()
&#125;)

<span class="hljs-comment">// a load</span>
<span class="hljs-comment">// b load</span>
<span class="hljs-comment">// main run</span>
<span class="hljs-comment">// a run</span>
<span class="hljs-comment">// b run</span>
<span class="hljs-comment">//ä»è¿™ä¸ªæ‰“å°ç»“æœæˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼ŒADMåœ¨requireæ—¶å°±æŠŠæ‰€æœ‰æ¨¡å—éƒ½åŠ è½½äº†å¹¶æ²¡æœ‰ç®¡ä½ æœ‰æ²¡æœ‰ç”¨åˆ°ä»–ï¼Œè¿™å°±æ˜¯ä¾èµ–å‰ç½®ã€‚</span>
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<h3 data-id="heading-3">ç®€å•å®ç°</h3>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-keyword">const</span> def = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Map</span>();

<span class="hljs-comment">// AMD mini impl</span>
<span class="hljs-keyword">const</span> defaultOptions = &#123;
  <span class="hljs-attr">paths</span>: <span class="hljs-string">''</span>
&#125;

<span class="hljs-comment">// From CDN åŠ è½½CDN ï¼ˆSystem åŠ è½½åº“ï¼‰</span>
<span class="hljs-keyword">const</span> __import = <span class="hljs-function">(<span class="hljs-params">url</span>) =></span> &#123;
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resove, reject</span>) =></span> &#123;
    System.import(url).then(resove, reject)
  &#125;)
&#125;

<span class="hljs-comment">// normal script è¯»å–è·¯å¾„</span>
<span class="hljs-keyword">const</span> __load = <span class="hljs-function">(<span class="hljs-params">url</span>) =></span> &#123;
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =></span> &#123;
    <span class="hljs-keyword">const</span> head = <span class="hljs-built_in">document</span>.getElementsByTagName(<span class="hljs-string">'head'</span>)[<span class="hljs-number">0</span>];
    <span class="hljs-keyword">const</span> node = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">'script'</span>);
    node.type = <span class="hljs-string">'text/javascript'</span>;
    node.src = url;
    node.async = <span class="hljs-literal">true</span>;
    node.onload = resolve;
    node.onerror = reject;
    head.appendChild(node)
  &#125;)
&#125;

<span class="hljs-comment">// ä¸ºå•¥æ²¡å†™ let const var</span>
<span class="hljs-comment">// åƒä¸‡ä¸è¦åœ¨å®é™…ä½¿ç”¨è¿™ç§æ¯”è¾ƒ low çš„æ–¹å¼ ğŸ”¥</span>
rj = &#123;&#125;;

rj.config = <span class="hljs-function">(<span class="hljs-params">options</span>) =></span> <span class="hljs-built_in">Object</span>.assign(defaultOptions, options);

<span class="hljs-comment">// å®šä¹‰æ¨¡å—ï¼Œè§¦å‘çš„æ—¶æœºå…¶å®æ˜¯åœ¨ require çš„æ—¶å€™ï¼Œæ‰€ä»¥ -> æ”¶é›†</span>
define = <span class="hljs-function">(<span class="hljs-params">name, deps, factory</span>) =></span> &#123;
  <span class="hljs-comment">// todo å‚æ•°çš„åˆ¤æ–­ï¼Œäº’æ¢</span>
  def.set(name, &#123; name, deps, factory &#125;);
&#125;

<span class="hljs-comment">// dep -> a -> a.js -> 'http:xxxx/xx/xx/a.js';</span>
<span class="hljs-keyword">const</span> __getUrl = <span class="hljs-function">(<span class="hljs-params">dep</span>) =></span> &#123;
  <span class="hljs-keyword">const</span> p = location.pathname;
  <span class="hljs-keyword">return</span> p.slice(<span class="hljs-number">0</span>, p.lastIndexOf(<span class="hljs-string">'/'</span>)) + <span class="hljs-string">'/'</span> + dep + <span class="hljs-string">'.js'</span>;
&#125;

<span class="hljs-comment">// å…¶å®æ‰æ˜¯è§¦å‘åŠ è½½ä¾èµ–çš„åœ°æ–¹</span>
<span class="hljs-built_in">require</span> = <span class="hljs-function">(<span class="hljs-params">deps, factory</span>) =></span> &#123;
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =></span> &#123;
    <span class="hljs-built_in">Promise</span>.all(deps.map(<span class="hljs-function"><span class="hljs-params">dep</span> =></span> &#123;
      <span class="hljs-comment">// èµ° CDN</span>
      <span class="hljs-keyword">if</span> (defaultOptions.paths[dep]) <span class="hljs-keyword">return</span> __import(defaultOptions.paths[dep]);

      <span class="hljs-keyword">return</span> __load(__getUrl(dep)).then(<span class="hljs-function">() =></span> &#123;
        <span class="hljs-keyword">const</span> &#123; deps, factory &#125; = def.get(dep);
        <span class="hljs-keyword">if</span> (deps.length === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> factory(<span class="hljs-literal">null</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">require</span>(deps, factory)
      &#125;)
    &#125;)).then(resolve, reject)
  &#125;)
  .then(<span class="hljs-function"><span class="hljs-params">instances</span> =></span> factory(...instances))
&#125;

<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<h3 data-id="heading-4">CMD</h3>
<p>ä»£è¡¨æŠ€æœ¯å®ç° Seajs
CMDä¾‹å­ï¼š</p>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-comment">//functionæœ‰ä¸‰ä¸ªå‚æ•°ï¼šrequireå‚æ•°ç”¨æ¥å¼•å…¥åˆ«çš„æ¨¡å—ï¼Œexportså’Œmoduleç”¨æ¥å¯¼å‡ºæ¨¡å—å…¬å…±æ¥å£ã€‚</span>
define(<span class="hljs-string">'a'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"><span class="hljs-built_in">require</span>, <span class="hljs-built_in">exports</span>, <span class="hljs-built_in">module</span></span>) </span>&#123;
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'a load'</span>)
  <span class="hljs-built_in">exports</span>.run = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123; <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'a run'</span>) &#125;
&#125;)

define(<span class="hljs-string">'b'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"><span class="hljs-built_in">require</span>, <span class="hljs-built_in">exports</span>, <span class="hljs-built_in">module</span></span>) </span>&#123;
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'b load'</span>)
  <span class="hljs-built_in">exports</span>.run = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123; <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'b run'</span>) &#125;
&#125;)

define(<span class="hljs-string">'main'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"><span class="hljs-built_in">require</span>, <span class="hljs-built_in">exports</span>, <span class="hljs-built_in">module</span></span>) </span>&#123;
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'main run'</span>)
  <span class="hljs-keyword">var</span> a = <span class="hljs-built_in">require</span>(<span class="hljs-string">'a'</span>)
  a.run()
  <span class="hljs-keyword">var</span> b = <span class="hljs-built_in">require</span>(<span class="hljs-string">'b'</span>)
  b.run()
&#125;)

seajs.use(<span class="hljs-string">'main'</span>)
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æˆ‘ä»¬çš„ä¾èµ–æ˜¯ç”¨require<strong>æŒ‰éœ€è¦æ¥å¼•å…¥</strong>çš„ã€‚è¿™å°±æ˜¯<strong>ä¾èµ–åç½®</strong>ã€‚è€Œä¸”æˆ‘ä»¬éœ€è¦è°ƒç”¨seajs.use()æ–¹æ³•æ¥æ‰§è¡Œè¿™ä¸ªæ¨¡å—ã€‚</p>
<h3 data-id="heading-5">ç®€å•å®ç°</h3>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-keyword">const</span> modules = &#123;&#125;;
<span class="hljs-keyword">const</span> <span class="hljs-built_in">exports</span> = &#123;&#125;;
sj = &#123;&#125;;

<span class="hljs-keyword">const</span> toUrl = <span class="hljs-function">(<span class="hljs-params">dep</span>) =></span> &#123;
  <span class="hljs-keyword">const</span> p = location.pathname;
  <span class="hljs-keyword">return</span> p.slice(<span class="hljs-number">0</span>, p.lastIndexOf(<span class="hljs-string">'/'</span>)) + <span class="hljs-string">'/'</span> + dep + <span class="hljs-string">'.js'</span>;
&#125;

<span class="hljs-keyword">const</span> getDepsFromFn = <span class="hljs-function">(<span class="hljs-params">fn</span>) =></span> &#123;
  <span class="hljs-keyword">let</span> matches = [];
  <span class="hljs-comment">// require('a ')</span>
  <span class="hljs-comment">//1. (?:require\() -> require(  -> (?:) éæ•è·æ€§åˆ†ç»„</span>
  <span class="hljs-comment">//2. (?:['"]) -> require('</span>
  <span class="hljs-comment">//3. ([^'"]+) -> a -> é¿å…å›æº¯ -> å›æº¯ çŠ¶æ€æœº</span>
  <span class="hljs-keyword">let</span> reg = <span class="hljs-regexp">/(?:require\()(?:['"])([^'"]+)/g</span>; <span class="hljs-comment">// todo</span>
  <span class="hljs-keyword">let</span> r = <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">while</span>((r = reg.exec(fn.toString())) !== <span class="hljs-literal">null</span>) &#123;
    reg.lastIndex
    matches.push(r[<span class="hljs-number">1</span>])
  &#125;

  <span class="hljs-keyword">return</span> matches
&#125;

<span class="hljs-keyword">const</span> __load = <span class="hljs-function">(<span class="hljs-params">url</span>) =></span> &#123;
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =></span> &#123;
    <span class="hljs-keyword">const</span> head = <span class="hljs-built_in">document</span>.getElementsByTagName(<span class="hljs-string">'head'</span>)[<span class="hljs-number">0</span>];
    <span class="hljs-keyword">const</span> node = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">'script'</span>);
    node.type = <span class="hljs-string">'text/javascript'</span>;
    node.src = url;
    node.async = <span class="hljs-literal">true</span>;
    node.onload = resolve;
    node.onerror = reject;
    head.appendChild(node)
  &#125;)
&#125;

<span class="hljs-comment">// ä¾èµ–å‘¢ï¼Ÿ</span>
<span class="hljs-comment">// æå–ä¾èµ–ï¼š 1. æ­£åˆ™è¡¨è¾¾å¼ 2. çŠ¶æ€æœº</span>
define = <span class="hljs-function">(<span class="hljs-params">id, factory</span>) =></span> &#123;
  <span class="hljs-keyword">const</span> url = toUrl(id);
  <span class="hljs-keyword">const</span> deps = getDepsFromFn(factory);
  <span class="hljs-keyword">if</span> (!modules[id]) &#123;
    modules[id] = &#123; url, id, factory, deps &#125;
  &#125;
&#125;

<span class="hljs-keyword">const</span> __exports = <span class="hljs-function">(<span class="hljs-params">id</span>) =></span> <span class="hljs-built_in">exports</span>[id] || (<span class="hljs-built_in">exports</span>[id] = &#123;&#125;);
<span class="hljs-keyword">const</span> __module = <span class="hljs-built_in">this</span>;
<span class="hljs-comment">// è¿™é‡Œé¢æ‰æ˜¯åŠ è½½æ¨¡å—çš„åœ°æ–¹</span>
<span class="hljs-keyword">const</span> __require = <span class="hljs-function">(<span class="hljs-params">id</span>) =></span> &#123;
  <span class="hljs-keyword">return</span> __load(toUrl(id)).then(<span class="hljs-function">() =></span> &#123;
    <span class="hljs-comment">// åŠ è½½ä¹‹å</span>
    <span class="hljs-keyword">const</span> &#123; factory, deps &#125; = modules[id];
    <span class="hljs-keyword">if</span> (!deps || deps.length === <span class="hljs-number">0</span>) &#123;
      factory(__require, __exports(id), __module);
      <span class="hljs-keyword">return</span> __exports(id);
    &#125;

    <span class="hljs-keyword">return</span> sj.use(deps, factory);
  &#125;)
&#125;

sj.use = <span class="hljs-function">(<span class="hljs-params">mods, callback</span>) =></span> &#123;
  mods = <span class="hljs-built_in">Array</span>.isArray(mods) ? mods : [mods];
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =></span> &#123;
    <span class="hljs-built_in">Promise</span>.all(mods.map(<span class="hljs-function"><span class="hljs-params">mod</span> =></span> &#123;
      <span class="hljs-keyword">return</span> __load(toUrl(mod)).then(<span class="hljs-function">() =></span> &#123;
        <span class="hljs-keyword">const</span> &#123; factory &#125; = modules[mod];
        <span class="hljs-keyword">return</span> factory(__require, __exports(mod), __module)
      &#125;)
    &#125;)).then(resolve, reject)
  &#125;).then(<span class="hljs-function"><span class="hljs-params">instances</span> =></span> callback && callback(...instances))
&#125;
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<h2 data-id="heading-6">è¡¥å……</h2>
<p>æœ‰æ—¶å€™é‡åˆ°é€’å½’è°ƒç”¨ï¼Œæ€»æ˜¯è§‰å¾—éå¸¸ç»•ï¼Œè¿™æ—¶å€™æˆ‘ä»¬å¯ä»¥è¯•ç€æ‹†å¼€æ¥çœ‹å¾…ï¼ŒæŠŠå®ƒå‡è®¾æˆä¸ºä¸€ä¸ªæœ€åŸºç¡€ç®€å•çš„å•è¿‡ç¨‹</p>
<p>å‡è®¾ æ¨¡å— A ä¾èµ– æ¨¡å— B , æ¨¡å— B åˆ™ æ— éœ€ä¾èµ–</p>
<p>æˆ‘ä»¬ç®€åŒ–ä¸‹æ¨¡å‹</p>
<p>å‡è®¾åªåŠ è½½æ¨¡å— B</p>
<p>å®šä¹‰ B æ¨¡å—</p>
<pre><code class="hljs language-js copyable" lang="js">define(<span class="hljs-string">'B'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'B load'</span>)
    <span class="hljs-keyword">return</span> &#123;
        <span class="hljs-attr">run</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123; <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'B run'</span>) &#125;
    &#125;
&#125;)
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<p>å¼•å…¥ æ¨¡å— B</p>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-built_in">require</span>([<span class="hljs-string">"B"</span>],<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">B</span>)</span>&#123;
    B.run()
&#125;)
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<p>å®ç°</p>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-built_in">require</span> = <span class="hljs-function">(<span class="hljs-params">deps, factory</span>) =></span> &#123;
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =></span> &#123;
       <span class="hljs-comment">// å¾ªç¯è°ƒç”¨ä¾èµ–</span>
      <span class="hljs-built_in">Promise</span>.all(deps.map(<span class="hljs-function"><span class="hljs-params">dep</span> =></span> &#123;
        <span class="hljs-comment">// èµ° CDN</span>
        <span class="hljs-keyword">if</span> (defaultOptions.paths[dep]) <span class="hljs-keyword">return</span> __import(defaultOptions.paths[dep]);
        <span class="hljs-comment">// æœ¬åœ°å¼•ç”¨</span>
        <span class="hljs-keyword">return</span> __load(__getUrl(dep)).then(<span class="hljs-function">() =></span> &#123;
          <span class="hljs-keyword">const</span> &#123; deps, factory &#125; = def.get(dep); <span class="hljs-comment">// è·å– define æ—¶å­˜å‚¨çš„ B æ¨¡å—</span>
          <span class="hljs-keyword">return</span> factory(<span class="hljs-literal">null</span>); <span class="hljs-comment">// æ‰§è¡Œ B æ¨¡å—ï¼Œ è¿”å› B æ¨¡å— return ç»“æœ</span>
        &#125;)
      &#125;)).then(resolve, reject) <span class="hljs-comment">// å°† â†‘ æ‰§è¡Œç»“æœæ”¾å› resolve çš„å€¼ä¸º Promise.all æ‰§è¡Œå®Œæˆåçš„ factory èŒƒå›´å€¼ æ•°ç»„</span>
    &#125;)
    .then(<span class="hljs-function"><span class="hljs-params">instances</span> =></span> factory(...instances)) <span class="hljs-comment">// è¿”å›ç»“æœ æ‰§è¡Œ require çš„ å›è°ƒå‡½æ•° factory</span>
  &#125;
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<p>å½“ A æ¨¡å—å­˜åœ¨å¼•ç”¨ B æ¨¡å—æ—¶</p>
<p>å®šä¹‰ A æ¨¡å—</p>
<pre><code class="hljs language-js copyable" lang="js">define(<span class="hljs-string">'A'</span>, [<span class="hljs-string">'B'</span>], <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">B</span>) </span>&#123;
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'A load'</span>)
    <span class="hljs-keyword">return</span> &#123;
        <span class="hljs-attr">run</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123; B.run() &#125;
    &#125;
&#125;)
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre>
<p>å¼•å…¥ æ¨¡å— A æ—¶åˆ™è¦å»æ£€æµ‹ A æ¨¡å—éœ€è¦ä¾èµ–çš„æ¨¡å—ï¼Œå½“å‡è®¾æ¯ä¸ªæ¨¡å—éƒ½æœ‰è‡ªå·±çš„ä¾èµ–æ—¶ï¼Œè¿™ä¸ªè¿‡ç¨‹å°±åƒæ˜¯ä¸€ä¸ªæ ‘çŠ¶å›¾ï¼Œä¸æ–­åœ°è°ƒç”¨ å„è‡ªçš„ requireï¼Œæ¯ä¸ªæ ‘èŠ‚ç‚¹éƒ½å»åŠ è½½è‡ªå·±èŠ‚ç‚¹åˆ†æ”¯æ¨¡å—ï¼Œç¬¦åˆé€’å½’è°ƒç”¨çš„æ¡ä»¶ã€‚</p>
<p>é€’å½’è°ƒç”¨éœ€è¦ä¸€ä¸ªæ‰§è¡Œæ¡ä»¶ï¼Œæ¡ä»¶å°±æ˜¯è¯¥æ¨¡å—æ˜¯å¦éœ€è¦ä¾èµ–</p>
<pre><code class="hljs language-js copyable" lang="js"><span class="hljs-keyword">return</span> __load(__getUrl(dep)).then(<span class="hljs-function">() =></span> &#123;
<span class="hljs-keyword">const</span> &#123; deps, factory &#125; = def.get(dep); <span class="hljs-comment">// å–å‡º æ¨¡å— æ£€æŸ¥ æ˜¯å¦éœ€è¦ä¾èµ–</span>
    <span class="hljs-keyword">if</span> (deps.length === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> factory(<span class="hljs-literal">null</span>); <span class="hljs-comment">// å½“ä¾èµ–é•¿åº¦éƒ¨ä½0æ—¶</span>
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">require</span>(deps, factory) <span class="hljs-comment">// å¦åˆ™ åŠ è½½ è‡ªèº«ä¾èµ–</span>
&#125;)
<span class="copy-code-btn">å¤åˆ¶ä»£ç </span></code></pre></div>  
</div>
            